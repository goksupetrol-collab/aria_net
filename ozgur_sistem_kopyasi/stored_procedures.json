[
  {
    "schema": "dbo",
    "name": "Alc_Fis_Borc_Fis_Olarak_Aktar",
    "definition": "CREATE PROCEDURE [dbo].Alc_Fis_Borc_Fis_Olarak_Aktar\r\n(@firmano  \t\tint,\r\n@fisrap_id \t\tint,\r\n@varno    \t\tint,\r\n@varok    \t\tint,\r\n@yertip   \t\tvarchar(100),\r\n@veridin  \t\tvarchar(8000),\r\n@tarih    \t\tdatetime,\r\n@saat\t  \t\tvarchar(10),\t\r\n@perkod   \t\tvarchar(50),\r\n@adaid    \t\tint)\r\nAS\r\nBEGIN\r\n  \r\n declare @yertipad   varchar(100)    \r\n declare @fistip     varchar(50)    \r\n declare @fistipad   varchar(100)    \r\n declare @say\t\t int\r\n declare @MESAJ\t\t varchar(300)\t\t\r\n declare @gctip\t\t varchar(1)\r\n declare @fistip_id  int\r\n declare @fistur_id  int\r\n \r\n \r\n\r\n\r\n select @gctip=f.gctip,\r\n @fistip_id=tip_id,\r\n @fistur_id=tur_id,\r\n @fistip=r.rapkod,\r\n @fistipad=r.ack\r\n from raporlar r left join fattip f on f.kod=r.rapkod \r\n where r.sil=0 and r.id=@fisrap_id\r\n \r\n \r\n select  @yertipad=ad from yertipad as y where y.kod=@yertip\r\n   \r\n   select @say=count(*) from veresimas as vs \r\n   where aktip not in ('BL','BK') \r\n       and verid in (select * from CsvToInt(@veridin))\r\n       if @say>0\r\n           begin\r\n           SELECT @MESAJ = 'Seçmiş Olduğunuz Fişler İçinde Aktarılmış Fişler Var..!'\r\n           RAISERROR (@MESAJ, 16,1)\r\n           RETURN\r\n       end\r\n\r\n\r\n  declare @verid \t\tint\r\n  declare @new_verid  \tfloat\r\n\r\n  declare fis_cur CURSOR FAST_FORWARD  \r\n  FOR select verid from veresimas where verid in (select * from CsvToInt(@veridin))\r\n   open fis_cur\r\n  fetch next from  fis_cur into @verid\r\n  while @@FETCH_STATUS=0\r\n   begin\r\n\r\n   insert into veresimas (firmano,verid,varno,kayok,\r\n   gctip,FisRap_id,fistip_id,fistur_id,fisad,fistip,yertip,yerad,seri,[no],ykno,\r\n   cartip,cartip_id,car_id,carkod,\r\n   plaka,perkod,adaid,surucu,km,toptut,ack,kmsec,varok,sil,\r\n   tarih,saat,\r\n   ototag,olususer,degtarsaat,deguser,olustarsaat,dataok,aktip,fatbelno,\r\n   aktar,vadtar,bagid,marsatid,parabrm,kur,akid) \r\n   select\r\n   firmano,0,@varno,kayok,\r\n   @gctip,@fisrap_id,@fistip_id,@fistur_id,\r\n   @fistipad,@fistip,@yertip,@yertipad,seri,[no],ykno,\r\n   cartip,cartip_id,car_id,carkod,\r\n   plaka,@perkod,@adaid,surucu,km,0,'SEÇİLEN ALACAK FİŞİ',kmsec,@varok,sil,\r\n   @tarih,@saat,ototag,olususer,degtarsaat,deguser,olustarsaat,0,aktip,fatbelno,\r\n   aktar,vadtar,0,marsatid,parabrm,kur,akid\r\n   from veresimas where verid=@verid\r\n   \r\n   select @new_verid=SCOPE_IDENTITY()\r\n   \r\n   \r\n   \r\n   insert into veresihrk (firmano,varno,verid,\r\n   stktip_id,stktip,stk_id,stkod,mik,brmfiy,depkod,kdvyuz,brim,sil,olususer,\r\n   olustarsaat,deguser,degtarsaat,dataok,yenbrmfiyfark,kayok,akfiytip)\r\n   select firmano,varno,@new_verid,\r\n   stktip_id,stktip,stk_id,stkod,mik,brmfiy,depkod,kdvyuz,brim,sil,olususer,\r\n   olustarsaat,deguser,degtarsaat,0,yenbrmfiyfark,kayok,akfiytip \r\n   from veresihrk  where verid=@verid and sil=0\r\n\r\n\r\n   /*veresiye fis olustur   */\r\n    update veresimas set \r\n    verid=@new_verid,\r\n    fis_alc_bagverid=@verid,\r\n    kayok=1 where id=@new_verid\r\n   \r\n    update veresimas set \r\n    fis_alc_bagverid=@new_verid,\r\n    kayok=1 where verid=@verid\r\n    \r\n    \r\n   FETCH next from  fis_cur into @verid\r\n  end\r\n close fis_cur\r\n deallocate fis_cur  \r\n   \r\nEND"
  },
  {
    "schema": "dbo",
    "name": "bankhrkgiris",
    "definition": "CREATE PROCEDURE [dbo].bankhrkgiris @id int\r\nAS\r\nBEGIN\r\n\r\ndeclare @varno float\r\ndeclare @sil  int\r\ndeclare @baktop float\r\ndeclare @newid float\r\ndeclare @gctip varchar(1)\r\ndeclare @borc float,@alacak float\r\n  \r\n/*-masraf */\r\ndeclare @gidtipkod varchar(20)\r\ndeclare @gidtiphrkkod varchar(20)\r\ndeclare @gidtipad varchar(30)\r\ndeclare @gidtiphrkad varchar(30)\r\ndeclare @gidkod varchar(30)\r\n\r\n/*faiz masraf */\r\ndeclare @faiz_gidtipkod varchar(20)\r\ndeclare @faiz_gidtiphrkkod varchar(20)\r\n\r\ndeclare @deguser varchar(100)\r\ndeclare @degtarsaat datetime\r\n\r\ndeclare @gidtutar float\r\ndeclare @firmano    float\r\n/*-masraf */\r\n  \r\n  \r\n/*banka işlemleri */\r\n\r\n  declare @islmtip varchar(20)\r\n  declare @islmhrk varchar(20)\r\n  declare @bankhrkid float\r\n\r\n  /*-masraf kodları */\r\n  set @gidtipkod='GLG'\r\n  set @gidtiphrkkod='BMF'\r\n  \r\n  \r\n   /*-faiz masraf kodları */\r\n  set @faiz_gidtipkod='GLG'\r\n  set @faiz_gidtiphrkkod='BFZ'\r\n  \r\n\r\n  \r\n\r\n  select @firmano=firmano,@bankhrkid=bankhrkid,@sil=sil,\r\n  @islmtip=islmtip,@islmhrk=islmhrk,\r\n  @borc=borc,@alacak=alacak,@varno=varno,\r\n  @gidkod=gidkod,@gidtutar=gidtutar,\r\n  @deguser=deguser,\r\n  @degtarsaat=degtarsaat\r\n  from bankahrk with (nolock)\r\n  where id=@id\r\n\r\n\r\n   if @bankhrkid=0\r\n    RETURN\r\n\r\n\r\n  if @sil=1\r\n  begin\r\n    if (@islmhrk='YTN') or (@islmhrk='CKN')\r\n      update kasahrk set sil=1,deguser=@deguser,degtarsaat=@degtarsaat \r\n      where masterid=@bankhrkid and karsihestip='bankakart'\r\n      and islmhrk=@islmhrk and Sil=0\r\n    \r\n    if (@islmhrk='B-C') or (@islmhrk='C-B')\r\n    update carihrk set sil=1,deguser=@deguser,degtarsaat=@degtarsaat \r\n    where masterid=@bankhrkid and karsihestip='bankakart'\r\n    and islmhrk=@islmhrk and Sil=0\r\n    \r\n    if (@islmhrk='BKK') or (@islmhrk='EKK')\r\n    update carihrk set sil=1,deguser=@deguser,degtarsaat=@degtarsaat \r\n    where masterid=@bankhrkid and karsihestip='bankakart'\r\n    and islmhrk=@islmhrk and Sil=0\r\n    \r\n    if (@islmhrk='BNK') or (@islmhrk='IKO')\r\n    update istkhrk set sil=1,deguser=@deguser,degtarsaat=@degtarsaat \r\n    where masterid=@bankhrkid and karsihestip='bankakart'\r\n    and islmhrk=@islmhrk and Sil=0\r\n    \r\n\r\n    update bankahrk set sil=1,deguser=@deguser,degtarsaat=@degtarsaat \r\n    where masterid=@bankhrkid and \r\n    karsihestip='bankakart' and islmhrk=@islmhrk and Sil=0\r\n    \r\n    \r\n    /*banka masraf yansıması silimi */\r\n    update bankahrk set sil=1,deguser=@deguser,degtarsaat=@degtarsaat \r\n    where masterid=@bankhrkid \r\n    and karsihestip='bankakart' and islmtip=@gidtipkod \r\n    and islmhrk=@gidtiphrkkod and Sil=0\r\n    \r\n    \r\n    /*gelir gider masraf yansıması */\r\n     update carihrk set sil=1,deguser=@deguser,degtarsaat=@degtarsaat \r\n     where masterid=@bankhrkid\r\n     and islmtip=@gidtipkod and islmhrk=@gidtiphrkkod \r\n     and karsihestip='bankakart' and Sil=0\r\n   \r\n  \r\n   \r\n    /*banka faiz yansıması silimi */\r\n    update bankahrk set sil=1,deguser=@deguser,degtarsaat=@degtarsaat \r\n    where masterid=@bankhrkid \r\n    and karsihestip='bankakart' and islmtip=@faiz_gidtipkod \r\n    and islmhrk=@faiz_gidtiphrkkod and Sil=0\r\n    \r\n    /*gelir gider faiz yansıması  */\r\n     update carihrk set sil=1,deguser=@deguser,degtarsaat=@degtarsaat  \r\n     where masterid=@bankhrkid\r\n     and islmtip=@faiz_gidtipkod and islmhrk=@faiz_gidtiphrkkod \r\n     and karsihestip='bankakart' and Sil=0\r\n  \r\n  return\r\n  end\r\n  \r\n  \r\n  \r\n  \r\n  \r\n\r\n\r\n if (@islmhrk='IKO')\r\n   begin\r\n\r\n          SET @gctip='C'\r\n\r\n          delete from istkhrk where masterid=@bankhrkid and karsihestip='bankakart'\r\n         \r\n          select @newid=0 \r\n          insert into istkhrk (firmano,istkkod,istkhrkid,gctip,masterid,fisfattip,fisfatid,islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n          cartip,carkod,borc,alacak,tarih,saat,olususer,olustarsaat,vadetar,belno,\r\n          ack,varno,kur,dataok,varok,perkod,adaid,deguser,degtarsaat,sil,\r\n          karsihestip,karsiheskod,parabrm,\r\n          Karsi_Karttip,Karsi_KartKod)\r\n          select firmano,carkod,@newid,@gctip,@bankhrkid,fisfattip,fisfatid,islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n          'bankakart',bankod,@alacak*kur,@borc*kur,tarih,saat,olususer,olustarsaat,\r\n          vadetar,belno,\r\n          ack,varno,kur,dataok,varok,perkod,adaid,deguser,degtarsaat,sil,\r\n          'bankakart',bankod,parabrm,\r\n          'bankakart',bankod\r\n           from bankahrk with (nolock) where id=@id\r\n           select @newid=SCOPE_IDENTITY()\r\n           update istkhrk set istkhrkid=@newid where id=@newid\r\n\r\n  end\r\n\r\n\r\n\r\nif (@islmhrk='YTN') or (@islmhrk='CKN')\r\n begin\r\n   if @islmhrk='YTN'\r\n    SET @gctip='G'\r\n    if @islmhrk='CKN'\r\n    SET @gctip='C'\r\n   \r\n\r\n    delete from kasahrk where masterid=@bankhrkid and karsihestip='bankakart'\r\n\r\n    select @newid=0 \r\n    insert into kasahrk (firmano,kaskod,kashrkid,gctip,varno,masterid,fisfattip,\r\n    fisfatid,islmtip,islmtipad,islmhrk,islmhrkad,yertip,\r\n    yerad,perkod,adaid,giren,cikan,bakiye,carkod,cartip,tarih,saat,\r\n    belno,ack,kur,varok,sil,olususer,\r\n    olustarsaat,deguser,degtarsaat,dataok,parabrm,\r\n    karsihestip,karsiheskod,\r\n    Karsi_Karttip,Karsi_KartKod)\r\n    select firmano,kaskod,@newid,@gctip,varno,@bankhrkid,fisfattip,fisfatid,islmtip,islmtipad,islmhrk,islmhrkad,yertip,\r\n    yerad,perkod,adaid,@alacak,@borc,0,bankod,'bankakart',tarih,saat,belno,ack,kur,varok,sil,olususer,\r\n    olustarsaat,deguser,degtarsaat,dataok,parabrm,'bankakart',bankod,\r\n    'bankakart',bankod from bankahrk with (nolock) where id=@id\r\n    \r\n    select @newid=SCOPE_IDENTITY()\r\n    update kasahrk set kashrkid=@newid where id=@newid\r\n    \r\n    \r\n    \r\n end\r\n\r\n if (@islmhrk='B-C') or (@islmhrk='C-B')\r\n  begin\r\n  \r\n      /*banka masraf yansıması sil */\r\n      delete from bankahrk where masterid=@bankhrkid \r\n      and karsihestip='bankakart' and islmtip=@gidtipkod \r\n      and islmhrk=@gidtiphrkkod \r\n  \r\n    \r\n      delete from carihrk where masterid=@bankhrkid and karsihestip='bankakart'\r\n\r\n      select @newid=0\r\n      insert into carihrk (firmano,carhrkid,gctip,masterid,fisfattip,fisfatid,islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n      cartip,carkod,borc,alacak,bakiye,tarih,saat,olususer,olustarsaat,vadetar,belno,\r\n      ack,varno,kur,dataok,pro,varok,perkod,adaid,deguser,degtarsaat,sil,\r\n      karsihestip,karsiheskod,parabrm,CariAvans,\r\n      Karsi_Karttip,Karsi_KartKod)\r\n      select firmano,@newid,gctip,@bankhrkid,fisfattip,fisfatid,islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n      cartip,carkod,@alacak*kur,@borc*kur,0,tarih,saat,olususer,olustarsaat,vadetar,belno,\r\n      ack,varno,kur,dataok,1,varok,perkod,adaid,deguser,degtarsaat,sil,\r\n      'bankakart',bankod,parabrm,CariAvans,\r\n      'bankakart',bankod from bankahrk with (nolock) where id=@id\r\n      select @newid=SCOPE_IDENTITY()\r\n      update carihrk set carhrkid=@newid where id=@newid\r\n      \r\n  end\r\n\r\n /*-pos masraf kom */\r\n  if (@islmhrk='BKK') or (@islmhrk='EKK')\r\n  begin\r\n  \r\n      delete from carihrk where masterid=@bankhrkid\r\n      and islmtip='BNK' and islmhrk=@islmhrk and karsihestip='bankakart'\r\n\r\n\r\n      select @newid=0 \r\n      insert into carihrk (firmano,carhrkid,gctip,masterid,fisfattip,fisfatid,islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n      cartip,carkod,borc,alacak,bakiye,tarih,saat,olususer,olustarsaat,vadetar,belno,\r\n      ack,varno,kur,dataok,pro,varok,perkod,adaid,deguser,degtarsaat,sil,\r\n      karsihestip,karsiheskod,parabrm,CariAvans,\r\n      Karsi_Karttip,Karsi_KartKod)\r\n      select firmano,@newid,gctip,@bankhrkid,fisfattip,fisfatid,islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n      cartip,carkod,@alacak,@borc,0,tarih,saat,olususer,olustarsaat,vadetar,belno,\r\n      ack,varno,kur,dataok,1,varok,perkod,adaid,deguser,degtarsaat,sil,\r\n      'bankakart',bankod,parabrm,CariAvans,\r\n      'bankakart',bankod from bankahrk with (nolock) where id=@id\r\n      and islmtip='BNK' and islmhrk=@islmhrk\r\n      \r\n       select @newid=SCOPE_IDENTITY()\r\n       update carihrk set carhrkid=@newid where id=@newid\r\n      \r\n      \r\n  end\r\n\r\n\r\n\r\n  /*banka gelir gider kasa yansıması silimi */\r\n  if (@islmhrk<>'VRG') and (@islmhrk<>'VKG')\r\n   begin\r\n   \r\n   \r\n   if  (@islmhrk='VRC')  \r\n    begin\r\n      /*banka masraf yansıması silimi */\r\n      delete from bankahrk where masterid=@bankhrkid \r\n      and karsihestip='bankakart' and islmtip=@gidtipkod \r\n      and islmhrk=@gidtiphrkkod\r\n      \r\n      \r\n       /*gelir gider masraf yansıması silimi */\r\n       delete from carihrk where masterid=@bankhrkid\r\n       and islmtip=@gidtipkod and islmhrk=@gidtiphrkkod \r\n       and karsihestip='bankakart'\r\n     end  \r\n      \r\n      \r\n      if (@islmhrk='VKC')\r\n       begin\r\n       /*banka faiz yansıması silimi */\r\n        delete from bankahrk where masterid=@bankhrkid \r\n        and karsihestip='bankakart' and islmtip=@faiz_gidtipkod \r\n        and islmhrk=@faiz_gidtiphrkkod\r\n        \r\n        \r\n       /*-gelir gider faiz yansıması silimi */\r\n       delete from carihrk where masterid=@bankhrkid\r\n       and islmtip=@faiz_gidtipkod and islmhrk=@faiz_gidtiphrkkod \r\n       and karsihestip='bankakart'\r\n      end\r\n\r\n   end\r\n   \r\n   \r\n   \r\n   \r\n   \r\n   \r\n    /*banka masraf yansıması silimi */\r\n    if (@islmhrk<>'VRG')\r\n    update bankahrk set sil=1,deguser=@deguser,degtarsaat=@degtarsaat \r\n    where masterid=@bankhrkid \r\n    and karsihestip='bankakart' and islmtip=@gidtipkod \r\n    and islmhrk=@gidtiphrkkod and Sil=0\r\n    \r\n    \r\n    /*gelir gider masraf yansıması */\r\n    if (@islmhrk<>'VRG')\r\n     update carihrk set sil=1,deguser=@deguser,degtarsaat=@degtarsaat \r\n     where masterid=@bankhrkid\r\n     and islmtip=@gidtipkod and islmhrk=@gidtiphrkkod \r\n     and karsihestip='bankakart' and Sil=0\r\n   \r\n   \r\n   \r\n  if @gidtutar>0\r\n    begin\r\n\r\n     \r\n     SELECT @gidtipad=ad from islemturtip where tip=@gidtipkod\r\n     SELECT @gidtiphrkad=ad from islemhrktip where tip=@gidtipkod and hrk=@gidtiphrkkod\r\n\r\n      if @islmtip='KRD' and @islmhrk='VKC'\r\n       begin\r\n        set @gidtipkod=@faiz_gidtipkod\r\n        set @gidtiphrkkod=@faiz_gidtiphrkkod\r\n        \r\n        SELECT @gidtipad=ad from islemturtip where tip=@gidtipkod\r\n        SELECT @gidtiphrkad=ad from islemhrktip where tip=@gidtipkod \r\n        and hrk=@gidtiphrkkod\r\n       end\r\n     \r\n      \r\n\r\n     /*--BANKA MASRAF GİRİŞİ */\r\n      select @newid=0\r\n      insert into bankahrk (firmano,bankod,bankhrkid,gctip,masterid,fisfattip,fisfatid,\r\n      islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n      cartip,carkod,borc,alacak,vadetar,tarih,saat,olususer,olustarsaat,belno,\r\n      ack,varno,kur,varok,perkod,adaid,deguser,degtarsaat,sil,\r\n      karsihestip,karsiheskod,parabrm,\r\n      Karsi_Karttip,Karsi_KartKod)\r\n      select firmano,bankod,@newid,'A',@bankhrkid,fisfattip,fisfatid,\r\n      @gidtipkod,@gidtipad,@gidtiphrkkod,@gidtiphrkad,yertip,yerad,\r\n      'gelgidkart',@gidkod,0,@gidtutar,vadetar,tarih,saat,olususer,olustarsaat,belno,\r\n      ack,varno,kur,varok,perkod,adaid,deguser,degtarsaat,sil,\r\n      'bankakart',bankod,parabrm,\r\n      'bankakart',bankod  from bankahrk where id=@id\r\n      \r\n       select @newid=SCOPE_IDENTITY()\r\n       update bankahrk set bankhrkid=@newid where id=@newid\r\n      \r\n      /*masraf gelir gider yansıması */\r\n         \r\n    \r\n          select @newid=0 \r\n          insert into carihrk (firmano,carhrkid,gctip,masterid,fisfattip,fisfatid,islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n          cartip,carkod,borc,alacak,bakiye,tarih,saat,olususer,olustarsaat,vadetar,belno,\r\n          ack,varno,kur,dataok,pro,varok,perkod,adaid,deguser,degtarsaat,sil,\r\n          karsihestip,karsiheskod,parabrm,CariAvans,\r\n          Karsi_Karttip,Karsi_KartKod)\r\n          select firmano,@newid,gctip,@bankhrkid,fisfattip,fisfatid,@gidtipkod,@gidtipad,@gidtiphrkkod,@gidtiphrkad,yertip,yerad,\r\n          'gelgidkart',@gidkod,@gidtutar*kur,0,0,tarih,saat,olususer,olustarsaat,vadetar,belno,\r\n          ack,varno,kur,dataok,1,varok,perkod,adaid,deguser,degtarsaat,sil,\r\n          'bankakart',bankod,parabrm,CariAvans,\r\n          'bankakart',bankod from bankahrk with (nolock) where id=@id\r\n          \r\n           select @newid=SCOPE_IDENTITY()\r\n           update carihrk set carhrkid=@newid where id=@newid\r\n          \r\n\r\n\r\n     end\r\n\r\n  \r\n  \r\nEND"
  },
  {
    "schema": "dbo",
    "name": "Cari_Vade_Gelir_Hrk",
    "definition": "CREATE PROCEDURE  [dbo].[Cari_Vade_Gelir_Hrk] (@id float,@sil int)\r\nAS\r\nBEGIN\r\n\r\ndeclare @newid float    \r\ndeclare @islmtip varchar(10)\r\ndeclare @islmhrk varchar(10)   \r\n\r\nset @islmtip='VAD'\r\nset @islmhrk='CVF'\r\n\r\n\r\n if @sil=1\r\n  begin\r\n    delete from carihrk where masterid=@id and islmtip=@islmtip and islmhrk=@islmhrk\r\n    RETURN\r\n  end\r\n  \r\n\r\n   if @sil=0\r\n   begin \r\n     delete from carihrk where masterid=@id and islmtip=@islmtip and islmhrk=@islmhrk \r\n    \r\n     select @newid=0 \r\n     insert into carihrk (firmano,carhrkid,gctip,masterid,carvardmasid,islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n     cartip,carkod,borc,alacak,tarih,saat,olususer,olustarsaat,vadetar,belno,\r\n     ack,varno,kur,dataok,pro,varok,perkod,adaid,deguser,degtarsaat,sil,parabrm)\r\n     select firmano,@newid,'-',@id,carvardmasid,islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n     karsihestip,karsiheskod,alacak,borc,tarih,saat,olususer,olustarsaat,tarih,belno,\r\n     ack,varno,kur,dataok,1,varok,perkod,adaid,deguser,degtarsaat,sil,parabrm\r\n     from carihrk with (nolock)  where carhrkid=@id and islmtip=@islmtip and islmhrk=@islmhrk \r\n\r\n     select @newid=SCOPE_IDENTITY()\r\n     update carihrk set carhrkid=@newid where id=@newid\r\n     \r\n   end\r\n    \r\n    \r\n\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "carifisaktaroto",
    "definition": "CREATE PROCEDURE [dbo].carifisaktaroto (@tar datetime,@verid float)\r\nAS\r\nBEGIN\r\n\r\ndeclare @newid float\r\ndeclare @fistip varchar(15)\r\ndeclare @gctip varchar(1)\r\ndeclare @borc float,@alacak float\r\ndeclare @fistutar float\r\ndeclare @islmtip varchar(10)\r\ndeclare @islmhrk varchar(10)\r\ndeclare @aktip   varchar(10)\r\ndeclare @aktar  datetime\r\n\r\n\r\n\r\ndeclare @islmtipad varchar(30)\r\ndeclare @islmhrkad varchar(30)\r\n\r\nset @islmtip='FIS'\r\nset @islmhrk='CAK'\r\n\r\nselect @islmtipad=ad from islemturtip where tip=@islmtip\r\nselect @islmhrkad=ad from islemhrktip where tip=@islmtip and hrk=@islmhrk\r\n\r\n\r\nSET @aktip='CH'\r\n  \r\n   DECLARE carifisaktarotoaktar CURSOR FAST_FORWARD FOR\r\n   SELECT vs.verid,vs.fistip,vs.toptut FROM veresimas as vs with (nolock) \r\n   inner join carikart as ck with (nolock) on ck.kod=vs.carkod and vs.cartip='carikart'\r\n   and vs.aktip='BK' and vs.sil=0 and vs.varok=1 and ck.otofisak=1 and vs.verid=@verid\r\n   \r\n\r\n   \r\n   OPEN carifisaktarotoaktar\r\n\r\n  FETCH NEXT FROM carifisaktarotoaktar INTO @verid,@fistip,@fistutar\r\n  WHILE @@FETCH_STATUS = 0\r\n  BEGIN\r\n  \r\n\r\n  set @borc=0\r\n  set @alacak=0\r\n  \r\n  if @fistip='FISVERSAT'\r\n  begin\r\n  set @gctip='B'\r\n  set @borc=@fistutar\r\n  end\r\n  \r\n  if @fistip='FISALCSAT'\r\n  begin\r\n  set @gctip='A'\r\n  set @alacak=@fistutar\r\n  end\r\n  \r\n  \r\n\r\n  select @newid=0\r\n  insert into carihrk (carhrkid,gctip,masterid,islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n  cartip,carkod,borc,alacak,tarih,saat,olususer,olustarsaat,vadetar,belno,\r\n  ack,varno,kur,dataok,pro,varok,perkod,adaid,deguser,degtarsaat,sil,parabrm,fisaktip)\r\n  select @newid,@gctip,@verid,@islmtip,@islmtipad,@islmhrk,@islmhrkad,yertip,yerad,\r\n  cartip,carkod,@borc,@alacak,tarih,saat,olususer,olustarsaat,vadtar,seri+cast([no] as varchar),\r\n  ack,varno,kur,dataok,1,varok,perkod,adaid,deguser,degtarsaat,sil,parabrm,@aktip\r\n  from veresimas with (nolock) where verid=@verid\r\n  \r\n  select @newid=SCOPE_IDENTITY()\r\n  update carihrk set carhrkid=@newid where id=@newid\r\n\r\n  set @aktar=convert(varchar,getdate(),101);\r\n\r\n  update veresimas set aktip=@aktip,akid=@newid,aktar=@aktar where verid=@verid\r\n\r\n\r\n  FETCH NEXT FROM carifisaktarotoaktar  INTO @verid,@fistip,@fistutar\r\n  END\r\n\r\n  CLOSE carifisaktarotoaktar\r\n  DEALLOCATE carifisaktarotoaktar\r\n\r\n\r\n\r\n  \r\n  \r\nEND"
  },
  {
    "schema": "dbo",
    "name": "CariFisVadeFark_Devir",
    "definition": "CREATE PROCEDURE [dbo].[CariFisVadeFark_Devir]\r\n@CariKod  varchar(50),\r\n@DevirTarih     datetime\r\nAS\r\nBEGIN\r\n\r\n\r\n \r\n\r\n\r\n   declare @TABLE_BAKIYE_BORC TABLE (\r\n   Id\t\t\t\t\tint IDENTITY(1, 1) NOT NULL,\r\n   TId\t\t\t\t\tint ,\r\n   CariTip\t\t\t    VARCHAR(20) COLLATE Turkish_CI_AS,\r\n   CariTip_Id\t\t\tint,\r\n   CariId\t\t\t\tint,\r\n   CariKod\t\t\t\tVARCHAR(30) COLLATE Turkish_CI_AS,\r\n   Bolundu              int default 0,\r\n   KTip                 int,\r\n   Borc      \t\t\tFloat,\r\n   Alacak\t\t\t\tFloat,\r\n   Odenen\t\t\t\tFloat default 0,\r\n   VadeTarih\t\t\tDateTime,\r\n   DevirliVadeTarih\t    DateTime,\r\n   VadeOran\t\t\t    float,\r\n   VadeGun\t\t\t\tint,\r\n   OdemeTarih\t\t\tDateTime,\r\n   VadeTutar\t\t\tfloat)\r\n   \r\n   \r\n   \r\n   \r\n   /*Vade Fark Tutarlar Sil */\r\n   \r\n  if @CariKod<>''\r\n  begin \r\n     delete From carihrk where islmtip='VAD' and islmhrk='OFD' \r\n     and cartip='carikart' and carkod=@CariKod and belno=YEAR(@DevirTarih)\r\n     \r\n     update veresimas Set DevirliVadeTarih=null \r\n     Where cartip='carikart' and carkod=@CariKod and Sil=0  and DevirliVadeTarih=@DevirTarih\r\n     and carkod in (select Kod From Carikart with (nolock) Where Kod=@CariKod and Sil=0 and Oto_FisVadeFark=1)\r\n  end  \r\n  else\r\n   begin\r\n     delete From carihrk where islmtip='VAD' and islmhrk='OFD' and belno=YEAR(@DevirTarih)\r\n    \r\n     update veresimas Set DevirliVadeTarih=null \r\n     Where cartip='carikart' and Sil=0  and DevirliVadeTarih=@DevirTarih\r\n     and carkod in (select Kod From Carikart with (nolock) Where Sil=0 and Oto_FisVadeFark=1)\r\n    \r\n   end \r\n\r\n\r\n  \r\n\r\n\r\n\r\n if @CariKod<>'' \r\n  insert into @TABLE_BAKIYE_BORC (TId,KTip,CariTip,CariKod,VadeTarih,DevirliVadeTarih,OdemeTarih,Borc,Alacak)\r\n  Select id,1 KTip,cartip,carkod,Tarih,null,null,Round(Borc,2),Round(Alacak,2) From CariHrk with (nolock) \r\n  Where cartip='carikart' and carkod=@CariKod\r\n  and Sil=0 and islmhrk not in ('FATVERSAT') and \r\n  carkod in (select Kod From Carikart with (nolock) Where Kod=@CariKod \r\n  and Sil=0 and Oto_FisVadeFark=1)\r\n  union all \r\n  /*if @TarihYon=1  */\r\n  /*insert into @Temp (TId,Tip,CariTip,CariKod,VadeTarih,DevirliVadeTarih,Borc,Alacak) */\r\n  Select id,2 KTip,cartip,carkod,case when DevirliVadeTarih is not null then DevirliVadeTarih else VadTar end,\r\n  DevirliVadeTarih,@DevirTarih,Round(toptut,2) Borc,0 Alacak From veresimas with (nolock) \r\n  Where cartip='carikart' and carkod=@CariKod and Sil=0 /*and VadTar<=@DevirTarih */\r\n  and carkod in (select Kod From Carikart with (nolock) Where Kod=@CariKod and Sil=0 and Oto_FisVadeFark=1)\r\n  order By Carkod\r\n  else\r\n  insert into @TABLE_BAKIYE_BORC (TId,KTip,CariTip,CariKod,VadeTarih,DevirliVadeTarih,OdemeTarih,Borc,Alacak)\r\n  Select id,1 KTip,cartip,carkod,Tarih,null,null,Round(Borc,2),Round(Alacak,2) From CariHrk with (nolock) \r\n  Where cartip='carikart' and Sil=0 and islmhrk not in ('FATVERSAT') and \r\n  carkod in (select Kod From Carikart with (nolock) Where Sil=0 and Oto_FisVadeFark=1)\r\n  union all \r\n  Select id,2 KTip,cartip,carkod,case when DevirliVadeTarih is not null then DevirliVadeTarih else VadTar end,\r\n  DevirliVadeTarih,@DevirTarih,Round(toptut,2) Borc,0 Alacak From veresimas with (nolock)\r\n  Where cartip='carikart' and Sil=0 /*and VadTar<=@DevirTarih */\r\n  and carkod in (select Kod From Carikart with (nolock) Where Sil=0 and Oto_FisVadeFark=1)\r\n  order By Carkod\r\n  \r\n  \r\n  \r\n  \r\n   \r\n    \r\n    \r\n    /* declare @T_Kod  varchar(50)\r\n     Set @T_Kod=''\r\n     set @Cari_Tip='carikart'\r\n     \r\n     ---- Bakiye Hesapla\r\n    \r\n     declare pom_var CURSOR FAST_FORWARD  FOR \r\n     select TId,KTip,CariKod,VadeTarih,DevirliVadeTarih,Borc,Alacak from @Temp order by CariKod,VadeTarih \r\n     open pom_var\r\n     fetch next from  pom_var into @TId,@KTip,@Kod,@Tarih,@DevirliVadeTarih,@Borc,@Alacak\r\n      while @@FETCH_STATUS=0\r\n      begin\r\n  \r\n      if @T_Kod<>@Kod \r\n      begin\r\n       set @Bakiye=@Borc-@Alacak\r\n      end\r\n       else\r\n        set @Bakiye=@Bakiye+@Borc-@Alacak\r\n      \r\n      \r\n       Set @Tip=1 \r\n      if  @Alacak>0 \r\n        Set @Tip=2 \r\n       \r\n       \r\n      insert into @TABLE_BAKIYE_BORC (TId,KTip,Tip,CariTip,CariKod,VadeTarih,DevirliVadeTarih,Borc,Alacak,Bakiye)\r\n      values (@TId,@KTip,@Tip,@Cari_Tip,@Kod,@Tarih,@DevirliVadeTarih,@Borc,@Alacak,@Bakiye)\r\n   \r\n      Set @T_Kod=@Kod \r\n  \r\n  \r\n      FETCH next from  pom_var into @TId,@KTip,@Kod,@Tarih,@DevirliVadeTarih,@Borc,@Alacak\r\n     end\r\n    close Pom_Var\r\n    deallocate pom_var\r\n    \r\n    \r\n  \r\n  --- Vade Fark Hesapla\r\n    Set @T_Kod=''\r\n    Declare @STarih Datetime\r\n    declare pom_var CURSOR FAST_FORWARD  FOR \r\n     select Id,CariKod,Bakiye from @TABLE_BAKIYE_BORC where Tip=1 order by Id \r\n     open pom_var\r\n     fetch next from  pom_var into @Id,@Kod,@Bakiye\r\n      while @@FETCH_STATUS=0\r\n      begin\r\n  \r\n      \r\n      \r\n       if @Bakiye>0\r\n       begin   \r\n        Set @STarih=null\r\n        \r\n        Select top 1 @STarih=VadeTarih From @TABLE_BAKIYE_BORC Where CariKod=@Kod and ID>@Id and Tip=2\r\n       \r\n         if @STarih is null\r\n         set  @STarih=@DevirTarih--DATEADD(day, DATEDIFF(day, 0, GetDate()), 0)\r\n        \r\n         --if @STarih<=@BitTarih\r\n           update @TABLE_BAKIYE_BORC set OdemeTarih=@STarih where Id=@Id\r\n       \r\n       \r\n       end\r\n      \r\n      \r\n           \r\n    \r\n  \r\n  \r\n      FETCH next from  pom_var into @Id,@Kod,@Bakiye\r\n     end\r\n    close Pom_Var\r\n    deallocate pom_var\r\n    */\r\n    \r\n    \r\n    declare @Id int,@TId int,@Say int,@KTip int\r\n    declare @Kod varchar(50),@Cari_Tip  varchar(30)\r\n    declare @Borc Float,@Alacak  Float\r\n    declare @Bakiye  Float\r\n    declare @Tarih  Datetime\r\n    declare @DevirliVadeTarih Datetime\r\n    \r\n    Declare @Odenen  float  /*Hem Fiş Hemde Alacaktan Düşecek */\r\n    Declare @FisBorc  float\r\n    Declare @FisBakiye  float\r\n    Declare @AlacakBakiye  float\r\n    \r\n    Declare @TempId\t  float\r\n    Declare @Sayac  int,@MaxSayac int\r\n    Declare @OdemeTarih  Datetime\r\n    \r\n     \r\n    /*- Vade Fark Hesapla */\r\n \r\n    Declare @STarih Datetime\r\n    declare pom_var CURSOR FAST_FORWARD  FOR \r\n     select Id,CariKod,Round(Alacak,2),VadeTarih as OdemeTarih from @TABLE_BAKIYE_BORC \r\n     where  Round(Alacak,2)>0  /* and KTip=1 */\r\n     order by CariKod,VadeTarih\r\n     open pom_var\r\n     fetch next from  pom_var into @Id,@Kod,@Alacak,@OdemeTarih\r\n      while @@FETCH_STATUS=0\r\n      begin\r\n  \r\n  \r\n       set @AlacakBakiye=@Alacak\r\n       \r\n       set @Sayac=1\r\n       set @MaxSayac=50\r\n      \r\n        \r\n      \r\n      \r\n       while @Sayac<@MaxSayac \r\n       begin\r\n       \r\n        Set @TempId=null\r\n        \r\n        \r\n        \r\n        /* Borc ve Vade Tarihi Bilgileri */\r\n         Select top 1 @TempId=Id,@FisBorc=Round(Borc,2) From @TABLE_BAKIYE_BORC \r\n         Where CariKod=@Kod and round(Borc-Odenen,2)>0 and Bolundu=0  /*and KTip=2 */\r\n         order by VadeTarih,TId\r\n       \r\n       \r\n         /* print('Id='+cast(@Id as  varchar(20))+' TempId='+cast(@TempId as  varchar(20)) ) */\r\n       \r\n          if @TempId is null  /*Bakiye Yoksa */\r\n          begin\r\n            set @sayac=@MaxSayac\r\n            /*set  @OdemeTarih=@DevirTarih--DATEADD(day, DATEDIFF(day, 0, GetDate()), 0) */\r\n            \r\n          end  \r\n         else \r\n          begin\r\n             /*Borc Bakiyesi Alacaktan Buyukse İse */\r\n             /* Kalan Borc Kadar Yeni Fis Hrk Olustur */\r\n                     \r\n             \r\n             \r\n             if @AlacakBakiye<@FisBorc\r\n              begin\r\n               set @FisBakiye=(@FisBorc-@AlacakBakiye)\r\n               \r\n                insert into @TABLE_BAKIYE_BORC (TId,KTip,CariTip,CariKod,VadeTarih,DevirliVadeTarih,Borc,Alacak)\r\n                select TId,KTip,CariTip,CariKod,VadeTarih,DevirliVadeTarih,@FisBakiye,0  from @TABLE_BAKIYE_BORC\r\n                where Id=@TempId\r\n                 \r\n                /*Borc İcin    */\r\n                update @TABLE_BAKIYE_BORC set OdemeTarih=@OdemeTarih,Odenen=@AlacakBakiye,Bolundu=1 where Id=@TempId \r\n              \r\n                 /*Odeme İşlemi İçin  */\r\n                 update @TABLE_BAKIYE_BORC set Odenen=Odenen+@AlacakBakiye where Id=@Id \r\n              \r\n               set @AlacakBakiye=0\r\n               set @sayac=@MaxSayac\r\n               \r\n               /* print('BREAK Id='+cast(@Id as  varchar(20))+' TempId='+cast(@TempId as  varchar(20)) ) */\r\n                \r\n                BREAK\r\n               \r\n              end\r\n             /*Borc Bakiyesi Alacaktan Kücük İse  */\r\n                          \r\n              if @AlacakBakiye>=@FisBorc\r\n              begin\r\n                 \r\n                /*Borc İçin                  */\r\n                update @TABLE_BAKIYE_BORC set OdemeTarih=@OdemeTarih,Odenen=@FisBorc where Id=@TempId \r\n        \r\n                 /*Odeme İşlemi İçin  */\r\n                 update @TABLE_BAKIYE_BORC set Odenen=Odenen+@FisBorc where Id=@Id \r\n        \r\n        \r\n                set @AlacakBakiye=@AlacakBakiye-@FisBorc\r\n                \r\n                set @sayac=@sayac+1\r\n              end\r\n             \r\n             \r\n             \r\n          end \r\n       \r\n       \r\n          \r\n       end\r\n  \r\n  \r\n      FETCH next from  pom_var into @Id,@Kod,@Alacak,@OdemeTarih\r\n     end\r\n    close Pom_Var\r\n    deallocate pom_var\r\n    \r\n    \r\n    update @TABLE_BAKIYE_BORC Set CariId=dt.id,VadeOran=Dt.fisvadfark \r\n    From @TABLE_BAKIYE_BORC as t\r\n    join (select id,kod,fisvadfark from carikart) dt on dt.Kod=t.CariKod\r\n  \r\n    Update @TABLE_BAKIYE_BORC Set VadeTutar=0,VadeGun=0\r\n   \r\n    \r\n    Update @TABLE_BAKIYE_BORC Set VadeGun=\r\n    case when CONVERT(float, OdemeTarih - VadeTarih)>0 then \r\n    CONVERT(float, OdemeTarih - VadeTarih)  else 0 end\r\n    Where Ktip=2  /*Sadece Fis İslemine */\r\n\r\n   \r\n    Update @TABLE_BAKIYE_BORC Set VadeTutar= Borc*(VadeGun*(VadeOran/30)/100)\r\n    \r\n    \r\n    /*if @GunTarih>@DevirTarih */\r\n    /*Update @TABLE_BAKIYE_BORC Set Vade_Tutar=0 where Odeme_Tarih<=@DevirTarih */\r\n    \r\n    /*if @GunTarih=@DevirTarih */\r\n    Update @TABLE_BAKIYE_BORC Set VadeTutar=0 where OdemeTarih>=@DevirTarih\r\n    \r\n    \r\n   /*  Declare @Tarih Datetime */\r\n     Declare @Saat varchar(10)\r\n  \r\n     Set @Tarih=@DevirTarih\r\n     Set @Saat='00:00:00'\r\n    \r\n    \r\n    if @CariKod<>''\r\n     delete From VeresiVadeFarkHrk where Tarih=@Tarih \r\n     and CarId in (Select id from carikart Where kod=@CariKod)\r\n    else\r\n     delete From VeresiVadeFarkHrk where Tarih=@Tarih \r\n \r\n\r\n    \r\n     insert into VeresiVadeFarkHrk (CarTip,CarId,Tarih,VadeOran,Borc,Alacak,VadeFark,\r\n      olususer,olustarsaat)\r\n      select 1,CariId,@Tarih,\r\n      max(VadeOran),Sum(Borc) Borc,Sum(Alacak) Alacak,\r\n      sum(VadeTutar),'SERVIS',GetDate() from @TABLE_BAKIYE_BORC group by CariId\r\n\r\n\r\n     \r\n     insert into carihrk (carhrkid,gctip,yerad,yertip,\r\n     islmtip,islmhrk,islmtipad,islmhrkad,cartip,cartip_id,carkod,car_id,\r\n     borc,alacak,bakiye,vadetar,tarih,saat,ack,olususer,olustarsaat,masterid,varno,belno) \r\n     select 0,'G','CARİ KART','carikart','VAD','OFD',\r\n     'VADE','CARİ OTO. FİŞ VADE DEVİR','carikart',1,CariKod,CariId,\r\n     sum(ISNULL(VadeTutar,0)),\r\n     0,0,@Tarih,@Tarih,\r\n     @Saat,'OTOMATİK FİŞ VADE DEVİR','SERVIS',GetDate(),0,0,YEAR(@DevirTarih) \r\n     from @TABLE_BAKIYE_BORC group by \r\n     CariKod,CariId\r\n     \r\n     \r\n     update carihrk set carhrkid=id where tarih=@Tarih \r\n     and islmtip='VAD' and islmhrk='OFD' and belno=YEAR(@DevirTarih)\r\n    \r\n     update veresimas set DevirliVadeTarih=@DevirTarih where \r\n     DevirliVadeTarih is null and id in \r\n     (Select TId From @TABLE_BAKIYE_BORC \r\n     Where KTip=2 and OdemeTarih<@DevirTarih and VadeTarih<@DevirTarih ) \r\n    \r\n    select * from @TABLE_BAKIYE_BORC order by VadeTarih\r\n\r\n    select CariKod,Sum(isnull(VadeTutar,0)) from @TABLE_BAKIYE_BORC    Group By CariKod\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "CariFisVadeFark_Oto",
    "definition": "CREATE PROCEDURE [dbo].[CariFisVadeFark_Oto]\r\n@CariKod  varchar(50),\r\n@Devirlimi   bit\r\nAS\r\nBEGIN\r\n\r\n\r\n  \r\n\r\n   declare @TABLE_BAKIYE_BORC TABLE (\r\n   Id\t\t\t\t\tint IDENTITY(1, 1) NOT NULL,\r\n   TId\t\t\t\t\tint ,\r\n   CariTip\t\t\t    VARCHAR(20) COLLATE Turkish_CI_AS,\r\n   CariTip_Id\t\t\tint,\r\n   CariId\t\t\t\tint,\r\n   CariKod\t\t\t\tVARCHAR(30) COLLATE Turkish_CI_AS,\r\n   Bolundu              int default 0,\r\n   KTip                 int,\r\n   Borc      \t\t\tFloat,\r\n   Alacak\t\t\t\tFloat,\r\n   Odenen\t\t\t\tFloat default 0,\r\n   VadeTarih\t\t\tDateTime,\r\n   DevirliVadeTarih\t    DateTime,\r\n   VadeOran\t\t\t    float,\r\n   VadeGun\t\t\t\tint,\r\n   OdemeTarih\t\t\tDateTime,\r\n   VadeTutar\t\t\tfloat)\r\n   \r\n   \r\n   /*Vade Fark Tutarlar Sil */\r\n   \r\n  declare @GunTarih datetime\r\n  set @GunTarih=DATEADD(day, DATEDIFF(day, 0, GetDate()), 0)\r\n   \r\n  if @CariKod<>'' \r\n   delete From carihrk where islmtip='VAD' and islmhrk='OFV' \r\n   and cartip='carikart' and carkod=@CariKod\r\n  else\r\n   delete From carihrk where islmtip='VAD' and islmhrk='OFV'  \r\n\r\n\r\n\r\n   \r\n if @CariKod<>'' \r\n  insert into @TABLE_BAKIYE_BORC (TId,KTip,CariTip,CariKod,VadeTarih,DevirliVadeTarih,OdemeTarih,Borc,Alacak)\r\n  Select id,1 KTip,cartip,carkod,Tarih,null,null,Round(Borc,2),Round(Alacak,2) From CariHrk with (nolock) \r\n  Where cartip='carikart' and carkod=@CariKod\r\n  and Sil=0 and islmhrk not in ('FATVERSAT') and \r\n  carkod in (select Kod From Carikart with (nolock) Where Kod=@CariKod \r\n  and Sil=0 and Oto_FisVadeFark=1)\r\n  union all \r\n  \r\n  Select id,1 KTip,cartip,carkod,Tarih,\r\n  DevirliVadeTarih,@GunTarih,0 Borc,Round(toptut,2) Alacak From veresimas with (nolock) \r\n  Where cartip='carikart' and carkod=@CariKod and Sil=0 and fistip = 'FISALCSAT'\r\n  and carkod in (select Kod From Carikart with (nolock) Where Kod=@CariKod and Sil=0 and Oto_FisVadeFark=1)\r\n  union all \r\n  \r\n  Select id,2 KTip,cartip,carkod, \r\n  case \r\n  when @Devirlimi=0  and DevirliVadeTarih is not null then DevirliVadeTarih \r\n  when @Devirlimi=0  and DevirliVadeTarih is null then VadTar \r\n  when @Devirlimi=1  then  VadTar \r\n  end, \r\n  DevirliVadeTarih,@GunTarih,Round(toptut,2) Borc,0 Alacak From veresimas with (nolock) \r\n  Where cartip='carikart' and carkod=@CariKod and Sil=0 and fistip != 'FISALCSAT'\r\n  and carkod in (select Kod From Carikart with (nolock) Where Kod=@CariKod and Sil=0 and Oto_FisVadeFark=1)\r\n  order By Carkod\r\n  \r\n  else\r\n  \r\n  insert into @TABLE_BAKIYE_BORC (TId,KTip,CariTip,CariKod,VadeTarih,DevirliVadeTarih,OdemeTarih,Borc,Alacak)\r\n  Select id,1 KTip,cartip,carkod,Tarih,null,null,Round(Borc,2),Round(Alacak,2) From CariHrk with (nolock) \r\n  Where cartip='carikart' and Sil=0 and islmhrk not in ('FATVERSAT') and \r\n  carkod in (select Kod From Carikart with (nolock) Where Sil=0 and Oto_FisVadeFark=1)\r\n  union all \r\n  \r\n  Select id,1 KTip,cartip,carkod,\r\n  case \r\n  when @Devirlimi=0  and DevirliVadeTarih is not null then DevirliVadeTarih \r\n  when @Devirlimi=0  and DevirliVadeTarih is null then VadTar \r\n  when @Devirlimi=1  then  VadTar \r\n  end,\r\n  DevirliVadeTarih,@GunTarih,0 Borc,Round(toptut,2) Alacak From veresimas with (nolock)\r\n  Where cartip='carikart' and Sil=0 and fistip = 'FISALCSAT'\r\n  and carkod in (select Kod From Carikart with (nolock)  Where Sil=0 and Oto_FisVadeFark=1)\r\n  union all \r\n  \r\n  \r\n  Select id,2 KTip,cartip,carkod,\r\n  case \r\n  when @Devirlimi=0  and DevirliVadeTarih is not null then DevirliVadeTarih \r\n  when @Devirlimi=0  and DevirliVadeTarih is null then VadTar \r\n  when @Devirlimi=1  then  VadTar  \r\n  end,    \r\n  DevirliVadeTarih,@GunTarih,Round(toptut,2) Borc,0 Alacak From veresimas with (nolock)\r\n  Where cartip='carikart' and Sil=0 and fistip != 'FISALCSAT'\r\n  and carkod in (select Kod From Carikart with (nolock)  Where Sil=0 and Oto_FisVadeFark=1)\r\n  order By Carkod\r\n  \r\n  \r\n  \r\n  \r\n    declare @Id int,@TId int,@Say int,@KTip int\r\n    declare @Kod varchar(50),@Cari_Tip  varchar(30)\r\n    declare @Borc Float,@Alacak  Float\r\n    declare @Bakiye  Float\r\n    declare @Tarih  Datetime\r\n    declare @DevirliVadeTarih Datetime\r\n  \r\n  \r\n  \r\n \r\n    \r\n    Declare @Odenen  float  /*Hem Fiş Hemde Alacaktan Düşecek */\r\n    Declare @FisBorc  float\r\n    Declare @FisBakiye  float\r\n    Declare @AlacakBakiye  float\r\n    \r\n    Declare @TempId\t  float\r\n    Declare @Sayac  int,@MaxSayac int\r\n    Declare @OdemeTarih  Datetime\r\n    Declare @FisVadeTarih  Datetime\r\n    \r\n     \r\n   /*- Vade Fark Hesapla */\r\n \r\n    Declare @STarih Datetime\r\n    declare pom_var CURSOR FAST_FORWARD  FOR \r\n     select Id,CariKod,Round(Alacak,2),VadeTarih as OdemeTarih from @TABLE_BAKIYE_BORC \r\n     where Round(Alacak,2)>0  /* and KTip=1  */\r\n     order by CariKod,VadeTarih\r\n     open pom_var\r\n     fetch next from  pom_var into @Id,@Kod,@Alacak,@OdemeTarih\r\n      while @@FETCH_STATUS=0\r\n      begin\r\n  \r\n  \r\n       set @AlacakBakiye=@Alacak\r\n       \r\n       set @Sayac=1\r\n       set @MaxSayac=50\r\n      \r\n        \r\n      \r\n      \r\n       while @Sayac<@MaxSayac \r\n       begin\r\n       \r\n        Set @TempId=null\r\n        set @FisVadeTarih=null\r\n        \r\n        \r\n        \r\n        /*Fiş Borç ve Vade Tarihi Bilgileri */\r\n         Select top 1 @TempId=Id,@FisBorc=Round(Borc,2),@FisVadeTarih=VadeTarih From @TABLE_BAKIYE_BORC \r\n         Where CariKod=@Kod and round(Borc-Odenen,2)>0 and Bolundu=0 /*and KTip=2 */\r\n         order by VadeTarih,TId\r\n       \r\n       \r\n         /* print('Id='+cast(@Id as  varchar(20))+' TempId='+cast(@TempId as  varchar(20)) ) */\r\n       \r\n          if @TempId is null  /*Bakiye Yoksa */\r\n          begin\r\n            set @sayac=@MaxSayac\r\n            break\r\n            /*set  @OdemeTarih=@DevirTarih--DATEADD(day, DATEDIFF(day, 0, GetDate()), 0) */\r\n            \r\n          end  \r\n         else \r\n          begin\r\n             /*Fis Bakiyesi Alacaktan Buyukse İse */\r\n             /* Kalan Borc Kadar Yeni Fis Hrk Olustur */\r\n                     \r\n             \r\n             \r\n             if @AlacakBakiye<@FisBorc\r\n              begin\r\n               set @FisBakiye=(@FisBorc-@AlacakBakiye)\r\n               \r\n                insert into @TABLE_BAKIYE_BORC (TId,KTip,CariTip,CariKod,VadeTarih,DevirliVadeTarih,Borc,Alacak)\r\n                select TId,KTip,CariTip,CariKod,case when @FisVadeTarih>@OdemeTarih then @FisVadeTarih else @OdemeTarih end,\r\n                DevirliVadeTarih,@FisBakiye,0  from @TABLE_BAKIYE_BORC\r\n                where Id=@TempId               /*VadeTarih */\r\n                 \r\n                /*borc İcin    */\r\n                update @TABLE_BAKIYE_BORC set OdemeTarih=@OdemeTarih,Odenen=@AlacakBakiye,Bolundu=1 where Id=@TempId \r\n              \r\n                 /*Odeme İşlemi İçin  */\r\n                 update @TABLE_BAKIYE_BORC set Odenen=Odenen+@AlacakBakiye where Id=@Id \r\n              \r\n               set @AlacakBakiye=0\r\n               set @sayac=@MaxSayac\r\n               \r\n               /* print('BREAK Id='+cast(@Id as  varchar(20))+' TempId='+cast(@TempId as  varchar(20)) ) */\r\n                \r\n                BREAK\r\n               \r\n              end\r\n             /*borc Bakiyesi Alacaktan Kücük İse  */\r\n                          \r\n              if @AlacakBakiye>=@FisBorc\r\n              begin\r\n                 \r\n                /*borc İçin                  */\r\n                update @TABLE_BAKIYE_BORC set OdemeTarih=@OdemeTarih,Odenen=@FisBorc where Id=@TempId \r\n        \r\n                 /*Odeme İşlemi İçin  */\r\n                 update @TABLE_BAKIYE_BORC set Odenen=Odenen+@FisBorc where Id=@Id \r\n        \r\n        \r\n                set @AlacakBakiye=@AlacakBakiye-@FisBorc\r\n                \r\n                set @sayac=@sayac+1\r\n              end\r\n             \r\n             \r\n             \r\n          end \r\n       end\r\n  \r\n  \r\n      FETCH next from  pom_var into @Id,@Kod,@Alacak,@OdemeTarih\r\n     end\r\n    close Pom_Var\r\n    deallocate pom_var\r\n    \r\n    \r\n    update @TABLE_BAKIYE_BORC Set CariId=dt.id,VadeOran=Dt.fisvadfark \r\n    From @TABLE_BAKIYE_BORC as t\r\n    join (select id,kod,fisvadfark from carikart with (nolock) )\r\n     dt on dt.Kod=t.CariKod\r\n  \r\n   Update @TABLE_BAKIYE_BORC Set VadeTutar=0,VadeGun=0\r\n   \r\n    \r\n    update @TABLE_BAKIYE_BORC set  OdemeTarih=@GunTarih \r\n    where OdemeTarih is null and Ktip=2\r\n  \r\n    \r\n    Update @TABLE_BAKIYE_BORC Set VadeGun=\r\n    case when round(CONVERT(float, OdemeTarih - VadeTarih),0)>0 then \r\n    round(CONVERT(float, OdemeTarih - VadeTarih),0) else 0 end\r\n    Where Ktip=2  /*Sadece Fis İslemine */\r\n\r\n   \r\n    Update @TABLE_BAKIYE_BORC Set VadeTutar=Borc*(VadeGun*(VadeOran/30)/100)\r\n    \r\n    \r\n    \r\n   /*  Declare @Tarih Datetime */\r\n     Declare @Saat varchar(10)\r\n  \r\n     Set @Tarih=@GunTarih\r\n     Set @Saat=CONVERT(VARCHAR(8),@GunTarih,108)\r\n    \r\n    \r\n    if @CariKod<>''\r\n     delete From VeresiVadeFarkHrk where Tarih=@Tarih \r\n     and CarId in (Select id from carikart Where kod=@CariKod)\r\n    else\r\n     delete From VeresiVadeFarkHrk where Tarih=@Tarih \r\n \r\n\r\n    \r\n     insert into VeresiVadeFarkHrk (CarTip,CarId,Tarih,VadeOran,Borc,Alacak,VadeFark,\r\n      olususer,olustarsaat)\r\n      select 1,CariId,@Tarih,\r\n      max(VadeOran),Sum(Borc) Borc,Sum(Alacak) Alacak,\r\n      sum(VadeTutar),'SERVIS',GetDate() from @TABLE_BAKIYE_BORC group by CariId\r\n\r\n\r\n     \r\n     insert into carihrk (carhrkid,gctip,yerad,yertip,\r\n     islmtip,islmhrk,islmtipad,islmhrkad,cartip,cartip_id,carkod,car_id,\r\n     borc,alacak,bakiye,vadetar,tarih,saat,ack,olususer,olustarsaat,masterid,varno) \r\n     select 0,'G','CARİ KART','carikart','VAD','OFV',\r\n     'VADE','CARI OTO. FIŞ VADE FARKI','carikart',1,CariKod,CariId,\r\n     sum(ISNULL(VadeTutar,0)),\r\n     0,0,@Tarih,@Tarih,\r\n     @Saat,'OTOMATİK FİŞVADE FARKI','SERVIS',GetDate(),0,0  \r\n     from @TABLE_BAKIYE_BORC group by \r\n     CariKod,CariId\r\n     \r\n     \r\n     update carihrk set carhrkid=id where tarih=@Tarih and islmtip='VAD' \r\n     and islmhrk='OFV'\r\n   \r\n       \r\n    \r\n    select * from @TABLE_BAKIYE_BORC ORDER BY VadeTarih,TId\r\n    \r\n    \r\n    select CariKod,Sum(isnull(VadeTutar,0)) from @TABLE_BAKIYE_BORC    Group By CariKod\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "carikartacilis",
    "definition": "CREATE PROCEDURE [dbo].carikartacilis @cartip varchar(20),@carkod varchar(20)\r\nAS\r\nBEGIN\r\n\r\ndeclare @kod varchar(20);\r\ndeclare @actutar float,@idx float;\r\ndeclare @borc float,@alacak float,@carhrkid float;\r\ndeclare @olustar datetime,@tarx datetime;\r\ndeclare @saatx varchar(8),@gctip varchar(2);\r\ndeclare @user varchar(50);\r\n\r\n\r\nif @cartip='carikart'\r\nselect @idx=id,@kod=kod,@actutar=actutar,@olustar=olustarsaat,@user=olususer from carikart\r\nwhere kod=@carkod\r\n\r\nif @cartip='perkart'\r\nselect @idx=id,@kod=kod,@actutar=actutar,@olustar=olustarsaat,@user=olususer from perkart\r\nwhere kod=@carkod\r\n\r\nif @cartip='gelgidkart'\r\nselect @idx=id,@kod=kod,@actutar=actutar,@olustar=olustarsaat,@user=olususer from gelgidkart\r\nwhere kod=@carkod\r\n\r\nif @cartip='bankakart'\r\nselect @idx=id,@kod=kod,@actutar=actutar,@olustar=olustarsaat,@user=olususer from bankakart\r\nwhere kod=@carkod\r\n\r\nif @cartip='istkredikart'\r\nselect @idx=id,@kod=kod,@actutar=actutar,@olustar=olustarsaat,@user=olususer from istkart\r\nwhere kod=@carkod\r\n\r\n\r\n\r\nif @actutar<>0 begin\r\nset @tarx=convert(varchar,@olustar,101);\r\nset @saatx=convert(varchar,@olustar,108);\r\n\r\nset @borc=0;\r\nset @alacak=0;\r\n\r\nif @actutar<0\r\nbegin\r\nset @alacak=-@actutar;\r\nset @gctip='B';\r\nend;\r\n\r\nif @actutar>0\r\nbegin\r\nset @borc=@actutar;\r\nset @gctip='A';\r\nend;\r\n\r\nif (@cartip='carikart') or (@cartip='perkart') or (@cartip='gelgidkart')\r\nbegin\r\nselect @carhrkid=isnull(max(carhrkid),0)+1 from carihrk;\r\ninsert into carihrk (carhrkid,gctip,yerad,yertip,islmtip,islmhrk,islmtipad,islmhrkad,cartip,\r\ncarkod,borc,alacak,bakiye,tarih,saat,olususer,olustarsaat,masterid,varno) values\r\n(@carhrkid,@gctip,'Cari Kartlar','carikart','ISL','KAC','İŞLEM','KART AÇILIŞ',@cartip,\r\n@kod,@borc,@alacak,(@borc-@alacak),@tarx,@saatx,\r\n@user,@olustar,@idx,0);\r\nend\r\n\r\nif (@cartip='bankakart')\r\nbegin\r\nselect @carhrkid=isnull(max(bankhrkid),0)+1 from bankahrk;\r\ninsert into bankahrk (bankhrkid,gctip,yerad,yertip,islmtip,islmhrk,islmtipad,islmhrkad,cartip,\r\nbankod,borc,alacak,tarih,saat,olususer,olustarsaat,masterid,varno) values\r\n(@carhrkid,@gctip,'BANKA KARTLARI','bankakart','ISL','KAC','İŞLEM','KART AÇILIŞ',@cartip,\r\n@kod,@borc,@alacak,@tarx,@saatx,\r\n@user,@olustar,@idx,0);\r\nend\r\n\r\nif (@cartip='istkredikart')\r\nbegin\r\nselect @carhrkid=isnull(max(istkhrkid),0)+1 from istkhrk;\r\ninsert into istkhrk (istkhrkid,gctip,yerad,yertip,islmtip,islmhrk,islmtipad,islmhrkad,cartip,\r\ncarkod,borc,alacak,tarih,saat,olususer,olustarsaat,masterid,varno) values\r\n(@carhrkid,@gctip,'İŞLETME KREDI KARTLARI','istkredikart','ISL','KAC','İŞLEM','KART AÇILIŞ',@cartip,\r\n@kod,@borc,@alacak,@tarx,@saatx,\r\n@user,@olustar,@idx,0);\r\nend\r\n\r\nend;\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "CEK_ALTTOPLAM",
    "definition": "CREATE PROCEDURE [dbo].CEK_ALTTOPLAM \r\n@DRMIN VARCHAR(4000)\r\nAS\r\nBEGIN\r\n\r\n  if object_id( 'tempdb..#TB_CEK_ALTTOP' ) is null\r\n  CREATE TABLE [dbo].[#TB_CEK_ALTTOP] (id int IDENTITY,\r\n  ACIKLAMA  VARCHAR(50) COLLATE Turkish_CI_AS,\r\n  TUTAR     FLOAT,\r\n  GCTIP     INT)\r\n\r\n     execute ('insert into #TB_CEK_ALTTOP \r\n     (ACIKLAMA,TUTAR,GCTIP)\r\n     SELECT d.ad,\r\n     sum(case when islmhrk=''ALN'' then giren\r\n     else cikan end),\r\n     case when islmhrk=''ALN'' then 1\r\n     else -1 end from cekkart \r\n     left join cektip as d on d.kod=cekkart.drm\r\n     where '+@DRMIN+' group by d.ad,cekkart.islmhrk')\r\n     \r\n     \r\n     \r\n     execute ('insert into #TB_CEK_ALTTOP \r\n     (ACIKLAMA,TUTAR,GCTIP)\r\n     SELECT ''ALT TOPLAM FARKI'',\r\n     sum(TUTAR*GCTIP),0  from #TB_CEK_ALTTOP')  \r\n     \r\n     \r\n     \r\n     \r\n     \r\n     \r\n\r\n     select * FROM #TB_CEK_ALTTOP\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "cekhrkgiris",
    "definition": "CREATE  PROCEDURE [dbo].cekhrkgiris @hrkid float\r\nAS\r\nBEGIN\r\n\r\ndeclare @varno float\r\ndeclare @baktop float\r\ndeclare @newid float\r\ndeclare @gctip varchar(1)\r\ndeclare @giren float,@cikan float\r\ndeclare @cekdrm varchar(20)\r\ndeclare @CEKBAK float\r\n  \r\ndeclare @islmtip varchar(20),@islmhrk varchar(20),\r\n@cartip varchar(20)\r\ndeclare @cekhrkid float\r\ndeclare @bankahrkid float\r\ndeclare @kasahrkid float\r\ndeclare @drmhrkid float\r\n/*-masraf */\r\ndeclare @gidtipkod varchar(20)\r\ndeclare @gidtiphrkkod varchar(20)\r\ndeclare @gidtipad varchar(30)\r\ndeclare @gidtiphekad varchar(30)\r\n/*-masraf */\r\n\r\ndeclare @carkod varchar(50)\r\ndeclare @tahcartip varchar(20),@tahcarkod varchar(20)\r\ndeclare @gidkod varchar(20),@gidtutar float\r\n\r\n\r\ndeclare @vercarkod varchar(50)\r\n\r\n\r\ndeclare @hrkdrm varchar(20)\r\n\r\n\r\n if @hrkid=0\r\n  RETURN\r\n\r\n\r\n  select @drmhrkid=hrkid,@cekdrm=drm,@gctip=gctip,\r\n  @cekhrkid=cekid,@islmtip=islmtip,@islmhrk=islmhrk,\r\n  @giren=giren,@cikan=cikan,@varno=varno,\r\n  @cartip=case when gctip='C' then vercartip else cartip end,\r\n  @carkod=case when gctip='C' then vercarkod else carkod end,\r\n  @vercarkod=vercarkod,\r\n  @tahcartip=tahcartip,@tahcarkod=tahcarkod,@gidkod=gidkod,\r\n  @gidtutar=gidtutar from cekkart with (nolock)\r\n  where cekid=@hrkid\r\n\r\n\r\n  update cekhrk set aktif=0 where cekid=@hrkid \r\n\r\n  select @hrkdrm=drm from cekhrk where id =@drmhrkid\r\n   \r\n\r\n   update cekhrk set aktif=1 where cekid=@hrkid and id >=\r\n   (select top 1 id from cekhrk with (nolock) where cekid=@hrkid and drm in              \r\n   ('KSN','POR') order by id desc ) \r\n\r\n\r\n if (@hrkdrm='CGR')\r\n  begin\r\n      select @newid=0\r\n      insert into carihrk (firmano,cekid,carhrkid,gctip,masterid,fisfattip,fisfatid,\r\n      islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n      cartip,carkod,borc,alacak,bakiye,tarih,saat,olususer,olustarsaat,vadetar,belno,\r\n      ack,varno,kur,pro,varok,perkod,adaid,deguser,degtarsaat,sil,\r\n      karsihestip,karsiheskod,parabrm,\r\n      Karsi_Karttip,Karsi_KartKod)\r\n      select m.firmano,m.cekid,@newid,@gctip,@cekhrkid,m.fisfattip,m.fisfatid,\r\n      m.islmtip,m.islmtipad,h.drm,h.drmad,h.yertip,h.yerad,\r\n      h.cartip,h.carkod,0,giren*m.kur,0,h.tarih,h.saat,h.olususer,h.olustarsaat,m.vadetar,m.ceksenno,\r\n      h.ack,0,/*m.varno, */\r\n      m.kur,1,m.varok,m.perkod,m.adaid,h.olususer,h.olustarsaat,m.sil,\r\n      'cekkart',m.refno,m.parabrm,\r\n      'cekkart',m.refno\r\n       from cekkart as m  with (nolock) inner join cekhrk as h with (nolock)\r\n      on h.id=m.hrkid where m.cekid=@hrkid and h.id=@drmhrkid\r\n      \r\n      select @newid=SCOPE_IDENTITY()\r\n      update carihrk set carhrkid=@newid where id=@newid\r\n  \r\n  \r\n  \r\n  end\r\n\r\n\r\n if (@cekdrm='PKR') OR (@cekdrm='TKR') OR (@cekdrm='CKR')\r\n  begin\r\n   if (@cekdrm='PKR') OR (@cekdrm='TKR')\r\n     begin\r\n\r\n      /*- cek alinan cari ters hareket   */\r\n      select @newid=0\r\n      insert into carihrk (firmano,cekid,carhrkid,gctip,masterid,fisfattip,fisfatid,\r\n      islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n      cartip,carkod,borc,alacak,bakiye,tarih,saat,olususer,olustarsaat,vadetar,belno,\r\n      ack,varno,kur,pro,varok,perkod,adaid,deguser,degtarsaat,sil,\r\n      karsihestip,karsiheskod,parabrm,Karsi_Karttip,Karsi_KartKod)\r\n      select m.firmano,m.cekid,@newid,@gctip,@cekhrkid,m.fisfattip,m.fisfatid,\r\n      m.islmtip,m.islmtipad,h.drm,h.drmad,h.yertip,h.yerad,\r\n      m.cartip,m.carkod,giren*m.kur,0,0,h.tarih,h.saat,\r\n      h.olususer,h.olustarsaat,m.vadetar,m.ceksenno,\r\n      h.ack,0,/*m.varno, */\r\n      m.kur,1,m.varok,m.perkod,m.adaid,\r\n      h.olususer,h.olustarsaat,m.sil,\r\n      'cekkart',m.refno,m.parabrm,\r\n      'cekkart',m.refno\r\n       from cekkart as m with (nolock)  inner join cekhrk as h with (nolock)\r\n       on h.id=m.hrkid where \r\n       m.cekid=@hrkid and h.id=@drmhrkid\r\n       \r\n       \r\n       select @newid=SCOPE_IDENTITY()\r\n       update carihrk set carhrkid=@newid where id=@newid\r\n       \r\n    end\r\n\r\n  if (@cekdrm='CKR')\r\n   begin\r\n     /*- cek alinan cari ters hareket  */\r\n      \r\n      select @newid=0\r\n      insert into carihrk (firmano,cekid,carhrkid,gctip,masterid,fisfattip,fisfatid,\r\n      islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n      cartip,carkod,borc,alacak,bakiye,tarih,saat,olususer,olustarsaat,vadetar,belno,\r\n      ack,varno,kur,pro,varok,perkod,adaid,deguser,degtarsaat,sil,\r\n      karsihestip,karsiheskod,parabrm,Karsi_Karttip,Karsi_KartKod)\r\n      select m.firmano,m.cekid,@newid,@gctip,@cekhrkid,m.fisfattip,m.fisfatid,\r\n      m.islmtip,m.islmtipad,h.drm,h.drmad,h.yertip,h.yerad,\r\n      m.cartip,m.carkod,giren*m.kur,0,0,h.tarih,h.saat,h.olususer,h.olustarsaat,m.vadetar,m.ceksenno,\r\n      h.ack,0,/*m.varno, */\r\n      m.kur,1,m.varok,m.perkod,m.adaid,h.olususer,h.olustarsaat,m.sil,\r\n      'cekkart',m.refno,m.parabrm,'cekkart',m.refno \r\n      from cekkart as m with (nolock) inner join cekhrk as h with (nolock)\r\n      on h.id=m.hrkid where m.cekid=@hrkid and h.id=@drmhrkid\r\n      \r\n       select @newid=SCOPE_IDENTITY()\r\n       update carihrk set carhrkid=@newid where id=@newid\r\n      \r\n      /* cirolanan cari ters hareket */\r\n      insert into carihrk (firmano,cekid,carhrkid,gctip,masterid,fisfattip,fisfatid,\r\n      islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n      cartip,carkod,borc,alacak,bakiye,tarih,saat,olususer,olustarsaat,vadetar,belno,\r\n      ack,varno,kur,pro,varok,perkod,adaid,deguser,degtarsaat,sil,\r\n      karsihestip,karsiheskod,parabrm,\r\n      Karsi_Karttip,Karsi_KartKod)\r\n      select m.firmano,m.cekid,@newid,@gctip,@cekhrkid,m.fisfattip,m.fisfatid,\r\n      m.islmtip,m.islmtipad,h.drm,h.drmad,h.yertip,h.yerad,\r\n      h.cartip,h.carkod,0,giren*m.kur,0,h.tarih,h.saat,h.olususer,h.olustarsaat,m.vadetar,m.ceksenno,\r\n      h.ack,0,/*m.varno, */\r\n      m.kur,1,m.varok,m.perkod,m.adaid,h.olususer,h.olustarsaat,m.sil,\r\n      'cekkart',m.refno,m.parabrm,\r\n      'cekkart',m.refno\r\n       from cekkart as m with (nolock) inner join cekhrk as h with (nolock)\r\n      on h.id=m.hrkid where m.cekid=@hrkid and h.id=@drmhrkid\r\n      \r\n      \r\n      \r\n     \r\n    end\r\n \r\n    RETURN\r\n  end\r\n\r\n\r\n\r\n /*-carikart yansıması */\r\n if (@cekdrm='POR') OR (@cekdrm='CIR') OR (@cekdrm='KSN')  OR (@cekdrm='PID')\r\n begin\r\n  if (@cartip='carikart') or (@cartip='perkart')\r\n   or (@cartip='gelgidkart') or (@cartip='vardicek')\r\n  begin\r\n /*-cari giris por */\r\n  if (@cekdrm='POR') OR (@cekdrm='CIR')\r\n  begin\r\n  \r\n  if @cekdrm='POR'\r\n  begin\r\n  /*-por işlemi */\r\n  delete from carihrk where \r\n  /*cartip not in ('gelgidkart') and  */\r\n  masterid=@cekhrkid\r\n  and (islmtip='CEK' OR islmtip='SEN') and islmhrk='ALN' \r\n  and karsihestip='cekkart'\r\n\r\n  select @newid=0\r\n  insert into carihrk (firmano,cekid,carhrkid,gctip,masterid,fisfattip,fisfatid,\r\n  islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n  cartip,carkod,borc,alacak,bakiye,tarih,saat,olususer,olustarsaat,vadetar,belno,\r\n  ack,varno,kur,dataok,pro,varok,perkod,adaid,deguser,degtarsaat,sil,\r\n  karsihestip,karsiheskod,parabrm,Karsi_Karttip,Karsi_KartKod)\r\n  select m.firmano,m.cekid,@newid,@gctip,@cekhrkid,\r\n  m.fisfattip,m.fisfatid,m.islmtip,m.islmtipad,m.islmhrk,m.islmhrkad,\r\n  h.yertip,h.yerad,\r\n  m.cartip,m.carkod,0,giren*m.kur,0,m.tarih,m.saat,h.olususer,\r\n  h.olustarsaat,m.vadetar,m.ceksenno,\r\n  h.ack,m.varno,m.kur,m.dataok,1,m.varok,m.perkod,m.adaid,\r\n  h.olususer,h.olustarsaat,m.sil,\r\n  'cekkart',m.refno,m.parabrm,\r\n  'cekkart',m.refno from cekkart as m with (nolock) inner join cekhrk as h with (nolock)\r\n  on h.id=m.hrkid where m.cekid=@hrkid and h.id=@drmhrkid\r\n  \r\n  \r\n   select @newid=SCOPE_IDENTITY()\r\n   update carihrk set carhrkid=@newid where id=@newid\r\n  \r\n  end\r\n\r\n /*---CİRO */\r\n  if @cekdrm='CIR'\r\n  begin\r\n    delete from carihrk where \r\n    /*cartip not in ('gelgidkart') and  */\r\n    masterid=@cekhrkid and carkod=@vercarkod\r\n    and (islmtip='CEK' OR islmtip='SEN') and \r\n     islmhrk='CIR' and karsihestip='cekkart'\r\n   \r\n   /* ayni cariden ve aynı cekid cirodan geri al islemini sil  */\r\n    delete from carihrk where masterid=@cekhrkid and carkod=@vercarkod\r\n    and (islmtip='CEK' OR islmtip='SEN') and \r\n     islmhrk='CGR' and karsihestip='cekkart' \r\n     \r\n     \r\n\r\n    select @newid=0\r\n    insert into carihrk (firmano,cekid,carhrkid,gctip,masterid,\r\n    fisfattip,fisfatid,islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n    cartip,carkod,borc,alacak,bakiye,tarih,saat,olususer,olustarsaat,vadetar,belno,\r\n    ack,varno,kur,dataok,pro,varok,perkod,adaid,deguser,degtarsaat,sil,\r\n    karsihestip,karsiheskod,parabrm,\r\n    Karsi_Karttip,Karsi_KartKod) \r\n    select m.firmano,m.cekid,@newid,@gctip,@cekhrkid,m.fisfattip,\r\n    m.fisfatid,m.islmtip,m.islmtipad,m.drm,m.drmad,h.yertip,h.yerad,\r\n    m.vercartip,m.vercarkod,\r\n    cikan*m.kur,0,0,h.tarih,h.saat,h.olususer,h.olustarsaat,\r\n    m.vadetar,m.ceksenno,\r\n    h.ack,0,/*m.varno, */\r\n    m.kur,m.dataok,1,m.varok,m.perkod,m.adaid,h.olususer,h.olustarsaat,m.sil,\r\n    'cekkart',m.refno,m.parabrm,\r\n    'cekkart',m.refno from cekkart as m with (nolock) inner join cekhrk as h with (nolock)\r\n    on h.id=m.hrkid where m.cekid=@hrkid and h.id=@drmhrkid\r\n    \r\n    \r\n     select @newid=SCOPE_IDENTITY()\r\n     update carihrk set carhrkid=@newid where id=@newid\r\n    \r\n    end\r\n\r\n  end;/*-PRO VE CIRO İŞLEMİ */\r\n  \r\n  if (@cekdrm='PID')/*portfoyden iade */\r\n  begin\r\n  select @newid=0\r\n  insert into carihrk (firmano,cekid,carhrkid,gctip,masterid,fisfattip,fisfatid,islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n  cartip,carkod,borc,alacak,bakiye,tarih,saat,olususer,olustarsaat,vadetar,belno,\r\n  ack,varno,kur,dataok,pro,varok,perkod,adaid,deguser,degtarsaat,sil,\r\n  karsihestip,karsiheskod,parabrm,\r\n  Karsi_Karttip,Karsi_KartKod) \r\n  select m.firmano,m.cekid,@newid,'B',@cekhrkid,m.fisfattip,\r\n  m.fisfatid,m.islmtip,m.islmtipad,m.drm,m.drmad,h.yertip,h.yerad,\r\n  m.cartip,m.carkod,\r\n  cikan*m.kur,0,0,h.tarih,h.saat,h.olususer,h.olustarsaat,m.vadetar,m.ceksenno,\r\n  h.ack,0,/*m.varno, */\r\n  m.kur,m.dataok,1,m.varok,m.perkod,m.adaid,h.olususer,h.olustarsaat,m.sil,\r\n  'cekkart',m.refno,m.parabrm,\r\n  'cekkart',m.refno from cekkart as m with (nolock) inner join cekhrk as h with (nolock)\r\n  on h.id=m.hrkid where m.cekid=@hrkid and h.id=@drmhrkid\r\n  \r\n  \r\n    select @newid=SCOPE_IDENTITY()\r\n    update carihrk set carhrkid=@newid where id=@newid\r\n  \r\n  end\r\n  \r\n  \r\n  \r\n\r\n /*-ksn */\r\n  if (@cekdrm='KSN')\r\n  begin\r\n  delete from carihrk where masterid=@cekhrkid\r\n  and (islmtip='CEK' OR islmtip='SEN') and islmhrk='KSN' \r\n  and karsihestip='cekkart'\r\n  \r\n  select @newid=0\r\n  insert into carihrk (firmano,cekid,carhrkid,gctip,masterid,fisfattip,fisfatid,islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n  cartip,carkod,borc,alacak,bakiye,tarih,saat,olususer,olustarsaat,vadetar,belno,\r\n  ack,varno,kur,dataok,pro,varok,perkod,adaid,deguser,degtarsaat,sil,\r\n  karsihestip,karsiheskod,parabrm,\r\n  Karsi_Karttip,Karsi_KartKod) \r\n  select m.firmano,m.cekid,@newid,@gctip,@cekhrkid,m.fisfattip,m.fisfatid,m.islmtip,m.islmtipad,m.islmhrk,m.islmhrkad,h.yertip,h.yerad,\r\n  m.vercartip,m.vercarkod,\r\n  cikan*m.kur,0,0,h.tarih,m.saat,m.olususer,h.olustarsaat,m.vadetar,m.ceksenno,\r\n  h.ack,0,/*m.varno, */\r\n  m.kur,m.dataok,1,m.varok,m.perkod,m.adaid,h.olususer,h.olustarsaat,m.sil,\r\n  'cekkart',m.refno,m.parabrm,\r\n  'cekkart',m.refno from cekkart as m  with (nolock) inner join cekhrk as h with (nolock)\r\n  on h.id=m.hrkid where m.cekid=@hrkid and h.id=@drmhrkid\r\n  \r\n   select @newid=SCOPE_IDENTITY()\r\n   update carihrk set carhrkid=@newid where id=@newid\r\n  \r\n end\r\n END\r\nend\r\n \r\n/*-carikart yansıması */\r\n\r\n/*banka gelir gider kasa yansıması silimi */\r\ndelete from bankahrk where masterid=@cekhrkid and karsihestip='cekkart'\r\ndelete from kasahrk where masterid=@cekhrkid  and karsihestip='cekkart'\r\n/*banka gelir gider kasa yansıması silimi */\r\n\r\n/*banka gelir gider kasa yansıması */\r\nif (@cekdrm='TKT') OR (@cekdrm='ELT') OR (@cekdrm='ODE')\r\nbegin\r\n\r\nif (@tahcartip='bankakart') \r\nbegin\r\nif (@cekdrm='TKT') /*banka takastan tahsil işlemi */\r\nset @cikan=0\r\n\r\nif (@cekdrm='ODE') /*banka çek ödeme işlemi */\r\nset @giren=0\r\n  select @newid=0\r\n  insert into bankahrk (firmano,cekid,bankod,bankhrkid,gctip,masterid,fisfattip,fisfatid,islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n  cartip,carkod,borc,alacak,vadetar,tarih,saat,olususer,olustarsaat,belno,\r\n  ack,varno,kur,dataok,pro,varok,perkod,adaid,deguser,degtarsaat,sil,\r\n  karsihestip,karsiheskod,parabrm,\r\n  Karsi_Karttip,Karsi_KartKod)\r\n  select m.firmano,m.cekid,h.carkod,@newid,@gctip,@cekhrkid,m.fisfattip,m.fisfatid,m.islmtip,m.islmtipad,m.drm,m.drmad,\r\n  h.yertip,h.yerad,'','',@giren,@cikan,m.vadetar,h.tarih,h.saat,h.olususer,h.olustarsaat,m.ceksenno,\r\n  h.ack,0,/*m.varno, */\r\n  m.kur,m.dataok,1,m.varok,m.perkod,m.adaid,h.olususer,h.olustarsaat,m.sil,\r\n  'cekkart',m.refno,m.parabrm,\r\n  'cekkart',m.refno from cekkart as m with (nolock) inner join cekhrk as h with (nolock)\r\n  on h.id=m.hrkid where m.cekid=@hrkid and h.id=@drmhrkid\r\n  \r\n   select @newid=SCOPE_IDENTITY()\r\n   update bankahrk set bankhrkid=@newid where id=@newid\r\n  \r\n  \r\n\r\nif @gidtutar>0\r\nbegin\r\n\r\nset @gidtipkod='GLG'\r\nset @gidtiphrkkod='MRF'\r\nSELECT @gidtipad=ad from islemturtip where tip=@gidtipkod;\r\nSELECT @gidtiphekad=ad from islemhrktip where tip=@gidtipkod and hrk=@gidtiphrkkod;\r\n\r\n/*--BANKA MASRAF GİRİŞİ */\r\n  select @newid=0\r\n  insert into bankahrk (firmano,cekid,bankod,bankhrkid,gctip,masterid,fisfattip,fisfatid,islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n  cartip,carkod,borc,alacak,vadetar,tarih,saat,olususer,olustarsaat,belno,\r\n  ack,varno,kur,dataok,pro,varok,perkod,adaid,deguser,degtarsaat,sil,\r\n  karsihestip,karsiheskod,parabrm,\r\n  Karsi_Karttip,Karsi_KartKod)\r\n  select m.firmano,m.cekid,h.tahcarkod,@newid,@gctip,@cekhrkid,m.fisfattip,m.fisfatid,@gidtipkod,@gidtipad,@gidtiphrkkod,@gidtiphekad,h.yertip,h.yerad,\r\n  'gelgidkart',@gidkod,0,@gidtutar,m.vadetar,h.tarih,h.saat,h.olususer,h.olustarsaat,m.ceksenno,\r\n  h.ack,0,/*m.varno, */\r\n  m.kur,m.dataok,1,m.varok,m.perkod,m.adaid,h.olususer,h.olustarsaat,m.sil,\r\n  'cekkart',m.refno,m.parabrm,\r\n  'gelgidkart',@gidkod from cekkart as m  with (nolock) inner join cekhrk as h with (nolock)\r\n  on h.id=m.hrkid where m.cekid=@hrkid and h.id=@drmhrkid\r\n  \r\n  select @newid=SCOPE_IDENTITY()\r\n  update bankahrk set bankhrkid=@newid where id=@newid\r\n\r\nend\r\nEND\r\n \r\n\r\nif (@tahcartip='kasakart')\r\nbegin\r\n\r\nif (@cekdrm='ELT') /*KASA ELDEN tahsil işlemi */\r\nset @cikan=0\r\n\r\n  select @newid=0\r\n  insert into kasahrk (firmano,cekid,kaskod,kashrkid,gctip,masterid,fisfattip,fisfatid,islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n  cartip,carkod,giren,cikan,tarih,saat,olususer,olustarsaat,belno,\r\n  ack,varno,kur,dataok,pro,varok,perkod,adaid,deguser,degtarsaat,sil,\r\n  karsihestip,karsiheskod,parabrm,\r\n  Karsi_Karttip,Karsi_KartKod)\r\n  select m.firmano,m.cekid,h.tahcarkod,@newid,@gctip,@cekhrkid,m.fisfattip,m.fisfatid,m.islmtip,m.islmtipad,m.drm,m.drmad,\r\n  h.yertip,h.yerad,'','',\r\n  @giren,@cikan,h.tarih,h.saat,h.olususer,h.olustarsaat,m.ceksenno,\r\n  h.ack,0,/*m.varno, */\r\n  m.kur,m.dataok,1,m.varok,m.perkod,m.adaid,h.olususer,h.olustarsaat,m.sil,\r\n  'cekkart',m.refno,m.parabrm,\r\n  'cekkart',m.refno from cekkart as m with (nolock) inner join cekhrk as h with (nolock)\r\n  on h.id=m.hrkid where m.cekid=@hrkid and h.id=@drmhrkid\r\n  \r\n  select @newid=SCOPE_IDENTITY()\r\n  update kasahrk set kashrkid=@newid where id=@newid\r\n  \r\n  \r\n  \r\ndelete from carihrk where masterid=@cekhrkid and islmtip='GLG' and islmhrk='MRF'\r\n   and karsihestip='cekkart'\r\nif @gidtutar>0\r\nbegin\r\n\r\nset @gidtipkod='GLG'\r\nset @gidtiphrkkod='MRF'\r\nSELECT @gidtipad=ad from islemturtip where tip=@gidtipkod;\r\nSELECT @gidtiphekad=ad from islemhrktip where tip=@gidtipkod and hrk=@gidtiphrkkod\r\n\r\n/*--KASA MASRAF GİRİŞİ */\r\n  select @newid=0\r\n  insert into kasahrk (firmano,cekid,kaskod,kashrkid,gctip,masterid,fisfattip,fisfatid,islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n  cartip,carkod,giren,cikan,tarih,saat,olususer,olustarsaat,belno,\r\n  ack,varno,kur,dataok,pro,varok,perkod,adaid,deguser,degtarsaat,sil,\r\n  karsihestip,karsiheskod,parabrm,\r\n  Karsi_Karttip,Karsi_KartKod)\r\n  select m.firmano,m.cekid,h.tahcarkod,@newid,'C',@cekhrkid,m.fisfattip,m.fisfatid,@gidtipkod,@gidtipad,@gidtiphrkkod,@gidtiphekad,\r\n  h.yertip,h.yerad,'gelgidkart',@gidkod,0,@gidtutar,h.tarih,h.saat,h.olususer,h.olustarsaat,m.ceksenno,\r\n  h.ack,0,/*m.varno, */\r\n  m.kur,m.dataok,1,m.varok,m.perkod,m.adaid,h.olususer,h.olustarsaat,m.sil,\r\n  'cekkart',m.refno,m.parabrm,\r\n  'cekkart',m.refno from cekkart as m with (nolock)  inner join cekhrk as h with (nolock)\r\n  on h.id=m.hrkid where m.cekid=@hrkid and h.id=@drmhrkid\r\n  \r\n  select @newid=SCOPE_IDENTITY()\r\n  update kasahrk set kashrkid=@newid where id=@newid\r\n\r\n end\r\n\r\n END\r\nend\r\n\r\n\r\n\r\n  \r\nEND"
  },
  {
    "schema": "dbo",
    "name": "cektipolustur",
    "definition": "CREATE PROCEDURE [dbo].cektipolustur\r\nAS\r\nBEGIN\r\n\r\nTRUNCATE TABLE cektip\r\n\r\ninsert into cektip (kod,ad) values ('CIR','CİRO');\r\ninsert into cektip (kod,ad) values ('POR','PORTFÖYDE');\r\ninsert into cektip (kod,ad) values ('TAK','TAKASTA');\r\ninsert into cektip (kod,ad) values ('TGR','TAKASTAN GERİ AL');\r\ninsert into cektip (kod,ad) values ('CGR','CİRODAN GERİ AL');\r\ninsert into cektip (kod,ad) values ('PID','PORTFÖYDEN İADE');\r\ninsert into cektip (kod,ad) values ('PKR','PORTFÖYDEN KARŞILIKSIZ');\r\ninsert into cektip (kod,ad) values ('TKR','TAKASTAN KARŞILIKSIZ');\r\ninsert into cektip (kod,ad) values ('CKR','CİRODAN KARŞILIKSIZ');\r\ninsert into cektip (kod,ad) values ('KGR','KARŞILIKSIZDAN GERİ AL');\r\ninsert into cektip (kod,ad) values ('ELT','ELDEN TAHSİL');\r\ninsert into cektip (kod,ad) values ('TKT','TAKASTAN TAHSİL');\r\ninsert into cektip (kod,ad) values ('KSN','KESİLEN');\r\ninsert into cektip (kod,ad) values ('ODE','KESİLEN ÇEK ÖDEME');\r\ninsert into cektip (kod,ad) values ('OTI','ÖDEME / TAHSİL İPTAL');\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "eventhrkolustur",
    "definition": "CREATE PROCEDURE [dbo].eventhrkolustur\r\nAS\r\nBEGIN\r\n\r\nTRUNCATE TABLE eventhrk\r\n/*-KART TANIMLARI */\r\n/*ACIKLAMA ... NOLU KART EKLENDI,DUZELTİLDI,SİLİNDİ */\r\ninsert into eventhrk (id,ad) values (1,'CARİ KART')/* -1,0,1 EKLENDİ SİLİNDİ DÜZELTİLDİ */\r\ninsert into eventhrk (id,ad) values (2,'BANKA KART')\r\ninsert into eventhrk (id,ad) values (3,'PERSONEL KART')\r\ninsert into eventhrk (id,ad) values (4,'POS KART')\r\ninsert into eventhrk (id,ad) values (5,'İŞLETME KREDİ KART')\r\ninsert into eventhrk (id,ad) values (6,'KASA KART')\r\ninsert into eventhrk (id,ad) values (7,'GELİR GİDER KART')\r\ninsert into eventhrk (id,ad) values (8,'PERAKENDE KART')\r\ninsert into eventhrk (id,ad) values (9,'SAYAÇ KART')\r\ninsert into eventhrk (id,ad) values (10,'AKARYAKIT STOK KART')\r\ninsert into eventhrk (id,ad) values (11,'MARKET STOK KART')\r\n\r\n/*VARRDIYA--50 */\r\ninsert into eventhrk (id,ad) values  (51,'POMPACI VARDIYA')/*1 ekleme, 2 geri alma, 3 kapatma,-1 silme */\r\n/* POMPACI VARDİYA OLASILIKLAR\r\n.. NOLU VARDIYA OLUSTURULDU\r\n..NOLU YARATILDI SİLME\r\n..NOLU YARATILDI GERI ALMA\r\n...\r\n\r\n*/\r\ninsert into eventhrk (id,ad) values  (52,'MARKET VARDIYA')\r\n\r\n/* FATURA HRK-- 70 */\r\ninsert into eventhrk (id,ad) values  (71,'ALIŞ FATURASI')\r\ninsert into eventhrk (id,ad) values  (72,'SATIŞ FATURASI')\r\n\r\ninsert into eventhrk (id,ad) values  (73,'ALIŞ İRSALİYESİ')\r\ninsert into eventhrk (id,ad) values  (74,'SATIŞ İRSALİYESİ')\r\n\r\ninsert into eventhrk (id,ad) values  (75,'ALINAN SİPARİŞ')\r\ninsert into eventhrk (id,ad) values  (76,'VERİLEN SİPARİŞ')\r\n\r\ninsert into eventhrk (id,ad) values  (77,'VERESİYE FİŞ')\r\n/*\r\nVERESIYE FISI DEGİŞTİRİLDİ ACKLAMADA ORNEK (DEGİŞTİRLMEDEN ONCEKİ CARI KODU,UNVANI )\r\n\r\nVERESIYE FISI DEGİŞTİRİLDİ SİLİNDİ\r\n\r\n*/\r\n\r\ninsert into eventhrk (id,ad) values  (78,'ALACAK FİŞİ')\r\n\r\n\r\n\r\n/*-ODEME HRKLERRRR -- 100 */\r\ninsert into eventhrk (id,ad) values  (101,'KASA TAHSİLAT')\r\ninsert into eventhrk (id,ad) values  (102,'KASA ÖDEME')\r\ninsert into eventhrk (id,ad) values  (103,'POS BORÇ')\r\ninsert into eventhrk (id,ad) values  (104,'POS ALACAK')\r\ninsert into eventhrk (id,ad) values  (104,'BANKA BORÇ')\r\ninsert into eventhrk (id,ad) values  (105,'BANKA ALACAK')\r\ninsert into eventhrk (id,ad) values  (106,'CARİ BORÇ')\r\ninsert into eventhrk (id,ad) values  (107,'CARİ ALACAK')\r\ninsert into eventhrk (id,ad) values  (106,'GELİR-GİDER BORÇ')\r\ninsert into eventhrk (id,ad) values  (107,'GELİR-GİDER ALACAK')\r\ninsert into eventhrk (id,ad) values  (108,'PERAKENDE BORÇ')\r\ninsert into eventhrk (id,ad) values  (109,'PERAKENDE ALACAK')\r\n\r\n/*-CEK HRKLERİ --200 */\r\ninsert into eventhrk (id,ad) values  (201,'VERİLEN ÇEK');\r\ninsert into eventhrk (id,ad) values  (202,'ALINAN ÇEK');\r\ninsert into eventhrk (id,ad) values  (203,'CİROLANAN ÇEK');\r\n\r\n/*-STOK HRK --300 */\r\ninsert into eventhrk (id,ad) values  (301,'HARİCİ İŞLEM')\r\ninsert into eventhrk (id,ad) values  (302,'STOK SATIŞ')\r\ninsert into eventhrk (id,ad) values  (303,'STOK ALIŞ')\r\n\r\ninsert into eventhrk (id,ad) values  (304,'STOK GİRİŞ')\r\ninsert into eventhrk (id,ad) values  (305,'STOK ÇIKIŞ')\r\n\r\ninsert into eventhrk (id,ad) values  (306,'KART AÇILIŞ')\r\n\r\n\r\n\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "eventkartlogyaz",
    "definition": "CREATE PROCEDURE [dbo].eventkartlogyaz (@tablename varchar(30),\r\n@recid int,@user_id int,@islemint int,@eventrkid int)\r\nAS\r\nBEGIN\r\ndeclare @tarih datetime\r\ndeclare @user_ip varchar(20)\r\ndeclare @user_pcad varchar(50)\r\ndeclare @sonack varchar(8000);\r\ndeclare @oncekiack varchar(8000);\r\n\r\nset @sonack='';\r\nset @oncekiack='';\r\n\r\ndeclare @sil int;\r\ndeclare @varok int;\r\n\r\nset @tarih=convert(varchar,GETDATE(),120)\r\n\r\n\r\nselect @user_pcad=isnull(ip,''),@user_ip=isnull(pc,'') from users where id=@user_id\r\n\r\n if @tablename='pomvardimas'\r\n begin\r\n  select @sonack=\r\n  '|VARDIYA ADI='+CAST(varad AS VARCHAR)+\r\n  '|TARIH='+convert(varchar,tarih,104)+\r\n  '|AKAR.SAT.MIK='+CAST(aksatmik AS VARCHAR)+\r\n  '|AKAR.SAT.TUT='+CAST(aksattop AS VARCHAR)+\r\n  '|POS.SAT.TUT='+CAST(postop AS VARCHAR)+\r\n  '|VER.SAT.TUT='+CAST(veresitop AS VARCHAR)+\r\n  '|NAKİT.TES.TUT='+CAST(naktestop AS VARCHAR)+\r\n  '|MAL.SAT.TUT='+CAST(malsattop AS VARCHAR)+\r\n  '|ODEME.TUT='+CAST(odetop AS VARCHAR)+\r\n  '|TAHSİLAT.TUT='+CAST(tahtop AS VARCHAR)+\r\n  '|GELİR TUT='+CAST(gelirtop AS VARCHAR)+\r\n  '|GİDER TUT='+CAST(gidertop AS VARCHAR)+\r\n  '|OTOMASYON.TUT='+CAST(otomastop AS VARCHAR)+\r\n  '|ACIK-FAZLA='+CAST(varackfaztip AS VARCHAR)\r\n   from pomvardimas where varno=@recid;\r\n  insert into eventhrklog (recid,tarih,userid,islemint,ip,pcadi,eventrkid,sonack,oncekiack)\r\n  values (@recid,@tarih,@user_id,@islemint,@user_ip,@user_pcad,@eventrkid,@sonack,@oncekiack)\r\nend;\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "Fat_Dep_Transfer",
    "definition": "CREATE PROCEDURE [dbo].Fat_Dep_Transfer (\r\n@Fatid int,\r\n@Sil   int)\r\nAS\r\nBEGIN\r\n\r\n  DECLARE @islmtip varchar(50)\r\n  DECLARE @islmtipad varchar(50)\r\n  \r\n  \r\n  if @Sil=1\r\n   begin\r\n    delete from stkhrk where tabload='fat_dep' and FatDep_id=@Fatid\r\n    RETURN\r\n   end \r\n  \r\n  \r\n  set @islmtip='FATSTKTRS'\r\n  \r\n  select  @islmtipad=ad from stkhrktip WITH (NOLOCK) where kod=@islmtip\r\n \r\n\r\n  delete from stkhrk where tabload='fat_dep' and FatDep_id=@Fatid\r\n\r\n   \r\n  /*cikis deposu */\r\n  insert Stkhrk (Firmano,stkhrkid,tabload,stkod,belno,ack,tarih,saat,\r\n  stktip,olustarsaat,olususer,islmtip,islmtipad,\r\n  yertip,yerad,giren,cikan,depkod,brmfiykdvli,kdvyuz,FatDep_id)\r\n  \r\n  select d.cfirmano,d.id,'fat_dep',\r\n  d.CStk_kod,d.belno,d.ack,d.tarih,d.saat,\r\n  d.CStktip,d.olustarsaat,d.olususer,@islmtip,@islmtipad,\r\n  d.yertip,d.yerad,0,(miktar),d.Cdepkod,\r\n  ((f.brmfiy+f.otvbrim)-(f.satisktut+f.genisktut)) / \r\n  ( case when f.carpan=0 then 1 else f.carpan end )*(1+f.kdvyuz),\r\n  f.kdvyuz,@Fatid\r\n  \r\n  from Fat_Dep as d WITH (NOLOCK) inner join \r\n  faturahrk as f WITH (NOLOCK) on f.fatid=d.fatid \r\n  and f.sil=0 and d.sil=0 and f.fatid=@Fatid\r\n  and d.Miktar>0 and f.id=d.fathrk_id\r\n\r\n\r\n  /*giris deposu */\r\n\r\n  insert stkhrk (Firmano,stkhrkid,tabload,stkod,belno,ack,tarih,saat,\r\n  stktip,olustarsaat,olususer,islmtip,islmtipad,\r\n  yertip,yerad,giren,cikan,depkod,brmfiykdvli,kdvyuz,FatDep_id)\r\n  \r\n  select d.gfirmano,d.id,'fat_dep',\r\n  d.gStk_kod,d.belno,d.ack,d.tarih,d.saat,\r\n  d.gStktip,d.olustarsaat,d.olususer,@islmtip,@islmtipad,\r\n  d.yertip,d.yerad,(miktar),0,d.gdepkod,\r\n  ((f.brmfiy+f.otvbrim)-(f.satisktut+f.genisktut)) / \r\n  ( case when f.carpan=0 then 1 else f.carpan end )*(1+f.kdvyuz),\r\n  f.kdvyuz,@Fatid\r\n  \r\n  from Fat_Dep as d WITH (NOLOCK) inner join \r\n  faturahrk as f WITH (NOLOCK) on f.fatid=d.fatid \r\n  and f.sil=0 and d.sil=0 and f.fatid=@Fatid\r\n  and d.Miktar>0 and f.id=d.fathrk_id\r\n \r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "fattipolustur",
    "definition": "CREATE PROCEDURE [dbo].fattipolustur\r\nAS\r\nBEGIN\r\n\r\nTRUNCATE table fattip\r\n\r\n\r\n/*------FATURA */\r\ninsert into fattip (kod,ad,gc,tip) values('FATAKALS','AKARYAKIT ALIŞ FATURASI','G','FAT');\r\ninsert into fattip (kod,ad,gc,tip) values('FATMRALS','MARKET ALIŞ FATURASI','G','FAT');\r\ninsert into fattip (kod,ad,gc,tip) values('FATGGALS','GELİR GİDER ALIŞ FATURASI','G','FAT');\r\ninsert into fattip (kod,ad,gc,tip) values('FATYGALS','YAĞ ALIŞ FATURASI','G','FAT');\r\n\r\ninsert into fattip (kod,ad,gc,tip) values('FATVERSAT','VERESİYE SATIŞ FATURASI','C','FAT');\r\ninsert into fattip (kod,ad,gc,tip) values('FATGGSAT','GELİR GİDER SATIŞ FATURASI','C','FAT');\r\ninsert into fattip (kod,ad,gc,tip) values('FATTOPSAT','TOPTAN SATIŞ FATURASI','C','FAT');\r\ninsert into fattip (kod,ad,gc,tip) values('FATPERSAT','PERAKENDE SATIŞ FATURASI','C','FAT');\r\ninsert into fattip (kod,ad,gc,tip) values('FATZRAPSAT','Z RAPORU SATIŞ ','C','FAT');\r\n\r\ninsert into fattip (kod,ad,gc,tip) values('FATIADALS','ALIŞTAN İADE FATURASI','C','FAT');\r\ninsert into fattip (kod,ad,gc,tip) values('FATIADSAT','SATIŞTAN İADE FATURASI','G','FAT');\r\n\r\n\r\n/*--IRSALIYE */\r\ninsert into fattip (kod,ad,gc,tip) values('IRSAKALS','AKARYAKIT ALIŞ İRSALİYESİ','G','IRS');\r\ninsert into fattip (kod,ad,gc,tip) values('IRSMRALS','MARKET ALIŞ İRSALİYESİ','G','IRS');\r\ninsert into fattip (kod,ad,gc,tip) values('IRSYGALS','YAĞ ALIŞ İRSALİYESİ','G','IRS');\r\n\r\ninsert into fattip (kod,ad,gc,tip) values('IRSAKSAT','AKARYAKIT SATIŞ İRSALİYESİ','C','IRS');\r\ninsert into fattip (kod,ad,gc,tip) values('IRSMRSAT','MARKET SATIŞ İRSALİYESİ','C','IRS');\r\ninsert into fattip (kod,ad,gc,tip) values('IRSYGSAT','YAĞ SATIŞ İRSALİYESİ','C','IRS');\r\n\r\n/*--SİPARİŞ */\r\ninsert into fattip (kod,ad,gc,tip) values('SIPALS','ALINAN SİPARİŞ','G','SIP');\r\ninsert into fattip (kod,ad,gc,tip) values('SIPSAT','VERILEN SİPARİŞ','C','SIP');\r\n\r\n/*VERESIYE */\r\ninsert into fattip (kod,ad,gc,tip) values('FISVERSAT','VERESİYE SATIŞ FİŞİ','C','FIS');\r\ninsert into fattip (kod,ad,gc,tip) values('FISALCSAT','ALACAK SATIŞ FİŞİ','C','FIS');\r\n\r\n\r\n/*ZRAPOR */\r\ninsert into fattip (kod,ad,gc,tip) values('FATZRPSAT','Z RAPORU SATIŞ ','C','ZRP');\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "Fatura_Cari_Stok_Iskonto",
    "definition": "CREATE PROCEDURE [dbo].[Fatura_Cari_Stok_Iskonto]\r\n@fatid           float\r\nAS\r\nBEGIN\r\n\r\n    declare  @isk_yuzde   float\r\n    declare  @isk_tutar   float\r\n    declare  @ara_toplam  float\r\n    \r\n    declare @carkod       varchar(50)\r\n    declare @cartip_id    int\r\n    \r\n    \r\n    declare  @fisisk  \t\t \tfloat\r\n    declare  @TtsDagisk   \t\tfloat\r\n    declare  @TtsBayisk  \t\tfloat\r\n    \r\n   \r\n    \r\n\r\n    select @carkod=carkod,@cartip_id=cartip_id,\r\n    @ara_toplam=fattop from faturamas with (nolock)  where fatid=@fatid\r\n    \r\n    \r\n     select @fisisk=isnull(fisisk,0),@TtsDagisk=isnull(TtsDagisk,0),\r\n    @TtsBayisk=isnull(TtsBayisk,0) from CariKart with (nolock) \r\n    Where Kod=@carkod \r\n    \r\n  \r\n\r\n     update faturahrk Set satiskyuz=dt.Iskonto_Oran\r\n      From faturahrk as t with (nolock)  join \r\n      (Select * From Cari_Fat_Urun_Iskonto Where car_kod=@carkod and sil=0) dt\r\n      on dt.car_kod=@carkod and cartip_id=@cartip_id \r\n      and t.stkod=dt.stk_kod and t.stktip=dt.stktip\r\n    where fatid=@fatid\r\n    \r\n    if @fisisk>0  \r\n      update faturahrk set satiskyuz=@fisisk where fatid=@fatid and OtoTag=0\r\n \r\n    if @TtsDagisk>0  \r\n      update faturahrk set satiskyuz=@TtsDagisk where fatid=@fatid and OtoTag=1\r\n\r\n   if @TtsBayisk>0  \r\n      update faturahrk set satiskyuz=@TtsBayisk where fatid=@fatid and OtoTag=2\r\n   \r\n    \r\n\r\n\r\n  \r\nEND"
  },
  {
    "schema": "dbo",
    "name": "Fatura_Genel_indirim",
    "definition": "CREATE PROCEDURE [dbo].Fatura_Genel_indirim\r\n@fatid           float,\r\n@tip             tinyint,\r\n@deger           float\r\nAS\r\nBEGIN\r\n\r\ndeclare  @isk_yuzde   float\r\ndeclare  @isk_tutar   float\r\ndeclare  @ara_toplam  float\r\n\r\n    select @ara_toplam=fattop from faturamas  with (nolock) where fatid=@fatid\r\n  \r\n\r\n  if @tip=0 /*YUZDE BAZINDA */\r\n   begin\r\n    if @ara_toplam>0\r\n     update faturamas set gen_ind_tip=@tip,\r\n     geniskyuz=@deger\r\n     ,genisktop=@ara_toplam*(@deger/100)\r\n      where fatid=@fatid\r\n    end\r\n\r\n\r\n  if @tip=1 /*TUTAR BAZINDA */\r\n   begin\r\n    if @ara_toplam>0\r\n     update faturamas set gen_ind_tip=@tip,\r\n     geniskyuz=(@deger*100)/@ara_toplam\r\n     ,genisktop=@deger  where fatid=@fatid\r\n    end\r\n  \r\n\r\n\r\n  \r\nEND"
  },
  {
    "schema": "dbo",
    "name": "Fatura_TahOde",
    "definition": "CREATE PROCEDURE dbo.Fatura_TahOde\r\n@id           int,\r\n@grp_tip \t  varchar(30),\r\n@Durum\t\t  bit\t\t  \t\r\nAS\r\nBEGIN\r\n\r\n      \r\n     \r\n    if @grp_tip='kasahrk'\r\n    begin\r\n     delete from kasahrk where tahodeid=@id\r\n    \r\n    if @Durum=1\r\n     begin\r\n    /*select @newid=isnull(max(kashrkid),0)+1 from kasahrk */\r\n    insert into kasahrk (firmano,kaskod,kashrkid,gctip,varno,\r\n    masterid,fisfattip,fisfatid,islmtip,islmtipad,islmhrk,islmhrkad,yertip,\r\n    yerad,perkod,adaid,giren,cikan,bakiye,carkod,cartip,vadetar,tarih,saat,belno,ack,\r\n    kur,varok,sil,olususer,\r\n    olustarsaat,deguser,degtarsaat,parabrm,karsihestip,karsiheskod,tahodeid,\r\n    fatid,fisid)\r\n    \r\n    select firmano,karsi_carkod,0,'G',varno,0,\r\n    case \r\n    when fatid>0 then 'FAT'\r\n    when fisid>0 then 'FIS' end,\r\n    case\r\n    when fatid>0 then fatid\r\n    when fisid>0 then fisid end,\r\n   \r\n    islmtip,islmtipad,islmhrk,islmhrkad,yertip,\r\n    yerad,perkod,adaid,giren,cikan,0,carkod,cartip,\r\n    vadetar,\r\n    case when Vadeli=0 then tarih else vadetar end,\r\n    saat,belno,ack+' / '+belno,kur,varok,sil,olususer,\r\n    olustarsaat,deguser,degtarsaat,parabrm,'','',id,\r\n    fatid,fisid from TahsilatOdeme  with (nolock)   \r\n    Where id=@id and sil=0\r\n    \r\n    \r\n    update kasahrk set kashrkid=h.id from \r\n    TahsilatOdeme as ins inner join kasahrk as h on \r\n    ins.id=@id and ins.id=h.tahodeid and  ins.sil=0\r\n    \r\n    end\r\n   \r\n    \r\n  end\r\n  \r\n  \r\n  \r\n   if @grp_tip='poshrk'\r\n   begin\r\n   \r\n    delete from poshrk where tahodeid=@id\r\n    \r\n    if @Durum=1\r\n     begin\r\n    insert into poshrk (firmano,poskod,bankod,poshrkid,gctip,varno,\r\n    masterid,fisfattip,fisfatid,\r\n    islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n    perkod,adaid,giren,cikan,extrakomyuz,bankomyuz,ekkomyuz,\r\n    carslip,carkod,cartip,vadetar,tarih,saat,belno,ack,kur,varok,sil,\r\n    krekartno,olususer,olustarsaat,deguser,degtarsaat,\r\n    parabrm,tahodeid,fatid,fisid)\r\n    \r\n    select firmano,karsi_carkod,bankkod,0,'G',varno,0,\r\n    case \r\n    when fatid>0 then 'FAT'\r\n    when fisid>0 then 'FIS' end,\r\n    case\r\n    when fatid>0 then fatid\r\n    when fisid>0 then fisid end,\r\n    \r\n    islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n    perkod,adaid,giren,cikan,extrakomyuz,bankomyuz,ekkomyuz,\r\n    1,carkod,cartip,vadetar,\r\n    case when Vadeli=0 then tarih else vadetar end,\r\n    saat,belno,ack+' / '+belno,kur,varok,sil,\r\n    krekartno,olususer,olustarsaat,deguser,degtarsaat,parabrm,id,\r\n    fatid,fisid\r\n    from TahsilatOdeme with (nolock) Where id=@id  and sil=0\r\n    \r\n    \r\n    update poshrk set poshrkid=h.id from TahsilatOdeme as ins  with (nolock) \r\n    inner join poshrk as h on ins.id=h.tahodeid and ins.id=@id\r\n    and  ins.sil=0\r\n    \r\n    end\r\n    \r\n    \r\n    \r\n  end\r\n \r\n \r\n if @grp_tip='cekhrk'\r\n   begin\r\n   \r\n   delete from cekkart where tahodeid=@id\r\n  \r\n  if @Durum=1\r\n     begin\r\n   insert into cekkart (cekid,firmano,islmtip,islmtipad,\r\n   ceksenno,CekSeriNo_id,sil,varno,varok,refno,cartip,carkod,\r\n   vercartip,vercarkod,gctip,yertip,yerad,drm,drmad,\r\n   islmhrk,islmhrkad,giren,cikan,\r\n   tarih,saat,banka,banksub,hesepno,kesideci,\r\n   parabrm,ack,vadetar,olususer,olustarsaat,\r\n   deguser,degtarsaat,dataok,masterid,perkod,adaid,kur,\r\n   fisfattip,fisfatid,belno,gidkod,gidtutar,bankod,\r\n   fisid,fatid,tahodeid,cartip_id,car_id,\r\n   vercartip_id,vercar_id)\r\n   \r\n   select 0,firmano,islmtip,islmtipad,ceksenno,CekSeriNo_id,0,\r\n   varno,varok,refno,\r\n   case when islmhrk='ALN' THEN cartip else '' end,\r\n   case when islmhrk='ALN' THEN carkod else '' end,\r\n   case when islmhrk='KSN' THEN cartip else '' end,\r\n   case when islmhrk='KSN' THEN carkod else '' end,\r\n   case when islmhrk='ALN' THEN 'G' else 'C' end, \r\n   yertip,yerad,drm,drmad,islmhrk,islmhrkad,\r\n   giren,cikan,\r\n   case when Vadeli=0 then tarih else vadetar end,\r\n   saat,bankad,banksub,hesapno,\r\n   kesideci,parabrm,ack+' / '+belno,vadetar,\r\n   olususer,olustarsaat,\r\n   deguser,degtarsaat,0,0,\r\n   perkod,adaid,kur,\r\n    case \r\n    when fatid>0 then 'FAT'\r\n    when fisid>0 then 'FIS' end,\r\n    case\r\n    when fatid>0 then fatid\r\n    when fisid>0 then fisid end,\r\n    belno,gidkod,gidtutar,bankkod,\r\n    fatid,fisid,id,\r\n    case when islmhrk='ALN' then cartip_id else 0 end,\r\n    case when islmhrk='ALN' then car_id else 0 end,  case when islmhrk='KSN' then cartip_id else 0 end,\r\n    case when islmhrk='KSN' then car_id else 0 end\r\n    from TahsilatOdeme with (nolock) Where id=@id \r\n    and  sil=0 \r\n    \r\n    update cekkart set cekid=h.id from  TahsilatOdeme as ins with (nolock) \r\n    inner join cekkart as h  with (nolock) on \r\n    ins.id=h.tahodeid and ins.id=@id and  ins.sil=0\r\n    end\r\n    \r\n    \r\n    \r\n    \r\n  end\r\n  \r\n  \r\n  \r\n  \r\n  \r\n  if @grp_tip='bankhrk'\r\n   begin\r\n  \r\n   delete from bankahrk where tahodeid=@id\r\n  \r\n   if @Durum=1\r\n    begin\r\n    insert bankahrk \r\n    (firmano,gctip,islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n    cartip,carkod,masterid,fisfattip,fisfatid,\r\n    varno,varok,bankhrkid,perkod,adaid,vadetar,tarih,saat,\r\n    bank_id,bankod,kaskod,\r\n    belno,ack,borc,alacak,kur,parabrm,olususer,\r\n    olustarsaat,gidkod,gidtutar,tahodeid,\r\n    fatid,fisid) \r\n    \r\n    select firmano,'-',islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n    cartip,carkod,0,\r\n     case \r\n      when fatid>0 then 'FAT'\r\n      when fisid>0 then 'FIS' end,\r\n      case\r\n      when fatid>0 then fatid\r\n      when fisid>0 then fisid end,\r\n      varno,varok,0,perkod,adaid,\r\n      vadetar,\r\n      case when Vadeli=0 then tarih else vadetar end,saat,\r\n      karsi_car_id,karsi_carkod,'',\r\n      belno,ack+' / '+belno,cikan,giren,kur,parabrm,\r\n      olususer,olustarsaat,\r\n      gidkod,gidtutar,id,\r\n      fatid,fisid \r\n      from TahsilatOdeme with (nolock) where id=@id\r\n      and  sil=0\r\n      \r\n    \r\n      update bankahrk set bankhrkid=h.id from  TahsilatOdeme as ins with (nolock)\r\n      inner join bankahrk as h with (nolock) on ins.id=h.tahodeid \r\n      and ins.id=@id and  ins.sil=0\r\n  end\r\n  \r\n  \r\n  end\r\n  \r\n  \r\n  if @grp_tip='istkhrk'\r\n   begin\r\n  \r\n   delete from istkhrk where tahodeid=@id\r\n   \r\n   if @Durum=1\r\n   begin\r\n     insert istkhrk \r\n     (firmano,gctip,islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n     cartip,carkod,masterid,fisfattip,fisfatid,\r\n     varno,varok,istkhrkid,perkod,adaid,vadetar,tarih,saat,\r\n     istkk_id,istkkod,\r\n     belno,ack,borc,alacak,kur,parabrm,olususer,\r\n     olustarsaat,tahodeid,\r\n     fatid,fisid) \r\n  \r\n    select firmano,'-',islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n    cartip,carkod,0,\r\n     case \r\n      when fatid>0 then 'FAT'\r\n      when fisid>0 then 'FIS' end,\r\n      case\r\n      when fatid>0 then fatid\r\n      when fisid>0 then fisid end,\r\n      varno,varok,0,perkod,adaid,\r\n      vadetar,\r\n      case when Vadeli=0 then tarih else vadetar end,\r\n      saat,\r\n      karsi_car_id,karsi_carkod,\r\n      belno,ack+' / '+belno,cikan,giren,kur,parabrm,\r\n      olususer,olustarsaat,\r\n      id,fatid,fisid  from TahsilatOdeme with (nolock) where id=@id\r\n      and sil=0 \r\n  \r\n  \r\n     update istkhrk set istkhrkid=h.id from  TahsilatOdeme as ins with (nolock)\r\n     inner join istkhrk as h with (nolock) on ins.id=h.tahodeid and ins.id=@id\r\n     and ins.sil=0 and  ins.sil=0\r\n     \r\n  \r\n  end\r\n   \r\n   \r\n   end \r\n \r\nEND"
  },
  {
    "schema": "dbo",
    "name": "faturagiris",
    "definition": "CREATE PROCEDURE [dbo].faturagiris @fatid float\r\nAS\r\nBEGIN\r\ndeclare @firmano    \tfloat\r\ndeclare @varno    \tfloat\r\ndeclare @baktop \tfloat\r\ndeclare @newid \t\tfloat\r\ndeclare @fattip  \tvarchar(15)\r\ndeclare @borc    \tfloat\r\ndeclare @alacak \tfloat\r\ndeclare @tutar   \tfloat\r\ndeclare @genisktop  float\r\ndeclare @say \t\tint\r\ndeclare @kapacik \tvarchar(10)\r\ndeclare @hrk_car_pro bit\r\ndeclare @hrk_stk_pro  bit\r\ndeclare @gidkod     varchar(30)\r\ndeclare @gid_id     int\r\n\r\ndeclare @islmtip \tvarchar(20)\r\ndeclare @islmhrk \tvarchar(20)\r\ndeclare @islmtipad \tvarchar(30)\r\ndeclare @islmhrkad \tvarchar(30)\r\ndeclare @yertip \tvarchar(30)\r\ndeclare @yertipad \tvarchar(30)\r\n\r\n\r\ndeclare @cartip \tvarchar(20)\r\ndeclare @fattur \tvarchar(20)\r\n\r\ndeclare @mesaj      varchar(500)\r\ndeclare @gctip \t\tint\r\n\r\ndeclare @Karsi_Cartip_id int\r\ndeclare @Karsi_Car_id    int\r\ndeclare @Hrk_Karsi_Pro   bit\r\ndeclare @AvansTakip      bit\r\n\r\n\r\ndeclare @karsi_cartip     varchar(20)\r\ndeclare @karsi_carkod     varchar(50)\r\n\r\ndeclare @carkod\t\t\t   varchar(50)\r\ndeclare @fatrapid         int\r\n\r\ndeclare @karsi_ack     varchar(200)\r\ndeclare @IskGiderHrkYansit  bit\r\n\r\n if @fatid=0 \r\n  RETURN\r\n\r\n\r\nselect \r\n@firmano=firmano,\r\n@fattur=fattip,\r\n@fatrapid=fatrap_id,  \r\n@gctip=gctip,\r\n@tutar=genel_top,\r\n@genisktop=genel_isk_top,\r\n@cartip=cartip,\r\n@carkod=carkod,\r\n@hrk_stk_pro=hrk_stk_pro,\r\n@hrk_car_pro=hrk_car_pro,\r\n@Karsi_Cartip_id=Karsi_Cartip_id,\r\n@Karsi_Car_id=Karsi_Car_id,\r\n@Hrk_Karsi_Pro=Hrk_Karsi_Pro,\r\n@AvansTakip=AvansTakip \r\n\r\nfrom faturamas  WITH (NOLOCK) where fatid=@fatid\r\n\r\n  select @kapacik=kaptip,@IskGiderHrkYansit=IskGiderHrkYansit \r\n  from raporlar WITH (NOLOCK) where id=@fatrapid\r\n  /*rapkod=@fattur */\r\n\r\n set @islmtip='FAT'\r\n  SELECT @islmtipad=ad from islemturtip WITH (NOLOCK) where tip=@islmtip\r\n\r\n\r\n  set @borc=0\r\n  set @alacak=0\r\n\r\n  if @gctip=1  \r\n   set @alacak=@tutar\r\n\r\n\r\n  if @gctip=2 \r\n   set @borc=@tutar\r\n\r\n\r\n   /* SELECT @mesaj = '\"'+cast(@gctip as varchar(50))+ '\" ' */\r\n    /*   RAISERROR (@mesaj, 16,1) */\r\n\r\n\r\n\r\n\r\nif (@cartip='carikart') or (@cartip='perkart') or (@cartip='gelgidkart') or\r\n(@cartip='perakendekart')\r\nbegin\r\n\r\n  delete from carihrk from carihrk with(nolock) \r\n  where masterid=@fatid and SUBSTRING(islmhrk,1,3)='FAT'\r\n  \r\n  if @hrk_car_pro=1\r\n  begin\r\n  /*select @newid=isnull(max(carhrkid),0)+1 from carihrk */\r\n  \r\n  select @newid=isnull(IDENT_CURRENT('carihrk'),0)+1 \r\n  insert into carihrk (firmano,carhrkid,gctip,masterid,\r\n  islmtip,islmtipad,\r\n  islmhrk,islmhrkad,belrap_id,yertip,yerad,\r\n  cartip,carkod,borc,alacak,tarih,saat,olususer,olustarsaat,vadetar,belno,\r\n  ack,varno,kur,dataok,pro,varok,perkod,adaid,deguser,degtarsaat,sil,parabrm,\r\n  fisfattip,fatid,car_id,cartip_id)\r\n  select firmano,0,@gctip,@fatid,\r\n  @islmtip,@islmtipad,\r\n  fattip,fatad,fatrap_id,\r\n  'faturamas','FATURA GİRİŞ',\r\n  cartip,carkod,@borc,@alacak,\r\n  tarih,saat,olususer,olustarsaat,vadtar,fatseri+cast([fatno] as varchar),\r\n  ack,0,kur,dataok,1,1,'',0,deguser,degtarsaat,sil,parabrm,'FAT',fatid,\r\n  car_id,cartip_id\r\n  from faturamas WITH (NOLOCK) where fatid=@fatid\r\n  select @newid=SCOPE_IDENTITY()\r\n \r\n  update carihrk set carhrkid=@newid where id=@newid\r\n  \r\n /* Karsi Hrk Aktar */\r\n   if @Hrk_Karsi_Pro=1\r\n   begin\r\n   \r\n   set @islmtip='FAT'  \r\n    set @islmhrk='BCA'\r\n  \r\n    \r\n    select @karsi_ack=cast(kod as Varchar(50))+' / '+\r\n    unvan\r\n    from Genel_Cari_Kart WITH (NOLOCK) \r\n    where CarTip_id=@Karsi_Cartip_id and id=@Karsi_Car_id  \r\n    \r\n   SELECT @islmtipad=ad from islemturtip WITH (NOLOCK) where tip=@islmtip\r\n   SELECT @islmhrkad=ad from islemhrktip WITH (NOLOCK) where tip=@islmtip and hrk=@islmhrk;\r\n     \r\n    delete from carihrk where fatid=@fatid and \r\n    islmtip=@islmtip and islmhrk=@islmhrk\r\n\r\n    insert into carihrk (firmano,carhrkid,gctip,masterid,\r\n    islmtip,islmtipad,islmhrk,islmhrkad,\r\n    belrap_id,yertip,yerad,\r\n    cartip,carkod,borc,alacak,tarih,saat,olususer,olustarsaat,vadetar,belno,\r\n    ack,varno,kur,dataok,pro,varok,perkod,adaid,deguser,degtarsaat,sil,parabrm,\r\n    fisfattip,fatid,car_id,cartip_id,FatKapTip)\r\n    select firmano,0,@gctip,@fatid,\r\n    @islmtip,@islmtipad,@islmhrk,@islmhrkad,\r\n    fatrap_id,\r\n    'faturamas','FATURA GİRİŞ',\r\n    cartip,carkod,@alacak,@borc,\r\n    tarih,saat,olususer,olustarsaat,vadtar,fatseri+cast([fatno] as varchar),\r\n    @karsi_ack,0,kur,dataok,1,1,'',0,deguser,degtarsaat,sil,parabrm,'FAT',fatid,\r\n    car_id,cartip_id,KapTip\r\n    from faturamas WITH (NOLOCK) where fatid=@fatid\r\n    \r\n    select @newid=SCOPE_IDENTITY() \r\n    \r\n    update carihrk set carhrkid=@newid where id=@newid\r\n    \r\n    \r\n     \r\n    select @karsi_cartip='carikart'\r\n    \r\n    select @karsi_carkod=kod from carikart with (nolock)  where id=@Karsi_Car_id\r\n    \r\n    \r\n    select @karsi_ack=cast(kod as Varchar(50))+' / '+\r\n    unvan\r\n    from Genel_Cari_Kart WITH (NOLOCK)  where cartip=@cartip and kod=@carkod\r\n    \r\n   \r\n    insert into carihrk (firmano,carhrkid,gctip,masterid,\r\n    islmtip,islmtipad,islmhrk,islmhrkad,\r\n    belrap_id,yertip,yerad,\r\n    cartip,carkod,borc,alacak,tarih,saat,olususer,olustarsaat,vadetar,belno,\r\n    ack,varno,kur,dataok,pro,varok,perkod,adaid,deguser,degtarsaat,sil,parabrm,\r\n    fisfattip,fatid,car_id,cartip_id,FatKapTip)\r\n    select firmano,0,@gctip,@fatid,\r\n    @islmtip,@islmtipad,@islmhrk,@islmhrkad,\r\n    fatrap_id,\r\n    'faturamas','FATURA GİRİŞ',\r\n    @karsi_cartip,@karsi_carkod,@borc,@alacak,\r\n    tarih,saat,olususer,olustarsaat,vadtar,fatseri+cast([fatno] as varchar),\r\n    @karsi_ack,0,kur,dataok,1,1,'',0,deguser,degtarsaat,sil,parabrm,'FAT',fatid,\r\n    @Karsi_Car_id,@Karsi_Cartip_id,KapTip\r\n    from faturamas  WITH (NOLOCK) where fatid=@fatid\r\n    \r\n    select @newid=SCOPE_IDENTITY() \r\n    \r\n    update carihrk set carhrkid=@newid where id=@newid\r\n    \r\n   end\r\n   \r\n   \r\n   /*- Fatura Avans Takip Iskonto Tutarı Ekle */\r\n   \r\n    set @islmtip='FAT'  \r\n    set @islmhrk='FIA'/* FATURA ISKONTO AVANS TAKIP */\r\n   \r\n   delete from carihrk from carihrk with(nolock) where fatid=@fatid and \r\n   islmtip=@islmtip and islmhrk=@islmhrk\r\n   \r\n   \r\n  if  @AvansTakip=1\r\n   begin\r\n   /* select @gidkod=Fat_Avans_Kart from sistemtanim WITH (NOLOCK) */\r\n   /* select @gid_id=id from gelgidkart WITH (NOLOCK) where kod=@gidkod */\r\n   \r\n     if  (@gctip=2) and (@genisktop>0) \r\n      begin\r\n   \r\n       SELECT @islmtipad=ad from islemturtip WITH (NOLOCK) where tip=@islmtip\r\n       SELECT @islmhrkad=ad from islemhrktip WITH (NOLOCK) where tip=@islmtip and hrk=@islmhrk\r\n    \r\n    /* Fat Avans Kart Cari Kart Hrk   */\r\n      insert into carihrk \r\n      (firmano,carhrkid,gctip,masterid,islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n      cartip,carkod,borc,alacak,tarih,saat,olususer,olustarsaat,vadetar,belno,\r\n      ack,varno,kur,dataok,pro,varok,perkod,adaid,deguser,degtarsaat,sil,parabrm,\r\n      fisfattip,fatid,belrap_id,car_id,cartip_id,FatKapTip)\r\n      select m.firmano,@newid,@gctip,@fatid,\r\n      @islmtip,@islmtipad,@islmhrk,@islmhrkad,\r\n      'faturamas','FATURA GİRİŞ',\r\n      m.cartip,m.carkod,\r\n      sum((h.Top_isk_Tut)*(1+(h.kdvyuz))),0,m.tarih,m.saat,max(m.olususer),max(m.olustarsaat),\r\n      m.vadtar,m.fatseri+cast(m.fatno as varchar),\r\n      ' KDV % '+cast(h.kdvyuz*100 as varchar)+' '+\r\n      m.fatseri+cast(m.fatno as varchar)+' FATURA AVANS MAHSUP İŞLEMİ',\r\n      0,max(m.kur),max(m.dataok),0,1,'',0,\r\n      max(m.deguser),max(m.degtarsaat),max(m.sil),max(m.parabrm),'FAT',\r\n      max(m.fatid),max(m.fatrap_id),max(car_id),max(cartip_id),Max(m.KapTip)\r\n      from faturamas as m WITH (NOLOCK)\r\n      inner join faturahrk as h WITH (NOLOCK) on\r\n      m.fatid=h.fatid and h.sil=0\r\n      left join Genel_Kart as k WITH (NOLOCK) on \r\n      m.cartip=k.cartp and m.carkod=k.kod\r\n      where m.fatid=@fatid and m.sil=0\r\n      and h.Top_isk_Tut>0\r\n      Group By  m.firmano,m.cartip,m.carkod,m.tarih,m.saat,m.vadtar,\r\n      m.fatseri,m.fatno,h.kdvyuz\r\n      \r\n      \r\n      /* Fat Avans Kart Hrk   */\r\n      insert into carihrk \r\n      (firmano,carhrkid,gctip,masterid,islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n      cartip,carkod,borc,alacak,tarih,saat,olususer,olustarsaat,vadetar,belno,\r\n      ack,varno,kur,dataok,pro,varok,perkod,adaid,deguser,degtarsaat,sil,parabrm,\r\n      fisfattip,fatid,belrap_id,car_id,cartip_id,CariAvans,FatKapTip)\r\n      select m.firmano,@newid,@gctip,@fatid,\r\n      @islmtip,@islmtipad,@islmhrk,@islmhrkad,\r\n      'faturamas','FATURA GİRİŞ',\r\n      m.cartip,m.carkod,\r\n      0,sum((h.Top_isk_Tut)*(1+(h.kdvyuz))),m.tarih,m.saat,max(m.olususer),max(m.olustarsaat),\r\n      m.vadtar,m.fatseri+cast(m.fatno as varchar),\r\n      ' KDV % '+cast(h.kdvyuz*100 as varchar)+' '+\r\n      m.fatseri+cast(m.fatno as varchar)+'  FATURA AVANS MAHSUP İŞLEMİ',\r\n      0,max(m.kur),max(m.dataok),0,1,'',0,\r\n      max(m.deguser),max(m.degtarsaat),max(m.sil),max(m.parabrm),'FAT',\r\n      max(m.fatid),max(m.fatrap_id),max(car_id),max(cartip_id),1,Max(m.KapTip)\r\n      from faturamas as m WITH (NOLOCK)\r\n      inner join faturahrk as h WITH (NOLOCK) on\r\n      m.fatid=h.fatid and h.sil=0\r\n      left join Genel_Kart as k WITH (NOLOCK) on \r\n      m.cartip=k.cartp and m.carkod=k.kod\r\n      where m.fatid=@fatid and m.sil=0\r\n      and h.Top_isk_Tut>0\r\n      Group By  m.firmano,m.cartip,m.carkod,m.tarih,m.saat,m.vadtar,\r\n      m.fatseri,m.fatno,h.kdvyuz\r\n      \r\n      end\r\n    \r\n   \r\n   end\r\n   \r\n   \r\n   \r\n   \r\n   \r\n \r\n  \r\n  /*-fatura iskonto gideri */\r\n\r\n    set @islmtip='GLG'  \r\n    set @islmhrk='FTI'\r\n  \r\n  \r\n   delete from carihrk from carihrk with(nolock) where fatid=@fatid and \r\n   islmtip=@islmtip and islmhrk=@islmhrk\r\n\r\n   delete from carihrk from carihrk with(nolock) where fatid=@fatid and \r\n   islmtip=@islmtip and islmhrk='FIK'\r\n\r\n  if (@IskGiderHrkYansit=1) and (@hrk_stk_pro=0)\r\n   begin\r\n\r\n   select @gidkod=FatIskGiderKod from firma WITH (NOLOCK) where id=@firmano\r\n \r\n \r\n   select @gid_id=id from gelgidkart WITH (NOLOCK) where kod=@gidkod\r\n  \r\n  if  (@gctip=2) and (@genisktop>0) and (ISNULL(@gidkod,'')<>'')\r\n   begin\r\n   \r\n     \r\n      /* \r\n     if (ISNULL(@gidkod,'')='') \r\n       begin\r\n           set @mesaj='Fatura İskontoları İçin Sistem Tanımında Fatura İskonto Gider Kartı Seçiniz...!'+\r\n           char(13)+char(10)+\r\n           'İskonto Gider Yansıması Yapılamadı....!'\r\n           RAISERROR (@mesaj, 16,1)\r\n           ROLLBACK TRANSACTION\r\n           RETURN\r\n        end\r\n      */\r\n\r\n   \r\n   \r\n     SELECT @islmtipad=ad from islemturtip WITH (NOLOCK) where tip=@islmtip\r\n     SELECT @islmhrkad=ad from islemhrktip WITH (NOLOCK) where tip=@islmtip and hrk=@islmhrk\r\n    \r\n    \r\n      insert into carihrk \r\n      (firmano,carhrkid,gctip,masterid,islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n      cartip,carkod,borc,alacak,tarih,saat,olususer,olustarsaat,vadetar,belno,\r\n      ack,varno,kur,dataok,pro,varok,perkod,adaid,deguser,degtarsaat,sil,parabrm,\r\n      fisfattip,fatid,belrap_id,car_id,cartip_id,FatKapTip)\r\n      select m.firmano,@newid,@gctip,@fatid,\r\n      @islmtip,@islmtipad,@islmhrk,@islmhrkad,\r\n      'faturamas','FATURA GİRİŞ',\r\n      'gelgidkart',@gidkod,\r\n      h.Top_isk_Tut,0,m.tarih,m.saat,m.olususer,m.olustarsaat,\r\n      m.vadtar,m.fatseri+cast(m.fatno as varchar),\r\n      substring((sk.ad+\r\n      ' / % '+cast(h.Top_isk_Yuz as varchar(20))+' ( '+\r\n      cast( round((h.brmfiy*h.mik),2)  as varchar(20))+' ) / '+\r\n      k.ad+' / '+m.ack),1,200)\r\n      ,0,m.kur,m.dataok,0,1,'',0,\r\n      m.deguser,m.degtarsaat,m.sil,m.parabrm,'FAT',\r\n      m.fatid,m.fatrap_id,@gid_id,3,m.KapTip\r\n      from faturamas as m WITH (NOLOCK)\r\n      inner join faturahrk as h WITH (NOLOCK) on\r\n      m.fatid=h.fatid and h.sil=0\r\n      left join Genel_Kart as k WITH (NOLOCK) on \r\n      m.cartip=k.cartp and m.carkod=k.kod\r\n      left join gelgidlistok as sk WITH (NOLOCK)  on \r\n      sk.tip=h.stktip and h.stkod=sk.kod\r\n      where m.fatid=@fatid and m.sil=0\r\n      and h.Top_isk_Tut>0\r\n      \r\n     \r\n     \r\n       set @islmtip='GLG'  \r\n       set @islmhrk='FIK'/*FATURA ISKONTO KDV */\r\n      \r\n       SELECT @islmhrkad=ad from islemhrktip WITH (NOLOCK)\r\n        where tip=@islmtip and hrk=@islmhrk\r\n      \r\n      \r\n      insert into carihrk \r\n      (firmano,carhrkid,gctip,masterid,islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n      cartip,carkod,borc,alacak,tarih,saat,olususer,olustarsaat,vadetar,belno,\r\n      ack,varno,kur,dataok,pro,varok,perkod,adaid,deguser,degtarsaat,sil,parabrm,\r\n      fisfattip,fatid,belrap_id,car_id,cartip_id,FatKapTip)\r\n      select m.firmano,@newid,@gctip,@fatid,\r\n      @islmtip,@islmtipad,\r\n      @islmhrk,@islmhrkad,\r\n      'faturamas','FATURA GİRİŞ',\r\n      'gelgidkart',@gidkod,\r\n      ((h.Top_isk_Tut)*(1+(h.kdvyuz)))-\r\n      (h.Top_isk_Tut),\r\n      0,m.tarih,m.saat,m.olususer,m.olustarsaat,\r\n      m.vadtar,m.fatseri+cast(m.fatno as varchar),\r\n      substring((sk.ad+\r\n      ' / % '+cast(h.Top_isk_Yuz as varchar(20))+' ( '+\r\n      cast( round((h.kdvyuz*100),2)  as varchar(20))+' ) / '+\r\n      k.ad+' / KDV TUTARI'),1,200)\r\n      ,0,m.kur,m.dataok,0,1,'',0,\r\n      m.deguser,m.degtarsaat,m.sil,m.parabrm,'FAT',\r\n      m.fatid,m.fatrap_id,@gid_id,3,m.KapTip\r\n      from faturamas as m WITH (NOLOCK)\r\n      inner join faturahrk as h WITH (NOLOCK) on\r\n      m.fatid=h.fatid and h.sil=0\r\n      left join Genel_Kart as k WITH (NOLOCK) on \r\n      m.cartip=k.cartp and m.carkod=k.kod\r\n      left join gelgidlistok as sk WITH (NOLOCK) on \r\n      sk.tip=h.stktip and h.stkod=sk.kod\r\n      where m.fatid=@fatid and m.sil=0\r\n      and h.Top_isk_Tut>0\r\n      \r\n   \r\n   \r\n    end\r\n   \r\n   end   \r\n  \r\n  \r\n  end\r\n\r\n\r\nEND\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "faturahrkgiris",
    "definition": "CREATE PROCEDURE [dbo].faturahrkgiris (@fatid float,@kayok int,@sil int)\r\nAS\r\nBEGIN\r\n declare @satirtoplam float\r\n declare @kdvtip varchar(10)\r\n declare @stktip varchar(10)\r\n declare @satiristip varchar(10)\r\n declare @brimfiyatkdvsiz float\r\n declare @otvbrim float\r\n declare @brimfiy float\r\n declare @mik float\r\n declare @carpan float\r\n declare @geniskorn float\r\n declare @genelisktop float\r\n declare @gidertop float\r\n declare @giderbrmtut float\r\n declare @gen_ind_tip tinyint\r\n \r\n declare @id float\r\n declare @satirbrmisktut float\r\n declare @satirbrmisklutut float\r\n declare @satirisktop float\r\n declare @giderbrmcarp float\r\n declare @kdvyuz float\r\n declare @kdvtevkifatyuz float\r\n declare @satiriskyuz float\r\n declare @satirbrimfiyat float\r\n declare @satgenelisktut float\r\n declare @satirkdvtut float\r\n declare @satirkdvtevkifattut float\r\n \r\n\r\n declare @baslik_faturatop          float\r\n declare @baslik_satiriskontotop    float\r\n declare @baslik_satirgeniskontotop float\r\n declare @baslik_gidertop           float\r\n declare @baslik_kdvtop             float\r\n declare @baslik_giderkdvtop        float\r\n declare @genel_isk_top             float\r\n declare @genel_kdv_top\t\t\t\tfloat\r\n declare @genel_kdv_tevkifat_top\tfloat\r\n declare @genel_ara_top             float\r\n declare @genel_net_top\t\t\t\tfloat\r\n\r\n declare  @hrk_stk_pro  \t\tbit\r\n \r\n declare @gn_matrah \t\t\tfloat \r\n declare @ak_matrah \t\t\tfloat \r\n declare @mr_matrah \t\t\tfloat\r\n declare @gg_matrah \t\t\tfloat\r\n \r\n declare @ak_isk_tip           \tint\r\n declare @ak_isk_yuz   \t\t\tfloat\r\n declare @ak_isk_top   \t\t\tfloat\r\n declare @ak_sat_isk_yuz   \t\tfloat\r\n declare @ak_sat_isk_top   \t\tfloat\r\n \r\n \r\n declare @mr_isk_tip       \t\tint\r\n declare @mr_isk_yuz       \t\tfloat\r\n declare @mr_isk_top       \t\tfloat\r\n declare @mr_sat_isk_yuz   \t\tfloat\r\n declare @mr_sat_isk_top   \t\tfloat\r\n \r\n declare @gg_isk_tip       \t\tint\r\n declare @gg_isk_yuz       \t\tfloat\r\n declare @gg_isk_top       \t\tfloat\r\n declare @gg_sat_isk_yuz   \t\tfloat\r\n declare @gg_sat_isk_top   \t\tfloat\r\n \r\n\r\n \r\n \r\n declare @Sat_Top_isk_Tut       Float       \r\n\r\n\r\n set @Sat_Top_isk_Tut=0\r\n set @baslik_satiriskontotop=0\r\n set @baslik_satirgeniskontotop=0\r\n set @baslik_kdvtop=0\r\n set @baslik_giderkdvtop=0\r\n set @baslik_faturatop=0\r\n set @genel_kdv_tevkifat_top=0\r\n\r\n\r\n\r\n  select @satirtoplam=\r\n  isnull(sum(case when satirtip='S' then\r\n  ((brmfiy+otvbrim)-isnull(brmfiy*(satiskyuz/100),0))*mik else 0 end),0),\r\n  \r\n  /*isnull(satisktut,0) */\r\n  \r\n  /*@satirisktop=satisktut, */\r\n  @gidertop=\r\n  isnull(sum(case when satirtip='M' then\r\n  (brmfiy+otvbrim)*mik else 0 end),0),\r\n  \r\n  @ak_matrah=isnull(sum(case when stktip='akykt' then\r\n  ((brmfiy+otvbrim)- ((brmfiy+otvbrim)*(satiskyuz/100)) )*mik else 0 end),0),\r\n  @mr_matrah=isnull(sum(case when stktip='markt' then\r\n  ((brmfiy+otvbrim)-((brmfiy+otvbrim)*(satiskyuz/100) ))*mik else 0 end),0),\r\n  \r\n   @gg_matrah=isnull(sum(case when stktip='gelgid' and satirtip='S' then\r\n  ((brmfiy+otvbrim)-((brmfiy+otvbrim)*(satiskyuz/100) ))*mik else 0 end),0)\r\n  \r\n  \r\n  \r\n  from faturahrklistesi WITH (NOLOCK)  where fatid=@fatid and sil=0\r\n\r\n  set @baslik_gidertop=@gidertop\r\n\r\n  /*@geniskorn=case when isnull(geniskyuz,0)>0 then geniskyuz/100 else 0 end */\r\n  select @hrk_stk_pro=hrk_stk_pro,\r\n  @gen_ind_tip=isnull(gen_ind_tip,0),\r\n  @geniskorn=isnull(geniskyuz,0),\r\n  @genelisktop=isnull(genisktop,0),\r\n  @ak_isk_tip=isnull(ak_isk_tip,0),\r\n  @ak_isk_yuz=isnull(ak_isk_yuz,0),\r\n  @ak_isk_top=isnull(ak_isk_top,0),\r\n  @mr_isk_tip=isnull(mr_isk_tip,0),\r\n  @mr_isk_yuz=isnull(mr_isk_yuz,0),\r\n  @mr_isk_top=isnull(mr_isk_top,0),\r\n  @gg_isk_tip=isnull(gg_isk_tip,0),\r\n  @gg_isk_yuz=isnull(gg_isk_yuz,0),\r\n  @gg_isk_top=isnull(gg_isk_top,0)\r\n  \r\n  \r\n  \r\n  from faturamas WITH (NOLOCK) where fatid=@fatid and sil=0\r\n\r\n\r\n  set @geniskorn=@geniskorn/100\r\n\r\n  if @satirtoplam>0\r\n  set @giderbrmcarp=@gidertop/@satirtoplam/*oranı */\r\n\r\n  if (@satirtoplam>0) and (@gen_ind_tip=1) /*tutar indrim */\r\n  set @geniskorn=(@genelisktop/@satirtoplam)/*oranı */\r\n  \r\n  if (@satirtoplam>0) and (@gen_ind_tip=0) /*yuzde indrim */\r\n  set @genelisktop=(@geniskorn*@satirtoplam)/*oranı */\r\n  \r\n  \r\n  set @gn_matrah=0\r\n  /*set @ak_matrah=0 */\r\n /* set @mr_matrah=0 */\r\n  \r\n\r\n DECLARE faturahrkisle CURSOR FAST_FORWARD FOR \r\n SELECT id,satirtip,kayok,sil,\r\n brmfiy,otvbrim,kdvyuz,kdvtevkifatyuzde,satiskyuz,mik,carpan,kdvtip,stktip\r\n FROM faturahrklistesi WITH (NOLOCK) where fatid=@fatid and sil=0\r\n OPEN faturahrkisle\r\n FETCH NEXT FROM faturahrkisle INTO  @id,@satiristip,@kayok,@sil,\r\n @brimfiy,@otvbrim,@kdvyuz,@kdvtevkifatyuz,@satiriskyuz,@mik,@carpan,@kdvtip,@stktip\r\n WHILE @@FETCH_STATUS = 0\r\n BEGIN\r\n\r\n  /*kdv hariç */\r\n set @satirbrimfiyat=@brimfiy+@otvbrim\r\n\r\n\r\n set @satirbrmisktut=(@brimfiy)*(CASE when @satiriskyuz>0 then\r\n (@satiriskyuz/100) else 0 end)\r\n\r\n set @gn_matrah=@gn_matrah+((@satirbrimfiyat-@satirbrmisktut)*@mik)\r\n\r\n\r\n set @ak_sat_isk_yuz=0\r\n set @ak_sat_isk_top=0\r\n set @mr_sat_isk_yuz=0\r\n set @mr_sat_isk_top=0 \r\n set @gg_sat_isk_yuz=0\r\n set @gg_sat_isk_top=0 \r\n \r\n\r\n\r\n if @stktip='akykt'\r\n  begin\r\n    /*set @ak_matrah=@ak_matrah+((@satirbrimfiyat-@satirbrmisktut)*@mik) */\r\n      if @ak_isk_tip=0\r\n       begin\r\n          set @ak_sat_isk_top=((@satirbrimfiyat-@satirbrmisktut))*(@ak_isk_yuz/100)\r\n          set @ak_sat_isk_yuz=@ak_isk_yuz/*/100 */\r\n        end\r\n        \r\n      if @ak_isk_tip=1\r\n       begin\r\n          set @ak_sat_isk_yuz=(@ak_isk_top/(@ak_matrah))\r\n          set @ak_sat_isk_top=((@satirbrimfiyat-@satirbrmisktut))*(@ak_sat_isk_yuz)\r\n     \r\n        end\r\n\r\n     if @ak_matrah=0\r\n     begin\r\n      set @ak_sat_isk_yuz=0\r\n      set @ak_sat_isk_top=0\r\n     end\r\n\r\n   end\r\n \r\n if @stktip='markt'\r\n  begin\r\n    /* set @mr_matrah=@mr_matrah+((@satirbrimfiyat-@satirbrmisktut)*@mik) */\r\n       if @mr_isk_tip=0\r\n       begin\r\n        set @mr_sat_isk_top=((@satirbrimfiyat-@satirbrmisktut))*(@mr_isk_yuz/100)\r\n        set @mr_sat_isk_yuz=@mr_isk_yuz/*/100 */\r\n        end\r\n \r\n    if @mr_isk_tip=1\r\n     begin\r\n       set @mr_sat_isk_yuz=(@mr_isk_top/(@mr_matrah))\r\n       set @mr_sat_isk_top=((@satirbrimfiyat-@satirbrmisktut))*(@mr_sat_isk_yuz)\r\n     end\r\n     \r\n     if @mr_matrah=0\r\n     begin\r\n      set @mr_sat_isk_yuz=0\r\n      set @mr_sat_isk_top=0\r\n     end\r\n     \r\n     \r\n    end\r\n    \r\n\r\n  if (@stktip='gelgid') and (@satiristip='S')\r\n   begin\r\n    /* set @gg_matrah=@gg_matrah+((@satirbrimfiyat-@satirbrmisktut)*@mik) */\r\n       if @gg_isk_tip=0\r\n       begin\r\n        set @gg_sat_isk_top=((@satirbrimfiyat-@satirbrmisktut))*(@gg_isk_yuz/100)\r\n        set @gg_sat_isk_yuz=@gg_isk_yuz/100\r\n        end\r\n \r\n    if @gg_isk_tip=1\r\n     begin\r\n       set @gg_sat_isk_yuz=(@gg_isk_top/(@gg_matrah))\r\n       set @gg_sat_isk_top=((@satirbrimfiyat-@satirbrmisktut))*(@gg_sat_isk_yuz)\r\n     end\r\n     \r\n     if @gg_matrah=0\r\n     begin\r\n      set @gg_sat_isk_yuz=0\r\n      set @gg_sat_isk_top=0\r\n     end\r\n     \r\n     \r\n    end\r\n\r\n    \r\n    \r\n    \r\n\r\n if @satiristip='M'\r\n set @satgenelisktut=0\r\n if @satiristip='S'\r\n set @satgenelisktut=(@satirbrimfiyat-@satirbrmisktut)*@geniskorn\r\n \r\n set @giderbrmtut=@giderbrmcarp*@satirbrimfiyat\r\n set @satirbrmisklutut=(@satirbrimfiyat-\r\n (@satirbrmisktut+@satgenelisktut+\r\n isnull(@mr_sat_isk_top,0)+\r\n isnull(@ak_sat_isk_top,0)+\r\n isnull(@gg_sat_isk_top,0)))\r\n set @satirkdvtut=@satirbrmisklutut*@kdvyuz\r\n \r\n \r\n set @satirkdvtevkifattut=( (@satirkdvtut*@mik)*@kdvtevkifatyuz)\r\n \r\n \r\n set @Sat_Top_isk_Tut=(@mik*@satirbrmisktut)+\r\n  (@mik*@satgenelisktut)+(@mik*@ak_sat_isk_top)+\r\n  (@mik*@mr_sat_isk_top)+(@mik*@gg_sat_isk_top)\r\n \r\n if @satiristip='S'\r\n   update faturahrk set\r\n     hrk_stk_pro=@hrk_stk_pro,\r\n     giderbrmtut=@giderbrmtut,\r\n     satisktut=@satirbrmisktut,\r\n     geniskyuz=@geniskorn,\r\n     genisktut=@satgenelisktut,\r\n   \r\n     ak_isk_yuz=@ak_sat_isk_yuz,\r\n     ak_isk_tut=@ak_sat_isk_top,\r\n  \r\n     mr_isk_yuz=@mr_sat_isk_yuz,\r\n     mr_isk_tut=@mr_sat_isk_top,\r\n     \r\n     gg_isk_yuz=@gg_sat_isk_yuz,\r\n     gg_isk_tut=@gg_sat_isk_top,\r\n         \r\n     Top_isk_Yuz= case when (@Mik*@satirbrimfiyat)>0 then \r\n     (@Sat_Top_isk_Tut*100) / ((@Mik*@satirbrimfiyat)) else 0 end,\r\n     Top_isk_Tut=@Sat_Top_isk_Tut, \r\n \r\n    \r\n     kdvtut=@satirkdvtut,\r\n     \r\n     top_kdv_tut=@satirkdvtut*@Mik,\r\n     \r\n     KdvTevkifatTutar=@satirkdvtevkifattut,\r\n     \r\n     top_tut_kdvsiz=Mik*brmfiy,\r\n     \r\n     top_tut_isk_kdvsiz=(Mik*brmfiy)-@Sat_Top_isk_Tut,\r\n     \r\n     top_tut_isk_kdvli=((Mik*brmfiy)-@Sat_Top_isk_Tut)+\r\n     (@satirkdvtut*@Mik)\r\n     \r\n\r\n     \r\n   where id=@id\r\n  \r\n \r\n\r\n  if @satiristip='S'\r\n  begin\r\n  set @baslik_faturatop=@baslik_faturatop+(@satirbrimfiyat*@mik)\r\n  set @baslik_kdvtop=@baslik_kdvtop+(@satirkdvtut*@mik)\r\n  set @genel_kdv_tevkifat_top=@genel_kdv_tevkifat_top+@satirkdvtevkifattut\r\n  set @baslik_satiriskontotop=@baslik_satiriskontotop+(@satirbrmisktut*@mik)\r\n  set @baslik_satirgeniskontotop=@baslik_satirgeniskontotop+(@satgenelisktut*@mik)\r\n  end\r\n  if @satiristip='M'\r\n  set @baslik_giderkdvtop=@baslik_giderkdvtop+(@satirkdvtut*@mik)\r\n\r\n\r\n\r\n  FETCH NEXT FROM faturahrkisle INTO  @id,@satiristip,@kayok,@sil,\r\n @brimfiy,@otvbrim,@kdvyuz,@kdvtevkifatyuz,@satiriskyuz,@mik,@carpan,@kdvtip,@stktip\r\n END\r\n CLOSE faturahrkisle\r\n DEALLOCATE faturahrkisle\r\n \r\n \r\n if @ak_matrah=0\r\n begin\r\n set @ak_isk_top=0\r\n set @ak_isk_yuz=0\r\n end\r\n else\r\n  begin\r\n if @ak_isk_tip=0\r\n   set @ak_isk_top=@ak_matrah*(@ak_isk_yuz/100)\r\n if @ak_isk_tip=1\r\n   set @ak_isk_yuz=(@ak_isk_top/@ak_matrah)*100\r\n end  \r\n\r\n\r\n if @mr_matrah=0\r\n begin\r\n  set @mr_isk_top=0\r\n  set @mr_isk_yuz=0\r\n end\r\n else\r\n  begin\r\n  if @mr_isk_tip=0\r\n    set @mr_isk_top=@mr_matrah*(@mr_isk_yuz/100)\r\n\r\n  if @mr_isk_tip=1\r\n    set @mr_isk_yuz=(@mr_isk_top/@mr_matrah)*100\r\n  end  \r\n  \r\n  \r\n  if @gg_matrah=0\r\n   begin\r\n   set @gg_isk_top=0\r\n   set @gg_isk_yuz=0\r\n  end\r\n else\r\n  begin\r\n  if @gg_isk_tip=0\r\n    set @gg_isk_top=@gg_matrah*(@gg_isk_yuz/100)\r\n\r\n  if @gg_isk_tip=1\r\n    set @gg_isk_yuz=@gg_isk_top/@gg_matrah\r\n  end  \r\n  \r\n  \r\n  \r\n\r\n\r\n  /* ara toplam */\r\n    set @genel_ara_top=\r\n    round(@baslik_faturatop,2)\r\n\r\n   /* gider top */\r\n    set @gidertop=round(@gidertop,2)\r\n\r\n/*- genel iskonto toplam */\r\n   set @genel_isk_top=\r\n   round(@genelisktop+@baslik_satiriskontotop+\r\n   @ak_isk_top+@mr_isk_top+@gg_isk_top,2)\r\n   \r\n   \r\n   set @genel_net_top=@baslik_faturatop-@genel_isk_top+@gidertop\r\n   \r\n   \r\n /*genel kdv toplam   */\r\n    set @genel_kdv_top=round(@baslik_kdvtop+@baslik_giderkdvtop,2)\r\n \r\n \r\n /*-faturamas */\r\n  update faturamas set\r\n     fattop=@baslik_faturatop,\r\n     genel_ara_top=@genel_ara_top,\r\n     genel_net_top=@genel_net_top,\r\n     gidertop=@gidertop,\r\n     geniskyuz=@geniskorn*100,\r\n     genisktop=@genelisktop,\r\n     giderkdvtop=@baslik_giderkdvtop,\r\n     satisktop=@baslik_satiriskontotop,\r\n     kdvtop=@baslik_kdvtop,\r\n       \r\n     gn_matrah=@gn_matrah,\r\n     ak_matrah=@ak_matrah,\r\n     mr_matrah=@mr_matrah,\r\n     gg_matrah=@gg_matrah,\r\n     \r\n     ak_isk_yuz=@ak_isk_yuz,\r\n     ak_isk_top=@ak_isk_top,\r\n   \r\n     mr_isk_yuz=@mr_isk_yuz,\r\n     mr_isk_top=@mr_isk_top,  \r\n  \r\n     gg_isk_yuz=@gg_isk_yuz,\r\n     gg_isk_top=@gg_isk_top,  \r\n\r\n\r\n        \r\n     genel_isk_top=@genel_isk_top,\r\n     /*round(@genelisktop+@baslik_satiriskontotop+@ak_isk_top+@mr_isk_top+@gg_isk_top,2), */\r\n     \r\n     genel_kdv_top=@genel_kdv_top,\r\n     genel_kdv_tevkifat_top=@genel_kdv_tevkifat_top,\r\n     \r\n     genel_top=\r\n     round((@genel_ara_top-@genel_isk_top+@gidertop)+\r\n     (@genel_kdv_top-@genel_kdv_tevkifat_top+yuvtop),2)\r\n          \r\n    /* round(((@baslik_faturatop- */\r\n    /* (@genelisktop+@baslik_satiriskontotop+@ak_isk_top+@mr_isk_top)) */\r\n    /* +(@baslik_kdvtop+@baslik_giderkdvtop+@gidertop+yuvtop)),2) */\r\n     where fatid=@fatid\r\n \r\n \r\nEND"
  },
  {
    "schema": "dbo",
    "name": "Fis_Cari_Alacak",
    "definition": "CREATE PROCEDURE  [dbo].[Fis_Cari_Alacak] (\r\n@verid \tfloat,\r\n@sil \tint)\r\nAS\r\nBEGIN\r\n\r\ndeclare @newid float    \r\ndeclare @fistip varchar(10)\r\ndeclare @fistipad varchar(30)\r\n\r\ndeclare @islmtip  \t\tvarchar(50)\r\ndeclare @islmtipad \t\tvarchar(50)\r\ndeclare @islmhrk  \t\tvarchar(50)\r\ndeclare @islmhrkad \t\tvarchar(50)\r\n\r\n\r\ndeclare @ack \t\t\tvarchar(200)\r\ndeclare @carkod \t\tvarchar(50)\r\ndeclare @cartip\t\t\tvarchar(50)\r\ndeclare @alc_carsec     bit\r\n\r\n\r\n\r\n\r\n\r\n if @verid=0\r\n  RETURN\r\n\r\n\r\n if @sil=1\r\n  begin\r\n    \r\n    delete from carihrk where fis_brc_id=@verid\r\n    \r\n    RETURN\r\n  end\r\n  \r\n\r\n  if @sil=0\r\n   begin \r\n   \r\n    set @alc_carsec=0\r\n      \r\n    select @alc_carsec=alc_carsec from veresimas with (nolock) where verid=@verid \r\n    and alc_carsec=1 and fistip='FISVERSAT' and sil=0   \r\n   \r\n    if @alc_carsec=0\r\n      update carihrk set sil=1 where fis_brc_id=@verid and sil=0\r\n   \r\n   \r\n    if (@alc_carsec=1)\r\n     begin\r\n    \r\n     /*veresiye fisine cari yansıması  */\r\n    \r\n      delete from carihrk where fis_brc_id=@verid\r\n     \r\n     \r\n      select @carkod=carkod,@cartip=cartip\r\n      from veresimas with (nolock)\r\n      where verid=@verid and sil=0 \r\n     \r\n      select @ack='FİŞ ALACAK - C/H : '+@carkod+' / '+ad from \r\n      Genel_Kart as k where k.cartp=@cartip and k.kod=@carkod\r\n    \r\n    \r\n       set @islmtip='FIS'\r\n        SELECT @islmtipad=AD from islemturtip where tip=@islmtip\r\n        set @islmhrk='VFG'\r\n        SELECT @islmhrkad=ad from islemhrktip where tip=@islmtip \r\n        and hrk=@islmhrk\r\n     \r\n     \r\n       select @newid=0  \r\n       insert into carihrk (carhrkid,firmano,gctip,masterid,fisfattip,fisfatid,\r\n       islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n       cartip,cartip_id,carkod,borc,alacak,bakiye,tarih,saat,olususer,olustarsaat,vadetar,belno,\r\n       ack,varno,kur,dataok,pro,varok,perkod,adaid,deguser,degtarsaat,sil,\r\n       karsihestip,karsiheskod,parabrm,fis_brc_id)\r\n  \r\n       select 0,\r\n       firmano,'A',0,'',0,\r\n       @islmtip,@islmtipad,@islmhrk,@islmhrkad,yertip,yerad,\r\n       cartip,cartip_id,brc_carkod,0,toptut,0,tarih,saat,olususer,olustarsaat,vadtar,\r\n       seri+CAST([no] as varchar),@ack,varno,kur,0,0,varok,perkod,adaid,\r\n       deguser,degtarsaat,sil,'','',parabrm,@verid\r\n       from veresimas with (nolock) where verid=@verid and sil=0 \r\n       \r\n       select @newid=SCOPE_IDENTITY()\r\n       update carihrk set carhrkid=@newid where id=@newid\r\n       \r\n      \r\n      return  \r\n   \r\n   end    \r\n   \r\n   end\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "Fis_Cari_Borc",
    "definition": "CREATE  PROCEDURE  [dbo].Fis_Cari_Borc (\r\n@verid float,\r\n@sil int)\r\nAS\r\nBEGIN\r\n\r\ndeclare @newid float    \r\ndeclare @fistip varchar(10)\r\ndeclare @fistipad varchar(30)\r\n\r\ndeclare @islmtip  \t\tvarchar(50)\r\ndeclare @islmtipad \t\tvarchar(50)\r\ndeclare @islmhrk  \t\tvarchar(50)\r\ndeclare @islmhrkad \t\tvarchar(50)\r\n\r\n\r\n  set @fistip='FISVERSAT'\r\n\r\n\r\n if @sil=1\r\n  begin\r\n    delete from veresimas where fis_cariver_id=@verid \r\n    \r\n    delete from carihrk where fis_alc_id=@verid\r\n    \r\n    update veresimas set fis_alc_bagverid=0 \r\n     where verid=(select top 1 fis_alc_bagverid \r\n     from veresimas with (nolock) where verid=@verid )\r\n\r\n    RETURN\r\n  end\r\n  \r\n\r\n    select @fistipad=ad from fattip where kod=@fistip\r\n   \r\n   \r\n   if @sil=0\r\n   begin \r\n     delete from veresimas where fis_cariver_id=@verid\r\n   \r\n    if EXISTS ( select id from veresimas with (nolock) where verid=@verid and brc_carsec=1 )\r\n     begin\r\n   \r\n    \r\n      select @newid=0\r\n      insert into veresimas (\r\n      verid,varno,kayok,fisad,fisrap_id,fistip,yertip,tarih,yerad,seri,[no],ykno,cartip,\r\n      carkod,plaka,perkod,adaid,surucu,km,toptut,ack,kmsec,varok,sil,saat,\r\n      ototag,olususer,degtarsaat,deguser,olustarsaat,dataok,aktip,fatbelno,\r\n      aktar,vadtar,bagid,marsatid,parabrm,kur,akid,fis_cariver_id) \r\n      select\r\n      @newid,varno,kayok,@fistipad,fisrap_id,@fistip,yertip,tarih,yerad,seri,[no],ykno,\r\n      brc_cartip,brc_carkod,plaka,perkod,adaid,surucu,km,0,ack+' - BAĞLI FİŞ',kmsec,varok,sil,saat,\r\n      ototag,olususer,degtarsaat,deguser,olustarsaat,0,aktip,fatbelno,\r\n      aktar,vadtar,@verid,marsatid,parabrm,kur,akid,@verid \r\n      from veresimas with (nolock) where verid=@verid and brc_carsec=1\r\n      select @newid=SCOPE_IDENTITY()\r\n      update veresimas set verid=@newid where id=@newid\r\n      \r\n      \r\n      insert into veresihrk (varno,verid,stktip,stkod,mik,brmfiy,depkod,kdvyuz,brim,sil,olususer,\r\n      olustarsaat,deguser,degtarsaat,dataok,yenbrmfiyfark,kayok,akfiytip)\r\n      select varno,@newid,stktip,stkod,mik,brmfiy,depkod,kdvyuz,brim,sil,olususer,\r\n      olustarsaat,deguser,degtarsaat,0,yenbrmfiyfark,kayok,akfiytip from veresihrk with (nolock)\r\n      where verid=@verid and sil=0 \r\n    end  \r\n   \r\n   \r\n   /*alacak fisine cari yansıması  */\r\n    if EXISTS ( select id from veresimas with (nolock) where verid=@verid \r\n    and (fis_alc_kocan=1 ) and fistip='FISALCSAT') \r\n     begin\r\n     \r\n      delete from carihrk where fis_alc_id=@verid\r\n     \r\n     \r\n     \r\n       set @islmtip='FIS'\r\n        SELECT @islmtipad=AD from islemturtip where tip=@islmtip\r\n        set @islmhrk='AFG'\r\n        SELECT @islmhrkad=ad from islemhrktip where tip=@islmtip and hrk=@islmhrk\r\n     \r\n     \r\n       select @newid=0\r\n       insert into carihrk (carhrkid,gctip,masterid,fisfattip,fisfatid,\r\n       islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n       cartip,carkod,borc,alacak,bakiye,tarih,saat,olususer,olustarsaat,vadetar,belno,\r\n        ack,varno,kur,dataok,pro,varok,perkod,adaid,deguser,degtarsaat,sil,\r\n        karsihestip,karsiheskod,parabrm,fis_alc_id)\r\n        \r\n       select @newid,\r\n       'B',0,'',0,\r\n       @islmtip,@islmtipad,@islmhrk,@islmhrkad,yertip,yerad,\r\n       cartip,carkod,toptut,0,0,tarih,saat,olususer,olustarsaat,vadtar,\r\n       seri+CAST([no] as varchar),ack,varno,kur,0,0,varok,perkod,adaid,\r\n       deguser,degtarsaat,sil,'','',parabrm,@verid\r\n       from veresimas with (nolock)\r\n       where verid=@verid and sil=0 \r\n       \r\n       select @newid=SCOPE_IDENTITY()\r\n       update carihrk set carhrkid=@newid where id=@newid\r\n       \r\n      \r\n      return  \r\n       \r\n   \r\n   end\r\n   \r\n   \r\n    \r\n   /*alacak fisine cari yansıması  */\r\n    if EXISTS ( select id from veresimas with (nolock) where verid=@verid \r\n    and (brc_carsec=0 or (brc_carsec is null) ) and (fis_alc_kocan=0) and fistip='FISALCSAT')\r\n     begin\r\n     \r\n      delete from carihrk where fis_alc_id=@verid\r\n     \r\n     \r\n     \r\n     set @islmtip='FIS'\r\n     SELECT @islmtipad=AD from islemturtip where tip=@islmtip\r\n     set @islmhrk='AFG'\r\n     SELECT @islmhrkad=ad from islemhrktip where tip=@islmtip and hrk=@islmhrk\r\n     \r\n     \r\n       select @newid=0\r\n       insert into carihrk (carhrkid,gctip,masterid,fisfattip,fisfatid,\r\n       islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n       cartip,carkod,borc,alacak,bakiye,tarih,saat,olususer,olustarsaat,vadetar,belno,\r\n        ack,varno,kur,dataok,pro,varok,perkod,adaid,deguser,degtarsaat,sil,\r\n        karsihestip,karsiheskod,parabrm,fis_alc_id)\r\n        \r\n       select @newid,\r\n       'B',0,'',0,\r\n       @islmtip,@islmtipad,@islmhrk,@islmhrkad,yertip,yerad,\r\n       cartip,carkod,toptut,0,0,tarih,saat,olususer,olustarsaat,vadtar,\r\n       seri+CAST([no] as varchar),ack,varno,kur,0,0,varok,perkod,adaid,\r\n       deguser,degtarsaat,sil,'','',parabrm,@verid\r\n       from veresimas with (nolock)\r\n       where verid=@verid and sil=0 \r\n       select @newid=SCOPE_IDENTITY()\r\n       update carihrk set carhrkid=@newid where id=@newid\r\n      \r\n        \r\n       \r\n    end\r\n     \r\n   end\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "Fis_Odeme_Sil",
    "definition": "CREATE PROCEDURE [dbo].Fis_Odeme_Sil @verid int \r\nAS\r\nBEGIN\r\n  \r\n /* kasahrk  sil */\r\n   if @verid=0\r\n     RETURN\r\n    \r\n      update kasahrk set sil=1 \r\n       where fisfatid=@verid and fisfattip='FIS'\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "fisparcala",
    "definition": "CREATE PROCEDURE [dbo].fisparcala @verid float,@odentut float\r\nAS\r\nBEGIN\r\ndeclare @topmastut \tfloat\r\ndeclare @fishrktut \tfloat\r\ndeclare @brmfiy \tfloat\r\ndeclare @idxmas \tfloat\r\ndeclare @idx \t\tfloat\r\ndeclare @kalan \t\tfloat\r\ndeclare @newverid \tfloat\r\ndeclare @bolmiktar \tfloat\r\n\r\nSET NOCOUNT ON\r\n\r\nif @odentut=0\r\n RETURN\r\n\r\n select @idxmas=id,@topmastut=isnull(round((toptut-isktop),2),0) from \r\n veresimas with (nolock) where verid=@verid\r\n and fistip='FISVERSAT' and aktip in ('BK','BL')\r\n\r\nset @kalan=@odentut\r\n\r\n\r\nif @odentut<@topmastut\r\nbegin\r\n\r\nDECLARE fisparcalax CURSOR FAST_FORWARD FOR SELECT id,verid,\r\n  round(( (brmfiy*(1-(iskyuz/100)))*mik),2),(brmfiy*(1-(iskyuz/100)))\r\n   FROM\r\n veresihrk with (nolock) where verid=@verid\r\n OPEN fisparcalax\r\n  FETCH NEXT FROM fisparcalax INTO  \r\n  @idx,@verid,@fishrktut,@brmfiy\r\n  WHILE @@FETCH_STATUS = 0\r\n  BEGIN\r\n\r\nset @kalan=@kalan-@fishrktut\r\nif @kalan<0\r\nbegin\r\n\r\n\r\n/* yeni fis olustuluyor */\r\n  insert into veresimas (\r\n  firmano,verid,varno,kayok,\r\n  gctip,fistip_id,fistur_id,fisrap_id,\r\n  hrk_car_pro,hrk_stk_pro,\r\n  fisad,fistip,yertip,tarih,yerad,seri,[no],ykno,\r\n  cartip,cartip_id,car_id,carkod,\r\n  plaka,perkod,adaid,surucu,km,toptut,isktop,\r\n  ack,kmsec,varok,sil,saat,\r\n  ototag,olususer,degtarsaat,deguser,olustarsaat,dataok,aktip,fatbelno,\r\n  aktar,vadtar,bagid,marsatid,parabrm,kur,akid,\r\n  Kart_parabrm,Kart_kur,Islem_Parabrm,Islem_Kur) \r\n  select firmano,0,varno,0,\r\n  gctip,fistip_id,fistur_id,fisrap_id,\r\n  hrk_car_pro,hrk_stk_pro,\r\n  fisad,fistip,yertip,tarih,yerad,seri,[no],ykno,\r\n  cartip,cartip_id,car_id,carkod,plaka,perkod,adaid,surucu,\r\n  km,0,0,'BÖLÜNEN FİŞ',kmsec,varok,sil,saat,\r\n  ototag,olususer,degtarsaat,deguser,olustarsaat,0,aktip,fatbelno,\r\n  aktar,vadtar,@idxmas,marsatid,parabrm,kur,akid,\r\n  Kart_parabrm,Kart_kur,Islem_Parabrm,Islem_Kur \r\n  \r\n  from veresimas with (nolock) where verid=@verid\r\n\r\n   select @newverid=SCOPE_IDENTITY()\r\n\r\n/* yeni fis olustuluyor */\r\n\r\n\r\n/* yeni fis hrk olustuluyor */\r\n\r\n  update veresihrk set \r\n  mik=((( (brmfiy*(1-iskyuz/100))*mik)+@kalan)/ (brmfiy*(1-(iskyuz/100)) ))\r\n   where id=@idx\r\n\r\n  set @bolmiktar=((-1*@kalan)/@brmfiy)\r\n\r\n  insert into veresihrk (firmano,varno,verid,\r\n  stktip_id,stktip,stk_id,stkod,\r\n  mik,brmfiy,iskyuz,\r\n  depkod,dep_id,kdvyuz,brim,sil,olususer,\r\n  olustarsaat,deguser,degtarsaat,dataok,yenbrmfiyfark,kayok,akfiytip,\r\n  Kart_parabrm,Kart_kur,Islem_Parabrm,Islem_Kur)\r\n  select firmano,varno,@newverid,\r\n  stktip_id,stktip,stk_id,stkod,\r\n  @bolmiktar,brmfiy,iskyuz,depkod,dep_id,\r\n  kdvyuz,brim,sil,olususer,\r\n  olustarsaat,deguser,degtarsaat,0,\r\n  yenbrmfiyfark,kayok,akfiytip,\r\n  Kart_parabrm,Kart_kur,Islem_Parabrm,Islem_Kur  from veresihrk with (nolock)\r\n  where id=@idx  and verid=@verid\r\n\r\n/* yeni fis hrk olustuluyor */\r\n\r\n/* diger fis hrk yeni fise tasınıyor */\r\n  update veresihrk set verid=@newverid where id>@idx and verid=@verid\r\n  \r\n  \r\n   update veresimas set verid=@newverid,\r\n    kayok=1 where id=@newverid\r\n\r\nbreak\r\n\r\nend\r\n\r\n\r\n  FETCH NEXT FROM fisparcalax INTO  @idx,@verid,@fishrktut,@brmfiy\r\n  END\r\n  CLOSE fisparcalax\r\n  DEALLOCATE fisparcalax\r\n\r\n\r\n\r\nend\r\n\r\nSET NOCOUNT OFF\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "Fiyat_Fark_Yansıma",
    "definition": "CREATE  PROCEDURE [dbo].Fiyat_Fark_Yansıma\r\n(@tip varchar(30),\r\n@masid integer,\r\n@sil  tinyint)\r\nAS\r\nBEGIN\r\n\r\n\r\n  declare @newid int\r\n  DECLARE @gidkod varchar(30)\r\n  DECLARE @tutar float\r\n  \r\n  declare @kur      float\r\n  declare @parabrm  varchar(20)\r\n  \r\n  declare @islmtip varchar(30)\r\n  declare @islmtipad varchar(50)\r\n  declare @islmhrk varchar(30)\r\n  declare @islmhrkad varchar(50)\r\n  declare @ack       varchar(50)\r\n\r\n\r\n  declare @yertip varchar(30)\r\n  declare @yerad varchar(50)\r\n  \r\n  if @tip='YFF'\r\n    begin\r\n    \r\n     set @islmtip='GLG'\r\n     select @islmtipad=ad from islemturtip where tip=@islmtip\r\n     set @islmhrk='YFK'\r\n     select @islmhrkad=ad from islemhrktip where\r\n     tip=@islmtip and hrk=@islmhrk\r\n\r\n     set @yertip='yenifiyfark'\r\n     select @yerad=ad from yertipad where kod=@yertip\r\n\r\n     select @parabrm=sistem_parabrm,@kur=sistem_kasakur,\r\n     @gidkod=vadfarkgelgid from sistemtanim\r\n     \r\n     set @ack='FİŞLERE YENİ FİYAT UYGULA'\r\n   end\r\n   \r\n    if @tip='VDF'\r\n    begin\r\n     set @islmtip='VAD'\r\n     select @islmtipad=ad from islemturtip where tip=@islmtip\r\n     set @islmhrk='VDF'\r\n     select @islmhrkad=ad from islemhrktip where\r\n     tip=@islmtip and hrk=@islmhrk\r\n\r\n     set @yertip='vadefiyfark'\r\n     select @yerad=ad from yertipad where kod=@yertip\r\n\r\n     select @parabrm=sistem_parabrm,@kur=sistem_kasakur,\r\n     @gidkod=vadfarkgelgid from sistemtanim\r\n\r\n     set @ack='FİŞLERE VADE FARKI UYGULA'\r\n   end\r\n\r\n  delete from carihrk where masterid=@masid and islmtip=@islmtip\r\n  and islmhrk=@islmhrk\r\n\r\n  select @newid=0\r\n  insert into carihrk (carhrkid,gctip,masterid,fisfattip,fisfatid,islmtip,islmtipad,islmhrk,islmhrkad,\r\n  yertip,yerad,cartip,carkod,borc,alacak,bakiye,tarih,saat,olususer,olustarsaat,vadetar,belno,\r\n  ack,varno,kur,dataok,pro,varok,perkod,adaid,deguser,degtarsaat,sil,\r\n  karsihestip,karsiheskod,parabrm)\r\n  select @newid,'A',@masid,'KENDI',0,\r\n  @islmtip,@islmtipad,@islmhrk,@islmhrkad,@yertip,@yerad,\r\n  'gelgidkart',@gidkod,0,@tutar,0,max(tarih),max(saat),max(olususer),\r\n  max(olustarsaat),max(tarih),cast(@masid as varchar),\r\n  @ack,0,@kur,0,1,1,'',0,'','',1,\r\n  '','',@parabrm from veresifarkhrk with (nolock) where masterid=@masid\r\n  \r\n  select @newid=SCOPE_IDENTITY()\r\n  update carihrk set carhrkid=@newid where id=@newid\r\n  \r\n  \r\nEND"
  },
  {
    "schema": "dbo",
    "name": "GENEL_GECVAROZETOLUSTUR",
    "definition": "CREATE PROCEDURE [dbo].GENEL_GECVAROZETOLUSTUR \r\n(@TIP varchar(20),@VARNOIN VARCHAR(max))\r\nAS\r\nBEGIN\r\ndeclare @sil \tint\r\ndeclare @varok \tint\r\ndeclare @varno \tint\r\n\r\n\r\n /*--vardiya özet tablosuna kapanış bilgilerini at */\r\n if @TIP='pomvardimas'\r\n begin\r\n  \r\n  DECLARE CRS_HRK CURSOR FAST_FORWARD FOR\r\n    SELECT varno FROM pomvardimas with (nolock) where varno in (select * from CsvToInt_Max(@VARNOIN))\r\n    and sil=0 and varok=1 ORDER BY varno\r\n    OPEN CRS_HRK\r\n   FETCH NEXT FROM CRS_HRK INTO  @varno\r\n    WHILE @@FETCH_STATUS = 0\r\n     BEGIN \r\n\r\n    delete from pomvardiozet where varno=@varno\r\n    \r\n    select @varok=varok,@sil=sil from pomvardimas with (nolock)  where varno=@varno\r\n\r\n    exec pomvarozet_Yeni @varno,'per','genel'\r\n    insert into pomvardiozet (varno,varok,sil,tip,tipack,giris,cikis,bakiye,sr)\r\n    select @varno,@varok,@sil,ickkod,ickad,sum(grs),sum(cks),sum(grs-cks),sr\r\n    from ##pomvardiozet where varno=@varno\r\n    group by ickkod,ickad,sr order by sr\r\n\r\n     FETCH NEXT FROM CRS_HRK INTO @varno\r\n    END\r\n   CLOSE CRS_HRK\r\n   DEALLOCATE CRS_HRK\r\n end\r\n\r\n /*--vardiya özet tablosuna kapanış bilgilerini at */\r\n if @TIP='marvardimas'\r\n begin\r\n \r\n DECLARE CRS_HRK CURSOR FAST_FORWARD FOR\r\n    SELECT varno FROM marvardimas with (nolock)  where varno in (select * from CsvToInt_Max(@VARNOIN))\r\n    and sil=0 and varok=1 ORDER BY varno\r\n    OPEN CRS_HRK\r\n   FETCH NEXT FROM CRS_HRK INTO  @varno\r\n    WHILE @@FETCH_STATUS = 0\r\n     BEGIN \r\n\r\n     delete from marvardiozet where varno=@varno\r\n     select @varok=varok,@sil=sil from marvardimas with (nolock)  where varno=@varno\r\n     exec marvarozet @varno,'per','genel'\r\n     insert into marvardiozet (varno,varok,sil,tip,tipack,giris,cikis,bakiye,sr)\r\n     select @varno,@varok,@sil,ickkod,ickad,sum(grs),sum(cks),sum(grs-cks),sr\r\n     from ##marvardiozet where varno=@varno\r\n     group by ickkod,ickad,sr order by sr\r\n    /*------------------------ */\r\n\r\n     FETCH NEXT FROM CRS_HRK INTO @varno\r\n    END\r\n   CLOSE CRS_HRK\r\n   DEALLOCATE CRS_HRK\r\n\r\n end\r\n \r\n \r\n /*--vardiya özet tablosuna kapanış bilgilerini at */\r\n if @TIP='resvardimas'\r\n begin\r\n \r\n DECLARE CRS_HRK CURSOR FAST_FORWARD FOR\r\n    SELECT varno FROM resvardimas with (nolock)  where varno in (select * from CsvToInt_Max(@VARNOIN))\r\n    and sil=0 and varok=1 ORDER BY varno\r\n    OPEN CRS_HRK\r\n   FETCH NEXT FROM CRS_HRK INTO  @varno\r\n    WHILE @@FETCH_STATUS = 0\r\n     BEGIN \r\n\r\n     delete from resvardiozet where varno=@varno\r\n     select @varok=varok,@sil=sil from resvardimas with (nolock)  where varno=@varno\r\n     exec resvarozet @varno,'per','genel'\r\n     insert into resvardiozet (varno,varok,sil,tip,tipack,giris,cikis,bakiye,sr)\r\n     select @varno,@varok,@sil,ickkod,ickad,sum(grs),sum(cks),sum(grs-cks),sr\r\n     from ##resvardiozet where varno=@varno\r\n     group by ickkod,ickad,sr order by sr\r\n    /*------------------------ */\r\n\r\n     FETCH NEXT FROM CRS_HRK INTO @varno\r\n    END\r\n   CLOSE CRS_HRK\r\n   DEALLOCATE CRS_HRK\r\n\r\n end\r\n \r\n  \r\nEND"
  },
  {
    "schema": "dbo",
    "name": "Genel_Log",
    "definition": "CREATE PROCEDURE [dbo].Genel_Log @yertip varchar(30),@id float,@islemtip int\r\nAS\r\nBEGIN\r\n  \r\n insert into genellog (tarih,yertip,islemno,islemtip,aktip)\r\n values (GETDATE(),@yertip,@id,@islemtip,0)\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "Genelrap_olustur",
    "definition": "CREATE PROCEDURE [dbo].Genelrap_olustur\r\nAS\r\nBEGIN\r\n\r\n\r\ntruncate table Genel_Rap_Goster\r\n\r\ninsert into Genel_Rap_Goster (id,ad,Goster)\r\nvalues (1,'Akaryakıt Satış Listesi',1)\r\n\r\ninsert into Genel_Rap_Goster (id,ad,Goster)\r\nvalues (2,'Gider Listesi',1)\r\n\r\ninsert into Genel_Rap_Goster (id,ad,Goster)\r\nvalues (3,'Gelir Listesi',1)\r\n\r\ninsert into Genel_Rap_Goster (id,ad,Goster)\r\nvalues (4,'Cari Kartlar',1)\r\n\r\ninsert into Genel_Rap_Goster (id,ad,Goster)\r\nvalues (5,'Personel Kartlar',1)\r\n\r\ninsert into Genel_Rap_Goster (id,ad,Goster)\r\nvalues (6,'Banka Kartları',1)\r\n\r\ninsert into Genel_Rap_Goster (id,ad,Goster)\r\nvalues (7,'Pos Kartları',1)\r\n\r\ninsert into Genel_Rap_Goster (id,ad,Goster)\r\nvalues (8,'İşletme Kredi Kartları',1)\r\n\r\n\r\ninsert into Genel_Rap_Goster (id,ad,Goster)\r\nvalues (9,'Çek',1)\r\n\r\n\r\ninsert into Genel_Rap_Goster (id,ad,Goster)\r\nvalues (10,'Kasa',1)\r\n\r\n\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "genelrapolustur",
    "definition": "CREATE PROCEDURE [dbo].genelrapolustur\r\nAS\r\nBEGIN\r\n\r\n\r\ntruncate table genelrap_goster\r\n\r\ninsert into genelrap_goster (id,ad,Goster)\r\nvalues (1,'Akaryakıt Satış Listesi',1)\r\n\r\ninsert into genelrap_goster (id,ad,Goster)\r\nvalues (2,'Gider Listesi',1)\r\n\r\ninsert into genelrap_goster (id,ad,Goster)\r\nvalues (3,'Gelir Listesi',1)\r\n\r\ninsert into genelrap_goster (id,ad,Goster)\r\nvalues (4,'Cari Veresiye',1)\r\n\r\ninsert into genelrap_goster (id,ad,Goster)\r\nvalues (5,'Cari Tahsilat',1)\r\n\r\ninsert into genelrap_goster (id,ad,Goster)\r\nvalues (6,'Cari Ödemeler',1)\r\n\r\ninsert into genelrap_goster (id,ad,Goster)\r\nvalues (7,'Cari Bakiye',1)\r\n\r\ninsert into genelrap_goster (id,ad,Goster)\r\nvalues (8,'Banka Kartları',1)\r\n\r\ninsert into genelrap_goster (id,ad,Goster)\r\nvalues (9,'Pos Kartları',1)\r\n\r\ninsert into genelrap_goster (id,ad,Goster)\r\nvalues (10,'Çek Listesi',1)\r\n\r\ninsert into genelrap_goster (id,ad,Goster)\r\nvalues (11,'Kasa Listesi',1)\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "havuzfisaktar",
    "definition": "CREATE PROCEDURE [dbo].havuzfisaktar(\r\n@firmano int,\r\n@aktip    int,/*1 aktarım 0 geri al */\r\n@veridin  varchar(8000),\r\n@varno  int)\r\nAS\r\n BEGIN\r\n\r\n \r\n  declare @yertip varchar(30)\r\n  declare @yertipad varchar(50)\r\n  declare @say           int\r\n  declare @mesaj         varchar(300)\r\n  declare @vts           float\r\n  \r\n  if @aktip=1 /*vardiyaya aktarım */\r\n  begin\r\n   select @say=count(*) from veresimas as vs with (nolock) where varno>0\r\n   and vs.verid in (select * from CsvToInt(@veridin))\r\n\r\n         if @say>0\r\n           begin\r\n           SELECT @MESAJ = 'Seçmiş Olduğunuz Fişler İçinde Aktarılmış Fişler Var..!'\r\n           RAISERROR (@MESAJ, 16,1)\r\n           RETURN\r\n         end\r\n  \r\n  SET @yertip='pomvardimas'\r\n  select @yertipad=ad from yertipad where kod=@yertip\r\n  \r\n\r\n  update veresimas set yertip=@yertip,yerad=@yertipad,\r\n  varno=@varno,kayok=1\r\n  where verid in (select * from CsvToInt(@veridin))\r\n  \r\n  end\r\n  \r\n  if @aktip=0 /*havuza geri alım */\r\n  begin\r\n   select @say=count(*) from veresimas as vs where varok=1\r\n   and vs.verid in (select * from CsvToInt(@veridin))\r\n\r\n         if @say>0\r\n           begin\r\n           SELECT @MESAJ = 'Seçmiş Olduğunuz Fişler İçinde Kapatılmış Vardiyalar Var..!'\r\n           RAISERROR (@MESAJ, 16,1)\r\n           RETURN\r\n         end\r\n\r\n  SET @yertip='havuzislem'\r\n  select @yertipad=ad from yertipad where kod=@yertip\r\n\r\n\r\n\r\n\r\n\r\n  update veresimas set yertip=\r\n  case when vtsid>0 then 'vts_islem' else 'havuzislem' end,\r\n  yerad=case when vtsid>0 then\r\n  (select ad from yertipad where kod='vts_islem')\r\n  else (select ad from yertipad where kod='havuzislem') end,\r\n  varno=0,kayok=1\r\n  where \r\n  verid in (select * from CsvToInt(@veridin))\r\n  /*and varno=@varno */\r\n  end\r\n\r\n\r\n END"
  },
  {
    "schema": "dbo",
    "name": "havuzfisaktar_max",
    "definition": "CREATE PROCEDURE [dbo].[havuzfisaktar_max](\r\n@firmano int,\r\n@aktip    int,/*1 aktarım 0 geri al */\r\n@veridin  varchar(max),\r\n@varno  int)\r\nAS\r\n BEGIN\r\n\r\n \r\n  declare @yertip varchar(30)\r\n  declare @yertipad varchar(50)\r\n  declare @say           int\r\n  declare @mesaj         varchar(300)\r\n  declare @vts           float\r\n  \r\n  if @aktip=1 /*vardiyaya aktarım */\r\n  begin\r\n   select @say=count(*) from veresimas as vs with (nolock) where varno>0\r\n   and vs.verid in (select * from CsvToInt_Max(@veridin))\r\n\r\n         if @say>0\r\n           begin\r\n           SELECT @MESAJ = 'Seçmiş Olduğunuz Fişler İçinde Aktarılmış Fişler Var..!'\r\n           RAISERROR (@MESAJ, 16,1)\r\n           RETURN\r\n         end\r\n  \r\n  SET @yertip='pomvardimas'\r\n  select @yertipad=ad from yertipad where kod=@yertip\r\n  \r\n\r\n  update veresimas set yertip=@yertip,yerad=@yertipad,\r\n  varno=@varno,kayok=1\r\n  where verid in (select * from CsvToInt_Max(@veridin))\r\n  \r\n  end\r\n  \r\n  if @aktip=0 /*havuza geri alım */\r\n  begin\r\n   select @say=count(*) from veresimas as vs where varok=1\r\n   and vs.verid in (select * from CsvToInt_Max(@veridin))\r\n\r\n         if @say>0\r\n           begin\r\n           SELECT @MESAJ = 'Seçmiş Olduğunuz Fişler İçinde Kapatılmış Vardiyalar Var..!'\r\n           RAISERROR (@MESAJ, 16,1)\r\n           RETURN\r\n         end\r\n\r\n  SET @yertip='havuzislem'\r\n  select @yertipad=ad from yertipad where kod=@yertip\r\n\r\n\r\n\r\n\r\n\r\n  update veresimas set yertip=\r\n  case when vtsid>0 then 'vts_islem' else 'havuzislem' end,\r\n  yerad=case when vtsid>0 then\r\n  (select ad from yertipad where kod='vts_islem')\r\n  else (select ad from yertipad where kod='havuzislem') end,\r\n  varno=0,kayok=1\r\n  where \r\n  verid in (select * from CsvToInt_Max(@veridin))\r\n  /*and varno=@varno */\r\n  end\r\n\r\n\r\n END"
  },
  {
    "schema": "dbo",
    "name": "hrk_sil",
    "definition": "CREATE PROCEDURE [dbo].hrk_sil\r\n@tablead varchar(30),\r\n@hrkid int,\r\n@firmano int,\r\n@deguser varchar(50)\r\nAS\r\nBEGIN\r\ndeclare @masid int\r\ndeclare @karsihestip varchar(20)\r\ndeclare @degtarsaat datetime\r\ndeclare @cartip     varchar(20)\r\n\r\nset @degtarsaat=getdate()\r\n\r\n if @tablead='kasahrk'\r\n begin\r\n select @hrkid=kashrkid,@masid=masterid,@karsihestip=karsihestip,\r\n @cartip=cartip from kasahrk with (nolock)\r\n where kashrkid=@hrkid /*firmano=@firmano */\r\n update kasahrk set sil=1,deguser=@deguser,degtarsaat=@degtarsaat\r\n where kashrkid=@hrkid\r\n \r\n \r\n if isnull(@hrkid,0)>0\r\n  begin\r\n  \r\n   if @karsihestip='bankakart'\r\n   update bankahrk set sil=1,deguser=@deguser,degtarsaat=@degtarsaat\r\n   where bankhrkid=@masid\r\n \r\n   if @karsihestip='carikart'\r\n   update carihrk set sil=1,deguser=@deguser,degtarsaat=@degtarsaat\r\n   where carhrkid=@masid\r\n\r\n  if @cartip='istkart'\r\n  update istkhrk set sil=1,deguser=@deguser,degtarsaat=@degtarsaat\r\n  where masterid=@hrkid and karsihestip='kasakart'\r\n\r\n end\r\n\r\n\r\n end\r\n\r\n\r\n if @tablead='carihrk'\r\n begin\r\n select @hrkid=carhrkid,@masid=masterid,@karsihestip=karsihestip \r\n from carihrk with (nolock)  where carhrkid=@hrkid\r\n \r\n if isnull(@hrkid,0)>0\r\n  begin\r\n     update carihrk set sil=1,deguser=@deguser,degtarsaat=@degtarsaat\r\n     where carhrkid=@hrkid\r\n\r\n     if @karsihestip='bankakart'\r\n     update bankahrk set sil=1,deguser=@deguser,degtarsaat=@degtarsaat\r\n     where bankhrkid=@masid \r\n\r\n     if @karsihestip='kasakart'\r\n     update kasahrk set sil=1,deguser=@deguser,degtarsaat=@degtarsaat\r\n     where kashrkid=@masid \r\n  end\r\n end\r\n\r\n\r\n if @tablead='poshrk'\r\n begin\r\n    select @hrkid=poshrkid,@masid=masterid/*,@karsihestip=karsihestip */\r\n    from poshrk with (nolock)  where poshrkid=@hrkid\r\n\r\n end\r\n\r\n if @tablead='bankhrk'\r\n begin\r\n select @hrkid=bankhrkid,@masid=masterid,@karsihestip=karsihestip\r\n from bankahrk with (nolock) where bankhrkid=@hrkid\r\n end\r\n\r\n if @tablead='istkhrk'\r\n begin\r\n select @hrkid=istkhrkid,@masid=masterid,@karsihestip=karsihestip\r\n  from istkhrk  with (nolock) where istkhrkid=@hrkid\r\n\r\n end\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "ilolustur",
    "definition": "CREATE PROCEDURE [dbo].ilolustur\r\nAS\r\nBEGIN\r\n\r\n\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('01', 'ADANA', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('02', 'ADIYAMAN', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('03', 'AFYON', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('04', 'AĞRI', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('05', 'AMASYA', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('06', 'ANKARA', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('07', 'ANTALYA', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('08', 'ARTVİN', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('09', 'AYDIN', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('10', 'BALIKESİR', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('11', 'BİLECİK', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('12', 'BİNGÖL', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('13', 'BİTLİS', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('14', 'BOLU', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('15', 'BURDUR', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('16', 'BURSA', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('17', 'ÇANAKKALE', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('18', 'ÇANKIRI', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('19', 'ÇORUM', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('20', 'DENİZLİ', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('21', 'DİYARBAKIR', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('22', 'EDİRNE', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('23', 'ELAZIĞ', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('24', 'ERZİNCAN', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('25', 'ERZURUM', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('26', 'ESKİŞEHİR', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('27', 'GAZİANTEP', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('28', 'GİRESUN', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('29', 'GÜMÜŞHANE', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('30', 'HAKKARİ', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('31', 'HATAY', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('32', 'ISPARTA', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('33', 'İÇEL', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('34', 'İSTANBUL', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('35', 'İZMİR', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('36', 'KARS', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('37', 'KASTAMONU', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('38', 'KAYSERİ', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('39', 'KIRKLARELİ', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('40', 'KIRŞEHİR', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('41', 'KOCAELİ', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('42', 'KONYA', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('43', 'KÜTAHYA', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('44', 'MALATYA', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('45', 'MANİSA', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('46', 'KAHRAMANMARAŞ', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('47', 'MARDİN', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('48', 'MUĞLA', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('49', 'MUŞ', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('50', 'NEVŞEHİR', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('51', 'NİĞDE', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('52', 'ORDU', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('53', 'RİZE', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('54', 'SAKARYA', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('55', 'SAMSUN', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('56', 'SİİRT', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('57', 'SİNOP', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('58', 'SİVAS', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('59', 'TEKİRDAĞ', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('60', 'TOKAT', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('61', 'TRABZON', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('62', 'TUNCELİ', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('63', 'ŞANLIURFA', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('64', 'UŞAK', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('65', 'VAN', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('66', 'YOZGAT', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('67', 'ZONGULDAK', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('68', 'AKSARAY', 'SISTEM', GETDATE() );\r\nINSERT INTO il (kod, ad, olususer, olustarsaat )  VALUES  ('69', 'BAYBURT', 'SISTEM', GETDATE() );\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "irsaliye_Topyaz",
    "definition": "CREATE PROCEDURE [dbo].irsaliye_Topyaz (@Fatid float) \r\n AS\r\n BEGIN\r\n\r\n  declare @irid int\r\n  \r\n   select @irid=irid from irsaliyemas where akid=@Fatid \r\n  \r\n  \r\n   update irsaliyemas set \r\n   Genel_Net_Top=Kdvsiz_top+Kdv_top,\r\n   irtop=Kdvsiz_top,\r\n   Genel_Kdv_Top=Kdv_top,\r\n   genel_top=Kdvsiz_top+Kdv_top\r\n   from irsaliyemas as t join \r\n   (select round (sum(brmfiy*mik),2) as Kdvsiz_top,\r\n   round( sum((brmfiy*(1+kdvyuz)*mik)-(brmfiy*mik)),2 ) Kdv_top\r\n     From irsaliyehrk \r\n   where irid=@irid and sil=0 )\r\n   dt on t.irid=@irid\r\n   \r\n   update irsaliyemas set kayok=1 where irid=@irid\r\n\r\n  \r\n  END"
  },
  {
    "schema": "dbo",
    "name": "irsaliyeisle",
    "definition": "CREATE PROCEDURE [dbo].irsaliyeisle @fatid float\r\nAS\r\nBEGIN\r\ndeclare @kaptip varchar(30)\r\ndeclare @tarih  datetime\r\ndeclare @sql    nvarchar(500)\r\ndeclare @kayok  int\r\ndeclare @sil    int\r\n\r\n\r\ndeclare @cartip varchar(20)\r\ndeclare @carkod varchar(50)\r\n\r\nselect @kayok=kayok,@sil=sil,@tarih=tarih,\r\n@sql=kapidler,@kaptip=kaptip\r\nfrom faturamas where fatid=@fatid\r\n\r\n if @kaptip='IRS'\r\n  begin\r\n\r\n     if @kayok=1 and @sil=0\r\n      begin\r\n      update irsaliyemas set aktip='FT',aktar=@tarih,akid=@fatid where fatid=@fatid\r\n        \r\n        \r\n      update irsaliyehrk set \r\n       brmfiy=(dt.brmfiy+isnull(dt.otvbrim,0)),\r\n       Mik=dt.mik,\r\n       satiskyuz=dt.satiskyuz,\r\n       satisktut=dt.satisktut,\r\n       geniskyuz=dt.geniskyuz, \r\n       genisktut=dt.genisktut\r\n       from irsaliyehrk as t join \r\n       (select kaphrkid,brmfiy,otvbrim,mik,\r\n       satiskyuz,satisktut,geniskyuz,genisktut\r\n       from faturahrk as h with (nolock) where fatid=@fatid)\r\n       dt on dt.kaphrkid=t.id\r\n       \r\n       exec irsaliye_topyaz @fatid\r\n\r\n        \r\n      end  \r\n\r\n     if @sil=1\r\n     begin\r\n      select @cartip=cartip,@carkod=carkod from irsaliyemas where fatid=@fatid\r\n\r\n      update irsaliyemas set aktip='BK',aktar=NULL,akid=0,fatid=0 where fatid=@fatid\r\n            \r\n       \r\n    end\r\n  end\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "irsaliyeisle_sil",
    "definition": "CREATE PROCEDURE [dbo].irsaliyeisle_sil @fatid float\r\nAS\r\nBEGIN\r\n\r\n update irsaliyemas set aktip='BK',aktar=NULL,akid=0,fatid=0\r\n where fatid=@fatid\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "islemhrktipolustur",
    "definition": "CREATE PROCEDURE [dbo].islemhrktipolustur\r\nAS\r\nBEGIN\r\n\r\ntruncate table islemhrktip\r\n\r\n\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('ISL','KAC','KART AÇILIŞ','G');\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('ISL','DVR','DEVİR İŞLEMİ','G');\r\n\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('TAH','NAK','NAKİT TAHSİLAT','G');\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('TAH','TES','NAKİT TESLİMAT','G');\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('TAH','POS','KREDİ KARTI TAHSİL','G');\r\n\r\n\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('ODE','NAK','NAKİT ÖDEME','C');\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('ODE','PRU','PARA ÜSTÜ','C');\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('ODE','IKK','KREDİ KART İLE ÖDEME','C');\r\n\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('CEK','KSN','KESİLEN ÇEK','C');\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('CEK','ALN','ALINAN ÇEK','G');\r\n\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('CEK','CIR','CİROLALAN ÇEK','C');\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('CEK','TGR','TAKASTAN ALINAN ÇEK','G');\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('CEK','CGR','CİRODAN ALINAN ÇEK','G');\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('CEK','TKT','TAKAS ÇEKİ TAHSİL','G');\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('CEK','ELT','ELDEN ÇEK TAHSİL','G');\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('CEK','ODE','ÇEK ÖDEME','C');\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('CEK','PID','PORTFÖYDEN ÇEK İADE','C');\r\n\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('CEK','CKR','CİRODAN KAŞILIKSIZ ÇEK','C');\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('CEK','PKR','PORTFÖYDEN KAŞILIKSIZ ÇEK','C');\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('CEK','TKR','TAKASTAN KAŞILIKSIZ ÇEK','C');\r\n\r\n\r\n\r\n/*\r\nif (tip='TGR') then\r\nresult:='Geri Al - Takastan';\r\nif (tip='PKR') then\r\nresult:='Karşılıksız';\r\nif (tip='TKR') then\r\nresult:='Karşılıksız';\r\nif (tip='CKR') then\r\nresult:='Karşılıksız';\r\n*/\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('SEN','VER','VERİLEN SENET','C');\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('SEN','ALN','ALINAN SENET','G');\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('EMC','ALN','ALINAN E.M.Ç','G');\r\n\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('BNK','YTN','BANKAYA YATAN','C');\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('BNK','CKN','BANKADAN ÇEKİLEN','G');\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('BNK','B-C','GİDEN HAVALE / EFT','G');\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('BNK','C-B','GELEN HAVALE / EFT','C');\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('BNK','SLO','POS ÖDEME','G');\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('BNK','BKK','BANKA KOMİSYON','C');\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('BNK','EKK','EK KOMİSYON','C');\r\n\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('BNK','IKO','BANKA I.K.K ÖDEME','G');\r\n\r\n\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('GLG','MRF','ÇEK MASRAFI','C');\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('GLG','BMF','BANKA MASRAFI','C');\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('GLG','BKK','BANKA KOMİSYON','C');\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('GLG','EKK','EK KOMİSYON','C');\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('GLG','MAR','MARKET GİDERİ','C');\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('GLG','IND','İNDİRİM','C');\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('GLG','GID','GİDER','C');\r\n\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('GLG','FIR','FİRE KAYDI','C');\r\n\r\n\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('MAH','GIR','MAHSUP GİRİŞ','G');\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('MAH','CIK','MAHSUP ÇIKIŞ','C');\r\n\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('DVA','DAG','DÖVİZ (A-S) GİRİŞ','G')\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('DVA','DAC','DÖVİZ (A-S) ÇIKIŞ','C')\r\n\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('DVS','DAG','DÖVİZ (A-S) GİRİŞ','G')\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('DVS','DAC','DÖVİZ (A-S) ÇIKIŞ','C')\r\n\r\n\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('VIR','VRG','VİRMAN GİRİŞ','G');\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('VIR','VRC','VİRMAN ÇIKIŞ','C');\r\n\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('HAR','BOR','HARİCİ BORÇ','C');\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('HAR','ALC','HARİCİ ALACAK','G');\r\n\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('FIS','CAK','CARİ FİŞ AKTARIM','C');\r\n\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('FAT','GID','FATURA GİDER GİRİŞİ','C');\r\n\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('FAT','SHR','FATURA STOK GİRİŞİ','C');\r\n\r\n\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('VAR','ACK','VARDİYA AÇIK','C');\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('VAR','FAZ','VARDİYA FAZLA','G');\r\n\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('VAR','VTO','VARDİYA TAHSİLAT ÖDEME','-');\r\n\r\n\r\n\r\n\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('SAY','ACK','SAYIM AÇIK','C');\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('SAY','FAZ','SAYIM FAZLA','G');\r\n\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('MAS','AKT','MAAŞ AKTARIM','G');\r\n\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('VAD','CFK','CARİ VADE FARKI','G');\r\n\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('VAD','FVF','FİŞ VADE FARKI','G');\r\n\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('GLG','FYF','FİŞ YENİ FİYAT FARKI','G');\r\n\r\n\r\n\r\n/*----faturalar */\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('FAT','AKA','AKARYAKIT ALIŞ FATURASI','G');\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('FAT','MRA','MARKET ALIŞ FATURASI','G');\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('FAT','YGA','YAĞ ALIŞ FATURASI','G');\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('FAT','GGA','GELİR-GİDER ALIŞ FATURASI','G');\r\n\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('FAT','VRS','VERESİYE SATIŞ FATURASI','C');\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('FAT','TPS','TOPTAN SATIŞ FATURASI','C');\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('FAT','PRS','PERAKENDE SATIŞ FATURASI','C');\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('FAT','GGS','GELİR-GİDER SATIŞ FATURASI','C');\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('FAT','IAS','SATIŞTAN İADE FATURASI','C');\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('FAT','IAA','ALIŞTAN İADE FATURASI','C');\r\n\r\n/*----irsaliye */\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('IRS','AKA','AKARYAKIT ALIŞ İRSALİYESİ','G');\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('IRS','MRA','MARKET ALIŞ İRSALİYESİ','G');\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('IRS','YGA','YAĞ ALIŞ İRSALİYESİ','G');\r\n\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('IRS','AKS','AKARYAKIT SATIŞ İRSALİYESİ','C');\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('IRS','MRS','MARKET SATIŞ İRSALİYESİ','C');\r\ninsert into islemhrktip (tip,hrk,ad,gc) values ('IRS','YGS','YAĞ SATIŞ İRSALİYESİ','C');\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "islemturtipolustur",
    "definition": "CREATE PROCEDURE [dbo].islemturtipolustur\r\nAS\r\nBEGIN\r\n\r\ntruncate table islemturtip\r\n\r\ninsert into islemturtip (tip,ad) values ('ISL','İŞLEM');\r\ninsert into islemturtip (tip,ad) values ('TAH','TAHSİLAT');\r\ninsert into islemturtip (tip,ad) values ('ODE','ÖDEME');\r\ninsert into islemturtip (tip,ad) values ('CEK','ÇEK');\r\ninsert into islemturtip (tip,ad) values ('SEN','SENET');\r\ninsert into islemturtip (tip,ad) values ('EMC','E.M.Ç');\r\ninsert into islemturtip (tip,ad) values ('BNK','BANKA');\r\ninsert into islemturtip (tip,ad) values ('GLG','GELİR-GİDER');\r\ninsert into islemturtip (tip,ad) values ('MAH','MAHSUP');\r\ninsert into islemturtip (tip,ad) values ('DVA','DÖVİZ ALIŞ');\r\ninsert into islemturtip (tip,ad) values ('DVS','DÖVİZ SATIŞ');\r\ninsert into islemturtip (tip,ad) values ('VIR','VİRMAN');\r\ninsert into islemturtip (tip,ad) values ('HAR','HARİCİ');\r\ninsert into islemturtip (tip,ad) values ('FIS','FİŞ');\r\ninsert into islemturtip (tip,ad) values ('VAR','VARDİYA');\r\n\r\ninsert into islemturtip (tip,ad) values ('FAT','FATURA');\r\ninsert into islemturtip (tip,ad) values ('IRS','İRSALİYESİ');\r\n\r\ninsert into islemturtip (tip,ad) values ('SAY','SAYIM');\r\n\r\ninsert into islemturtip (tip,ad) values ('MAS','MAAŞ');\r\n\r\ninsert into islemturtip (tip,ad) values ('VAD','VADE');\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "istkarthrkgiris",
    "definition": "CREATE PROCEDURE [dbo].istkarthrkgiris @hrkid float,@sil int\r\nAS\r\nBEGIN\r\n\r\ndeclare @varno float\r\ndeclare @baktop float\r\ndeclare @newid float\r\ndeclare @gctip varchar(1)\r\ndeclare @borc float\r\ndeclare @alacak float\r\ndeclare @poskod varchar(20)\r\ndeclare @masid  float\r\n  \r\ndeclare @islmtip varchar(20)\r\ndeclare @islmhrk varchar(20)\r\ndeclare @cartip varchar(20)\r\ndeclare @istkhrkid float\r\ndeclare @Yan_Sil   bit\r\n\r\ndeclare @devir \t    bit\r\n\r\nselect @masid=masterid,@gctip=gctip,@istkhrkid=istkhrkid,\r\n@islmtip=islmtip,@islmhrk=islmhrk,\r\n@borc=borc,@alacak=alacak,@varno=varno,@cartip=cartip,\r\n@devir=devir\r\nfrom istkhrk where istkhrkid=@hrkid\r\n\r\n if @hrkid=0\r\n  RETURN\r\n\r\n if @devir=1\r\n  return\r\n\r\nif @sil=1\r\n begin\r\n/*-karsı hesap siliniyor */\r\n  if (@cartip='carikart') or (@cartip='perkart') or (@cartip='gelgidkart')\r\n    delete from carihrk where masterid=@istkhrkid and karsihestip='istkart'\r\n\r\n  if (@cartip='kasakart') \r\n   delete from kasahrk where kashrkid=@masid\r\n\r\n RETURN\r\nend\r\n\r\n\r\n \r\nif @cartip<>''\r\nbegin\r\n\r\n\r\nif (@cartip='carikart') or (@cartip='perkart') or (@cartip='gelgidkart')\r\nbegin\r\n  delete from carihrk where masterid=@istkhrkid and karsihestip='istkart'\r\n\r\n  select @newid=0\r\n  insert into carihrk (firmano,carhrkid,gctip,masterid,fisfattip,fisfatid,islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n  cartip,carkod,borc,alacak,bakiye,tarih,saat,olususer,olustarsaat,vadetar,belno,\r\n  ack,varno,kur,dataok,pro,varok,perkod,adaid,deguser,degtarsaat,sil,\r\n  karsihestip,karsiheskod,parabrm,\r\n  Karsi_Karttip,Karsi_KartKod) \r\n  select firmano,@newid,@gctip,@istkhrkid,fisfattip,fisfatid,islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n  cartip,carkod,@alacak,@borc,0,tarih,saat,olususer,olustarsaat,vadetar,belno,\r\n  ack,varno,kur,dataok,1,varok,perkod,adaid,deguser,degtarsaat,sil,\r\n  'istkart',istkkod,parabrm,\r\n  'istkart',istkkod\r\n  from istkhrk with (nolock)  where istkhrkid=@hrkid\r\n  \r\n  select @newid=SCOPE_IDENTITY()\r\n  update carihrk set carhrkid=@newid where id=@newid\r\n  \r\n  \r\n  \r\nEND\r\nend\r\n\r\n\r\n  \r\n  \r\nEND"
  },
  {
    "schema": "dbo",
    "name": "Kart_Sumalan",
    "definition": "CREATE PROCEDURE [dbo].Kart_Sumalan\r\nAS\r\nBEGIN\r\ndeclare @tabload varchar(30)\r\n\r\n truncate TABLE kartsumalan\r\n\r\n /*carikart */\r\n set @tabload='carikart'\r\n insert into kartsumalan (tabload,alanad) values (@tabload,'fisbak')\r\n insert into kartsumalan (tabload,alanad) values (@tabload,'carbak')\r\n insert into kartsumalan (tabload,alanad) values (@tabload,'fisadet')\r\n insert into kartsumalan (tabload,alanad) values (@tabload,'fisakadet')\r\n insert into kartsumalan (tabload,alanad) values (@tabload,'cekbak')\r\n insert into kartsumalan (tabload,alanad) values (@tabload,'fisaktut')\r\n insert into kartsumalan (tabload,alanad) values (@tabload,'actutar')\r\n insert into kartsumalan (tabload,alanad) values (@tabload,'sonhrktar')\r\n insert into kartsumalan (tabload,alanad) values (@tabload,'sonfistarih')\r\n insert into kartsumalan (tabload,alanad) values (@tabload,'sonfistutar')\r\n\r\n\r\n /*perkart */\r\n set @tabload='perkart'\r\n insert into kartsumalan (tabload,alanad) values (@tabload,'fisbak')\r\n insert into kartsumalan (tabload,alanad) values (@tabload,'carbak')\r\n insert into kartsumalan (tabload,alanad) values (@tabload,'fisadet')\r\n insert into kartsumalan (tabload,alanad) values (@tabload,'fisakadet')\r\n insert into kartsumalan (tabload,alanad) values (@tabload,'fisaktut')\r\n insert into kartsumalan (tabload,alanad) values (@tabload,'actutar')\r\n\r\n /*gelir gider kart */\r\n set @tabload='gelgidkart'\r\n insert into kartsumalan (tabload,alanad) values (@tabload,'fisbak')\r\n insert into kartsumalan (tabload,alanad) values (@tabload,'carbak')\r\n insert into kartsumalan (tabload,alanad) values (@tabload,'fisadet')\r\n insert into kartsumalan (tabload,alanad) values (@tabload,'fisakadet')\r\n insert into kartsumalan (tabload,alanad) values (@tabload,'fisaktut')\r\n insert into kartsumalan (tabload,alanad) values (@tabload,'actutar')\r\n\r\n /*bankakart */\r\n set @tabload='bankakart'\r\n insert into kartsumalan (tabload,alanad) values (@tabload,'borc')\r\n insert into kartsumalan (tabload,alanad) values (@tabload,'alacak')\r\n insert into kartsumalan (tabload,alanad) values (@tabload,'actutar')\r\n\r\n /*pos kart */\r\n set @tabload='poskart'\r\n insert into kartsumalan (tabload,alanad) values (@tabload,'bekbak')\r\n insert into kartsumalan (tabload,alanad) values (@tabload,'kombak')\r\n\r\n /*ist kredi kart */\r\n set @tabload='istkart'\r\n insert into kartsumalan (tabload,alanad) values (@tabload,'borc')\r\n insert into kartsumalan (tabload,alanad) values (@tabload,'alacak')\r\n insert into kartsumalan (tabload,alanad) values (@tabload,'actutar')\r\n\r\n\r\n /*perekandekart */\r\n set @tabload='perekandekart'\r\n insert into kartsumalan (tabload,alanad) values (@tabload,'fisbak')\r\n insert into kartsumalan (tabload,alanad) values (@tabload,'carbak')\r\n insert into kartsumalan (tabload,alanad) values (@tabload,'fisadet')\r\n\r\n\r\n  /*tank kart */\r\n set @tabload='tankkart'\r\n insert into kartsumalan (tabload,alanad) values (@tabload,'alsmik')\r\n insert into kartsumalan (tabload,alanad) values (@tabload,'satmik')\r\n insert into kartsumalan (tabload,alanad) values (@tabload,'acmik')\r\n insert into kartsumalan (tabload,alanad) values (@tabload,'alskdvlitoptut')\r\n insert into kartsumalan (tabload,alanad) values (@tabload,'satkdvlitoptut')\r\n\r\n\r\n  /*stok kart */\r\n set @tabload='stokkart'\r\n insert into kartsumalan (tabload,alanad) values (@tabload,'alsmik')\r\n insert into kartsumalan (tabload,alanad) values (@tabload,'satmik')\r\n insert into kartsumalan (tabload,alanad) values (@tabload,'acmik')\r\n insert into kartsumalan (tabload,alanad) values (@tabload,'alsiademik')\r\n insert into kartsumalan (tabload,alanad) values (@tabload,'alsiadekdvlitoptut')\r\n insert into kartsumalan (tabload,alanad) values (@tabload,'satiademik')\r\n insert into kartsumalan (tabload,alanad) values (@tabload,'satiadekdvlitoptut')\r\n\r\n\r\n /*sayackart kart */\r\n set @tabload='sayackart'\r\n insert into kartsumalan (tabload,alanad) values (@tabload,'sonendks')\r\n\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "kartac",
    "definition": "CREATE PROCEDURE [dbo].kartac @cartip varchar(20),@kod varchar(30),@ad varchar(100),\r\n@parabrm varchar(10),@gizli int\r\nAS\r\nBEGIN\r\n  declare @grp1 int\r\n\r\nif @cartip='gelgidkart'\r\n begin\r\n\r\n    select @grp1=grp_giderid from sistemtanim \r\n    insert into gelgidkart (grp1,grp2,grp3,kod,ad,muhkod,fiyat,actutar,toplim,kdv,kdvtip,\r\n    brim,parabrm,drm,olususer,olustarsaat,gizli)\r\n    values (@grp1,0,0,@kod,@ad,'',0,0,0,0,'Dahil','AD',@parabrm,\r\n    'Aktif','SİSTEM',getdate(),@gizli)\r\n  \r\n end\r\n\r\n  \r\nEND"
  },
  {
    "schema": "dbo",
    "name": "Karttipolustur",
    "definition": "CREATE PROCEDURE [dbo].Karttipolustur\r\nAS\r\nBEGIN\r\n TRUNCATE table karttip\r\n\r\n  insert into karttip (kod,ad) values\r\n  ('carikart','CARİ KARLAR')\r\n  \r\n  insert into karttip (kod,ad) values\r\n  ('perkart','PERSONEL KARTLAR')\r\n\r\n  insert into karttip (kod,ad) values\r\n  ('gelgidkart','GELİR-GİDER KARTLARI')\r\n\r\n  insert into karttip (kod,ad) values\r\n  ('bankakart','BANKA KARTLARI')\r\n\r\n  insert into karttip (kod,ad) values\r\n  ('poskart','POS KARTLARI')\r\n\r\n  insert into karttip (kod,ad) values\r\n  ('istkart','İŞLETME K. KARTLARI')\r\n  \r\n  \r\n  insert into karttip (kod,ad) values\r\n  ('kasakart','KASA KARTLARI')\r\n  \r\n  \r\n  insert into karttip (kod,ad) values\r\n  ('perakendekart','PERAKENDE KARTLAR')\r\n  \r\n   insert into karttip (kod,ad) values\r\n  ('otomaskart','OTOMASYON KARTLARI')\r\n\r\n\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "kasahrkgiris",
    "definition": "CREATE PROCEDURE [dbo].kasahrkgiris @hrkid float,@sil int\r\nAS\r\nBEGIN\r\n\r\ndeclare @varno \t\tfloat\r\ndeclare @baktop \tfloat\r\ndeclare @newid \t\tfloat\r\ndeclare @masterid \tfloat\r\ndeclare @gctip \t\tvarchar(1)\r\ndeclare @giren \t\tfloat\r\ndeclare @cikan \t\tfloat\r\ndeclare @yertip \tvarchar(30)\r\ndeclare @fisfattip  varchar(30)\r\n  \r\ndeclare @islmtip \tvarchar(20)\r\ndeclare @islmhrk \tvarchar(20)\r\ndeclare @cartip \tvarchar(20)\r\ndeclare @kashrkid \tfloat\r\n\r\n  if @hrkid=0\r\n   return\r\n\r\n/*------- siliniyor */\r\nif @sil=1\r\nbegin\r\n\r\n if (select count(*) from carihrk with (nolock)\r\n where masterid=@hrkid and karsihestip='kasakart' )>0\r\n delete from carihrk where masterid=@hrkid and karsihestip='kasakart'\r\n\r\n if (select count(*) from kasahrk with (nolock)\r\n where masterid=@hrkid and karsihestip='kasakart' )>0\r\n  delete from kasahrk  where masterid=@hrkid and karsihestip='kasakart'\r\n\r\n if (select count(*) from istkhrk with (nolock)\r\n where masterid=@hrkid and karsihestip='kasakart' )>0\r\n  delete from istkhrk where masterid=@hrkid and karsihestip='kasakart'\r\n\r\n\r\ndelete from TahsilatOdeme where id=\r\n   (select top 1 tahodeid from kasahrk where kashrkid=@hrkid  )\r\n\r\n\r\nRETURN\r\nend\r\n/*------- siliniyor */\r\n\r\n\r\n/*------- bilgi giriliyor */\r\nif @sil=0\r\nbegin\r\n\r\n  select @gctip=gctip,@kashrkid=kashrkid,@islmtip=islmtip,@islmhrk=islmhrk,\r\n  @masterid=masterid,@giren=giren,@cikan=cikan,@varno=varno,@cartip=cartip,\r\n  @yertip=yertip,@fisfattip=fisfattip from kasahrk with (nolock)\r\n  where kashrkid=@hrkid \r\n\r\n/*if @fisfattip='FIS' RETURN */\r\n\r\nif (@islmhrk<>'TES') \r\n begin\r\n\r\nif (@cartip='carikart') or (@cartip='perkart') or (@cartip='gelgidkart')\r\nor (@cartip='rehberkart')\r\n begin\r\n\r\n  delete from carihrk where masterid=@kashrkid and karsihestip='kasakart'\r\n\r\n  update istkhrk set sil=1,cartip='X' \r\n  where masterid=@kashrkid and karsihestip='kasakart'\r\n\r\n\r\n    if @gctip='G'\r\n    SET @gctip='A'\r\n    if @gctip='C'\r\n    SET @gctip='B'\r\n\r\n\r\n  \r\n  SELECT @newid=0 \r\n  insert into carihrk (firmano,carhrkid,gctip,masterid,fisfattip,fisfatid,\r\n  islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n  cartip,carkod,borc,alacak,bakiye,tarih,saat,olususer,olustarsaat,vadetar,belno,\r\n  ack,varno,kur,dataok,pro,varok,perkod,adaid,deguser,degtarsaat,sil,\r\n  karsihestip,karsiheskod,parabrm,\r\n  Karsi_Karttip,Karsi_KartKod,CariAvans)\r\n  select firmano,@newid,@gctip,@kashrkid,fisfattip,fisfatid,islmtip,islmtipad,\r\n  islmhrk,islmhrkad,yertip,yerad,\r\n  cartip,carkod,@cikan*kur,@giren*kur,0,tarih,saat,olususer,olustarsaat,vadetar,\r\n  belno,ack,varno,kur,dataok,1,varok,perkod,adaid,deguser,degtarsaat,sil,\r\n  'kasakart',kaskod,parabrm,\r\n  'kasakart',kaskod,CariAvans \r\n  from kasahrk with (nolock) where kashrkid=@hrkid\r\n  select @newid=SCOPE_IDENTITY()\r\n  update carihrk set carhrkid=@newid where id=@newid  \r\n \r\n  END\r\n\r\n\r\nif (@cartip='istkart')\r\n begin\r\n\r\n     set @gctip='G'\r\n\r\n      delete from carihrk where masterid=@kashrkid and karsihestip='kasakart'\r\n      \r\n      /*update istkhrk set sil=1 where masterid=@kashrkid and karsihestip='kasakart' */\r\n      \r\n      /*delete istkhrk where masterid=@kashrkid and karsihestip='kasakart' */\r\n      \r\n      if (select count(*) from istkhrk with (nolock) where \r\n       masterid=@kashrkid and karsihestip='kasakart' and sil=0 )=0\r\n       begin\r\n        SELECT @newid=0\r\n        insert into istkhrk (firmano,istkkod,istkhrkid,gctip,masterid,fisfattip,\r\n        fisfatid,islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n        cartip,carkod,borc,alacak,tarih,saat,olususer,olustarsaat,vadetar,belno,\r\n        ack,varno,kur,dataok,varok,perkod,adaid,deguser,degtarsaat,sil,\r\n        karsihestip,karsiheskod,parabrm,\r\n        Karsi_Karttip,Karsi_KartKod)\r\n        select firmano,carkod,@newid,@gctip,@kashrkid,fisfattip,fisfatid,islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n        'kasakart',kaskod,@cikan*kur,@giren*kur,tarih,saat,olususer,olustarsaat,\r\n        vadetar,belno,\r\n        ack,varno,kur,dataok,varok,perkod,adaid,deguser,degtarsaat,sil,\r\n        'kasakart',kaskod,parabrm,\r\n        'kasakart',kaskod\r\n         from kasahrk with (nolock) where kashrkid=@hrkid\r\n         select @newid=SCOPE_IDENTITY()\r\n         update carihrk set carhrkid=@newid where id=@newid  \r\n         \r\n      end\r\n       else\r\n        begin\r\n        update istkhrk set\r\n        firmano=dt.firmano, \r\n        istkkod=dt.carkod,\r\n        gctip=@gctip,masterid=@kashrkid,\r\n        fisfattip=dt.fisfattip,fisfatid=dt.fisfatid,\r\n        islmtip=dt.islmtip,islmtipad=dt.islmtipad,\r\n        islmhrk=dt.islmhrk,islmhrkad=dt.islmhrkad,\r\n        yertip=dt.yertip,yerad=dt.yerad,\r\n        cartip='kasakart',carkod=dt.kaskod,\r\n        borc=(@cikan*dt.kur),alacak=(@giren*dt.kur),\r\n        tarih=dt.tarih,saat=dt.saat,\r\n        olususer=dt.olususer,olustarsaat=dt.olustarsaat,\r\n        vadetar=dt.vadetar,belno=dt.belno,\r\n        ack=dt.ack,varno=dt.varno,kur=dt.kur,\r\n        dataok=dt.dataok,varok=dt.varok,\r\n        perkod=dt.perkod,adaid=dt.adaid,\r\n        deguser=dt.deguser,degtarsaat=dt.degtarsaat,\r\n        sil=dt.sil,karsihestip='kasakart',\r\n        karsiheskod=dt.kaskod,parabrm=dt.parabrm,\r\n        Karsi_Karttip='kasakart',\r\n        Karsi_KartKod=dt.kaskod\r\n        from istkhrk as t join\r\n        (select firmano,carkod,fisfattip,fisfatid,\r\n        islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n        kaskod,tarih,saat,olususer,olustarsaat,vadetar,belno,\r\n        ack,varno,kur,dataok,varok,perkod,adaid,deguser,degtarsaat,sil,\r\n        parabrm from kasahrk with (nolock) where kashrkid=@hrkid and sil=0 ) dt\r\n        on t.masterid=@kashrkid \r\n        and t.karsihestip='kasakart'\r\n       end\r\n\r\n  end\r\n\r\n end\r\nend\r\n \r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "KasaKapat",
    "definition": "CREATE PROCEDURE [dbo].[KasaKapat]\r\n@firmano      int,\r\n@kaskod\t\t  varchar(50),\r\n@bastar       datetime,\r\n@bittar       datetime,\r\n@drm          int,\r\n@user_Ad      varchar(100)\r\nAS\r\nBEGIN\r\n\r\n declare   @tar    datetime\r\n\r\n set @tar=@bastar\r\n \r\n  while @tar<=@bittar \r\n    begin\r\n    \r\n    if (select count(*) from Kasa_kapat where \r\n    firmano=@firmano and kaskod=@kaskod and Tarih=@tar and sil=0)=0 \r\n     insert into Kasa_kapat \r\n     (firmano,kaskod,tarih,drm,olususer,olustarsaat)\r\n     values (@firmano,@kaskod,@tar,@drm,@user_Ad,getdate())\r\n     else\r\n     update Kasa_kapat \r\n     set drm=@drm,\r\n     deguser=@user_Ad,\r\n     degtarsaat=getdate()\r\n     where firmano=@firmano and kaskod=@kaskod and Tarih=@tar\r\n     \r\n\r\n    set @tar=DATEADD(day,1,@tar)\r\n    \r\n    end\r\n   \r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "Market_BozukPara",
    "definition": "CREATE PROCEDURE [dbo].Market_BozukPara\r\n(\r\n@firmano  \tint,\r\n@varno \t\tint,\r\n@sil \t\tint)\r\nAS\r\nBEGIN\r\n\r\n\r\ndeclare @islmtip  \tvarchar(50)\r\ndeclare @islmtipad  varchar(50)\r\ndeclare @islmhrk  \tvarchar(50)\r\ndeclare @islmhrkad  varchar(50)\r\ndeclare @gctip  \tvarchar(50)\r\ndeclare @newid  \tint\r\n\r\n\r\ndeclare @yertip  \tvarchar(50)\r\ndeclare @yertipkad  varchar(50)\r\n\r\n\r\n    set @islmtip='VAR'\r\n    set @islmhrk='BPC'\r\n    set @gctip='C'\r\n    set @yertip='marvardimas'\r\n    \r\n   if exists (select id from kasahrk with (nolock)\r\n    Where marbozukpara_id=@varno) and @sil=1\r\n     update kasahrk set sil=1  where  marbozukpara_id=@varno \r\n\r\n\r\n   if @sil=0\r\n    begin \r\n\r\n\r\n    select @islmtipad=ad from islemturtip where tip=@islmtip \r\n    select @islmhrkad=ad from islemhrktip where tip=@islmtip and hrk=@islmhrk\r\n    select @yertipkad=ad from yertipad where kod=@yertip\r\n\r\n  \r\n   if exists (select id from kasahrk with (nolock) Where marbozukpara_id=@varno)\r\n      update kasahrk set sil=@sil,cikan=dt.bozukpara,\r\n      kaskod=dt.kas_kod from kasahrk as t \r\n      join (select kas_kod,varno,bozukpara from marvardimas with (NOLOCK) where \r\n       firmano=@firmano and varno=@varno and sil=0  )\r\n       dt on t.marbozukpara_id=@varno \r\n    else\r\n    begin\r\n    select @newid=0\r\n    insert into kasahrk (firmano,kaskod,kashrkid,gctip,varno,\r\n    masterid,islmtip,islmtipad,islmhrk,islmhrkad,yertip,\r\n    yerad,perkod,adaid,giren,cikan,bakiye,cartip,carkod,tarih,saat,\r\n    belno,ack,kur,varok,sil,olususer,\r\n    olustarsaat,deguser,degtarsaat,dataok,parabrm,\r\n    karsihestip,karsiheskod,marbozukpara_id)\r\n    select firmano,kas_kod,@newid,@gctip,0,0,\r\n    @islmtip,@islmtipad,\r\n    @islmhrk,@islmhrkad,@yertip,\r\n    @yertipkad,'Diger',0,0,bozukpara,0,'vardikasa','VRDKASA',\r\n    tarih,saat,cast(varno as varchar(50)),varad,\r\n    kur,varok,sil,olususer,\r\n    olustarsaat,deguser,degtarsaat,\r\n    dataok,parabrm,'','',varno \r\n    from marvardimas with (NOLOCK) where \r\n    firmano=@firmano and varno=@varno\r\n     and sil=0 and kas_kod<>'' and bozukpara>0\r\n     \r\n     select @newid=SCOPE_IDENTITY()\r\n     update kasahrk set kashrkid=@newid where id=@newid\r\n     \r\n     \r\n   end\r\n \r\n   end\r\n\r\n\r\n\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "Market_SatHrk_Stk_isle",
    "definition": "CREATE PROCEDURE [dbo].Market_SatHrk_Stk_isle (\r\n@marsatid float,@kayok int,@sil int)\r\nAS\r\nBEGIN\r\n\r\ndeclare @islmtip varchar(20)\r\ndeclare @islmtipad varchar(30)\r\ndeclare @islmtip1 varchar(20);\r\ndeclare @islmtipad1 varchar(30);\r\ndeclare @tabload   varchar(20)\r\n\r\n/*market satıs stok isle */\r\n  if @sil=0 and @kayok=1\r\n   begin\r\n   set @tabload='marsathrk'\r\n   \r\n   delete from stkhrk where tabload=@tabload\r\n   and stkhrkid in (select id from marsathrk as mh where\r\n   mh.marsatid=@marsatid and mh.kayok=1)\r\n   \r\n   select @islmtip=kod,@islmtipad=ad from stkhrktip where kod='MARSAT'\r\n   select @islmtip1=kod,@islmtipad1=ad from stkhrktip where kod='MARIAD'\r\n\r\n   insert stkhrk (stkhrkid,stkod,tarih,saat,stktip,stktipad,olustarsaat,olususer,islmtip,islmtipad,\r\n   yertip,yerad,giren,cikan,siademik,depkod,brmfiykdvli,kdvyuz,tabload,belno)\r\n   select mh.id,stkod,tarih,saat,stktip,stktipad,\r\n   mh.olustarsaat,mh.olususer,case when islmtip='iade' then\r\n   @islmtip1 else @islmtip end,\r\n   case when islmtip='iade' then @islmtipad1 else @islmtipad end,\r\n   yertip,yerad,case when islmtip='iade' then mik else 0 end,\r\n   case when islmtip='satis' then mik else 0 end,\r\n   case when islmtip='iade' then mik else 0 end,\r\n   depkod,brmfiy*kur,kdvyuz,@tabload,cast(marsatid as varchar)\r\n   from marsathrk  as mh where mh.marsatid=@marsatid and mh.kayok=1\r\n\r\n   end\r\n   \r\n   /*market satıs stok sil */\r\n   if @sil=1 and @kayok=1\r\n   begin\r\n   set @tabload='marsathrk'\r\n\r\n   delete from stkhrk where tabload=@tabload\r\n   and stkhrkid in (select id from marsathrk as mh where\r\n   mh.marsatid=@marsatid and mh.kayok=1)\r\n   end\r\n   \r\n\r\n   update stokkart set\r\n   alsmik=dt.giren,\r\n   alskdvlitoptut=dt.alistoptut,\r\n   satmik=dt.cikan,\r\n   satkdvlitoptut=dt.satistoptut,\r\n   alsiademik=dt.alsiade,\r\n   alsiadekdvlitoptut=dt.alsiadekdvtoptut,\r\n   satiademik=dt.satiade,\r\n   satiadekdvlitoptut=dt.satiadekdvtoptut\r\n   from stokkart as t\r\n   JOIN (select s.stktip,s.stkod,\r\n   isnull(sum(s.giren),0) as giren,\r\n   isnull(sum(s.giren*s.brmfiykdvli),0) alistoptut,\r\n   isnull(sum(s.cikan),0) as cikan,\r\n   isnull(sum(s.cikan*s.brmfiykdvli),0) as satistoptut,\r\n   /*-aide miktar */\r\n   isnull(sum(s.aiademik),0) as alsiade,\r\n   isnull(sum(s.aiademik*s.brmfiykdvli),0) alsiadekdvtoptut,\r\n   isnull(sum(s.siademik),0) as satiade,\r\n   isnull(sum(s.siademik*s.brmfiykdvli),0) as satiadekdvtoptut\r\n   from stkhrk as s inner join marsathrk as mh on\r\n   s.stktip=mh.stktip and s.stkod=mh.stkod and s.sil=0\r\n   and mh.marsatid=@marsatid and mh.kayok=1\r\n   group by s.stktip,s.stkod ) dt\r\n   on t.kod=dt.stkod and t.tip=dt.stktip\r\n \r\n  \r\nEND"
  },
  {
    "schema": "dbo",
    "name": "marketsatodesil",
    "definition": "CREATE PROCEDURE [dbo].marketsatodesil @marsatid float\r\nAS\r\nBEGIN\r\n\r\n\r\n  if isnull(@marsatid,0)=0 \r\n   return\r\n\r\n\r\n   update markasahrk set TransferStartId=isnull(TransferStartId,0)+1,sil=1 where marsatid=@marsatid\r\n   update poshrk set TransferStartId=isnull(TransferStartId,0)+1,sil=1   where marsatid=@marsatid\r\n   update veresimas set TransferStartId=isnull(TransferStartId,0)+1,sil=1 where marsatid=@marsatid\r\n   update carihrk set TransferStartId=isnull(TransferStartId,0)+1,sil=1  where marsatid=@marsatid \r\n   and  islmtip='GLG' and islmhrk='MAR'\r\n   \r\n   \r\n   update marsatmas set naktop=0,postop=0,veresitop=0,\r\n   yuvtop=0 where marsatid=@marsatid\r\n   \r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "MarSatRecHrkOlustur",
    "definition": "CREATE PROCEDURE dbo.MarSatRecHrkOlustur\r\n@MarSatId     int\r\nAS\r\nBEGIN\r\n  \r\n  /*update  */\r\n   update MarSatRecHrk Set sil=dt.sil,\r\n   TransferStartId=TransferStartId+1  \r\n    from MarSatRecHrk as t join \r\n    ( select h.id,h.sil\r\n    From Marsathrk as h with (nolock) \r\n    inner join Stok_Recete as r with (nolock) \r\n    on r.Urun_id=h.stk_id and r.sil=0\r\n    where h.marsatid=@MarSatId and isnull(h.Recete,0)=1\r\n    and h.id in (Select MarSatHrkId From MarSatRecHrk with (nolock) \r\n    where marsatid=@MarSatId ) ) dt \r\n    on dt.id=t.MarSatHrkId \r\n\r\n\r\n\r\n   /*insert Uretim Recete */\r\n   insert into MarSatRecHrk (MarSatId,MarSatHrkId,StokReceteId,\r\n   UretimTipId,UrunId,StokTipId,StokTip,StokId,StokKod,Miktar,\r\n   OlusturmaKullaniciUnvan,OlusturmaTarihSaat)\r\n   Select @MarSatId,h.id,r.id,\r\n   1,r.Urun_id,r.StkTip_id,k.tip,r.Stk_id,k.Kod,r.Miktar*h.mik,\r\n   h.OlusUser,h.OlusTarSaat\r\n   From Marsathrk as h with (nolock) \r\n   inner join Stok_Recete as r with (nolock) \r\n   on r.Urun_id=h.stk_id and r.sil=0 and H.sil=0\r\n   inner join Stokkart as k with (nolock) on k.id=r.Stk_id\r\n   where h.marsatid=@MarSatId and isnull(h.Recete,0)=1\r\n   and h.id not in (Select MarSatHrkId From MarSatRecHrk with (nolock) \r\n   where marsatid=@MarSatId and UretimTipId=1 )\r\n\r\n   \r\n   /*insert Uretim Urun */\r\n   insert into MarSatRecHrk (MarSatId,MarSatHrkId,StokReceteId,\r\n   UretimTipId,UrunId,StokTipId,StokTip,StokId,StokKod,Miktar,\r\n   OlusturmaKullaniciUnvan,OlusturmaTarihSaat)\r\n   Select @MarSatId,h.id,0,\r\n   2,h.Stk_id,h.StkTip_id,k.tip,h.Stk_id,k.Kod,h.mik,\r\n   h.OlusUser,h.OlusTarSaat\r\n   From Marsathrk as h with (nolock) \r\n   inner join Stokkart as k with (nolock) on k.id=h.Stk_id\r\n   where h.marsatid=@MarSatId and isnull(h.Recete,0)=1\r\n   and h.id not in (Select MarSatHrkId From MarSatRecHrk with (nolock) \r\n   where marsatid=@MarSatId and UretimTipId=2 )\r\n   \r\n   \r\n   \r\n   \r\n   \r\n   /*SELECT id FROM MarSatRecHrk as rh WHERE NOT EXISTS (SELECT id FROM MarSatRecHrk as mrs\r\n   WHERE rh.X = mrs.X  AND rh.Y = mrs.Y )\r\n   */\r\n   \r\n   \r\n   /*delete */\r\n   update MarSatRecHrk set Sil=1,TransferStartId=TransferStartId+1  \r\n   where MarSatId=@MarSatId \r\n   and MarSatHrkId not in (select h.id from Marsathrk h with (nolock)\r\n   inner join marsatmas as m  with (nolock)\r\n   on m.marsatid=h.marsatid  and isnull(h.Recete,0)=1 and  h.marsatid=@MarSatId)\r\n   \r\n   \r\n   \r\n  declare @MarSatHrkId    int\r\n  declare @MarSatRecId    int\r\n  declare @UrunId   int\r\n  declare @StokId   int\r\n  declare @Miktar    float\r\n  declare @StokIdAlisFiyat float\r\n  \r\n  declare @MarSatHrkRecToplam    float\r\n  declare @MarSatHrkToplam       float\r\n  \r\n   \r\n  declare pom_var CURSOR FAST_FORWARD  FOR \r\n  select id,h.Stk_id,((h.brmfiy*(1-h.indyuz))*h.kur)*h.mik  as BirimFiyat \r\n  from Marsathrk as h with (nolock)  where marsatid=@MarSatId and sil=0 \r\n  and isnull(Recete,0)=1\r\n   open pom_var\r\n  fetch next from  pom_var into @MarSatHrkId,@UrunId,@MarSatHrkToplam\r\n  while @@FETCH_STATUS=0\r\n   begin\r\n    set @MarSatHrkRecToplam=0\r\n   \r\n    /*Recete İcinde Urunleri Bul */\r\n    \r\n  declare rec_var CURSOR FAST_FORWARD  FOR \r\n   Select Id,StokId,Miktar From MarSatRecHrk with (nolock)  \r\n   Where MarSatHrkId=@MarSatHrkId and Sil=0 and UretimTipId=1\r\n   open rec_var\r\n  fetch next from  rec_var into @MarSatRecId,@StokId,@Miktar\r\n  while @@FETCH_STATUS=0\r\n   begin\r\n   \r\n   /*Recete İcindeki Urunun Alis Fiyatini Bul  */\r\n    Select @StokIdAlisFiyat=\r\n    case when alskdvtip='Dahil' then alsfiy \r\n    else alsfiy*(1+(alskdv/100)) end\r\n    From Stokkart with (NOLOCK) where id=@StokId\r\n       \r\n     update MarSatRecHrk Set BirimMaliyetFiyat=@StokIdAlisFiyat Where Id=@MarSatRecId\r\n   \r\n    set @MarSatHrkRecToplam=@MarSatHrkRecToplam+(@StokIdAlisFiyat*@Miktar)\r\n     \r\n   FETCH next from  rec_var into @MarSatRecId,@StokId,@Miktar\r\n  end\r\n close rec_var\r\n deallocate rec_var\r\n          \r\n  /*Satis Fiyatiyla Orantila    */\r\n\r\n   \r\n    update MarSatRecHrk Set BirimFiyat=BirimMaliyetFiyat*(@MarSatHrkToplam/\r\n    case when @MarSatHrkRecToplam>0 then @MarSatHrkRecToplam else 1.00 end )\r\n    Where MarSatHrkId=@MarSatHrkId\r\n  \r\n\r\n\r\n   FETCH next from  pom_var into @MarSatHrkId,@UrunId,@MarSatHrkToplam\r\n  end\r\n close Pom_Var\r\n deallocate pom_var\r\n   \r\n\r\n\r\n   \r\n   \r\n   \r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "marvarhrkvarmi",
    "definition": "CREATE PROCEDURE [dbo].marvarhrkvarmi @varno float,@artip varchar(50),@inx nvarchar(200)\r\nAS\r\nBEGIN\r\ndeclare @perkod varchar(50),@perad varchar(50);\r\ndeclare @say int;\r\n\r\nSET NOCOUNT ON\r\n\r\n\r\n/*set @inx = replace(@inx, '''', '''''' ) */\r\nif object_id( 'tempdb..#marickhrk' ) is null\r\ncreate table #marickhrk (kod varchar(30))\r\ntruncate table #marickhrk;\r\ninsert #ickhrk (kod) exec('select kod from perkart where kod in ('+@inx+')' );\r\n\r\nif object_id( 'tempdb..#marvarhrkvarmi' ) is null\r\nCREATE TABLE [dbo].[#marvarhrkvarmi] ([id] numeric(18, 0) IDENTITY(1, 1) NOT NULL,\r\nickad varchar(100),tablo varchar(30),kod varchar(50),ad varchar(50),tutar float,atper varchar(50) default '');\r\n\r\ntruncate table #marvarhrkvarmi;\r\n\r\n\r\nDECLARE marvarhrkvarmix CURSOR LOCAL FOR SELECT per,perad FROM marvardiper where varno=@varno\r\nand per in (select kod from #marickhrk)\r\n\r\n OPEN marvarhrkvarmix\r\n FETCH NEXT FROM marvarhrkvarmix INTO  @perkod,@perad\r\n WHILE @@FETCH_STATUS <> -1\r\n BEGIN\r\n/*\r\n insert into #marvarhrkvarmi (ickad,tablo,kod,ad,tutar)\r\n select 'Akaryakıt Sayaçlı Satış Tutarı','vardisayac',@perkod,@perad,isnull(sum(tutar),0) from vardisayac where varno=@varno\r\n and ipt=0 and perkod=@perkod;\r\n \r\n\r\n insert into #varhrkvarmi (ickad,tablo,kod,ad,tutar)\r\n select 'Veresiye Satış Tutarı','veresihrk',@perkod,@perad,isnull(sum(toptut),0) from veresimas\r\n where varno=@varno and ipt=0 and perkod=@perkod;\r\n\r\n\r\n insert into #varhrkvarmi (ickad,tablo,kod,ad,tutar)\r\n select 'Pos Satış Tutarı','possat',@perkod,@perad,isnull(sum(tutar),0) from possat\r\n where varno=@varno and ipt=0 and perkod=@perkod ;\r\n\r\n insert into #varhrkvarmi (ickad,tablo,kod,ad,tutar)\r\n select 'Yağ - Emtia Satış Tutarı','Emtiasat',@perkod,@perad,isnull(sum(tutar),0) from Emtiasat\r\n where varno=@varno and ipt=0 and perkod=@perkod;\r\n\r\n\r\n insert into #varhrkvarmi (ickad,tablo,kod,ad,tutar)\r\n select 'Nakit Teslimat Tutarı','nakitteslim',@perkod,@perad,isnull(sum(tutar*kur),0) from kasahrk\r\n where varno=@varno and ipt=0 and perkod=@perkod;\r\n\r\n insert into #varhrkvarmi (ickad,tablo,kod,ad,tutar)\r\n select 'Ödeme Tutarı','odeme',@perkod,@perad,isnull(sum(tutar*kur),0) from finans\r\n where varno=@varno and tip='Ödeme' and ipt=0 and perkod=@perkod\r\n\r\n\r\ninsert into #varhrkvarmi (ickad,tablo,kod,ad,tutar)\r\nselect 'Tahsilat Tutarı','tahilat',@perkod,@perad,isnull(sum(tutar*kur),0) from finans\r\nwhere varno=@varno and tip='Tahsilat' and ipt=0 and perkod=@perkod\r\n\r\ninsert into #varhrkvarmi (ickad,tablo,kod,ad,tutar)\r\nselect 'Mahsup Tutarı','mahsup',@perkod,@perad,isnull(sum(tutar*kur),0) from finans\r\nwhere varno=@varno and islmtur='Mahsup Giriş' and ipt=0 and perkod=@perkod\r\n\r\n\r\ninsert into #varhrkvarmi (ickad,tablo,kod,ad,tutar)\r\nselect 'Çek-Senet','cek-senet',@perkod,@perad,isnull(sum(tutar*kur),0) from finans where varno=@varno\r\nand tip='Çek-Senet' and ipt=0 and perkod=@perkod\r\n \r\ninsert into #varhrkvarmi (ickad,tablo,kod,ad,tutar)\r\nselect 'Banka İşlem','banka',@perkod,@perad,isnull(sum(tutar*kur),0) from finans where varno=@varno\r\nand tip='Banka' and ipt=0 and perkod=@perkod;\r\n\r\n*/\r\n  FETCH NEXT FROM marvarhrkvarmix INTO  @perkod,@perad\r\n  END\r\n  CLOSE marvarhrkvarmix\r\n  DEALLOCATE marvarhrkvarmix\r\n\r\n\r\nselect * from #marvarhrkvarmi where tutar>0\r\n\r\n\r\nSET NOCOUNT OFF\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "marvarkabul",
    "definition": "Create PROCEDURE [dbo].marvarkabul\r\n(@varno float,@varok int,@sil int)\r\nAS\r\nBEGIN\r\nSET NOCOUNT ON\r\n\r\n\r\n\r\ndeclare @say \t\t\t\t\tint\r\ndeclare @Firmano                int\r\ndeclare @varad \t\t\t\t\tvarchar(40)\r\ndeclare @yertip \t\t\t\tvarchar(30)\r\n\r\nset @yertip='marvardimas'\r\n\r\n/*----silme ve geri alma durumu icin */\r\nif (@sil=1) or (@varok=0)\r\nbegin\r\n delete from marvardiozet where varno=@varno\r\n\r\n/*-VARDIYA ACIK FAZLA İSLENMESI SILIMI */\r\n delete from carihrk where varno=@varno \r\n and yertip=@yertip and islmtip='VAR';\r\n\r\n\r\nRETURN\r\nend\r\n/*----silme ve geri alma durumu icin */\r\n\r\n delete from marvardiozet where varno=@varno\r\n\r\n/*kasa cari tahsilat karsi hesap kapatma */\r\n exec Vardiya_Kasa_Kapat @yertip,@varno\r\n\r\n/*--vardiya ozet tablosuna kapanis bilgilerini at */\r\n exec marvarozet @varno,'per','genel'\r\n  insert into marvardiozet (varno,varok,sil,tip,tipack,giris,cikis,bakiye,sr)\r\n   select @varno,@varok,@sil,ickkod,ickad,sum(grs),sum(cks),sum(grs-cks),sr\r\n    from ##marvardiozet where varno=@varno\r\n     group by ickkod,ickad,sr order by sr\r\n/*------------------------ */\r\n\r\n\r\n\r\n   declare @cartip varchar(20)\r\n   declare @carkod varchar(30)\r\n   \r\n   \r\n    select top 1 @cartip=cartip,@carkod=kod from marvardikap \r\n    with (nolock) where varno=@varno and sil=0\r\n    \r\n    delete from carihrk where varno=@varno and yertip=@yertip \r\n    and islmtip='VAR'\r\n    \r\n       \r\n   \r\n    /*personel carihrk */\r\n    \r\n    declare @KapTarih Datetime\r\n    declare @KapTarihSaat varchar(20)\r\n    declare @KapAcik      varchar(150)\r\n    \r\n    select @Firmano=Firmano,@KapTarih=kaptar,@KapTarihSaat=Kapsaat,@varad=varad from marvardimas with (nolock)\r\n    where varno=@Varno and Sil=0 \r\n    set @KapAcik='TARIH : '+CONVERT(varchar,@KapTarih, 104)+' # '+@varad+'. NOLU VARDIYA #'; \r\n\r\n     \r\n    INSERT INTO [carihrk] (firmano,carhrkid,gctip,\r\n    islmtip,islmtipad,\r\n    islmhrk,islmhrkad,\r\n    yertip,yerad,cartip,carkod,masterid,fisfattip,fisfatid,\r\n    varno,perkod,adaid,tarih,saat,\r\n    belno,ack,borc,alacak,kur,parabrm,olususer,olustarsaat,varok)\r\n    select @firmano,0,case when ackfaz='acik' then 'C' else 'G' end,\r\n    'VAR', N'VARDİYA', \r\n    case when ackfaz='acik' then 'ACK' else 'FAZ' end,\r\n    case when ackfaz='acik' then 'VARDİYA AÇIK' else 'VARDİYA FAZLA' end,\r\n    'marvardimas','MARKET VARDİYA', \r\n    cartip,kod,0,'KENDI',0,varno,'',0,@KapTarih,@KapTarihSaat,\r\n    varno,@KapAcik+case when ackfaz='acik' then ' HESAP AÇIĞI' else ' HESAP FAZLASI' end,\r\n    case when ackfaz='acik' then abs(tutar) else 0 end,\r\n    case when ackfaz='acik' then 0 else abs(tutar) end,\r\n    1,'TL',olususer,olustarsaat,@varok \r\n    from marvardikap with (nolock) where varno=@varno and sil=0 and ABS(tutar)>0\r\n    \r\n    update carihrk set carhrkid=id where carhrkid=0 and islmtip='VAR' and sil=0  \r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "marvarozet",
    "definition": "CREATE PROCEDURE [dbo].marvarozet @varno float,@tip varchar(10),@tipdty varchar(10)\r\nAS\r\nBEGIN\r\n\r\ndeclare @sql \t\tnvarchar(500)\r\ndeclare @acik \t\tfloat\r\ndeclare @fazla \t\tfloat\r\ndeclare @perkod \tvarchar(50)\r\ndeclare @perad \t\tvarchar(50)\r\ndeclare @yertip \tvarchar(20)\r\n\r\nset @yertip='marvardimas'\r\n\r\nSET NOCOUNT ON\r\n\r\nif object_id( 'tempdb..##marvardiozet' ) is null\r\nCREATE TABLE [dbo].[##marvardiozet] (\r\n  [id] numeric(18, 0) IDENTITY(1, 1) NOT NULL,\r\n  [varno] float NOT NULL,\r\n  [perkod] varchar(30) COLLATE Turkish_CI_AS NULL,\r\n  [perad] varchar(50) COLLATE Turkish_CI_AS NULL,\r\n  [ada] varchar(50) COLLATE Turkish_CI_AS NULL,\r\n  [grs] float  DEFAULT 0 NULL,\r\n  [cks] float DEFAULT 0 NULL,\r\n  [ickkod] varchar(30) COLLATE Turkish_CI_AS NULL,\r\n  [ickad] varchar(50) COLLATE Turkish_CI_AS NULL,\r\n  [sr] float NULL,\r\n  PRIMARY KEY  ([id], [varno]))\r\n  delete from ##marvardiozet where varno=@varno\r\n\r\n/*\r\nAKSAT\r\nVERAT\r\nVERBT\r\nVEROT\r\nPOSST\r\nMALST\r\nNAKTS\r\nODETT\r\nCAROD\r\nPEROD\r\nPRKOD\r\nTAHTT\r\nCARTH\r\nPERTH\r\nPRKTH\r\nGELIR\r\nGIDER\r\n\r\n*/\r\n\r\n\r\nDECLARE marvardiozetx CURSOR FAST_FORWARD FOR SELECT varno from marvardimas  WITH (NOLOCK) where varno=@varno\r\n  OPEN marvardiozetx\r\n  FETCH NEXT FROM marvardiozetx INTO  @varno\r\n   WHILE @@FETCH_STATUS = 0\r\n    BEGIN\r\n\r\n       insert into ##marvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\n       select @varno,'MRSAT','Market Satış - İade Tutarı',1,@perkod,@perad,\r\n       isnull(sum(case when h.islmtip='satis' then round(h.mik*(h.brmfiy)*h.kur,2) else 0 end),0),\r\n       isnull(sum(case when h.islmtip='iade' then round(h.mik*(h.brmfiy)*h.kur,2) else 0 end),0) \r\n       from marsathrk as h WITH (NOLOCK) inner join marsatmas as m  WITH (NOLOCK) on m.marsatid=h.marsatid\r\n       where m.varno=@varno and m.sil=0 and h.sil=0 \r\n\r\n      insert into ##marvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\n      select @varno,'BZPAR','Bozuk Para Tutarı',2.0,@perkod,@perad,isnull(sum(bozukpara),0),0 from \r\n      marvardimas WITH (NOLOCK)\r\n      where varno=@varno \r\n\r\n      insert into ##marvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\n      select @varno,'VERAT','Veresiye Alacak Tutarı',2.1,@perkod,@perad,isnull(sum(toptut-(fiyfarktop+vadfarktop)),0),0 \r\n      from veresimas WITH (NOLOCK)\r\n      where varno=@varno and fistip='FISALCSAT' and sil=0 and adaid=@perkod and ototag=0 and yertip=@yertip\r\n\r\n\r\n      insert into ##marvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\n      select @varno,'VERBT','Veresiye Borç Tutarı',2.2,@perkod,@perad,0,isnull(sum(toptut-(fiyfarktop+vadfarktop)),0) \r\n      from veresimas WITH (NOLOCK)\r\n      where varno=@varno and fistip='FISVERSAT' and sil=0 and ototag<>1 and yertip=@yertip\r\n\r\n\r\n\r\n      insert into ##marvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\n      select @varno,'POSST','Pos Satış Tutarı',3,@perkod,@perad,\r\n      isnull(sum(case when carslip=1 then giren*kur else 0 end),0),\r\n      isnull(sum(giren*kur),0) from poshrk WITH (NOLOCK)\r\n      where varno=@varno and sil=0 and ((yertip='marvardimas') or (yertip='yazarkasa')  or (yertip='promakscsv')  )\r\n\r\n      /*\r\n      update ##marvardiozet set grs=dt.giris from ##marvardiozet t join\r\n      (select isnull(sum(giren*kur),0) as giris from poshrk where\r\n      varno=@varno and carkod<>'' and sil=0 and yertip=@yertip)\r\n      dt on t.ickkod='POSST' and t.perkod=@perkod\r\n      */\r\n\r\n      insert into ##marvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\n      select @varno,'GIDER','Gider Tutarı',5,@perkod,@perad,0,isnull(sum(borc*kur),0) \r\n      from carihrk WITH (NOLOCK)\r\n      where varno=@varno and\r\n      ( (islmtip='ODE') OR (islmhrk='IND') and (islmtip='GLG') OR (islmhrk='MAR') ) and cartip='gelgidkart' and sil=0 and yertip=@yertip\r\n\r\n\r\n      if @tipdty='genel'\r\n      insert into ##marvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\n      select @varno,'ODETT','Ödeme Tutarı',6,@perkod,@perad,0,isnull(sum(cikan*kur),0) from kasahrk WITH (NOLOCK)\r\n      where varno=@varno and ((islmtip='ODE' and cartip<>'gelgidkart') or (islmtip='BNK' and islmhrk='YTN') )\r\n      and sil=0 and yertip=@yertip\r\n\r\n      if @tipdty='detay'\r\n      begin\r\n\r\n      insert into ##marvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\n      values (@varno,'ODETT','Ödeme Tutarı',6,@perkod,@perad,0,0)\r\n\r\n\r\n      insert into ##marvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\n      select @varno,'CAROD','Cari Ödemeler',8,@perkod,@perad,0,isnull(sum(cikan*kur),0) from kasahrk WITH (NOLOCK)\r\n      where varno=@varno and (islmtip='ODE' and cartip='carikart') and sil=0 and yertip=@yertip\r\n\r\n\r\n      insert into ##marvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\n      select @varno,'PEROD','Personel Ödemeler',10,@perkod,@perad,0,isnull(sum(cikan*kur),0) from kasahrk WITH (NOLOCK)\r\n      where varno=@varno and (islmtip='ODE' and cartip='perkart') and sil=0 and yertip=@yertip\r\n\r\n      end;\r\n\r\n\r\n      if @tipdty='genel'\r\n      begin\r\n      insert into ##marvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\n      select @varno,'TAHTT','Tahsilat Tutarı',7,@perkod,@perad,isnull(sum(giren*kur),0),0 from kasahrk WITH (NOLOCK)\r\n      where varno=@varno and ((islmtip='TAH' and islmhrk<>'TES' and cartip<>'gelgidkart') or (islmtip='BNK' and islmhrk='CKN') )\r\n      and sil=0 and yertip=@yertip\r\n      end;\r\n\r\n\r\n      if @tipdty='detay'\r\n      begin\r\n      insert into ##marvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\n      values (@varno,'TAHTT','Tahsilat Tutarı',7,@perkod,@perad,0,0);\r\n\r\n\r\n      insert into ##marvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\n      select @varno,'CARTH','Cari Tahsilat',9,@perkod,@perad,isnull(sum(giren*kur),0),0 from kasahrk WITH (NOLOCK)\r\n      where varno=@varno and (islmtip='TAH' and islmhrk<>'TES' and cartip='carikart')\r\n      and sil=0 and yertip=@yertip\r\n\r\n      insert into ##marvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\n      select @varno,'PERTH','Personel Tahsilat',11,@perkod,@perad,isnull(sum(giren*kur),0),0 from kasahrk WITH (NOLOCK)\r\n      where varno=@varno and (islmtip='TAH' and islmhrk<>'TES' and cartip='perkart') and sil=0  and yertip=@yertip\r\n\r\n\r\n      insert into ##marvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\n      select @varno,'PRKTH','Perakende Tahsilat',13,@perkod,@perad,isnull(sum(giren*kur),0),0 from kasahrk WITH (NOLOCK)\r\n      where varno=@varno and (islmtip='TAH' and islmhrk<>'TES' and cartip='perakendekart') and sil=0 and yertip=@yertip\r\n\r\n      end;\r\n\r\n\r\n\r\n      insert into ##marvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\n      select @varno,'GELIR','Gelir Tutarı',20,@perkod,@perad,isnull(sum(alacak*kur),0),0 from carihrk WITH (NOLOCK)\r\n      where varno=@varno and islmtip='TAH' and islmhrk<>'TES' and cartip='gelgidkart' and sil=0 and yertip=@yertip\r\n\r\n\r\n\r\n      insert into ##marvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\n      select @varno,'NAKTS','Nakit Teslimat Tutarı',21,@perkod,@perad,0,isnull(sum(giren*kur),0) from kasahrk WITH (NOLOCK)\r\n      where varno=@varno and sil=0 and yertip=@yertip and islmtip='TAH' AND islmhrk='TES' and masterid=0\r\n\r\n\r\n      if @tipdty='detay'\r\n      begin\r\n\r\n      insert into ##marvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\n      select @varno,'CEKST','Çek-Senet',25,@perkod,@perad,isnull(sum(giren*kur),0),isnull(sum(cikan*kur),0) from cekkart WITH (NOLOCK)\r\n      where varno=@varno and sil=0 and yertip=@yertip\r\n\r\n      insert into ##marvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\n      select @varno,'BNKCK','Banka Çekilen',26,@perkod,@perad,isnull(sum(giren*kur),0),0 from kasahrk WITH (NOLOCK)\r\n      where varno=@varno and islmtip='BNK' and islmhrk='CKN' and sil=0 and yertip=@yertip\r\n\r\n      insert into ##marvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\n      select @varno,'BNKYT','Banka Yatan',27,@perkod,@perad,0,isnull(sum(cikan*kur),0) from kasahrk WITH (NOLOCK)\r\n      where varno=@varno and islmtip='BNK' and islmhrk='YTN' and sil=0 and yertip=@yertip\r\n      \r\n      \r\n      \r\n      insert into ##marvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\n       select @varno,'BNKEF','Banka Gelen EFT',28,@perkod,@perad,0,isnull(sum(borc*kur),0) from bankahrk \r\n       with (nolock) where varno=@varno and islmtip='BNK' and islmhrk='C-B' and sil=0 and carkod='VRDHES'\r\n       and yertip=@yertip\r\n\r\n\r\n      insert into ##marvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\n       select @varno,'BNKEF','Banka Giden EFT',29,@perkod,@perad,isnull(sum(alacak*kur),0),0 from bankahrk \r\n       with (nolock) where varno=@varno and islmtip='BNK' and islmhrk='B-C' and sil=0 and carkod='VRDHES'\r\n       and yertip=@yertip\r\n      \r\n      \r\n      \r\n      end;\r\n      \r\n      \r\n      \r\n      if @tipdty='genel' /* diğer satışlar olusturuluyor */\r\n       begin\r\n\r\n        insert into ##marvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\n        select @varno,'DIGST','Diğer Tutarlar',39,@perkod,@perad,\r\n        isnull(sum(case when cartip<>'vardicek' then giren*kur else 0 end),0),\r\n        isnull(sum(giren*kur),0) from cekkart with (nolock)\r\n        where varno=@varno and sil=0 and yertip=@yertip\r\n       \r\n       \r\n        \r\n         UPDATE ##marvardiozet SET grs=grs+giren,cks=cks+cikan from ##marvardiozet as t join\r\n         (select isnull(sum(alacak*kur),0) as giren,isnull(sum(borc*kur),0) cikan from bankahrk with (nolock)\r\n          where varno=@varno and islmtip='BNK' and islmhrk in ('C-B','B-C') and sil=0 and carkod='VRDHES' \r\n          and yertip=@yertip ) dt on t.sr=39 \r\n\r\n      end\r\n\r\n      \r\n      \r\n      \r\n      \r\n\r\n\r\n      insert into ##marvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\n      select @varno,'aratp','Ara Toplam',40,@perkod,@perad,sum(grs),sum(cks) from ##marvardiozet where varno=@varno\r\n\r\n\r\n      select @acik=(grs-cks) from ##marvardiozet where ickkod='aratp' and varno=@varno\r\n\r\n      if @acik<0\r\n      begin\r\n      set @fazla=0;\r\n      set @acik=-@acik;\r\n      end\r\n      else\r\n      begin\r\n      set @fazla=@acik;\r\n      set @acik=0;\r\n      end;\r\n\r\n      insert into ##marvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\n      values(@varno,'ackfz','Fark',41,@perkod,@perad,@acik,@fazla) ;\r\n\r\n      select @acik=sum(grs),@fazla=sum(cks) from ##marvardiozet where (ickkod='aratp' or ickkod='ackfz') and varno=@varno \r\n\r\n\r\n      insert into ##marvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\n      values(@varno,'gentp','Genel Toplam',42,@perkod,@perad,@acik,@fazla) ;\r\n\r\n\r\n\r\n  FETCH NEXT FROM marvardiozetx INTO  @varno\r\n  END\r\n  CLOSE marvardiozetx\r\n  DEALLOCATE marvardiozetx\r\n\r\n\r\n\r\nSET NOCOUNT OFF\r\n\r\n/*select sr as id,varno,ickkod,ickad,sr,sum(grs) grs,sum(cks) cks from pomvardiozet */\r\n/*where varno=@varno group by varno,ickkod,ickad,sr order by sr */\r\n\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "Muh_Param_Olustur",
    "definition": "CREATE PROCEDURE [dbo].Muh_Param_Olustur(@firmano int)\r\nAS\r\nBEGIN\r\n\r\n TRUNCATE table entegre_muh_hes_kod\r\n\r\n\r\n\r\n insert into entegre_muh_hes_kod\r\n (firmano,tip,kod,ack,kdv_oran,deger,deguser,degtarsaat)\r\n values (@firmano,'als_kdv','alis_kdv_1','İNDİRİLECEK KDV %1',1,'191.01','SİSTEM',getdate())\r\n \r\n insert into entegre_muh_hes_kod\r\n (firmano,tip,kod,ack,kdv_oran,deger,deguser,degtarsaat)\r\n values (@firmano,'als_kdv','alis_kdv_8','İNDİRİLECEK KDV %8',8,'191.02','SİSTEM',getdate())\r\n \r\n insert into entegre_muh_hes_kod\r\n (firmano,tip,kod,ack,kdv_oran,deger,deguser,degtarsaat)\r\n values (@firmano,'als_kdv','alis_kdv_18','İNDİRİLECEK KDV %18',18,'191.03','SİSTEM',getdate())\r\n \r\n insert into entegre_muh_hes_kod\r\n (firmano,tip,kod,ack,kdv_oran,deger,deguser,degtarsaat)\r\n values (@firmano,'als_kdv','alis_kdv_26','İNDİRİLECEK KDV %26',26,'191.04','SİSTEM',getdate())\r\n \r\n \r\n insert into entegre_muh_hes_kod\r\n (firmano,tip,kod,ack,kdv_oran,deger,deguser,degtarsaat)\r\n values (@firmano,'sat_kdv','satis_kdv_1','HESAPLANAN KDV %1',1,'391.01','SİSTEM',getdate())\r\n\r\n insert into entegre_muh_hes_kod\r\n (firmano,tip,kod,ack,kdv_oran,deger,deguser,degtarsaat)\r\n values (@firmano,'sat_kdv','satis_kdv_8','HESAPLANAN KDV %8',8,'391.02','SİSTEM',getdate())\r\n\r\n insert into entegre_muh_hes_kod\r\n (firmano,tip,kod,ack,kdv_oran,deger,deguser,degtarsaat)\r\n values (@firmano,'sat_kdv','satis_kdv_18','HESAPLANAN KDV %18',18,'391.03','SİSTEM',getdate())\r\n\r\n insert into entegre_muh_hes_kod\r\n (firmano,tip,kod,ack,kdv_oran,deger,deguser,degtarsaat)\r\n values (@firmano,'sat_kdv','satis_kdv_26','HESAPLANAN KDV %26',26,'391.04','SİSTEM',getdate())\r\n \r\n/* */\r\n insert into entegre_muh_hes_kod\r\n (firmano,tip,kod,ack,kdv_oran,deger,deguser,degtarsaat)\r\n values (@firmano,'alsia_kdv','alis_iade_kdv_1','ALIŞ İADE KDV %1',1,'391.05','SİSTEM',getdate())\r\n \r\n insert into entegre_muh_hes_kod\r\n (firmano,tip,kod,ack,kdv_oran,deger,deguser,degtarsaat)\r\n values (@firmano,'alsia_kdv','alis_iade_kdv_8','ALIŞ İADE KDV %8',8,'391.06','SİSTEM',getdate())\r\n \r\n insert into entegre_muh_hes_kod\r\n (firmano,tip,kod,ack,kdv_oran,deger,deguser,degtarsaat)\r\n values (@firmano,'alsia_kdv','alis_iade_kdv_18','ALIŞ İADE KDV %18',18,'391.06','SİSTEM',getdate())\r\n \r\n insert into entegre_muh_hes_kod\r\n (firmano,tip,kod,ack,kdv_oran,deger,deguser,degtarsaat)\r\n values (@firmano,'alsia_kdv','alis_iade_kdv_26','ALIŞ İADE KDV %26',26,'391.07','SİSTEM',getdate())\r\n  \r\n  insert into entegre_muh_hes_kod\r\n (firmano,tip,kod,ack,kdv_oran,deger,deguser,degtarsaat)\r\n values (@firmano,'satia_kdv','satis_iade_kdv_1','SATIŞ İADE KDV %1',1,'191.05','SİSTEM',getdate())\r\n\r\n insert into entegre_muh_hes_kod\r\n (firmano,tip,kod,ack,kdv_oran,deger,deguser,degtarsaat)\r\n values (@firmano,'satia_kdv','satis_iade_kdv_8','SATIŞ İADE KDV %8',8,'191.06','SİSTEM',getdate())\r\n\r\n insert into entegre_muh_hes_kod\r\n (firmano,tip,kod,ack,kdv_oran,deger,deguser,degtarsaat)\r\n values (@firmano,'satia_kdv','satis_iade_kdv_18','SATIŞ İADE KDV %18',18,'191.07','SİSTEM',getdate())\r\n\r\n insert into entegre_muh_hes_kod\r\n (firmano,tip,kod,ack,kdv_oran,deger,deguser,degtarsaat)\r\n values (@firmano,'satia_kdv','satis_iade_kdv_26','SATIŞ İADE KDV %26',26,'191.08','SİSTEM',getdate())\r\n \r\n \r\n insert into entegre_muh_hes_kod\r\n (firmano,tip,kod,ack,kdv_oran,deger,deguser,degtarsaat)\r\n values (@firmano,'yuv_gelir','yuv_gelir','YUVARLAMA GELİR HESABI',0,'679.01','SİSTEM',getdate())\r\n\r\n insert into entegre_muh_hes_kod\r\n (firmano,tip,kod,ack,kdv_oran,deger,deguser,degtarsaat)\r\n values (@firmano,'yuv_gider','yuv_gider','YUVARLAMA GİDER HESABI',0,'689.01','SİSTEM',getdate())\r\n \r\n \r\n\r\n\r\n/*\r\nINSERT INTO [dbo].[entegre_muh_hes_kod] ([id], [firmano], [tip], [kod], [ack], [deger], [kdv_oran], [deguser], [degtarsaat], [parabrm], [olususer], [olustarsaat])\r\nVALUES \r\n  (1, 7, 'als_kdv', 'alis_kdv_1', 'İNDİRİLECEK KDV %1', '191.01', 1, 'SİSTEM YÖNETİCİSİ', '20090401 18:24:44.877', '', 'SİSTEM', '20090313 11:28:55.840')\r\nGO\r\n\r\nINSERT INTO [dbo].[entegre_muh_hes_kod] ([id], [firmano], [tip], [kod], [ack], [deger], [kdv_oran], [deguser], [degtarsaat], [parabrm], [olususer], [olustarsaat])\r\nVALUES \r\n  (2, 7, 'als_kdv', 'alis_kdv_8', 'İNDİRİLECEK KDV %8', '191.02', 8, 'SİSTEM YÖNETİCİSİ', '20090401 18:24:48.267', '', 'SİSTEM', '20090313 11:28:55.840')\r\nGO\r\n\r\nINSERT INTO [dbo].[entegre_muh_hes_kod] ([id], [firmano], [tip], [kod], [ack], [deger], [kdv_oran], [deguser], [degtarsaat], [parabrm], [olususer], [olustarsaat])\r\nVALUES \r\n  (3, 7, 'als_kdv', 'alis_kdv_18', 'İNDİRİLECEK KDV %18', '191.03', 18, 'SİSTEM YÖNETİCİSİ', '20090401 18:24:52.687', '', 'SİSTEM', '20090313 11:28:55.840')\r\nGO\r\n\r\nINSERT INTO [dbo].[entegre_muh_hes_kod] ([id], [firmano], [tip], [kod], [ack], [deger], [kdv_oran], [deguser], [degtarsaat], [parabrm], [olususer], [olustarsaat])\r\nVALUES \r\n  (4, 7, 'als_kdv', 'alis_kdv_26', 'İNDİRİLECEK KDV %26', '191.04', 26, 'SİSTEM YÖNETİCİSİ', '20090401 18:24:55.077', '', 'SİSTEM', '20090313 11:28:55.840')\r\nGO\r\n\r\nINSERT INTO [dbo].[entegre_muh_hes_kod] ([id], [firmano], [tip], [kod], [ack], [deger], [kdv_oran], [deguser], [degtarsaat], [parabrm], [olususer], [olustarsaat])\r\nVALUES \r\n  (5, 7, 'sat_kdv', 'satis_kdv_1', 'HESAPLANAN KDV %1', '391.01', 1, 'SİSTEM YÖNETİCİSİ', '20090401 18:24:56.420', '', 'SİSTEM', '20090313 11:28:55.840')\r\nGO\r\n\r\nINSERT INTO [dbo].[entegre_muh_hes_kod] ([id], [firmano], [tip], [kod], [ack], [deger], [kdv_oran], [deguser], [degtarsaat], [parabrm], [olususer], [olustarsaat])\r\nVALUES \r\n  (6, 7, 'sat_kdv', 'satis_kdv_8', 'HESAPLANAN KDV %8', '391.02', 8, 'SİSTEM YÖNETİCİSİ', '20090401 18:24:58.983', '', 'SİSTEM', '20090313 11:28:55.840')\r\nGO\r\n\r\nINSERT INTO [dbo].[entegre_muh_hes_kod] ([id], [firmano], [tip], [kod], [ack], [deger], [kdv_oran], [deguser], [degtarsaat], [parabrm], [olususer], [olustarsaat])\r\nVALUES \r\n  (7, 7, 'sat_kdv', 'satis_kdv_18', 'HESAPLANAN KDV %18', '391.03', 18, 'SİSTEM YÖNETİCİSİ', '20090401 18:25:02.170', '', 'SİSTEM', '20090313 11:28:55.840')\r\nGO\r\n\r\nINSERT INTO [dbo].[entegre_muh_hes_kod] ([id], [firmano], [tip], [kod], [ack], [deger], [kdv_oran], [deguser], [degtarsaat], [parabrm], [olususer], [olustarsaat])\r\nVALUES \r\n  (8, 7, 'sat_kdv', 'satis_kdv_26', 'HESAPLANAN KDV %26', '391.04', 26, 'SİSTEM YÖNETİCİSİ', '20090401 18:25:04.530', '', 'SİSTEM', '20090313 11:28:55.840')\r\nGO\r\n\r\nINSERT INTO [dbo].[entegre_muh_hes_kod] ([id], [firmano], [tip], [kod], [ack], [deger], [kdv_oran], [deguser], [degtarsaat], [parabrm], [olususer], [olustarsaat])\r\nVALUES \r\n  (11, 7, 'alsia_kdv', 'alis_iade_kdv_1', 'ALIŞ İADE KDV %1', '391.50', 1, 'SİSTEM YÖNETİCİSİ', '20090407 09:44:18.843', '', 'SİSTEM', '20090313 11:28:55')\r\nGO\r\n\r\nINSERT INTO [dbo].[entegre_muh_hes_kod] ([id], [firmano], [tip], [kod], [ack], [deger], [kdv_oran], [deguser], [degtarsaat], [parabrm], [olususer], [olustarsaat])\r\nVALUES \r\n  (12, 7, 'alsia_kdv', 'alis_iade_kdv_8', 'ALIŞ İADE KDV %8', '391.50', 8, 'SİSTEM YÖNETİCİSİ', '20090407 09:44:22.077', '', 'SİSTEM', '20090313 11:28:55')\r\nGO\r\n\r\nINSERT INTO [dbo].[entegre_muh_hes_kod] ([id], [firmano], [tip], [kod], [ack], [deger], [kdv_oran], [deguser], [degtarsaat], [parabrm], [olususer], [olustarsaat])\r\nVALUES \r\n  (13, 7, 'alsia_kdv', 'alis_iade_kdv_18', 'ALIŞ İADE KDV %18', '391.50', 18, 'SİSTEM YÖNETİCİSİ', '20090407 09:44:22.843', '', 'SİSTEM', '20090313 11:28:55')\r\nGO\r\n\r\nINSERT INTO [dbo].[entegre_muh_hes_kod] ([id], [firmano], [tip], [kod], [ack], [deger], [kdv_oran], [deguser], [degtarsaat], [parabrm], [olususer], [olustarsaat])\r\nVALUES \r\n  (14, 7, 'alsia_kdv', 'alis_iade_kdv_26', 'ALIŞ İADE KDV %26', '391.50', 26, 'SİSTEM YÖNETİCİSİ', '20090407 09:44:23.907', '', 'SİSTEM', '20090313 11:28:55')\r\nGO\r\n\r\nINSERT INTO [dbo].[entegre_muh_hes_kod] ([id], [firmano], [tip], [kod], [ack], [deger], [kdv_oran], [deguser], [degtarsaat], [parabrm], [olususer], [olustarsaat])\r\nVALUES \r\n  (15, 7, 'satia_kdv', 'satis_iade_kdv_1', 'SATIŞ İADE KDV %1', '191.50', 1, 'SİSTEM YÖNETİCİSİ', '20090407 09:44:01.610', '', 'SİSTEM', '20090313 11:28:55')\r\nGO\r\n\r\nINSERT INTO [dbo].[entegre_muh_hes_kod] ([id], [firmano], [tip], [kod], [ack], [deger], [kdv_oran], [deguser], [degtarsaat], [parabrm], [olususer], [olustarsaat])\r\nVALUES \r\n  (16, 7, 'satia_kdv', 'satis_iade_kdv_8', 'SATIŞ İADE KDV %8', '191.50', 8, 'SİSTEM YÖNETİCİSİ', '20090407 09:44:03.390', '', 'SİSTEM', '20090313 11:28:55')\r\nGO\r\n\r\nINSERT INTO [dbo].[entegre_muh_hes_kod] ([id], [firmano], [tip], [kod], [ack], [deger], [kdv_oran], [deguser], [degtarsaat], [parabrm], [olususer], [olustarsaat])\r\nVALUES \r\n  (17, 7, 'satia_kdv', 'satis_iade_kdv_18', 'SATIŞ İADE KDV %18', '191.50', 18, 'SİSTEM YÖNETİCİSİ', '20090407 09:44:05.110', '', 'SİSTEM', '20090313 11:28:55')\r\nGO\r\n\r\nINSERT INTO [dbo].[entegre_muh_hes_kod] ([id], [firmano], [tip], [kod], [ack], [deger], [kdv_oran], [deguser], [degtarsaat], [parabrm], [olususer], [olustarsaat])\r\nVALUES \r\n  (18, 7, 'satia_kdv', 'satis_iade_kdv_26', 'SATIŞ İADE KDV %26', '191.50', 26, 'SİSTEM YÖNETİCİSİ', '20090407 09:44:06.703', '', 'SİSTEM', '20090313 11:28:55')\r\nGO\r\n\r\nINSERT INTO [dbo].[entegre_muh_hes_kod] ([id], [firmano], [tip], [kod], [ack], [deger], [kdv_oran], [deguser], [degtarsaat], [parabrm], [olususer], [olustarsaat])\r\nVALUES \r\n  (19, 7, 'yuv_gelir', 'yuv_gelir', 'YUVARLAMA GELİR HESABI', '679.01', 0, 'SİSTEM YÖNETİCİSİ', '20090407 09:44:49.577', '', 'SİSTEM', '20090313 11:28:55')\r\nGO\r\n\r\nINSERT INTO [dbo].[entegre_muh_hes_kod] ([id], [firmano], [tip], [kod], [ack], [deger], [kdv_oran], [deguser], [degtarsaat], [parabrm], [olususer], [olustarsaat])\r\nVALUES \r\n  (20, 7, 'yuv_gider', 'yuv_gider', 'YUVARLAMA GİDER HESABI', '689.01', 0, 'SİSTEM YÖNETİCİSİ', '20090407 09:44:53.313', '', 'SİSTEM', '20090313 11:28:55')\r\nGO\r\n\r\n  */\r\n  \r\nEND"
  },
  {
    "schema": "dbo",
    "name": "numara_no_yaz",
    "definition": "CREATE PROCEDURE [dbo].numara_no_yaz (@tip VARCHAR(20),@DEGER VARCHAR(20))\r\nAS\r\nBEGIN\r\n  DECLARE @I INT\r\n  DECLARE @NUMARA FLOAT\r\n  DECLARE @SERI   VARCHAR(10)\r\n  DECLARE @UZUNLUK     INT\r\n\r\n  IF CHARINDEX (',',@DEGER)>0\r\n   RETURN\r\n\r\n  IF CHARINDEX (' ',@DEGER)>0\r\n   RETURN\r\n\r\n /* if LEN(@DEGER)>10 */\r\n  /*  RETURN */\r\n\r\n\r\n  SET @SERI = ''\r\n  SET @I    = 1\r\n\r\n  WHILE @I <= LEN(@DEGER)\r\n  BEGIN\r\n    IF ( (SELECT ISNUMERIC(SUBSTRING(@DEGER,@I,1))) = 0 )\r\n    BEGIN\r\n      SET @SERI = @SERI + ( SELECT SUBSTRING(@DEGER,@I,1) )\r\n    END\r\n    ELSE\r\n    BEGIN\r\n/*     PRINT RIGHT(@DEGER,LEN(@DEGER) - @I + 1) */\r\n      IF ISNUMERIC(RIGHT(@DEGER,LEN(@DEGER) - @I + 1))=1\r\n      AND RIGHT(@DEGER,LEN(@DEGER) -@I + 1)>'0'\r\n      BEGIN\r\n      SET @UZUNLUK=LEN(@DEGER) - @I + 1\r\n      SELECT @NUMARA = CAST(RIGHT(@DEGER,LEN(@DEGER) - @I + 1) AS FLOAT)\r\n      BREAK\r\n      END\r\n    END\r\n\r\n    SET @I = @I + 1\r\n  END\r\n\r\n  set @NUMARA=isnull(@NUMARA,0)\r\n\r\n  set @UZUNLUK=isnull(@UZUNLUK,5)\r\n\r\n  UPDATE numarator SET\r\n    seri = @SERI,\r\n    numara = @NUMARA,\r\n    uzunluk=@UZUNLUK\r\n  WHERE tip = @tip\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "numaratorolustur",
    "definition": "CREATE PROCEDURE [dbo].numaratorolustur\r\nAS\r\nBEGIN\r\n\r\nTRUNCATE TABLE numarator\r\n\r\ninsert into numarator   (seri,numara,tip,tipack,uzunluk) values\r\n('CR',0,'carikart','Cari Kartlar',5)\r\ninsert into numarator   (seri,numara,tip,tipack,uzunluk) values\r\n('PRS',0,'perkart','Personel Kartları',5)\r\ninsert into numarator   (seri,numara,tip,tipack,uzunluk) values\r\n('PRD',0,'perakendekart','Perakende Kartlar',5)\r\ninsert into numarator   (seri,numara,tip,tipack,uzunluk) values\r\n('BNK',0,'bankakart','Banka Kartları',5)\r\ninsert into numarator   (seri,numara,tip,tipack,uzunluk) values\r\n('MDP',0,'mardepkart','Market Depo Kartları',5)\r\ninsert into numarator   (seri,numara,tip,tipack,uzunluk) values\r\n('GDR',0,'gelirkart','Gelir Kartları',5)\r\ninsert into numarator   (seri,numara,tip,tipack,uzunluk) values\r\n('GLR',0,'giderkart','Gider Kartları',5)\r\ninsert into numarator   (seri,numara,tip,tipack,uzunluk) values\r\n('SYC',0,'sayackart','Sayaç Kartları',5)\r\ninsert into numarator   (seri,numara,tip,tipack,uzunluk) values\r\n('POS',0,'poskart','Pos Kartları',5)\r\ninsert into numarator   (seri,numara,tip,tipack,uzunluk) values\r\n('ISKR',0,'istkredikart','İşletme Kredi Kartları',5)\r\n\r\n\r\ninsert into numarator   (seri,numara,tip,tipack,uzunluk) values\r\n('TNK',0,'tankkart','Tank Kartları',5)\r\ninsert into numarator   (seri,numara,tip,tipack,uzunluk) values\r\n('MST',0,'marktstkkart','Market Stok Kartları',5)\r\ninsert into numarator   (seri,numara,tip,tipack,uzunluk) values\r\n('AST',0,'akyktstkkart','Akaryakıt Stok Kartları',5)\r\ninsert into numarator   (seri,numara,tip,tipack,uzunluk) values\r\n('A',0,'makbuz','MAKBUZ',5)\r\n\r\n\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "Oto_Tank_Durum",
    "definition": "CREATE PROCEDURE [dbo].Oto_Tank_Durum\r\nAS\r\nBEGIN\r\n  DECLARE @TB_TANK_ON_DURUM TABLE (\r\n  TK_ID        int,\r\n  TK_KOD       VARCHAR(20) COLLATE Turkish_CI_AS,\r\n  TK_AD        VARCHAR(40) COLLATE Turkish_CI_AS,\r\n  TK_KAPASITE  FLOAT,\r\n  TK_MEVCUT    FLOAT)\r\n  \r\n  declare @son_tarsaat datetime\r\n\r\n  SELECT top 1 @son_tarsaat=max(tarih+cast(saat as datetime))\r\n  FROM otomasoku\r\n\r\n  if @son_tarsaat is NULL\r\n  set @son_tarsaat=cast(YEAR(getdate()) as varchar)+'-01-01'\r\n\r\n  /* insert into @TB_TANK_ON_DURUM (TK_KOD) */\r\n  /* select kod from otomaspumptan where tip=1 --tank */\r\n\r\n   insert into @TB_TANK_ON_DURUM (TK_ID,TK_KOD,TK_AD,TK_KAPASITE,TK_MEVCUT)\r\n   select tk.id,tk.kod,tk.ad,kapsit,isnull(sum(h.giren-h.cikan),0) mevcut\r\n   from tankkart as tk\r\n   inner join otomaspumptan as tksec on tksec.tip=1 and tk.kod=tksec.kod\r\n   left join stkhrk as h on h.sil=0 and h.depkod=tk.kod\r\n   and h.tarih+cast(h.saat as datetime)<=@son_tarsaat\r\n   where tk.sil=0\r\n   group by tk.id,tk.kod,tk.ad,kapsit\r\n\r\n\r\n  /* select @son_tarsaat */\r\n\r\n  /*- ven son vardiyadan sonraki akaryakıt stok girişleri nerde? */\r\n  update @TB_TANK_ON_DURUM\r\n  set TK_MEVCUT=(TK_MEVCUT-dt.mevcut)\r\n  from @TB_TANK_ON_DURUM as t\r\n  join (select tank_kod,sum(litre) as mevcut from otomaspumphrk as h where\r\n  h.tarih+cast(h.saat as datetime)>@son_tarsaat\r\n  group by tank_kod ) dt\r\n  on t.TK_KOD=dt.tank_kod\r\n\r\n\r\n  select * from @TB_TANK_ON_DURUM\r\n  \r\n  \r\nEND"
  },
  {
    "schema": "dbo",
    "name": "Oto_vts_sonkayityaz",
    "definition": "CREATE PROCEDURE [dbo].Oto_vts_sonkayityaz(\r\n@firmano int,@otomasad varchar(50))\r\nAS\r\nBEGIN\r\n declare @sonsatir float\r\n declare @sontarih datetime\r\n declare @sondosya  varchar(30)\r\n  \r\n  select top 1 @sonsatir=otomasid,\r\n  @sondosya=dosya,\r\n  @sontarih=tarih from otomasonlineoku\r\n  where firmano=@firmano and otomasad=@otomasad\r\n  order by id desc\r\n\r\n  update oto_onl_param\r\n  set sonsatirno=@sonsatir,sontarih=@sontarih,\r\n  sondosya=@sondosya where\r\n  firmano=@firmano and otomasad=@otomasad\r\n  \r\n  \r\nEND"
  },
  {
    "schema": "dbo",
    "name": "otomasondosya",
    "definition": "CREATE PROCEDURE [dbo].otomasondosya @dosyad varchar(50),@tip varchar(30),@sil int\r\nAS\r\nBEGIN\r\n  \r\n  if @sil=0\r\n  insert into otomasdosya (dosya,otomastip) values (@dosyad,@tip)\r\n  if @sil=1\r\n  delete from otomasdosya where dosya=@dosyad and otomastip=@tip\r\n  \r\n  \r\nEND"
  },
  {
    "schema": "dbo",
    "name": "otomastipolustur",
    "definition": "CREATE PROCEDURE [dbo].otomastipolustur\r\nAS\r\nBEGIN\r\n\r\nTRUNCATE table otomastip\r\n\r\n insert into otomastip (ad,onli,dosyatip)\r\n  values ('Turpak ONL',1,'txt')\r\n  \r\n insert into otomastip (ad,onli,dosyatip)\r\n  values ('Turpak VRD',0,'txt')\r\n\r\n insert into otomastip (ad,onli,dosyatip)\r\n  values ('Turpak VRD.XML',0,'zip')\r\n\r\n insert into otomastip (ad,onli,dosyatip)\r\n  values ('Turpak Sale.XML',1,'xml')\r\n\r\n\r\n insert into otomastip (ad,onli,dosyatip)\r\n  values ('Asis ONL',1,'txt')\r\n  \r\n insert into otomastip (ad,onli,dosyatip)\r\n  values ('Asis VRD',0,'txt')\r\n  \r\n insert into otomastip (ad,onli,dosyatip)\r\n  values ('Roseman ONL',1,'txt')\r\n  \r\n insert into otomastip (ad,onli,dosyatip)\r\n  values ('Roseman VRD',0,'txt')\r\n\r\n insert into otomastip (ad,onli,dosyatip)\r\n  values ('IFS SQL',1,'sql')\r\n\r\n insert into otomastip (ad,onli,dosyatip)\r\n  values ('IT Tailor ONL',1,'txt')\r\n\r\n insert into otomastip (ad,onli,dosyatip)\r\n  values ('IT Tailor VRD',0,'txt')\r\n\r\n\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "Pda_offsayimisle",
    "definition": "CREATE PROCEDURE [dbo].Pda_offsayimisle\r\n@sayid           float,\r\n@offsayid        int,\r\n@tarih           datetime,\r\n@users           varchar(50)\r\nAS\r\nBEGIN\r\n\r\n\r\n\r\n update sayimhrk set sayimmik=sayimmik+dt.miktar,\r\n saydrm='S' from sayimhrk t join\r\n (select stk_kod,miktar from\r\n Pda_OffSayim_Hrk where offsayid=@offsayid  )\r\n as dt on t.stkod=dt.stk_kod\r\n and t.sayid=@sayid\r\n \r\n \r\n update Pda_OffSayim_Mas set\r\n       drm='OK',\r\n       aktarid=@sayid,\r\n       aktartarsaat=@tarih,\r\n       aktaruser=@users\r\n    where id=@offsayid\r\n    \r\n    \r\n    \r\n select stk_barkod as barkod,('YOK') as stokad,miktar\r\n from Pda_OffSayim_Hrk\r\n where offsayid=@offsayid and stk_kod not in\r\n (select stkod from sayimhrk where sayid=@sayid)\r\n\r\n\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "personelmaas",
    "definition": "CREATE PROCEDURE [dbo].personelmaas (@masid float,@sil int)\r\nAS\r\nBEGIN\r\n  \r\ndeclare @newid float\r\ndeclare @gctip varchar(1);\r\ndeclare @borc float,@alacak float\r\n\r\nDECLARE @CARTIP VARCHAR(30)\r\nDECLARE @CARKOD VARCHAR(50)\r\nDECLARE @TUTAR FLOAT\r\nDECLARE @KUR FLOAT\r\n\r\n/*gider hareketleri */\r\n  DECLARE @gidkod varchar(30)\r\n  DECLARE @gidtutar float\r\n\r\n  select @gidkod=karsiheskod,@gidtutar=isnull(sum(alacak),0) from carihrk\r\n  with (nolock)\r\n  where permasmasid=@masid and cartip='perkart' and sil=0 \r\n  group by karsiheskod\r\n\r\n  update carihrk set sil=1 where \r\n  permasmasid=@masid and cartip='gelgidkart'\r\n\r\n  if isnull(@gidtutar,0)>0 and (@sil=0)\r\n  begin\r\n  select @newid=0\r\n  insert into carihrk (permasmasid,carhrkid,gctip,masterid,fisfattip,fisfatid,islmtip,islmtipad,islmhrk,islmhrkad,\r\n  yertip,yerad,cartip,carkod,borc,alacak,bakiye,tarih,saat,olususer,olustarsaat,vadetar,belno,\r\n  ack,varno,kur,dataok,pro,varok,perkod,adaid,deguser,degtarsaat,sil,\r\n  karsihestip,karsiheskod,parabrm) \r\n  select top 1 @masid,@newid,'B',0,'KENDI',0,islmtip,islmtipad,\r\n  islmhrk,islmhrkad,yertip,yerad,'gelgidkart',@gidkod,@gidtutar,0,0,tarih,saat,olususer,olustarsaat,null,belno,\r\n  ack,0,kur,0,1,1,'',0,deguser,degtarsaat,sil,\r\n  '','',parabrm from carihrk with (nolock)  where permasmasid=@masid \r\n  and cartip='perkart' and sil=0\r\n  \r\n  select @newid=SCOPE_IDENTITY()\r\n  update carihrk set carhrkid=@newid where id=@newid\r\n  \r\n  end\r\n\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "Plaka_Kaydet",
    "definition": "CREATE PROCEDURE [dbo].Plaka_Kaydet\r\n(@firmano    int,\r\n@cartip \tvarchar(20),\r\n@carkod \tvarchar(20),\r\n@plaka \t\tvarchar(30),\r\n@userad  \tvarchar(50))\r\nAS\r\nBEGIN\r\ndeclare @say           int\r\ndeclare @limit         float\r\ndeclare @limit_tip     varchar(20)\r\ndeclare @limit_harlt   float\r\ndeclare @limit_hartut  float\r\n\r\n\r\n  if @plaka=''\r\n    return\r\n  \r\n  select @say=isnull(count(*),0),\r\n  @limit=isnull(limit,0),\r\n  @limit_tip=isnull(limitturu,'')\r\n  from otomasgenkod  with (nolock) where cartip=@cartip and kod=@carkod\r\n  and plaka=@plaka \r\n  group by isnull(limit,0),isnull(limitturu,'')\r\n  \r\n  \r\n  \r\n  set @say=isnull(@say,0)\r\n  set @limit=isnull(@limit,0)\r\n  set @limit_tip=isnull(@limit_tip,'')\r\n  \r\n  \r\n  \r\n  if @say=0\r\n   begin\r\n    insert into otomasgenkod (firmano,cartip,kod,plaka,otomaskod,\r\n    olususer,olustarsaat)\r\n    select @firmano,@cartip,@carkod,@plaka,'',@userad,getdate()\r\n   end\r\n\r\n  \r\n\r\n\r\n  DECLARE @TB_PLAKA_LIMIT TABLE (\r\n  CAR_TIP         VARCHAR(20),\r\n  CAR_KOD         VARCHAR(50),\r\n  LIMIT_TIP       VARCHAR(20),\r\n  LIMIT           FLOAT,\r\n  LIMIT_KUL       FLOAT )\r\n  \r\n  \r\n  if @say>0\r\n   begin\r\n    if @limit=0\r\n     return\r\n\r\n   /*degerler alınıyor.. */\r\n    select @limit_harlt=isnull(sum(miktarlt),0),\r\n    @limit_hartut=isnull(sum(lttutar),0) from _Plaka_Limit_Miktar as l with (nolock)\r\n    where l.cartip=@cartip and l.carkod=@carkod\r\n    and l.plaka=@plaka\r\n    group by l.cartip,l.carkod\r\n    \r\n    if (@limit_tip='Litre') /*and @limit<@limit_harlt */\r\n    insert into @TB_PLAKA_LIMIT (CAR_TIP,CAR_KOD,LIMIT_TIP,LIMIT,LIMIT_KUL)\r\n    select  @cartip,@carkod,@limit_tip,@limit,@limit_harlt\r\n    \r\n    if (@limit_tip='Tutar') /*and @limit<@limit_hartut */\r\n    insert into @TB_PLAKA_LIMIT (CAR_TIP,CAR_KOD,LIMIT_TIP,LIMIT,LIMIT_KUL)\r\n    select  @cartip,@carkod,@limit_tip,@limit,@limit_hartut\r\n\r\n    \r\n   \r\n   \r\n   end\r\n  \r\n\r\n  SELECT * FROM @TB_PLAKA_LIMIT\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "Pom_Vardi_Hesapla",
    "definition": "CREATE PROCEDURE [dbo].Pom_Vardi_Hesapla (@VARNIN varchar(4000),@tip varchar(20))\r\nAS\r\nBEGIN\r\n  \r\ndeclare @varno int\r\n  \r\nif object_id( 'tempdb..#EKSTRE_TEMP' ) is null\r\nCREATE TABLE [dbo].[#EKSTRE_TEMP] (\r\n    VARNO      FLOAT)\r\n  \r\n TRUNCATE TABLE #EKSTRE_TEMP\r\n    \r\n declare @separator char(1)\r\n set @separator = ','\r\n\r\n declare @separator_position int\r\n declare @array_value varchar(1000)\r\n\r\n IF (LEN(RTRIM(@VARNIN)) > 0)\r\n BEGIN\r\n  set @VARNIN = @VARNIN + ','\r\n END\r\n\r\n while patindex('%,%' , @VARNIN) <> 0\r\n begin\r\n\r\n   select @separator_position =  patindex('%,%' , @VARNIN)\r\n   select @array_value = left(@VARNIN, @separator_position - 1)\r\n\r\n  Insert #EKSTRE_TEMP\r\n  Values (Cast(@array_value as float))\r\n  select @VARNIN = stuff(@VARNIN, 1, @separator_position, '')\r\n end\r\n\r\n\r\n   DECLARE CRS_VARNO_STOK_HRK CURSOR FAST_FORWARD FOR\r\n    SELECT VARNO FROM #EKSTRE_TEMP\r\n\r\n    OPEN CRS_VARNO_STOK_HRK\r\n     FETCH NEXT FROM CRS_VARNO_STOK_HRK INTO\r\n       @varno\r\n       WHILE @@FETCH_STATUS = 0\r\n       BEGIN\r\n       if @tip='pomvardimas'\r\n       begin\r\n       /*exec pomstoktankac @varno */\r\n       exec pomvarditopduz @varno\r\n       exec GENEL_GECVAROZETOLUSTUR @tip,@varno\r\n       end\r\n\r\n       if @tip='marvardimas'\r\n       begin\r\n       exec GENEL_GECVAROZETOLUSTUR @tip,@varno\r\n       end\r\n       \r\n      FETCH NEXT FROM CRS_VARNO_STOK_HRK INTO\r\n     @varno\r\n     END\r\n\r\n   CLOSE CRS_VARNO_STOK_HRK\r\n   DEALLOCATE CRS_VARNO_STOK_HRK\r\n\r\n\r\n  \r\n  \r\n  \r\n  \r\n  \r\n  \r\n  \r\nEND"
  },
  {
    "schema": "dbo",
    "name": "Pom_Vardi_Ozet",
    "definition": "CREATE PROCEDURE [dbo].Pom_Vardi_Ozet (@VARNIN VARCHAR(8000))\r\nAS\r\nBEGIN\r\n\r\n declare @sql nvarchar(500);\r\n declare @acik float,@fazla float;\r\n declare @perkod varchar(50),@perad varchar(50);\r\n declare @yertip varchar(20)\r\n set @yertip='pomvardimas';\r\n \r\n declare @varno int\r\n\r\nif object_id( 'tempdb..#PEKSTRE_TEMP' ) is null\r\nCREATE TABLE [dbo].[#PEKSTRE_TEMP] (\r\n    VARNO      FLOAT)\r\n\r\n TRUNCATE TABLE #PEKSTRE_TEMP\r\n\r\n declare @separator char(1)\r\n set @separator = ','\r\n\r\n declare @separator_position int\r\n declare @array_value varchar(1000)\r\n\r\n IF (LEN(RTRIM(@VARNIN)) > 0)\r\n BEGIN\r\n  set @VARNIN = @VARNIN + ','\r\n END\r\n\r\n while patindex('%,%' , @VARNIN) <> 0\r\n begin\r\n\r\n   select @separator_position =  patindex('%,%' , @VARNIN)\r\n   select @array_value = left(@VARNIN, @separator_position - 1)\r\n\r\n  Insert #PEKSTRE_TEMP\r\n  Values (Cast(@array_value as float))\r\n  select @VARNIN = stuff(@VARNIN, 1, @separator_position, '')\r\n end\r\n \r\n\r\nif object_id( 'tempdb..#pom_genel_ozet' ) is null\r\nCREATE TABLE [dbo].[#pom_genel_ozet] (\r\n  [id] int IDENTITY(1, 1) NOT NULL,\r\n  [giris] float DEFAULT 0 NULL,\r\n  [cikis] float DEFAULT 0 NULL,\r\n  [tip] varchar(10) COLLATE Turkish_CI_AS NULL,\r\n  [tipack] varchar(50) COLLATE Turkish_CI_AS NULL,\r\n  [sr] float NULL)\r\n\r\n  delete from #pom_genel_ozet \r\n\r\n  insert into #pom_genel_ozet (tip,tipack,sr,giris,cikis)\r\n  select 'AKSAT','Akaryakıt Sayaçlı Satış Tutarı',1,\r\n  isnull(sum(tutar),0),0 from pomvardisayac where sil=0\r\n  AND varno in (select * from #PEKSTRE_TEMP)\r\n\r\n\r\n insert into #pom_genel_ozet (tip,tipack,sr,giris,cikis)\r\n select 'VERAT','Veresiye Alacak Tutarı',2.0,\r\n isnull(sum(toptut),0),0 from veresimas\r\n where fistip='FISALCSAT' and sil=0 and ototag<>1 and yertip=@yertip\r\n AND varno in (select * from #PEKSTRE_TEMP)\r\n\r\n insert into #pom_genel_ozet (tip,tipack,sr,giris,cikis)\r\n select 'VERBT','Veresiye Borç Tutarı',2.1,0,isnull(sum(toptut),0)\r\n from veresimas\r\n where fistip='FISVERSAT' and sil=0 and ototag<>1 and yertip=@yertip\r\n AND varno in (select * from #PEKSTRE_TEMP)\r\n\r\n insert into #pom_genel_ozet (tip,tipack,sr,giris,cikis)\r\n select 'VEROT','Otomasyon Tutarı',2.2,0,isnull(sum(toptut),0)\r\n from veresimas\r\n where sil=0 and ototag=1 and yertip=@yertip\r\n AND varno in (select * from #PEKSTRE_TEMP)\r\n\r\n insert into #pom_genel_ozet (tip,tipack,sr,giris,cikis)\r\n select 'POSST','Pos Satış Tutarı',3,0,isnull(sum(giren*kur),0)\r\n from poshrk\r\n where sil=0 and yertip=@yertip\r\n AND varno in (select * from #PEKSTRE_TEMP)\r\n\r\n insert into #pom_genel_ozet (tip,tipack,sr,giris,cikis)\r\n select 'MALST','Yağ - Emtia Satış Tutarı',4,isnull(sum(tutar),0),0\r\n from emtiasat\r\n where sil=0 and yertip=@yertip\r\n AND varno in (select * from #PEKSTRE_TEMP)\r\n\r\n\r\n insert into #pom_genel_ozet (tip,tipack,sr,giris,cikis)\r\n select 'NAKTS','Nakit Teslimat Tutarı',5,0,isnull(sum(giren*kur),0)\r\n from kasahrk\r\n where sil=0 and yertip=@yertip and islmhrk='TES' and masterid=0\r\n AND varno in (select * from #PEKSTRE_TEMP)\r\n \r\n\r\n insert into #pom_genel_ozet (tip,tipack,sr,giris,cikis)\r\n select 'ODETT','Ödeme Tutarı',6,0,isnull(sum(cikan*kur),0)\r\n from kasahrk\r\n where ((islmtip='ODE' and cartip<>'gelgidkart') or (islmtip='BNK' and islmhrk='YTN') )\r\n and sil=0 and yertip=@yertip AND varno in (select * from #PEKSTRE_TEMP)\r\n\r\n insert into #pom_genel_ozet (tip,tipack,sr,giris,cikis)\r\n select 'TAHTT','Tahsilat Tutarı',7,isnull(sum(giren*kur),0),0 from kasahrk\r\n where ((islmtip='TAH' and cartip<>'gelgidkart') or (islmtip='BNK' and islmhrk='CKN') )\r\n and sil=0 and yertip=@yertip  AND varno in (select * from #PEKSTRE_TEMP)\r\n\r\n insert into #pom_genel_ozet (tip,tipack,sr,giris,cikis)\r\n select 'GELIR','Gelir Tutarı',20,\r\n isnull(sum(giren*kur),0),0 from kasahrk\r\n where islmtip='TAH' and cartip='gelgidkart' and sil=0\r\n and yertip=@yertip  AND varno in (select * from #PEKSTRE_TEMP)\r\n\r\n\r\n insert into #pom_genel_ozet (tip,tipack,sr,giris,cikis)\r\n select 'GIDER','Gider Tutarı',21,0,isnull(sum(cikan*kur),0) from kasahrk\r\n where islmtip='ODE' and cartip='gelgidkart'\r\n and sil=0 and yertip=@yertip AND varno in (select * from #PEKSTRE_TEMP)\r\n\r\n insert into #pom_genel_ozet (tip,tipack,sr,giris,cikis)\r\n select 'ARATOP','Ara Toplam',40,sum(giris),sum(cikis)\r\n from #pom_genel_ozet \r\n\r\n\r\n select @acik=(giris-cikis) from #pom_genel_ozet where tip='ARATOP'\r\n  \r\n if @acik<0\r\n begin\r\n set @fazla=0;\r\n set @acik=-@acik;\r\n end\r\n else\r\n begin\r\n set @fazla=@acik;\r\n set @acik=0;\r\n end\r\n\r\n insert into #pom_genel_ozet (tip,tipack,sr,giris,cikis)\r\n values('ACKFAZ','Fark',41,@acik,@fazla) ;\r\n\r\n select @acik=sum(giris),@fazla=sum(cikis) from #pom_genel_ozet\r\n where (tip='ARATOP' or tip='ACKFAZ')\r\n\r\n\r\n insert into #pom_genel_ozet (tip,tipack,sr,giris,cikis)\r\n values('GENTOP','Genel Toplam',42,@acik,@fazla)\r\n\r\n\r\n\r\nselect tipack AS ACIKLAMA,giris AS GIRIS,cikis AS CIKIS,sr AS SIRA from #pom_genel_ozet order by sr\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "Pom_Vardi_VarOk_Kont",
    "definition": "CREATE PROCEDURE [dbo].Pom_Vardi_VarOk_Kont\r\nAS\r\nBEGIN\r\n\r\n  update pomvardisayac set Varok=1 \r\n  where sil=0 and varok=0 \r\n  and varno in \r\n  (select varno from pomvardimas with (nolock) where \r\n  varok=1 and sil=0 group by varno)\r\n\r\n\r\n\r\n  update pomvardiper set Varok=1 \r\n  where sil=0 and varok=0 \r\n  and varno in \r\n  (select varno from pomvardimas with (nolock) where \r\n  varok=1 and sil=0 group by varno)\r\n  \r\n\r\n  update pomvardiperada set Varok=1 \r\n  where sil=0 and varok=0 \r\n  and varno in \r\n  (select varno from pomvardimas with (nolock) where \r\n  varok=1 and sil=0 group by varno)\r\n  \r\n  \r\n  update pomvardistok set Varok=1 \r\n  where sil=0 and varok=0 \r\n  and varno in \r\n  (select varno from pomvardimas with (nolock) where \r\n  varok=1 and sil=0 group by varno)  \r\n  \r\n  \r\n  update pomvarditank set Varok=1 \r\n  where sil=0 and varok=0 \r\n  and varno in \r\n  (select varno from pomvardimas with (nolock) where \r\n  varok=1 and sil=0 group by varno) \r\n  \r\n  \r\n  /*ters işlem   */\r\n  update pomvardisayac set sil=1 \r\n  where varno not in \r\n  (select varno from pomvardimas with (nolock) )\r\n  \r\n   update pomvardiper set sil=1 \r\n   where varno not in \r\n   (select varno from pomvardimas with (nolock) )\r\n\r\n   update pomvardiperada set sil=1 \r\n   where varno not in \r\n   (select varno from pomvardimas with (nolock))\r\n  \r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "Pom_Vardi_VarOk_Kont_Firma",
    "definition": "Create PROCEDURE [dbo].[Pom_Vardi_VarOk_Kont_Firma]\r\n@Firmano int\r\nAS\r\nBEGIN\r\n\r\n  update pomvardisayac set Varok=1 \r\n  where sil=0 and varok=0 and Firmano=@Firmano\r\n  and varno in \r\n  (select varno from pomvardimas with (nolock) where \r\n  varok=1 and sil=0 and Firmano=@Firmano group by varno)\r\n\r\n\r\n\r\n  update pomvardiper set Varok=1 \r\n  where sil=0 and varok=0 and Firmano=@Firmano\r\n  and varno in \r\n  (select varno from pomvardimas with (nolock) where \r\n  varok=1 and sil=0 and Firmano=@Firmano group by varno)\r\n  \r\n\r\n  update pomvardiperada set Varok=1 \r\n  where sil=0 and varok=0  and Firmano=@Firmano\r\n  and varno in \r\n  (select varno from pomvardimas with (nolock) where \r\n  varok=1 and sil=0 and Firmano=@Firmano group by varno)\r\n  \r\n  /* \r\n  update pomvardistok set Varok=1 \r\n  where sil=0 and varok=0  and Firmano=@Firmano\r\n  and varno in \r\n  (select varno from pomvardimas with (nolock) where \r\n  varok=1 and sil=0 and Firmano=@Firmano group by varno)  \r\n  \r\n  \r\n  update pomvarditank set Varok=1 \r\n  where sil=0 and varok=0  and Firmano=@Firmano\r\n  and varno in \r\n  (select varno from pomvardimas with (nolock) where \r\n  varok=1 and sil=0 and Firmano=@Firmano group by varno) \r\n  */\r\n  \r\n  /*ters işlem   */\r\n  update pomvardisayac set sil=1 \r\n  where  Firmano=@Firmano and varno not in \r\n  (select varno from pomvardimas with (nolock) where Firmano=@Firmano )\r\n  \r\n   update pomvardiper set sil=1 \r\n   where Firmano=@Firmano and varno not in \r\n   (select varno from pomvardimas with (nolock) where Firmano=@Firmano )\r\n\r\n   update pomvardiperada set sil=1 \r\n   where Firmano=@Firmano and varno not in \r\n   (select varno from pomvardimas with (nolock) where Firmano=@Firmano )\r\n  \r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "pomstoktankac",
    "definition": "CREATE PROCEDURE [dbo].pomstoktankac\r\n@firmano int,\r\n@varno float\r\nAS\r\nBEGIN\r\n\r\n\r\n declare @stkkod   varchar(20)\r\n declare @stktip   varchar(10)\r\n declare @tankkod  varchar(30)\r\n declare @kdvyuz   float\r\n declare @brimfiy  float\r\n declare @satismik float\r\n declare @acmik    float\r\n declare @trsmik    float\r\n declare @testmik    float\r\n\r\n /*-- stok son durumları */\r\n  DECLARE @TB_DEP_TARIH TABLE (\r\n    VAR_NO     FLOAT,\r\n    DEP_KOD    VARCHAR(30) COLLATE Turkish_CI_AS,\r\n    STOK_TIP   VARCHAR(10) COLLATE Turkish_CI_AS,\r\n    STOK_KOD   VARCHAR(30) COLLATE Turkish_CI_AS,\r\n    MIKTAR     FLOAT,\r\n    TUTAR      FLOAT)\r\n   INSERT INTO @TB_DEP_TARIH\r\n   SELECT * FROM DBO.DEPO_TARIHLI_STOKIN ('pomvardimas',@varno)\r\n/*--stok son durumları */\r\n\r\n/*--stok kartlarına gore */\r\n /*delete from pomvardistok where varno=@varno */\r\n update pomvardistok Set Sil=1,TransferStartId=isnull(TransferStartId,0)+1 where varno=@varno  \r\n\r\nDECLARE POM_SAYACSTOK CURSOR FAST_FORWARD FOR\r\n SELECT p.stkod,p.stktip,avg(p.kdvyuz),\r\n  case when sum(p.satmik)>0 then\r\n  sum(p.tutar)/sum(p.satmik) else avg(p.brimfiy) end,\r\n  sum(p.satmik),isnull(sum(p.transfermik),0),isnull(sum(p.testmik),0),\r\n (select sum(isnull(MIKTAR,0)) \r\n from @TB_DEP_TARIH as  s where\r\n s.STOK_TIP=p.stktip and s.STOK_KOD=p.stkod)\r\n FROM pomvardisayac as p with (nolock) \r\n where varno=@varno and firmano=@firmano and Sil=0\r\n group by p.stkod,p.stktip\r\n\r\n OPEN POM_SAYACSTOK\r\n FETCH NEXT FROM POM_SAYACSTOK INTO\r\n @stkkod,@stktip,@kdvyuz,@brimfiy,@satismik,@trsmik,@testmik,@acmik\r\n WHILE @@FETCH_STATUS = 0\r\n BEGIN\r\n\r\n   set @acmik=isnull(@acmik,0)\r\n\r\n   insert into pomvardistok\r\n   (firmano,varno,kod,acmik,satmik,kalan,brimfiy,stktip,kdvyuz,\r\n   transfer_cks_mik,transfer_grs_mik,testmik)\r\n   values\r\n   (@firmano,@varno,@stkkod,@acmik,@satismik,@acmik-@satismik,@brimfiy,@stktip,@kdvyuz,\r\n   @trsmik,@trsmik,@testmik)\r\n   \r\n FETCH NEXT FROM POM_SAYACSTOK INTO  @stkkod,@stktip,@kdvyuz,@brimfiy,@satismik,@trsmik,@testmik,@acmik\r\n\r\n END\r\n CLOSE POM_SAYACSTOK\r\n DEALLOCATE POM_SAYACSTOK\r\n/*-----------stok kartlarına gore */\r\n\r\n/*-----tank kartlarına gore */\r\n /*delete from pomvarditank where varno=@varno */\r\n update pomvarditank Set Sil=1,TransferStartId=isnull(TransferStartId,0)+1 where varno=@varno  \r\n\r\nDECLARE POM_SAYACTANK CURSOR FAST_FORWARD FOR\r\n SELECT p.tankod,p.stkod,p.stktip,avg(p.kdvyuz),\r\n  case when sum(p.satmik)>0 then\r\n  sum(p.tutar)/sum(p.satmik) else avg(p.brimfiy) end,\r\n  sum(p.satmik),isnull(sum(p.transfermik),0),isnull(sum(p.testmik),0),\r\n (select MIKTAR from @TB_DEP_TARIH as  s where\r\n s.dep_kod=p.tankod and s.STOK_TIP=p.stktip and s.STOK_KOD=p.stkod)\r\n FROM pomvardisayac as p with (nolock)\r\n where varno=@varno and firmano=@firmano and Sil=0\r\n group by p.tankod,p.stkod,p.stktip\r\n\r\n OPEN POM_SAYACTANK\r\n FETCH NEXT FROM POM_SAYACTANK INTO\r\n @tankkod,@stkkod,@stktip,@kdvyuz,@brimfiy,@satismik,@trsmik,@testmik,@acmik\r\n WHILE @@FETCH_STATUS = 0\r\n BEGIN\r\n \r\n  set @acmik=isnull(@acmik,0)\r\n\r\n   insert into pomvarditank\r\n   (firmano,varno,kod,stkod,acmik,satmik,kalan,brimfiy,stktip,kdvyuz,transfer_cks_mik,testmik)\r\n   values\r\n   (@firmano,@varno,@tankkod,@stkkod,@acmik,@satismik,@acmik-(@satismik+@trsmik+@testmik),@brimfiy,@stktip,@kdvyuz,@trsmik,@testmik)\r\n\r\n FETCH NEXT FROM POM_SAYACTANK INTO  @tankkod,@stkkod,@stktip,@kdvyuz,@brimfiy,@satismik,@trsmik,@testmik,@acmik\r\n\r\n END\r\n CLOSE POM_SAYACTANK\r\n DEALLOCATE POM_SAYACTANK\r\n/*-----------tank kartlarına gore */\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "pomtumvarozet",
    "definition": "CREATE PROCEDURE [dbo].pomtumvarozet @varno float\r\nAS\r\nBEGIN\r\n\r\ndeclare @sql nvarchar(50);\r\ndeclare @acik float,@fazla float;\r\n\r\nif object_id( 'tempdb..#tumvarozet' ) is null\r\nCREATE TABLE [dbo].[#tumvarozet] (id int IDENTITY,\r\nkod varchar(50),ad varchar(50),grs float,cks float);\r\n\r\n\r\ninsert into #tumvarozet (kod,ad,grs,cks) select 'aksattut','Akaryakıt Sayaçlı Satış Tutarı',aksattut,0 from vardimas  where varno=@varno ;\r\n\r\n\r\n\r\nselect * from #tumvarozet;\r\n\r\n\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "PomVardi_Evrak_Kont",
    "definition": "CREATE PROCEDURE dbo.PomVardi_Evrak_Kont\r\nAS\r\nBEGIN\r\n   \r\n /*veresiye fis kontrol */\r\n  declare @varno int\r\n  declare @min_varno int  \r\n  declare @tarih    datetime   \r\n  \r\n   select @min_varno=Min(varno) from pomvardimas with (nolock)  where varno>0\r\n   \r\n   \r\n  /*havuza geri al */\r\n   update veresimas \r\n   set TransferStartId=isnull(TransferStartId,0)+1,\r\n   sil=0,\r\n   yertip=case when vtsid>0 then 'vts_islem' else 'havuzislem' end,\r\n   yerad=case when vtsid>0 then\r\n   (select ad from yertipad where kod='vts_islem')\r\n   else (select ad from yertipad where kod='havuzislem') end,\r\n   varno=0,kayok=1\r\n   from veresimas v \r\n   with (nolock) where v.havuzfis=1 \r\n   and v.varno>0 and v.varno>=isnull(@min_varno,1)\r\n   and isnull(v.devir,0)=0\r\n   and v.varno not in (select varno from pomvardimas \r\n   where varno>=isnull(@min_varno,1)) \r\n\r\n       \r\n  \r\n   update veresimas set sil=1 where \r\n   yertip='pomvardimas' and sil=0 and aktip='BK'\r\n   and  varno >=isnull(@min_varno,1) and isnull(devir,0)=0\r\n   and varno not in (select varno from pomvardimas \r\n   where varno>=isnull(@min_varno,1)   ) \r\n   \r\n   \r\n   \r\n   update poshrk set sil=1 where \r\n   yertip='pomvardimas' and sil=0 and aktip='BK'\r\n   and  varno >=isnull(@min_varno,1) and isnull(devir,0)=0\r\n   and varno not in (select varno from pomvardimas \r\n   where varno>=isnull(@min_varno,1) )     \r\n\r\n \r\n  \r\n\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "pomvardistokduzelt",
    "definition": "CREATE PROCEDURE [dbo].pomvardistokduzelt (@varno float)\r\nAS\r\nBEGIN\r\n\r\n declare @tankod varchar(20)\r\n declare @stkod varchar(20)\r\n declare @stktip varchar(20)\r\n declare @id float\r\n declare @TARIH1 datetime\r\n declare @SAAT1 VARCHAR(8)\r\n \r\n declare @stkkalanmik float\r\n declare @tnkkalanmik float\r\n\r\n select @TARIH1=tarih,@SAAT1=cast(saat as varchar) from pomvardimas where varno=@varno\r\n\r\n DECLARE pomtankstokduz CURSOR FAST_FORWARD FOR SELECT id,kod,stkod,stktip\r\n FROM pomvarditank where varno=@varno and Sil=0\r\n OPEN pomtankstokduz\r\n FETCH NEXT FROM pomtankstokduz INTO  @id,@tankod,@stkod,@stktip\r\n WHILE @@FETCH_STATUS = 0\r\n BEGIN\r\n\r\n\r\n set @stkkalanmik=isnull((select MIKTAR from dbo.DEPO_TARIHLI_STOK ('',@stktip,@stkod,@TARIH1,@SAAT1)),0)\r\n set @tnkkalanmik=isnull((select MIKTAR from dbo.DEPO_TARIHLI_STOK (@tankod,@stktip,@stkod,@TARIH1,@SAAT1)),0)\r\n\r\n  update pomvardistok set acmik=@stkkalanmik,kalan=@stkkalanmik-(satmik+testmik+transfer_cks_mik)\r\n  from pomvardistok where kod=@stkod and stktip=@stktip and varno=@varno and Sil=0\r\n \r\n  update pomvarditank set acmik=@tnkkalanmik,kalan=(@tnkkalanmik)-(satmik+testmik+transfer_cks_mik)\r\n  from pomvarditank where kod=@tankod and varno=@varno and Sil=0\r\n\r\n\r\n\r\n FETCH NEXT FROM pomtankstokduz INTO  @id,@tankod,@stkod,@stktip\r\n END\r\n CLOSE pomtankstokduz\r\n DEALLOCATE pomtankstokduz\r\n\r\n  \r\nEND"
  },
  {
    "schema": "dbo",
    "name": "pomvarditopduz",
    "definition": "CREATE PROCEDURE [dbo].pomvarditopduz(@varno float)\r\nAS\r\nBEGIN\r\n\r\ndeclare @yertip varchar(20)\r\n\r\nset @yertip='pomvardimas'\r\n\r\n update pomvardimas set\r\n    otomastop=(select isnull(sum(toptut),0) from veresimas\r\n    where yertip=@yertip and ototag>0 and varno=@varno and sil=0 and kayok=1),\r\n    veresitop=(select isnull(sum(toptut),0) from veresimas\r\n    where yertip=@yertip and ototag=0 and varno=@varno and sil=0 and kayok=1)\r\n  where varno=@varno\r\n\r\n/*-tahsilat odeme nakit teslimat toplamı */\r\nupdate pomvardimas set naktestop=\r\n   (select isnull(sum(giren*kur),0) from kasahrk\r\n   where varno=@varno and sil=0 and islmtip='TAH'\r\n   and islmhrk='TES' and yertip=@yertip and masterid=0)\r\nwhere varno=@varno\r\n\r\n/*-tahsilat toplamı */\r\nupdate pomvardimas set tahtop=\r\n   (select isnull(sum(giren*kur),0) from kasahrk\r\n   where varno=@varno and sil=0 and islmtip='TAH' and islmhrk='NAK' and cartip<>'gelgidkart' and yertip=@yertip)\r\nwhere varno=@varno\r\n\r\n/*-gelir toplamı */\r\nupdate pomvardimas set gelirtop=\r\n   (select isnull(sum(giren*kur),0) from kasahrk\r\n   where varno=@varno and sil=0 and islmtip='TAH' and islmhrk='NAK' and cartip='gelgidkart' and yertip=@yertip)\r\nwhere varno=@varno\r\n\r\n\r\n/*-odeme toplamı */\r\nupdate pomvardimas set odetop=\r\n   (select isnull(sum(cikan*kur),0) from kasahrk\r\n   where varno=@varno and sil=0 and islmtip='ODE' and islmhrk='NAK' and cartip<>'gelgidkart' and yertip=@yertip)\r\nwhere varno=@varno\r\n\r\n/*-gider toplamı */\r\nupdate pomvardimas set gidertop=\r\n   (select isnull(sum(cikan*kur),0) from kasahrk\r\n   where varno=@varno and sil=0 and islmtip='ODE' and islmhrk='NAK' and cartip='gelgidkart' and yertip=@yertip)\r\nwhere varno=@varno\r\n\r\n\r\n/*-ak satis toplamı */\r\nupdate pomvardimas set aksatmik=dt.aksatmikl,aksattop=dt.aksattopl from pomvardimas\r\nt join (select isnull(sum(satmik),0) aksatmikl,\r\nisnull(sum(satmik*brimfiy),0) as aksattopl from pomvardisayac \r\n where varno=@varno and sil=0 ) dt on t.varno=@varno\r\n \r\n/*veresiye toplam */\r\nupdate pomvardimas set otomastop=(select isnull(sum(case when fistip='FISALCSAT' then\r\n                                  -1*toptut else toptut end ),0)\r\n                                  from veresimas where varno=@varno and ototag>=1 and sil=0)\r\n                                  where varno=@varno\r\n\r\nupdate pomvardimas set veresitop=(select isnull(sum(case when fistip='FISALCSAT' then\r\n                                  -1*toptut else toptut end),0)\r\n                                  from veresimas where varno=@varno and ototag=0 and sil=0)\r\n                                  where varno=@varno\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "PomvardiVeresiTTSKont",
    "definition": "CREATE PROCEDURE dbo.PomvardiVeresiTTSKont\r\n(@varno float)\r\nAS\r\nBEGIN\r\n declare @firmano  int\r\n declare @TTSKey   varchar(100)\r\n declare @Tarih    datetime\r\n\r\n  select @firmano=firmano,@Tarih=tarih  from pomvardimas with (nolock) where varno=@varno\r\n \r\n  select @TTSKey=tts_key from otomaskart where firmano=@firmano and tts_key <>'' \r\n \r\n if isnull(@TTSKey,'')<>''\r\n  begin\r\n \r\n /*\r\n  SELECT  O.kod AS oCARKOD,v.carkod as vCARKOD,v.TARÃ„Â°H ,O.plaka OPLAKA,V.PLAKA AS VPLAKA,\r\n   o.cartip,v.verid,v.aktip\r\n  from    otomasgenkod AS O \r\n  INNER JOIN     veresimas AS V  ON V.plaka = O.plaka and v.varno=@varno\r\n  where v.firmano =@firmano and O.otomaskod='TTS' \r\n  and v.otocarkod in (select * from CsvToSTR(@TTSKey))\r\n  AND o.kod<>v.carkod --and v.plaka='041RA398'\r\n\r\nselect * from veresimas where verid=29973\r\nand otocarkod in (select * from CsvToSTR(@TTSKey))\r\n--('901395','903182')\r\n*/\r\n\r\n\r\n update veresimas set cartip=dt.cartip,carkod=dt.carkod from veresimas as t join \r\n (select v.verid,O.kod AS carkod,o.cartip  from  otomasgenkod AS O \r\n  INNER JOIN  veresimas AS V  ON V.plaka = O.plaka and o.firmano=v.firmano\r\n  and v.varno=@varno and v.tarih>=DATEADD(day,-5,@Tarih) and v.sil=0\r\n  where v.firmano=@firmano  and O.otomaskod='TTS' and v.aktip='BK'\r\n  and v.otocarkod in (select * from CsvToSTR(@TTSKey))\r\n  AND o.kod<>v.carkod) dt on dt.verid=t.verid\r\n\r\nend\r\n\r\n\r\n\r\n   /*-vardiya olusumunda versiye fislerine varno atanmamÄ±s ise kontrol  */\r\n    update veresimas set sil=1,\r\n    deguser='VeresiTTSKont',degtarsaat=getdate() where id in (\r\n    select id from veresimas with (NOLOCK) where firmano=@firmano\r\n    and varno=0 and otomas_id in ( \r\n    select otomas_id from veresimas as v with (NOLOCK)\r\n    where firmano=@firmano and sil=0 and otomas_id>0 and yertip='pomvardimas'  \r\n    group by Tarih,otomas_id\r\n    having count(*)>1) )\r\n\r\n\r\n\r\n   \r\n\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "PomVarKabul",
    "definition": "CREATE PROCEDURE [dbo].PomVarKabul(\r\n@firmano                           int,\r\n@varno                                               float,\r\n@varok                                               int,\r\n@sil                                       int)\r\nAS\r\nBEGIN\r\nSET NOCOUNT ON\r\n\r\nBEGIN TRAN PM1\r\n\r\n/*stok bilgileri */\r\ndeclare @stkod                                                               varchar(30)\r\ndeclare @sayackod                                        varchar(30)\r\ndeclare @satmik                                             float\r\ndeclare @idx                                                     float\r\ndeclare @testmik                                           float\r\ndeclare @transmik                                         float\r\ndeclare @ilkenk                                               float\r\ndeclare @sonenk                                            float\r\ndeclare @olustar                                            datetime\r\nDECLARE @tarx                                                               datetime\r\ndeclare @saatx                                                                varchar(8)\r\ndeclare @olususer                                          varchar(50)\r\ndeclare @varad                                                               varchar(40)\r\ndeclare @stktip                                               varchar(10)\r\ndeclare @yerad                                                               varchar(30)\r\ndeclare @stktipad                                          varchar(30)\r\ndeclare @depkod                                           varchar(30)\r\nDECLARE @trstank                                         varchar(30)\r\ndeclare @yertip                                               varchar(30)\r\ndeclare @islmtip                                             varchar(10)\r\ndeclare @islmtipad                                        varchar(20)\r\ndeclare @sayachrkid                      float\r\ndeclare @say                                                    int\r\ndeclare @brmfiy                                                             float\r\nDeclare @kdvyuz                                            float\r\n\r\n\r\nDECLARE @Var_tar                                        datetime\r\ndeclare @Var_saat                                         varchar(10)\r\n\r\n\r\n/*----silme ve geri alma durumu için */\r\nif (@sil=1) or (@varok=0)\r\n  begin\r\n  /* select @say=count(*) from pomvardimas where  */\r\n  /* firmano=@firmano and sil=0 and varno>@varno and varok=1  */\r\n    if (@sil=1)\r\n     update sayachrk Set Sil=1 where varno=@varno and yertip='pomvardimas'\r\n  \r\n     \r\n    update stkhrk set Sil=1 where varno=@varno and yertip='pomvardimas'\r\n    and tabload is null \r\n\r\n    update pomvardiozet set Sil=1 where varno=@varno\r\n\r\n    update kasahrk set Sil=1 where islmhrk='VTO' and varno=@varno and yertip='pomvardimas'\r\n\r\n    /*-VARDIYA ACIK FAZLA İŞLENMESI SILIMI */\r\n    update carihrk set sil=1 where varno=@varno and yertip='pomvardimas' and islmtip='VAR'\r\n\r\n    if @varok=0\r\n    update otomasoku set aktar=0 where varno=@varno\r\n\r\n    if @sil=1\r\n      delete otomasoku where varno=@varno\r\n\r\n\r\n                IF @@ERROR > 0\r\n                               ROLLBACK TRAN PM1\r\n                ELSE\r\n                               COMMIT TRAN PM1\r\n\r\n    SET NOCOUNT OFF\r\n   RETURN\r\n  end\r\n   /*----silme ve geri alma durumu için */\r\n   \r\n   \r\n   \r\n  declare  @drm     tinyint\r\n\r\n  select @drm=Var_Hrk_Tar_isle from sistemtanim\r\n\r\n\r\n   select @Var_tar=kaptar,@Var_saat=kapsaat from \r\n   pomvardimas with (nolock) where firmano=@firmano and varno=@varno\r\n\r\n\r\n   if (@drm>0)/*acılıs tarihi */\r\n     select @Var_tar=tarih,@Var_saat=saat from \r\n     pomvardimas with (nolock) where firmano=@firmano and varno=@varno \r\n    \r\n  \r\n  \r\n   \r\n   \r\n  delete from  pomvardiozet where varno=@varno\r\n\r\n  /*--vardiya özet tablosuna kapanış bilgilerini al */\r\n  exec pomvarozet_Yeni @varno,'per','genel'\r\n  insert into pomvardiozet (varno,varok,sil,tip,tipack,\r\n  giris,cikis,bakiye,sr)\r\n  select @varno,@varok,@sil,ickkod,ickad,\r\n  sum(grs),sum(cks),sum(grs-cks),sr\r\n  from ##pomvardiozet where varno=@varno\r\n  group by ickkod,ickad,sr order by sr\r\n  /*------------------------ */\r\n\r\n  update otomasoku set aktar=-1 where varno=@varno\r\n\r\n\r\n  Declare @Once_SonEndk                         float\r\n  Declare @Gec_Satmik                Float\r\n  Declare @Enktur                          Varchar(10)\r\n  Declare @Fark_Enks                    float\r\n\r\n\r\n  set @yertip='pomvardimas'\r\n  select @yerad=ad from yertipad where kod=@yertip\r\n\r\n  /*kasa cari tahsilat karsı hesap kapatma */\r\n  exec Vardiya_Kasa_Kapat @yertip,@varno\r\n\r\n\r\n  set @islmtip='POMSAYSAT'\r\n  select @islmtipad=ad from stkhrktip where kod=@islmtip\r\n\r\n\r\n\r\n     /*sayac endekleri isleniyor */\r\n     DECLARE pomvardisayackab CURSOR FAST_FORWARD FOR\r\n     SELECT pm.varad,pm.deguser,pm.degtarsaat,\r\n     pm.kaptar,pm.kapsaat,\r\n     ps.sayackod,ps.ilkendk,ps.sonendk,\r\n     ps.Enktur,ps.OncekiSonEndk\r\n      FROM pomvardisayac as ps with (nolock)\r\n     inner join pomvardimas as pm on\r\n     pm.varno=ps.varno where pm.firmano=@firmano \r\n     and pm.sil=0 and ps.Sil=0 and ps.varno=@varno and ps.varok=1\r\n     and ps.perkod='Diger' /*and ps.ilkendk<>ps.sonendk */\r\n\r\n      OPEN pomvardisayackab\r\n      FETCH NEXT FROM pomvardisayackab INTO  \r\n      @varad,@olususer,@olustar,@tarx,@saatx,\r\n      @sayackod,@ilkenk,@sonenk,@Enktur,@Once_SonEndk\r\n      WHILE @@FETCH_STATUS = 0\r\n       BEGIN\r\n\r\n      /*-sayac bilgileri */\r\n      if (@sonenk<>0) and (@ilkenk<>@sonenk)\r\n      begin\r\n\r\n      if (select count(*) from sayachrk with (nolock) where \r\n       varno=@varno and sayackod=@sayackod and Sil=0 )=0\r\n        begin       \r\n          select @sayachrkid=isnull(max(sayachrkid),0)+1 from sayachrk\r\n          insert into sayachrk (firmano,sayachrkid,varno,sayackod,\r\n          tarih,saat,ilkendks,sonendks,belno,ack,olususer,olustarsaat,\r\n          islmtip,islmtipad,yertip,yerad,dataok)\r\n          values (@firmano,@sayachrkid,@varno,@sayackod,\r\n          @Var_tar,@Var_Saat,@ilkenk,@sonenk,@varno,@varad+' SAYAÇ SATIŞI',\r\n          @olususer,@olustar,@islmtip,@islmtipad,@yertip,@yerad,0)\r\n        end  \r\n        else\r\n        update sayachrk set firmano=@firmano,\r\n        ilkendks=@ilkenk,\r\n        sonendks=@sonenk,\r\n        belno=@varno,\r\n        ack=@varad+' SAYAÇ SATIŞI',\r\n        tarih=@Var_tar,saat=@Var_Saat where \r\n         varno=@varno and sayackod=@sayackod and Sil=0\r\n       end \r\n        else\r\n        begin\r\n         if (@sonenk>0) and (@ilkenk=@sonenk)\r\n           update sayachrk set Sil=1  where varno=@varno and sayackod=@sayackod\r\n        end \r\n     \r\n     /*     \r\n      --Bu vardiyadan sonraki Vardiyalarda Endeks Duzelt\r\n           \r\n         if @sonenk<>@Once_SonEndk  \r\n          begin\r\n          \r\n          --artan azalan dikkat\r\n         -- if @Enktur='Artan'\r\n            set @Fark_Enks=(@SonEnk-@Once_SonEndk)\r\n         -- else\r\n           --set @Fark_Enks=-1*(@SonEnk-@Once_SonEndk)  \r\n          \r\n            \r\n          \r\n       \r\n           update pomvardisayac set\r\n           ilkendk=ilkendk+@Fark_Enks,\r\n           sonendk=Sonendk+@Fark_Enks,\r\n           OncekiSonEndk=SonEndk+@Fark_Enks\r\n           where firmano=@firmano and Varno>@Varno \r\n           and sayackod=@sayackod \r\n                 \r\n           update sayachrk set\r\n            ilkendks=ilkendks+@Fark_Enks,\r\n            sonendks=sonendks+@Fark_Enks\r\n            where firmano=@firmano and \r\n            varno>@varno and sayackod=@sayackod\r\n          \r\n        end\r\n       */ \r\n        \r\n        \r\n        \r\n        \r\n     \r\n      FETCH NEXT FROM pomvardisayackab INTO  \r\n      @varad,@olususer,@olustar,@tarx,@saatx,@sayackod,\r\n      @ilkenk,@sonenk,@Enktur,@Once_SonEndk\r\n\r\n      END\r\n     CLOSE pomvardisayackab\r\n     DEALLOCATE pomvardisayackab\r\n     \r\n      /*Son Endeksi onceki endkse ata */\r\n        update pomvardisayac set OncekiSonEndk=Sonendk\r\n           where firmano=@firmano and Varno=@Varno and Sil=0\r\n\r\n     \r\n     \r\n\r\n\r\n  /*stok satisları yansıtılıyor */\r\n\r\n    DECLARE pomvardistkkab CURSOR FAST_FORWARD FOR \r\n    SELECT pm.varad,pm.deguser,pm.degtarsaat,\r\n    pm.kaptar,pm.kapsaat,pt.kod,pt.stkod,pt.stktip,\r\n    pt.brimfiy,pt.kdvyuz,pt.satmik,pt.testmik,pt.transfer_cks_mik\r\n    FROM pomvarditank as pt inner join pomvardimas as pm on\r\n    pm.varno=pt.varno and pm.sil=0 and isnull(pt.sil,0)=0 where pt.varno=@varno\r\n\r\n    OPEN pomvardistkkab\r\n    FETCH NEXT FROM pomvardistkkab INTO  \r\n    @varad,@olususer,@olustar,@tarx,@saatx,@depkod,\r\n    @stkod,@stktip,@brmfiy,@kdvyuz,@satmik,@testmik,@transmik\r\n    WHILE @@FETCH_STATUS <> -1\r\n     BEGIN\r\n\r\n      if @satmik>0\r\n      begin\r\n        insert into stkhrk (firmano,stkhrkid,stkod,tarih,saat,\r\n        giren,cikan,brmfiykdvli,kdvyuz,\r\n        ack,olususer,olustarsaat,varno,islmtip,islmtipad,\r\n        depkod,stktip,stktipad,\r\n        yertip,yerad,dataok,pro)\r\n        values (@firmano,@varno,@stkod,@Var_tar,@Var_Saat,\r\n        0,@satmik,@brmfiy,@kdvyuz,@varad+' SAYAÇ SATIŞI',@olususer,@olustar,\r\n        @varno,@islmtip,@islmtipad,@depkod,@stktip,@stktipad,@yertip,@yerad,0,1)\r\n      end\r\n\r\n\r\n      FETCH NEXT FROM pomvardistkkab INTO  \r\n      @varad,@olususer,@olustar,@tarx,@saatx,@depkod,\r\n      @stkod,@stktip,@brmfiy,@kdvyuz,@satmik,@testmik,@transmik\r\n\r\n      END\r\n    CLOSE pomvardistkkab\r\n    DEALLOCATE pomvardistkkab\r\n\r\n\r\n    /*-tank transfer giris haraketleri */\r\n\r\n    set @islmtip='POMTRANS'\r\n    select @islmtipad=ad from stkhrktip where kod=@islmtip\r\n\r\n    /*- tank transfer giris haraketleri */\r\n     insert into stkhrk (firmano,stkhrkid,stkod,tarih,saat,giren,cikan,\r\n     brmfiykdvli,kdvyuz,ack,olususer,olustarsaat,varno,\r\n     islmtip,islmtipad,depkod,stktip,yertip,yerad)\r\n\r\n     select ps.firmano,ps.varno,ps.stkod,@Var_tar,@Var_Saat,\r\n     isnull(sum(ps.transfermik),0),0,\r\n     case when sum(ps.tutar)>0 then\r\n     sum(ps.tutar)/sum(ps.satmik) else avg(ps.brimfiy) end,avg(ps.kdvyuz),\r\n     @varad+' SAYAÇ TRANSFER GİRİS',@olususer,@olustar,ps.varno,\r\n     @islmtip,@islmtipad,\r\n     ps.transfertank,ps.stktip,@yertip,@yerad\r\n     FROM pomvardisayac as ps \r\n     inner join pomvardimas as pm on pm.varno=ps.varno \r\n     and pm.firmano=ps.firmano and pm.sil=0 and isnull(ps.sil,0)=0\r\n     where ps.varno=@varno and ps.firmano=@firmano\r\n     and transfertank<>'' and ps.transfermik>0\r\n     group by ps.firmano,ps.varno,ps.stkod,ps.transfertank,ps.stktip\r\n   \r\n   \r\n     \r\n         \r\n\r\n    /*-tank transfer cikis haraketleri */\r\n     \r\n     insert into stkhrk (firmano,stkhrkid,stkod,tarih,saat,\r\n     giren,cikan,brmfiykdvli,kdvyuz,ack,olususer,olustarsaat,varno,\r\n     islmtip,islmtipad,\r\n     depkod,stktip,yertip,yerad)\r\n\r\n     select ps.firmano,ps.varno,ps.stkod,@Var_tar,@Var_Saat,\r\n     0,isnull(sum(ps.transfer_cks_mik),0),\r\n     case when sum(ps.tutar)>0 then\r\n     sum(ps.tutar)/sum(ps.satmik) else avg(ps.brimfiy) end,avg(ps.kdvyuz),\r\n     @varad+' SAYAÇ TRANSFER CIKIS',@olususer,@olustar,ps.varno,\r\n     @islmtip,@islmtipad,\r\n     ps.kod,ps.stktip,@yertip,@yerad\r\n     FROM pomvarditank as ps\r\n     inner join pomvardimas as pm on pm.varno=ps.varno \r\n     and pm.firmano=ps.firmano and pm.sil=0 and isnull(ps.sil,0)=0\r\n     where ps.varno=@varno and ps.firmano=@firmano\r\n     and ps.transfer_cks_mik>0\r\n     group by ps.firmano,ps.varno,ps.stkod,ps.kod,ps.stktip\r\n\r\n\r\n                IF @@ERROR > 0\r\n                               ROLLBACK TRAN PM1\r\n                ELSE\r\n                               COMMIT TRAN PM1\r\n\r\n\r\n\r\n  exec  PomVardi_Evrak_Kont\r\n\r\nSET NOCOUNT OFF\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "pomvarozet",
    "definition": "CREATE PROCEDURE [dbo].pomvarozet @varno float,@tip varchar(10),@tipdty varchar(10)\r\nAS\r\nBEGIN\r\n\r\ndeclare @sql nvarchar(500)\r\ndeclare @acik float\r\ndeclare @fazla float\r\ndeclare @perkod varchar(50)\r\ndeclare @perad varchar(50)\r\ndeclare @yertip varchar(20)\r\n\r\nset @yertip='pomvardimas'\r\n\r\nSET NOCOUNT ON\r\n\r\nif object_id( 'tempdb..##pomvardiozet' ) is null\r\nCREATE TABLE [dbo].[##pomvardiozet] (\r\n  [id] numeric(18, 0) IDENTITY(1, 1) NOT NULL,\r\n  [varno] float NOT NULL,\r\n  [perkod] varchar(30) COLLATE Turkish_CI_AS NULL,\r\n  [perad] varchar(50) COLLATE Turkish_CI_AS NULL,\r\n  [ada] varchar(50) COLLATE Turkish_CI_AS NULL,\r\n  [grs] float DEFAULT 0 NULL,\r\n  [cks] float DEFAULT 0 NULL,\r\n  [ickkod] varchar(10) COLLATE Turkish_CI_AS NULL,\r\n  [ickad] varchar(50) COLLATE Turkish_CI_AS NULL,\r\n  [sr] float NULL,\r\n  PRIMARY KEY CLUSTERED ([id], [varno]))\r\n\r\n\r\ndelete from ##pomvardiozet where varno=@varno\r\n\r\n/*\r\nAKSAT\r\nVERAT\r\nVERBT\r\nVEROT\r\nPOSST\r\nMALST\r\nNAKTS\r\nODETT\r\nCAROD\r\nPEROD\r\nPRKOD\r\nTAHTT\r\nCARTH\r\nPERTH\r\nPRKTH\r\nGELIR\r\nGIDER\r\n\r\n*/\r\n\r\n\r\nif @tip='per'\r\nbegin\r\n\r\nDECLARE vardiperx CURSOR LOCAL FOR SELECT per,perad \r\nFROM pomvardiper with (nolock) where varno=@varno and sil=0\r\n\r\n OPEN vardiperx\r\n FETCH NEXT FROM vardiperx INTO  @perkod,@perad\r\n WHILE @@FETCH_STATUS <> -1\r\n BEGIN\r\n\r\n insert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\n select @varno,'AKSAT','Akaryakıt Sayaçlı Satış Tutarı',1,@perkod,@perad,isnull(sum(tutar),0),0 \r\n from pomvardisayac with (nolock) where varno=@varno and sil=0 and perkod=@perkod\r\n\r\ninsert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'VERAT','Veresiye Alacak Tutarı',2.0,@perkod,@perad,\r\nisnull(sum(toptut-(fiyfarktop+vadfarktop)),0),0 from veresimas as m with (nolock)\r\nwhere varno=@varno and fistip='FISALCSAT' and sil=0 and \r\nm.perkod=@perkod and m.ototag=0 and yertip=@yertip and isnull(m.fis_alc_kocan,0)=0\r\n\r\n\r\ninsert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'VERAT','Veresiye Alacak Tutarı',2.0,@perkod,@perad,\r\nisnull(sum(toptut-(fiyfarktop+vadfarktop)),0),0 from veresimas as m with (nolock)\r\nwhere varno=@varno and fistip='FISALCSAT' and sil=0 and \r\nm.perkod=@perkod and m.ototag=0 and yertip=@yertip and isnull(m.fis_alc_kocan,0)=1\r\n\r\n\r\n\r\n UPDATE ##pomvardiozet set cks=cks+cikan from ##pomvardiozet as t join\r\n (select isnull(sum(toptut-(fiyfarktop+vadfarktop)),0) cikan \r\n from veresimas as m with (nolock) where varno=@varno and fistip='FISALCSAT' and sil=0 \r\n and m.perkod=@perkod and m.ototag=0 and yertip=@yertip \r\n and isnull(m.fis_alc_kocan,0)=1 )\r\n dt on t.sr=2\r\n\r\n\r\n\r\n\r\n\r\ninsert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'VERBT','Veresiye Borç Tutarı',2.1,@perkod,@perad,0,isnull(sum(toptut-(fiyfarktop+vadfarktop)),0) from veresimas\r\nwith (nolock) where varno=@varno and fistip='FISVERSAT' and sil=0 and perkod=@perkod and ototag=0 and yertip=@yertip\r\n\r\ninsert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'VEROT','Otomasyon Tutarı',2.2,@perkod,@perad,0,isnull(sum(toptut-(fiyfarktop+vadfarktop)),0) from veresimas\r\nwith (nolock) where varno=@varno and sil=0 and perkod=@perkod and ototag>0 and yertip=@yertip\r\n\r\ninsert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'POSST','Pos Satış Tutarı',3,@perkod,@perad,\r\nisnull(sum(case when carslip=1 then (giren*kur) else 0 end ),0),\r\nisnull(sum(giren*kur),0) from poshrk with (nolock)\r\nwhere varno=@varno and sil=0 and perkod=@perkod and yertip=@yertip\r\n\r\n\r\ninsert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'MALST','Yağ - Emtia Satış Tutarı',4,@perkod,@perad,isnull(sum(tutar),0),0 from emtiasat\r\nwith (nolock) where varno=@varno and sil=0 and perkod=@perkod and yertip=@yertip\r\n\r\n\r\ninsert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'NAKTS','Nakit Teslimat Tutarı',5,@perkod,@perad,0,isnull(sum(giren*kur),0) from kasahrk\r\nwith (nolock) where varno=@varno and sil=0 and perkod=@perkod and yertip=@yertip and islmhrk='TES' and masterid=0\r\n\r\nif @tipdty='genel'\r\ninsert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'ODETT','Ödeme Tutarı',6,@perkod,@perad,0,isnull(sum(cikan*kur),0) from kasahrk\r\nwith (nolock) where varno=@varno and ((islmtip='ODE' and cartip<>'gelgidkart') or (islmtip='BNK' and islmhrk='YTN') )\r\nand sil=0 and perkod=@perkod and yertip=@yertip\r\n\r\n\r\nif @tipdty='detay'\r\nbegin\r\n\r\ninsert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nvalues (@varno,'ODETT','Ödeme Tutarı',6,@perkod,@perad,0,0)\r\n\r\n\r\ninsert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'CAROD','Cari Ödemeler',8,@perkod,@perad,0,isnull(sum(cikan*kur),0) from kasahrk\r\nwith (nolock) where varno=@varno and (islmtip='ODE' and cartip='carikart') and sil=0 and perkod=@perkod and yertip=@yertip\r\n\r\n\r\ninsert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'PEROD','Personel Ödemeler',10,@perkod,@perad,0,isnull(sum(cikan*kur),0) from kasahrk\r\nwith (nolock) where varno=@varno and (islmtip='ODE' and cartip='perkart') and sil=0 and perkod=@perkod and yertip=@yertip\r\n\r\nend;\r\n\r\n\r\nif @tipdty='genel'\r\nbegin\r\ninsert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'TAHTT','Tahsilat Tutarı',7,@perkod,@perad,isnull(sum(giren*kur),0),0 from kasahrk\r\nwith (nolock) where varno=@varno and ((islmtip='TAH' and cartip<>'gelgidkart') or (islmtip='BNK' and islmhrk='CKN') )\r\nand sil=0 and perkod=@perkod and yertip=@yertip\r\n\r\nend;\r\n\r\n\r\nif @tipdty='detay'\r\nbegin\r\ninsert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nvalues (@varno,'TAHTT','Tahsilat Tutarı',7,@perkod,@perad,0,0);\r\n\r\n\r\ninsert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'CARTH','Cari Tahsilat',9,@perkod,@perad,isnull(sum(giren*kur),0),0 from kasahrk\r\nwith (nolock) where varno=@varno and (islmtip='TAH' and cartip='carikart')\r\nand sil=0 and perkod=@perkod and yertip=@yertip\r\n\r\ninsert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'PERTH','Personel Tahsilat',11,@perkod,@perad,isnull(sum(giren*kur),0),0 from kasahrk\r\nwith (nolock) where varno=@varno and (islmtip='TAH' and cartip='perkart')\r\nand sil=0 and perkod=@perkod and yertip=@yertip\r\n\r\n\r\ninsert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'PRKTH','Perakende Tahsilat',13,@perkod,@perad,isnull(sum(giren*kur),0),0 from kasahrk\r\nwith (nolock) where varno=@varno and (islmtip='TAH' and cartip='perakendekart')\r\nand sil=0 and perkod=@perkod and yertip=@yertip\r\n\r\nend;\r\n\r\n\r\ninsert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'GELIR','Gelir Tutarı',20,@perkod,@perad,isnull(sum(giren*kur),0),0 from kasahrk\r\nwith (nolock)where varno=@varno and islmtip='TAH' and cartip='gelgidkart' and sil=0 and perkod=@perkod\r\nand yertip=@yertip\r\n\r\n\r\ninsert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'GIDER','Gider Tutarı',21,@perkod,@perad,0,isnull(sum(cikan*kur),0) from kasahrk\r\nwith (nolock) where varno=@varno and islmtip='ODE' and cartip='gelgidkart' and sil=0 and perkod=@perkod\r\nand yertip=@yertip\r\n\r\nif @tipdty='detay'\r\nbegin\r\n\r\ninsert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'CEKST','Çek-Senet',25,@perkod,@perad,\r\nisnull(sum(case when cartip<>'vardicek' then giren*kur else 0 end),0),\r\nisnull(sum(giren*kur),0) from cekkart\r\nwith (nolock) where varno=@varno and sil=0 and perkod=@perkod and yertip=@yertip\r\n\r\ninsert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'BNKCK','Banka Çekilen',26,@perkod,@perad,isnull(sum(giren*kur),0),0 from kasahrk\r\nwith (nolock) where varno=@varno and islmtip='BNK' and islmhrk='CKN' and sil=0 and perkod=@perkod and yertip=@yertip\r\n\r\ninsert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'BNKYT','Banka Yatan',27,@perkod,@perad,0,isnull(sum(cikan*kur),0) from kasahrk\r\nwith (nolock) where varno=@varno and islmtip='BNK' and islmhrk='YTN' and sil=0 and perkod=@perkod and yertip=@yertip\r\n\r\n\r\nend;\r\n\r\n\r\n\r\nif @tipdty='genel' /* diğer satışlar olusturuluyor */\r\n begin\r\n\r\n    insert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\n    select @varno,'DIGST','Diğer Tutarlar',39,@perkod,@perad,\r\n    isnull(sum(case when cartip<>'vardicek' then giren*kur else 0 end),0),\r\n    isnull(sum(giren*kur),0) from cekkart with (nolock)\r\n    where varno=@varno and sil=0 and perkod=@perkod and yertip=@yertip\r\n\r\n   /*\r\n     UPDATE ##pomvardiozet SET grs=grs+giren,cks=cks+cikan from ##pomvardiozet as t join\r\n     (select isnull(sum(giren*kur),0) as giren ,0 cikan from kasahrk\r\n      where varno=@varno and islmtip='BNK' and islmhrk='CKN' and sil=0 and\r\n      perkod=@perkod and yertip=@yertip ) dt on t.sr=39\r\n\r\n     UPDATE ##pomvardiozet SET grs=grs+giren,cks=cks+cikan from ##pomvardiozet as t join\r\n     (select 0 as giren,isnull(sum(cikan*kur),0) cikan   from kasahrk\r\n     where varno=@varno and islmtip='BNK' and islmhrk='YTN' and sil=0 and\r\n     perkod=@perkod and yertip=@yertip ) dt on t.sr=39\r\n    */ \r\n\r\n end\r\n\r\n\r\n\r\ninsert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'ARATOP','Ara Toplam',40,@perkod,@perad,sum(grs),sum(cks) \r\nfrom ##pomvardiozet where varno=@varno and perkod=@perkod\r\n\r\n\r\nselect @acik=(grs-cks) from ##pomvardiozet \r\nwhere ickkod='ARATOP' and varno=@varno and perkod=@perkod \r\n\r\nif @acik<0\r\nbegin\r\nset @fazla=0\r\nset @acik=-@acik\r\nend\r\nelse\r\nbegin\r\nset @fazla=@acik\r\nset @acik=0\r\nend;\r\n\r\ninsert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nvalues(@varno,'ACKFAZ','Fark',41,@perkod,@perad,@acik,@fazla) \r\n\r\nselect @acik=sum(grs),@fazla=sum(cks) from \r\n##pomvardiozet where (ickkod='ARATOP' or ickkod='ACKFAZ') \r\nand varno=@varno and perkod=@perkod\r\n\r\n\r\ninsert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nvalues(@varno,'GENTOP','Genel Toplam',42,@perkod,@perad,@acik,@fazla) \r\n\r\n\r\n\r\n  FETCH NEXT FROM vardiperx INTO  @perkod,@perad\r\n  END\r\n  CLOSE vardiperx\r\n  DEALLOCATE vardiperx\r\n\r\n\r\nend/*personele gore */\r\n\r\n\r\n/*----ada göre */\r\n\r\nif @tip='ada'\r\nbegin\r\n\r\n DECLARE vardiperx CURSOR LOCAL FOR \r\n SELECT cast(adaid as varchar) kod,adad ad \r\n FROM pomvardisayac with (nolock) where varno=@varno and sil=0\r\n group by adaid,adad\r\n\r\n OPEN vardiperx\r\n FETCH NEXT FROM vardiperx INTO  @perkod,@perad\r\n WHILE @@FETCH_STATUS <> -1\r\n BEGIN\r\n\r\n insert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\n select @varno,'AKSAT','Akaryakıt Sayaçlı Satış Tutarı',1,@perkod,@perad,isnull(sum(tutar),0),0 from pomvardisayac\r\n with (nolock) where varno=@varno and sil=0 and adaid=@perkod\r\n\r\n\r\ninsert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'VERAT','Veresiye Alacak Tutarı',2.0,@perkod,@perad,isnull(sum(toptut-(fiyfarktop+vadfarktop)),0),0 from veresimas\r\n with (nolock) where varno=@varno and fistip='FISALCSAT' and sil=0 and adaid=@perkod and ototag=0 and yertip=@yertip\r\n\r\n\r\n UPDATE ##pomvardiozet set cks=cks+cikan from ##pomvardiozet as t join\r\n (select isnull(sum(toptut-(fiyfarktop+vadfarktop)),0) cikan \r\n from veresimas as m with (nolock) where varno=@varno and fistip='FISALCSAT' and sil=0 \r\n and m.adaid=@perkod and m.ototag=0 and yertip=@yertip \r\n and isnull(m.fis_alc_kocan,0)=1 )\r\n dt on t.sr=2\r\n\r\n\r\n\r\n\r\ninsert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'VERBT','Veresiye Borç Tutarı',2.1,@perkod,@perad,0,isnull(sum(toptut-(fiyfarktop+vadfarktop)),0) from veresimas\r\nwith (nolock) where varno=@varno and fistip='FISVERSAT' and sil=0 and adaid=@perkod and ototag=0 and yertip=@yertip\r\n\r\n\r\ninsert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'VEROT','Otomasyon Tutarı',2.2,@perkod,@perad,0,isnull(sum(toptut-(fiyfarktop+vadfarktop)),0) from veresimas\r\nwith (nolock) where varno=@varno and sil=0 and adaid=@perkod and ototag>0 and yertip=@yertip\r\n\r\n\r\n\r\n\r\ninsert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'POSST','Pos Satış Tutarı',3,@perkod,@perad,\r\nisnull(sum(case when carslip=1 then (giren*kur) else 0 end ),0),\r\nisnull(sum(giren*kur),0) from poshrk with (nolock)\r\nwhere varno=@varno and sil=0 and adaid=@perkod and yertip=@yertip\r\n\r\n\r\ninsert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'MALST','Yağ - Emtia Satış Tutarı',4,@perkod,@perad,isnull(sum(tutar),0),0 from emtiasat\r\nwith (nolock) where varno=@varno and sil=0 and adaid=@perkod and yertip=@yertip\r\n\r\n\r\ninsert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'NAKTS','Nakit Teslimat Tutarı',5,@perkod,@perad,0,isnull(sum(giren*kur),0) from kasahrk\r\nwith (nolock) where varno=@varno and sil=0 and adaid=@perkod and yertip=@yertip\r\n\r\nif @tipdty='genel'\r\ninsert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'ODETT','Ödeme Tutarı',6,@perkod,@perad,0,isnull(sum(cikan*kur),0) from kasahrk\r\nwith (nolock) where varno=@varno and ((islmtip='ODE' and cartip<>'gelgidkart') or (islmtip='BNK' and islmhrk='YTN') )\r\nand sil=0 and adaid=@perkod and yertip=@yertip\r\n\r\nif @tipdty='detay'\r\nbegin\r\n\r\ninsert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nvalues (@varno,'ODETT','Ödeme Tutarı',6,@perkod,@perad,0,0)\r\n\r\n\r\ninsert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'CAROD','Cari Ödemeler',8,@perkod,@perad,0,isnull(sum(cikan*kur),0) from kasahrk\r\nwith (nolock) where varno=@varno and (islmtip='ODE' and cartip='carikart') and sil=0 and adaid=@perkod\r\nand yertip=@yertip\r\n\r\n\r\ninsert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'PEROD','Personel Ödemeler',10,@perkod,@perad,0,isnull(sum(cikan*kur),0) from kasahrk\r\nwith (nolock) where varno=@varno and (islmtip='ODE' and cartip='perkart') and sil=0 and adaid=@perkod\r\nand yertip=@yertip\r\n\r\nend\r\n\r\n\r\nif @tipdty='genel'\r\nbegin\r\ninsert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'TAHTT','Tahsilat Tutarı',7,@perkod,@perad,isnull(sum(giren*kur),0),0 from kasahrk\r\nwith (nolock) where varno=@varno and ((islmtip='TAH' and cartip<>'gelgidkart') or (islmtip='BNK' and islmhrk='CKN') )\r\nand sil=0 and adaid=@perkod and yertip=@yertip\r\nend;\r\n\r\n\r\nif @tipdty='detay'\r\nbegin\r\ninsert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nvalues (@varno,'TAHTT','Tahsilat Tutarı',7,@perkod,@perad,0,0);\r\n\r\n\r\ninsert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'CARTH','Cari Tahsilat',9,@perkod,@perad,isnull(sum(giren*kur),0),0 from kasahrk\r\nwith (nolock) where varno=@varno and (islmtip='TAH' and cartip='carikart')\r\nand sil=0 and adaid=@perkod and yertip=@yertip\r\n\r\ninsert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'PERTH','Personel Tahsilat',11,@perkod,@perad,isnull(sum(giren*kur),0),0 from kasahrk\r\nwith (nolock) where varno=@varno and (islmtip='TAH' and cartip='perkart')\r\nand sil=0 and adaid=@perkod and yertip=@yertip\r\n\r\n\r\ninsert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'PRKTH','Perakende Tahsilat',13,@perkod,@perad,isnull(sum(giren*kur),0),0 from kasahrk\r\nwith (nolock) where varno=@varno and (islmtip='TAH' and cartip='perakendekart')\r\nand sil=0 and adaid=@perkod and yertip=@yertip\r\n\r\nend\r\n\r\n\r\n\r\ninsert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'GELIR','Gelir Tutarı',20,@perkod,@perad,isnull(sum(giren*kur),0),0 from kasahrk\r\nwith (nolock) where varno=@varno and islmtip='TAH' and cartip='gelgidkart' and sil=0 and adaid=@perkod\r\nand yertip=@yertip\r\n\r\n\r\ninsert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'GIDER','Gider Tutarı',21,@perkod,@perad,0,isnull(sum(cikan*kur),0) from kasahrk\r\nwith (nolock) where varno=@varno and islmtip='ODE' and  cartip='gelgidkart' and sil=0 and adaid=@perkod\r\nand yertip=@yertip\r\n\r\nif @tipdty='detay'\r\nbegin\r\n\r\ninsert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'CEKST','Çek-Senet',25,@perkod,@perad,\r\nisnull(sum(case when cartip<>'vardicek' then giren*kur else 0 end),0),\r\nisnull(sum(giren*kur),0) from cekkart with (nolock)\r\nwhere varno=@varno and sil=0 and adaid=@perkod and yertip=@yertip\r\n\r\ninsert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'BNKCK','Banka Çekilen',26,@perkod,@perad,isnull(sum(giren*kur),0),0 from kasahrk\r\nwith (nolock) where varno=@varno and islmtip='BNK' and islmhrk='CKN'\r\nand sil=0 and adaid=@perkod and yertip=@yertip\r\n\r\ninsert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'BNKYT','Banka Yatan',27,@perkod,@perad,0,isnull(sum(cikan*kur),0) from kasahrk\r\nwith (nolock) where varno=@varno and islmtip='BNK' and islmhrk='YTN'\r\nand sil=0 and adaid=@perkod and yertip=@yertip\r\n\r\n\r\n\r\nend;\r\n\r\n\r\n\r\ninsert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'ARATOP','Ara Toplam',40,@perkod,@perad,sum(grs),sum(cks) from ##pomvardiozet where varno=@varno and perkod=@perkod\r\n\r\n\r\nselect @acik=isnull((grs-cks),0) from ##pomvardiozet where ickkod='ARATOP' and varno=@varno and perkod=@perkod \r\n\r\nif @acik<0\r\nbegin\r\nset @fazla=0;\r\nset @acik=-@acik;\r\nend\r\nelse\r\nbegin\r\nset @fazla=@acik;\r\nset @acik=0;\r\nend;\r\n\r\ninsert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nvalues(@varno,'ACKFAZ','Fark',41,@perkod,@perad,@acik,@fazla) ;\r\n\r\nselect @acik=sum(grs),@fazla=sum(cks) from ##pomvardiozet where (ickkod='ARATOP' or ickkod='ACKFAZ') \r\nand varno=@varno and perkod=@perkod\r\n\r\n\r\ninsert into ##pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nvalues(@varno,'GENTOP','Genel Toplam',42,@perkod,@perad,@acik,@fazla) ;\r\n\r\n\r\n\r\n  FETCH NEXT FROM vardiperx INTO  @perkod,@perad\r\n  END\r\n  CLOSE vardiperx\r\n  DEALLOCATE vardiperx\r\n\r\n\r\nend/*ada gore */\r\n\r\n\r\nSET NOCOUNT OFF\r\n\r\n/*select sr as id,varno,ickkod,ickad,sr,sum(grs) grs,sum(cks) cks from pomvardiozet */\r\n/*where varno=@varno group by varno,ickkod,ickad,sr order by sr */\r\n\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "pomvarozet_Yeni",
    "definition": "CREATE PROCEDURE [dbo].[pomvarozet_Yeni] \r\n@varno float,\r\n@tip varchar(10),\r\n@tipdty varchar(10)\r\nAS\r\nBEGIN\r\n\r\ndeclare @sql nvarchar(500)\r\ndeclare @acik float\r\ndeclare @fazla float\r\ndeclare @perkod varchar(50)\r\ndeclare @perad varchar(50)\r\ndeclare @yertip varchar(20)\r\n\r\n\r\nset @yertip='pomvardimas'\r\n\r\nSET NOCOUNT ON\r\n\r\n\r\n  declare @Table_Pomvardiozet TABLE (\r\n  [id] numeric(18, 0) IDENTITY(1, 1) NOT NULL,\r\n  [varno] float NOT NULL,\r\n  [perkod] varchar(30) COLLATE Turkish_CI_AS NULL,\r\n  [perad] varchar(50) COLLATE Turkish_CI_AS NULL,\r\n  [ada] varchar(50) COLLATE Turkish_CI_AS NULL,\r\n  [grs] float DEFAULT 0 NULL,\r\n  [cks] float DEFAULT 0 NULL,\r\n  [ickkod] varchar(10) COLLATE Turkish_CI_AS NULL,\r\n  [ickad] varchar(50) COLLATE Turkish_CI_AS NULL,\r\n  [sr] float NULL,\r\n  PRIMARY KEY CLUSTERED ([id], [varno]))\r\n \r\n  \r\n\r\n/*\r\nAKSAT\r\nVERAT\r\nVERBT\r\nVEROT\r\nPOSST\r\nMALST\r\nNAKTS\r\nODETT\r\nCAROD\r\nPEROD\r\nPRKOD\r\nTAHTT\r\nCARTH\r\nPERTH\r\nPRKTH\r\nGELIR\r\nGIDER\r\n\r\n*/\r\n\r\n\r\nif @tip='per'\r\nbegin\r\n\r\nDECLARE vardiperx CURSOR LOCAL FOR SELECT per,perad \r\n FROM pomvardiper with (nolock) where varno=@varno and sil=0\r\n\r\n OPEN vardiperx\r\n FETCH NEXT FROM vardiperx INTO  @perkod,@perad\r\n WHILE @@FETCH_STATUS <> -1\r\n BEGIN\r\n\r\n insert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\n select @varno,'AKSAT','Akaryakıt Sayaçlı Satış Tutarı',1,@perkod,@perad,isnull(sum(tutar),0),0 \r\n from pomvardisayac with (nolock) where varno=@varno and sil=0 and perkod=@perkod\r\n\r\ninsert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'VERAT','Veresiye Alacak Tutarı',2.0,@perkod,@perad,\r\nisnull(sum(toptut-(isktop)),0),0 from veresimas as m with (nolock)\r\nwhere varno=@varno and fistip='FISALCSAT' and sil=0 and \r\nm.perkod=@perkod and m.ototag=0 and yertip=@yertip and isnull(m.fis_alc_kocan,0)=0\r\n\r\n\r\ninsert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'VERAT','Veresiye Alacak Tutarı',2.0,@perkod,@perad,\r\nisnull(sum(toptut-(isktop)),0),0 from veresimas as m with (nolock)\r\nwhere varno=@varno and fistip='FISALCSAT' and sil=0 and \r\nm.perkod=@perkod and m.ototag=0 and yertip=@yertip and isnull(m.fis_alc_kocan,0)=1\r\n\r\n\r\n\r\n UPDATE @Table_Pomvardiozet set cks=cks+cikan from @Table_Pomvardiozet as t join\r\n (select isnull(sum(toptut-(isktop)),0) cikan \r\n from veresimas as m with (nolock) where varno=@varno and fistip='FISALCSAT' and sil=0 \r\n and m.perkod=@perkod and m.ototag=0 and yertip=@yertip \r\n and isnull(m.fis_alc_kocan,0)=1 )\r\n dt on t.sr=2\r\n\r\n\r\n\r\n\r\n\r\ninsert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'VERBT','Veresiye Borç Tutarı',2.1,@perkod,@perad,0,isnull(sum(toptut-(isktop)),0) from veresimas\r\nwith (nolock) where varno=@varno and fistip='FISVERSAT' and sil=0 and perkod=@perkod and ototag=0 and yertip=@yertip\r\n\r\ninsert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'VEROT','Otomasyon Tutarı',2.2,@perkod,@perad,0,isnull(sum(toptut-(isktop)),0) from veresimas\r\nwith (nolock) where varno=@varno and sil=0 and perkod=@perkod and ototag>0 and yertip=@yertip\r\n\r\ninsert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'POSST','Pos Satış Tutarı',3,@perkod,@perad,\r\nisnull(sum(case when carslip=1 then (giren*kur) else 0 end ),0),\r\nisnull(sum(giren*kur),0) from poshrk with (nolock)\r\nwhere varno=@varno and sil=0 and perkod=@perkod and yertip=@yertip\r\n\r\n\r\ninsert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'MALST','Yağ - Emtia Satış Tutarı',4,@perkod,@perad,isnull(sum(tutar),0),0 from emtiasat\r\nwith (nolock) where varno=@varno and sil=0 and perkod=@perkod and yertip=@yertip\r\n\r\n\r\ninsert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'NAKTS','Nakit Teslimat Tutarı',5,@perkod,@perad,0,isnull(sum(giren*kur),0) from kasahrk\r\nwith (nolock) where varno=@varno and sil=0 and perkod=@perkod and yertip=@yertip and islmhrk='TES' and masterid=0\r\n\r\nif @tipdty='genel'\r\n  insert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\n  select @varno,'ODETT','Ödeme Tutarı',6,@perkod,@perad,0,isnull(sum(cikan*kur),0) from kasahrk\r\n  with (nolock) where varno=@varno and ((islmtip='ODE' and cartip<>'gelgidkart') or (islmtip='BNK' and islmhrk='YTN') )\r\n  and sil=0 and perkod=@perkod and yertip=@yertip\r\n\r\n\r\nif @tipdty='detay'\r\nbegin\r\n\r\ninsert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nvalues (@varno,'ODETT','Ödeme Tutarı',6,@perkod,@perad,0,0)\r\n\r\n\r\ninsert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'CAROD','Cari Ödemeler',8,@perkod,@perad,0,isnull(sum(cikan*kur),0) from kasahrk\r\nwith (nolock) where varno=@varno and (islmtip='ODE' and cartip='carikart') and sil=0 and perkod=@perkod and yertip=@yertip\r\n\r\n\r\ninsert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'PEROD','Personel Ödemeler',10,@perkod,@perad,0,isnull(sum(cikan*kur),0) from kasahrk\r\nwith (nolock) where varno=@varno and (islmtip='ODE' and cartip='perkart') and sil=0 and perkod=@perkod and yertip=@yertip\r\n\r\nend\r\n\r\n \r\n if @tipdty='genel'\r\n  begin\r\n  insert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\n  select @varno,'TAHTT','Tahsilat Tutarı',7,@perkod,@perad,isnull(sum(giren*kur),0),0 from kasahrk \r\n  with (nolock) where varno=@varno and ((islmtip='TAH' and islmhrk<>'TES' and cartip<>'gelgidkart') or (islmtip='BNK' and islmhrk='CKN') )\r\n  and sil=0 and perkod=@perkod and yertip=@yertip \r\n  \r\n end\r\n \r\n\r\n  if @tipdty='detay'\r\n  begin\r\n    insert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\n    values (@varno,'TAHTT','Tahsilat Tutarı',7,@perkod,@perad,0,0)\r\n\r\n\r\n    insert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\n    select @varno,'CARTH','Cari Tahsilat',9,@perkod,@perad,isnull(sum(giren*kur),0),0 from kasahrk\r\n    with (nolock) where varno=@varno and (islmtip='TAH' and cartip='carikart')\r\n    and sil=0 and perkod=@perkod and yertip=@yertip\r\n\r\n    insert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\n    select @varno,'PERTH','Personel Tahsilat',11,@perkod,@perad,isnull(sum(giren*kur),0),0 from kasahrk\r\n    with (nolock) where varno=@varno and (islmtip='TAH' and cartip='perkart')\r\n    and sil=0 and perkod=@perkod and yertip=@yertip\r\n\r\n\r\n    insert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\n    select @varno,'PRKTH','Perakende Tahsilat',13,@perkod,@perad,isnull(sum(giren*kur),0),0 from kasahrk\r\n    with (nolock) where varno=@varno and (islmtip='TAH' and cartip='perakendekart')\r\n    and sil=0 and perkod=@perkod and yertip=@yertip\r\n\r\n  end\r\n\r\n\r\ninsert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'GELIR','Gelir Tutarı',20,@perkod,@perad,isnull(sum(giren*kur),0),0 from kasahrk\r\nwith (nolock)where varno=@varno and islmtip='TAH' and cartip='gelgidkart' and sil=0 and perkod=@perkod\r\nand yertip=@yertip\r\n\r\n\r\ninsert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'GIDER','Gider Tutarı',21,@perkod,@perad,0,isnull(sum(cikan*kur),0) from kasahrk\r\nwith (nolock) where varno=@varno and islmtip='ODE' and cartip='gelgidkart' and sil=0 and perkod=@perkod\r\nand yertip=@yertip\r\n\r\nif @tipdty='detay'\r\nbegin\r\n\r\ninsert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'CEKST','Çek-Senet',25,@perkod,@perad,\r\nisnull(sum(case when cartip<>'vardicek' then giren*kur else 0 end),0),\r\nisnull(sum(giren*kur),0) from cekkart\r\nwith (nolock) where varno=@varno and sil=0 and perkod=@perkod and yertip=@yertip\r\n\r\ninsert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'BNKCK','Banka Çekilen',26,@perkod,@perad,isnull(sum(giren*kur),0),0 from kasahrk\r\nwith (nolock) where varno=@varno and islmtip='BNK' and islmhrk='CKN' and sil=0 and perkod=@perkod and yertip=@yertip\r\n\r\ninsert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'BNKYT','Banka Yatan',27,@perkod,@perad,0,isnull(sum(cikan*kur),0) from kasahrk\r\nwith (nolock) where varno=@varno and islmtip='BNK' and islmhrk='YTN' and sil=0 and perkod=@perkod and yertip=@yertip\r\n\r\n\r\ninsert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'BNKEF','Banka Gelen EFT',28,@perkod,@perad,0,isnull(sum(borc*kur),0) from bankahrk\r\nwith (nolock) where varno=@varno and islmtip='BNK' and islmhrk='C-B' and sil=0 and carkod='VRDHES'\r\nand perkod=@perkod and yertip=@yertip\r\n\r\n\r\ninsert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'BNKEF','Banka Giden EFT',29,@perkod,@perad,isnull(sum(alacak*kur),0),0 from bankahrk\r\nwith (nolock) where varno=@varno and islmtip='BNK' and islmhrk='B-C' and sil=0 and carkod='VRDHES'\r\nand perkod=@perkod and yertip=@yertip\r\n\r\nend\r\n\r\n\r\n\r\nif @tipdty='genel' /* diğer satışlar olusturuluyor */\r\n begin\r\n\r\n    insert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\n    select @varno,'DIGST','Diğer Tutarlar',39,@perkod,@perad,\r\n    isnull(sum(case when cartip<>'vardicek' then giren*kur else 0 end),0),\r\n    isnull(sum(giren*kur),0) from cekkart with (nolock)\r\n    where varno=@varno and sil=0 and perkod=@perkod and yertip=@yertip\r\n   \r\n    \r\n     UPDATE @Table_Pomvardiozet SET grs=grs+giren,cks=cks+cikan from @Table_Pomvardiozet as t join\r\n     (select isnull(sum(alacak*kur),0) as giren,isnull(sum(borc*kur),0) cikan from bankahrk\r\n      where varno=@varno and islmtip='BNK' and islmhrk in ('C-B','B-C') and sil=0 and carkod='VRDHES' \r\n      and perkod=@perkod and yertip=@yertip ) dt on t.sr=39 and t.perkod=@perkod\r\n\r\n\r\n   /*\r\n     UPDATE @Table_Pomvardiozet SET grs=grs+giren,cks=cks+cikan from @Table_Pomvardiozet as t join\r\n     (select isnull(sum(giren*kur),0) as giren ,0 cikan from kasahrk\r\n      where varno=@varno and islmtip='BNK' and islmhrk='CKN' and sil=0 and\r\n      perkod=@perkod and yertip=@yertip ) dt on t.sr=39\r\n\r\n     UPDATE @Table_Pomvardiozet SET grs=grs+giren,cks=cks+cikan from @Table_Pomvardiozet as t join\r\n     (select 0 as giren,isnull(sum(cikan*kur),0) cikan   from kasahrk\r\n     where varno=@varno and islmtip='BNK' and islmhrk='YTN' and sil=0 and\r\n     perkod=@perkod and yertip=@yertip ) dt on t.sr=39\r\n    */ \r\n\r\n end\r\n\r\n\r\n\r\ninsert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'ARATOP','Ara Toplam',40,@perkod,@perad,sum(grs),sum(cks) \r\nfrom @Table_Pomvardiozet where varno=@varno and perkod=@perkod\r\n\r\n\r\nselect @acik=(grs-cks) from @Table_Pomvardiozet \r\nwhere ickkod='ARATOP' and varno=@varno and perkod=@perkod \r\n\r\nif @acik<0\r\nbegin\r\nset @fazla=0\r\nset @acik=-@acik\r\nend\r\nelse\r\nbegin\r\nset @fazla=@acik\r\nset @acik=0\r\nend\r\n\r\ninsert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nvalues(@varno,'ACKFAZ','Fark',41,@perkod,@perad,@acik,@fazla) \r\n\r\nselect @acik=sum(grs),@fazla=sum(cks) from \r\n@Table_Pomvardiozet where (ickkod='ARATOP' or ickkod='ACKFAZ') \r\nand varno=@varno and perkod=@perkod\r\n\r\n\r\ninsert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nvalues(@varno,'GENTOP','Genel Toplam',42,@perkod,@perad,@acik,@fazla) \r\n\r\n\r\n\r\n  FETCH NEXT FROM vardiperx INTO  @perkod,@perad\r\n  END\r\n  CLOSE vardiperx\r\n  DEALLOCATE vardiperx\r\n\r\n\r\nend/*personele gore */\r\n\r\n\r\n/*----ada göre */\r\n\r\nif @tip='ada'\r\nbegin\r\n\r\n DECLARE vardiperx CURSOR LOCAL FOR \r\n SELECT cast(adaid as varchar) kod,adad ad \r\n FROM pomvardisayac with (nolock) where varno=@varno and sil=0\r\n group by adaid,adad\r\n\r\n OPEN vardiperx\r\n FETCH NEXT FROM vardiperx INTO  @perkod,@perad\r\n WHILE @@FETCH_STATUS <> -1\r\n BEGIN\r\n\r\n insert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\n select @varno,'AKSAT','Akaryakıt Sayaçlı Satış Tutarı',1,@perkod,@perad,isnull(sum(tutar),0),0 from pomvardisayac\r\n with (nolock) where varno=@varno and sil=0 and adaid=@perkod\r\n\r\n\r\ninsert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'VERAT','Veresiye Alacak Tutarı',2.0,@perkod,@perad,isnull(sum(toptut-(isktop)),0),0 from veresimas\r\n with (nolock) where varno=@varno and fistip='FISALCSAT' and sil=0 and adaid=@perkod and ototag=0 and yertip=@yertip\r\n\r\n\r\n UPDATE @Table_Pomvardiozet set cks=cks+cikan from @Table_Pomvardiozet as t join\r\n (select isnull(sum(toptut-(isktop)),0) cikan \r\n from veresimas as m with (nolock) where varno=@varno and fistip='FISALCSAT' and sil=0 \r\n and m.adaid=@perkod and m.ototag=0 and yertip=@yertip \r\n and isnull(m.fis_alc_kocan,0)=1 )\r\n dt on t.sr=2\r\n\r\n\r\n\r\n\r\ninsert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'VERBT','Veresiye Borç Tutarı',2.1,@perkod,@perad,0,isnull(sum(toptut-(isktop)),0) from veresimas\r\nwith (nolock) where varno=@varno and fistip='FISVERSAT' and sil=0 and adaid=@perkod and ototag=0 and yertip=@yertip\r\n\r\n\r\ninsert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'VEROT','Otomasyon Tutarı',2.2,@perkod,@perad,0,isnull(sum(toptut-(isktop)),0) from veresimas\r\nwith (nolock) where varno=@varno and sil=0 and adaid=@perkod and ototag>0 and yertip=@yertip\r\n\r\n\r\n\r\n\r\ninsert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'POSST','Pos Satış Tutarı',3,@perkod,@perad,\r\nisnull(sum(case when carslip=1 then (giren*kur) else 0 end ),0),\r\nisnull(sum(giren*kur),0) from poshrk with (nolock)\r\nwhere varno=@varno and sil=0 and adaid=@perkod and yertip=@yertip\r\n\r\n\r\ninsert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'MALST','Yağ - Emtia Satış Tutarı',4,@perkod,@perad,isnull(sum(tutar),0),0 from emtiasat\r\nwith (nolock) where varno=@varno and sil=0 and adaid=@perkod and yertip=@yertip\r\n\r\n\r\ninsert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'NAKTS','Nakit Teslimat Tutarı',5,@perkod,@perad,0,isnull(sum(giren*kur),0) from kasahrk\r\nwith (nolock) where varno=@varno and sil=0 and adaid=@perkod and yertip=@yertip\r\n\r\nif @tipdty='genel'\r\ninsert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'ODETT','Ödeme Tutarı',6,@perkod,@perad,0,isnull(sum(cikan*kur),0) from kasahrk\r\nwith (nolock) where varno=@varno and ((islmtip='ODE' and cartip<>'gelgidkart') or (islmtip='BNK' and islmhrk='YTN') )\r\nand sil=0 and adaid=@perkod and yertip=@yertip\r\n\r\nif @tipdty='detay'\r\nbegin\r\n\r\ninsert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nvalues (@varno,'ODETT','Ödeme Tutarı',6,@perkod,@perad,0,0)\r\n\r\n\r\ninsert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'CAROD','Cari Ödemeler',8,@perkod,@perad,0,isnull(sum(cikan*kur),0) from kasahrk\r\nwith (nolock) where varno=@varno and (islmtip='ODE' and cartip='carikart') and sil=0 and adaid=@perkod\r\nand yertip=@yertip\r\n\r\n\r\ninsert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'PEROD','Personel Ödemeler',10,@perkod,@perad,0,isnull(sum(cikan*kur),0) from kasahrk\r\nwith (nolock) where varno=@varno and (islmtip='ODE' and cartip='perkart') and sil=0 and adaid=@perkod\r\nand yertip=@yertip\r\n\r\nend\r\n\r\n\r\nif @tipdty='genel'\r\nbegin\r\ninsert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'TAHTT','Tahsilat Tutarı',7,@perkod,@perad,isnull(sum(giren*kur),0),0 from kasahrk\r\nwith (nolock) where varno=@varno and ((islmtip='TAH' and islmhrk<>'TES' and cartip<>'gelgidkart') or (islmtip='BNK' and islmhrk='CKN') )\r\nand sil=0 and adaid=@perkod and yertip=@yertip\r\nend\r\n\r\n\r\nif @tipdty='detay'\r\nbegin\r\ninsert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nvalues (@varno,'TAHTT','Tahsilat Tutarı',7,@perkod,@perad,0,0)\r\n\r\n\r\ninsert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'CARTH','Cari Tahsilat',9,@perkod,@perad,isnull(sum(giren*kur),0),0 from kasahrk\r\nwith (nolock) where varno=@varno and (islmtip='TAH' and cartip='carikart')\r\nand sil=0 and adaid=@perkod and yertip=@yertip\r\n\r\ninsert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'PERTH','Personel Tahsilat',11,@perkod,@perad,isnull(sum(giren*kur),0),0 from kasahrk\r\nwith (nolock) where varno=@varno and (islmtip='TAH' and cartip='perkart')\r\nand sil=0 and adaid=@perkod and yertip=@yertip\r\n\r\n\r\ninsert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'PRKTH','Perakende Tahsilat',13,@perkod,@perad,isnull(sum(giren*kur),0),0 from kasahrk\r\nwith (nolock) where varno=@varno and (islmtip='TAH' and cartip='perakendekart')\r\nand sil=0 and adaid=@perkod and yertip=@yertip\r\n\r\nend\r\n\r\n\r\n\r\ninsert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'GELIR','Gelir Tutarı',20,@perkod,@perad,isnull(sum(giren*kur),0),0 from kasahrk\r\nwith (nolock) where varno=@varno and islmtip='TAH' and cartip='gelgidkart' and sil=0 and adaid=@perkod\r\nand yertip=@yertip\r\n\r\n\r\ninsert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'GIDER','Gider Tutarı',21,@perkod,@perad,0,isnull(sum(cikan*kur),0) from kasahrk\r\nwith (nolock) where varno=@varno and islmtip='ODE' and  cartip='gelgidkart' and sil=0 and adaid=@perkod\r\nand yertip=@yertip\r\n\r\nif @tipdty='detay'\r\nbegin\r\n\r\ninsert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'CEKST','Çek-Senet',25,@perkod,@perad,\r\nisnull(sum(case when cartip<>'vardicek' then giren*kur else 0 end),0),\r\nisnull(sum(giren*kur),0) from cekkart with (nolock)\r\nwhere varno=@varno and sil=0 and adaid=@perkod and yertip=@yertip\r\n\r\ninsert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'BNKCK','Banka Çekilen',26,@perkod,@perad,isnull(sum(giren*kur),0),0 from kasahrk\r\nwith (nolock) where varno=@varno and islmtip='BNK' and islmhrk='CKN'\r\nand sil=0 and adaid=@perkod and yertip=@yertip\r\n\r\ninsert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'BNKYT','Banka Yatan',27,@perkod,@perad,0,isnull(sum(cikan*kur),0) from kasahrk\r\nwith (nolock) where varno=@varno and islmtip='BNK' and islmhrk='YTN'\r\nand sil=0 and adaid=@perkod and yertip=@yertip\r\n\r\n\r\n\r\nend\r\n\r\n\r\n\r\ninsert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nselect @varno,'ARATOP','Ara Toplam',40,@perkod,@perad,sum(grs),sum(cks) from @Table_Pomvardiozet where varno=@varno and perkod=@perkod\r\n\r\n\r\nselect @acik=isnull((grs-cks),0) from @Table_Pomvardiozet where ickkod='ARATOP' and varno=@varno and perkod=@perkod \r\n\r\nif @acik<0\r\nbegin\r\nset @fazla=0\r\nset @acik=-@acik\r\nend\r\nelse\r\nbegin\r\nset @fazla=@acik\r\nset @acik=0\r\nend\r\n\r\ninsert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nvalues(@varno,'ACKFAZ','Fark',41,@perkod,@perad,@acik,@fazla) \r\n\r\nselect @acik=sum(grs),@fazla=sum(cks) from @Table_Pomvardiozet where (ickkod='ARATOP' or ickkod='ACKFAZ') \r\nand varno=@varno and perkod=@perkod\r\n\r\n\r\ninsert into @Table_Pomvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\nvalues(@varno,'GENTOP','Genel Toplam',42,@perkod,@perad,@acik,@fazla) \r\n\r\n\r\n\r\n  FETCH NEXT FROM vardiperx INTO  @perkod,@perad\r\n  END\r\n  CLOSE vardiperx\r\n  DEALLOCATE vardiperx\r\n\r\n\r\nend/*ada gore */\r\n\r\n\r\nSET NOCOUNT OFF\r\n\r\n\r\n\r\n\r\n\r\n\r\n \r\n \r\n \r\n \r\n if object_id( 'tempdb..##pomvardiozet' ) is null\r\n  CREATE TABLE [dbo].[##pomvardiozet] (\r\n  [id] numeric(18, 0) IDENTITY(1, 1) NOT NULL,\r\n  [varno] float NOT NULL,\r\n  [perkod] varchar(30) COLLATE Turkish_CI_AS NULL,\r\n  [perad] varchar(50) COLLATE Turkish_CI_AS NULL,\r\n  [ada] varchar(50) COLLATE Turkish_CI_AS NULL,\r\n  [grs] float DEFAULT 0 NULL,\r\n  [cks] float DEFAULT 0 NULL,\r\n  [ickkod] varchar(10) COLLATE Turkish_CI_AS NULL,\r\n  [ickad] varchar(50) COLLATE Turkish_CI_AS NULL,\r\n  [sr] float NULL,\r\n  PRIMARY KEY CLUSTERED ([id], [varno]))\r\n  \r\n  \r\n  truncate table ##pomvardiozet\r\n  \r\n  insert into ##pomvardiozet (varno,perkod,perad,ada,grs,cks,ickkod,ickad,sr) \r\n  select varno,perkod,perad,ada,grs,cks,ickkod,ickad,sr from @Table_Pomvardiozet\r\n\r\n\r\n\r\n  select * from @Table_Pomvardiozet\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "pomvarperadaac",
    "definition": "CREATE PROCEDURE [dbo].pomvarperadaac\r\n@firmano int,\r\n@varno float,\r\n@tip varchar(30)\r\nAS\r\nBEGIN\r\n/*@firmano int */\r\n\r\ndeclare @perkod varchar(50)\r\ndeclare @perad varchar(50)\r\ndeclare @adad varchar(30)\r\ndeclare @adaid int\r\ndeclare @adabag int\r\nSET NOCOUNT ON\r\n\r\nselect @adabag=adabag from pomvardimas with (nolock) where varno=@varno\r\n\r\n/*sadece personele gore */\r\nif @tip='per'\r\nbegin\r\n DECLARE vardiadapercac CURSOR LOCAL FOR SELECT per,perad\r\n FROM pomvardiper with (nolock) where varno=@varno and firmano=@firmano\r\n and Sil=0\r\n OPEN vardiadapercac\r\n FETCH NEXT FROM vardiadapercac INTO  @perkod,@perad\r\n WHILE @@FETCH_STATUS <> -1\r\n BEGIN\r\n\r\n      EXEC pomvarpersayac  @firmano,@varno,@perkod,@perad,0,'Tum'\r\n \r\n \r\n   FETCH NEXT FROM vardiadapercac INTO  @perkod,@perad\r\n\r\n  END\r\n  CLOSE vardiadapercac\r\n  DEALLOCATE vardiadapercac\r\n  \r\nend;\r\n\r\nif @tip='ada'\r\nbegin\r\n DECLARE vardiadapercac CURSOR LOCAL FOR \r\n SELECT per,adaid,adad\r\n FROM pomvardiperada with (nolock)\r\n  where varno=@varno and firmano=@firmano and Sil=0 and per<>''\r\n OPEN vardiadapercac\r\n FETCH NEXT FROM vardiadapercac INTO  @perkod,@adaid,@adad\r\n WHILE @@FETCH_STATUS <> -1\r\n BEGIN\r\n\r\n select @perad=ad from perkart as p  with (nolock)\r\n where firmano=@firmano and kod=@perkod and p.sil=0 and p.drm='Aktif' \r\n\r\n EXEC pomvarpersayac @firmano,@varno,@perkod,@perad,@adaid,@adad\r\n \r\n if @adabag=1\r\n  EXEC pomvarpersayac @firmano,@varno,'Diger','Diğer',@adaid,@adad\r\n\r\n \r\n\r\n FETCH NEXT FROM vardiadapercac INTO  @perkod,@adaid,@adad\r\n\r\n\r\n\r\n  END\r\n  CLOSE vardiadapercac\r\n  DEALLOCATE vardiadapercac\r\n\r\n if @adabag=0\r\n  EXEC pomvarpersayac @firmano,@varno,'Diger','Diğer',0,'Tum';\r\n\r\nend\r\n\r\nSET NOCOUNT OFF\r\n\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "pomvarpersayac",
    "definition": "CREATE PROCEDURE [dbo].pomvarpersayac\r\n@firmano int,\r\n@varno float,\r\n@perkod varchar(50),\r\n@perad varchar(50),\r\n@adaid int,@adad varchar(50)\r\nAS\r\nBEGIN\r\nSET NOCOUNT ON\r\n\r\ndeclare @say int\r\ndeclare @grp1 int\r\ndeclare @kod varchar(50)\r\ndeclare @ad varchar(50)\r\ndeclare @satfiytip varchar(50)\r\ndeclare @tankkod varchar(50)\r\ndeclare @stktip varchar(10)\r\ndeclare @enktur varchar(10)\r\ndeclare @otomaskod varchar(50)\r\ndeclare @stkkod varchar(50)\r\ndeclare @ilkend float\r\ndeclare @sonend float\r\ndeclare @satfiy float\r\ndeclare @aktarma float\r\ndeclare @test float\r\ndeclare @sonendk float\r\ndeclare @kdvyuz float\r\ndeclare @stkkalan float\r\n\r\n\r\n\r\nif @adad='Tum'\r\n DECLARE pomvardisayacac CURSOR FORWARD_ONLY READ_ONLY LOCAL FOR\r\n SELECT s.grp1,g.ad,s.kod,s.otomaskod,s.ad,s.satfiytip,s.sonendks,\r\n s.tankod,t.bagak,t.stktip,s.enktur FROM sayackart as s with (NOLOCK) \r\n inner join tankkart as t with (NOLOCK)  on t.kod=s.tankod\r\n and t.drm='Aktif' and t.sil=0 and s.firmano=@firmano\r\n inner join grup as g on g.id=s.grp1 \r\n where s.drm='Aktif' and s.sil=0\r\n \r\nif @adad<>'Tum'\r\n DECLARE pomvardisayacac CURSOR FORWARD_ONLY READ_ONLY LOCAL FOR\r\n SELECT s.grp1,g.ad,s.kod,s.otomaskod,s.ad,s.satfiytip,s.sonendks,\r\n s.tankod,t.bagak,t.stktip,s.enktur FROM sayackart as s with (NOLOCK)  \r\n inner join tankkart  as t with (NOLOCK)  on t.kod=s.tankod\r\n and t.drm='Aktif' and t.sil=0 and s.firmano=@firmano\r\n inner join grup as g on g.id=s.grp1 \r\n where s.drm='Aktif' and s.sil=0 and s.grp1=@adaid\r\n\r\n OPEN pomvardisayacac\r\n FETCH NEXT FROM pomvardisayacac INTO  @grp1,@adad,@kod,@otomaskod,@ad,\r\n @satfiytip,@ilkend,\r\n @tankkod,@stkkod,@stktip,@enktur\r\n WHILE @@FETCH_STATUS <> -1\r\n BEGIN\r\n\r\n\r\n set @satfiytip=SUBSTRING(@satfiytip,1,1)\r\n\r\n\r\nif @satfiytip='1'\r\nselect @kdvyuz=sat1kdv,@satfiy=case when sat1kdvtip='Dahil' then \r\nsat1fiy else sat1fiy*(1+(sat1kdv/100)) end \r\nfrom stokkart with (nolock) where tip=@stktip and kod=@stkkod\r\n\r\nif @satfiytip='2'\r\nselect @kdvyuz=sat2kdv,@satfiy=case when sat2kdvtip='Dahil' then \r\nsat2fiy else sat2fiy*(1+(sat2kdv/100))  end \r\nfrom stokkart with (nolock) where tip=@stktip and kod=@stkkod\r\n\r\nif @satfiytip='3'\r\nselect @kdvyuz=sat3kdv,@satfiy=case when sat3kdvtip='Dahil' then \r\nsat3fiy else sat3fiy*(1+(sat3kdv/100)) end \r\nfrom stokkart with (nolock) where tip=@stktip and kod=@stkkod\r\n\r\nif @satfiytip='4'\r\nselect @kdvyuz=sat4kdv,@satfiy=case when sat4kdvtip='Dahil' then \r\n sat4fiy else sat4fiy*(1+(sat4kdv/100)) end from stokkart with (nolock)\r\nwhere tip=@stktip and kod=@stkkod\r\n\r\n\r\n  \r\n\r\n\r\n  if not EXISTS(select id from pomvardisayac\r\n  where perkod=@perkod and sayackod=@kod and varno=@varno and firmano=@firmano and Sil=0)\r\n  begin\r\n    insert into pomvardisayac (firmano,varno,perkod,perad,adaid,adad,sayackod,otomaskod,sayacad,ilkendk,sonendk,OncekiSonEndk,transfermik,testmik,satmik,kdvyuz,brimfiy,tutar,tankod,stkod,stktip,enktur)\r\n     values  (@firmano,@varno,@perkod,@perad,@grp1,@adad,@kod,@otomaskod,@ad,@ilkend,@ilkend,@ilkend,0,0,0,@kdvyuz/100,@satfiy,0,@tankkod,@stkkod,@stktip,@enktur);\r\n  end\r\n\r\n\r\n FETCH NEXT FROM pomvardisayacac INTO  @grp1,@adad,@kod,@otomaskod,@ad,@satfiytip,@ilkend,@tankkod,@stkkod,@stktip,@enktur\r\n\r\n  END\r\n  CLOSE pomvardisayacac\r\n  DEALLOCATE pomvardisayacac\r\n\r\n\r\n exec pomstoktankac @firmano,@varno\r\n\r\nSET NOCOUNT OFF\r\n \r\nEND"
  },
  {
    "schema": "dbo",
    "name": "poshrkgiris",
    "definition": "CREATE PROCEDURE [dbo].poshrkgiris @hrkid float\r\nAS\r\nBEGIN\r\n\r\ndeclare @varno \t\tfloat\r\ndeclare @baktop \tfloat\r\ndeclare @newid \t\tfloat\r\ndeclare @anaid \t\tbigint\r\ndeclare @gctip \t\tvarchar(1)\r\ndeclare @giren \t\tfloat\r\ndeclare @cikan \t\tfloat\r\ndeclare @poskod \tvarchar(20)\r\n  \r\ndeclare @islmtip \tvarchar(20)\r\ndeclare @islmhrk \tvarchar(20)\r\ndeclare @cartip \tvarchar(20)\r\ndeclare @poshrkid \tfloat\r\n\r\ndeclare @devir \t    bit\r\n\r\n  select @gctip=gctip,@poshrkid=poshrkid,\r\n  @islmtip=islmtip,@islmhrk=islmhrk,\r\n  @giren=giren,@cikan=cikan,@varno=varno,\r\n  @cartip=cartip,@anaid=ana_id,\r\n  @devir=devir \r\n  from poshrk with (nolock) where poshrkid=@hrkid\r\n\r\n if @devir=1\r\n  return\r\n\r\n if @poshrkid=0\r\n  return\r\n\r\n  \r\n  if @anaid>0\r\n   begin\r\n    set @poshrkid=@anaid\r\n    select @giren=sum(giren),@cikan=sum(cikan) from\r\n    poshrk with (nolock)  where ana_id=@anaid  and sil=0\r\n   end  \r\n   \r\n\r\n\r\n /*delete from carihrk where masterid=@poshrkid and karsihestip='poskart' */\r\n  update carihrk set sil=1,dataok=0 where masterid=@poshrkid  \r\n  and islmtip=@islmtip and islmhrk=@islmhrk \r\n  and karsihestip='poskart'\r\n\r\n\r\n  update istkhrk set sil=1,dataok=0 where masterid=@poshrkid  \r\n  and islmtip=@islmtip and islmhrk=@islmhrk \r\n  and karsihestip='poskart'\r\n\r\n   if @cartip<>''\r\n    begin\r\n\r\n    if (@cartip='carikart') or (@cartip='perkart') \r\n    or (@cartip='gelgidkart')\r\n     begin\r\n     /* select @newid=max(carhrkid)+1 from carihrk */\r\n      insert into carihrk (firmano,carhrkid,gctip,masterid,fisfattip,fisfatid,\r\n      islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n      cartip_id,cartip,car_id,carkod,borc,alacak,bakiye,tarih,saat,\r\n      olususer,olustarsaat,vadetar,belno,\r\n      ack,varno,kur,dataok,pro,varok,perkod,\r\n      adaid,deguser,degtarsaat,sil,\r\n      karsihestip,karsiheskod,parabrm,\r\n      fatid,\r\n      Karsi_Karttip,Karsi_KartKod) \r\n      select top 1 firmano,0,@gctip,@poshrkid,fisfattip,fisfatid,\r\n      islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n      cartip_id,cartip,car_id,carkod,@cikan,@giren,0,tarih,saat,\r\n      olususer,olustarsaat,vadetar,belno,\r\n      ack,varno,kur,dataok,1,varok,perkod,adaid,deguser,degtarsaat,sil,\r\n      'poskart',poskod,parabrm,fatid,\r\n      'poskart',poskod      \r\n       from poshrk with (nolock)  where poshrkid=@poshrkid\r\n      order by id\r\n      \r\n      select @newid=SCOPE_IDENTITY()\r\n         \r\n      update carihrk set carhrkid=@newid where id=@newid\r\n      \r\n      \r\n      \r\n    END\r\n\r\n    \r\n    \r\n    if (@cartip='istkart') \r\n     begin\r\n      insert into istkhrk (firmano,\r\n      istkhrkid,gctip,masterid,fisfattip,fisfatid,\r\n      islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n      istkkod,cartip_id,cartip,car_id,carkod,borc,alacak,tarih,saat,\r\n      olususer,olustarsaat,vadetar,belno,\r\n      ack,varno,kur,dataok,varok,perkod,\r\n      adaid,deguser,degtarsaat,sil,\r\n      karsihestip,karsiheskod,parabrm,fatid,\r\n      Karsi_Karttip,Karsi_KartKod) \r\n      select top 1 firmano,0,@gctip,@poshrkid,fisfattip,fisfatid,\r\n      islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n      carkod,5,'poskart',pos_id,poskod,\r\n      @cikan,@giren,tarih,saat,\r\n      olususer,olustarsaat,car_vadetar,belno,\r\n      ack,varno,kur,dataok,varok,perkod,adaid,deguser,degtarsaat,sil,\r\n      'poskart',poskod,parabrm,fatid,\r\n      'poskart',poskod\r\n       from poshrk with (nolock)  where poshrkid=@poshrkid\r\n      order by id\r\n      \r\n      select @newid=SCOPE_IDENTITY()\r\n         \r\n      update istkhrk set istkhrkid=@newid where id=@newid\r\n      \r\n      \r\n      \r\n    END\r\n    \r\n    end\r\n  \r\nEND"
  },
  {
    "schema": "dbo",
    "name": "Prom_Puan_Birlestir",
    "definition": "CREATE PROCEDURE [dbo].[Prom_Puan_Birlestir]\r\n(@firmano\t\tint,\r\n@SecKart_idin\tvarchar(8000),\r\n@Mas_Kartid\t\tint,\r\n@Yertip         varchar(50),\r\n@Tarih\t\t\tdatetime,\r\n@Saat\t\t\tvarchar(10),\r\n@Belno\t\t\tvarchar(30),\r\n@Ack\t\t\tvarchar(100),\r\n@Users\t\t\tvarchar(100),\r\n@UsertarSaat\tdatetime)\r\nAS\r\nBEGIN\r\n  \r\n\r\n declare @islemTip_id   int\r\n declare @islemTip_Ad   varchar(50)\r\n declare @YerAd   \tvarchar(50)\r\n declare @Puanid \tint\r\n\r\n  declare @OdeTip_id   int\r\n  declare @OdeTip_Ad   varchar(50)\r\n\r\n\r\n \r\n  declare @Aktar_Puan\tFloat \r\n  declare @Aktar_Tutar\tFloat \r\n \r\n \r\n  select @YerAd=ad from yertipad where kod=@Yertip\r\n  \r\n  \r\n  set @OdeTip_id=85 /*aktarılacak puan */\r\n   select @OdeTip_Ad=ad from islemhrktip \r\n   where id=@OdeTip_id\r\n  \r\n   \r\n\r\n \r\n  set @islemTip_id=10 /*aktarılacak puan */\r\n   select @islemTip_Ad=ack_tr from Prom_Puan_Hrk_Tip\r\n   where id=@islemTip_id\r\n  \r\n   select @Puanid=isnull(MAX(id),0)+1 from Prom_Puan_Hrk\r\n   \r\n    insert into Prom_Puan_Hrk\r\n    (Firmano,Sil,Varno,Cartip_id,Cartip,Car_id,Carkod,\r\n    Stktip_id,Stktip,Stk_id,Stkkod,\r\n    Puan_Giren,Puan_Cikan,\r\n    Tarih,Saat,islemTip_id,islemTip_Ad,OdeTip_id,OdeTip_Ad,\r\n    Ack,OlusUser,OlusTarSaat,DegisUser,DegisTarSaat,\r\n    Car_Plaka,Car_KartNo,Car_KartId,Brm_Fiyat_Kdvli,Kdv_Oran,\r\n    Mik_Giren,Mik_Cikan,\r\n    BelNo,Tutar_Kdvli,Fatid,Fisid,\r\n    Promid,Puanid,Yertip,YerAd)\r\n    \r\n    select \r\n    @firmano,0,0,\r\n    k.cartip_id,k.cartip,k.id,k.kod,\r\n    0,'',0,'',\r\n    0,k.Mevcut_Puan,@tarih,@saat,\r\n    @islemTip_id,@islemTip_Ad,\r\n    @OdeTip_id,@OdeTip_Ad,@Ack,@Users,@UsertarSaat,\r\n    '',null,k.plaka,\r\n    k.kartno,k.KartId,0,0,\r\n    0,1,@Belno,k.Kal_Tutar,0,0,0,@Puanid,@Yertip,@YerAd \r\n    from Prom_Musteri_Listesi as k\r\n     where k.KartId in (select * from CsvToInt(@SecKart_idin))\r\n     and Mevcut_Puan>0\r\n    \r\n  \r\n  \r\n   select @Aktar_Puan=isnull(sum(Puan_Cikan),0),\r\n   @Aktar_Tutar=isnull(sum(Tutar_Kdvli),0) from Prom_Puan_Hrk\r\n   where Puanid=@Puanid and sil=0 and islemTip_id=@islemTip_id\r\n    \r\n  if @Aktar_Puan=0\r\n   RETURN  \r\n   \r\n    set @islemTip_id=11 /*gelen puan */\r\n    select @islemTip_Ad=ack_tr from Prom_Puan_Hrk_Tip\r\n     where id=@islemTip_id   \r\n     \r\n     \r\n    insert into Prom_Puan_Hrk\r\n    (Firmano,Sil,Varno,Cartip_id,Cartip,Car_id,Carkod,\r\n    Stktip_id,Stktip,Stk_id,Stkkod,\r\n    Puan_Giren,Puan_Cikan,\r\n    Tarih,Saat,islemTip_id,islemTip_Ad,OdeTip_id,OdeTip_Ad,\r\n    Ack,OlusUser,OlusTarSaat,DegisUser,DegisTarSaat,\r\n    Car_Plaka,Car_KartNo,Car_KartId,Brm_Fiyat_Kdvli,Kdv_Oran,\r\n    Mik_Giren,Mik_Cikan,\r\n    BelNo,Tutar_Kdvli,Fatid,Fisid,\r\n    Promid,Puanid,Yertip,YerAd)\r\n    \r\n    select \r\n    @firmano,0,0,\r\n    k.cartip_id,k.cartip,k.id,k.kod,\r\n    0,'',0,'',\r\n    @Aktar_Puan,0,@tarih,@saat,\r\n    @islemTip_id,@islemTip_Ad,\r\n    @OdeTip_id,@OdeTip_Ad,@Ack,@Users,@UsertarSaat,\r\n    '',null,k.plaka,\r\n    k.kartno,k.KartId,0,0,\r\n    1,0,@Belno,@Aktar_Tutar,0,0,0,@Puanid,@Yertip,@YerAd \r\n    from Prom_Musteri_Listesi as k\r\n     where k.KartId=@Mas_Kartid\r\n     \r\n    \r\n    \r\n  \r\n  \r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "Prom_Puan_Hrk_isle",
    "definition": "CREATE PROCEDURE [dbo].Prom_Puan_Hrk_isle \r\n(@Evraktip   \tvarchar(30),\r\n@Evrak_id\t\tbigint,\r\n@Sil\t\t\ttinyint)\r\nAS\r\nBEGIN\r\n  \r\n\r\n declare @islemTip_id   int\r\n declare @islemTip_Ad   varchar(50)\r\n \r\n \r\n if @Evraktip='FISPRSSAT'\r\n  begin\r\n  \r\n  set @islemTip_id=6\r\n   select @islemTip_Ad=ack_tr from Prom_Puan_Hrk_Tip\r\n   where id=@islemTip_id\r\n  \r\n  \r\n   delete from Prom_Puan_Hrk where \r\n   promid=@Evrak_id   \r\n  \r\n  \r\n\r\n\r\n\r\n    insert into Prom_Puan_Hrk\r\n    (Firmano,Sil,Varno,Cartip_id,Cartip,Car_id,Carkod,\r\n    Stktip_id,Stktip,Stk_id,Stkkod,\r\n    Puan_Giren,Puan_Cikan,\r\n    Tarih,Saat,islemTip_id,islemTip_Ad,OdeTip_id,OdeTip_Ad,\r\n    Ack,OlusUser,OlusTarSaat,DegisUser,DegisTarSaat,\r\n    Car_Plaka,Car_KartNo,Car_KartId,Brm_Fiyat_Kdvli,Kdv_Oran,\r\n    Mik_Giren,Mik_Cikan,\r\n    BelNo,Tutar_Kdvli,Fatid,Fisid,Promid,Yertip,YerAd)\r\n    \r\n    select \r\n    M.firmano,m.sil,m.varno,\r\n    m.Cartip_id,m.Cartip,m.Car_id,m.Carkod,\r\n    h.stktip_id,h.stktip,h.stk_id,h.stkod,\r\n    h.Kaz_Top_Puan,0,m.tarih,m.saat,\r\n    @islemTip_id,@islemTip_Ad,\r\n    m.OdeTip_id,m.OdeTip_Ad,\r\n    m.ack,m.olususer,m.olustarsaat,\r\n    m.deguser,m.degtarsaat,m.plaka,\r\n    m.Kartno,m.KartId,h.brmfiy,h.kdvyuz*100,\r\n    0,h.mik,m.seri+cast(m.no as varchar(30)),\r\n    h.Tut_isk_Kdvli,\r\n    0,0,m.promid,m.yertip,m.yerad\r\n    From Prom_Sat_Baslik as M inner join \r\n    Prom_Sat_Hrk as h on m.promid=h.promid\r\n    and m.sil=0 and h.sil=0\r\n    where m.Promid=@Evrak_id and h.Kaz_Top_Puan>0\r\n\r\n  end\r\n\r\n\r\n\r\nif @Evraktip='FISPRSTES'\r\n  begin\r\n  \r\n  set @islemTip_id=9\r\n   select @islemTip_Ad=ack_tr from Prom_Puan_Hrk_Tip\r\n   where id=@islemTip_id\r\n  \r\n  \r\n   delete from Prom_Puan_Hrk where \r\n   promid=@Evrak_id   \r\n  \r\n  \r\n\r\n\r\n\r\n    insert into Prom_Puan_Hrk\r\n    (Firmano,Sil,Varno,Cartip_id,Cartip,Car_id,Carkod,\r\n    Stktip_id,Stktip,Stk_id,Stkkod,\r\n    Puan_Giren,Puan_Cikan,\r\n    Tarih,Saat,islemTip_id,islemTip_Ad,OdeTip_id,OdeTip_Ad,\r\n    Ack,OlusUser,OlusTarSaat,DegisUser,DegisTarSaat,\r\n    Car_Plaka,Car_KartNo,Car_KartId,Brm_Fiyat_Kdvli,Kdv_Oran,\r\n    Mik_Giren,Mik_Cikan,\r\n    BelNo,Tutar_Kdvli,Fatid,Fisid,Promid,Yertip,YerAd)\r\n    \r\n    select \r\n    M.firmano,m.sil,m.varno,\r\n    m.Cartip_id,m.Cartip,m.Car_id,m.Carkod,\r\n    h.stktip_id,h.stktip,h.stk_id,h.stkod,\r\n    0,h.Sat_Top_Puan,m.tarih,m.saat,\r\n    @islemTip_id,@islemTip_Ad,\r\n    m.OdeTip_id,m.OdeTip_Ad,\r\n    m.ack,m.olususer,m.olustarsaat,\r\n    m.deguser,m.degtarsaat,m.plaka,\r\n    m.Kartno,m.KartId,h.brmfiy,h.kdvyuz*100,\r\n    0,h.mik,m.seri+cast(m.no as varchar(30)),\r\n    h.Tut_isk_Kdvli,\r\n    0,0,m.promid,m.yertip,m.yerad\r\n    From Prom_Sat_Baslik as M inner join \r\n    Prom_Sat_Hrk as h on m.promid=h.promid\r\n    and m.sil=0 and h.sil=0\r\n    where m.Promid=@Evrak_id and h.Sat_Top_Puan>0\r\n\r\n  end\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "Prom_Puan_Sifirla",
    "definition": "CREATE PROCEDURE [dbo].[Prom_Puan_Sifirla]\r\n(@firmano\t\tint,\r\n@kart_idin\t\tvarchar(8000),\r\n@Yertip         varchar(50),\r\n@Users\t\t\tvarchar(100),\r\n@UsertarSaat\tdatetime)\r\nAS\r\nBEGIN\r\n  \r\n\r\n declare @islemTip_id   int\r\n declare @islemTip_Ad   varchar(50)\r\n declare @YerAd   \tvarchar(50)\r\n declare @Tarih\t\t\tdatetime\r\n declare @Saat\t\t\tvarchar(10)\r\n declare @Puanid\t\tint\r\n \r\n \r\n  declare @OdeTip_id   int\r\n  declare @OdeTip_Ad   varchar(50)\r\n \r\n \r\n  select @YerAd=ad from yerad where kod=@Yertip\r\n   \r\n  set @OdeTip_id=85 /*aktarılacak puan */\r\n   select @OdeTip_Ad=ad from islemhrktip \r\n   where id=@OdeTip_id\r\n \r\n \r\n  set @Tarih=convert(varchar,@UsertarSaat,101)\r\n  set @Saat=convert(varchar,@UsertarSaat,108)\r\n \r\n \r\n \r\n\r\n  set @islemTip_id=7\r\n   select @islemTip_Ad=ack_tr from Prom_Puan_Hrk_Tip\r\n   where id=@islemTip_id\r\n  \r\n    select @Puanid=isnull(MAX(id),0)+1 from Prom_Puan_Hrk\r\n    insert into Prom_Puan_Hrk\r\n    (Firmano,Sil,Varno,Cartip_id,Cartip,Car_id,Carkod,\r\n    Stktip_id,Stktip,Stk_id,Stkkod,\r\n    Puan_Giren,Puan_Cikan,\r\n    Tarih,Saat,islemTip_id,islemTip_Ad,OdeTip_id,OdeTip_Ad,\r\n    Ack,OlusUser,OlusTarSaat,DegisUser,DegisTarSaat,\r\n    Car_Plaka,Car_KartNo,Car_KartId,Brm_Fiyat_Kdvli,Kdv_Oran,\r\n    Mik_Giren,Mik_Cikan,\r\n    BelNo,Tutar_Kdvli,Fatid,Fisid,Promid,Puanid,\r\n    Yertip,YerAd)\r\n    \r\n    select \r\n    @firmano,0,0,\r\n    k.cartip_id,k.cartip,k.id,k.kod,\r\n    0,'',0,'',\r\n    0,k.Mevcut_Puan,@tarih,@saat,\r\n    @islemTip_id,@islemTip_Ad,\r\n    @OdeTip_id,@OdeTip_Ad,@islemTip_Ad,@Users,@UsertarSaat,\r\n    '',null,k.plaka,\r\n    k.kartno,k.KartId,0,0,\r\n    0,1,'',k.Kal_Tutar,0,0,0,@Puanid,@Yertip,@YerAd \r\n    from Prom_Musteri_Listesi as k\r\n     where ot_id in (select * from CsvToInt(@kart_idin))\r\n     and Mevcut_Puan>0\r\n     \r\n     \r\n     \r\n     \r\n    \r\n    \r\n  \r\n  \r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "ResSatRecHrkOlustur",
    "definition": "CREATE PROCEDURE dbo.[ResSatRecHrkOlustur]\r\n@ResSatId     int\r\nAS\r\nBEGIN\r\n  \r\n  /*update  */\r\n   update ResSatRecHrk Set sil=dt.sil,\r\n   TransferStartId=TransferStartId+1  \r\n    from ResSatRecHrk as t join \r\n    ( select h.Id,h.sil\r\n    From ResSathrk as h with (nolock) \r\n    inner join Stok_Recete as r with (nolock) \r\n    on r.Urun_id=h.stkId and r.sil=0\r\n    where h.ResSatId=@ResSatId and isnull(h.Recete,0)=1\r\n    and h.Id in (Select ResSatHrkId From ResSatRecHrk with (nolock) \r\n    where ResSatId=@ResSatId ) ) dt \r\n    on dt.Id=t.ResSatHrkId \r\n\r\n\r\n\r\n   /*insert Uretim Recete */\r\n   insert into ResSatRecHrk (ResSatId,ResSatHrkId,StokReceteId,\r\n   UretimTipId,UrunId,StokTipId,StokTip,StokId,StokKod,Miktar,\r\n   OlusturmaKullaniciUnvan,OlusturmaTarihSaat)\r\n   Select @ResSatId,h.Id,r.id,\r\n   1,r.Urun_id,r.StkTip_id,k.tip,r.Stk_id,k.Kod,r.Miktar*h.miktar,\r\n   h.OlusUser,h.OlusTarSaat\r\n   From ResSathrk as h with (nolock) \r\n   inner join Stok_Recete as r with (nolock) \r\n   on r.Urun_id=h.StkId and r.sil=0 and H.sil=0\r\n   inner join Stokkart as k with (nolock) on k.id=r.Stk_id\r\n   where h.ResSatId=@ResSatId and isnull(h.Recete,0)=1\r\n   and h.Id not in (Select ResSatHrkId From ResSatRecHrk with (nolock) \r\n   where ResSatId=@ResSatId and UretimTipId=1 )\r\n\r\n   \r\n   /*insert Uretim Urun */\r\n   insert into ResSatRecHrk (ResSatId,ResSatHrkId,StokReceteId,\r\n   UretimTipId,UrunId,StokTipId,StokTip,StokId,StokKod,Miktar,\r\n   OlusturmaKullaniciUnvan,OlusturmaTarihSaat)\r\n   Select @ResSatId,h.Id,0,\r\n   2,h.StkId,h.StkTipId,k.tip,h.StkId,k.Kod,h.miktar,\r\n   h.OlusUser,h.OlusTarSaat\r\n   From ResSathrk as h with (nolock) \r\n   inner join Stokkart as k with (nolock) on k.id=h.StkId\r\n   where h.ResSatId=@ResSatId and isnull(h.Recete,0)=1\r\n   and h.Id not in (Select ResSatHrkId From ResSatRecHrk with (nolock) \r\n   where ResSatId=@ResSatId and UretimTipId=2 )\r\n   \r\n   \r\n   \r\n   \r\n   \r\n   /*SELECT id FROM ResSatRecHrk as rh WHERE NOT EXISTS (SELECT id FROM ResSatRecHrk as mrs\r\n   WHERE rh.X = mrs.X  AND rh.Y = mrs.Y )\r\n   */\r\n   \r\n   \r\n   /*delete */\r\n   update ResSatRecHrk set Sil=1,TransferStartId=TransferStartId+1  \r\n   where ResSatId=@ResSatId \r\n   and ResSatHrkId not in (select h.Id from ResSathrk h with (nolock)\r\n   inner join ResSatMas as m  with (nolock)\r\n   on m.Id=h.ResSatId  and isnull(h.Recete,0)=1 and  h.ResSatId=@ResSatId)\r\n   \r\n   \r\n   \r\n  declare @ResSatHrkId    int\r\n  declare @ResSatRecId    int\r\n  declare @UrunId   int\r\n  declare @StokId   int\r\n  declare @Miktar    float\r\n  declare @StokIdAlisFiyat float\r\n  \r\n  declare @ResSatHrkRecToplam    float\r\n  declare @ResSatHrkToplam       float\r\n  \r\n   \r\n  declare pom_var CURSOR FAST_FORWARD  FOR \r\n  select Id,h.StkId,((h.BirimFiyat*(1-h.IndYuz))*h.Kur)*h.Miktar  as BirimFiyat \r\n  from ResSathrk as h with (nolock)  where ResSatId=@ResSatId and sil=0 \r\n  and isnull(Recete,0)=1\r\n   open pom_var\r\n  fetch next from  pom_var into @ResSatHrkId,@UrunId,@ResSatHrkToplam\r\n  while @@FETCH_STATUS=0\r\n   begin\r\n    set @ResSatHrkRecToplam=0\r\n   \r\n    /*Recete İcinde Urunleri Bul */\r\n    \r\n  declare rec_var CURSOR FAST_FORWARD  FOR \r\n   Select Id,StokId,Miktar From ResSatRecHrk with (nolock)  \r\n   Where ResSatHrkId=@ResSatHrkId and Sil=0 and UretimTipId=1\r\n   open rec_var\r\n  fetch next from  rec_var into @ResSatRecId,@StokId,@Miktar\r\n  while @@FETCH_STATUS=0\r\n   begin\r\n   \r\n   /*Recete İcindeki Urunun Alis Fiyatini Bul  */\r\n    Select @StokIdAlisFiyat=\r\n    case when alskdvtip='Dahil' then alsfiy \r\n    else alsfiy*(1+(alskdv/100)) end\r\n    From Stokkart with (NOLOCK) where id=@StokId\r\n       \r\n     update ResSatRecHrk Set BirimMaliyetFiyat=@StokIdAlisFiyat Where Id=@ResSatRecId\r\n   \r\n    set @ResSatHrkRecToplam=@ResSatHrkRecToplam+(@StokIdAlisFiyat*@Miktar)\r\n     \r\n   FETCH next from  rec_var into @ResSatRecId,@StokId,@Miktar\r\n  end\r\n close rec_var\r\n deallocate rec_var\r\n          \r\n  /*Satis Fiyatiyla Orantila    */\r\n\r\n   \r\n    update ResSatRecHrk Set BirimFiyat=BirimMaliyetFiyat*(@ResSatHrkToplam/\r\n    case when @ResSatHrkRecToplam>0 then @ResSatHrkRecToplam else 1.00 end )\r\n    Where ResSatHrkId=@ResSatHrkId\r\n  \r\n\r\n\r\n   FETCH next from  pom_var into @ResSatHrkId,@UrunId,@ResSatHrkToplam\r\n  end\r\n close Pom_Var\r\n deallocate pom_var\r\n   \r\n\r\n\r\n   \r\n   \r\n   \r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "Restaurat_BozukPara",
    "definition": "CREATE PROCEDURE [dbo].[Restaurat_BozukPara]\r\n(\r\n@firmano  \tint,\r\n@varno \t\tint,\r\n@sil \t\tint)\r\nAS\r\nBEGIN\r\n\r\n\r\ndeclare @islmtip  \tvarchar(50)\r\ndeclare @islmtipad  varchar(50)\r\ndeclare @islmhrk  \tvarchar(50)\r\ndeclare @islmhrkad  varchar(50)\r\ndeclare @gctip  \tvarchar(50)\r\ndeclare @newid  \tint\r\n\r\n\r\ndeclare @yertip  \tvarchar(50)\r\ndeclare @yertipkad  varchar(50)\r\n\r\n\r\n    set @islmtip='VAR'\r\n    set @islmhrk='BPC'\r\n    set @gctip='C'\r\n    set @yertip='resvardimas'\r\n    \r\n    \r\n     update kasahrk set sil=1  where \r\n     marbozukpara_id=@varno \r\n \r\n \r\n  \r\n    \r\n   if @sil=0\r\n    begin \r\n    \r\n    select @islmtipad=ad from islemturtip where tip=@islmtip \r\n    \r\n    \r\n    select @islmhrkad=ad from islemhrktip where tip=@islmtip and \r\n    hrk=@islmhrk\r\n    \r\n    \r\n    select @yertipkad=ad from yertipad where kod=@yertip\r\n\r\n    select @newid=0\r\n    insert into kasahrk (firmano,kaskod,kashrkid,gctip,varno,\r\n    masterid,islmtip,islmtipad,islmhrk,islmhrkad,yertip,\r\n    yerad,perkod,adaid,giren,cikan,bakiye,cartip,carkod,tarih,saat,\r\n    belno,ack,kur,varok,sil,olususer,\r\n    olustarsaat,deguser,degtarsaat,dataok,parabrm,\r\n    karsihestip,karsiheskod,marbozukpara_id)\r\n    select firmano,KasaKod,@newid,@gctip,0,0,\r\n    @islmtip,@islmtipad,\r\n    @islmhrk,@islmhrkad,@yertip,\r\n    @yertipkad,'Diger',0,0,bozukpara,0,'vardikasa','VRDKASA',\r\n    tarih,saat,cast(varno as varchar(50)),varad,\r\n    kur,varok,sil,olususer,\r\n    olustarsaat,deguser,degtarsaat,\r\n    1,ParaBirim,'','',varno \r\n    from resvardimas where firmano=@firmano and varno=@varno\r\n    and sil=0 and KasaKod<>'' and bozukpara>0\r\n \r\n     select @newid=SCOPE_IDENTITY()\r\n     update kasahrk set kashrkid=@newid where id=@newid\r\n     \r\n   end\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "ResVarKabul",
    "definition": "CREATE PROCEDURE [dbo].[ResVarKabul]\r\n(@varno float,@varok int,@sil int)\r\nAS\r\nBEGIN\r\nSET NOCOUNT ON\r\n\r\n\r\n\r\ndeclare @say \t\t\t\t\tint\r\ndeclare @Firmano                int\r\ndeclare @varad \t\t\t\t\tvarchar(40)\r\ndeclare @yertip \t\t\t\tvarchar(30)\r\n\r\nset @yertip='resvardimas'\r\n\r\n/*----silme ve geri alma durumu icin */\r\nif (@sil=1) or (@varok=0)\r\nbegin\r\n delete from resvardiozet where varno=@varno\r\n\r\n/*-VARDIYA ACIK FAZLA İSLENMESI SILIMI */\r\n delete from carihrk where varno=@varno \r\n and yertip=@yertip and islmtip='VAR'\r\n\r\n\r\nRETURN\r\nend\r\n/*----silme ve geri alma durumu icin */\r\n\r\n delete from resvardiozet where varno=@varno\r\n\r\n/*kasa cari tahsilat karsi hesap kapatma */\r\n exec Vardiya_Kasa_Kapat @yertip,@varno\r\n\r\n/*--vardiya ozet tablosuna kapanis bilgilerini at */\r\n exec resvarozet @varno,'per','genel'\r\n  insert into resvardiozet (varno,varok,sil,tip,tipack,giris,cikis,bakiye,sr)\r\n   select @varno,@varok,@sil,ickkod,ickad,sum(grs),sum(cks),sum(grs-cks),sr\r\n    from ##resvardiozet where varno=@varno\r\n     group by ickkod,ickad,sr order by sr\r\n/*------------------------ */\r\n\r\n\r\n\r\n   declare @cartip varchar(20)\r\n   declare @carkod varchar(30)\r\n   \r\n   \r\n    select top 1 @cartip=cartip,@carkod=kod from resvardikap \r\n    with (nolock) where varno=@varno and sil=0\r\n    \r\n    delete from carihrk where varno=@varno and yertip=@yertip \r\n    and islmtip='VAR'\r\n    \r\n       \r\n   \r\n    /*personel carihrk */\r\n    \r\n    declare @KapTarih Datetime\r\n    declare @KapTarihSaat varchar(20)\r\n    declare @KapAcik      varchar(150)\r\n    \r\n    select @Firmano=Firmano,@KapTarih=kaptarih,@KapTarihSaat=Kapsaat,@varad=varad from resvardimas with (nolock)\r\n    where varno=@Varno and Sil=0 \r\n    set @KapAcik='TARIH : '+CONVERT(varchar,@KapTarih, 104)+' # '+@varad+'. NOLU VARDIYA #'; \r\n\r\n     \r\n    INSERT INTO [carihrk] (firmano,carhrkid,gctip,\r\n    islmtip,islmtipad,\r\n    islmhrk,islmhrkad,\r\n    yertip,yerad,cartip,carkod,masterid,fisfattip,fisfatid,\r\n    varno,perkod,adaid,tarih,saat,\r\n    belno,ack,borc,alacak,kur,parabrm,olususer,olustarsaat,varok)\r\n    select @firmano,0,case when ackfaz='acik' then 'C' else 'G' end,\r\n    'VAR', N'VARDİYA', \r\n    case when ackfaz='acik' then 'ACK' else 'FAZ' end,\r\n    case when ackfaz='acik' then 'VARDİYA AÇIK' else 'VARDİYA FAZLA' end,\r\n    'resvardimas','RESTAURANT VARDİYA', \r\n    cartip,kod,0,'KENDI',0,varno,'',0,@KapTarih,@KapTarihSaat,\r\n    varno,@KapAcik+case when ackfaz='acik' then ' HESAP AÇIĞI' else ' HESAP FAZLASI' end,\r\n    case when ackfaz='acik' then abs(tutar) else 0 end,\r\n    case when ackfaz='acik' then 0 else abs(tutar) end,\r\n    1,'TL',olususer,olustarsaat,@varok \r\n    from resvardikap with (nolock) where varno=@varno and sil=0 and ABS(tutar)>0\r\n    \r\n    update carihrk set carhrkid=id where carhrkid=0 and islmtip='VAR' and sil=0  \r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "ResVarOzet",
    "definition": "CREATE PROCEDURE [dbo].[ResVarOzet] @varno float,@tip varchar(10),@tipdty\r\n varchar(10)\r\nAS\r\nBEGIN\r\n\r\ndeclare @sql         nvarchar(500)\r\ndeclare @acik         float\r\ndeclare @fazla         float\r\ndeclare @perkod     varchar(50)\r\ndeclare @perad         varchar(50)\r\ndeclare @yertip     varchar(20)\r\n\r\nset @yertip='Resvardimas'\r\n\r\nSET NOCOUNT ON\r\n\r\nif object_id( 'tempdb..##Resvardiozet' ) is null\r\nCREATE TABLE [dbo].[##Resvardiozet] (\r\n  [id] numeric(18, 0) IDENTITY(1, 1) NOT NULL,\r\n  [varno] float NOT NULL,\r\n  [perkod] varchar(30) COLLATE Turkish_CI_AS NULL,\r\n  [perad] varchar(50) COLLATE Turkish_CI_AS NULL,\r\n  [ada] varchar(50) COLLATE Turkish_CI_AS NULL,\r\n  [grs] float  DEFAULT 0 NULL,\r\n  [cks] float DEFAULT 0 NULL,\r\n  [ickkod] varchar(30) COLLATE Turkish_CI_AS NULL,\r\n  [ickad] varchar(50) COLLATE Turkish_CI_AS NULL,\r\n  [sr] float NULL,\r\n  PRIMARY KEY  ([id], [varno]))\r\n  delete from ##Resvardiozet where varno=@varno\r\n\r\n/*\r\nAKSAT\r\nVERAT\r\nVERBT\r\nVEROT\r\nPOSST\r\nMALST\r\nNAKTS\r\nODETT\r\nCAROD\r\nPEROD\r\nPRKOD\r\nTAHTT\r\nCARTH\r\nPERTH\r\nPRKTH\r\nGELIR\r\nGIDER\r\n\r\n*/\r\n\r\n\r\nDECLARE marvardiozetx CURSOR FAST_FORWARD FOR SELECT varno from resvardimas\r\n where varno=@varno\r\n  OPEN marvardiozetx\r\n  FETCH NEXT FROM marvardiozetx INTO  @varno\r\n   WHILE @@FETCH_STATUS = 0\r\n    BEGIN\r\n\r\n       insert into ##Resvardiozet (varno,ickkod,ickad,sr,perkod,perad,grs,cks)\r\n       select @varno,'RSSAT','Restaurant Satış - İade Tutarı',1,@perkod,@perad,\r\n       isnull(sum(case when m.Iade=0 then round(h.miktar*(h.birimfiyat)*h.kur,2)\r\n        else 0 end),0),\r\n       isnull(sum(case when m.Iade=1 then round(h.miktar*(h.birimfiyat)*h.kur,2)\r\n        else 0 end),0) \r\n       from Ressathrk as h inner join Ressatmas as m on m.Id=h.RessatId\r\n       where m.varno=@varno and m.sil=0 \r\n\r\n      insert into ##Resvardiozet(varno, ickkod, ickad, sr, perkod, perad, grs,\r\n       cks)\r\n      select @varno,\r\n             'BZPAR',\r\n             'Bozuk Para Tutarı',\r\n             2.0,\r\n             @perkod,\r\n             @perad,\r\n             isnull(sum(bozukpara), 0),\r\n             0\r\n      from Resvardimas\r\n      where varno = @varno\r\n      insert into ##Resvardiozet(varno, ickkod, ickad, sr, perkod, perad, grs,\r\n       cks)\r\n      select @varno,\r\n             'VERAT',\r\n             'Veresiye Alacak Tutarı',\r\n             2.1,\r\n             @perkod,\r\n             @perad,\r\n             isnull(sum(toptut -(fiyfarktop + vadfarktop)), 0),\r\n             0\r\n      from veresimas\r\n      where varno = @varno and\r\n            fistip = 'FISALCSAT' and\r\n            sil = 0 and\r\n            adaid = @perkod and\r\n            ototag = 0 and\r\n            yertip = @yertip\r\n      insert into ##Resvardiozet(varno, ickkod, ickad, sr, perkod, perad, grs,\r\n       cks)\r\n      select @varno,\r\n             'VERBT',\r\n             'Veresiye Borç Tutarı',\r\n             2.2,\r\n             @perkod,\r\n             @perad,\r\n             0,\r\n             isnull(sum(toptut -(fiyfarktop + vadfarktop)), 0)\r\n      from veresimas\r\n      where varno = @varno and\r\n            fistip = 'FISVERSAT' and\r\n            sil = 0 and\r\n            ototag <> 1 and\r\n            yertip = @yertip\r\n      insert into ##Resvardiozet(varno, ickkod, ickad, sr, perkod, perad, grs,\r\n       cks)\r\n      select @varno,\r\n             'POSST',\r\n             'Pos Satış Tutarı',\r\n             3,\r\n             @perkod,\r\n             @perad,\r\n             isnull(sum(case\r\n  when carslip = 1 then giren * kur\r\n  else 0\r\nend), 0),\r\n             isnull(sum(giren * kur), 0)\r\n      from poshrk\r\n      where varno = @varno and\r\n            sil = 0 and\r\n            yertip = @yertip /*\r\n      update ##marvardiozet set grs=dt.giris from ##marvardiozet t join\r\n      (select isnull(sum(giren*kur),0) as giris from poshrk where\r\n      varno=@varno and carkod<>'' and sil=0 and yertip=@yertip)\r\n      dt on t.ickkod='POSST' and t.perkod=@perkod\r\n      */\r\n      insert into ##Resvardiozet(varno, ickkod, ickad, sr, perkod, perad, grs,\r\n       cks)\r\n      select @varno,\r\n             'GIDER',\r\n             'Gider Tutarı',\r\n             5,\r\n             @perkod,\r\n             @perad,\r\n             0,\r\n             isnull(sum(borc * kur), 0)\r\n      from carihrk\r\n      where varno = @varno and\r\n            ((islmtip = 'ODE') OR\r\n            (islmhrk = 'IND') and\r\n            (islmtip = 'GLG') OR\r\n            (islmhrk = 'RES')) and\r\n            cartip = 'gelgidkart' and\r\n            sil = 0 and\r\n            yertip = @yertip if @tipdty = 'genel'\r\n      insert into ##Resvardiozet(varno, ickkod, ickad, sr, perkod, perad, grs,\r\n       cks)\r\n      select @varno,\r\n             'ODETT',\r\n             'Ödeme Tutarı',\r\n             6,\r\n             @perkod,\r\n             @perad,\r\n             0,\r\n             isnull(sum(cikan * kur), 0)\r\n      from kasahrk\r\n      where varno = @varno and\r\n            ((islmtip = 'ODE' and\r\n            cartip <> 'gelgidkart') or\r\n            (islmtip = 'BNK' and\r\n            islmhrk = 'YTN')) and\r\n            sil = 0 and\r\n            yertip = @yertip if @tipdty = 'detay'\r\n      begin\r\n\r\n      insert into ##Resvardiozet(varno, ickkod, ickad, sr, perkod, perad, grs,\r\n       cks)\r\n      values (@varno, 'ODETT', 'Ödeme Tutarı', 6, @perkod, @perad, 0, 0)\r\n      insert into ##Resvardiozet(varno, ickkod, ickad, sr, perkod, perad, grs,\r\n       cks)\r\n      select @varno,\r\n             'CAROD',\r\n             'Cari Ödemeler',\r\n             8,\r\n             @perkod,\r\n             @perad,\r\n             0,\r\n             isnull(sum(cikan * kur), 0)\r\n      from kasahrk\r\n      where varno = @varno and\r\n            (islmtip = 'ODE' and\r\n            cartip = 'carikart') and\r\n            sil = 0 and\r\n            yertip = @yertip\r\n      insert into ##Resvardiozet(varno, ickkod, ickad, sr, perkod, perad, grs,\r\n       cks)\r\n      select @varno,\r\n             'PEROD',\r\n             'Personel Ödemeler',\r\n             10,\r\n             @perkod,\r\n             @perad,\r\n             0,\r\n             isnull(sum(cikan * kur), 0)\r\n      from kasahrk\r\n      where varno = @varno and\r\n            (islmtip = 'ODE' and\r\n            cartip = 'perkart') and\r\n            sil = 0 and\r\n            yertip = @yertip end;\r\n\r\n\r\n      if @tipdty='genel'\r\n      begin\r\n      insert into ##Resvardiozet(varno, ickkod, ickad, sr, perkod, perad, grs,\r\n       cks)\r\n      select @varno,\r\n             'TAHTT',\r\n             'Tahsilat Tutarı',\r\n             7,\r\n             @perkod,\r\n             @perad,\r\n             isnull(sum(giren * kur), 0),\r\n             0\r\n      from kasahrk\r\n      where varno = @varno and\r\n            ((islmtip = 'TAH' and\r\n            cartip <> 'gelgidkart') or\r\n            (islmtip = 'BNK' and\r\n            islmhrk = 'CKN')) and\r\n            sil = 0 and\r\n            yertip = @yertip end;\r\n\r\n\r\n      if @tipdty='detay'\r\n      begin\r\n      insert into ##Resvardiozet(varno, ickkod, ickad, sr, perkod, perad, grs,\r\n       cks)\r\n      values (@varno, 'TAHTT', 'Tahsilat Tutarı', 7, @perkod, @perad, 0, 0);\r\n\r\n\r\n      insert into ##Resvardiozet(varno, ickkod, ickad, sr, perkod, perad, grs,\r\n       cks)\r\n      select @varno,\r\n             'CARTH',\r\n             'Cari Tahsilat',\r\n             9,\r\n             @perkod,\r\n             @perad,\r\n             isnull(sum(giren * kur), 0),\r\n             0\r\n      from kasahrk\r\n      where varno = @varno and\r\n            (islmtip = 'TAH' and\r\n            cartip = 'carikart') and\r\n            sil = 0 and\r\n            yertip = @yertip\r\n      insert into ##Resvardiozet(varno, ickkod, ickad, sr, perkod, perad, grs,\r\n       cks)\r\n      select @varno,\r\n             'PERTH',\r\n             'Personel Tahsilat',\r\n             11,\r\n             @perkod,\r\n             @perad,\r\n             isnull(sum(giren * kur), 0),\r\n             0\r\n      from kasahrk\r\n      where varno = @varno and\r\n            (islmtip = 'TAH' and\r\n            cartip = 'perkart') and\r\n            sil = 0 and\r\n            yertip = @yertip\r\n      insert into ##Resvardiozet(varno, ickkod, ickad, sr, perkod, perad, grs,\r\n       cks)\r\n      select @varno,\r\n             'PRKTH',\r\n             'Perakende Tahsilat',\r\n             13,\r\n             @perkod,\r\n             @perad,\r\n             isnull(sum(giren * kur), 0),\r\n             0\r\n      from kasahrk\r\n      where varno = @varno and\r\n            (islmtip = 'TAH' and\r\n            cartip = 'perakendekart') and\r\n            sil = 0 and\r\n            yertip = @yertip end;\r\n\r\n\r\n\r\n      insert into ##Resvardiozet(varno, ickkod, ickad, sr, perkod, perad, grs,\r\n       cks)\r\n      select @varno,\r\n             'GELIR',\r\n             'Gelir Tutarı',\r\n             20,\r\n             @perkod,\r\n             @perad,\r\n             isnull(sum(alacak * kur), 0),\r\n             0\r\n      from carihrk\r\n      where varno = @varno and\r\n            islmtip = 'TAH' and\r\n            cartip = 'gelgidkart' and\r\n            sil = 0 and\r\n            yertip = @yertip\r\n      insert into ##Resvardiozet(varno, ickkod, ickad, sr, perkod, perad, grs,\r\n       cks)\r\n      select @varno,\r\n             'NAKTS',\r\n             'Nakit Teslimat Tutarı',\r\n             21,\r\n             @perkod,\r\n             @perad,\r\n             0,\r\n             isnull(sum(giren * kur), 0)\r\n      from kasahrk\r\n      where varno = @varno and\r\n            sil = 0 and\r\n            yertip = @yertip and\r\n            islmtip = 'TAH' AND\r\n            islmhrk = 'TES' and\r\n            masterid = 0 if @tipdty = 'detay'\r\n      begin\r\n\r\n      insert into ##Resvardiozet(varno, ickkod, ickad, sr, perkod, perad, grs,\r\n       cks)\r\n      select @varno,\r\n             'CEKST',\r\n             'Çek-Senet',\r\n             25,\r\n             @perkod,\r\n             @perad,\r\n             isnull(sum(giren * kur), 0),\r\n             isnull(sum(cikan * kur), 0)\r\n      from cekkart\r\n      where varno = @varno and\r\n            sil = 0 and\r\n            yertip = @yertip\r\n      insert into ##Resvardiozet(varno, ickkod, ickad, sr, perkod, perad, grs,\r\n       cks)\r\n      select @varno,\r\n             'BNKCK',\r\n             'Banka Çekilen',\r\n             26,\r\n             @perkod,\r\n             @perad,\r\n             isnull(sum(giren * kur), 0),\r\n             0\r\n      from kasahrk\r\n      where varno = @varno and\r\n            islmtip = 'BNK' and\r\n            islmhrk = 'CKN' and\r\n            sil = 0 and\r\n            yertip = @yertip\r\n      insert into ##Resvardiozet(varno, ickkod, ickad, sr, perkod, perad, grs,\r\n       cks)\r\n      select @varno,\r\n             'BNKYT',\r\n             'Banka Yatan',\r\n             27,\r\n             @perkod,\r\n             @perad,\r\n             0,\r\n             isnull(sum(cikan * kur), 0)\r\n      from kasahrk\r\n      where varno = @varno and\r\n            islmtip = 'BNK' and\r\n            islmhrk = 'YTN' and\r\n            sil = 0 and\r\n            yertip = @yertip end;\r\n\r\n\r\n      insert into ##Resvardiozet(varno, ickkod, ickad, sr, perkod, perad, grs,\r\n       cks)\r\n      select @varno,\r\n             'aratp',\r\n             'Ara Toplam',\r\n             40,\r\n             @perkod,\r\n             @perad,\r\n             sum(grs),\r\n             sum(cks)\r\n      from ##resvardiozet\r\n      where varno = @varno\r\n      select @acik =(grs - cks)\r\n      from ##Resvardiozet\r\n      where ickkod = 'aratp' and\r\n            varno = @varno if @acik < 0\r\n      begin\r\n      set @fazla=0;\r\n      set @acik=-@acik;\r\n      end\r\n      else\r\n      begin\r\n      set @fazla=@acik;\r\n      set @acik=0;\r\n      end;\r\n\r\n      insert into ##Resvardiozet(varno, ickkod, ickad, sr, perkod, perad, grs,\r\n       cks)\r\n      values (@varno, 'ackfz', 'Fark', 41, @perkod, @perad, @acik, @fazla);\r\n\r\n      select @acik = sum(grs),\r\n             @fazla = sum(cks)\r\n      from ##Resvardiozet\r\n      where (ickkod = 'aratp' or\r\n            ickkod = 'ackfz') and\r\n            varno = @varno\r\n      insert into ##Resvardiozet(varno, ickkod, ickad, sr, perkod, perad, grs,\r\n       cks)\r\n      values (@varno, 'gentp', 'Genel Toplam', 42, @perkod, @perad, @acik,\r\n       @fazla);\r\n\r\n\r\n\r\n  FETCH NEXT FROM marvardiozetx INTO  @varno\r\n  END\r\n  CLOSE marvardiozetx\r\n  DEALLOCATE marvardiozetx\r\n\r\n\r\n\r\nSET NOCOUNT OFF\r\n\r\n/*select sr as id,varno,ickkod,ickad,sr,sum(grs) grs,sum(cks) cks from pomvardiozet */\r\n/*where varno=@varno group by varno,ickkod,ickad,sr order by sr */\r\n\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "sayacacilis",
    "definition": "CREATE PROCEDURE [dbo].sayacacilis @sayackod varchar(20)\r\nAS\r\nBEGIN\r\n\r\ndeclare @kod varchar(20);\r\ndeclare @acendks float\r\ndeclare @acmekendks float\r\ndeclare @idx float;\r\ndeclare @borc float,@alacak float,@sayachrkid float;\r\ndeclare @olustar datetime,@tarx datetime;\r\ndeclare @saatx varchar(8);\r\ndeclare @user varchar(50);\r\n\r\ndeclare @islmtip varchar(20);\r\ndeclare @islmtipad varchar(20);\r\n\r\nselect @islmtip=kod,@islmtipad=ad from stkhrktip where kod='KARTAC'\r\n\r\n\r\nselect @idx=id,@kod=kod,@acendks=acendks,@acmekendks=acmekendks,\r\n@olustar=olustarsaat,@user=olususer from sayackart\r\nwhere kod=@sayackod\r\n\r\n\r\nif  (@acendks>0) or (@acmekendks>0) begin\r\nset @tarx=convert(varchar,@olustar,101);\r\nset @saatx=convert(varchar,@olustar,108);\r\n\r\n\r\nselect @sayachrkid=isnull(max(sayachrkid),1) from sayachrk;\r\n\r\ninsert into sayachrk (sayachrkid,sayackod,tarih,saat,\r\nilkendks,sonendks,ilkmekendks,sonmekendks,\r\nislmtip,islmtipad,\r\nolususer,olustarsaat,yertip,yerad,dataok) values\r\n(@sayachrkid,@kod,@tarx,@saatx,0,@acendks,0,@acmekendks,\r\n@islmtip,@islmtipad,\r\n@user,@olustar,'sayackart','SAYAÇ KARTI',0);\r\nend;\r\n\r\n\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "sayacsonendks",
    "definition": "CREATE PROCEDURE [dbo].sayacsonendks @sayackod varchar(20)\r\nAS\r\nBEGIN\r\ndeclare @sonendks float\r\ndeclare @sonmekendks float\r\n\r\nselect top 1\r\n@sonendks=isnull(sonendks,0),\r\n@sonmekendks=isnull(sonmekendks,0)\r\n from sayachrk as mas\r\nwhere mas.sayackod=@sayackod and mas.sil=0 order by mas.id  desc\r\n\r\nupdate sayackart set\r\n     sonendks=@sonendks,\r\n     sonmekendks=@sonmekendks\r\n     where kod=@sayackod\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "sayacyenifiyat",
    "definition": "CREATE PROCEDURE [dbo].sayacyenifiyat\r\n@firmano   int,\r\n@varno     float\r\nAS\r\nBEGIN\r\n\r\n  declare @STOK_KOD             VARCHAR(30)\r\n  declare @KDVTIP \t\t        VARCHAR(10)\r\n  declare @GECSTOK_KOD \t        VARCHAR(30)\r\n  declare @BRIM_FIYAT \t        FLOAT\r\n  declare @KDVORAN \t\t        FLOAT\r\n  declare @kart_ak_isle         int\r\n  SET @GECSTOK_KOD=''\r\n  \r\n\r\n set @kart_ak_isle=1\r\n \r\n select @kart_ak_isle=ISNULL(Kart_ak_isle,0) from Firma \r\n  where id=@firmano\r\n  \r\n   \r\n  /*Ortalama  */\r\n  DECLARE sayacyenifiyat_cur CURSOR LOCAL FOR\r\n  SELECT stkod from pomvardisayac\r\n  where varno=@varno and sil=0 and satmik>0 \r\n  group by stkod\r\n  /*,Round(brimfiy,4) */\r\n  OPEN sayacyenifiyat_cur\r\n  FETCH NEXT FROM sayacyenifiyat_cur INTO \r\n  @STOK_KOD/*,@BRIM_FIYAT */\r\n  WHILE @@FETCH_STATUS = 0\r\n  BEGIN\r\n  \r\n  /*IF @GECSTOK_KOD<>@STOK_KOD */\r\n   /*BEGIN */\r\n   SET @GECSTOK_KOD=@STOK_KOD\r\n   \r\n   SELECT @KDVTIP=sat1kdvtip,@KDVORAN=sat1kdv FROM stokkart where tip='akykt'\r\n   and kod=@STOK_KOD\r\n   if (@KDVTIP='Hariç') and (@KDVORAN>0)\r\n   set @KDVORAN=1+(@KDVORAN/100)\r\n   else\r\n   set @KDVORAN=1\r\n\r\n  if @kart_ak_isle=1\r\n   begin \r\n     SELECT @BRIM_FIYAT=Max(Round(brimfiy,4)) from pomvardisayac\r\n     where varno=@varno and sil=0 and satmik>0  and stkod=@STOK_KOD\r\n     \r\n     update stokkart set sat1fiy=(@BRIM_FIYAT/@KDVORAN) where tip='akykt'\r\n     and kod=@STOK_KOD\r\n   \r\n   end\r\n   \r\n    /*ortalama */\r\n    SELECT @BRIM_FIYAT=Round(Sum(brimfiy*satmik)/Sum(satmik),6) from pomvardisayac\r\n    where varno=@varno and sil=0 and satmik>0   and stkod=@STOK_KOD\r\n\r\n   update pomvardistok set brimfiy=@BRIM_FIYAT where stktip='akykt'\r\n   and kod=@STOK_KOD and varno=@varno\r\n\r\n   update pomvarditank set brimfiy=@BRIM_FIYAT where stktip='akykt'\r\n   and kod=@STOK_KOD and varno=@varno\r\n\r\n\r\n  /* END */\r\n\r\n  FETCH NEXT FROM sayacyenifiyat_cur  INTO @STOK_KOD/*,@BRIM_FIYAT */\r\n  END\r\n\r\n  CLOSE sayacyenifiyat_cur\r\n  DEALLOCATE sayacyenifiyat_cur\r\n  \r\n  \r\n  /*\r\n  SELECT stkod,Max(Round(brimfiy,4)) from pomvardisayac\r\n  where varno=@varno and sil=0 and satmik>0 group by \r\n  */\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "sayimgiris",
    "definition": "CREATE PROCEDURE [dbo].sayimgiris \r\n@sayid float,\r\n@saygrp1id int,\r\n@saygrp2id int,\r\n@saygrp3id int\r\nAS\r\nBEGIN\r\n\r\ndeclare @mesaj varchar(100)\r\n    DECLARE @TB_SAYIMHRK TABLE (\r\n    id                  FLOAT,\r\n    DEP_KOD             VARCHAR(30) COLLATE Turkish_CI_AS,\r\n    STOK_TIP            VARCHAR(10) COLLATE Turkish_CI_AS,\r\n    STOK_KOD            VARCHAR(30) COLLATE Turkish_CI_AS,\r\n    DRM                 VARCHAR(10) COLLATE Turkish_CI_AS,\r\n    SAYDRM              VARCHAR(10) COLLATE Turkish_CI_AS,\r\n    SAYILAN_MIK         FLOAT,\r\n    ONLINESAYILAN_MIK   FLOAT,\r\n    ONLINETARIHSAAT     DATETIME,\r\n    ONLINESAYIM         BIT)\r\n\r\n\r\n  declare @grp1 int,@grp2 int,@grp3 int\r\n  declare @depkod varchar(30),@stktip varchar(10)\r\n  declare @stkod varchar(30)\r\n  declare @brmfiytip varchar(30)\r\n  declare @kdvtip varchar(5)\r\n  declare @saybastar datetime\r\n  declare @tarih datetime,@saat varchar(8)\r\n  declare @olustarsaat datetime,@olususer varchar(50)\r\n\r\n\r\n    insert into @TB_SAYIMHRK (id,DEP_KOD,STOK_TIP,STOK_KOD,DRM,SAYDRM,SAYILAN_MIK,\r\n    ONLINESAYILAN_MIK,ONLINETARIHSAAT,ONLINESAYIM)\r\n    select  hk.id,hk.depkod,hk.stktip,hk.stkod,hk.drm,hk.saydrm,hk.sayimmik,\r\n    hk.OnlineSayimMiktar,hk.OnlineSayimTarihSaat,hk.OnlineSayim\r\n    from  sayimhrk as hk with (nolock)\r\n    inner join stokkart as k with (nolock)\r\n    on k.kod=hk.stkod and k.tip=hk.stktip and k.sil=0\r\n /*   left join grup as g on g.id=(case when k.grp3>0 then k.grp3 */\r\n /*   when k.grp2>0 then k.grp2 */\r\n /*   when k.grp1>0 then k.grp1 end) and g.sil=0 */\r\n    where hk.sayid=@sayid\r\n    and k.grp1=@saygrp1id and k.grp2=@saygrp2id and k.grp3=@saygrp3id\r\n\r\n    select @brmfiytip=brmfiytip,@depkod=depkod,@kdvtip=kdvtip,@tarih=tarih,@saat=saat,\r\n    @saybastar=(tarih+cast(saat as datetime)),\r\n    @olustarsaat=case when olustarsaat>0 then degtarsaat else olustarsaat end,\r\n    @olususer=case when olususer<>'' then deguser else olususer end\r\n    from sayimmas as sm with (nolock) where sayid=@sayid\r\n   \r\n    delete from sayimhrk where sayid=@sayid and id in\r\n    (select id from @TB_SAYIMHRK)\r\n\r\n   insert into sayimhrk (tarih,saat,sayid,depkod,stktip,stkod,mevcutmik,\r\n   brmfiy,kdvyuz,kdvtip,olustarsaat,olususer)\r\n   select @tarih,@saat,@sayid,@depkod,D.STOK_TIP,D.STOK_KOD,\r\n   d.MIKTAR,case\r\n   when @brmfiytip='SIFIR FIYAT' then 0\r\n   when (@brmfiytip='ORTALAMA ALIS FIYAT') and @kdvtip='DAHIL' then\r\n   d.ORT_BRMFIY_D\r\n   when (@brmfiytip='ORTALAMA ALIS FIYAT') and @kdvtip='HARIC' then\r\n   d.ORT_BRMFIY_H\r\n   when (@brmfiytip='ALIS FIYAT') and @kdvtip='DAHIL' then\r\n   d.ALS_BRMFIY_D\r\n   when (@brmfiytip='ALIS FIYAT') and @kdvtip='HARIC' then\r\n   d.ALS_BRMFIY_H\r\n   when (@brmfiytip='SATIS FIYAT-1') and @kdvtip='DAHIL' then\r\n   d.SAT1_BRMFIY_D\r\n   when (@brmfiytip='SATIS FIYAT-1') and @kdvtip='HARIC' then\r\n   d.SAT1_BRMFIY_H\r\n   when (@brmfiytip='SATIS FIYAT-2') and @kdvtip='DAHIL' then\r\n   d.SAT2_BRMFIY_D\r\n   when (@brmfiytip='SATIS FIYAT-2') and @kdvtip='HARIC' then\r\n   d.SAT2_BRMFIY_H end,\r\n/*---kdv */\r\n   case when @brmfiytip='SIFIR FIYAT' then 0\r\n   when (@brmfiytip='ORTALAMA ALIS FIYAT') then\r\n   d.ALS_KDV_YUZ\r\n   when (@brmfiytip='ALIS FIYAT') then\r\n   d.ALS_KDV_YUZ\r\n   when (@brmfiytip='SATIS FIYAT-1') then\r\n   d.SAT1_KDV_YUZ\r\n   when (@brmfiytip='SATIS FIYAT-2') then\r\n   d.SAT2_KDV_YUZ end,\r\n   @kdvtip,@olustarsaat,@olususer FROM STOK_SAYIM_GRUP_FIRMA_DEPO\r\n   (@sayid,@saygrp1id,@saygrp2id,@saygrp3id,@depkod,@saybastar) as d\r\n  \r\n\r\n\r\n   update sayimhrk set sayimmik=dt.SAYILAN_MIK,\r\n   OnlineSayimMiktar=dt.ONLINESAYILAN_MIK,\r\n   OnlineSayimTarihSaat=dt.ONLINETARIHSAAT,\r\n   OnlineSayim=dt.ONLINESAYIM,\r\n   drm=dt.DRM,saydrm=dt.SAYDRM\r\n   from sayimhrk as t with (nolock) join\r\n   (select DEP_KOD,STOK_TIP,STOK_KOD,DRM,SAYDRM,SAYILAN_MIK,\r\n   ONLINESAYILAN_MIK,ONLINETARIHSAAT,ONLINESAYIM\r\n   from @TB_SAYIMHRK ) dt on t.stkod=dt.STOK_KOD and t.stktip=dt.STOK_TIP\r\n   and t.sayid=@sayid\r\n   \r\n   \r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "sayimonayla",
    "definition": "CREATE PROCEDURE [dbo].sayimonayla @sayid float,@drm varchar(5)\r\nAS\r\nBEGIN\r\ndeclare @islmtip varchar(20)\r\ndeclare @islmtipad varchar(30)\r\ndeclare @islmtip1 varchar(20)\r\ndeclare @islmtipad1 varchar(30)\r\n\r\ndeclare @tabload varchar(30)\r\n\r\nset @tabload='sayimhrk'\r\n\r\n \r\n delete from stkhrk where tabload=@tabload\r\n and stkhrkid in (select id from sayimhrk as h with (nolock) where h.sayid=@sayid)\r\n \r\n if @drm='B'\r\n    RETURN\r\n\r\n   select @islmtip=kod,@islmtipad=ad from stkhrktip where kod='SAYSON'\r\n\r\n   insert stkhrk (Firmano,stkhrkid,sayid,stkod,tarih,saat,stktip,olustarsaat,olususer,islmtip,islmtipad,\r\n   yertip,yerad,giren,cikan,depkod,brmfiykdvli,kdvyuz,tabload,belno,ack)\r\n \r\n   select mas.firmano,h.id,h.sayid,stkod,\r\n   case when h.OnlineSayimTarihSaat is null then  mas.onaytarih\r\n   else CONVERT(varchar(10), h.OnlineSayimTarihSaat, 121) end,\r\n   case when h.OnlineSayimTarihSaat is null then mas.onaysaat \r\n   else CONVERT(varchar(8), h.OnlineSayimTarihSaat, 108) end,\r\n   stktip,h.olustarsaat,h.olususer,@islmtip,@islmtipad,mas.yertip,mas.yerad,\r\n   case when (h.sayimmik-h.mevcutmik)>0 then abs(h.sayimmik-h.mevcutmik) else 0 end,\r\n   case when (h.sayimmik-h.mevcutmik)<0 then abs(h.sayimmik-h.mevcutmik) else 0 end,\r\n   h.depkod,brmfiy,kdvyuz,@tabload,cast(h.sayid as varchar(20)),\r\n   mas.onayack from sayimhrk as h  with (nolock)\r\n   inner join sayimmas as mas on mas.sayid=h.sayid and mas.sayid=@sayid\r\n   and abs(h.sayimmik-h.mevcutmik)>0\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "siparisisle",
    "definition": "CREATE PROCEDURE [dbo].siparisisle @fatid float\r\nAS\r\nBEGIN\r\ndeclare @fattip varchar(10)\r\n\r\nif (select top 1 kaptip from faturamas where fatid=@fatid)='SIP'\r\nupdate siparishrk set tesmik=isnull(dt.tesmik,0) from siparishrk t join\r\n(select kaphrkid,sum(mik) as tesmik from faturahrk where sil=0 and kayok=1\r\nand fatid=@fatid and kaptip='SIP' group by kaphrkid) dt on\r\nt.id=dt.kaphrkid\r\n\r\n/*------------------------------------------------------------------------------------------ */\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "Slipaktar",
    "definition": "CREATE PROCEDURE [dbo].Slipaktar\r\n@tutarytl       float,\r\n@bankkomtut     float,\r\n@komgidkod      varchar(30),\r\n@ekkomtut       float,\r\n@ekgidkod       varchar(30),\r\n@tarih          datetime,\r\n@Saat            varchar(10),\r\n@userad         varchar(100),\r\n@ack            varchar(150),\r\n@GuidStr        varchar(50)\r\nAS\r\nBEGIN\r\n\r\n  DECLARE @EKSTRE_TEMP TABLE (\r\n  poshrkid      int)\r\n\r\n   declare @hrk_id        int\r\n   declare @hrk_phrkid    int\r\n   declare @hrk_kaltut    float\r\n   declare @poshrktut     float\r\n   declare @brmfiy        float\r\n   declare @gctip         varchar(1)\r\n   declare @giren         float\r\n   declare @cikan         float\r\n   declare @newid         int\r\n   declare @islmtip       varchar(20)\r\n   declare @islmhrk       varchar(20)\r\n   declare @islmtipad     varchar(30)\r\n   declare @islmhrkad     varchar(30)\r\n   declare @hrk_bankod    varchar(30)\r\n   declare @bankod        varchar(50)\r\n   declare @poskod        varchar(50)\r\n   declare @yertip        varchar(30)\r\n   declare @yertipad      varchar(50)\r\n  /* declare @saatx         varchar(8) */\r\n   declare @parabrm       varchar(8)\r\n   declare @parakur       float\r\n   declare @say           int\r\n   declare @mesaj         varchar(300)\r\n   \r\n   declare @FirmanNo       int\r\n   \r\n   declare @ErrorNo int\r\n   declare @ErrorMesaj varchar(200)\r\n   declare @IdMesaj varchar(200)\r\n\r\n  /*----pos parcala */\r\n   set @ErrorNo=1\r\n   set @IdMesaj=''\r\n   \r\n   if @tutarytl>0  /*tutar girilmisse */\r\n   begin\r\n   set @hrk_kaltut=Round(@tutarytl,2)\r\n\r\n    DECLARE POSAKTAR_HRK CURSOR FAST_FORWARD FOR\r\n    SELECT  p.id,p.bankod,p.poskod,p.poshrkid,\r\n    Round(giren,2) FROM poshrk as p with (nolock)\r\n    WHERE   p.sil=0 and p.poshrkid in (select poshrkid from ##pos_slip_aktar where GuidStr=@GuidStr)\r\n    order by p.id\r\n    OPEN POSAKTAR_HRK\r\n\r\n    delete from @EKSTRE_TEMP\r\n\r\n    FETCH NEXT FROM POSAKTAR_HRK INTO\r\n    @hrk_id,@hrk_bankod,@poskod,@hrk_phrkid,@poshrktut\r\n    WHILE @@FETCH_STATUS = 0\r\n    BEGIN\r\n     set @bankod=@hrk_bankod\r\n\r\n    if @hrk_kaltut>0 \r\n     begin\r\n      Insert @EKSTRE_TEMP  Values (@hrk_phrkid)\r\n      if @IdMesaj=''\r\n       set @IdMesaj=cast(@hrk_phrkid as varchar)\r\n      else\r\n       set @IdMesaj=@IdMesaj+','+cast(@hrk_phrkid as varchar)\r\n     end\r\n     \r\n     if round(@hrk_kaltut,2)<round(@poshrktut,2)\r\n     begin\r\n   \r\n        if round(@hrk_kaltut,2)>0        \r\n         exec slipparcala @hrk_phrkid,@hrk_kaltut,@userad\r\n      break\r\n     end\r\n\r\n    set @hrk_kaltut=Round(@hrk_kaltut,2)-Round(@poshrktut,2)\r\n\r\n\r\n    FETCH NEXT FROM POSAKTAR_HRK INTO\r\n    @hrk_id,@hrk_bankod,@poskod,@hrk_phrkid,@poshrktut\r\n    END\r\n\r\n    CLOSE POSAKTAR_HRK\r\n    DEALLOCATE POSAKTAR_HRK\r\n  end  /*tutar girilmisse */\r\n  \r\n  \r\n  /*----------------- */\r\n\r\n  /* set @saatx=convert(varchar,getdate(),108); */\r\n  \r\n   BEGIN TRANSACTION\r\n   BEGIN TRY  \r\n   \r\n   set @ErrorNo=2\r\n   \r\n   set @islmtip='BNK'\r\n   set @islmhrk='SLO'\r\n   set  @yertip='poskart'\r\n   select @islmtipad=ad from islemturtip where tip=@islmtip\r\n   select @islmhrkad=ad from islemhrktip where tip=@islmtip and hrk=@islmhrk\r\n   select @yertipad=ad from yertipad where kod=@yertip\r\n\r\n   select @bankod=bankod from poskart where kod=@poskod\r\n\r\n   select @parabrm=b.parabrm,@FirmanNo=Firmano from bankakart as b where b.kod=@bankod\r\n\r\n   \r\n   select @newid=0\r\n   insert into bankahrk (firmano,gctip,islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n   cartip,masterid,varno,bankhrkid,perkod,adaid,vadetar,tarih,saat,cartur,carkod,bankod,\r\n   belno,ack,borc,alacak,kur,parabrm,olususer,olustarsaat)\r\n   values (@FirmanNo,'B',@islmtip,@islmtipad,@islmhrk,@islmhrkad,@yertip,@yertipad,\r\n   '',@newid,0,@newid,'',0,@tarih,@tarih,@saat,'','',@bankod,'',@ack,\r\n   @tutarytl,0,1,@parabrm,@userad,getdate())\r\n   \r\n   select @newid=SCOPE_IDENTITY() \r\n   update bankahrk set masterid=id,bankhrkid=id where id=@newid\r\n   \r\n   set @ErrorNo=3\r\n    if @newid=0\r\n     begin\r\n        RAISERROR ('Aktarma bankahrk Yeni Id İşlemi Hatalı Tekrar Deneyiniz', 16,1) \r\n     end\r\n  \r\n   \r\n   if @bankkomtut>0\r\n   begin\r\n   set @islmhrk='BKK'\r\n   select @islmhrkad=ad from islemhrktip where tip=@islmtip and hrk=@islmhrk\r\n\r\n   insert into bankahrk (firmano,gctip,islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,cartip,\r\n   masterid,varno,bankhrkid,perkod,adaid,vadetar,tarih,saat,cartur,carkod,bankod,\r\n   belno,ack,borc,alacak,kur,parabrm,olususer,olustarsaat)\r\n   values (@FirmanNo,'A',@islmtip,@islmtipad,@islmhrk,@islmhrkad,@yertip,@yertipad,\r\n   'gelgidkart',@newid,0,@newid,'',0,@tarih,@tarih,@saat,'',@komgidkod,@bankod,\r\n   '',@ack,0,@bankkomtut,1,@parabrm,\r\n   @userad,getdate())\r\n   end\r\n\r\n   if @ekkomtut>0\r\n   begin\r\n   set @islmhrk='EKK'\r\n   select @islmhrkad=ad from islemhrktip where tip=@islmtip and hrk=@islmhrk\r\n   \r\n   insert into bankahrk (firmano,gctip,islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,cartip,\r\n   masterid,varno,bankhrkid,perkod,adaid,vadetar,tarih,saat,cartur,carkod,bankod,\r\n   belno,ack,borc,alacak,kur,parabrm,olususer,olustarsaat)\r\n   values (@FirmanNo,'A',@islmtip,@islmtipad,@islmhrk,@islmhrkad,@yertip,@yertipad,\r\n   'gelgidkart',@newid,0,@newid,'',0,@tarih,@tarih,@saat,'',@ekgidkod,@bankod,\r\n   '',@ack,0,@ekkomtut,1,@parabrm,\r\n   @userad,getdate())\r\n   end\r\n\r\n    set @ErrorNo=4\r\n  \r\n    /*-slipleri aktarılmıs olarak isaretle */\r\n    update poshrk set aktip='AK',akid=@newid,aktar=@tarih,\r\n    deguser=@userad,degtarsaat=getdate()\r\n     where poshrkid in (select * from @EKSTRE_TEMP)\r\n     and sil=0\r\n\r\n    set @ErrorNo=5\r\n    \r\n    END TRY  \r\n    BEGIN CATCH \r\n      set @ErrorMesaj= 'Aktarma İşlemi Hatalı '+CAST(@ErrorNo as varchar(50))+\r\n      ' IdMesaj='+@IdMesaj+' Tekrar Deneyiniz'\r\n      RAISERROR (@ErrorMesaj, 16,1) \r\n      ROLLBACK TRANSACTION\r\n      RETURN\r\n   END CATCH\r\n\r\n   COMMIT TRANSACTION\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "SlipBirlestir",
    "definition": "CREATE PROCEDURE [dbo].SlipBirlestir @Ana_id bigint\r\nAS\r\nBEGIN\r\n\r\n\r\n   declare @TopTutar\t\tfloat\r\n   declare @mesaj\t\t\tnvarchar(500)\t\r\n   \r\n   if (select count(*) from poshrk\r\n   where ana_id=@Ana_id and aktip='AK' and sil=0)>0 \r\n    begin\r\n     \r\n    \r\n      set @mesaj=''\r\n      select @mesaj='Slipler İçinde Bankaya Aktarılmış Slipler Bulunmakta...!'\r\n      RAISERROR (@mesaj, 16,1)\r\n      ROLLBACK TRANSACTION\r\n      RETURN\r\n     \r\n    end\r\n    \r\n   \r\n   \r\n   \r\n   \r\n   select @TopTutar=sum(giren) from poshrk\r\n   where ana_id=@Ana_id and sil=0\r\n   \r\n   \r\n   \r\n   update poshrk set giren=@TopTutar,Ana_id=0 where \r\n   poshrkid=@Ana_id\r\n   \r\n   \r\n   delete from poshrk where ana_id=@Ana_id\r\n   \r\nEND"
  },
  {
    "schema": "dbo",
    "name": "slipparcala",
    "definition": "CREATE PROCEDURE [dbo].slipparcala\r\n@poshrkid float,\r\n@odentut float,\r\n@userad  varchar(100)\r\nAS\r\nBEGIN\r\ndeclare @topmastut \t\tfloat\r\ndeclare @poshrktut \t\tfloat\r\ndeclare @brmfiy \t\tfloat\r\ndeclare @idxmas \t\tfloat\r\ndeclare @idx \t\t\tfloat\r\ndeclare @kalan \t\t\tfloat\r\ndeclare @newid \t\t\tfloat\r\n\r\n SET NOCOUNT ON\r\n\r\n\r\n  select @idxmas=poshrkid,@topmastut=isnull(giren,0) from \r\n  poshrk with (nolock)  where poshrkid=@poshrkid\r\n  and aktip='BK' and akid=0\r\n\r\n  set @kalan=@odentut\r\n\r\n  if @odentut<@topmastut\r\n  begin\r\n\r\n  DECLARE slipparcalax CURSOR FAST_FORWARD FOR SELECT \r\n   id,poshrkid,giren FROM poshrk with (nolock) where poshrkid=@poshrkid\r\n    OPEN slipparcalax\r\n    FETCH NEXT FROM slipparcalax INTO  @idx,@poshrkid,@poshrktut\r\n    WHILE @@FETCH_STATUS = 0\r\n     BEGIN\r\n\r\n    set @kalan=@kalan-@poshrktut\r\n     if @kalan<0\r\n      begin\r\n\r\n      /*select @newverid=max(poshrkid)+1 from poshrk */\r\n      \r\n      /* yeni fis olustuluyor */\r\n      insert into poshrk (firmano,poshrkid,varno,perkod,adaid,islmtip,islmtipad,\r\n      islmhrk,islmhrkad,yertip,yerad,masterid,gctip,tarih,saat,\r\n      carslip,cartip_id,cartip,car_id,carkod,\r\n      pos_id,poskod,bank_id,bankod,\r\n      giren,cikan,extrakomyuz,bankomyuz,ack,vadetar,varok,\r\n      sil,olususer,olustarsaat,deguser,degtarsaat,\r\n      dataok,belno,kur,aktar,aktip,gerialtar,\r\n      bagid,ana_id,parabrm,ekkomyuz,akid,devir)\r\n      select firmano,0,varno,perkod,adaid,islmtip,islmtipad,\r\n      islmhrk,islmhrkad,yertip,yerad,masterid,gctip,tarih,saat,\r\n      carslip,cartip_id,cartip,car_id,carkod,\r\n      pos_id,poskod,bank_id,bankod,-@kalan,0,extrakomyuz,bankomyuz,ack,vadetar,varok,\r\n      sil,olususer,olustarsaat,deguser,degtarsaat,dataok,belno,kur,aktar,'BK',gerialtar,\r\n      @idxmas,case when ana_id=0 then @idxmas else ana_id end,parabrm,ekkomyuz,akid,\r\n      devir\r\n      from poshrk with (nolock) where poshrkid=@poshrkid\r\n\r\n      select @newid=SCOPE_IDENTITY()\r\n      update poshrk set poshrkid=@newid where id=@newid\r\n     \r\n     /* ana slip islemi */\r\n      update poshrk set giren=giren+@kalan,\r\n      deguser=@userad,degtarsaat=getdate(),\r\n      dataok=0,ana_id=case when ana_id=0 then poshrkid \r\n      else ana_id end\r\n      where id=@idx\r\n\r\n     /* diger fis hrk yeni fise tasınıyor */\r\n     break\r\n     end\r\n\r\n\r\n   FETCH NEXT FROM slipparcalax INTO  @idx,@poshrkid,@poshrktut\r\n  END\r\n  CLOSE slipparcalax\r\n  DEALLOCATE slipparcalax\r\n\r\nend\r\n  \r\nSET NOCOUNT OFF\r\n  \r\n  \r\nEND"
  },
  {
    "schema": "dbo",
    "name": "sp_ActLog",
    "definition": "CREATE Procedure [dbo].[sp_ActLog]\r\n( @Act int,\r\n  @MID int,\r\n  @FID int,\r\n  @DID int,\r\n  @Tablo varchar(50),\r\n  @Id int,\r\n  @Usr int,\r\n  @Usr2 datetime\r\n)\r\n\r\nas\r\n\r\nif @Act=1\r\nbegin\r\n  Exec('Insert Into '+@Tablo+'_ (MID,FID,DID,Id,Crt,Crt2) values ('+@MID+','+@FID+','+@DID+','+@Id+','+@Usr+','+@Usr2+')')\r\nend\r\nif @Act=0\r\nbegin\r\n  Exec('Update '+@Tablo+'_ Set Upd='+@Usr+',Upd2='+@Usr2+' Where MID='+@MID+' and FID='+@FID+' and DID='+@DID+' and Id='+@Id)\r\nend\r\nif @Act=-1\r\nbegin\r\n  Exec('Update '+@Tablo+'_ Set Del='+@Usr+',Del2='+@Usr2+' Where MID='+@MID+' and FID='+@FID+' and DID='+@DID+' and Id='+@Id)\r\nend\r\nif @Act=-2\r\nbegin\r\n  Exec('Delete from '+@Tablo+'_ Where MID='+@MID+' and FID='+@FID+' and DID='+@DID+' and Id='+@Id)\r\nend"
  },
  {
    "schema": "dbo",
    "name": "Sp_BarkodStokIdDuzelt",
    "definition": "CREATE PROCEDURE [dbo].[Sp_BarkodStokIdDuzelt] \r\n@firmano int,\r\n@tip varchar(50),\r\n@kod varchar(50)\r\nAS\r\nBEGIN\r\n\r\n      update barkod set stk_id=(select id from stokkart where kod=@kod and firmano IN(@firmano,0) and tip=@tip)\r\n      where kod=@kod and firmano IN(@firmano,0) and tip=@tip\r\n            \r\nEND"
  },
  {
    "schema": "dbo",
    "name": "sp_DizinKontrol",
    "definition": "CREATE PROCEDURE [dbo].sp_DizinKontrol\r\n@Dizin VARCHAR(255),\r\n@Klasor VARCHAR(255)\r\nAS\r\nBEGIN\r\nDECLARE @ANSW BIT\r\n\r\nCREATE TABLE #Tmp(Dir varchar(255))\r\n\r\nINSERT INTO #Tmp\r\nEXEC master..xp_subdirs @Dizin\r\n\r\nif @Klasor=''\r\n  set @ANSW=1\r\n else\r\n  begin\r\n   IF EXISTS (Select * from #Tmp WHERE Dir = @Klasor)\r\n   SET @ANSW = 1 ELSE SET @ANSW = 0\r\n   end\r\n\r\nDROP TABLE #Tmp\r\nRETURN @ANSW\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "sp_loglama",
    "definition": "create PROCEDURE [dbo].[sp_loglama]\r\n(\r\n@firmano int,\r\n@id float,\r\n@tabload varchar(30),\r\n@islem int,\r\n@for_log varchar(500)\r\n)\r\nAS\r\nBEGIN\r\n/*\r\n--- 1 insert 0 update -1 delete -2 kalıcı delete\r\n--silen user -tarih- kodu , adi tutari\r\n\r\n  --loglama\r\n  Declare\r\n  @SQL Nvarchar(4000),\r\n  @PARAMDEF NVARCHAR(50),\r\n  @LogAlan varchar(1000),\r\n  @Usr varchar(100),\r\n  @Tarih datetime,\r\n  @Deger varchar(8000),\r\n  @UsrIP varchar(20),\r\n  @UsrPC varchar(50)\r\n\r\n  Set @Usr=''\r\n  Set @Tarih=''\r\n  Set @Deger=''\r\n  Set @UsrIP=''\r\n  Set @UsrPC=''\r\n\r\n  set @LogAlan=''\r\n  Set @LogAlan = (Select Alan from LogAlan Where Tablo=@tabload)\r\n\r\n  if @for_log=''\r\n  begin\r\n\tset @SQL=''\r\n\tset @PARAMDEF='@DegerOut varchar(8000) OUTPUT'\r\n\tset @SQL =N' Declare @TmpDeger varchar(8000) '+\r\n\t\t\t\t' Set @TmpDeger = (Select top 1 '+@LogAlan+' from '+@tabload+\r\n\t\t                   ' where firmano='+cast(@firmano as varchar(20))+' and id='+cast(@id as varchar(20))+') '+\r\n\t\t\t    ' Set @DegerOut=@TmpDeger '\t\r\n\r\n    EXEC SP_EXECUTESQL @SQL,@PARAMDEF,@DegerOut=@Deger out\r\n  end\r\n\r\n  if @islem=1\r\n  begin\r\n    set @SQL=''\r\n\tset @PARAMDEF='@UsrOut varchar(100) OUTPUT'\r\n\tset @SQL =N' Declare @TmpUsr varchar(100)'+\r\n\t\t\t\t' Set @TmpUsr = (Select top 1 olususer from '+@tabload+\r\n\t\t                   ' where firmano='+cast(@firmano as varchar(20))+' and id='+cast(@id as varchar(20))+') '+\r\n\t\t\t    ' Set @UsrOut=@TmpUsr'\t\r\n\r\n    EXEC SP_EXECUTESQL @SQL,@PARAMDEF,@UsrOut=@Usr out\r\n\r\n\tset @SQL=''\r\n\tset @PARAMDEF='@TarihOut datetime OUTPUT'\r\n\tset @SQL =N'Declare @TmpTarih datetime '+\r\n\t\t\t\t' Set @TmpTarih = (Select top 1 olustarsaat from '+@tabload+\r\n\t\t                   ' where firmano='+cast(@firmano as varchar(20))+' and id='+cast(@id as varchar(20))+') '+\r\n\t\t\t    ' Set @TarihOut=@TmpTarih  '\t\r\n\r\n    EXEC SP_EXECUTESQL @SQL,@PARAMDEF,@TarihOut=@Tarih out\r\n\r\n    set @Deger=REPLACE(@Deger,'''','''''')\r\n    Set @UsrIP = (Select isnull(ip,'') from users where ad=@Usr)\r\n    Set @UsrPC = (Select isnull(pc,'') from users where ad=@Usr)\r\n\r\n\tset @SQL=''\r\n    set @SQL='Insert into  userlog( islem,tarih,usr,ip,pcadi,firmano,kayitid,tablo,ack) values '+\r\n          '( ''KAYIT'','''+convert(varchar,@Tarih,120)+''','''+isnull(@Usr,'')+''','''+isnull(@UsrIP,'')+''','''+isnull(@UsrPC,'')+''','+\r\n          cast(@firmano as varchar(20))+','+cast(@id as varchar(20))+','''+isnull(@tabload,'')+''','''+isnull(@Deger,'')+''' )'\r\n    EXEC SP_EXECUTESQL @SQL\r\n\r\n    return\r\n  end\r\n\r\n  if @islem=0\r\n  begin\r\n\tset @SQL=''\r\n\tset @PARAMDEF='@UsrOut varchar(100) OUTPUT'\r\n\tset @SQL =N' Declare @TmpUsr varchar(100)'+\r\n\t\t\t\t' Set @TmpUsr = (Select top 1 deguser from '+@tabload+\r\n\t\t                   ' where firmano='+cast(@firmano as varchar(20))+' and id='+cast(@id as varchar(20))+') '+\r\n\t\t\t    ' Set @UsrOut=@TmpUsr'\t\r\n\r\n    EXEC SP_EXECUTESQL @SQL,@PARAMDEF,@UsrOut=@Usr out\r\n\r\n\tset @SQL=''\r\n\tset @PARAMDEF='@TarihOut datetime OUTPUT'\r\n\tset @SQL =N'Declare @TmpTarih datetime '+\r\n\t\t\t\t' Set @TmpTarih = (Select top 1 degtarsaat from '+@tabload+\r\n\t\t                   ' where firmano='+cast(@firmano as varchar(20))+' and id='+cast(@id as varchar(20))+') '+\r\n\t\t\t    ' Set @TarihOut=@TmpTarih  '\t\r\n\r\n    EXEC SP_EXECUTESQL @SQL,@PARAMDEF,@TarihOut=@Tarih out\r\n\r\n    set @Deger=REPLACE(@Deger,'''','''''')\r\n    Set @UsrIP = (Select ip from users where ad=@Usr)\r\n    Set @UsrPC = (Select pc from users where ad=@Usr)\r\n\r\n    set @SQL='Insert into  userlog( islem,tarih,usr,ip,pcadi,firmano,kayitid,tablo,ack) values '+\r\n          '( ''GÜNCELLEME'','''+convert(varchar,@Tarih,120)+''','''+isnull(@Usr,'')+''','''+isnull(@UsrIP,'')+''','''+isnull(@UsrPC,'')+''','+\r\n          cast(@firmano as varchar(20))+','+cast(@id as varchar(20))+','''+isnull(@tabload,'')+''','''+isnull(@Deger,'')+''' )'\r\n\r\n    EXEC SP_EXECUTESQL @SQL\r\n    return\r\n  end\r\n\r\n  if @islem=-1\r\n  begin\r\n\tset @SQL=''\r\n\tset @PARAMDEF='@UsrOut varchar(100) OUTPUT'\r\n\tset @SQL =N' Declare @TmpUsr varchar(100)'+\r\n\t\t\t\t' Set @TmpUsr = (Select top 1 deguser from '+@tabload+\r\n\t\t                   ' where firmano='+cast(@firmano as varchar(20))+' and id='+cast(@id as varchar(20))+') '+\r\n\t\t\t    ' Set @UsrOut=@TmpUsr'\t\r\n\r\n    EXEC SP_EXECUTESQL @SQL,@PARAMDEF,@UsrOut=@Usr out\r\n\r\n\tset @SQL=''\r\n\tset @PARAMDEF='@TarihOut datetime OUTPUT'\r\n\tset @SQL =N'Declare @TmpTarih datetime '+\r\n\t\t\t\t' Set @TmpTarih = (Select top 1 degtarsaat from '+@tabload+\r\n\t\t                   ' where firmano='+cast(@firmano as varchar(20))+' and id='+cast(@id as varchar(20))+') '+\r\n\t\t\t    ' Set @TarihOut=@TmpTarih  '\t\r\n\r\n    EXEC SP_EXECUTESQL @SQL,@PARAMDEF,@TarihOut=@Tarih out\r\n\r\n\r\n    set @Deger=REPLACE(@Deger,'''','''''')\r\n    Set @UsrIP = (Select ip from users where ad=@Usr)\r\n    Set @UsrPC = (Select pc from users where ad=@Usr)\r\n\r\n\r\n\r\n    set @SQL='Insert into  userlog( islem,tarih,usr,ip,pcadi,firmano,kayitid,tablo,ack) values '+\r\n          '( ''SİLME'','''+convert(varchar,@Tarih,120)+''','''+isnull(@Usr,'')+''','''+isnull(@UsrIP,'')+''','''+isnull(@UsrPC,'')+''','+\r\n          cast(@firmano as varchar(20))+','+cast(@id as varchar(20))+','''+isnull(@tabload,'')+''','''+isnull(@Deger,'')+''' )'\r\n\r\n    EXEC SP_EXECUTESQL @SQL\r\n    return\r\n  end\r\n\r\n  if @islem=-2\r\n  begin\r\n    set @Deger=REPLACE(@Deger,'''','''''')\r\n    \r\n    set @SQL='Insert into  userlog( islem,tarih,usr,ip,pcadi,firmano,kayitid,tablo,ack) values '+\r\n          '( ''SİLME'','''+convert(varchar,@Tarih,120)+''','''+isnull(@Usr,'')+''','''+isnull(@UsrIP,'')+''','''+isnull(@UsrPC,'')+''','+\r\n          cast(@firmano as varchar(20))+','+cast(@id as varchar(20))+','''+isnull(@tabload,'')+''','''+isnull(@Deger,'')+''' )'\r\n\r\n    EXEC SP_EXECUTESQL @SQL\r\n    return\r\n  end\r\n */\r\n return\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "sp_LogMotor",
    "definition": "CREATE procedure [dbo].sp_LogMotor\r\n(\r\n@TabloAd varchar(100),\r\n@Rec_Id varchar(100),\r\n@Islem int, /* 1 Insert , 0 Update , -1 Delete, */\r\n@userid int\r\n)\r\nas\r\n\r\n\r\n\r\nDeclare\r\n\t@TmpAlan varchar(8000),\r\n\t@Alanlar varchar(8000),\r\n\t@ParamAlan varchar(8000),\r\n\t@DeclareAlan varchar(8000),\r\n    @pcadi varchar(50),\r\n    @pcip varchar(20)\r\n    \r\n    select @pcadi=isnull(ip,''),@pcip=isnull(pc,'') from users where id=@userid\r\n\r\n\r\n\tSet @TmpAlan=''\r\n\tSet @Alanlar=''\r\n\tSet @ParamAlan=''\r\n\tSet @DeclareAlan=''\r\n\r\n\r\n\r\nDeclare TabloAlanlari Cursor for\r\nselect COLUMN_NAME from INFORMATION_SCHEMA.COLUMNS where TABLE_NAME = @TabloAd and DATA_TYPE<>'image'\r\n\r\n Open TabloAlanlari\r\n\tFetch Next From TabloAlanlari into  @TmpAlan\r\n\tWhile @@Fetch_status =0\r\n\tbegin\r\n\t  Set @Alanlar = @Alanlar +'@'+@TmpAlan + '=isnull('+@TmpAlan +',''''),'\r\n      Set @ParamAlan =@ParamAlan+'+''|'+@TmpAlan+'=''+@'+@TmpAlan\r\n\t  Set @DeclareAlan=@DeclareAlan+'@'+@TmpAlan+' varchar(8000),'\r\n\t  Fetch Next From TabloAlanlari into  @TmpAlan\r\n\tend\r\n\r\nClose TabloAlanlari\r\nDeallocate TabloAlanlari\r\n\r\nSet @ParamAlan =SUBSTRING ( @ParamAlan ,2 , len(@ParamAlan) )\r\nSet @DeclareAlan =' Declare ' +SUBSTRING ( @DeclareAlan ,1 , len(@DeclareAlan)-1 )\r\nSet @Alanlar =SUBSTRING ( @Alanlar ,1 , len(@Alanlar)-1 )\r\n\r\nDEclare @str_datetime varchar(50)\r\nSet @str_datetime=convert(varchar,getdate(),120)\r\n\r\n\r\nExec(@DeclareAlan+'\r\ndeclare @islemdetay varchar(8000)\r\n select '+@Alanlar+' from '+@TabloAd+' Where id='+@Rec_Id+'\r\n set @islemdetay =(select '+@ParamAlan+' )\r\n insert into eventlog (tarih,recid,userid,islemtipi,islemdetay,ip,pcadi)\r\nvalues ('''+@str_datetime+''','+@Rec_Id+','+@userid+','+@Islem+',@islemdetay,'''+@pcip+''','''+@pcadi+''')')\r\n/*Log insert gelicek */"
  },
  {
    "schema": "dbo",
    "name": "sp_ParaKurManage",
    "definition": "CREATE PROCEDURE [dbo].sp_ParaKurManage(@Act int,@Id int,@ParaBirim_Id int,@tarih datetime,\r\n@userid int,@UserTarih datetime,\r\n@Alis float,@Satis float,@OzelAlis float,@OzelSatis float,\r\n@Return nvarchar(20) output)\r\nAS\r\nBEGIN\r\n\r\ndeclare @MID int,@FID int,@DID int;\r\n/*\r\nselect @MID=mid,@FID=Fid,@DID=Did from users where id=@userid;\r\n\r\ndeclare @Count int,@Son_Id int\r\n\r\nif @Act = 1\r\n begin\r\n  Select @Son_Id=isnull(Max(Id),0)+1 from Kurgrs where MID=@MID and FID=@FID and DID=@DID\r\n  begin transaction\r\n  insert into Kurgrs\r\n    (MID,FID,DID,ParaBirim_Id,Id,Tarih,Alis,Satis,OzelAlis,OzelSatis)\r\n  values\r\n    (@MID,@FID,@DID,@ParaBirim_Id,@Id,@Tarih,@Alis,@Satis,@OzelAlis,@OzelSatis)\r\n\r\n  Exec sp_ActLog @Act,@MID,@FID,@DID,'Kurgrs',@Son_Id,@userid,@UserTarih\r\n\r\n  if @@error<>0\r\n  begin\r\n    rollback\r\n    select @return = 'f_Kaydedilemedi'\r\n  end\r\n  else\r\n  begin\r\n    commit\r\n    select @return = 's_Ok'\r\n  end\r\n\r\n  return\r\nend\r\n\r\nif @Act = 0\r\nbegin\r\n  select @Count = count(*) from ParaKur where MID=@MID and FID=@FID and DID=@DID and Id = @Id\r\n  if @Count = 0\r\n  begin\r\n    select @return = 'f_KayitYok'\r\n    return\r\n  end\r\n\r\n  begin transaction\r\n\r\n  Update ParaKur\r\n  Set Alis=@Alis,Satis=@Satis,OzelAlis=@OzelAlis,OzelSatis=@OzelSatis\r\n  where MID=@MID and FID=@FID and DID=@DID and Id = @Id\r\n\r\n  Exec sp_ActLog @Act,@MID,@FID,@DID,'Kurgrs',@Id,@userid,@UserTarih\r\n\r\n  if @@error<>0\r\n  begin\r\n    rollback\r\n    select @return = 'f_Güncellenemedi'\r\n  end\r\n  else\r\n  begin\r\n    commit\r\n    select @return = 's_Ok'\r\n  end\r\n\r\n  return\r\nend\r\n\r\nif @Act = -1\r\nbegin\r\n  select @Count = count(*) from ParaKur where MID=@MID and FID=@FID and DID=@DID and Id = @Id\r\n  if @Count = 0\r\n  begin\r\n    select @return = 'f_KayitYok'\r\n    return\r\n  end\r\n\r\n  begin transaction\r\n\r\n    Update ParaKur\r\n    Set Del=1\r\n     where MID=@MID and FID=@FID and DID=@DID and Id = @Id\r\n\r\n    Exec sp_ActLog @Act,@MID,@FID,@DID,'Kurgrs',@Id,@userid,@UserTarih\r\n\t\r\n  if @@error<>0\r\n  begin\r\n    rollback\r\n    select @return = 'f_Silinemedi'\r\n  end\r\n  else\r\n  begin\r\n    commit\r\n    select @return = 's_Ok'\r\n  end\r\n\r\n  return\r\nend\r\n\r\nif @Act = -2 --normal delete\r\nbegin\r\n  select @Count = count(*) from ParaKur where MID=@MID and FID=@FID and DID=@DID and Id = @Id\r\n  if @Count = 0\r\n  begin\r\n    select @return = 'f_KayitYok'\r\n    return\r\n  end\r\n\r\n  begin transaction\r\n\r\n    Delete from ParaKur\r\n    where MID=@MID and FID=@FID and DID=@DID and Id = @Id\r\n\r\n    Exec sp_ActLog @Act,@MID,@FID,@DID,'Kurgrs',@Id,@userid,@UserTarih\r\n\t\r\n  if @@error<>0\r\n  begin\r\n    rollback\r\n    select @return = 'f_Silinemedi'\r\n  end\r\n  else\r\n  begin\r\n    commit\r\n    select @return = 's_Ok'\r\n  end\r\n\r\n  return\r\nend\r\n\r\nselect @return = 'f_BilinmeyenIslem'\r\nreturn\r\n*/\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "Sp_Stok_FirmaFiyatList",
    "definition": "CREATE PROCEDURE dbo.Sp_Stok_FirmaFiyatList\r\n@Firmano int\r\nAS\r\nBEGIN\r\n \r\n\r\n  /*\r\n    declare @SqlStr nvarchar(4000) \r\n\r\n    CREATE TABLE  #Stok_FirmaFiyatList  (\r\n    id            INT ,\r\n    Tip,\r\n    Kod,\r\n    Ad, \r\n    Grp1,\r\n    Grp2,\r\n    Grp3,\r\n    Firmano\r\n    FirmaUnvan\r\n    Sat1Kdv\r\n    AlisKdv\r\n    \r\n    \r\n    \r\n   set @SqlStr=' Update #Satis_Yillik Set Ay'\r\n   +CAST(@Ay as varchar(2))+'Adet='+CAST(@Miktar as varchar(200))+\r\n   ',Ay'+CAST(@Ay as varchar(2))+'Tutar='+CAST(@Tutar as varchar(200))+\r\n   ',Ay'+CAST(@Ay as varchar(2))+'Kisi='+CAST(@Kisi as varchar(200))+\r\n   ' where TipIdId='''+@TipId_Id+''' '\r\n  \r\n   EXECUTE(@SqlStr)\r\n\r\n   */\r\n   \r\n   \r\n  if @Firmano<=0\r\n   Select 0 Firmano,\r\n   'StokKart' as FirmaUnvan,\r\n   K.id,K.Tip,K.Kod,K.Ad,K.Grp1,K.Grp2,K.Grp3,\r\n   K.Sat1Kdv SatisKdv,K.AlsKdv AlisKdv,\r\n   ISNULL(K.AlsFiy,0) AlisFiyat,\r\n   ISNULL(K.Sat1Fiy,0) as SatisFiyat1,\r\n   ISNULL(K.Sat2Fiy,0) as SatisFiyat2,\r\n   ISNULL(K.Sat3Fiy,0) as SatisFiyat3,\r\n   ISNULL(K.Sat4Fiy,0) as SatisFiyat4,\r\n   0.00 AlisFiyatYeni,\r\n   0.00 SatisFiyat1Yeni,0.00 SatisFiyat2Yeni,\r\n   0.00 SatisFiyat3Yeni,0.00 SatisFiyat4Yeni\r\n   /*ISNULL(M.Miktar,0) as MevcutMiktar */\r\n   From Stokkart as K with(nolock)\r\n   Where K.Sil=0 \r\n   \r\n   \r\n\r\n  if @Firmano>0\r\n   Select isnull(S1.Firmano,0) Firmano,\r\n   F.ad as FirmaUnvan,\r\n   K.id,K.Tip,K.Kod,K.Ad,K.Grp1,K.Grp2,K.Grp3,\r\n   K.Sat1Kdv SatisKdv,K.AlsKdv AlisKdv,\r\n   ISNULL(A.Fiyat,0) AlisFiyat,\r\n   ISNULL(S1.Fiyat,0) as SatisFiyat1,\r\n   ISNULL(S2.Fiyat,0) as SatisFiyat2,\r\n   ISNULL(S3.Fiyat,0) as SatisFiyat3,\r\n   ISNULL(S4.Fiyat,0) as SatisFiyat4,\r\n   0.00 AlisFiyatYeni,\r\n   0.00 SatisFiyat1Yeni,0.00 SatisFiyat2Yeni,\r\n   0.00 SatisFiyat3Yeni,0.00 SatisFiyat4Yeni\r\n   /*ISNULL(M.Miktar,0) as MevcutMiktar */\r\n   From Stokkart as K with(nolock)\r\n   inner join Firma as F with(nolock) on \r\n   isnull(F.sil,0)=0 and K.Sil=0 and F.id=@Firmano \r\n   inner Join Stok_Fiyat as S1 with(nolock)\r\n   on S1.Stk_id=K.id And S1.FiyNo=1 and S1.FiyTip=2 And F.id=S1.FirmaNo\r\n   inner Join Stok_Fiyat as S2 with(nolock)\r\n   on S2.Stk_id=K.id And S2.FiyNo=2 and S2.FiyTip=2 And F.id=S2.FirmaNo\r\n   inner Join Stok_Fiyat as S3 with(nolock)\r\n   on S3.Stk_id=K.id And S3.FiyNo=3 and S3.FiyTip=2 And F.id=S3.FirmaNo\r\n   inner Join Stok_Fiyat as S4 with(nolock)\r\n   on S4.Stk_id=K.id And S4.FiyNo=4 and S4.FiyTip=2 And F.id=S4.FirmaNo\r\n   inner Join Stok_Fiyat as A with(nolock)\r\n   on A.Stk_id=K.id And A.FiyNo=1 and A.FiyTip=1 And F.id=A.FirmaNo\r\n   /*\r\n   Left Join _Stok_FirmaMiktar as M with(nolock)\r\n   on M.stktip=K.Tip and M.Stkod=K.Kod And M.Firmano=S1.FirmaNo\r\n   */\r\n   \r\n   \r\n   \r\n   \r\n   \r\n \r\n \r\n  return \r\n \r\nEND"
  },
  {
    "schema": "dbo",
    "name": "Sp_VardiyaYazarkasaRap",
    "definition": "CREATE PROCEDURE dbo.Sp_VardiyaYazarkasaRap (@Firmano int,@VarTip int,@Varno varchar(4000))\r\nAS\r\nBEGIN\r\n\r\n\r\n   create Table  #Table (\r\n    Id              int IDENTITY(1, 1) NOT NULL,\r\n    Tip             int,\r\n    UrunTip\t        nvarchar(50),\r\n    UrunKod\t        nvarchar(50),\r\n    UrunAd          nvarchar(100),\r\n    UrunKdv         Float Default 0, \r\n    Fis             Float Default 0,\r\n    Emc          \tFloat Default 0,\r\n    TTS             Float Default 0,\r\n    VeresiyeTutar       Float Default 0,\r\n    VardiyaUrunTutar \tFloat Default 0,\r\n    VardiyaUrunFiyat       Float Default 0,\r\n    VardiyaUrunMiktar      Float Default 0,\r\n    ZRaporUrunTutar \tFloat Default 0,\r\n    ZraporUrunFiyat       Float Default 0,\r\n    ZraporUrunMiktar      Float Default 0,\r\n    ZRaporFarkTutar \tFloat Default 0,\r\n    ZraporFarkMiktar      Float Default 0,\r\n    \r\n    \r\n    Transfer        Float Default 0,\r\n    AraTutar       Float Default 0,\r\n    Pos1Kod         varchar(50),\r\n    Pos1Tutar      Float Default 0,\r\n    Pos2Kod         varchar(50),\r\n    Pos2Tutar      Float Default 0,\r\n    Pos3Kod         varchar(50),\r\n    Pos3Tutar      Float Default 0,\r\n    Pos4Kod         varchar(50),\r\n    Pos4Tutar      Float Default 0,    \r\n    Pos5Kod         varchar(50),\r\n    Pos5Tutar      Float Default 0,\r\n    Pos6Kod         varchar(50),\r\n    Pos6Tutar      Float Default 0,\r\n    Pos7Kod         varchar(50),\r\n    Pos7Tutar      Float Default 0,\r\n    Pos8Kod         varchar(50),\r\n    Pos8Tutar      Float Default 0,\r\n    PosTutar      Float Default 0,\r\n    NakitTutar    Float Default 0,\r\n    \r\n    NakitKdvTutar    Float Default 0,\r\n    PosKdvTutar    Float Default 0,\r\n    \r\n    \r\n    \r\n   )\r\n   \r\n   if @VarTip=1\r\n    begin\r\n    \r\n     insert into #Table (Tip,UrunTip,UrunKod,UrunAd,UrunKdv,VardiyaUrunFiyat,VardiyaUrunMiktar,VardiyaUrunTutar) \r\n     Select  1,stktip,Kod,'',max(kdvyuz),\r\n     case when sum(satmik)=0 then max(brimfiy) else sum(satmik*brimfiy)/sum(satmik) end brimfiy,\r\n     sum(satmik) satmik,\r\n     sum(satmik*brimfiy) tutar from pomvardistok with (nolock)\r\n     where varno in (Select * From CsvToInt(@Varno)) and Sil=0\r\n     group by stktip,Kod\r\n     \r\n     insert into #Table (Tip,UrunTip,UrunKod,UrunAd,UrunKdv)\r\n     values (2,'','','Toplam','0')\r\n     \r\n    /* insert into #Table (Tip,UrunTip,UrunKod,UrunAd,UrunKdv) */\r\n   /*  values (3,'','','Kasa','0') */\r\n     \r\n     \r\n     \r\n     \r\n     \r\n     /*veresiye Fis */\r\n     update #Table  Set Fis=dt.Tutar From #Table  as t \r\n     join (Select h.stktip,h.stkod,Sum(h.mik*h.brmfiy) Tutar \r\n     From  veresimas as m with (NOLOCK)\r\n     inner join  veresihrk as h with (NOLOCK) on m.verid=h.verid and m.sil=0 and h.Sil=0\r\n     and m.fistip='FISVERSAT' and m.ototag=0\r\n     where  m.yertip='pomvardimas' and m.varno in (Select * From CsvToInt(@Varno)) \r\n     group by h.stktip,h.stkod  ) dt\r\n     on dt.stktip=t.UrunTip and dt.stkod=t.UrunKod\r\n\r\n    /*tts */\r\n     update #Table  Set TTS=dt.Tutar From #Table  as t \r\n     join (Select h.stktip,h.stkod,Sum(h.mik*h.brmfiy) Tutar \r\n     From  veresimas as m with (NOLOCK)\r\n     inner join  veresihrk as h with (NOLOCK) on m.verid=h.verid and m.sil=0 and h.Sil=0\r\n     and m.fistip='FISVERSAT' and m.ototag>0\r\n     where  m.yertip='pomvardimas' and m.varno in (Select * From CsvToInt(@Varno)) \r\n     group by h.stktip,h.stkod  ) dt\r\n     on dt.stktip=t.UrunTip and dt.stkod=t.UrunKod\r\n     \r\n     \r\n   /*Veresiye Tutar */\r\n     update #Table  Set VeresiyeTutar=Fis+Emc+TTS  \r\n     \r\n       \r\n     update #Table  Set \r\n     ZRaporUrunTutar=dt.Tutar,\r\n     ZraporUrunFiyat=dt.fiyat,\r\n     ZraporUrunMiktar=dt.Miktar     \r\n     From #Table  as t \r\n     join (Select h.tip,h.kod,\r\n      case when Sum(h.miktar)>0 then  \r\n     Sum(h.miktar*h.brmfiy)/Sum(h.miktar) else\r\n      1 end as Fiyat,\r\n     Sum(h.miktar) miktar,\r\n     Sum(h.miktar*h.brmfiy) Tutar \r\n     From  zrapormas as m with (NOLOCK)\r\n     inner join  zraporhrk as h with (NOLOCK) on m.zrapid=h.zrapid  and h.Sil=0\r\n     inner join ZraporVardiya as v with (NOLOCK) on m.zrapid=v.zrapid \r\n     and v.varno in (Select * From CsvToInt(@Varno))  and v.Sil=0\r\n     where m.sil=0\r\n     group by h.tip,h.kod  ) dt\r\n     on dt.tip=t.UrunTip and dt.kod=t.UrunKod\r\n     \r\n     \r\n     \r\n     /*Veresiye Tutar */\r\n       update #Table  Set AraTutar=VardiyaUrunTutar-VeresiyeTutar\r\n     \r\n     \r\n     \r\n   DECLARE @sSQL nvarchar(4000)\r\n    declare @i int\r\n    set @i=1\r\n    declare @poskod varchar(50)\r\n    declare @giren   float\r\n    declare pom_var CURSOR FAST_FORWARD  FOR \r\n    select poskod,sum(giren) giren from poshrk with (nolock) \r\n    where varno in (Select * From CsvToInt(@Varno)) and sil=0 and yertip='pomvardimas'\r\n    group by Poskod\r\n     open pom_var\r\n     fetch next from  pom_var into @poskod,@giren\r\n     while @@FETCH_STATUS=0\r\n      begin\r\n       \r\n      /*Tutar Yaz  */\r\n       set @sSQL='Update #Table set '+\r\n       'Pos'+cast(@i as varchar(5))+'kod='''+cast(@poskod as varchar(50))+''','+\r\n       'Pos'+cast(@i as varchar(5))+'Tutar='''+cast(@giren as varchar(50))+''' where Tip=2 '\r\n       EXEC (@sSQL)\r\n       \r\n        set @sSQL='Update #Table set Pos'+cast(@i as varchar(5))+'kod='''+cast(@poskod as varchar(50))+''' where Tip=1 '\r\n        EXEC (@sSQL) \r\n       \r\n                  \r\n        \r\n        DECLARE @retval float   \r\n        DECLARE @ParmDefinition nvarchar(500);\r\n\r\n       /*AraTutar */\r\n\r\n        SELECT @sSQL = N'SELECT top 1 @retvalOUT = Id FROM #Table where Tip=1 and (AraTutar-PosTutar)>=@araTutar'\r\n        SET @ParmDefinition = N'@araTutar float,@retvalOUT float OUTPUT'\r\n        EXEC sp_executesql @sSQL, @ParmDefinition,@giren,@retvalOUT=@retval OUTPUT\r\n        /*SELECT @retval */\r\n        \r\n        \r\n        set @sSQL='Update #Table set Pos'+cast(@i as varchar(5))+'Tutar=@giren where Id=@Id '\r\n        SET @ParmDefinition = N'@giren float,@Id int'\r\n        EXEC sp_executesql @sSQL,@ParmDefinition,@giren,@retval\r\n       \r\n        set @sSQL='Update #Table set PosTutar=PosTutar+@giren where Tip=1 and Id=@Id'\r\n        SET @ParmDefinition = N'@giren float,@Id int'\r\n        EXEC sp_executesql @sSQL,@ParmDefinition,@giren,@retval\r\n            \r\n     \r\n      \r\n      set @i=@i+1\r\n\r\n      FETCH next from  pom_var into @poskod,@giren\r\n     end\r\n   close Pom_Var\r\n   deallocate pom_var\r\n     \r\n\r\n  \r\n    \r\n  \r\n \r\n\r\n    end\r\n   \r\n   \r\n     \r\n     update #Table  Set UrunAd=dt.Ad From #Table  as t \r\n     join (Select tip,kod,ad From  stokkart as m with (NOLOCK) ) dt\r\n     on dt.tip=t.UrunTip and dt.kod=t.UrunKod\r\n    \r\n     \r\n     \r\n    \r\n     \r\n   \r\n    Update #Table set ZRaporFarkTutar=VardiyaUrunTutar-ZRaporUrunTutar,\r\n    ZRaporFarkMiktar=VardiyaUrunMiktar-ZRaporUrunMiktar where Tip=1\r\n    Update #Table set NakitTutar=AraTutar-PosTutar where Tip=1\r\n   \r\n    Update #Table set NakitKdvTutar=NakitTutar-(NakitTutar/(1+UrunKdv)) where Tip=1\r\n    Update #Table set PosKdvTutar=PosTutar-(PosTutar/(1+UrunKdv)) where Tip=1\r\n   \r\n   \r\n   \r\n   \r\n     update #Table  Set \r\n     TTS=dt.TTS,Fis=dt.Fis,Emc=Dt.Emc,\r\n     VardiyaUrunMiktar=dt.VardiyaUrunMiktar,\r\n     VardiyaUrunTutar=dt.VardiyaUrunTutar,\r\n     ZraporUrunMiktar=dt.ZraporUrunMiktar,\r\n     ZraporUrunTutar=dt.ZraporUrunTutar,\r\n     ZRaporFarkTutar=dt.ZRaporFarkTutar,\r\n     ZRaporFarkMiktar=dt.ZRaporFarkMiktar,\r\n     PosTutar=Dt.PosTutar,\r\n     NakitTutar=Dt.NakitTutar,\r\n     NakitKdvTutar=dt.NakitKdvTutar,\r\n     PosKdvTutar=dt.PosKdvTutar\r\n     \r\n     From #Table  as t \r\n     join (Select Sum(Fis) Fis,Sum(Emc) Emc,Sum(TTS) TTS,\r\n     Sum(VardiyaUrunMiktar) VardiyaUrunMiktar,Sum(VardiyaUrunTutar) VardiyaUrunTutar,\r\n     Sum(ZraporUrunMiktar) ZraporUrunMiktar,Sum(ZraporUrunTutar) ZraporUrunTutar,\r\n     Sum(ZRaporFarkTutar) ZRaporFarkTutar,Sum(ZRaporFarkMiktar) ZRaporFarkMiktar,\r\n     Sum(PosTutar) PosTutar,Sum(NakitTutar) NakitTutar,\r\n     Sum(NakitKdvTutar) NakitKdvTutar,Sum(PosKdvTutar) PosKdvTutar\r\n     From  #Table Where Tip=1 ) dt\r\n     on t.Tip=2\r\n   \r\n   \r\n   \r\n    \r\n   Select * From #Table\r\n   \r\n   \r\n   \r\n\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "SpAppIrsaliyeAktar",
    "definition": "CREATE PROCEDURE dbo.[SpAppIrsaliyeAktar]\r\n@BackIrsaliyeId  int,\r\n@DeviceId  varchar(50),\r\n@UserId  int\r\nAS\r\nBEGIN\r\n\r\n   declare @Tutar float\r\n   declare @KdvDahilTutar float\r\n\r\n   \r\n   \r\n   \r\n   select @Tutar=Round(Sum(brmfiy*Mik),2),\r\n   @KdvDahilTutar=Round(Sum( (brmfiy*Mik)*(1+kdvyuz)),2)\r\n   from  irsaliyehrk with (nolock)\r\n   Where irid=@BackIrsaliyeId and Sil=0 \r\n   \r\n\r\n   update irsaliyemas set irid=id,\r\n   irtop=isnull(@Tutar,0),\r\n   genel_top=isnull(@KdvDahilTutar,0),\r\n   genel_ara_top=isnull(@Tutar,0),\r\n   genel_kdv_top=isnull(@KdvDahilTutar,0)-isnull(@Tutar,0),\r\n   genel_net_top=isnull(@Tutar,0),\r\n   kayok=1 where id=@BackIrsaliyeId\r\n  \r\n   Declare @UserUnvan   varchar(150)\r\n   select @UserUnvan=ad from  users where id=@UserId\r\n    \r\n   select id,firmano,irseri+irno irsserino,tarih,saat,@UserUnvan as userunvan \r\n   from irsaliyemas with (nolock) where id=@BackIrsaliyeId \r\n   \r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "SpAppIrsaliyeHrkAl",
    "definition": "CREATE PROCEDURE dbo.[SpAppIrsaliyeHrkAl]\r\n@DeviceId  varchar(50),\r\n@AppIrsaliyeId  int,\r\n@BackIrsaliyeId  int,\r\n@SiraNo      int,\r\n@TarihSaat  datetime,\r\n@BarkodNo   varchar(30),\r\n@Miktar   float ,\r\n@Fiyat   float ,\r\n@UserId     int\r\nAS\r\nBEGIN\r\n  \r\n   Declare @Id     int \r\n   Declare @IrsaliyeHrkId  int\r\n   Declare @Firmano  int\r\n   Declare @Tarih  Datetime\r\n   Declare @DepoId   int\r\n   Declare @DepoKod   varchar(50)\r\n   Declare @StokId     int \r\n   Declare @StokTipId     int \r\n   Declare @StokTip   varchar(10)\r\n   Declare @StokKod   varchar(50)\r\n   Declare @StokKdv   float\r\n   Declare @OlusturmaUnvan   varchar(150)\r\n   \r\n   select @OlusturmaUnvan=ad from  users where id=@UserId\r\n   \r\n   \r\n   select @Firmano=firmano,@Tarih=TarihSaat,@DepoKod=DepoKod \r\n   from AppIrsaliyeMas with (nolock) Where Id=@AppIrsaliyeId\r\n   \r\n   \r\n   select @DepoId=id from depokart with (nolock) where kod=@DepoKod and Sil=0 \r\n   \r\n\r\n   select @StokTip=tip,@StokKod=kod from barkod as b with (nolock)\r\n   where b.barkod=@BarkodNo and b.sil=0\r\n   \r\n   select @StokId=id,@StokKdv=sat1kdv,@StokTipId=2 /*tip_id  */\r\n   from stokkart as k with (nolock)\r\n   where k.tip=@StokTip and k.kod=@StokKod and k.sil=0\r\n  \r\n\r\n\r\n   select @Id=Id from AppIrsaliyeHrk with (nolock) Where DeviceId=@DeviceId\r\n   and AppIrsaliyeId=@AppIrsaliyeId and SiraNo=@SiraNo\r\n\r\n   if isnull(@Id,0)=0\r\n   insert into AppIrsaliyeHrk (DeviceId,AppIrsaliyeId,SiraNo,TarihSaat,BarkodNo,\r\n   Miktar,Fiyat,StokTip,StokKod,OlusturmaTarihSaat,OlusturmaUnvan)\r\n   select @DeviceId,@AppIrsaliyeId,@SiraNo,@TarihSaat,@BarkodNo,\r\n   @Miktar,@Fiyat,@StokTip,@StokKod,GetDate(),@OlusturmaUnvan\r\n   \r\n\r\n   select @IrsaliyeHrkId=id from irsaliyehrk with (nolock) Where irid=@BackIrsaliyeId\r\n   and AppSiraNo=@SiraNo and Sil=0 \r\n   \r\n   if isnull(@IrsaliyeHrkId,0)=0\r\n   begin  \r\n   \r\n    insert into irsaliyehrk (AppSiraNo,irid,firmano,kdvtip,\r\n    stktip,stkod,mik,carpan,brim,ustbrim,kdvyuz,kdvtut,\r\n    depkod,dataok,grupid,olususer,olustarsaat,brmfiy,sil,sipid,kayok,parabrim,kur,\r\n    stktip_id,stk_id,dep_id,Kart_ParaBrm,Kart_Kur,Islem_ParaBrm,Islem_Kur,\r\n    kesafet,barkod,remote_id,satiskyuz,satisktut,geniskyuz,genisktut)\r\n    select @SiraNo,@BackIrsaliyeId,@Firmano,'' kdvtip,\r\n     @StokTip stktip,@StokKod,@Miktar,1 carpan,'AD' brim,'' ustbrim,(@StokKdv/100) kdvyuz,0 kdvtut,\r\n     @DepoKod,0 dataok,\r\n     0 grupid,@OlusturmaUnvan,GetDate(),@Fiyat,0 sil,0 sipid,1 kayok,'TL',1,\r\n     @StokTipId,@StokId,@DepoId,'TL' Kart_ParaBrm,1 Kart_Kur,'TL' Islem_ParaBrm,1 Islem_Kur,\r\n     1 kesafet,@BarkodNo,0 remote_id,0 satiskyuz,0 satisktut,0 geniskyuz,0 genisktut \r\n   \r\n \r\n  end\r\n  \r\n  \r\n \r\n  \r\n  \r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "SpAppIrsaliyeMasAl",
    "definition": "CREATE PROCEDURE dbo.[SpAppIrsaliyeMasAl]\r\n@DeviceId  varchar(50),\r\n@FirmaNo     int,\r\n@TarihSaat  datetime,\r\n@Seri   varchar(10),\r\n@SeriNo   varchar(20),\r\n@CariKod   varchar(50),\r\n@DepoKod   varchar(50),\r\n@UserId     int\r\nAS\r\nBEGIN\r\n  \r\n   Declare @Id     int \r\n   Declare @IrsaliyeId     int \r\n   Declare @IrsaliyeRapId     int \r\n   Declare @IrsaliyeTipId     int \r\n   Declare @CariId     int \r\n   Declare @OlusturmaUnvan   varchar(150)\r\n   \r\n   select @OlusturmaUnvan=ad from  users with (nolock) where id=@UserId\r\n   select @CariId=id from carikart with (nolock) Where Kod=@CariKod and Sil=0 \r\n\r\n  \r\n   select @Id=Id from AppIrsaliyeMas with (nolock) Where DeviceId=@DeviceId\r\n   and TarihSaat=@TarihSaat and Seri=@Seri and SeriNo=@SeriNo\r\n   \r\n   select top 1 @IrsaliyeRapId=id,@IrsaliyeTipId=tip_id from raporlar where rapkod='IRSMRALS'\r\n   \r\n   \r\n\r\n   if isnull(@Id,0)=0\r\n   begin\r\n     insert into AppIrsaliyeMas (DeviceId,Firmano,TarihSaat,Seri,SeriNo,\r\n     CariKod,DepoKod,OlusturmaTarihSaat,OlusturmaUnvan)\r\n     select @DeviceId,@FirmaNo,@TarihSaat,@Seri,@SeriNo,\r\n     @CariKod,@DepoKod,GetDate(),@OlusturmaUnvan\r\n     select @Id=SCOPE_IDENTITY()\r\n   end\r\n   \r\n   \r\n   select @IrsaliyeId=id from irsaliyemas with (nolock) Where FirmaNo=@FirmaNo\r\n   and irseri=@Seri and irno=@SeriNo and Sil=0 \r\n   \r\n  \r\n  if isnull(@IrsaliyeId,0)=0\r\n   begin\r\n    insert into irsaliyemas (irid,firmano,kayok, sil, irtip, irad,\r\n    irturad,irtur,irseri,irno ,tarih,vadtar,kdvtip,ack,kdvtut,\r\n     depo,dataok,olususer,olustarsaat,irtop,kdvtop,cartip,carkod,\r\n    saat,aktip,akid,sevktar,yertip,yerad,gctip,irstip_id,irstur_id,\r\n    irsrap_id,car_id,cartip_id,hrk_car_pro,hrk_stk_pro,Kart_ParaBrm,Kart_Kur,Islem_ParaBrm,\r\n    Islem_Kur,genel_ara_top,genel_top,genel_kdv_top,yuvtop,remote_id,\r\n    genel_net_top) \r\n    \r\n    select 0,@FirmaNo,0,0,'IRSMRALS','MARKET ALIŞ İRSALİYESİ',\r\n    '','',@Seri,@SeriNo,@TarihSaat,@TarihSaat,'Hariç','['+@Seri+@SeriNo + ' / MARKET ALIŞ İRSALİYE]',0,\r\n    @DepoKod,0,@OlusturmaUnvan,GetDate(),0,0,'carikart',@Carikod,\r\n    '00:00:00','BK',0,@TarihSaat,'AppIrsaliye','App Irsaliye',1,@IrsaliyeTipId,4,\r\n    @IrsaliyeRapId,@CariId,1,0,1,'TL',1,'TL',\r\n    1,0,0,0,0,0,0\r\n    \r\n    SELECT @IrsaliyeId=SCOPE_IDENTITY()\r\n   end\r\n   \r\n   select @Id as Id,@IrsaliyeId IrsaliyeId\r\n   \r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "SpAppKartFirmaDurum",
    "definition": "CREATE PROCEDURE dbo.[SpAppKartFirmaDurum]\r\n@Firmano      int,\r\n@KartTipId    int,\r\n@KartKod        varchar(50)\r\nAS\r\nBEGIN\r\n   \r\n\r\n   \r\n   \r\n   \r\n   Declare @Id     int \r\n   Declare @KartTip   varchar(20)\r\n   \r\n   /*\r\n   if (@KartTipId=1) --cari\r\n    select @KartTip='carikart',@KartKod=kod from carikart as b with (nolock)\r\n     where b.kod=@KartKod and b.sil=0 \r\n     \r\n     \r\n   if (@KartTipId=4) --banka\r\n    select @KartTip='bankakart',@KartKod=kod from bankakart as b with (nolock)\r\n     where b.kod=@KartKod and b.sil=0    \r\n\r\n\r\n   if (@KartTipId=8) --kasa\r\n    select @KartTip='kasakart',@KartKod=kod from kasakart as b with (nolock)\r\n     where b.kod=@KartKod and b.sil=0   \r\n  */\r\n\r\n   if (@KartTipId=1) /*cari  */\r\n    begin\r\n     select id,kod,unvan ad,\r\n     brc_bakiye borc,alc_bakiye alacak,top_bakiye bakiye\r\n     from Cari_Kart_Listesi as k with (nolock) where kod=@KartKod and sil=0 \r\n   \r\n     select d.id,d.kod,d.ad,\r\n     sum(borc) As borc,\r\n     sum(alacak) As alacak,\r\n     sum(borc-alacak) as bakiye\r\n     from carikart as k with (nolock)\r\n     left join carihrk as h with (nolock) on \r\n     h.cartip='carikart' and k.kod=h.carkod\r\n     and h.sil=0 and k.sil=0\r\n     left join Firma as d on d.id=h.firmano\r\n     where k.kod=@KartKod \r\n     group by k.kod,k.ad,d.id,d.kod,d.ad\r\n     having abs(isnull(sum(borc-alacak),0))>0\r\n     \r\n   end\r\n\r\n   \r\n   \r\n   if (@KartTipId=4) /*kasa  */\r\n    begin\r\n     select id,kod,ad,\r\n     giren_bakiye as borc,cikan_bakiye as alacak,top_bakiye as bakiye\r\n     from Kasa_Kart_Listesi as k with (nolock) where kod=@KartKod and sil=0 \r\n   \r\n     select d.id,d.kod,d.ad,\r\n     sum(h.giren) As borc,\r\n     sum(h.cikan) As alacak,\r\n     sum(h.giren-h.cikan) as bakiye\r\n     from kasakart as k with (nolock)\r\n     left join kasahrk as h with (nolock) on \r\n     k.kod=h.kaskod and h.sil=0 and k.sil=0\r\n     left join Firma as d on d.id=h.firmano\r\n     where k.kod=@KartKod \r\n     group by k.kod,k.ad,d.id,d.kod,d.ad\r\n     having abs(isnull(sum(h.giren-h.cikan),0))>0\r\n     \r\n   end\r\n   \r\n   \r\n   \r\n   if (@KartTipId=8) /*banka  */\r\n    begin\r\n     select id,kod,ad,\r\n     brc_bakiye borc,alc_bakiye alacak,top_bakiye bakiye\r\n     from Banka_Kart_Listesi as k with (nolock) where kod=@KartKod and sil=0 \r\n   \r\n     select d.id,d.kod,d.ad,\r\n     sum(h.borc) As borc,\r\n     sum(h.alacak) As alacak,\r\n     sum(h.borc-h.alacak) as bakiye\r\n     from bankakart as k with (nolock)\r\n     left join bankahrk as h with (nolock) on \r\n     k.kod=h.bankod and h.sil=0 and k.sil=0\r\n     left join Firma as d on d.id=h.firmano\r\n     where k.kod=@KartKod \r\n     group by k.kod,k.ad,d.id,d.kod,d.ad\r\n     having abs(isnull(sum(h.borc-h.alacak),0))>0\r\n     \r\n   end\r\n    \r\n\r\n  \r\nEND"
  },
  {
    "schema": "dbo",
    "name": "SpAppRafEtiketHrkAl",
    "definition": "CREATE PROCEDURE dbo.[SpAppRafEtiketHrkAl]\r\n@DeviceId  varchar(50),\r\n@AppRafEtiketId  int,\r\n@SiraNo       int,\r\n@TarihSaat  datetime,\r\n@BarkodNo   varchar(30),\r\n@UserId     int\r\nAS\r\nBEGIN\r\n  \r\n   Declare @Id     int \r\n   Declare @Firmano  int\r\n   Declare @OlusturmaUnvan   varchar(150)\r\n   \r\n   select @OlusturmaUnvan=ad from  users where id=@UserId\r\n   \r\n\r\n\r\n   select @Id=Id from AppRafEitketHrk with (nolock) Where DeviceId=@DeviceId\r\n   and AppRafEtiketId=@AppRafEtiketId and SiraNo=@SiraNo\r\n\r\n   if isnull(@Id,0)=0\r\n   insert into AppRafEitketHrk (DeviceId,AppRafEtiketId,SiraNo,TarihSaat,BarkodNo,\r\n   OlusturmaTarihSaat,OlusturmaUnvan)\r\n   select @DeviceId,@AppRafEtiketId,@SiraNo,@TarihSaat,@BarkodNo,\r\n   GetDate(),@OlusturmaUnvan\r\n\r\n  \r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "SpAppRafEtiketMasAl",
    "definition": "CREATE PROCEDURE dbo.[SpAppRafEtiketMasAl]\r\n@DeviceId  varchar(50),\r\n@FirmaNo     int,\r\n@TarihSaat  datetime,\r\n@Aciklama    varchar(100),\r\n@UserId     int\r\nAS\r\nBEGIN\r\n  \r\n   Declare @Id     int \r\n   Declare @OlusturmaUnvan   varchar(150)\r\n   \r\n   select @OlusturmaUnvan=ad from  users with (nolock) where id=@UserId\r\n\r\n  \r\n   select @Id=Id from AppRafEtiketMas with (nolock) Where DeviceId=@DeviceId\r\n   and TarihSaat=@TarihSaat \r\n   \r\n\r\n   if isnull(@Id,0)=0\r\n   begin\r\n     insert into AppRafEtiketMas (DeviceId,Firmano,TarihSaat,Aciklama,\r\n     OlusturmaTarihSaat,OlusturmaUnvan)\r\n     select @DeviceId,@FirmaNo,@TarihSaat,@Aciklama,GetDate(),@OlusturmaUnvan\r\n     select @Id=SCOPE_IDENTITY()\r\n   end\r\n   \r\n   \r\n  \r\n   \r\n   select @Id as Id\r\n   \r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "SpAppSayimAktar",
    "definition": "CREATE PROCEDURE dbo.SpAppSayimAktar\r\n@BackSayimId  int,\r\n@DeviceId  varchar(50),\r\n@AppSayimId  int,\r\n@UserId  int\r\nAS\r\nBEGIN\r\n\r\n   update sayimhrk set OnlineSayimMiktar=dt.miktar,\r\n   OnlineSayimTarihSaat=dt.TarihSaat,saydrm='S',OnlineSayim=1 from sayimhrk t join \r\n   (select StokKod,sum(miktar) as miktar,max(TarihSaat) TarihSaat \r\n   from AppSayim where BackSayimId=@BackSayimId\r\n    /*DeviceId=@DeviceId and AppSayimId=@AppSayimId  */\r\n   group by StokKod ) as dt on t.stkod=dt.StokKod \r\n   and t.sayid=@BackSayimId\r\n   \r\n   exec SpSayimSatisMiktarHesapla @BackSayimId\r\n   \r\n   \r\n   Declare @UserUnvan   varchar(150)\r\n   select @UserUnvan=ad from  users where id=@UserId\r\n    \r\n   select id,firmano,sayack,tarih,saat,@UserUnvan as userunvan \r\n   from sayimmas with (nolock) where sayid=@BackSayimId \r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "SpAppSayimAl",
    "definition": "CREATE PROCEDURE dbo.SpAppSayimAl\r\n@BackSayimId  int,\r\n@DeviceId  varchar(50),\r\n@AppSayimId  int,\r\n@SiraNo      int,\r\n@TarihSaat  datetime,\r\n@BarkodNo   varchar(30),\r\n@Miktar   float ,\r\n@UserId     int\r\nAS\r\nBEGIN\r\n  \r\n   Declare @Id     int \r\n   Declare  @StokTip   varchar(10)\r\n   Declare @StokKod   varchar(50)\r\n   /*Declare @OlusturmaTarihSaat datetime */\r\n   Declare @OlusturmaUnvan   varchar(150)\r\n   \r\n   select @OlusturmaUnvan=ad from  users where id=@UserId\r\n\r\n   \r\n   select @StokTip=tip,@StokKod=kod from barkod as b with (nolock)\r\n   where b.barkod=@BarkodNo and b.sil=0\r\n   \r\n  \r\n   select @Id=Id from AppSayim Where DeviceId=@DeviceId\r\n   and AppSayimId=@AppSayimId and SiraNo=@SiraNo and BackSayimId=@BackSayimId\r\n\r\n   if isnull(@Id,0)=0\r\n   insert into AppSayim (BackSayimId,DeviceId,AppSayimId,SiraNo,TarihSaat,BarkodNo,\r\n   Miktar,StokTip,StokKod,OlusturmaTarihSaat,OlusturmaUnvan)\r\n   select @BackSayimId,@DeviceId,@AppSayimId,@SiraNo,@TarihSaat,@BarkodNo,\r\n   @Miktar,@StokTip,@StokKod,GetDate(),@OlusturmaUnvan\r\n   \r\n   \r\n   \r\n   \r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "SpAppUrunDepoDurum",
    "definition": "CREATE PROCEDURE dbo.SpAppUrunDepoDurum\r\n@Firmano    int,\r\n@BarkodNo   varchar(30)\r\nAS\r\nBEGIN\r\n   \r\n\r\n   \r\n   \r\n   \r\n   Declare @Id     int \r\n   Declare @StokTip   varchar(10)\r\n   Declare @StokKod   varchar(50)\r\n\r\n   \r\n   \r\n   select @StokTip=tip,@StokKod=kod from barkod as b with (nolock)\r\n   where b.barkod=@BarkodNo and b.sil=0 and isnull(b.barkod,'')!=''\r\n\r\n   \r\n   /*ürün adı, depolara göre miktar, alış-satış fiyatı-kdv, kar yüzdesi */\r\n   \r\n   select id,kod,ad,\r\n   round(case when alsfiy>0 then  ((sat1fiy*100)/alsfiy)-100 else 0 end,2) karyuzde,\r\n   k.alsfiy as alisfiyat,\r\n   k.alskdv as aliskdv,\r\n   k.sat1fiy as satisfiyat,\r\n   k.sat1kdv satiskdv\r\n   from stokkart as k with (nolock) where tip=@StokTip and kod=@StokKod and sil=0 \r\n   \r\n   \r\n   \r\n   select d.id,d.kod,d.ad,\r\n   sum(giren) As giren,\r\n   sum(cikan) As cikan,\r\n   sum(giren-cikan) as kalan\r\n   from stokkart as k with (nolock)\r\n   left join stkhrk as h with (nolock) on \r\n   k.tip=h.stktip and k.kod=h.stkod\r\n   and h.sil=0 and k.sil=0\r\n   left join Depo_Kart_Listesi as d on d.kod=h.depkod\r\n   where k.tip=@StokTip and k.kod=@StokKod \r\n   group by k.tip,k.kod,k.ad,d.id,d.kod,d.ad\r\n   having abs(isnull(sum(giren-cikan),0))>0\r\n     \r\n\r\n\r\n    \r\n\r\n  \r\nEND"
  },
  {
    "schema": "dbo",
    "name": "SpAppUrunFiyatDegistir",
    "definition": "CREATE PROCEDURE dbo.[SpAppUrunFiyatDegistir]\r\n@Kod   varchar(30),\r\n@Fiyat float,\r\n@UserId     int \r\nAS\r\nBEGIN\r\n\r\n  declare @id      int\r\n  declare @UrunAd   varchar(150)\r\n  declare @OlusturmaUnvan   varchar(150)\r\n  select @OlusturmaUnvan=ad from  users where id=@UserId\r\n\r\n  select @id=id,@UrunAd=ad from  stokkart where tip='markt' and kod=@Kod\r\n \r\n\r\n  update stokkart set sat1fiy=@Fiyat,\r\n  SatisFiyat1DegisimTarih=Getdate(),\r\n  deguser=@OlusturmaUnvan,\r\n  degtarsaat=Getdate()\r\n  where id=@id\r\n  \r\n  select  @UrunAd urunad,@Fiyat yenifiyat,@OlusturmaUnvan userunvan \r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "SpBulutTahsilat",
    "definition": "CREATE PROCEDURE dbo.SpBulutTahsilat(\r\n@Firmano    int,\r\n@EntegratorId  int,\r\n@TahsilatId int,\r\n@TahsilatTipId int,\r\n@TahsilatTipAd varchar(100),\r\n@TarihSaat Datetime,\r\n@BankKod   varchar(50),\r\n@BankAd    varchar(50),\r\n@BankIBAN  varchar(50),\r\n@TCVKNNo   varchar(50),\r\n@Unvan     varchar(500), \r\n@Tutar     float,\r\n@Aciklama  varchar(1000) )\r\nAS\r\nBEGIN\r\n  \r\n\r\n   /*Firmano=@Firmano and */\r\n   if not EXISTS(select Id from BulutTahsilat with (nolock) \r\n   where  TahsilatId=@TahsilatId and Sil=0 )  \r\n    INSERT INTO dbo.BulutTahsilat(\r\n      Firmano,TahsilatId,TahsilatTipId,TahsilatTipAd,EntegratorId,TarihSaat,BankKod,BankAd,BankIBAN,\r\n       TCVKNNo,Unvan,Tutar,Aciklama,KayitTarihSaat) \r\n    select @FirmaNo,@TahsilatId,@TahsilatTipId,@TahsilatTipAd,@EntegratorId,@TarihSaat,@BankKod,@BankAd,@BankIBAN,\r\n       @TCVKNNo,@Unvan,@Tutar,@Aciklama,GetDate() \r\n       \r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "SpBulutTahsilatAktar",
    "definition": "CREATE PROCEDURE dbo.[SpBulutTahsilatAktar](\r\n@Id  int )\r\nAS\r\nBEGIN\r\n  \r\n   declare @RecId    int\r\n   declare @BankKod    varchar(50)\r\n   declare @CariKod    varchar(50)\r\n   declare @CariTipId  int\r\n   declare @CariId    int\r\n   declare @BankId    int\r\n   declare @Tutar    float\r\n   declare @CariTur    varchar(50)\r\n   declare @CariTip    varchar(50)\r\n   \r\n   set @CariTur='carikart'\r\n   set @CariTip='CARİ KARTLAR'\r\n   \r\n     \r\n     \r\n    select @CariTipId=CariTipId,@CariId=CariId,@BankId=BankaId,@Tutar=Tutar from  BulutTahsilat with (nolock) \r\n    Where Id=@Id\r\n    \r\n   \r\n    \r\n    select  @CariKod=kod,@CariTur=cartp,@CariTip=tip \r\n    from Genel_Kart with (nolock) Where Tip_id=@CariTipId and id=@CariId\r\n    select  @BankKod=kod from bankakart with (nolock) Where id=@BankId\r\n    \r\n   if @Tutar>0 \r\n    insert into bankahrk (firmano,gctip,bankhrkid,\r\n    islmtip,islmtipad,\r\n    islmhrk,islmhrkad,\r\n    yertip,yerad,\r\n    cartip,masterid,fisfatid,fisfattip,\r\n    varno,varok,perkod,adaid,\r\n    vadetar,tarih,saat,\r\n    cartur,carkod,bankod,kaskod,\r\n    belno,ack,borc,alacak,kur,parabrm,\r\n    olususer,olustarsaat,\r\n    gidkod,gidtutar,rg,CariAvans,\r\n    Karsi_KartTip,Karsi_KartKod)\r\n    select firmano,'C',0,\r\n    'BNK','BANKA',\r\n    'C-B','GELEN HAVALE / EFT',\r\n    'bulut','Bulut Tahsilat',\r\n    @CariTur,0,0,'KENDI',\r\n    0,1,'Diger',0,\r\n    DATEADD(DAY, DATEDIFF(DAY, 0, TarihSaat), 0),\r\n    DATEADD(DAY, DATEDIFF(DAY, 0, TarihSaat), 0),\r\n    convert(char(8), TarihSaat, 108),\r\n    @CariTip,@CariKod,@BankKod,'',\r\n    'BLT',SUBSTRING(Aciklama,1,100),Tutar,0,1,'TL',\r\n    'Bulut Tahsilat',GetDate(),\r\n    '',0,1,0,\r\n    @CariTur,@CariKod\r\n    from  BulutTahsilat with (nolock) Where Id=@Id\r\n    \r\n    \r\n    if @Tutar<0 \r\n    insert into bankahrk (firmano,gctip,bankhrkid,\r\n    islmtip,islmtipad,\r\n    islmhrk,islmhrkad,\r\n    yertip,yerad,\r\n    cartip,masterid,fisfatid,fisfattip,\r\n    varno,varok,perkod,adaid,\r\n    vadetar,tarih,saat,\r\n    cartur,carkod,bankod,kaskod,\r\n    belno,ack,borc,alacak,kur,parabrm,\r\n    olususer,olustarsaat,\r\n    gidkod,gidtutar,rg,CariAvans,\r\n    Karsi_KartTip,Karsi_KartKod)\r\n    select firmano,'G',0,\r\n    'BNK','BANKA',\r\n    'B-C','GİDEN HAVALE / EFT',\r\n    'bulut','Bulut Tahsilat',\r\n    @CariTur,0,0,'KENDI',\r\n    0,1,'Diger',0,\r\n    DATEADD(DAY, DATEDIFF(DAY, 0, TarihSaat), 0),\r\n    DATEADD(DAY, DATEDIFF(DAY, 0, TarihSaat), 0),\r\n    convert(char(8), TarihSaat, 108),\r\n    @CariTip,@CariKod,@BankKod,'',\r\n    'BLT',SUBSTRING(Aciklama,1,100),0,-1*Tutar,1,'TL',\r\n    'Bulut Tahsilat',GetDate(),\r\n    '',0,1,0,\r\n    @CariTur,@CariKod\r\n    from  BulutTahsilat with (nolock) Where Id=@Id\r\n    \r\n    \r\n    \r\n    select @RecId=SCOPE_IDENTITY()\r\n    \r\n    update bankahrk WITH (TABLOCK) set bankhrkid=@recId where id=@recId\r\n    \r\n    update BulutTahsilat set AktarimId=@RecId,AktarimTarihSaat=GetDate()\r\n     Where Id=@Id\r\n\r\n\r\n\r\n     \r\n  \r\n   RETURN  @RecId\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "SpCariTarihBorcAlacakRapor",
    "definition": "CREATE PROCEDURE dbo.SpCariTarihBorcAlacakRapor\r\n@Firmano     int,\r\n@CarTip    varchar(20),\r\n@CarKodIn  varchar(8000),\r\n@BasTarih   Datetime,\r\n@BitTarih   Datetime\r\nAS\r\nBEGIN\r\n  \r\n\r\n   declare @Table table ( \r\n   id               int ,\r\n   Tip              varchar(30),\r\n   Kod              varchar(30),\r\n   Unvan            varchar(250),\r\n   GrupAd           varchar(150),\r\n   DevirBorc     float default 0,\r\n   DevirAlacak     float default 0,\r\n   Borc     float default 0,\r\n   Alacak     float default 0,\r\n   ToplamBorc     float default 0,\r\n   ToplamAlacak   float default 0  \r\n   ) \r\n\r\n\r\n\r\nDECLARE @EKSTRE_CARITEMP TABLE (\r\n id         int,\r\n Firmano    int,\r\n cartip      varchar(20),\r\n carkod      varchar(30) COLLATE Turkish_CI_AS,\r\n carunvan      varchar(250) COLLATE Turkish_CI_AS,\r\n GrupAd        varchar(150) COLLATE Turkish_CI_AS )\r\n\r\ndeclare @separator char(1) \r\n set @separator = ','\r\n\r\n declare @separator_position int\r\n declare @array_value varchar(1000)\r\n\r\n IF (LEN(RTRIM(@CarKodIn)) > 0)\r\n BEGIN\r\n  set @CarKodIn = @CarKodIn + ','\r\n END\r\n\r\n while patindex('%,%' , @CarKodIn) <> 0\r\n begin\r\n\r\n   select @separator_position =  patindex('%,%' , @CarKodIn)\r\n   select @array_value = left(@CarKodIn, @separator_position - 1)\r\n\r\n  Insert @EKSTRE_CARITEMP \r\n  Values (0,0,@CarTip,@array_value,'','')\r\n\r\n   select @CarKodIn = stuff(@CarKodIn, 1, @separator_position, '')\r\n end\r\n\r\n  if @CarKodIn=''\r\n    Insert @EKSTRE_CARITEMP \r\n    select id,firmano,@CarTip,kod,ad,grupad1 from Genel_Kart as vc \r\n    where vc.cartp=@CarTip  and vc.sl=0 \r\n    \r\n \r\n   update @EKSTRE_CARITEMP set id=dt.id,firmano=dt.firmano,carunvan=dt.ad,\r\n   GrupAd=dt.grupad1 \r\n   from @EKSTRE_CARITEMP as t join\r\n   (select id,firmano,kod,ad,grupad1 from Genel_Kart as vc \r\n   where vc.cartp=@CarTip  ) dt\r\n   on t.carkod=dt.kod\r\n \r\n\r\n \r\n   if (@Firmano>0)\r\n    delete @EKSTRE_CARITEMP where Firmano not in (0,@Firmano)\r\n  \r\n   \r\n   insert into  @Table (id,Tip,Kod,Unvan,GrupAd)\r\n    select id,cartip,carkod,carunvan,GrupAd from @EKSTRE_CARITEMP\r\n \r\n  if @CarTip in ('carikart','perkart','gelgidkart')\r\n   begin\r\n    update @Table set \r\n    DevirBorc=case when dt.toplam>0 then (dt.toplam) else 0 end, \r\n    DevirAlacak=case when dt.toplam<0 then abs(dt.toplam) else 0 end \r\n    From @Table as t \r\n    join (select carkod,round(sum(h.borc-h.alacak),2) toplam from carihrk as h with (nolock)\r\n    where cartip=@CarTip and carkod in (select carkod from @EKSTRE_CARITEMP ) \r\n    and sil=0 and Tarih<@BasTarih group by carkod ) dt on dt.carkod=t.kod\r\n\r\n    update @Table set Borc=dt.borc, \r\n    Alacak=dt.alacak From @Table as t \r\n    join (select carkod,round(sum(h.borc-h.alacak),2) toplam,round(sum(h.borc),2) borc,\r\n\tround(sum(h.alacak),2) alacak   from carihrk as h with (nolock)\r\n    where cartip=@CarTip and carkod in (select carkod from @EKSTRE_CARITEMP ) \r\n    and sil=0 and Tarih>=@BasTarih and Tarih<=@BitTarih  group by carkod ) dt on dt.carkod=t.kod\r\n   end\r\n   \r\n   \r\n  if @CarTip in ('bankakart')\r\n   begin\r\n    update @Table set \r\n    DevirBorc=case when dt.toplam>0 then (dt.toplam) else 0 end, \r\n    DevirAlacak=case when dt.toplam<0 then abs(dt.toplam) else 0 end \r\n    From @Table as t \r\n    join (select bankod,round(sum(h.borc-h.alacak),2) toplam from bankahrk as h with (nolock)\r\n    where  bankod in (select carkod from @EKSTRE_CARITEMP ) \r\n    and sil=0 and Tarih<@BasTarih group by bankod ) dt on dt.bankod=t.kod\r\n\r\n    update @Table set Borc=dt.borc, \r\n    Alacak=dt.alacak From @Table as t \r\n    join (select bankod,round(sum(h.borc-h.alacak),2) toplam,round(sum(h.borc),2) borc,\r\n\tround(sum(h.alacak),2) alacak   from bankahrk as h with (nolock)\r\n    where  bankod in (select carkod from @EKSTRE_CARITEMP ) \r\n    and sil=0 and Tarih>=@BasTarih and Tarih<=@BitTarih  group by bankod ) dt on dt.bankod=t.kod\r\n   end \r\n   \r\n  \r\n   \r\n    update @Table set ToplamBorc=\r\n    case when (DevirBorc+Borc)-(DevirAlacak+Alacak)>0 then (DevirBorc+Borc)-(DevirAlacak+Alacak) else 0 end,\r\n    ToplamAlacak=case when (DevirBorc+Borc)-(DevirAlacak+Alacak)<0 then abs((DevirBorc+Borc)-(DevirAlacak+Alacak)) else 0 end\r\n\r\n     select * from @Table\r\n    return\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "SpFaturaFisIkontoKontrol",
    "definition": "CREATE PROCEDURE dbo.SpFaturaFisIkontoKontrol\r\n@FatId     int,\r\n@Sil       bit\r\nAS\r\nBEGIN\r\n \r\n\r\n   \r\n \r\n\r\n   if @Sil=1 \r\n    begin\r\n     /*yansımada iptal */\r\n      update veresihrk set Fat_IskYuz=0,iskyuz=0 where \r\n         verid in (Select verid from veresimas \r\n         with (nolock) where fatid=@FatId )\r\n   \r\n     end\r\n\r\n\r\n   if @Sil=0\r\n    begin\r\n\r\n    declare @GenelIskTop    float\r\n    declare @FatFisIskYansit bit\r\n\r\n\r\n     select top 1 @FatFisIskYansit=FaturaFisIskonto from sistemtanim \r\n\r\n\r\n    \r\n          \r\n    set @GenelIskTop=0\r\n    \r\n    Select @GenelIskTop=genel_isk_top from faturamas with (nolock)\r\n    where fatid=@FatId\r\n    \r\n     if @GenelIskTop>=0\r\n     begin  \r\n     \r\n     \r\n       if @FatFisIskYansit=0 /*sadece Fat_IskYuz */\r\n         update veresihrk set \r\n         Fat_IskYuz=dt.FatSatIskYuz\r\n         from veresihrk as t \r\n         join (\r\n         Select v.verid,h.stktip,h.stkod,\r\n         case when (h.brmfiy*h.mik) > 0 then  \r\n         ROUND( (h.top_isk_tut/(h.brmfiy*h.mik))*100,4) else 0 end as FatSatIskYuz   \r\n         from veresimas as v with (nolock) \r\n         inner join faturahrk as h with (nolock) on h.fatid=@FatId and h.sil=0\r\n         where v.fatid=@FatId ) dt on dt.verid=t.verid \r\n         and dt.stkod=t.stkod and dt.stktip=t.stktip\r\n        \r\n              \r\n        if @FatFisIskYansit=1 \r\n         update veresihrk set \r\n         Fat_IskYuz=dt.FatSatIskYuz,\r\n         iskyuz=dt.FatSatIskYuz\r\n         from veresihrk as t \r\n         join (\r\n         Select v.verid,h.stktip,h.stkod,\r\n         case when (h.brmfiy*h.mik) > 0 then  \r\n         ROUND( (h.top_isk_tut/(h.brmfiy*h.mik))*100,4) else 0 end as FatSatIskYuz   \r\n         from veresimas as v with (nolock) \r\n         inner join faturahrk as h with (nolock) on h.fatid=@FatId and h.sil=0\r\n         where v.fatid=@FatId ) dt on dt.verid=t.verid \r\n         and dt.stkod=t.stkod and dt.stktip=t.stktip\r\n         \r\n         \r\n         \r\n         \r\n         \r\n  \r\n    end\r\n\r\n  end\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "SpFaturaHrkKarAnaliz",
    "definition": "CREATE PROCEDURE dbo.SpFaturaHrkKarAnaliz\r\n@FatId    int\r\nAS\r\nBEGIN\r\n  \r\n\r\n  Create Table #FatHrkKarAnaliz (\r\n   Firmano              int,\r\n   FatId   \t\t\t\tint,\r\n   StokTipId            int,\r\n   StokId               int,\r\n   STOK_KOD   \t\t\tvarchar(50),\r\n   Barkod     \t\t\tvarchar(50),\r\n   STOK_AD    \t\t\tvarchar(250),\r\n   MIKTAR     \t\t\tfloat,\r\n   KDV        \t\t\tfloat,\r\n   STOK_BIRIM   varchar(50),\r\n   BIRIM_FIYAT \t\t\tfloat,\r\n   BIRIM_FIYATKDVLI   \tfloat,\r\n   TUTAR                float,\r\n   TUTARKDVLI \t\t\tfloat,\r\n   SAT_BIRIM_FIYATKDVLI float,\r\n   SAT_TUTARKDVLI\t    float,\r\n   KAR_YUZDE    \t\tfloat,\r\n      \r\n   TEDARIKFIYATKDVLI         float Default 0,\r\n   MARJYUZDE            float Default 100,\r\n   TEDARIKMARJFIYAT         float Default 0,\r\n   TEDARIKMARJFARK          float Default 0,\r\n   TEDARIKMARJTUTAR    \t\tfloat Default 0\r\n  )\r\n\r\n\r\ninsert into #FatHrkKarAnaliz (Firmano,FatId,StokTipId,StokId,\r\nSTOK_KOD,Barkod,STOK_AD,MIKTAR,KDV,STOK_BIRIM,\r\nBIRIM_FIYAT,BIRIM_FIYATKDVLI,TUTAR,TUTARKDVLI,\r\nSAT_BIRIM_FIYATKDVLI,SAT_TUTARKDVLI,KAR_YUZDE)\r\n\r\nselect fm.firmano, \r\nfhrk.fatid,gstk.Tip_id,gstk.id,\r\nfhrk.stkod AS STOK_KOD,\r\nfhrk.barkod,\r\ngstk.ad as STOK_AD,\r\n(fhrk.mik) MIKTAR,\r\n(fhrk.kdvyuz*100) as KDV,\r\nfhrk.brim AS STOK_BIRIM,\r\n((fhrk.brmfiy+fhrk.otvbrim)-(fhrk.satisktut+fhrk.genisktut)) BIRIM_FIYAT,\r\n((fhrk.brmfiy+fhrk.otvbrim)-(fhrk.satisktut+fhrk.genisktut))*(1+fhrk.kdvyuz) BIRIM_FIYATKDVLI,\r\n((fhrk.brmfiy+fhrk.otvbrim)-(fhrk.satisktut+fhrk.genisktut))*fhrk.mik TUTAR,\r\n((fhrk.brmfiy+fhrk.otvbrim)-(fhrk.satisktut+fhrk.genisktut))*(1+fhrk.kdvyuz)*fhrk.mik TUTARKDVLI,\r\ncase when gstk.sat1kdvtip='Dahil' then  sat1fiy \r\nelse gstk.sat1fiy*(1+(gstk.sat1kdv/100)) END SAT_BIRIM_FIYATKDVLI,\r\n\r\nfhrk.mik*case when gstk.sat1kdvtip='Dahil' then  sat1fiy \r\nelse gstk.sat1fiy*(1+(gstk.sat1kdv/100)) END SAT_TUTARKDVLI,\r\n0 KAR_YUZDE\r\n/*\r\n -1*round( (1-((case when gstk.sat1kdvtip='Dahil' then  sat1fiy else gstk.sat1fiy*(1+(gstk.sat1kdv/100)) END) / \r\n (case when ((fhrk.brmfiy+fhrk.otvbrim)-(fhrk.satisktut+fhrk.genisktut))*(1+fhrk.kdvyuz)=0 then\r\n 1 else ((fhrk.brmfiy+fhrk.otvbrim)-(fhrk.satisktut+fhrk.genisktut))*(1+fhrk.kdvyuz) end)))*100,2) KAR_YUZDE\r\n */\r\n\r\n\r\n  from faturahrk AS fhrk WITH (NOLOCK)\r\n  inner join faturamas as fm  WITH (NOLOCK) on fm.fatid=fhrk.fatid and fm.sil=0\r\n  inner join gelgidlistok as gstk WITH (NOLOCK) \r\n  on gstk.kod=fhrk.stkod\r\n  and fhrk.stktip=gstk.tip \r\n  where fhrk.fatid=@FatId and fhrk.sil=0 \r\n\r\n \r\n Create Table #StokFiyatAnaliz (\r\n  Tarih    Datetime\r\n   \r\n )\r\n \r\n insert into #StokFiyatAnaliz (Tarih)\r\n select max(Tarih) from StokFiyatLog (nolock)\r\n where sil=0 and Tarih <= (select top 1 Tarih From faturamas (nolock) \r\n Where Fatid=@FatId and Sil=0 ) and StokId in (select StokId from #FatHrkKarAnaliz )\r\n group by Firmano,StokTipId,StokId\r\n order by Max(Tarih) desc  \r\n \r\n\r\n update #FatHrkKarAnaliz SET \r\n TEDARIKFIYATKDVLI=dt.TedarikFiyat,\r\n MARJYUZDE=dt.MarjYuzde,\r\n SAT_BIRIM_FIYATKDVLI=dt.SatisFiyat,\r\n SAT_TUTARKDVLI=dt.SatisFiyat*MIKTAR \r\n from #FatHrkKarAnaliz as t join (\r\n select Firmano,StokTipId,StokId,\r\n SatisFiyat,TedarikFiyat,MarjYuzde from StokFiyatLog (nolock)\r\n where Sil=0 and Tarih in (select Tarih from #StokFiyatAnaliz) )\r\n dt on dt.StokTipId=t.StokTipId and dt.StokId=t.StokId\r\n and dt.Firmano=t.Firmano\r\n \r\n update  #FatHrkKarAnaliz SET TEDARIKMARJFIYAT=((SAT_BIRIM_FIYATKDVLI-TEDARIKFIYATKDVLI)*MARJYUZDE)/100\r\n \r\n update  #FatHrkKarAnaliz SET TEDARIKMARJFARK=(TEDARIKMARJFIYAT-(SAT_BIRIM_FIYATKDVLI-BIRIM_FIYATKDVLI))\r\n \r\n update #FatHrkKarAnaliz SET  TEDARIKMARJTUTAR=TEDARIKMARJFARK*MIKTAR\r\n \r\n \r\n update #FatHrkKarAnaliz SET  KAR_YUZDE=\r\n case when SAT_BIRIM_FIYATKDVLI=0 then 0 else \r\n ((SAT_BIRIM_FIYATKDVLI-BIRIM_FIYATKDVLI)/SAT_BIRIM_FIYATKDVLI)*100\r\n end\r\n\r\n\r\n select *,(SAT_TUTARKDVLI-TUTARKDVLI) FARK_TUTAR from #FatHrkKarAnaliz\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "SpGunlukIslemOzet",
    "definition": "CREATE PROCEDURE [dbo].[SpGunlukIslemOzet]\r\n@Firmano int,\r\n@Tarih   Datetime\r\nAS\r\nBEGIN\r\n\r\n  declare @Sirano  int\r\n\r\n  /*1.Rapor Stok Durum Rapor Urun Adi Miktar - Tutar  */\r\n   Declare  @StokDurum TABLE (\r\n   KARTKOD     VARCHAR(30),\r\n   KARTAD     VARCHAR(150),\r\n   MIKTAR      FLOAT,\r\n   TUTAR       FLOAT\r\n   )\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n   /*2.Rapor Pompaci Vardiya Satis Rapor Urun Adi Miktar - Tutar - Kar tutar  */\r\n   Declare  @PompaciVardiyaDurum TABLE (\r\n   KARTKOD     VARCHAR(30),\r\n   KARTAD     VARCHAR(150),\r\n   MIKTAR      FLOAT,\r\n   TUTAR       FLOAT,\r\n   KARTUTAR    FLOAT\r\n   )\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\r\n   /*3.Rapor Pos mevduat Rapor Urun BANKA,POS  Tutar  */\r\n   Declare  @BankaPosDurum TABLE (\r\n   KARTKOD     VARCHAR(30),\r\n   KARTAD     VARCHAR(150),\r\n   MIKTAR      FLOAT,\r\n   TUTAR       FLOAT\r\n   )\t\r\n    \r\n  \r\n   /*4.Rapor Cari BorcAlacak Rapor Urun BANKA,POS  Tutar  */\r\n   Declare  @CariBorcAlacakDurum TABLE (\r\n   KARTKOD     VARCHAR(30),\r\n   KARTAD     VARCHAR(150),\r\n   MIKTAR      FLOAT,\r\n   TUTAR       FLOAT\r\n   )\t\r\n   \r\n   \r\n   /*5.Rapor GelirGider Rapor Tutar  */\r\n   Declare  @GelirGiderDurum TABLE (\r\n   KARTKOD     VARCHAR(30),\r\n   KARTAD     VARCHAR(150),\r\n   MIKTAR      FLOAT,\r\n   TUTAR       FLOAT\r\n   )\t\r\n   \r\n   \r\n   \r\n    CREATE TABLE  #TB_RAPOR (\r\n    Id         \t\t    INT IDENTITY(1, 1),\r\n    SiraNo\t\t\t    int DEFAULT 1,\r\n    BaslikNo              int default 0,\r\n    GrupNo\t\t\t\t\tint,\r\n    DegerId\t\t\t\t int, \r\n    DegerKod\t\t     VARCHAR(50), \r\n    Alan1Type            int default 0, /* string 0 - 1 float -2 tarih  */\r\n    Alan1Deger\t\t\tVARCHAR(100)  COLLATE Turkish_CI_AS DEFAULT '',\r\n    Alan2Type\t\t\t int default 0, /* string 0 - 1 float -2 tarih  */\r\n    Alan2Deger    \t        VARCHAR(100)  COLLATE Turkish_CI_AS DEFAULT '',\r\n    Alan3Type\t\t\t int default 0, /* string 0 - 1 float -2 tarih  */\r\n    Alan3Deger               VARCHAR(100)  COLLATE Turkish_CI_AS DEFAULT '',\r\n    Alan4Type\t\t\t int default 0, /* string 0 - 1 float -2 tarih  */\r\n    Alan4Deger               VARCHAR(100)  COLLATE Turkish_CI_AS DEFAULT '',\r\n    Alan5Type\t\t\t int default 0, /* string 0 - 1 float -2 tarih  */\r\n    Alan5Deger               VARCHAR(100)  COLLATE Turkish_CI_AS DEFAULT '', \r\n    Alan6Type\t\t\t int default 0, /* string 0 - 1 float -2 tarih  */\r\n    Alan6Deger               VARCHAR(100)  COLLATE Turkish_CI_AS DEFAULT '', \r\n    Alan7Type\t\t\t int default 0, /* string 0 - 1 float -2 tarih  */\r\n    Alan7Deger               VARCHAR(100)  COLLATE Turkish_CI_AS DEFAULT ''\r\n    )\r\n\r\n    \r\n    /*------------Stok Durum*/\r\n     set @Sirano=1\r\n     insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,Alan1Deger)\r\n      select 1,@Sirano,1,'Stok Durum '\r\n    \r\n    \r\n     insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,Alan1Deger,Alan2Deger,Alan3Deger,Alan4Deger)\r\n     select 2,@Sirano,1,'ÃƒÅ“rÃƒÂ¼n ','Miktar','Tutar','Fiyat'\r\n     \r\n     \r\n      insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,DegerKod,Alan1Deger,\r\n      Alan2Type,Alan2Deger,Alan3Type,Alan3Deger,Alan4Type)\r\n      select 5,@Sirano,1,s.Kod,Ad,1,0,1,0,1 from stokkart as s with (nolock) \r\n      Where s.sil=0 and s.tip='akykt' and s.firmano in (0,@Firmano)\r\n      \r\n      insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,DegerKod,Alan1Deger,\r\n      Alan2Type,Alan2Deger,Alan3Type,Alan3Deger,Alan4Type)\r\n      select 5,@Sirano,1,'markt','MARKET',1,0,1,0,1\r\n      \r\n      /*Son Akaryakit Tarihteki Alis Fiyat */\r\n      \r\n       Declare  @StokFiyat TABLE (\r\n       Tip     VARCHAR(30),\r\n       Kod     VARCHAR(150),\r\n       Tarih      Datetime,\r\n       BakiyeMiktar      float default 0,\r\n       SatisMiktar\t\tfloat default 0,\r\n       SatisTutar\t\tfloat default 0,\r\n       AlisFiyat       float default 0,\r\n       FifoFiyat       float default 0\r\n       )\r\n      \r\n      insert into @StokFiyat (Tip,Kod,BakiyeMiktar,Tarih)\r\n      SELECT  S.stktip,s.stkod,sum(giren-cikan),\r\n      max(\r\n      case when s.giren>0 then S.tarih+cast(saat as datetime) else null end)\r\n      FROM stkhrk as s with (NOLOCK) WHERE \r\n      s.sil=0  and (s.tarih<=@Tarih) and s.firmano in (0,@Firmano)\r\n      group by s.stkod,S.stktip\r\n      \r\n     \r\n      update @StokFiyat set \r\n      SatisMiktar=round(dt.SatisMiktar,2),\r\n      SatisTutar=round(dt.SatisTutar,2)\r\n       from @StokFiyat as t \r\n      join (select sum(cikan-giren) SatisMiktar,\r\n      sum((cikan*brmfiykdvli)-(giren*brmfiykdvli) ) as SatisTutar,\r\n      S.stktip,s.stkod \r\n      from stkhrk as s with (NOLOCK) \r\n      where s.sil=0  and s.Tarih=@Tarih /*and s.cikan>0 */\r\n      and s.firmano in (0,@Firmano) and s.yertip in ('marvardimas','pomvardimas')\r\n      group by S.stktip,s.stkod ) dt on \r\n      dt.stktip=t.tip and dt.stkod=t.kod\r\n           \r\n      \r\n      \r\n      \r\n        declare @i      int\r\n        declare @Count      int\r\n        declare @Tip    varchar(20)\r\n        declare @Kod    varchar(50)\r\n        declare @KodIn  varchar(500)\r\n        declare @StokTipCount      int\r\n       set  @StokTipCount=1\r\n       \r\n      WHILE @StokTipCount < 3 /*3 */\r\n       begin\r\n       \r\n       \r\n       \r\n       \r\n        if @StokTipCount=1\r\n         set @Tip='akykt'\r\n         \r\n        if @StokTipCount=2\r\n         set @Tip='markt'\r\n       \r\n       \r\n        set @StokTipCount=@StokTipCount+1\r\n        set @KodIn=''\r\n        set @i=0\r\n        declare Cur CURSOR FAST_FORWARD  FOR \r\n         select Tip,Kod,\r\n         (Select Count(Kod) from @StokFiyat Where Tip=@Tip )\r\n         Say from @StokFiyat Where Tip=@Tip\r\n         open Cur\r\n        fetch next from  Cur into @Tip,@Kod,@Count\r\n        while @@FETCH_STATUS=0\r\n         begin\r\n          set @i=@i+1\r\n          \r\n            \r\n          if @KodIn=''\r\n           set @KodIn=@Kod\r\n          else\r\n           set @KodIn=@KodIn+','+@Kod\r\n          \r\n  \r\n          \r\n          \r\n          if (@i%20)=0\r\n           begin   \r\n            update @StokFiyat set FifoFiyat=round(dt.BRMTUT,2) from @StokFiyat as t \r\n            join (select * from fn_StokFifo(@Firmano,@Tip,@KodIn,@Tarih) )dt\r\n            on dt.STOK_TIP=t.Tip and dt.STOK_KOD=t.kod\r\n            set @KodIn=''\r\n          end\r\n          \r\n          if (@Count=@i) and @KodIn<>''\r\n           begin   \r\n            update @StokFiyat set FifoFiyat=dt.BRMTUT from @StokFiyat as t \r\n            join (select * from fn_StokFifo(@Firmano,@Tip,@KodIn,@Tarih) )dt\r\n            on dt.STOK_TIP=t.Tip and dt.STOK_KOD=t.kod\r\n            set @KodIn=''\r\n          end\r\n          \r\n         \r\n         FETCH next from  Cur into @Tip,@Kod,@Count\r\n        end\r\n       close Cur\r\n       deallocate Cur\r\n      \r\n     end /* while  */\r\n      \r\n          \r\n      \r\n      update @StokFiyat set AlisFiyat=round(dt.brmfiykdvli,2) from @StokFiyat as t \r\n      join (select S.brmfiykdvli,S.stktip,s.stkod,\r\n      S.tarih+cast(saat as datetime) as tarih from stkhrk as s with (NOLOCK) \r\n      where s.sil=0 and s.giren>0 and s.firmano in (@Firmano) ) dt on dt.Tarih=t.Tarih \r\n      and dt.stktip=t.tip and dt.stkod=t.kod\r\n      \r\n      /*Akaryakit */\r\n      update #TB_RAPOR set \r\n      Alan2Deger=dt.miktar,\r\n      Alan3Deger=dt.Tutar,\r\n      Alan4Deger=dt.AlisFiyat  \r\n      From #TB_RAPOR as t \r\n      join (select Tip,Kod,AlisFiyat,Round(BakiyeMiktar,2) Miktar,\r\n      Round(BakiyeMiktar*AlisFiyat,2) as Tutar \r\n      from @StokFiyat where Tip='akykt' )\r\n      dt on t.DegerKod=dt.Kod\r\n      \r\n      \r\n       /*Market */\r\n      update #TB_RAPOR set Alan2Deger=dt.miktar,\r\n      Alan3Deger=dt.Tutar,\r\n      Alan4Deger=dt.AlisFiyat From #TB_RAPOR as t \r\n      join (select Round(sum(BakiyeMiktar),2) Miktar,\r\n      Round(sum(BakiyeMiktar*AlisFiyat),2) as Tutar,\r\n      case when Round(sum(BakiyeMiktar),2)>0 then \r\n      Round(sum(BakiyeMiktar*AlisFiyat),2) / Round(sum(BakiyeMiktar),2) \r\n      else 0 end AlisFiyat \r\n       from @StokFiyat where Tip='markt'  )\r\n      dt on t.DegerKod='markt'     \r\n      \r\n        \r\n      /*Toplam */\r\n       \r\n      insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,DegerKod,Alan1Deger,\r\n      Alan2Type,Alan2Deger,Alan3Type,Alan3Deger)\r\n      select 10,1,1,'','TOPLAM',\r\n      1,Round(sum(BakiyeMiktar),2) Miktar,1,Round(sum(BakiyeMiktar*AlisFiyat),2)\r\n      as Tutar from @StokFiyat\r\n     \r\n   /* Stok Durum Sonu */\r\n   \r\n     \r\n     \r\n    /* Pompaci Vardiya Durum*/\r\n     set @Sirano=10\r\n     insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,Alan1Deger)\r\n     select 1,@Sirano,1,'Pompaci Vardiya Satis '                                                                                                                                                     \r\n    \r\n    \r\n     insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,Alan1Deger,Alan2Deger,Alan3Deger,Alan4Deger)\r\n     select 2,@Sirano,1,'Urun ','Miktar','Tutar','Kar'\r\n    \r\n    \r\n      insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,DegerKod,Alan1Deger,\r\n      Alan2Type,Alan2Deger,Alan3Type,Alan3Deger,Alan4Type,Alan4Deger)\r\n      select 5,@Sirano,1,s.Kod,Ad,1,0,1,0,1,0 from stokkart as s with (nolock) \r\n      Where s.sil=0 and s.tip='akykt' and s.firmano in (0,@Firmano)\r\n    \r\n    \r\n      update #TB_RAPOR set Alan2Deger=dt.miktar,\r\n      Alan3Deger=dt.Tutar,Alan4Deger=dt.KarTutar  \r\n      From #TB_RAPOR as t \r\n      join (select Tip,Kod,Round(SatisMiktar,2) Miktar,\r\n      Round(SatisTutar,2) as Tutar,\r\n      Round(SatisTutar,2)-(SatisMiktar*FifoFiyat) as KarTutar\r\n      \r\n      from @StokFiyat where Tip='akykt' )\r\n      dt on t.DegerKod=dt.Kod and t.SiraNo=@Sirano\r\n      \r\n      \r\n      \r\n      insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,DegerKod,Alan1Deger,\r\n      Alan2Type,Alan2Deger,Alan3Type,Alan3Deger,Alan4Type,Alan4Deger)\r\n      select 10,@Sirano,1,'','TOPLAM',1,\r\n      Round(Sum(SatisMiktar),2),1,Round(Sum(SatisTutar),2),\r\n      1,Round(sum((SatisTutar)-(SatisMiktar*FifoFiyat)),2) \r\n      from @StokFiyat where Tip='akykt' \r\n\r\n    /* Pompaci Vardiya Sonu*/\r\n    \r\n    \r\n    /*Pos Banka Durum */\r\n    \r\n    set @Sirano=20\r\n    insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,Alan1Deger)\r\n    select 1,@Sirano,1,'Cari - Banka - Pos Durum '       \r\n     \r\n    insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,Alan1Deger,Alan2Deger,Alan3Deger,Alan4Deger)\r\n    select 2,@Sirano,1,'Aciklama ','Borc Bakiye','Alacak Bakiye','Bakiye'\r\n    \r\n    \r\n    insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,DegerKod,Alan1Deger,\r\n      Alan2Type,Alan2Deger,Alan3Type,Alan3Deger,Alan4Type,Alan4Deger)  \r\n      select TOP 1 5,@Sirano,1,'','CARi',\r\n      1,LTRIM(STR(round(Sum(borc),2),25,2)),1,LTRIM(STR(round(Sum(alacak),2),25,2)),\r\n      1,LTRIM(STR(round(Sum(borc-alacak),2),25,2)) FROM  carihrk as s with (nolock)\r\n      where s.cartip='carikart' and s.Sil=0 and s.firmano in (0,@Firmano) and s.Tarih<@Tarih   \r\n    \r\n    \r\n    insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,DegerKod,Alan1Deger,\r\n      Alan2Type,Alan2Deger,Alan3Type,Alan3Deger,Alan4Type,Alan4Deger)  \r\n    select TOP 1 5,@Sirano,1,'','BANKA',\r\n      1,BAKIYE_BORC,1,BAKIYE_ALACAK,1,BAKIYE_BORC-BAKIYE_ALACAK  FROM  UDF_MIZAN_BANKA (@firmano,0,'2000-01-01',@Tarih,0)\r\n       \r\n       \r\n    insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,DegerKod,Alan1Deger,\r\n      Alan2Type,Alan2Deger,Alan3Type,Alan3Deger,Alan4Type,Alan4Deger)  \r\n      select TOP 1 5,@Sirano,1,'','POS',\r\n      1,BAKIYE_BORC,1,BAKIYE_ALACAK,1,BAKIYE_BORC-BAKIYE_ALACAK FROM  UDF_MIZAN_POS_BEKLEYEN (@firmano,0,'2000-01-01',@Tarih,0) \r\n      \r\n      \r\n      \r\n      \r\n      \r\n     \r\n    \r\n      insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,DegerKod,Alan1Deger,\r\n      Alan2Type,Alan2Deger,Alan3Type,Alan3Deger,Alan4Type,Alan4Deger)\r\n      SELECT 10,@Sirano,1,'','TOPLAM',\r\n      1,LTRIM(STR(Sum(cast( Alan2Deger as float)),25,2)),\r\n      1,LTRIM(STR(sum(cast( Alan3Deger as float)),25,2)),\r\n      1,LTRIM(STR(sum(cast( Alan4Deger as float)),25,2))\r\n      from #TB_RAPOR where BaslikNo=5 and Sirano=@Sirano\r\n     \r\n  \r\n   /*Pos Banka Durum Sonu */\r\n   \r\n   \r\n   \r\n  \r\n   \r\n    /*Cari Durum */\r\n    \r\n  /*  set @Sirano=40\r\n    insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,Alan1Deger)\r\n    select 1,@Sirano,1,'Cari  '       \r\n     \r\n    insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,Alan1Deger,Alan2Deger,Alan3Deger,Alan4Deger)\r\n    select 2,@Sirano,1,'AÃƒÂ§Ã„Â±klama ','BorÃƒÂ§ Bakiye','Alacak Bakiye',''\r\n    \r\n    insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,DegerKod,Alan1Deger,\r\n      Alan2Type,Alan2Deger,Alan3Type,Alan3Deger)  \r\n    select TOP 1 5,@Sirano,1,'','BANKA',\r\n      1,BAKIYE_BORC,1,BAKIYE_ALACAK FROM  UDF_MIZAN_BANKA (0,0,'2000-01-01',@Tarih,0)\r\n       \r\n       \r\n    insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,DegerKod,Alan1Deger,\r\n      Alan2Type,Alan2Deger,Alan3Type,Alan3Deger)  \r\n    select TOP 1 5,@Sirano,1,'','POS',\r\n      1,BAKIYE_BORC,1,BAKIYE_ALACAK FROM  UDF_MIZAN_POS_BEKLEYEN (0,0,'2000-01-01',@Tarih,0) \r\n     \r\n    \r\n    insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,DegerKod,Alan1Deger,\r\n      Alan2Type,Alan2Deger,Alan3Type,Alan3Deger)\r\n      SELECT 5,@Sirano,1,'','TOPLAM',1,Sum(cast( Alan2Deger as float)),1,sum(cast( Alan3Deger as float))\r\n      from #TB_RAPOR where BaslikNo=5 and Sirano=@Sirano\r\n    */ \r\n  \r\n   /*CariDurum Sonu */\r\n   \r\n   \r\n   \r\n    \r\n   \r\n   \r\n    /* Market Vardiya Satis */\r\n     set @Sirano=50\r\n     insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,Alan1Deger)\r\n     select 1,@Sirano,1,'Market Vardiya Satis '                                                                                                                                                     \r\n    \r\n    \r\n     insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,Alan1Deger,Alan2Deger,Alan3Deger,Alan4Deger)\r\n     select 2,@Sirano,1,'Urun ','Miktar','Tutar','Kar'\r\n    \r\n    \r\n      insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,DegerKod,Alan1Deger,\r\n      Alan2Type,Alan2Deger,Alan3Type,Alan3Deger,Alan4Type,Alan4Deger)\r\n      select 5,@Sirano,1,'markt','MARKET',1,0,1,0,1,0 \r\n       \r\n    \r\n      update #TB_RAPOR set Alan2Deger=dt.SatisMiktar,\r\n      Alan3Deger=dt.SatisTutar,Alan4Deger=dt.KarTutar  \r\n      From #TB_RAPOR as t \r\n      join (select  Round(Sum(SatisMiktar),2) SatisMiktar,\r\n      Round(Sum(SatisTutar),2) SatisTutar ,\r\n      Round(sum((SatisTutar)-(SatisMiktar*FifoFiyat)),2) KarTutar  \r\n      from @StokFiyat where Tip='markt' )\r\n      dt on t.SiraNo=@Sirano and BaslikNo=5\r\n     \r\n      insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,DegerKod,Alan1Deger,\r\n      Alan2Type,Alan2Deger,Alan3Type,Alan3Deger,Alan4Type,Alan4Deger)\r\n      select 10,@Sirano,1,'','TOPLAM',\r\n      1,Round(Sum(SatisMiktar),2),\r\n      1,Round(Sum(SatisTutar),2),\r\n      1,Round(sum((SatisTutar)-(SatisMiktar*isnull(FifoFiyat,0))),2) \r\n      from @StokFiyat where Tip='markt' \r\n   \r\n    /* Market Vardiya Sonu*/\r\n    \r\n    \r\n    \r\n    \r\n     /* Gelir Gider */\r\n     set @Sirano=60\r\n     insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,Alan1Deger)\r\n     select 1,@Sirano,1,'Gelir - Gider'                                                                                                                                                     \r\n    \r\n    \r\n     insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,Alan1Deger,Alan2Deger,Alan3Deger,Alan4Deger)\r\n     select 2,@Sirano,1,'Aciklama ','Gelir','Gider','Fark'\r\n    \r\n    \r\n     insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,DegerKod,Alan1Deger,\r\n      Alan2Type,Alan2Deger,Alan3Type,Alan3Deger,Alan4Type,Alan4Deger)  \r\n      select 5,@Sirano,1,'','Gider',\r\n      1,LTRIM(STR(isnull(round(Sum(alacak),2),0),25,2)),\r\n      1,LTRIM(STR(isnull(round(Sum(borc),2),0),25,2)),\r\n      1,LTRIM(STR(isnull(round(Sum(alacak-borc),2),0),25,2)) FROM  carihrk as s with (nolock)\r\n      where s.cartip='gelgidkart' and s.Sil=0 and s.firmano in (0,@Firmano) and s.Tarih=@Tarih\r\n      and Borc>0    \r\n      \r\n      \r\n      insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,DegerKod,Alan1Deger,\r\n      Alan2Type,Alan2Deger,Alan3Type,Alan3Deger,Alan4Type,Alan4Deger)  \r\n      select 5,@Sirano,1,'','Gelir',\r\n      1,LTRIM(STR(isnull(round(Sum(alacak),2),0),25,2)),\r\n      1,LTRIM(STR(isnull(round(Sum(borc),2),0),25,2)),\r\n      1,LTRIM(STR(isnull(round(Sum(alacak-borc),2),0),25,2)) FROM  carihrk as s with (nolock)\r\n      where s.cartip='gelgidkart' and s.Sil=0 and s.firmano in (0,@Firmano) and s.Tarih=@Tarih\r\n      and Alacak>0   \r\n  \r\n    \r\n      insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,DegerKod,Alan1Deger,\r\n      Alan2Type,Alan2Deger,Alan3Type,Alan3Deger,Alan4Type,Alan4Deger)\r\n      SELECT 10,@Sirano,1,'','TOPLAM',\r\n      1,LTRIM(STR(isnull(Sum(cast( Alan2Deger as float)),0),25,2)),\r\n      1,LTRIM(STR(isnull(Sum(cast( Alan3Deger as float)),0),25,2)),\r\n      1,LTRIM(STR(isnull(Sum(cast( Alan4Deger as float)),0),25,2))\r\n      from #TB_RAPOR where BaslikNo=5 and Sirano=@Sirano\r\n\r\n    /* Gelir Gider Sonu*/\r\n    \r\n  \r\n  \r\n  \r\n   /*Kasa Durum Durum */\r\n    \r\n    set @Sirano=70\r\n    insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,Alan1Deger)\r\n    select 1,@Sirano,1,'Kasa Durum '       \r\n     \r\n    insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,Alan1Deger,Alan2Deger,Alan3Deger,Alan4Deger)\r\n    select 2,@Sirano,1,'Aciklama ','Giren','Cikan','Bakiye'\r\n    \r\n           \r\n     insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,DegerKod,Alan1Deger,\r\n      Alan2Type,Alan2Deger,Alan3Type,Alan3Deger,Alan4Type,Alan4Deger)  \r\n      select 5,@Sirano,1,'',ACK,\r\n      1,BORC,1,ALACAK,1,BAKIYE_BORC-BAKIYE_ALACAK FROM  UDF_MIZAN_KASA (@Firmano,0,@Tarih,@Tarih,0)\r\n      Where ParentId=1 \r\n      \r\n            \r\n     \r\n    \r\n      insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,DegerKod,Alan1Deger,\r\n      Alan2Type,Alan2Deger,Alan3Type,Alan3Deger,Alan4Type,Alan4Deger)\r\n      SELECT 5,@Sirano,1,'','TOPLAM',\r\n      1,LTRIM(STR(Sum(cast( Alan2Deger as float)),25,2)),\r\n      1,LTRIM(STR(sum(cast( Alan3Deger as float)),25,2)),\r\n      1,LTRIM(STR(sum(cast( Alan4Deger as float)),25,2))\r\n      from #TB_RAPOR where BaslikNo=5 and Sirano=@Sirano\r\n     \r\n \r\n   /*Kasa Durum Sonu */\r\n\r\n\r\n    set @Sirano=80\r\n    insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,Alan1Deger)\r\n    select 1,@Sirano,1,'Genel Kar/Zarar '\r\n    \r\n     insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,Alan1Deger,Alan2Deger,Alan3Deger)\r\n     select 2,@Sirano,1,'Aciklama','Kar','Zarar'\r\n    \r\n    \r\n      declare @KarZarar float\r\n      select @KarZarar=Round(sum((SatisTutar)-(SatisMiktar*FifoFiyat)),2)\r\n      from @StokFiyat \r\n      \r\n      select @KarZarar=Round(sum((SatisTutar)-(SatisMiktar*FifoFiyat)),2)\r\n      from @StokFiyat\r\n      /*gelir gider */\r\n      SELECT @KarZarar=@KarZarar+isnull(Sum(cast( Alan4Deger as float)),0)\r\n      from #TB_RAPOR where BaslikNo=5 and Sirano=60\r\n      \r\n      \r\n       \r\n     \r\n      insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,DegerKod,Alan1Deger,\r\n      Alan2Type,Alan2Deger,Alan3Type,Alan3Deger)  \r\n      select 5,@Sirano,1,'','KAR/ZARAR',\r\n      1, CASE when @KarZarar>0 then @KarZarar else 0 end,\r\n      1, CASE when @KarZarar<0 then -1*@KarZarar else 0 end\r\n   \r\n\r\n  \r\n    select * from #TB_RAPOR order by SiraNo,BaslikNo,Id\r\n  \r\n  /*  select * from @StokFiyat */\r\n  \r\n  return\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "SpLog_Fatura",
    "definition": "CREATE PROCEDURE dbo.SpLog_Fatura(@FaturaId int)\r\nAS\r\nBEGIN\r\n \r\n \r\n     SET NOCOUNT ON\r\n     \r\n     \r\n     if not EXISTS (SELECT [id] FROM [petromas_db]..[isletme] \r\n      where dataname=DB_NAME() and isnull(AktarimYapilacak,0)=1 )\r\n      RETURN\r\n     \r\n\r\n     IF NOT EXISTS (SELECT * FROM [petromas_db].dbo.sysobjects WHERE name = N'BayiInfo' AND xtype='U' ) \r\n      RETURN\r\n \r\n   \r\n\r\n\tDECLARE @BayiId INT\r\n\tSET @BayiId = (SELECT TOP 1 [BayiId] FROM [petromas_db]..[BayiInfo] ORDER BY BayiId DESC)\r\n  \r\n    if @BayiId is null\r\n\t RETURN\r\n     \r\n    \r\n     \r\n\t   \r\n \r\n \r\n\r\n      /*update islemi Silme */\r\n     update Log_Fatura Set Sil=dt.Sil,TransferStartId=TransferStartId+1,\r\n     SyncStatus=1\r\n     from  Log_Fatura as t join \r\n     (Select ins.id,ins.Sil FROM Faturamas  AS ins with (nolock)\r\n     join Genel_Cari_Kart c with (nolock)\r\n     on c.kod = ins.carkod and c.cartip=ins.cartip\r\n     where ins.id=@FaturaId \r\n      and ins.id in (Select Id From Log_Fatura where Id=@FaturaId )) dt on dt.id=t.Id\r\n\r\n\r\n\r\n\r\n\r\n\t    INSERT INTO Log_Fatura\r\n\t\t(\r\n\t\t\tId,\r\n\t\t\tAciklama\r\n\t\t\t/*,YOK! */\r\n\t\t\t,AkaryakitIskontoTutar\r\n\t\t\t,AkaryakitIskontoYuzde\r\n\t\t\t,AkaryakitMatrah\r\n\t\t\t/*,YOK! */\r\n\t\t\t,BayiId\r\n\t\t\t,KartId\r\n\t\t\t/*,YOK! */\r\n\t\t\t/*,YOK! */\r\n\t\t\t,KartTipId\r\n\t\t\t/*,<KarsiKartId, int,> */\r\n\t\t\t/*,<KarsiKartTipId, int,> */\r\n\t\t\t/*,<KartId, int,> */\r\n\t\t\t/*,YOK! */\r\n\t\t\t,DegistirmeTarihSaat\r\n\t\t\t/*,<DegistirmeKullaniciId, int,> */\r\n\t\t\t/*,<DegistirmeKullaniciTipId, int,> */\r\n\t\t\t/*,YOK! */\r\n\t\t\t/*,YOK! */\r\n\t\t\t/*,YOK! */\r\n\t\t\t,EFaturaNo\r\n\t\t\t,EFaturaAktarimTarih\r\n\t\t\t,EFaturaId\r\n\t\t\t,EFaturaTipId\r\n\t\t\t/*,YOK!  */\r\n\t\t\t/*,YOK!  */\r\n\t\t\t,EntegreAktarimTarih\r\n\t\t\t/*,<EntegreId, int,> */\r\n\t\t\t/*,EntegreTipId */\r\n\t\t\t/*,FaturaAd */\r\n\t\t\t/*,YOK! */\r\n\t\t\t,FaturaNo\r\n\t\t\t/*,YOK! */\r\n\t\t\t,FaturaSeri\r\n\t\t\t/*,YOK! */\r\n\t\t\t/*,YOK! */\r\n\t\t\t/*,YOK! */\r\n\t\t\t/*,YOK! */\r\n\t\t\t/*,YOK! */\r\n\t\t\t,FaturaAd\r\n\t\t\t/*,YOK! */\r\n\t\t\t/*,YOK! */\r\n\t\t\t/*,YOK! */\r\n\t\t\t/*,YOK! */\r\n\t\t\t,GenelIskontoTutar\r\n\t\t\t/*,YOK! */\r\n\t\t\t,ToplamNetTutar\r\n\t\t\t/*,<GenelTipId, int,> */\r\n\t\t\t,ToplamGenelTutar\r\n\t\t\t/*,YOK! */\r\n\t\t\t,GenelIskontoYuzde\r\n\t\t\t/*,YOK! */\r\n\t\t\t/*,YOK! */\r\n\t\t\t/*,YOK! */\r\n\t\t\t/*,YOK! */\r\n\t\t\t/*,<ToplamIskontoTutar, float,> */\r\n\t\t\t/*,<ToplamAraTutar, float,> */\r\n\t\t\t,GiderKdvToplam\r\n\t\t\t,GiderToplam\r\n\t\t\t,GenelMatrah\r\n\t\t\t/*,<HareketCariYaz, bit,> */\r\n\t\t\t/*,<HareketStokYaz, bit,> */\r\n\t\t\t/*,YOK! */\r\n\t\t\t/*,YOK! */\r\n\t\t\t/*,YOK! */\r\n\t\t\t,IslemKur\r\n\t\t\t/*,<IslemParaBirimId, int,> */\r\n\t\t\t/*,<IslemTipId, int,> */\r\n\t\t\t/*,YOK! */\r\n\t\t\t/*,YOK! */\r\n\t\t\t/*,YOK! */\r\n\t\t\t/*,YOK! */\r\n\t\t\t/*,<KapTipId, int,> */\r\n\t\t\t,KarsiKartId\r\n\t\t\t,KarsiKartTipId\r\n\t\t\t,KartKur\r\n\t\t\t/*,<KartParaBirimId, int,> */\r\n\t\t\t/*,<KayitDurum, bit,> */\r\n\t\t\t,KdvOran1\r\n\t\t\t,KdvOran2\r\n\t\t\t,KdvOran3\r\n\t\t\t,KdvOran4\r\n\t\t\t,KdvOran5\r\n\t\t\t/*,<KdvTipId, int,> */\r\n\t\t\t,ToplamKdvTutar\r\n\t\t\t,KdvTutar1\r\n\t\t\t,KdvTutar2\r\n\t\t\t,KdvTutar3\r\n\t\t\t,KdvTutar4\r\n\t\t\t,KdvTutar5\r\n\t\t\t,Kilit\r\n\t\t\t,Kur\r\n\t\t\t/*,YOK! */\r\n\t\t\t/*,YOK! */\r\n\t\t\t,MarketIskontoTutar\r\n\t\t\t,MarketIskontoYuzde\r\n\t\t\t,MarketMatrah\r\n\t\t\t,Odeme\r\n\t\t\t,OdemeToplam\r\n\t\t\t,OlusturmaTarihSaat\r\n\t\t\t/*,<OlusturmaKullaniciId, int,> */\r\n\t\t\t/*,<OlusturmaKullaniciTipId, int,> */\r\n\t\t\t,OtvToplam\r\n\t\t\t/*,<ParaBirimId, int,> */\r\n\t\t\t/*,YOK! */\r\n\t\t\t,Plaka\r\n\t\t\t/*,YOK! */\r\n\t\t\t/*,<RaporId, int,> */\r\n\t\t\t,RemoteId\r\n\t\t\t/*,YOK! */\r\n\t\t\t/*,YOK! */\r\n\t\t\t/*,<Sil, bit,> */\r\n\t\t\t/*,<SilKullaniciId, int,> */\r\n\t\t\t/*,<SilKullaniciTipId, int,> */\r\n\t\t\t/*,<SilTarihSaat, datetime,> */\r\n\t\t\t/*,YOK! */\r\n\t\t\t,TarihSaat\r\n\t\t\t,VadeTarih\r\n\t\t\t/*,YOK! */\r\n\t\t\t/*,<VardiyaId, int,> */\r\n\t\t\t/*,YOK! */\r\n\t\t\t/*,YOK! */\r\n\t\t\t/*,YOK! */\r\n\t\t\t,YazarKasaFisno\r\n\t\t\t,YuvarlamaTutar\r\n\t\t\t/*,<TransferStartId, int,> */\r\n\t\t\t/*,<TransferStopId, int,> */\r\n\t\t\t/*,<TransferTarihSaat, datetime,> */\r\n\t\t\t,VergiNumarasi\r\n\t\t\t,GenelTipId\r\n\t\t\t,IslemTipId\r\n\t\t)\r\n\t  SELECT  \r\n\t\t\r\n\t  \r\n\t\t\tins.id\r\n\t\t\t,ins.ack                                              AS Aciklama\r\n\t\t\t/*,ins.ak_isk_tip, tinyint,                             YOK! */\r\n\t\t\t,ins.ak_isk_top                                      AS AkaryakitIskontoTutar\r\n\t\t\t,ins.ak_isk_yuz                                      AS AkaryakitIskontoYuzde\r\n\t\t\t,ins.ak_matrah                                       AS AkaryakitMatrah\r\n\t\t\t/*,ins.AvansTakip, bit,                                 YOK! */\r\n\t\t\t,@BayiId\t\t\t\t\t\t\t\t\t\t     AS BayiId\r\n\t\t\t,ins.car_id                                          AS KartId\r\n\t\t\t/*,ins.carkod, varchar(20),                             YOK! */\r\n\t\t\t/*,ins.cartip, varchar(20),                             YOK! */\r\n\t\t\t,ins.cartip_id                                       AS KartTipId\r\n\t\t\t/*,!YOK\t\t\t\t\t\t\t\t\t\t\t\t AS <KarsiKartId, int,> */\r\n\t\t\t/*,!YOK\t\t\t\t\t\t\t\t\t\t\t\t AS <KarsiKartTipId, int,> */\r\n\t\t\t/*,!YOK\t\t\t\t\t\t\t\t\t\t\t\t AS <KartId, int,> */\r\n\t\t\t/*,ins.dataok, int,                                     YOK! */\r\n\t\t\t,ins.degtarsaat                                      AS DegistirmeTarihSaat\r\n\t\t\t/*,ins.deguser, varchar(50),    <Tip Uyumsuz>        AS <DegistirmeKullaniciId, int,> */\r\n\t\t\t/*,!YOK\t\t\t\t\t\t\t\t\t\t\t\t AS <DegistirmeKullaniciTipId, int,> */\r\n\t\t\t/*,ins.Dep_Dag, bit,                                    YOK! */\r\n\t\t\t/*,ins.depo, varchar(20),                               YOK! */\r\n\t\t\t/*,ins.EFatura, bit,                                    YOK! */\r\n\t\t\t,CASE ins.EFatura    \r\n\t\t\t\tWHEN 1 THEN ins.fatno   \r\n\t\t\t\tWHEN 0 THEN NULL                                \r\n\t\t\t END\t\t\t\t\t\t\t\t\t\t\t\t AS EFaturaNo\r\n\t\t\t,ins.Efatura_Aktar                                   AS EFaturaAktarimTarih\r\n\t\t\t,ins.EFatura_Id                                      AS EFaturaId\r\n\t\t\t,ins.EFatura_Tip                                     AS EFaturaTipId\r\n\t\t\t/*,ins.EFaturaEFinansBelgeOId, varchar(100),\t\t\tYOK! */\r\n\t\t\t/*,ins.Entegre, bit,                                    YOK! */\r\n\t\t\t,ins.entegre_aktar                                   AS EntegreAktarimTarih\r\n\t\t\t/*,!YOK\t\t\t\t\t\t\t\t\t\t\t\t AS <EntegreId, int,> */\r\n\t\t\t/*,ins.entegre_tip, varchar(10), <Tip Uyumsuz>       AS EntegreTipId, int */\r\n\t\t\t/*,ins.fatad, nvarchar(50),      <Tip Uyumsuz>       AS FaturaAd, varchar(100) */\r\n\t\t\t/*,ins.fatid, float,                                    YOK! */\r\n\t\t\t,ins.fatno                                           AS FaturaNo\r\n\t\t\t/*,ins.fatrap_id, int,                                  YOK! */\r\n\t\t\t,ins.fatseri                                         AS FaturaSeri\r\n\t\t\t/*,ins.fattip, varchar(20),                             YOK! */\r\n\t\t\t/*,ins.fattip_id, int,                                  YOK! */\r\n\t\t\t/*,ins.fattop, float,          <Satır Toplamı>          YOK! */\r\n\t\t\t/*,ins.fattur, varchar(10),    <Veri Boş>               YOK! */\r\n\t\t\t/*,ins.fattur_id, int,         <Veri Boş>               YOK! */\r\n\t\t\t,ins.fatturad                                        AS FaturaAd\r\n\t\t\t/*,ins.firmano, int,                                    YOK! */\r\n\t\t\t/*,ins.gctip, int,             <1 Geliyor>              YOK! */\r\n\t\t\t/*,ins.gen_ind_tip, tinyint,                            YOK! */\r\n\t\t\t/*,ins.genel_ara_top, float,                            YOK! */\r\n\t\t\t,ins.genel_isk_top                                   AS GenelIskontoTutar\r\n\t\t\t/*,ins.genel_kdv_top, float,                            YOK! */\r\n\t\t\t,ins.genel_net_top                                   AS ToplamNetTutar\r\n\t\t\t/*,!YOK\t\t\t\t\t\t\t\t\t\t\t\t AS <GenelTipId, int,> */\r\n\t\t\t,ins.genel_top                                       AS ToplamGenelTutar\r\n\t\t\t/*,ins.genisktop, float,                                YOK! */\r\n\t\t\t,ins.geniskyuz                                       AS GenelIskontoYuzde\r\n\t\t\t/*,ins.gg_isk_tip                                       YOK! */\r\n\t\t\t/*,ins.gg_isk_top, float,                               YOK! */\r\n\t\t\t/*,ins.gg_isk_yuz, float,                               YOK! */\r\n\t\t\t/*,ins.gg_matrah, float,                                YOK! */\r\n\t\t\t/*,!YOK\t\t\t\t\t\t\t\t\t\t\t\t AS <ToplamIskontoTutar, float,> */\r\n\t\t\t/*,!YOK\t\t\t\t\t\t\t\t\t\t\t\t AS <ToplamAraTutar, float,> */\r\n\t\t\t,ins.giderkdvtop                                     AS GiderKdvToplam\r\n\t\t\t,ins.gidertop                                        AS GiderToplam\r\n\t\t\t,ins.gn_matrah                                       AS GenelMatrah\r\n\t\t\t/*,!YOK\t\t\t\t\t\t\t\t\t\t\t\t AS <HareketCariYaz, bit,> */\r\n\t\t\t/*,!YOK\t\t\t\t\t\t\t\t\t\t\t\t AS <HareketStokYaz, bit,> */\r\n\t\t\t/*,ins.hrk_car_pro, bit,                                YOK! */\r\n\t\t\t/*,ins.Hrk_Karsi_Pro, bit,                              YOK! */\r\n\t\t\t/*,ins.hrk_stk_pro, bit,                                YOK! */\r\n\t\t\t,ins.Islem_Kur                                       AS IslemKur\r\n\t\t\t/*,ins.Islem_ParaBrm, varchar(20),   <Tip Uyumsuz>   AS <IslemParaBirimId, int,> */\r\n\t\t\t/*,!YOK\t\t\t\t\t\t\t\t\t\t\t\t AS <IslemTipId, int,> */\r\n\t\t\t/*,ins.irs_no, varchar(100),                            YOK! */\r\n\t\t\t/*,ins.irsaliyeirid, float,                             YOK! */\r\n\t\t\t/*,ins.isk_tip, tinyint,                                YOK! */\r\n\t\t\t/*,ins.kapidler, varchar(8000),                         YOK! */\r\n\t\t\t/*,ins.kaptip, varchar(5),           <Tip Uyumsuz>   AS <KapTipId, int,> */\r\n\t\t\t,ins.Karsi_Car_id                                    AS KarsiKartId\r\n\t\t\t,ins.Karsi_Cartip_id                                 AS KarsiKartTipId\r\n\t\t\t,ins.Kart_Kur                                        AS KartKur\r\n\t\t\t/*,ins.Kart_ParaBrm, varchar(20),    <Tip Uyumsuz>   AS <KartParaBirimId, int,> */\r\n\t\t\t/*,ins.kayok, int,                   <Tip Uyumsuz>   AS <KayitDurum, bit,> */\r\n\t\t\t,ins.KdvOran1                                        AS KdvOran1\r\n\t\t\t,ins.KdvOran2                                        AS KdvOran2\r\n\t\t\t,ins.KdvOran3                                        AS KdvOran3\r\n\t\t\t,ins.KdvOran4                                        AS KdvOran4\r\n\t\t\t,ins.KdvOran5                                        AS KdvOran5\r\n\t\t\t/*,ins.kdvtip, varchar(10),          <Tip Uyumsuz>   AS <KdvTipId, int,> */\r\n\t\t\t,ins.kdvtop                                          AS ToplamKdvTutar\r\n\t\t\t,ins.KdvTutar1                                       AS KdvTutar1\r\n\t\t\t,ins.KdvTutar2                                       AS KdvTutar2\r\n\t\t\t,ins.KdvTutar3                                       AS KdvTutar3\r\n\t\t\t,ins.KdvTutar4                                       AS KdvTutar4\r\n\t\t\t,ins.KdvTutar5                                       AS KdvTutar5\r\n\t\t\t,ins.kilit                                           AS Kilit\r\n\t\t\t,ins.kur                                             AS Kur\r\n\t\t\t/*,ins.marsatid, float,                                 YOK! */\r\n\t\t\t/*,ins.mr_isk_tip, tinyint,                             YOK! */\r\n\t\t\t,ins.mr_isk_top                                      AS MarketIskontoTutar\r\n\t\t\t,ins.mr_isk_yuz                                      AS MarketIskontoYuzde\r\n\t\t\t,ins.mr_matrah                                       AS MarketMatrah\r\n\t\t\t,ins.Odeme                                           AS Odeme\r\n\t\t\t,ins.odemetop                                        AS OdemeToplam\r\n\t\t\t,ins.olustarsaat                                     AS OlusturmaTarihSaat\r\n\t\t\t/*,ins.olususer, varchar(50),       <Tip Uyumsuz>    AS <OlusturmaKullaniciId, int,> */\r\n\t\t\t/*,!YOK\t\t\t\t\t\t\t\t\t\t\t\t AS <OlusturmaKullaniciTipId, int,> */\r\n\t\t\t,ins.otvtop                                          AS OtvToplam\r\n\t\t\t/*,ins.parabrm, varchar(10),        <Tip Uyumsuz>    AS <ParaBirimId, int,> */\r\n\t\t\t/*,ins.Per_id, int,                                     YOK! */\r\n\t\t\t,ins.plaka                                           AS Plaka\r\n\t\t\t/*,ins.prom_pro, bit,                                   YOK! */\r\n\t\t\t/*,!YOK\t\t\t\t\t\t\t\t\t\t\t\t AS <RaporId, int,> */\r\n\t\t\t,ins.remote_id\t\t\t\t\t\t\t\t\t\t\t\t AS RemoteId\r\n\t\t\t/*,ins.saat, varchar(8),                                YOK! */\r\n\t\t\t/*,ins.satisktop, float,                                YOK! */\r\n\t\t\t/*,ins.sil, int,                    <Tip Uyumsuz>    AS <Sil, bit,> */\r\n\t\t\t/*,!YOK\t\t\t\t\t\t\t\t\t\t\t\t AS <SilKullaniciId, int,> */\r\n\t\t\t/*,!YOK\t\t\t\t\t\t\t\t\t\t\t\t AS <SilKullaniciTipId, int,> */\r\n\t\t\t/*,!YOK\t\t\t\t\t\t\t\t\t\t\t\t AS <SilTarihSaat, datetime,> */\r\n\t\t\t/*,ins.siparissipid, float,                             YOK! */\r\n\t\t\t,ins.tarih                                           AS TarihSaat\r\n\t\t\t,ins.vadtar                                          AS VadeTarih\r\n\t\t\t/*,ins.Varno, float,                                    YOK! */\r\n\t\t\t/*,!YOK\t\t\t\t\t\t\t\t\t\t\t\t AS <VardiyaId, int,> */\r\n\t\t\t/*,ins.yazildi, bit,                                    YOK! */\r\n\t\t\t/*,ins.yerad, varchar(30),                              YOK! */\r\n\t\t\t/*,ins.yertip, varchar(20),                             YOK! */\r\n\t\t\t,ins.ykfisno                                         AS YazarKasaFisno\r\n\t\t\t,ins.yuvtop                                          AS YuvarlamaTutar\r\n\t\t\t/*,!YOK\t\t\t\t\t\t\t\t\t\t\t\t AS <TransferStartId, int,> */\r\n\t\t\t/*,!YOK\t\t\t\t\t\t\t\t\t\t\t\t AS <TransferStopId, int,> */\r\n\t\t\t/*,!YOK\t\t\t\t\t\t\t\t\t\t\t\t AS <TransferTarihSaat, datetime,> */\r\n\t\t\t,c.vergino,\r\n\t\t\t(Case when ins.fattip='FATMRALS' then 11 \r\n\t\t\twhen ins.fattip='FATIADALS' then 13 end)  as GenelTipId,\r\n\t\t\t(Case when ins.fattip='FATMRALS' then 2 \r\n\t\t\twhen ins.fattip='FATIADALS' then 7 end) as IslemTipId\r\n\r\n\t\tFROM Faturamas  AS ins with (nolock)\r\n        join Genel_Cari_Kart c with (nolock)\r\n        on c.kod = ins.carkod and c.cartip=ins.cartip\r\n        where ins.id=@FaturaId and  ins.kayok=1\r\n        and ins.id not in ( Select Id From Log_Fatura Wtih (nolock) )\r\n        \r\n        \r\n      \r\n          /*delete  Silme update */\r\n         update Log_Fatura Set Sil=1,TransferStartId=TransferStartId+1,\r\n         SyncStatus=1 from Log_Fatura as ins  \r\n         where ins.Id=@FaturaId and ins.Id not in (Select id From faturamas with (nolock)\r\n         Where id=@FaturaId)  \r\n      \r\n        \r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "SpLog_FaturaHareket",
    "definition": "CREATE PROCEDURE dbo.SpLog_FaturaHareket(@FaturaId int)\r\nAS\r\n BEGIN\r\n\r\nSET NOCOUNT ON\r\n\r\n\r\n\r\n    if not EXISTS (SELECT [id] FROM [petromas_db]..[isletme] \r\n      where dataname=DB_NAME() and isnull(AktarimYapilacak,0)=1 )\r\n      RETURN\r\n\r\n     IF NOT EXISTS (SELECT * FROM [petromas_db].dbo.sysobjects WHERE name = N'BayiInfo' AND xtype='U' ) \r\n      RETURN\r\n\r\n\r\n\tDECLARE @BayiId INT\r\n\tSET @BayiId = (SELECT TOP 1 [BayiId] FROM [petromas_db]..[BayiInfo] ORDER BY BayiId DESC)\r\n\r\n\r\n\t if @BayiId is null\r\n\t RETURN\r\n\t\r\n\t\r\n\r\n     /*update islemi Silme */\r\n     update Log_FaturaHareket Set Sil=dt.Sil,TransferStartId=TransferStartId+1,\r\n     SyncStatus=1\r\n     from  Log_FaturaHareket as t join \r\n     (Select ins.id,ins.Sil FROM faturahrk AS ins with (nolock) \r\n      inner join stokkart sk with (nolock) on sk.kod = ins.stkod \r\n      and sk.tip = ins.stktip  where ins.fatid=@FaturaId \r\n     and ins.id in (Select Id From Log_FaturaHareket where FaturaId=@FaturaId )) dt on dt.id=t.Id\r\n\r\n\r\n\r\n\tINSERT INTO Log_FaturaHareket\r\n\t\t(\r\n\t\t\t  Id\r\n\t\t\t  ,Aciklama\r\n\t\t\t  ,Barkod\r\n\t\t\t/*,[BirimId] [int] NULL, */\r\n\t\t\t  ,BayiId\r\n\t\t\t  ,BirimFiyat\r\n\t\t\t  ,Carpan\r\n\t\t\t  ,DegistirmeTarihSaat\r\n\t\t\t/*,[DegistirmeKullaniciId] [int] NULL, */\r\n\t\t\t/*,[DepoId] [int] NULL, */\r\n\t\t\t/*,[DepoTipId] [int] NULL, */\r\n\t\t\t  ,FaturaId\r\n\t\t\t  ,IslemKur\r\n\t\t\t/*,[IslemParaBirimId] [int] NULL, */\r\n\t\t\t  ,KartKur\r\n\t\t\t/*,[KartParaBirimId] [int] NULL, */\r\n\t\t\t/*,[KdvTipId] [int] NULL, */\r\n\t\t\t  ,KdvTutar\r\n\t\t\t  ,KdvYuzde\r\n\t\t\t  ,Kesafet\r\n\t\t\t  ,Kur\r\n\t\t\t  ,Miktar\r\n\t\t\t  ,OlusturmaTarihSaat\r\n\t\t\t/*,[OlusturmaKullaniciId] [int] NULL, */\r\n\t\t\t  ,OtvCarpan\r\n\t\t\t  ,OtvTutar\r\n\t\t\t  ,OtvYuzde\r\n\t\t\t/*,[ParaBirimId] [int] NULL, */\r\n\t\t\t  ,RemoteId\r\n\t\t\t  ,SatirIskontoTutar\r\n\t\t\t  ,SatirIskontoYuzde\r\n\t\t\t/*,[Sil] [bit] NULL, */\r\n\t\t\t  ,ToplamIskontoTutar\r\n\t\t\t  ,ToplamIskontoYuzde\r\n\t\t\t  ,ToplamKdvTutar\r\n\t\t\t  ,ToplamTutarIskontoluKdvli\r\n\t\t\t  ,ToplamTutarIskontoluKdvsiz\r\n\t\t\t  ,KartId\r\n\t\t\t  ,KartTipId\r\n\t\t)\r\n\t  SELECT \r\n\t\t\t\tins.id\r\n\t\t\t  ,ins.[ack]                                                          AS Aciklama\r\n\t\t\t/*,ins.[ak_isk_tut]                                                   AS  */\r\n\t\t\t/*,ins.[ak_isk_yuz]                                                   AS  */\r\n\t\t\t  ,ins.[barkod]                                                       AS Barkod\r\n\t\t\t  ,@BayiId\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t  AS BayiId\r\n\t\t\t/*,ins.[brim]                      <Tip Uyumsuz>                      AS [BirimId] [int] NULL, */\r\n\t\t\t  ,ins.[brmfiy]                                                       AS BirimFiyat\r\n\t\t\t  ,ins.[carpan]                                                       AS Carpan\r\n\t\t\t/*,ins.[dataok]                                                       AS  */\r\n\t\t\t  ,ins.[degtarsaat]                                                   AS DegistirmeTarihSaat\r\n\t\t\t/*,ins.[deguser]                   <Tip Uyumsuz>                      AS [DegistirmeKullaniciId] [int] NULL, */\r\n\t\t\t/*,ins.[dep_id]                    <Tip Uyumsuz>                      AS [DepoId] [int] NULL, */\r\n\t\t\t/*,ins.[depkod]                    <Tip Uyumsuz>                      AS [DepoTipId] [int] NULL, */\r\n\t\t\t  ,ins.[fatid]                                                        AS FaturaId\r\n\t\t\t/*,ins.[firmano]                                                      AS  */\r\n\t\t\t/*,ins.[genisktut]                                                    AS  */\r\n\t\t\t/*,ins.[geniskyuz]                                                    AS  */\r\n\t\t\t/*,ins.[gg_isk_tut]                                                   AS  */\r\n\t\t\t/*,ins.[gg_isk_yuz]                                                   AS  */\r\n\t\t\t/*,ins.[giderbrmtut]                                                  AS  */\r\n\t\t\t/*,ins.[grupid]                                                       AS  */\r\n\t\t\t/*,ins.[hrk_stk_pro]                                                  AS  */\r\n\t\t\t  ,ins.[Islem_Kur]                                                    AS IslemKur\r\n\t\t\t/*,ins.[Islem_ParaBrm]             <Tip Uyumsuz>                      AS [IslemParaBirimId] [int] NULL, */\r\n\t\t\t/*,ins.[kaphrkid]                                                     AS  */\r\n\t\t\t/*,ins.[kaptip]                                                       AS  */\r\n\t\t\t  ,ins.[Kart_Kur]                                                     AS KartKur\r\n\t\t\t/*,ins.[Kart_ParaBrm]              <Tip Uyumsuz>                      AS [KartParaBirimId] [int] NULL, */\r\n\t\t\t/*,ins.[kayok]                                                        AS  */\r\n\t\t\t/*,ins.[kdvtip]                    <Tip Uyumsuz>                      AS [KdvTipId] [int] NULL, */\r\n\t\t\t  ,ins.[kdvtut]                                                       AS KdvTutar\r\n\t\t\t  ,ins.[kdvyuz]*100                                                   AS KdvYuzde\r\n\t\t\t  ,ins.[kesafet]                                                      AS Kesafet\r\n\t\t\t  ,ins.[kur]                                                          AS Kur\r\n\t\t\t/*,ins.[masraf_tut]                                                   AS  */\r\n\t\t\t/*,ins.[masraf_yuz]                                                   AS  */\r\n\t\t\t  ,ins.[mik]                                                          AS Miktar\r\n\t\t\t/*,ins.[mr_isk_tut]                                                   AS  */\r\n\t\t\t/*,ins.[mr_isk_yuz]                                                   AS  */\r\n\t\t\t/*,ins.[Net_Miktar]                                                   AS  */\r\n\t\t\t  ,ins.[olustarsaat]                                                  AS OlusturmaTarihSaat\r\n\t\t\t/*,ins.[olususer]                   <Tip Uyumsuz>                     AS [OlusturmaKullaniciId] [int] NULL, */\r\n\t\t\t/*,ins.[OtoTag]                                                       AS  */\r\n\t\t\t  ,ins.[Otv_Carpan]                                                   AS OtvCarpan\r\n\t\t\t/*,ins.[otvbrim]                                                      AS  */\r\n\t\t\t  ,ins.[otvtut]                                                       AS OtvTutar\r\n\t\t\t  ,ins.[otvyuz]                                                       AS OtvYuzde\r\n\t\t\t/*,ins.[parabrim]                   <Tip Uyumsuz>                     AS [ParaBirimId] [int] NULL, */\r\n\t\t\t  ,ins.remote_id\t\t\t                                                  AS RemoteId\r\n\t\t\t  ,ins.[satisktut]                                                    AS SatirIskontoTutar\r\n\t\t\t  ,ins.[satiskyuz]                                                    AS SatirIskontoYuzde\r\n\t\t\t/*,ins.[sil]                        <Tip Uyumsuz>                     AS [Sil] [bit] NULL, */\r\n\t\t\t\r\n\t\t\t/*,ins.[stkod]                                                        AS  */\r\n\t\t\t/*,ins.[stktip]                                                       AS  */\r\n\t\t\t/*,ins.[stktip_id]                                                    AS  */\r\n\t\t\t/*,ins.[Tesis_AlisFiyat]                                              AS  */\r\n\t\t\t/*,ins.[Tesis_Fiyat]                                                  AS  */\r\n\t\t\t/*,ins.[Tesis_id]                                                     AS  */\r\n\t\t\t/*,ins.[Tesis_PrimOran]                                               AS  */\r\n\t\t\t  ,ins.[top_isk_tut]                                                  AS ToplamIskontoTutar\r\n\t\t\t  ,ins.[top_isk_yuz]                                                  AS ToplamIskontoYuzde\r\n\t\t\t  ,ins.[top_kdv_tut]                                                  AS ToplamKdvTutar\r\n\t\t\t  ,ins.[top_tut_isk_kdvli]                                            AS ToplamTutarIskontoluKdvli\r\n\t\t\t  ,ins.[top_tut_isk_kdvsiz]                                           AS ToplamTutarIskontoluKdvsiz\r\n\t\t\t/*,ins.[top_tut_kdvsiz]                                               AS  */\r\n\t\t\t/*,ins.[ustbrim]                                                      AS  */\r\n\t\t\t/*,!YOK                                                               AS [DegistirmeKullaniciTipId] [int] NUL */\r\n\t\t\t/*,!YOK                                                               AS [KartId] [int] NULL, */\r\n\t\t\t/*,!YOK                                                               AS [KartTipId] [int] NULL, */\r\n\t\t\t/*,!YOK                                                               AS [SilKullaniciId] [int] NULL, */\r\n\t\t\t/*,!YOK                                                               AS [SilKullaniciTipId] [int] NULL, */\r\n\t\t\t/*,!YOK                                                               AS [SilTarihSaat] [datetime] NULL, */\r\n\t\t\t/*,!YOK                                                               AS [TransferStartId] [int] NULL, */\r\n\t\t\t/*,!YOK                                                               AS [TransferStopId] [int] NULL, */\r\n\t\t\t/*,!YOK                                                               AS [TransferTarihSaat] [datetime] NULL, */\r\n\t\t\t,sk.remote_id                                                         AS OpetUrunKartId\r\n\t\t\t,10\r\n\t\t FROM faturahrk AS ins with (nolock) \r\n         inner join stokkart sk with (nolock) \r\n         on sk.kod = ins.stkod and sk.tip = ins.stktip  \r\n         where ins.fatid=@FaturaId \r\n         and ins.id not in (Select Id From Log_FaturaHareket with (nolock) \r\n         Where FaturaId=@FaturaId )\r\n         \r\n\r\n     \r\n        /*delete  Silme update */\r\n         update Log_FaturaHareket Set Sil=1,TransferStartId=TransferStartId+1,\r\n         SyncStatus=1 from Log_FaturaHareket as ins  \r\n         where ins.FaturaId=@FaturaId and ins.Id not in (Select id From faturahrk with (nolock)\r\n         Where Fatid=@FaturaId)  \r\n\r\n\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "SpLog_FaturaUrunHareket",
    "definition": "CREATE PROCEDURE dbo.SpLog_FaturaUrunHareket( \r\n@FaturaId int)\r\nAS\r\nBEGIN\r\n\r\n   \r\n    SET NOCOUNT ON\r\n   \r\n\r\n    if not EXISTS (SELECT [id] FROM [petromas_db]..[isletme] \r\n      where dataname=DB_NAME() and isnull(AktarimYapilacak,0)=1 )\r\n      RETURN\r\n\r\n\r\n   IF NOT EXISTS (SELECT * FROM [petromas_db].dbo.sysobjects WHERE name = N'BayiInfo' AND xtype='U' ) \r\n      RETURN\r\n   \r\n   \r\n    DECLARE @BayiId INT\r\n\tSET @BayiId = (SELECT TOP 1 [BayiId] FROM [petromas_db]..[BayiInfo] ORDER BY BayiId DESC)\r\n   \r\n  \r\n   \r\n     if @BayiId is null\r\n\t RETURN\r\n   \r\n   \r\n    /*update islemi Silme */\r\n     update Log_UrunHareket Set Sil=dt.Sil,TransferStartId=TransferStartId+1,\r\n     Giren=dt.Giren,Cikan=dt.Cikan,\r\n     BirimFiyatNetKdvli=dt.brmfiykdvli,\r\n     KdvYuzde=dt.KdvYuzde,\r\n     SyncStatus=1\r\n     from  Log_UrunHareket as t join \r\n     (Select ins.id,ins.Sil,ins.Giren,İns.Cikan,\r\n     ins.brmfiykdvli,ins.kdvyuz*100 AS KdvYuzde \r\n     FROM stkhrk AS ins with (nolock) \r\n     inner join stokkart sk with (nolock) on \r\n     sk.kod = ins.Stkod and sk.tip = ins.stktip and ins.fatid=@FaturaId \r\n     /*and ins.sil=1 */\r\n     and ins.id in (Select Id From Log_UrunHareket with (nolock)  \r\n     where FaturaId=@FaturaId )) dt on dt.id=t.Id\r\n  \r\n   \r\n   /*Insert İslemi */\r\n    INSERT INTO [dbo].[Log_UrunHareket]\r\n\t\t\t   ([Id]\r\n\t\t\t   ,[KartTipId]\r\n\t\t\t   ,[StokKodu]\r\n\t\t\t   ,[BayiId]\r\n\t\t\t   ,[MarketVardiyaId]\r\n\t\t\t   ,[Sil]\r\n\t\t\t   ,[IslemTipId]\r\n\t\t\t   ,[TarihSaat]\r\n\t\t\t   ,[Giren]\r\n\t\t\t   ,[Cikan]\r\n\t\t\t   ,[BirimFiyatNetKdvli]\r\n\t\t\t   ,[KdvYuzde]\r\n\t\t\t   ,[Otv]\r\n\t\t\t   ,[BelgeNo]\r\n\t\t\t   ,[Aciklama]\r\n\t\t\t   ,[OlusturmaKullaniciId]\r\n\t\t\t   ,[OlusturmaTarihSaat]\r\n\t\t\t   ,[DegistirmeKullaniciId]\r\n\t\t\t   ,[DegistirmeTarihSaat]\r\n\t\t\t   ,[FaturaId]\r\n               ,[FaturaHareketId]\r\n\t\t\t   ,[IrsaliyeId]\r\n\t\t\t   ,[SayimId]\r\n\t\t\t   ,[KartId]\r\n\t\t\t   ,[RemoteId]\r\n\t\t\t   ,[DepoTransferId]\r\n\t\t\t   ,[DepoId]\r\n\t\t\t   ,[MarketSatisId]\r\n\t\t\t   ,[MarketSatisHareketId]\r\n\t\t\t   )\r\n        SELECT\r\n\t\t ins.id   AS Id\r\n\t\t,CASE ins.stktip \r\n\t\t\tWHEN 'markt' THEN 10\r\n\t\t\tELSE NULL\r\n\t\t\t\t/* markt değerinin [OpetBackOffice].[dbo].[KartTip] tarafında 10 */\r\n\t\t\t\t/* değerine denk geliyor */\r\n\t\t\t\t/* !! Tüm alabileceği değerler için WHEN koşulunu doldurmalı !! */\r\n\t\t\t\t/* > SELECT * FROM [OpetBackOffice].[dbo].[KartTip]\t\t\t\t\t\t\t */\r\n\r\n\t  \t\t\t\t\t\t\t\t  \r\n\t\tEND\tAS KartTipId\r\n\t\t,ins.stkod  AS StokKodu\r\n\t\t,@BayiId\t AS BayiId\r\n\t\t,ins.varno   AS MarketVardiyaId\r\n\t\t,ins.sil  AS Sil\r\n\t\t,CASE ins.islmtip \r\n\t\t\tWHEN 'MARSAT' THEN 9 \r\n\t\t\tWHEN 'MARIAD' THEN 10\r\n\t\t\tWHEN 'FATMRALS' THEN 2\r\n\t\t\t/* Diğer tüm durumlar için tekrar gözden geçirilmeli */\r\n\t\t END AS IslemTipId\r\n\t\t,CONVERT(DATETIME, CONVERT(CHAR(8), ins.tarih, 112)+' '+CONVERT(CHAR(8), ins.saat)) AS TarihSaat\r\n\t\t,ins.giren  AS Giren\r\n\t\t,ins.cikan  AS Cikan\r\n\t\t,ins.brmfiykdvli  AS BirimFiyatNetKdvli\r\n\t\t,ins.kdvyuz*100 AS KdvYuzde\r\n\t\t,ins.otv    AS Otv\r\n\t\t,ins.belno   AS BelgeNo\r\n\t\t,ins.ack   AS Aciklama\r\n\t\t,(SELECT TOP 1 ins.id FROM users WHERE ad like ins.olususer)  AS OlusturmaKullaniciId\r\n\t\t,ins.olustarsaat  AS OlusturmaTarihSaat\r\n\t\t,(SELECT TOP 1 ins.id FROM users WHERE ad like ins.deguser)  AS DegistirmeKullaniciId\r\n\t\t,ins.degtarsaat   AS DegistirmeTarihSaat\r\n\t\t,ins.fatid    AS FaturaId\r\n        ,ins.stkhrkid  AS FaturaHareketId\r\n\t\t,ins.irid    AS IrsaliyeId\r\n\t\t,ins.sayid AS SayimId\r\n\t\t,sk.Remote_id AS OpetUrunId\r\n\t\t,ins.remote_id  AS RemoteId\r\n\t\t,ins.DepTrsId    AS DepoTransferId\r\n\t\t,ins.DepoId  AS DepoId\r\n\t\t,ins.marsatid\r\n\t\t,0 hrkid\r\n\t\tFROM stkhrk AS ins with (nolock) \r\n        inner join stokkart sk with (nolock) on \r\n        sk.kod = ins.Stkod and sk.tip = ins.stktip \r\n        and ins.fatid=@FaturaId /*and ins.sil=0 */\r\n        and ins.id Not in (Select Id From Log_UrunHareket with (nolock) \r\n        where FaturaId=@FaturaId )\r\n        \r\n\r\n        \r\n        \r\n        \r\n        \r\n        \r\n        \r\nEND"
  },
  {
    "schema": "dbo",
    "name": "SpLog_MarketSatis",
    "definition": "CREATE PROCEDURE dbo.[SpLog_MarketSatis](@MarketSatisId int)\r\nAS\r\nBEGIN\r\n  /* Declare @KayOk Int */\r\n  /* Declare @Id Int */\r\n   \r\n   /*--Sadece Insert islemleri icin  */\r\n   /* Select @Id=id,@KayOk=KayOk From Inserted */\r\n    \r\n   /* if EXISTS (Select Id From Log_Fatura With (Nolock) Where Id=@Id) */\r\n   /*    RETURN */\r\n \r\n   /* if @KayOk=0  */\r\n    /*  RETURN */\r\n\t\r\n\t\r\n\tSET NOCOUNT ON\r\n\r\n    if not EXISTS (SELECT [id] FROM [petromas_db]..[isletme] \r\n      where dataname=DB_NAME() and isnull(AktarimYapilacak,0)=1 )\r\n      RETURN\r\n\r\n\r\n     IF NOT EXISTS (SELECT * FROM [petromas_db].dbo.sysobjects WHERE name = N'BayiInfo' AND xtype='U' ) \r\n      RETURN\r\n\t\r\n\r\n\tDECLARE @BayiId INT\r\n\tSET @BayiId = (SELECT TOP 1 [BayiId] FROM [petromas_db]..[BayiInfo] ORDER BY BayiId DESC)\r\n  \r\n  \r\n     if @BayiId is null\r\n\t RETURN\r\n  \r\n  \r\n     /*update islemi Silme */\r\n     update Log_MarketSatis Set Sil=dt.Sil,TransferStartId=TransferStartId+1,\r\n     SyncStatus=1 from  Log_MarketSatis as t join \r\n     (Select ins.id,ins.Sil FROM marsatmas AS ins where \r\n     ins.marsatid=@MarketSatisId /*and ins.sil=1 */\r\n     and ins.id in (Select Id From Log_MarketSatis \r\n     Where Id=@MarketSatisId)) dt on dt.id=t.Id\r\n  \r\n  \r\n \r\n\t    INSERT INTO [dbo].[Log_MarketSatis]\r\n\t\t(\r\n\t\t\tId,\r\n\t\t\tBayiId\r\n\t\t\t,MarketVardiyaId\r\n\t\t\t,TarihSaat\r\n\t\t\t,IslemTipId\r\n\t\t\t/* YOK! ,OlusturmaKullaniciTipId */\r\n\t\t\t,OlusturmaKullaniciId\r\n\t\t\t,OlusturmaTarihSaat\r\n\t\t\t/* YOK! ,DegistirmeKullaniciTipId */\r\n\t\t\t,DegistirmeKullaniciId\r\n\t\t\t,DegistirmeTarihSaat\r\n\t\t\t,Sil\r\n\t\t\t,NakitTutar\r\n\t\t\t,PosTutar\r\n\t\t\t,VeresiyeTutar\r\n\t\t\t,IadeTutar\r\n\t\t\t,IndirimTutar\r\n\t\t\t,YuvarlamaTutar\r\n\t\t\t,SatisTutar\r\n\t\t\t,GiderTutar\r\n\t\t\t,RemoteId\r\n\t\t\t,YazarKasaNo\r\n\t\t\t,VeresiyeId\r\n\t\t\t,FaturaId\r\n\t\t\t,TransferStartId\r\n\t\t\t,TransferStopId\t\r\n\t\t\t,TransferTarihSaat\r\n\t\t)\r\n\t\tSELECT\r\n\t\tid \t\t\t\t\t\tAS ID\r\n\t\t/*,marsatid\t\t\t\t */\r\n\t\t,@BayiId\t\t\t\tAS BayiId\r\n\t\t,varno\t\t\t\t\tAS MarketVardiyaId\r\n\t\t/*,varok */\r\n\t\t/*,kayok */\r\n\t\t/*,tarih */\r\n\t\t,CONVERT(DATETIME, CONVERT(CHAR(8), tarih, 112)+' '+CONVERT(CHAR(8), saat)) AS TarihSaat\r\n\t\t/*,saat */\r\n\t\t,CASE islmtip\r\n\t\t\tWHEN 'satis' THEN 9\r\n\t\t\tWHEN 'iade' THEN 10 \r\n\t\tEND \t\t\t\t\tAS IslemTipId\r\n\t\t/*,islmtipad\t\t */\r\n\t\t/*,yertip\t\t */\r\n\t\t/*,yerad\t */\r\n\t\t/* DİKKAT\r\n\t\t* users tablosundaki ad alanına <TOP 1 id FROM users WHERE ad=@olususer> sorgusuyla kullanıcı id bilgisini alacağım \r\n\t\t* Eğer aynı adla iki kullanıcı olur bulunamazsa id bilgisi boş dönecek oysa sisteme giriş yapmış bir kullanıcı bu işlemi \r\n\t\t* yapıyor!\r\n\t\t*/\r\n\t\t,(SELECT TOP 1 id FROM users WHERE ad=ins.olususer)\t\tAS OlusturmaKullaniciId\r\n\t\t,[olustarsaat]\t\t\t\t\t\t\t\t\t\t\t\t\tAS OlusturmaTarihSaat\r\n\t\t/* YOK! ,[DegistirmeKullaniciTipId] */\r\n\t\t/* DİKKAT\r\n\t\t* OlusturmaKullaniciId ile aynı sorun!!!!\r\n\t\t*/\r\n\t\t,(SELECT TOP 1 id FROM users WHERE ad like ins.deguser)\tAS DegistirmeKullaniciId\r\n\t\t,degtarsaat\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS DegistirmeTarihSaat\r\n\t\t,sil\t\t\t\t\tAS Sil\r\n\t\t/*,dataok\t\t */\r\n\t\t,naktop\t\t\t\t\tAS NakitTutar\r\n\t\t,postop\t\t\t\t\tAS PosTutar\r\n\t\t,veresitop\t\t\t\tAS VeresiyeTutar\r\n\t\t,iadetop\t\t\t\tAS IadeTutar\r\n\t\t,indtop\t\t\t\t\tAS IndirimTutar\r\n\t\t,yuvtop\t\t\t\t\tAS YuvarlamaTutar\r\n\t\t/*,parabrm\t\t */\r\n\t\t/*,kur\t\t */\r\n\t\t,satistop\t\t\t\tAS SatisTutar\r\n\t\t,gidertop\t\t\t\tAS GiderTutar\r\n\t\t/*,cartip\t\t */\r\n\t\t/*,carkod\t\t */\r\n\t\t/*,islmhrk\t\t */\r\n\t\t/*,islmhrkad\t\t */\r\n\t\t/*,cartip_id\t\t */\r\n\t\t/*,car_id\t\t */\r\n\t\t,remote_id\t\t\t\tAS RemoteId\r\n\t\t,YazarKasa_id\t\t\tAS YazarKasaNo\r\n\t\t,Verid\t\t\t\t\tAS VeresiyeId\r\n\t\t,Fatid\t\t\t\t\tAS FaturaId\r\n\t\t/*,Fis_No\t\t */\r\n\t\t/*,[Transfer]\t\t */\r\n\t\t/*,Transfer_TarSaat\t\t */\r\n\t\t,TransferStartId\t\tAS TransferStartId\r\n\t\t,TransferStopId\t\t\tAS TransferStopId\t\r\n\t\t,TransferDateTime\t\tAS TransferTarihSaat\r\n\t\tFROM marsatmas as ins with (nolock) \r\n        where ins.sil=0 and ins.marsatid=@MarketSatisId\r\n        and ins.id not in (Select Id From Log_MarketSatis with (NOLOCK)\r\n        where Id=@MarketSatisId )\r\n\r\n\r\n     /* Silme */\r\n     update Log_MarketSatis Set Sil=1,TransferStartId=TransferStartId+1,\r\n     SyncStatus=1 from Log_MarketSatis as ins \r\n     where ins.Id=@MarketSatisId and ins.Id not in (Select id From Marsatmas with (nolock) \r\n     Where id=@MarketSatisId)\r\n\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "SpLog_MarketSatisHareket",
    "definition": "CREATE PROCEDURE dbo.[SpLog_MarketSatisHareket](@MarketSatisId int)\r\nAS\r\nBEGIN\r\n  /* Declare @KayOk Int */\r\n  /* Declare @Id Int */\r\n   \r\n   /*--Sadece Insert islemleri icin  */\r\n   /* Select @Id=id,@KayOk=KayOk From Inserted */\r\n    \r\n   /* if EXISTS (Select Id From Log_Fatura With (Nolock) Where Id=@Id) */\r\n   /*    RETURN */\r\n \r\n   /* if @KayOk=0  */\r\n    /*  RETURN */\r\n\t\r\n\t\r\n\tSET NOCOUNT ON\r\n\r\n    if not EXISTS (SELECT [id] FROM [petromas_db]..[isletme] \r\n      where dataname=DB_NAME() and isnull(AktarimYapilacak,0)=1 )\r\n      RETURN\r\n\r\n\r\n     IF NOT EXISTS (SELECT * FROM [petromas_db].dbo.sysobjects WHERE name = N'BayiInfo' AND xtype='U' ) \r\n      RETURN\r\n\r\n\tDECLARE @BayiId INT\r\n\tSET @BayiId = (SELECT TOP 1 [BayiId] FROM [petromas_db]..[BayiInfo] ORDER BY BayiId DESC)\r\n  \r\n    if @BayiId is null\r\n\t RETURN\r\n  \r\n     /*update islemi Silme */\r\n     update Log_MarketSatisHareket Set Sil=dt.Sil,TransferStartId=TransferStartId+1,\r\n     SyncStatus=1 from  Log_MarketSatisHareket as t join \r\n     (Select ins.id,ins.Sil FROM marsathrk AS ins with (nolock)  where \r\n     ins.marsatid=@MarketSatisId /*and ins.sil=1 */\r\n     and ins.id in (Select Id From Log_MarketSatisHareket with (nolock) \r\n     Where MarketSatisId=@MarketSatisId)) dt on dt.id=t.Id\r\n  \r\n  \r\n \r\n\t    INSERT INTO [dbo].[Log_MarketSatisHareket] (\r\n\t\t\t\t   [Id]\r\n\t\t\t\t  ,[BayiId]\r\n\t\t\t\t  ,[MarketSatisId]\r\n\t\t\t\t  ,[TarihSaat]\r\n\t\t\t\t  ,[KartTipId]\r\n\t\t\t\t  ,[KartId]\r\n\t\t\t\t  ,[Barkod]\r\n\t\t\t\t  ,[FiyatNo]\r\n\t\t\t\t  ,[Miktar]\r\n\t\t\t\t  ,[BirimFiyat]\r\n\t\t\t\t  ,[IndirimYuzde]\r\n\t\t\t\t  ,[KdvYuzde]\r\n\t\t\t\t  ,[KdvTipId]\r\n\t\t\t\t  ,[ParaBirimId]\r\n\t\t\t\t  ,[ParaBirimKur]\r\n\t\t\t\t  ,[BirimId]\r\n\t\t\t\t  ,[Sil]\r\n\t\t\t\t  /*,[OlusturmaKullaniciTipId] */\r\n\t\t\t\t  ,[OlusturmaKullaniciId]\r\n\t\t\t\t  ,[OlusturmaTarihSaat]\r\n\t\t\t\t  /*,[DegistirmeKullaniciTipId] */\r\n\t\t\t\t  ,[DegistirmeKullaniciId]\r\n\t\t\t\t  ,[DegistirmeTarihSaat]\r\n\t\t\t\t  /*,[SilKullaniciTipId] */\r\n\t\t\t\t  /*,[SilKullaniciId] */\r\n\t\t\t\t  /*,[SilTarihSaat] */\r\n\t\t\t\t  ,[TransferStartId]\r\n\t\t\t\t  ,[TransferStopId]\r\n\t\t\t\t  ,[TransferTarihSaat]\r\n\t\t\t\t  ,[RemoteId]\r\n\t\t\t  )\r\n\t\t\t  SELECT\r\n\t\t\t\t  inserted.[id]\t\t\t\t\t\tAS [Id]\t\r\n\t\t\t\t  ,@BayiId\r\n\t\t\t\t  ,inserted.[marsatid]\t\t\t\tAS [MarketSatisId]\r\n\t\t\t\t  ,CONVERT(DATETIME, CONVERT(CHAR(8), [tarih], 112)+' '+CONVERT(CHAR(8), [saat])) AS [TarihSaat]\r\n\t\t\t\t  ,10\r\n\t\t\t\t  ,sk.remote_id\r\n\t\t\t\t  ,inserted.[barkod]\t\t\t\tAS [Barkod]\r\n\t\t\t\t  ,inserted.[satfiyno]\t\t\t\tAS [FiyatNo]\r\n\t\t\t\t  ,inserted.[mik]\t\t\t\t\tAS [Miktar]\r\n\t\t\t\t  ,inserted.[brmfiy]\t\t\t\tAS [BirimFiyat]\r\n\t\t\t\t  ,inserted.[indyuz]\t\t\t\tAS [IndirimYuzde]\r\n\t\t\t\t  ,inserted.[kdvyuz]\t\t\t\tAS [KdvYuzde]\r\n\t\t\t\t  /* DİKKAT\r\n\t\t\t\t   * KDV Tiplerinin tutulduğu tabloyu bulamadım.\r\n\t\t\t\t   * Dahil için 1 gönderilmiş hariç için 0 göndereceğim !!!\r\n\t\t\t\t   */\r\n\t\t\t\t  ,CASE [kdvtip]\t\t\t\r\n\t\t\t\t\t  WHEN 'Dahil' THEN 1\r\n\t\t\t\t\t  ELSE 0\r\n\t\t\t\t   END AS [KdvTipId]\r\n\t\t\t\t  ,CASE [parabrm]\r\n\t\t\t\t\t  WHEN 'TL' THEN 1\r\n\t\t\t\t\t  WHEN 'EUR' THEN 2\r\n\t\t\t\t\t  WHEN 'USD' THEN 3\r\n\t\t\t\t\t  WHEN 'GBP' THEN 4\r\n\t\t\t\t   END\t\t\t\t\t\tAS [ParaBirimId]\r\n\t\t\t\t  ,inserted.[kur]\t\t\tAS [ParaBirimKur]\r\n\t\t\t\t  ,CASE inserted.[brim] \r\n\t\t\t\t\t  WHEN 'AD' THEN 1\r\n\t\t\t\t\t  WHEN 'KG' THEN 2\r\n\t\t\t\t\t  WHEN 'LT' THEN 3\r\n\t\t\t\t\t  ELSE 0\r\n\t\t\t\t   END\t\t\t\t\t\tAS [BirimId]\r\n\t\t\t\t  ,inserted.[sil]\t\t\tAS [Sil]\r\n\t\t\t\t  /* YOK! ,inserted.[OlusturmaKullaniciTipId] */\r\n\t\t\t\t  /* DİKKAT\r\n\t\t\t\t   * users tablosundaki ad alanına <TOP 1 id FROM users WHERE ad=@olususer> sorgusuyla kullanıcı id bilgisini alacağım \r\n\t\t\t\t   * Eğer aynı adla iki kullanıcı olur bulunamazsa id bilgisi boş dönecek oysa sisteme giriş yapmış bir kullanıcı bu işlemi \r\n\t\t\t\t   * yapıyor!\r\n\t\t\t\t   */\r\n\t\t\t\t  ,(SELECT TOP 1 id FROM users WHERE ad like inserted.olususer)\t\tAS [OlusturmaKullaniciId]\r\n\t\t\t\t  ,inserted.[olustarsaat]\t\t\t\t\t\t\t\t\t\t\tAS [OlusturmaTarihSaat]\r\n\t\t\t\t  /* YOK! ,inserted.[DegistirmeKullaniciTipId] */\r\n\t\t\t\t  /* DİKKAT\r\n\t\t\t\t   * OlusturmaKullaniciId ile aynı sorun!!!!\r\n\t\t\t\t   */\r\n\t\t\t\t  ,(SELECT TOP 1 id FROM users WHERE ad like inserted.deguser)\t\tAS [DegistirmeKullaniciId]\r\n\t\t\t\t  ,inserted.[degtarsaat]\t\t\t\t\t\t\t\t\t\t\tAS [DegistirmeTarihSaat]\r\n\t\t\t\t  /* YOK! ,inserted.[SilKullaniciTipId] */\r\n\t\t\t\t  /* YOK! ,inserted.[SilKullaniciId] */\r\n\t\t\t\t  /* YOK! ,inserted.[SilTarihSaat] */\r\n\t\t\t\t  ,inserted.[TransferStartId]\tAS [TransferStartId]\r\n\t\t\t\t  ,inserted.[TransferStopId]\tAS [TransferStopId]\r\n\t\t\t\t  ,inserted.[Transfer_TarSaat]\tAS [TransferTarihSaat] /*,inserted.[TransferDateTime]\tAS [TransferTarihSaat] */\r\n\t\t\t\t  ,inserted.[remote_id]\t\t\tAS [RemoteId]\r\n\t\t\t  FROM Marsathrk AS inserted with (nolock) \r\n\t        INNER JOIN stokkart sk with (nolock) ON sk.tip=inserted.stktip AND sk.Kod = inserted.stkod\r\n             where inserted.marsatid=@MarketSatisId\r\n            and inserted.id not in (Select Id From Log_MarketSatisHareket with (nolock)\r\n            where MarketSatisId=@MarketSatisId)\r\n\r\n\r\n         /* Silme */\r\n         update Log_MarketSatisHareket Set Sil=1,TransferStartId=TransferStartId+1,\r\n         SyncStatus=1 from Log_MarketSatisHareket as ins  \r\n         where ins.MarketSatisId=@MarketSatisId \r\n         and ins.Id not in (Select id From Marsathrk with (nolock)\r\n         Where marsatid=@MarketSatisId)\r\n\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "SpLog_MarketSatisUrunHareket",
    "definition": "CREATE PROCEDURE dbo.[SpLog_MarketSatisUrunHareket]( \r\n@MarketSatisId int)\r\nAS\r\nBEGIN\r\n\r\n     SET NOCOUNT ON\r\n\r\n   if not EXISTS (SELECT [id] FROM [petromas_db]..[isletme] \r\n      where dataname=DB_NAME() and isnull(AktarimYapilacak,0)=1 )\r\n      RETURN\r\n\r\n\r\n     IF NOT EXISTS (SELECT * FROM [petromas_db].dbo.sysobjects WHERE name = N'BayiInfo' AND xtype='U' ) \r\n      RETURN\r\n\r\n\r\n    DECLARE @BayiId INT\r\n\tSET @BayiId = (SELECT TOP 1 [BayiId] FROM [petromas_db]..[BayiInfo] ORDER BY BayiId DESC)\r\n   \r\n  \r\n     if @BayiId is null\r\n\t RETURN\r\n  \r\n  \r\n    /*update islemi Silme */\r\n     update Log_UrunHareket Set \r\n     Sil=dt.Sil,\r\n     KartId=dt.SkRemoteId, /*dt.RemoteId, */\r\n     StokKodu=dt.stkod,\r\n     StokBarkod=dt.Barkod,\r\n     ReceteStokHareketId=dt.MarSatRecHrkId,\r\n     Giren=dt.Giren,Cikan=dt.Cikan,\r\n     BirimFiyatNetKdvli=dt.brmfiykdvli,\r\n     KdvYuzde=dt.KdvYuzde,\r\n     TransferStartId=TransferStartId+1,\r\n     SyncStatus=1,\r\n     TarihSaat=Dt.TarihSaat,\r\n     IslemTipId=dt.IslemTipId\r\n     from  Log_UrunHareket as t join \r\n     (Select ins.id,ins.Sil,ins.barkod,sk.remote_id as SkRemoteId,ins.MarSatRecHrkId,\r\n     ins.stkod,ins.remote_id  AS RemoteId,\r\n     CONVERT(DATETIME, CONVERT(CHAR(8), ins.tarih, 112)+' '+CONVERT(CHAR(8), ins.saat)) AS TarihSaat,\r\n     CASE ins.islmtip \r\n\t\t\tWHEN 'MARSAT' THEN 9 \r\n\t\t\tWHEN 'MARIAD' THEN 10\r\n\t\t\tWHEN 'FATMRALS' THEN 2\r\n\t\t\t/* Diğer tüm durumlar için tekrar gözden geçirilmeli */\r\n\t\t END IslemTipId,\t\r\n     ins.Giren,ins.cikan,\r\n     ins.brmfiykdvli,ins.kdvyuz*100 KdvYuzde\r\n      FROM stkhrk AS ins with (nolock) \r\n     inner join stokkart sk with (nolock) on \r\n     sk.kod = ins.Stkod and sk.tip = ins.stktip and ins.marsatid=@MarketSatisId\r\n     /*and ins.sil=1 */\r\n     and ins.id in (Select Id From Log_UrunHareket with (nolock) \r\n     Where MarketSatisId=@MarketSatisId)) dt on dt.id=t.Id\r\n\r\n   \r\n   /*Insert İslemi */\r\n    INSERT INTO [dbo].[Log_UrunHareket]\r\n\t\t\t   ([Id]\r\n\t\t\t   ,[KartTipId]\r\n\t\t\t   ,[StokKodu]\r\n               ,[StokBarkod]\r\n\t\t\t   ,[BayiId]\r\n\t\t\t   ,[MarketVardiyaId]\r\n\t\t\t   ,[Sil]\r\n\t\t\t   ,[IslemTipId]\r\n\t\t\t   ,[TarihSaat]\r\n\t\t\t   ,[Giren]\r\n\t\t\t   ,[Cikan]\r\n\t\t\t   ,[BirimFiyatNetKdvli]\r\n\t\t\t   ,[KdvYuzde]\r\n\t\t\t   ,[Otv]\r\n\t\t\t   ,[BelgeNo]\r\n\t\t\t   ,[Aciklama]\r\n\t\t\t   ,[OlusturmaKullaniciId]\r\n\t\t\t   ,[OlusturmaTarihSaat]\r\n\t\t\t   ,[DegistirmeKullaniciId]\r\n\t\t\t   ,[DegistirmeTarihSaat]\r\n   \t\t\t   ,[FaturaId]\r\n\t\t\t   ,[IrsaliyeId]\r\n\t\t\t   ,[SayimId]\r\n\t\t\t   ,[KartId]\r\n\t\t\t   ,[RemoteId]\r\n\t\t\t   ,[DepoTransferId]\r\n\t\t\t   ,[DepoId]\r\n\t\t\t   ,[MarketSatisId]\r\n\t\t\t   ,[MarketSatisHareketId]\r\n               ,[ReceteStokHareketId]\r\n\t\t\t   )\r\n        SELECT\r\n\t\t ins.id  AS Id\r\n\t\t,CASE ins.stktip \r\n\t\t\tWHEN 'markt' THEN 10\r\n\t\t\tELSE NULL\r\n\t\t\t\t/* markt değerinin [OpetBackOffice].[dbo].[KartTip] tarafında 10 */\r\n\t\t\t\t/* değerine denk geliyor */\r\n\t\t\t\t/* !! Tüm alabileceği değerler için WHEN koşulunu doldurmalı !! */\r\n\t\t\t\t/* > SELECT * FROM [OpetBackOffice].[dbo].[KartTip]\t\t\t\t\t\t\t */\r\n\r\n\t  \t\t\t\t\t\t\t\t  \r\n\t\tEND\tAS KartTipId\r\n\t\t,ins.stkod   AS StokKodu\r\n        ,ins.barkod  As Barkod\r\n\t\t,@BayiId\t AS BayiId\r\n\t\t,ins.varno  AS MarketVardiyaId\r\n\t\t,ins.sil   AS Sil\r\n\t\t,CASE ins.islmtip \r\n\t\t\tWHEN 'MARSAT' THEN 9 \r\n\t\t\tWHEN 'MARIAD' THEN 10\r\n\t\t\tWHEN 'FATMRALS' THEN 2\r\n\t\t\t/* Diğer tüm durumlar için tekrar gözden geçirilmeli */\r\n\t\t END\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\r\n\t\t\t\t\tAS IslemTipId\r\n\t\t,CONVERT(DATETIME, CONVERT(CHAR(8), ins.tarih, 112)+' '+CONVERT(CHAR(8), ins.saat)) AS TarihSaat\r\n\t\t,ins.giren   AS Giren\r\n\t\t,ins.cikan   AS Cikan\r\n\t\t,ins.brmfiykdvli   AS BirimFiyatNetKdvli\r\n\t\t,ins.kdvyuz*100    AS KdvYuzde\r\n\t\t,ins.otv      AS Otv\r\n\t\t,ins.belno    AS BelgeNo\r\n\t\t,ins.ack   AS Aciklama\r\n\t\t,(SELECT TOP 1 ins.id FROM users WHERE ad like ins.olususer)  AS OlusturmaKullaniciId\r\n\t\t,ins.olustarsaat     AS OlusturmaTarihSaat\r\n\t\t,(SELECT TOP 1 ins.id FROM users WHERE ad like ins.deguser)    AS DegistirmeKullaniciId\r\n\t\t,ins.degtarsaat    AS DegistirmeTarihSaat\r\n\t    ,ins.fatid  AS FaturaId\r\n\t\t,ins.irid    AS IrsaliyeId\r\n\t\t,ins.sayid   AS SayimId\r\n\t\t,sk.Remote_id \tAS OpetUrunId\r\n\t\t,ins.remote_id  AS RemoteId\r\n\t\t,ins.DepTrsId    AS DepoTransferId\r\n\t\t,ins.DepoId   AS DepoId\r\n\t\t,ins.marsatid\r\n\t\t,ins.stkhrkid\r\n        ,ins.MarSatRecHrkId\r\n\t\tFROM stkhrk AS ins with (nolock)  \r\n        inner join stokkart sk with (nolock) on \r\n        sk.kod = ins.Stkod and sk.tip = ins.stktip and ins.marsatid=@MarketSatisId\r\n        /*and ins.sil=0  */\r\n        and ins.marsatid=@MarketSatisId \r\n        and ins.id Not in (Select Id From Log_UrunHareket with (nolock) \r\n        where MarketSatisId=@MarketSatisId )\r\n        \r\n       \r\n \r\n        \r\n        \r\n        \r\n        \r\n        \r\n        \r\n        \r\n        \r\nEND"
  },
  {
    "schema": "dbo",
    "name": "SpMarketSatisBedelsizBarkod",
    "definition": "CREATE PROCEDURE dbo.SpMarketSatisBedelsizBarkod\r\n@MarSatId     int\r\nAS\r\nBEGIN\r\n  \r\n    \r\n    update BarkodBedelsiz set Aktif=0\r\n    where barkod in (Select barkod from marsathrk where marsatid=@MarSatId \r\n    and Sil=0 and Bedelsiz=1)\r\n    \r\n    update BarkodBedelsiz set Aktif=1\r\n    where barkod in (Select barkod from marsathrk where marsatid=@MarSatId \r\n    and  Sil=1 and Bedelsiz=1) \r\n    \r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "SpMarketVardiyaNcrFisNoKontrol",
    "definition": "CREATE PROCEDURE dbo.SpMarketVardiyaNcrFisNoKontrol\r\n@Varno int\r\nAS\r\nBEGIN\r\n\r\n  declare @id int\r\n  declare pom_varx CURSOR FAST_FORWARD  FOR \r\n  SELECT Max(id) from marsatmas with (NOLOCK)\r\n  where varno=@Varno and sil=0 and varok=0\r\n  group by fis_no having count(fis_no)>1\r\n   open pom_varx\r\n  fetch next from  pom_varx into @id\r\n  while @@FETCH_STATUS=0\r\n   begin\r\n  \r\n    /*print @id  */\r\n    update marsatmas set sil=1,\r\n    deguser='NcrFisNoKontrol',degtarsaat=getdate() \r\n    where id=@id\r\n\r\n\r\n  FETCH next from  pom_varx into @id\r\n  end\r\n close Pom_Varx\r\n deallocate pom_varx\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "SpNetsisDekontPompaciVardiya",
    "definition": "CREATE PROCEDURE dbo.[SpNetsisDekontPompaciVardiya]\r\n@Varno             int\r\nAS\r\nBegin\r\n   \r\n /*StokMiktar */\r\n /*StokTutar */\r\n /*StokKdv */\r\n /*    */\r\n\r\n\r\n   Declare @TB_STOK TABLE (\r\n    Varno \t\t\t\t INT,\r\n    Tarih                DATETIME,\r\n    Saat             \t VARCHAR(10) COLLATE Turkish_CI_AS,\r\n    Tip                  Varchar(10), /* */\r\n    DekontSeri           Varchar(10),\r\n    DekontNo             Varchar(10),\r\n    BA                   Varchar(1),\r\n    CM \t\t\t\t\t Varchar(1),\r\n    HesapKod             VARCHAR(30) COLLATE Turkish_CI_AS,\r\n    Tutar                Decimal(18,2) default 0,\r\n    Miktar\t\t\t\t Float default 0, \r\n    KdvTutar\t\t\t Decimal(18,2) default 0,\r\n    KdvYuzde\t\t\t Float default 0,\t\t\r\n    Ack \t\t\t\t VARCHAR(100) COLLATE Turkish_CI_AS,\r\n    CariTip              VARCHAR(20) COLLATE Turkish_CI_AS,\r\n    CariKod\t\t\t\t VARCHAR(30) COLLATE Turkish_CI_AS,\r\n    StokTip             VARCHAR(10) COLLATE Turkish_CI_AS,\r\n    StokKod             VARCHAR(30) COLLATE Turkish_CI_AS,\r\n    StokKdvYuz          Decimal(18,2),\r\n    StokMiktar          Decimal(18,3),\r\n    StokTutar  \t\t    Decimal(18,2),\r\n    OlusTarihSaat          DATETIME)\r\n   \r\n   \r\n   \r\n   DECLARE @CAR_KOD             VARCHAR(30) \r\n     \r\n   SELECT @CAR_KOD=zrap_carkod FROM sistemtanim\r\n   \r\n   /*CM    S=STOK C=CARI M=MAVIN Kasa B=BANKA */\r\n   \r\n  \r\n \r\n   /*Vardiya Stok Kalemleri */\r\n     insert into @TB_STOK (Varno,Tarih,Saat,\r\n     Ack,OlusTarihSaat,BA,CM,\r\n     StokTip,StokKod,StokKdvYuz,StokMiktar,StokTutar)\r\n     SELECT p.varno,p.tarih,p.saat,p.varad,p.olustarsaat,\r\n     'A','S',\r\n     ps.stktip,ps.stkod,max(ps.kdvyuz),sum(ps.satmik),sum(ps.tutar)\r\n     from pomvardimas as p \r\n     inner join pomvardisayac as ps \r\n     on ps.varno=p.varno and p.varok=1\r\n     and ps.varno=@Varno\r\n     /* and p.tarih>=@BasTarih and p.tarih<=@BitTarih  */\r\n       \r\n      group by p.varno,p.tarih,p.saat,p.varad,p.olustarsaat,\r\n      ps.stktip,ps.stkod\r\n      order by p.varno\r\n      \r\n      \r\n      update @TB_STOK Set \r\n      Tutar=StokTutar/(1+StokKdvYuz),\r\n      KdvTutar=StokTutar-(StokTutar/(1+StokKdvYuz)),\r\n      KdvYuzde=StokKdvYuz*100,\r\n      Miktar=StokMiktar\r\n     \r\n      \r\n      update @TB_STOK set HesapKod=dt.muhckskod \r\n      from @TB_STOK as t join (select tip,kod,muhckskod \r\n      from stokkart with (nolock) where Sil=0 ) dt \r\n      on dt.tip=t.StokTip and dt.kod=t.StokKod \r\n      \r\n     /*-Nakit Teslimat */\r\n        \r\n      insert into @TB_STOK (Varno,Tarih,Saat,Ack,OlusTarihSaat,\r\n       BA,CM,CariTip,CariKod,HesapKod,Tutar)\r\n       SELECT p.varno,p.tarih,p.saat,p.varad,p.olustarsaat,\r\n       'B','M','kasakart',k.Kod,k.muhkod,sum(h.giren)\r\n       from kasahrk as h with (nolock) \r\n       inner join kasakart as k with (nolock)  on k.kod=h.kaskod\r\n       inner join pomvardimas as p with (nolock) on  p.varno=h.varno\r\n       where h.sil=0 and h.yertip='pomvardimas' \r\n       and h.varno=@Varno\r\n       group by p.varno,p.tarih,p.saat,p.varad,p.olustarsaat,k.muhkod,k.kod    \r\n      \r\n     \r\n     \r\n      /*Pos Kalemler */\r\n     \r\n     \r\n      insert into @TB_STOK (Varno,Tarih,Saat,Ack,OlusTarihSaat,\r\n       BA,CM,CariTip,CariKod,HesapKod,Tutar)\r\n       SELECT p.varno,p.tarih,p.saat,p.varad,p.olustarsaat,\r\n       'B','M','poskart',k.Kod,k.muhkod,sum(h.giren)\r\n       from poshrk as h with (nolock) \r\n       inner join poskart as k with (nolock)  on  k.kod=h.poskod\r\n       inner join pomvardimas as p with (nolock) on  p.varno=h.varno\r\n       where h.sil=0 and h.yertip='pomvardimas' \r\n       and h.varno=@Varno\r\n       group by p.varno,p.tarih,p.saat,p.varad,p.olustarsaat,k.muhkod,k.kod\r\n     \r\n     \r\n     \r\n     /*Veresiye Kalemler */\r\n     \r\n      insert into @TB_STOK (Varno,Tarih,Saat,Ack,OlusTarihSaat,\r\n       BA,CM,CariTip,CariKod,HesapKod,Tutar)\r\n      Select p.varno,p.tarih,p.saat,p.varad,p.olustarsaat,\r\n      'B','C','carikart',c.Kod,c.muhkod,sum(h.toptut)\r\n      from veresimas as h with (nolock) \r\n      inner join carikart as c on h.carkod=c.kod\r\n      inner join pomvardimas as p with (nolock) on  p.varno=h.varno\r\n      where h.sil=0 and h.yertip='pomvardimas' \r\n      and h.varno =@Varno\r\n      group by p.varno,p.tarih,p.saat,p.varad,p.olustarsaat,c.kod,c.muhkod\r\n     \r\n    /*gelir gider girisi */\r\n   \r\n   \r\n     \r\n     /*acik ile 'B' fazla ise 'A' */\r\n     insert into @TB_STOK (Varno,Tarih,Saat,\r\n     Ack,OlusTarihSaat,BA,CM,\r\n     CariTip,CariKod,HesapKod,Tutar)\r\n     SELECT p.varno,p.tarih,p.saat,p.varad,p.olustarsaat,\r\n     case when ps.tutar<0 then 'B' else 'A' end,'C',\r\n     ps.cartip,ps.kod,'',abs(ps.tutar)\r\n     from pomvardimas as p \r\n     inner join pomvardikap as ps \r\n     on ps.varno=p.varno and p.varok=1 \r\n     and ps.sil=0 and p.varno =@Varno\r\n     and abs(ps.tutar)>0\r\n     \r\n   \r\n     \r\n     \r\n     /*\r\n   \r\n    \r\n   \r\n    --DECLARE @VARNO \t\t\t\t  int\r\n    DECLARE @TARIH \t\t\t\t  DATETIME\r\n    DECLARE @SAAT\t\t\t\t  VARCHAR(10) \t \r\n    DECLARE @STOK_TIP             VARCHAR(10) \r\n    DECLARE @STOK_KOD             VARCHAR(30)\r\n    DECLARE @STOK_KDVYUZ          FLOAT\r\n    DECLARE @STOK_MIKTAR          FLOAT\r\n    DECLARE @STOK_TUTAR  \t\t  FLOAT\r\n    DECLARE @ACK                  VARCHAR(100) \r\n    DECLARE @OLUSTARSAAT     \t  DATETIME\r\n\r\n\r\n \r\n   DECLARE VARDI_STOK CURSOR FAST_FORWARD FOR\r\n    SELECT p.varno,p.tarih,p.saat,p.varad,p.olustarsaat,\r\n    ps.stktip,ps.stkod,max(ps.kdvyuz),sum(ps.satmik),sum(ps.tutar)\r\n    from pomvardimas as p \r\n    inner join pomvardisayac as ps \r\n     on ps.varno=p.varno and p.varok=1\r\n     and ps.varno=@Varno\r\n     -- and p.tarih>=@BasTarih and p.tarih<=@BitTarih \r\n       \r\n      group by p.varno,p.tarih,p.saat,p.varad,p.olustarsaat,\r\n      ps.stktip,ps.stkod\r\n      order by p.varno\r\n   \r\n      \r\n      \r\n     OPEN  VARDI_STOK\r\n      FETCH NEXT FROM VARDI_STOK INTO\r\n       @VARNO,@TARIH,@SAAT,@ACK,@OLUSTARSAAT,\r\n       @STOK_TIP,@STOK_KOD,@STOK_KDVYUZ,@STOK_MIKTAR,@STOK_TUTAR\r\n       WHILE @@FETCH_STATUS = 0\r\n        BEGIN  \r\n\r\n     declare @GEC_STOK_MIKTAR      FLOAT\r\n     declare @GEC_STOK_TUTAR       FLOAT\r\n\r\n     set @GEC_STOK_MIKTAR=0\r\n     set @GEC_STOK_TUTAR=0\r\n\r\n     select @GEC_STOK_MIKTAR=sum(h.mik),\r\n     @GEC_STOK_TUTAR=sum(h.mik*h.brmfiy) from veresimas as m \r\n     inner join veresihrk as h \r\n     on m.verid=h.verid and m.sil=h.sil and m.sil=0\r\n     and h.stktip=@STOK_TIP and h.stkod=@STOK_KOD\r\n     and m.yertip='pomvardimas' and m.varno=@VARNO\r\n     group by m.varno,h.stktip,h.stkod\r\n     \r\n     set @STOK_MIKTAR=@STOK_MIKTAR-@GEC_STOK_MIKTAR\r\n     set @STOK_TUTAR=@STOK_TUTAR-@GEC_STOK_TUTAR\r\n\r\n     insert into @TB_STOK (Varno,Tarih,Saat,Ack,\r\n     CariKod,OlusTarihSaat,\r\n     StokTip,StokKod,StokKdvYuz,StokMiktar,StokTutar)\r\n     values (@VARNO,@TARIH,@SAAT,@ACK,@CAR_KOD,@OLUSTARSAAT,\r\n     @STOK_TIP,@STOK_KOD,@STOK_KDVYUZ,@STOK_MIKTAR,@STOK_TUTAR) \r\n\r\n\r\n     FETCH NEXT FROM VARDI_STOK INTO\r\n       @VARNO,@TARIH,@SAAT,@ACK,@OLUSTARSAAT,\r\n       @STOK_TIP,@STOK_KOD,@STOK_KDVYUZ,@STOK_MIKTAR,@STOK_TUTAR\r\n\r\n   END\r\n   \r\n     CLOSE VARDI_STOK\r\n     DEALLOCATE VARDI_STOK\r\n     \r\n     */\r\n     \r\n     select * from @TB_STOK\r\n\r\n\r\nRETURN\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "SpOtomasyonSaatPivotRapor",
    "definition": "CREATE PROCEDURE dbo.SpOtomasyonSaatPivotRapor \r\n@Firmano    int,\r\n@BasTar     Datetime,\r\n@BitTar     Datetime\r\nAS\r\nBEGIN\r\n   \r\n\r\n/*                         \r\n  DECLARE @data Table\r\n(\r\n    id int identity(1,1)\r\n    ,ReadyDate datetime\r\n    ,foo varchar(500)\r\n)\r\nINSERT INTO @data\r\nVALUES\r\n\r\n('10-14-2019 06:05','(this will populate no columns)')\r\n,('10-14-2019 07:12','(this will populate the 7:00 hour and 8:00 hour)')\r\n,('10-14-2019 10:02','(this will populate the 10:00 hour, 11:00, 12:00)')\r\n,('10-14-2019 12:50','(this will populate the 12:00, 13:00, 14:00)') \r\n\r\n\r\n;WITH Numbers AS\r\n(\r\n    SELECT 1 AS Number\r\n    UNION ALL\r\n    SELECT Number+1\r\n        FROM Numbers \r\n        WHERE Number < 24\r\n)\r\n,src\r\nas (\r\nSelect *, \r\n    flag = CASE WHEN Number >= DATEPART(hour, ReadyDate) AND Number < DATEPART(hour, ReadyDate)  THEN 1 ELSE 0 END \r\nfrom @Data\r\n    CROSS APPLY Numbers\r\n)\r\nSelect * \r\nfrom src\r\n    PIVOT \r\n    (\r\n      max(flag) for number in ([1],[2], [3], [4], [5], [6], [7], [8], [9], [10], [11], [12], [13], [14], [15], [16], [17], [18], [19], [20], [21], [22], [23], [24])\r\n    ) as ptable                              \r\n                                \r\n\r\n*/ \r\n\r\n  CREATE Table #TempSaat (\r\n   Firmano   int,\r\n   Tarih     Datetime,\r\n   Saat      int,\r\n   Toplam      int\r\n  )\r\n  \r\n  \r\n  if @Firmano=0\r\n   insert into #TempSaat (Firmano,Tarih,Saat,Toplam) \r\n   select Firmano, \r\n    CAST([Tarih] as date) AS Tarih,\r\n    DATEPART(hour,[Saat]) AS Saat,\r\n     COUNT(*) AS Toplam\r\n    from [otomasoku]\r\n    where [Tarih]>= @BasTar  /*'2019-07-01 00:00:00.000' */\r\n     and [Tarih]< DATEADD(day,1,@BitTar)                    /*'2019-07-31 23:59:00.000' */\r\n     GROUP BY Firmano,\r\n        CAST([Tarih] as date),\r\n         DATEPART(hour,[Saat])\r\n         \r\n         \r\n  if @Firmano>0\r\n   insert into #TempSaat (Firmano,Tarih,Saat,Toplam) \r\n   select Firmano, \r\n    CAST([Tarih] as date) AS Tarih,\r\n    DATEPART(hour,[Saat]) AS Saat,\r\n     COUNT(*) AS Toplam\r\n    from [otomasoku]\r\n    where firmano=@Firmano  \r\n    and [Tarih]>= @BasTar  /*'2019-07-01 00:00:00.000' */\r\n     and [Tarih]< DATEADD(day,1,@BitTar)                    /*'2019-07-31 23:59:00.000' */\r\n     GROUP BY Firmano,\r\n        CAST([Tarih] as date),\r\n         DATEPART(hour,[Saat])       \r\n\r\n\r\n if @Firmano=0\r\n begin\r\n   select Firmano,Tarih,\r\n   isnull([0],0) [0],isnull([1],0) [1],isnull([2],0) [2],isnull([3],0) [3],\r\n   isnull([4],0) [4],isnull([5],0) [5],isnull([6],0) [6],isnull([7],0) [7],\r\n   isnull([8],0) [8],isnull([9],0) [9],isnull([10],0) [10],isnull([11],0) [11],\r\n   isnull([12],0) [12],isnull([13],0) [13],isnull([14],0) [14],isnull([15],0) [15],\r\n   isnull([16],0) [16],isnull([17],0) [17],isnull([18],0) [18],isnull([19],0) [19],\r\n   isnull([20],0) [20],isnull([21],0) [21],isnull([22],0) [22],isnull([23],0) [23],\r\n   \r\n   (isnull([0],0)+isnull([1],0)+isnull([2],0)+isnull([3],0)+\r\n   isnull([4],0)+isnull([5],0)+isnull([6],0)+isnull([7],0)+\r\n   isnull([8],0)+isnull([9],0)+isnull([10],0)+isnull([11],0)+\r\n   isnull([12],0)+isnull([13],0)+isnull([14],0)+isnull([15],0)+\r\n   isnull([16],0)+isnull([17],0)+isnull([18],0)+isnull([19],0)+\r\n   isnull([20],0)+isnull([21],0)+isnull([22],0)+isnull([23],0) ) Toplam\r\n  from \r\n  (\r\n    select Firmano,Tarih,Saat,Toplam\r\n    from #TempSaat\r\n   \r\n   /* select Firmano, \r\n    CAST([Tarih] as date) AS Tarih,\r\n    DATEPART(hour,[Saat]) AS Saat,\r\n     COUNT(*) AS Toplam\r\n    from [otomasoku]\r\n    where [Tarih]>= @BasTar  --'2019-07-01 00:00:00.000'\r\n     and [Tarih]< DATEADD(day,1,@BitTar)                    --'2019-07-31 23:59:00.000'\r\n     GROUP BY Firmano,\r\n        CAST([Tarih] as date),\r\n         DATEPART(hour,[Saat])\r\n         */\r\n\r\n  ) src\r\n  pivot\r\n  (\r\n    sum(Toplam) \r\n    for Saat in  ([0],[1],[2],[3],[4],[5],[6],[7],[8],[9],[10],[11],[12],[13],[14],[15],[16],[17],[18],[19],[20],[21],[22],[23]) \r\n  ) piv \r\n  order by Firmano,Tarih\r\n \r\n end\r\n \r\n \r\n \r\n \r\n\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "SpOzetBilanco",
    "definition": "CREATE PROCEDURE [dbo].[SpOzetBilanco]\r\n@Firmano int,\r\n@Tarih   Datetime\r\nAS\r\nBEGIN\r\n\r\n  declare @Sirano  int\r\n  declare @Alacak decimal(13,2)\r\n  declare @Borc decimal(13,2)\r\n\r\n  /*1.Rapor Stok Durum Rapor Urun Adi Miktar - Tutar  */\r\n   Declare  @StokDurum TABLE (\r\n   KARTKOD     VARCHAR(30),\r\n   KARTAD     VARCHAR(150),\r\n   MIKTAR      FLOAT,\r\n   TUTAR       FLOAT\r\n   )\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\r\n   \r\n    CREATE TABLE  #TB_RAPOR (\r\n    Id         \t\t    INT IDENTITY(1, 1),\r\n    SiraNo\t\t\t    int DEFAULT 1,\r\n    BaslikNo              int default 0,\r\n    GrupNo\t\t\t\t\tint,\r\n    DegerId\t\t\t\t    int, \r\n    DegerKod\t\t        VARCHAR(50), \r\n    Alan1Type            int default 0, /* string 0 - 1 float -2 tarih  */\r\n    Alan1Deger\t\t\tVARCHAR(100)  COLLATE Turkish_CI_AS DEFAULT '',\r\n    Alan2Type\t\t\t int default 0, /* string 0 - 1 float -2 tarih  */\r\n    Alan2Deger    \t        VARCHAR(100)  COLLATE Turkish_CI_AS DEFAULT '',\r\n    Alan3Type\t\t\t int default 0, /* string 0 - 1 float -2 tarih  */\r\n    Alan3Deger               VARCHAR(100)  COLLATE Turkish_CI_AS DEFAULT '',\r\n    Alan4Type\t\t\t int default 0, /* string 0 - 1 float -2 tarih  */\r\n    Alan4Deger               VARCHAR(100)  COLLATE Turkish_CI_AS DEFAULT '',\r\n    Alan5Type\t\t\t int default 0, /* string 0 - 1 float -2 tarih  */\r\n    Alan5Deger               VARCHAR(100)  COLLATE Turkish_CI_AS DEFAULT '', \r\n    Alan6Type\t\t\t int default 0, /* string 0 - 1 float -2 tarih  */\r\n    Alan6Deger               VARCHAR(100)  COLLATE Turkish_CI_AS DEFAULT '', \r\n    Alan7Type\t\t\t int default 0, /* string 0 - 1 float -2 tarih  */\r\n    Alan7Deger               VARCHAR(100)  COLLATE Turkish_CI_AS DEFAULT ''\r\n    )\r\n\r\n   \r\n   \r\n   \r\n   \r\n    CREATE TABLE  #TB_OZETRAPOR (\r\n    Id         \t\t    INT IDENTITY(1, 1),\r\n    StokMiktar\t\t    decimal(13,2),\r\n    StokTutar\t\t    decimal(13,2),\r\n    CariAlacak          decimal(13,2) default 0,\r\n    CariBorc            decimal(13,2) default 0,\r\n    PerAlacak           decimal(13,2) default 0,\r\n    PerBorc             decimal(13,2) default 0,\r\n    KasaAlacak          decimal(13,2) default 0,\r\n    KasaBorc            decimal(13,2) default 0,\r\n    ToplamAlacak        decimal(13,2) default 0,\r\n    ToplamBorc          decimal(13,2) default 0\r\n    )\r\n\r\n    \r\n    /*------------Stok Durum*/\r\n     set @Sirano=1\r\n     insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,Alan1Deger)\r\n      select 1,@Sirano,1,'Stok Durum '\r\n    \r\n    \r\n     insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,Alan1Deger,Alan2Deger,Alan3Deger,Alan4Deger)\r\n     select 2,@Sirano,1,'Ürün ','-','Tutar','-'\r\n     \r\n     \r\n      insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,DegerKod,Alan1Deger,\r\n      Alan2Type,Alan2Deger,Alan3Type,Alan3Deger,Alan4Type)\r\n      select 5,@Sirano,1,'stok','STOK',1,0,1,0,1 \r\n     \r\n     \r\n      \r\n      /*Son Akaryakit Tarihteki Alis Fiyat */\r\n      \r\n       Declare  @StokFiyat TABLE (\r\n       Tip     VARCHAR(30),\r\n       Kod     VARCHAR(150),\r\n       Tarih      Datetime,\r\n       BakiyeMiktar      float default 0,\r\n       SatisMiktar\t\tfloat default 0,\r\n       SatisTutar\t\tfloat default 0,\r\n       AlisFiyat       float default 0,\r\n       FifoFiyat       float default 0,\r\n       SatisFiyat      float default 0\r\n       )\r\n      \r\n      insert into @StokFiyat (Tip,Kod,BakiyeMiktar,Tarih)\r\n      SELECT  S.stktip,s.stkod,sum(giren-cikan),\r\n      max(\r\n      case when s.giren>0 then S.tarih+cast(saat as datetime) else null end)\r\n      FROM stkhrk as s with (NOLOCK) WHERE \r\n      s.sil=0  and (s.tarih<=@Tarih) and s.firmano in (0,@Firmano)\r\n      group by s.stkod,S.stktip\r\n      \r\n      \r\n      \r\n      \r\n       update @StokFiyat \r\n       set SatisFiyat=dt.Sat1Fiy \r\n       from @StokFiyat as t \r\n       join (select tip,kod,sat1fiy from stokkart s with (NOLOCK) \r\n       where sil=0 ) dt on \r\n       dt.tip=t.tip and dt.kod=t.kod\r\n\r\n      \r\n      \r\n      update #TB_RAPOR set \r\n      /*Alan2Deger=dt.miktar, */\r\n      Alan3Deger=cast(dt.Tutar as decimal(13,2))\r\n      /*Alan4Deger=dt.SatisFiyat */\r\n       From #TB_RAPOR as t \r\n      join (select\r\n      Round(sum(BakiyeMiktar),2) Miktar,\r\n      Round(sum(BakiyeMiktar*SatisFiyat),2) as Tutar,\r\n      case when Round(sum(BakiyeMiktar),2)>0 then \r\n      Round(sum(BakiyeMiktar*SatisFiyat),2) / Round(sum(BakiyeMiktar),2) \r\n      else 0 end SatisFiyat \r\n       from @StokFiyat  )\r\n      dt on t.DegerKod='stok' \r\n      \r\n      \r\n      \r\n     insert into #TB_OZETRAPOR (StokMiktar,StokTutar)\r\n      values (0,0)\r\n    \r\n    \r\n      update #TB_OZETRAPOR set  \r\n      StokMiktar=isnull(dt.miktar,0),\r\n      StokTutar=isnull(cast(dt.Tutar as decimal(13,2)),0)\r\n      From #TB_RAPOR as t \r\n      join (select  Round(sum(BakiyeMiktar),2) Miktar,\r\n      Round(sum(BakiyeMiktar*SatisFiyat),2) as Tutar,\r\n      case when Round(sum(BakiyeMiktar),2)>0 then \r\n      Round(sum(BakiyeMiktar*SatisFiyat),2) / Round(sum(BakiyeMiktar),2) \r\n      else 0 end SatisFiyat from @StokFiyat  )\r\n      dt on t.DegerKod='stok' \r\n   \r\n      \r\n     \r\n    \r\n     \r\n    \r\n    \r\n    \r\n    /*Pos Banka Durum */\r\n    \r\n    set @Sirano=20\r\n    insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,Alan1Deger)\r\n    select 1,@Sirano,1,'Cari - Personel - Kasa Durum '       \r\n     \r\n    insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,Alan1Deger,Alan2Deger,Alan3Deger,Alan4Deger)\r\n    select 2,@Sirano,1,'Aciklama ','Alacağımız','Borçlarımız','Bakiye'\r\n    \r\n   \r\n    \r\n   \r\n    \r\n    \r\n    \r\n    insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,DegerKod,Alan1Deger,\r\n      Alan2Type,Alan2Deger,Alan3Type,Alan3Deger,Alan4Type,Alan4Deger)  \r\n      select TOP 1 5,@Sirano,1,'','CARI',\r\n      1,LTRIM(STR(round(Sum(borc),2),25,2)),1,\r\n      LTRIM(STR(round(Sum(alacak),2),25,2)),\r\n      1,LTRIM(STR(round(Sum(borc-alacak),2),25,2)) \r\n      FROM  carihrk as s with (nolock)\r\n      where s.cartip='carikart' and s.Sil=0 \r\n      and s.firmano in (@Firmano) and s.Tarih<=@Tarih  \r\n      \r\n      \r\n      \r\n      set @Borc=0\r\n      Set @Alacak=0\r\n      \r\n      select\r\n      @Alacak=round(Sum(borc),2),\r\n      @Borc=round(Sum(alacak),2) \r\n      FROM  carihrk as s with (nolock)\r\n      where s.cartip='carikart' and s.Sil=0 \r\n      and s.firmano in (@Firmano) and s.Tarih<=@Tarih \r\n      \r\n     \r\n      update #TB_OZETRAPOR set  \r\n      CariAlacak=isnull(@Alacak,0),\r\n      CariBorc=isnull(@Borc,0)\r\n      From #TB_RAPOR\r\n    \r\n    \r\n   \r\n    \r\n    /*\r\n      update #TB_OZETRAPOR set  \r\n      CariAlacak=cast(  round(dt.alacak,2) as decimal(13,5)),--isnull(cast(dt.alacak as decimal(13,2)),0),\r\n      CariBorc=0--isnull(cast(dt.borc as decimal(13,2)),0)\r\n      From #TB_RAPOR as t join (\r\n      select\r\n      round(Sum(borc),2) alacak,\r\n      round(Sum(alacak),2) borc\r\n      FROM  carihrk as s with (nolock)\r\n      where s.cartip='carikart' and s.Sil=0 \r\n      and s.firmano in (@Firmano) and s.Tarih<=@Tarih   \r\n      ) dt on 1=1 \r\n    */\r\n\r\n    \r\n    insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,DegerKod,Alan1Deger,\r\n      Alan2Type,Alan2Deger,Alan3Type,Alan3Deger,Alan4Type,Alan4Deger)  \r\n      select TOP 1 5,@Sirano,1,'','PERSONEL',\r\n      1,LTRIM(STR(round(Sum(borc),2),25,2)),1,\r\n      LTRIM(STR(round(Sum(alacak),2),25,2)),\r\n      1,LTRIM(STR(round(Sum(borc-alacak),2),25,2)) \r\n      FROM  carihrk as s with (nolock)\r\n      where s.cartip='perkart' and s.Sil=0 \r\n      and s.firmano in (@Firmano) and s.Tarih<=@Tarih  \r\n    \r\n    \r\n      update #TB_OZETRAPOR set  \r\n      PerAlacak=isnull(dt.alacak,0),\r\n      PerBorc=isnull(dt.borc,2)\r\n      From #TB_RAPOR as t join (\r\n      select\r\n      round(Sum(borc),2) alacak,\r\n      round(Sum(alacak),2) borc\r\n      FROM  carihrk as s with (nolock)\r\n      where s.cartip='perkart' and s.Sil=0 \r\n      and s.firmano in (@Firmano) and s.Tarih<=@Tarih   \r\n      ) dt on 1=1 \r\n    \r\n    \r\n    \r\n    /*\r\n    insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,DegerKod,Alan1Deger,\r\n      Alan2Type,Alan2Deger,Alan3Type,Alan3Deger,Alan4Type,Alan4Deger)  \r\n      select TOP 1 5,@Sirano,1,'','BANKA',\r\n      1,round(cast(BAKIYE_BORC as decimal(15,2)),2),1,\r\n      round(cast(BAKIYE_ALACAK as decimal(15,2)) ,2),1,\r\n      round(cast(BAKIYE_BORC-BAKIYE_ALACAK as decimal(15,2)),2)  \r\n      FROM  UDF_MIZAN_BANKA (@firmano,0,'2000-01-01',@Tarih,0)\r\n       \r\n       \r\n    insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,DegerKod,Alan1Deger,\r\n      Alan2Type,Alan2Deger,Alan3Type,Alan3Deger,Alan4Type,Alan4Deger)  \r\n      select TOP 1 5,@Sirano,1,'','POS',\r\n      1,round(cast(BAKIYE_BORC as decimal(15,2)),2),1,\r\n      round(cast(BAKIYE_ALACAK as decimal(15,2)) ,2),1,\r\n      round(cast(BAKIYE_BORC-BAKIYE_ALACAK as decimal(15,2)),2)  \r\n      FROM  UDF_MIZAN_POS_BEKLEYEN (@firmano,0,'2000-01-01',@Tarih,0) \r\n      */\r\n\r\n     \r\n     \r\n \r\n  \r\n   /*Kasa Durum Durum */\r\n    \r\n    /*insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,Alan1Deger) */\r\n    /*select 1,@Sirano,1,'Kasa Durum '        */\r\n     \r\n   /* insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,Alan1Deger,Alan2Deger,Alan3Deger,Alan4Deger) */\r\n    /*select 2,@Sirano,1,'Aciklama ','Giren','Cikan','Bakiye' */\r\n    \r\n   set @Sirano=70 \r\n    insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,DegerKod,Alan1Deger,\r\n    Alan2Type,Alan2Deger,Alan3Type,Alan3Deger,Alan4Type)\r\n    select 5,@Sirano,1,'kasa','KASA',1,0,1,0,1 \r\n    \r\n    \r\n    update #TB_RAPOR set \r\n      Alan2Deger=isnull(dt.Borc,0),\r\n      Alan3Deger=isnull(dt.Alacak,0),\r\n      Alan4Deger=isnull(dt.bakiye,0)  \r\n      From #TB_RAPOR as t \r\n      join (select \r\n      Sum(cast(BORC as decimal(15,2))) Borc,\r\n      Sum(cast(ALACAK as decimal(15,2))) Alacak,\r\n      Sum(cast(BAKIYE_BORC-BAKIYE_ALACAK as decimal(15,2))) bakiye\r\n      \r\n      FROM  UDF_MIZAN_KASA (@Firmano,0,@Tarih,@Tarih,0)  \r\n      Where ParentId>0  )\r\n      dt on  t.SiraNo=@Sirano\r\n      \r\n      \r\n      \r\n      \r\n      update #TB_OZETRAPOR set  \r\n      KasaAlacak=isnull(dt.alacak,0),\r\n      KasaBorc=isnull(dt.borc,0)\r\n      From #TB_RAPOR as t join (\r\n      select\r\n      round(Sum(borc),2) alacak,\r\n      round(Sum(alacak),2) borc\r\n      FROM  UDF_MIZAN_KASA (@Firmano,0,@Tarih,@Tarih,0)  \r\n      Where ParentId>0  )\r\n      dt on 1=1\r\n  \r\n    \r\n    \r\n     update #TB_OZETRAPOR set ToplamAlacak=StokTutar+CariAlacak+PerAlacak+KasaAlacak\r\n     \r\n     update #TB_OZETRAPOR set ToplamBorc=CariBorc+PerBorc+KasaBorc\r\n     \r\n    \r\n    \r\n    /*\r\n     --ilgili gun      \r\n     insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,DegerKod,Alan1Deger,\r\n      Alan2Type,Alan2Deger,Alan3Type,Alan3Deger,Alan4Type,Alan4Deger)  \r\n      select 5,@Sirano,1,'',ACK,\r\n      1,cast(BORC as decimal(15,2)),1,\r\n      cast(ALACAK as decimal(15,2)),1,\r\n      cast(BAKIYE_BORC-BAKIYE_ALACAK as decimal(15,2)) \r\n      FROM  UDF_MIZAN_KASA (@Firmano,0,@Tarih,@Tarih,0)\r\n      --FROM  UDF_MIZAN_KASA (@Firmano,0,'2000-01-01',@Tarih,0)\r\n\r\n      Where ParentId>0 \r\n      */\r\n     \r\n     /*\r\n      insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,DegerKod,Alan1Deger,\r\n      Alan2Type,Alan2Deger,Alan3Type,Alan3Deger,Alan4Type,Alan4Deger)\r\n      SELECT 10,@Sirano,1,'','TOPLAM',\r\n      1,LTRIM(STR(Sum(cast( Alan2Deger as decimal(13,2))),25,2)),\r\n      1,LTRIM(STR(sum(cast( Alan3Deger as decimal(13,2))),25,2)),\r\n      1,LTRIM(STR(sum(cast( Alan4Deger as decimal(13,2))),25,2))\r\n      from #TB_RAPOR where BaslikNo=5 and Sirano=@Sirano\r\n    */\r\n      insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,DegerKod,Alan1Deger,\r\n      Alan2Type,Alan2Deger,Alan3Type,Alan3Deger,Alan4Type,Alan4Deger)\r\n      SELECT 5,@Sirano,1,'','TOPLAM',\r\n      1,LTRIM(STR(Sum(cast( Alan2Deger as decimal(13,2))),25,2)),\r\n      1,LTRIM(STR(sum(cast( Alan3Deger as decimal(13,2))),25,2)),\r\n      1,LTRIM(STR(sum(cast( Alan4Deger as decimal(13,2))),25,2))\r\n      from #TB_RAPOR where BaslikNo=5 and Sirano in (20,70)\r\n     \r\n \r\n   /*Kasa Durum Sonu */\r\n\r\n\r\n    set @Sirano=80\r\n    insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,Alan1Deger)\r\n    select 1,@Sirano,1,'Genel Toplam '\r\n    \r\n     insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,\r\n     Alan1Deger,Alan2Deger,Alan3Deger,Alan4Deger)\r\n     select 2,@Sirano,1,'Aciklama','Alacaklarımız','Borçlarımız','Fark'\r\n     \r\n     \r\n     declare @Stok decimal(12,2)\r\n      set @Stok=0\r\n         \r\n      select @Stok=cast(sum((BakiyeMiktar*SatisFiyat))as decimal(13,2))\r\n      from @StokFiyat\r\n     \r\n     \r\n    \r\n      set @Alacak=0\r\n      set @Borc=0\r\n      \r\n      \r\n      \r\n      SELECT \r\n      @Alacak=LTRIM(STR(Sum(cast( Alan2Deger as decimal(13,2))),25,2)),\r\n      @Borc=LTRIM(STR(sum(cast( Alan3Deger as decimal(13,2))),25,2))\r\n      from #TB_RAPOR where BaslikNo=5 and Sirano in (70)\r\n      \r\n      \r\n      if @Stok<0\r\n      set @Borc=@Borc+@Stok\r\n      else\r\n       set @Alacak=@Alacak+@Stok\r\n     \r\n     \r\n      insert into #TB_RAPOR (BaslikNo,SiraNo,GrupNo,DegerKod,Alan1Deger,\r\n      Alan2Type,Alan2Deger,Alan3Type,Alan3Deger,Alan4Type,Alan4Deger)\r\n      SELECT 5,@Sirano,1,'','Toplam',\r\n      1,round(@Alacak,2),\r\n      1,round(@Borc,2),\r\n      1,round(@Alacak-@Borc,2)\r\n      \r\n      \r\n      \r\n      \r\n  \r\n    \r\n  \r\n    /*select * from #TB_RAPOR order by SiraNo,BaslikNo,Id */\r\n    select * from #TB_OZETRAPOR\r\n  \r\n  /*\r\n  select * from @StokFiyat \r\n   \r\n   \r\n   select Tip,Kod,Sum(bakiyemiktar) Miktar,\r\n   Sum(bakiyemiktar*satisfiyat) from @StokFiyat\r\n   group by Tip,Kod \r\n  */\r\n  \r\n  return\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "SpPomvardiVeresiTTSKont",
    "definition": "CREATE PROCEDURE dbo.SpPomvardiVeresiTTSKont (\r\n@firmano int,\r\n@varno float\r\n)\r\nAS\r\nBEGIN\r\n \r\n declare @TTSKey   varchar(100)\r\n declare @Tarih    datetime\r\n\r\n  select @Tarih=tarih  from pomvardimas with (nolock) where varno=@varno\r\n \r\n  select @TTSKey=tts_key from otomaskart where firmano=@firmano and tts_key<>'' \r\n \r\n if isnull(@TTSKey,'')<>''\r\n  begin\r\n \r\n /*\r\n  SELECT  O.kod AS oCARKOD,v.carkod as vCARKOD,v.TARİH ,O.plaka OPLAKA,V.PLAKA AS VPLAKA,\r\n   o.cartip,v.verid,v.aktip\r\n  from    otomasgenkod AS O \r\n  INNER JOIN     veresimas AS V  ON V.plaka = O.plaka and v.varno=@varno\r\n  where v.firmano =@firmano and O.otomaskod='TTS' \r\n  and v.otocarkod in (select * from CsvToSTR(@TTSKey))\r\n  AND o.kod<>v.carkod --and v.plaka='041RA398'\r\n\r\nselect * from veresimas where verid=29973\r\nand otocarkod in (select * from CsvToSTR(@TTSKey))\r\n--('901395','903182')\r\n*/\r\n\r\n\r\n update veresimas set cartip=dt.cartip,carkod=dt.carkod from veresimas as t join \r\n (select v.verid,O.kod AS carkod,o.cartip  from  otomasgenkod AS O \r\n  INNER JOIN  veresimas AS V  ON V.plaka = O.plaka and o.firmano=v.firmano\r\n  and v.varno=@varno and v.tarih>=DATEADD(day,-5,@Tarih) and v.sil=0\r\n  where v.firmano=@firmano  and O.otomaskod='TTS' and v.aktip='BK'\r\n  and v.otocarkod in (select * from CsvToSTR(@TTSKey))\r\n  AND o.kod<>v.carkod) dt on dt.verid=t.verid\r\n\r\nend\r\n\r\n\r\n /*vardiya basligi olusmamis ise   */\r\n if not EXISTS (select id  from pomvardimas with (nolock) where varno=@varno)\r\n  begin\r\n   update veresimas \r\n   set TransferStartId=isnull(TransferStartId,0)+1,\r\n   sil=0,\r\n   yertip=case when vtsid>0 then 'vts_islem' else 'havuzislem' end,\r\n   yerad=case when vtsid>0 then\r\n   (select ad from yertipad where kod='vts_islem')\r\n   else (select ad from yertipad where kod='havuzislem') end,\r\n   varno=0,kayok=1\r\n   from veresimas v \r\n   with (nolock) inner join otomasoku ot with (nolock) \r\n    on v.firmano=ot.firmano and ot.Firmano=@firmano and v.havuzfis=1 \r\n    and v.vtsid=ot.otomasid and v.sil=0  and v.varno=@varno\r\n  end\r\n\r\n\r\n\r\n   /*-vardiya olusumunda veresiye fislerine varno atanmamis ise kontrol  */\r\n    update veresimas set sil=1,\r\n    deguser='VeresiTTSKont',degtarsaat=getdate() where id in (\r\n    select id from veresimas with (NOLOCK) where firmano=@firmano\r\n    and varno=0 and otomas_id in ( \r\n    select otomas_id from veresimas as v with (NOLOCK)\r\n    where firmano=@firmano and sil=0 and otomas_id>0 and yertip='pomvardimas'  \r\n    group by Tarih,otomas_id\r\n    having count(*)>1) )\r\n \r\n\r\n   /*AracSayi Bul */\r\n    update pomvardimas set AracSayi=dt.AracSayi from pomvardimas as t \r\n    join (Select count(id) AracSayi from otomasoku with (NOLOCK) \r\n    where varno=@varno ) dt on t.varno=@varno\r\n    \r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "SpPromaksMarketSatisAktar",
    "definition": "CREATE PROCEDURE dbo.[SpPromaksMarketSatisAktar]\r\n@FirmaNo       int,\r\n@VarNo         int,\r\n@GuidId           varchar(40),\r\n@OlusUser         varchar(100),\r\n@FiyatGuncelle    bit\r\nAS\r\nBEGIN\r\n\r\n\r\n\r\n     declare @KasaNo \t\tint\r\n     declare @FisNo\t\t\tint \r\n     declare @AcilisTarihSaat \tDatetime\r\n     declare @KapanisTarihSaat \tDatetime\r\n    /* declare @Tutar        \tfloat */\r\n     declare @FisTutar        \tfloat\r\n     declare @MarSatId      int\r\n     declare @YazarKasaServisLogId       int\r\n     declare @KasaHrkId         int\r\n     \r\n     \r\n     declare @AcilisTarih Datetime\r\n     declare @AcilisSaat  varchar(8)\r\n     \r\n     declare @OdemeTip   varchar(30)\r\n     \r\n     declare @FisTarihSaat Datetime\r\n     declare @FisTarih Datetime\r\n     declare @FisSaat  varchar(8)\r\n     declare @YazarKasaVardiyaNo \t\tint\r\n\r\n     \r\n     \r\n     declare @DepoKod      varchar(30) \r\n     declare @PersonelKod Varchar(30) \r\n\r\n     declare @KdvTip      varchar(30)\r\n     declare @IslemTip      varchar(30)\r\n     declare @IslemTipAd      varchar(30)\r\n     declare @YerTip      varchar(30)\r\n     declare @YerTipAd      varchar(50)\r\n     Declare @ParaBirim Varchar(20)\r\n     \r\n     declare @Barkod  varchar(30)\r\n     declare @StokKod  varchar(30)\r\n     declare @StokTip  varchar(30)\r\n     declare @StokTipAd  varchar(30)\r\n     declare @Birim      varchar(20)\r\n     declare @StokId      int\r\n     declare @StokTipId      int\r\n     declare @Miktar      Float\r\n     declare @BirimFiyat      Float\r\n     declare @KdvYuz      Float\r\n     \r\n     \r\n     \r\n     declare @Giren      Float\r\n     declare @Cikan      Float\r\n    \r\n    declare @PosHrkId  int \r\n    declare @PosKod  varchar(30)\r\n    declare @BankKod  varchar(30)\r\n    declare @VarPosIsle  bit\r\n     \r\n    Set @KdvTip='Dahil'\r\n    Set @Islemtip='satis'\r\n    Set @IslemTipAd='SATIŞ'\r\n    Set @YerTip='promakscsv'\r\n    Set @YerTipAd='PROMAKS CSV'\r\n    Set @ParaBirim='TL' \r\n\r\n   \r\n    select top 1 @VarPosIsle=Var_Pos_Isle,@PosKod=marpossatkod from sistemtanim\r\n    select @BankKod=pk.bankod from poskart as pk where pk.kod=@PosKod\r\n    \r\n    \r\n    \r\n    Select @DepoKod=Depkod,@PersonelKod=PerKod  \r\n    From MarvardiMas Where varno=@Varno\r\n    \r\n    \r\n    \r\n    if @DepoKod=''\r\n      set @DepoKod='M0001'\r\n    \r\n   if @PersonelKod='' \r\n    set @PersonelKod='P0001'\r\n    \r\n    \r\n    set @StokTip='markt'\r\n    set @StokTipAd='MARKET'\r\n    set @StokTipId=2\r\n    \r\n    \r\n     /*Nakit  */\r\n           \r\n      /*MarSatMas Kontrol ve Olustur  */ \r\n\r\n       declare CurMarSat CURSOR FAST_FORWARD  FOR \r\n       Select IslemTarih,IslemId,Sum(Tutar) Tutar,OdemeTip from PromaksMarketSatisLog with (nolock) \r\n       Where GuidId=@GuidId and Aktar=1 and StokId is not null\r\n       Group By IslemTarih,IslemId,OdemeTip\r\n       \r\n\t    \r\n        open CurMarSat\r\n       fetch next from  CurMarSat into @FisTarihSaat,@FisNo,@FisTutar,@OdemeTip\r\n       while @@FETCH_STATUS=0\r\n         begin\r\n                  \r\n         \r\n         \r\n         Set @MarSatId=0\r\n         \r\n         set @FisTarih=DATEADD(dd,0,DATEDIFF(dd,0,@FisTarihSaat))   \r\n         set @FisSaat=CONVERT(VARCHAR(8),@FisTarihSaat,108) \r\n         \r\n         Select @MarSatId=id From marsatmas with (nolock) \r\n         where Varno=@VarNo And Fis_No=@FisNo and Sil=0\r\n   \r\n         if isnull(@MarSatId,0)=0\r\n          begin\r\n            insert into marsatmas (Firmano,varno,marsatid,islmtip,islmtipad,yertip,yerad,\r\n            tarih,saat,kayok,olususer,olustarsaat,yazarkasa_id,Fis_No,YazarKasaIslemId,\r\n            parabrm,cartip,carkod,Zno)\r\n            values (@Firmano,@VarNo,0,@IslemTip,@IslemTipAd,@YerTip,@YerTipAd,\r\n            @FisTarih,@FisSaat,0,@OlusUser,GetDate(),0,@FisNo,0,\r\n            @ParaBirim,'vardikasa','VRDKASA',0)\r\n\r\n            select @MarSatId=SCOPE_IDENTITY() \r\n          \r\n            update marsatmas set marsatid=id where id=@MarSatId\r\n          end\r\n          \r\n         \r\n         \r\n          /* MarsatHrk Kontrol ve Olustur   */ \r\n         \r\n           declare CurMarSatHrk CURSOR FAST_FORWARD  FOR \r\n           Select Id,StokId,StokKod,Barkod,Miktar,Fiyat,Kdv,Birim  \r\n           from PromaksMarketSatisLog with (nolock) \r\n           Where GuidId=@GuidId and Aktar=1 and IslemId=@FisNo and StokId is not null\r\n         \r\n           \r\n           open CurMarSatHrk\r\n           fetch next from  CurMarSatHrk into @YazarKasaServisLogId,\r\n           @StokId,@StokKod,@Barkod,@Miktar,@BirimFiyat,@KdvYuz,@Birim  \r\n           while @@FETCH_STATUS=0\r\n            begin \r\n               \r\n           insert into marsathrk (Firmano,varno,islmtip,islmtipad,perkod,depkod,\r\n            yertip,yerad,satfiyno,tarih,saat,marsatid,barkod,\r\n            stk_id,stkod,stktip_id,stktip,stktipad,mik,brim,\r\n            brmfiy,kdvtip,kdvyuz,olususer,olustarsaat,YazarKasaServisLogId)\r\n           values (@Firmano,@VarNo,@IslemTip,@IslemTipAd,@PersonelKod,@DepoKod,\r\n            @YerTip,@YerTipAd,1,@FisTarih,@FisSaat,@MarSatId,\r\n            @Barkod,@StokId,@StokKod,@StokTipId,@StokTip,@StokTipAd,@Miktar,@Birim,\r\n            @BirimFiyat,@KdvTip,@KdvYuz/100,@OlusUser,GetDate(),@YazarKasaServisLogId)\r\n\r\n            update PromaksMarketSatisLog Set Transfer=1 Where Id=@YazarKasaServisLogId\r\n\r\n               \r\n           fetch next from  CurMarSatHrk into @YazarKasaServisLogId,\r\n          @StokId,@StokKod,@Barkod,@Miktar,@BirimFiyat,@KdvYuz,@Birim\r\n       end\r\n       close CurMarSatHrk\r\n       deallocate CurMarSatHrk\r\n         \r\n        \r\n       /*Markart Kasa */\r\n        set @Giren=0\r\n        set @Cikan=0\r\n        \r\n        \r\n        Select @FisTutar=Sum(mik*brmfiy) from marsathrk with (nolock)\r\n         where  marsatid=@MarSatId\r\n             \r\n        if @FisTutar>0\r\n          set @Giren=@FisTutar\r\n        else\r\n          set @Cikan=@FisTutar \r\n          \r\n         \r\n       set @PosHrkId=0   \r\n       set @KasaHrkId=0   \r\n         \r\n      \r\n       /*Nakit */\r\n       \r\n      if (@OdemeTip='Nakit') \r\n       begin    \r\n            \r\n         select @KasaHrkId=id From markasahrk with (nolock) Where marsatid=@MarSatId     \r\n       \r\n        if isnull(@KasaHrkId,0)=0\r\n        begin\r\n        insert into markasahrk (Firmano,varno,gctip,marsatid,kaskod,\r\n         kashrkid,islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n         tarih,saat,olususer,olustarsaat,giren,cikan,kur,parabrm,perkod)\r\n        values (@Firmano,@VarNo,'G',@MarSatId,'VRDKASA',\r\n         0,'TAH','TAHSİLAT','NAK','NAKİT TAHSİLAT',@YerTip,@YerTipAd,\r\n         @FisTarih,@FisSaat,@OlusUser,GetDate(),\r\n         @Giren,abs(@Cikan),1,@ParaBirim,@PersonelKod)\r\n\r\n         select @KasaHrkId=SCOPE_IDENTITY() \r\n          \r\n         update markasahrk set kashrkid=id where id=@KasaHrkId\r\n\r\n       end \r\n       else\r\n        update markasahrk set giren=@Giren,cikan=abs(@Cikan) where marsatid=@MarSatId \r\n       \r\n       end\r\n       \r\n       \r\n       \r\n       \r\n      if (@OdemeTip='Kredi Kartı') \r\n       begin\r\n       \r\n             /*\r\n         poshrk','poshrkid',['gctip','islmtip','islmtipad',\r\n                        'islmhrk','islmhrkad','yertip','yerad','marsatid','perkod','adaid','tarih','saat','carslip',\r\n                        'cartip_id','cartip','car_id','carkod',\r\n                        'poskod','bankod',\r\n                        'giren','cikan',\r\n                        'ekkomyuz','extrakomyuz','bankomyuz','kur',\r\n                        'ack','krekartno','olususer','olustarsaat','varno','vadetar','parabrm','PosIsle'\r\n                        */\r\n       \r\n       \r\n    \r\n            \r\n             select @PosHrkId=id From poshrk with (nolock) Where marsatid=@MarSatId     \r\n           \r\n            if isnull(@PosHrkId,0)=0\r\n            begin\r\n             insert into poshrk (Firmano,varno,gctip,marsatid,poskod,bankod,\r\n             carslip,cartip_id,cartip,car_id,carkod,\r\n             poshrkid,islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n             vadetar,tarih,saat,olususer,olustarsaat,\r\n             giren,cikan,kur,\r\n             ekkomyuz,extrakomyuz,bankomyuz,\r\n             parabrm,perkod,PosIsle)\r\n             values (@Firmano,@VarNo,'G',@MarSatId,@PosKod,@BankKod,\r\n             0,0,'',0,'',\r\n             0,'TAH','TAHSİLAT','POS','KREDİ KARTI TAHSİL',@YerTip,@YerTipAd,\r\n             @FisTarih,@FisTarih,@FisSaat,@OlusUser,GetDate(),\r\n             @Giren,abs(@Cikan),1,\r\n             0,0,0,\r\n             @ParaBirim,@PersonelKod,@VarPosIsle)\r\n\r\n             select @PosHrkId=SCOPE_IDENTITY() \r\n              \r\n             update poshrk set poshrkid=id where id=@PosHrkId\r\n\r\n           end \r\n           else\r\n            update poshrk set giren=@Giren,cikan=abs(@Cikan) where marsatid=@MarSatId \r\n       \r\n       end\r\n       \r\n       \r\n       \r\n       \r\n       \r\n       \r\n        /*satistop,iadetop,NakTop=satistop-iadetop, */\r\n        update MarSatMas Set KayOk=1,\r\n        NakTop=case When @KasaHrkId>0 then case when abs(@Cikan)>0 then @Cikan else abs(@FisTutar) end else 0 end,\r\n        PosTop=case When @PosHrkId>0 then case when abs(@Cikan)>0 then @Cikan else abs(@FisTutar) end else 0 end,\r\n        \r\n        islmtipad=case When @PosHrkId>0 then 'POS' else islmtipad end,\r\n        islmhrk=case When @PosHrkId>0 then 'KREDİ KARTI TAHSİL' else islmtipad end,\r\n        satistop=@Giren,\r\n        \r\n        iadetop=abs(@Cikan)\r\n        Where id=@MarSatId \r\n         \r\n         \r\n        fetch next from  CurMarSat into @FisTarihSaat,@FisNo,@FisTutar,@OdemeTip\r\n       \r\n     end\r\n      close CurMarSat\r\n      deallocate CurMarSat\r\n  \r\n\r\n\r\n    /*Kredi kartı */\r\n    \r\n  if @FiyatGuncelle=1\r\n   begin   \r\n    /*Satis Fiyat Update */\r\n    declare @Market_Sube bit\r\n    select @Market_Sube=Market_Sube from sistemtanim \r\n    \r\n    if isnull(@Market_Sube,0)=0    \r\n     begin \r\n     update stokkart set \r\n     Sat1Fiy=dt.Fiyat, \r\n     SatisFiyat1DegisimTarih=DATEADD(dd,0,DATEDIFF(dd,0,IslemTarih)) \r\n     from stokkart as t join \r\n     (Select StokId,Max(Fiyat) Fiyat,\r\n     Max(IslemTarih) IslemTarih from PromaksMarketSatisLog with (nolock) \r\n     Where GuidId=@GuidId and StokId is not null\r\n     group by StokId\r\n     ) dt on dt.StokId=t.id and t.Sat1Fiy<>dt.Fiyat\r\n    end \r\n    \r\n    if isnull(@Market_Sube,0)=1\r\n    begin\r\n    \r\n     update stok_fiyat set \r\n     Fiyat=dt.Fiyat, \r\n     FiyatDegisimTarih=DATEADD(dd,0,DATEDIFF(dd,0,IslemTarih)) \r\n     from stok_fiyat as t join \r\n     (Select StokId,Max(Fiyat) Fiyat,\r\n     Max(IslemTarih) IslemTarih from PromaksMarketSatisLog with (nolock) \r\n     Where GuidId=@GuidId and StokId is not null\r\n     group by StokId\r\n     ) dt on dt.StokId=t.Stk_id and t.Stktip_id=2\r\n     and t.FiyTip=2 and t.FiyNo=1 and t.Firmano=@Firmano \r\n     and t.Fiyat<>dt.Fiyat\r\n    \r\n    end  \r\n  end    \r\n\r\n\r\n     return\r\n\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "SpRehberMarketSatisKomisyon",
    "definition": "CREATE PROCEDURE dbo.SpRehberMarketSatisKomisyon\r\n@MarsatId    int\r\nAS\r\nBEGIN\r\n \r\n\r\n    \r\n    declare @islmtip \tvarchar(20)\r\n    declare @islmhrk \tvarchar(20)\r\n    declare @islmtipad \tvarchar(50)\r\n    declare @islmhrkad \tvarchar(50)\r\n    declare @carkod \tvarchar(30)\r\n    declare @rehberId    int\r\n    \r\n    declare @KomisyonTutar  float\r\n    declare @SatisTutar  float\r\n    declare @alacak  float\r\n    declare @borc  float\r\n    declare @newid  int\r\n    \r\n    set @KomisyonTutar=0\r\n    set @SatisTutar=0\r\n    set @alacak=0\r\n    set @borc=0\r\n    set @islmtip='SAT'\r\n    set @islmtipad='SATIŞ'\r\n    set @islmhrk='KMS'\r\n    set @islmhrkad='SATIŞ KOMİSYON'\r\n   \r\n\r\n    \r\n\r\n    set @rehberId=0\r\n    \r\n    select @rehberId=rehberId,@SatisTutar=(m.satistop-m.iadetop) From marsatmas as m with (nolock)  \r\n    where marsatid=@MarsatId and Sil=0\r\n    \r\n    \r\n    if  @rehberId=0\r\n    begin\r\n       update carihrk set sil=1,dataok=0,\r\n       TransferStartId=isnull(TransferStartId,0)+1 \r\n       where marsatid=@MarsatId and islmtip=@islmtip and islmhrk=@islmhrk\r\n       return\r\n    end\r\n    \r\n    \r\n    select @KomisyonTutar=sum( ((brmfiy*(1-indyuz))*h.kur)*(h.RehberKomisyonYuzde/100))\r\n    from marsathrk h with (nolock) inner join marsatmas as m  with (nolock)\r\n    on m.marsatid=h.marsatid  where h.marsatid=@MarsatId and m.Sil=0 and h.sil=0\r\n    \r\n   \r\n    if @SatisTutar<0\r\n     set @borc=@KomisyonTutar   \r\n    else\r\n      set @alacak=@KomisyonTutar\r\n    \r\n    select @carkod=kod from RehberKart with (nolock) \r\n    where Id=@rehberId\r\n    \r\n\r\n   /*insert */\r\n   if not EXISTS (Select id from carihrk where marsatid=@MarsatId \r\n   and islmtip=@islmtip and islmhrk=@islmhrk)\r\n    begin\r\n      insert into carihrk (firmano,carhrkid,gctip,masterid,\r\n      islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n      cartip_id,cartip,car_id,carkod,borc,alacak,bakiye,tarih,saat,\r\n      olususer,olustarsaat,vadetar,belno,\r\n      ack,varno,kur,dataok,pro,varok,perkod,\r\n      adaid,deguser,degtarsaat,sil,\r\n      parabrm,marsatid) \r\n     \r\n      select top 1 firmano,0,'G',@MarsatId,\r\n      @islmtip,@islmtipad,@islmhrk,@islmhrkad,yertip,yerad,\r\n      12,'rehberkart',@rehberId,@carkod,@borc,@alacak,0,tarih,saat,\r\n      olususer,olustarsaat,tarih,@MarsatId,\r\n      cast(@MarsatId as varchar(20))+' NOLU MARKET SATIŞ KOMİSYON',varno,kur,dataok,1,varok,'' as perkod,0 adaid,\r\n      deguser,degtarsaat,sil,\r\n      'TL',@MarsatId  from marsatmas as m with (nolock)  \r\n      where marsatid=@MarsatId and Sil=0\r\n      order by id\r\n      \r\n      select @newid=SCOPE_IDENTITY()\r\n      update carihrk set carhrkid=@newid where id=@newid  \r\n    \r\n    end\r\n    else\r\n     begin\r\n     \r\n       update carihrk set sil=dt.sil,dataok=0,\r\n       cartip_id=12,cartip='rehberkart',\r\n       car_id=@rehberId,carkod=@carkod,\r\n       tarih=dt.tarih,saat=dt.saat,vadetar=dt.tarih,\r\n       borc=@borc,alacak=@alacak,\r\n       deguser=dt.deguser,degtarsaat=dt.degtarsaat,\r\n       TransferStartId=isnull(TransferStartId,0)+1 \r\n       from carihrk as t join \r\n       ( select marsatid,tarih,saat,sil,deguser,degtarsaat from marsatmas as m with (nolock)  \r\n         where marsatid=@MarsatId) dt on dt.marsatid=t.marsatid\r\n         and t.islmtip=@islmtip and t.islmhrk=@islmhrk\r\n       \r\n     \r\n     \r\n     \r\n     end\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "SpSayimSatisMiktarHesapla",
    "definition": "CREATE PROCEDURE dbo.SpSayimSatisMiktarHesapla\r\n@SayimId   int\r\nAS\r\nBEGIN\r\n  \r\n  declare @SayimAcTarihSaat Datetime\r\n  declare @Firmano  int\r\n  declare @DepoKod  varchar(50)\r\n  \r\n  \r\n  declare @SatisMiktar  float\r\n  \r\n  set @SayimAcTarihSaat= null\r\n    \r\n  select @SayimAcTarihSaat=(tarih+cast(saat as datetime)),\r\n  @Firmano=Firmano,@DepoKod=depkod\r\n  from sayimmas Where id=@SayimId and Sil=0\r\n\r\n  if @SayimAcTarihSaat  is not null\r\n   begin\r\n\r\n  declare @id int\r\n  declare @StkKod varchar(50)\r\n  declare @StkTip varchar(20)\r\n  Declare @SayimTarihSaat  datetime\r\n  declare pom_var CURSOR FAST_FORWARD  FOR \r\n  select id,stkod,Stktip,OnlineSayimTarihSaat from SayimHrk with (nolock) \r\n  where sayid=@SayimId \r\n  and sil=0 and isnull(OnlineSayim,0)=1 \r\n   open pom_var\r\n  fetch next from  pom_var into @id,@StkKod,@Stktip,@SayimTarihSaat\r\n  while @@FETCH_STATUS=0\r\n   begin\r\n  \r\n   set @SatisMiktar=0\r\n   \r\n   Select @SatisMiktar=sum(cikan-giren) From stkhrk with (nolock) \r\n   where stktip=@StkTip and stkod=@StkKod and depkod=@DepoKod and Sil=0\r\n   and (tarih+cast(saat as datetime))>=@SayimAcTarihSaat  \r\n   and (tarih+cast(saat as datetime))<@SayimTarihSaat\r\n\r\n   update SayimHrk set sayimmik=OnlineSayimMiktar+isnull(@SatisMiktar,0),\r\n   OnlineSatisMiktar=isnull(@SatisMiktar,0)\r\n   Where id=@id\r\n\r\n  FETCH next from  pom_var into @id,@StkKod,@Stktip,@SayimTarihSaat\r\n  end\r\n close Pom_Var\r\n deallocate pom_var\r\n\r\nend\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "spStokKartOlustur",
    "definition": "CREATE PROCEDURE [dbo].[spStokKartOlustur]\r\n       @id DECIMAL=null, \r\n       @Epdk_Tur INT,\r\n       @Gtip NVARCHAR(4000),\r\n       @KarYuzde FLOAT,\r\n       @Prom BIT,\r\n       @Prom_Kac_Satis INT,\r\n       @Prom_Sat_Puan FLOAT,\r\n       @Prom_Sat_Tip TINYINT,\r\n       @Prom_Urun BIT,\r\n       @Puan_Brm  TINYINT,\r\n       @Puan_Fis FLOAT,\r\n       @Puan_KK FLOAT,\r\n       @Puan_Nakit FLOAT,\r\n       @Puan_Otomas FLOAT,\r\n       @Puan_Tip tinyint,\r\n       @Recete BIT,\r\n       @Remote_id INT,\r\n       @Restaurant BIT,\r\n       @YK_Fiyat INT,\r\n       @acmik FLOAT,\r\n       @ad NVARCHAR(4000),\r\n       @alsfiy FLOAT,\r\n       @alsiadekdvlitoptut FLOAT,\r\n       @alsiademik FLOAT,\r\n       @alskdv FLOAT,\r\n       @alskdvlitoptut FLOAT,\r\n       @alskdvtip NVARCHAR(4000),\r\n       @alsmik FLOAT,\r\n       @alspbrm NVARCHAR(4000),\r\n       @barkod NVARCHAR(4000),\r\n       @brim NVARCHAR(4000),\r\n       @brmcarp FLOAT,\r\n       @brmcarp2 FLOAT,\r\n       @brmust NVARCHAR(4000),\r\n       @brmust2 NVARCHAR(4000),\r\n       @dataok INT,\r\n       @degtarsaat datetime,\r\n       @deguser NVARCHAR(4000),\r\n       @drm  NVARCHAR(4000),\r\n       @eksat NVARCHAR(4000),\r\n       @firmano INT,\r\n       @grp1 INT,\r\n       @grp2 INT,\r\n       @grp3 INT,\r\n       @grpkdvoran FLOAT,\r\n       @karoran1 FLOAT,\r\n       @karoran2 FLOAT,\r\n       @kesft FLOAT,\r\n       @kod NVARCHAR(4000),\r\n       @minmik FLOAT,\r\n       @muh_als_iad_kod NVARCHAR(4000),\r\n       @muh_als_isk_kod NVARCHAR(4000),\r\n       @muh_als_otv_kod  NVARCHAR(4000),\r\n       @muh_sat_iad_kod NVARCHAR(4000),\r\n       @muh_sat_isk_kod NVARCHAR(4000),\r\n       @muh_sat_mal_kod NVARCHAR(4000),\r\n       @muh_sat_otv_kod NVARCHAR(4000),\r\n       @muhckskod NVARCHAR(4000),\r\n       @muhgrskod NVARCHAR(4000),\r\n       @muhonkod NVARCHAR(4000),\r\n       @notack NVARCHAR(4000),\r\n       @olustarsaat  datetime,\r\n       @olususer NVARCHAR(4000),\r\n       @ortalsfiykdvli FLOAT,\r\n       @otv FLOAT,\r\n       @ozel_kod1 INT,\r\n       @ozel_kod2 INT,\r\n       @sat1fiy FLOAT,\r\n       @sat1kdv FLOAT,\r\n       @sat1kdvtip NVARCHAR(4000),\r\n       @sat1pbrm NVARCHAR(4000),\r\n       @sat2fiy FLOAT,\r\n       @sat2kdv FLOAT,\r\n       @sat2kdvtip NVARCHAR(4000),\r\n       @sat2pbrm NVARCHAR(4000),\r\n       @sat3fiy FLOAT,\r\n       @sat3kdv FLOAT,\r\n       @sat3kdvtip NVARCHAR(4000),\r\n       @sat3pbrm NVARCHAR(4000),\r\n       @sat4fiy FLOAT,\r\n       @sat4kdv FLOAT,\r\n       @sat4kdvtip NVARCHAR(4000),\r\n       @sat4pbrm NVARCHAR(4000),\r\n       @satiadekdvlitoptut FLOAT,\r\n       @satiademik FLOAT,\r\n       @satkdvlitoptut FLOAT,\r\n       @satmik FLOAT,\r\n       @sil INT,\r\n       @tip NVARCHAR(4000),\r\n       @tip_id INT,\r\n       @ykno NVARCHAR(4000),\r\n       @zrapor tinyint\r\nAS\r\nBEGIN\r\n\r\n       DECLARE @AutoIncId BIGINT\r\n\r\n       SET @sat1fiy = Replace(@sat1fiy,',','.')\r\n       SET @sat2fiy = Replace(@sat1fiy,',','.')\r\n       SET @sat3fiy = Replace(@sat1fiy,',','.')\r\n       SET @sat4fiy = Replace(@sat1fiy,',','.')\r\n       SET @alsfiy = Replace(@alsfiy,',','.')\r\n\r\n       /* Eğer Remote_Id StokKart içinde yoksa */\r\n       IF NOT EXISTS (SELECT id FROM stokkart WHERE Remote_id = @Remote_id)\r\n       BEGIN\r\n             INSERT INTO [StokKart] ([tip], [kod], [firmano], [barkod], [ad], [sat1fiy], [sat1kdv], [sat1kdvtip], [sat2fiy], [sat2kdv], [sat2kdvtip], [alsfiy], [alskdv], [alskdvtip], [kesft], [brim], [otv], [eksat], [minmik], [drm], [muhgrskod], [muhckskod],  [brmcarp], [brmust], [ykno], [grp1], [grp2], [grp3], [alsmik], [satmik], [sil], [olususer], [olustarsaat], [deguser], [degtarsaat], [dataok], [acmik], [karoran1], [karoran2], [grpkdvoran], [sat1pbrm], [sat2pbrm], [sat3pbrm], [sat4pbrm], [alspbrm], [sat3fiy], [sat3kdv],  [sat3kdvtip], [sat4fiy], [sat4kdv], [sat4kdvtip], [alskdvlitoptut], [satkdvlitoptut], [alsiademik], [alsiadekdvlitoptut], [satiademik], [satiadekdvlitoptut], [ortalsfiykdvli], [brmust2], [brmcarp2], [zrapor], [muh_als_iad_kod], [muh_sat_iad_kod], [muh_als_isk_kod],  [muh_sat_isk_kod], [muh_als_otv_kod], [muh_sat_otv_kod], [muh_sat_mal_kod], [muhonkod], [ozel_kod1], [ozel_kod2], [notack], [tip_id], [Puan_Brm], [Puan_Tip], [Puan_Nakit], [Puan_KK], [Puan_Fis], [Prom], [Prom_Urun], [Prom_Sat_Tip], [Prom_Sat_Puan], [Prom_Kac_Satis],  [Puan_Otomas], [Gtip], [Epdk_Tur], [YK_Fiyat], [Recete], [Restaurant], [Remote_id], [KarYuzde]) values (@tip, @kod, @firmano, @barkod, @ad, @sat1fiy, @sat1kdv, @sat1kdvtip, @sat2fiy, @sat2kdv, @sat2kdvtip, @alsfiy, @alskdv, @alskdvtip, @kesft, @brim, @otv, @eksat,  @minmik, @drm, @muhgrskod, @muhckskod, @brmcarp, @brmust, @ykno, @grp1, @grp2, @grp3, @alsmik, @satmik, @sil, @olususer, @olustarsaat, @deguser, @degtarsaat, @dataok, @acmik, @karoran1, @karoran2, @grpkdvoran, @sat1pbrm, @sat2pbrm, @sat3pbrm, @sat4pbrm, @alspbrm,  @sat3fiy, @sat3kdv, @sat3kdvtip, @sat4fiy, @sat4kdv, @sat4kdvtip, @alskdvlitoptut, @satkdvlitoptut, @alsiademik, @alsiadekdvlitoptut, @satiademik, @satiadekdvlitoptut, @ortalsfiykdvli, @brmust2, @brmcarp2, @zrapor, @muh_als_iad_kod, @muh_sat_iad_kod, @muh_als_isk_kod,  @muh_sat_isk_kod, @muh_als_otv_kod, @muh_sat_otv_kod, @muh_sat_mal_kod, @muhonkod, @ozel_kod1, @ozel_kod2, @notack, @tip_id, @Puan_Brm, @Puan_Tip, @Puan_Nakit, @Puan_KK, @Puan_Fis, @Prom, @Prom_Urun, @Prom_Sat_Tip, @Prom_Sat_Puan, @Prom_Kac_Satis, @Puan_Otomas, @Gtip,  @Epdk_Tur, @YK_Fiyat, @Recete, @Restaurant, @Remote_id, @KarYuzde);\r\n             SET @AutoIncId = (SELECT CAST(SCOPE_IDENTITY()  AS BIGINT) AS [id])\r\n             INSERT INTO barkod(firmano,tip,kod,barkod,olususer,olustarsaat,sil,carpan,brim,tip_id,stk_id,Remote_id)\r\n             SELECT @firmano, 'markt', @kod, @barkod, @olususer, @olustarsaat, 0, @brmcarp,  @brim, @tip_id, @AutoIncId, @AutoIncId\r\n       END\r\n       ELSE\r\n       BEGIN\r\n             UPDATE [StokKart] SET [tip] = @tip, [kod] = @kod, [firmano] = @firmano, [barkod] = @barkod, [ad] = @ad, [sat1fiy] = @sat1fiy, [sat1kdv] = @sat1kdv, [sat1kdvtip] = @sat1kdvtip, [sat2fiy] = @sat2fiy, [sat2kdv] = @sat2kdv, [sat2kdvtip] = @sat2kdvtip,  [alsfiy] = @alsfiy, [alskdv] = @alskdv, [alskdvtip] = @alskdvtip, [kesft] = @kesft, [brim] = @brim, [otv] = @otv, [eksat] = @eksat, [minmik] = @minmik, [drm] = @drm, [muhgrskod] = @muhgrskod, [muhckskod] = @muhckskod, [brmcarp] = @brmcarp, [brmust] = @brmust, [ykno] =  @ykno, [grp1] = @grp1, [grp2] = @grp2, [grp3] = @grp3, [alsmik] = @alsmik, [satmik] = @satmik, [sil] = @sil, [olususer] = @olususer, [olustarsaat] = @olustarsaat, [deguser] = @deguser, [degtarsaat] = @degtarsaat, [dataok] = @dataok, [acmik] = @acmik, [karoran1] =  @karoran1, [karoran2] = @karoran2, [grpkdvoran] = @grpkdvoran, [sat1pbrm] = @sat1pbrm, [sat2pbrm] = @sat2pbrm, [sat3pbrm] = @sat3pbrm, [sat4pbrm] = @sat4pbrm, [alspbrm] = @alspbrm, [sat3fiy] = @sat3fiy, [sat3kdv] = @sat3kdv, [sat3kdvtip] = @sat3kdvtip, [sat4fiy] =  @sat4fiy, [sat4kdv] = @sat4kdv, [sat4kdvtip] = @sat4kdvtip, [alskdvlitoptut] = @alskdvlitoptut, [satkdvlitoptut] = @satkdvlitoptut, [alsiademik] = @alsiademik, [alsiadekdvlitoptut] = @alsiadekdvlitoptut, [satiademik] = @satiademik, [satiadekdvlitoptut] =  @satiadekdvlitoptut, [ortalsfiykdvli] = @ortalsfiykdvli, [brmust2] = @brmust2, [brmcarp2] = @brmcarp2, [zrapor] = @zrapor, [muh_als_iad_kod] = @muh_als_iad_kod, [muh_sat_iad_kod] = @muh_sat_iad_kod, [muh_als_isk_kod] = @muh_als_isk_kod, [muh_sat_isk_kod] =  @muh_sat_isk_kod, [muh_als_otv_kod] = @muh_als_otv_kod, [muh_sat_otv_kod] = @muh_sat_otv_kod, [muh_sat_mal_kod] = @muh_sat_mal_kod, [muhonkod] = @muhonkod, [ozel_kod1] = @ozel_kod1, [ozel_kod2] = @ozel_kod2, [notack] = @notack, [tip_id] = @tip_id, [Puan_Brm] =  @Puan_Brm, [Puan_Tip] = @Puan_Tip, [Puan_Nakit] = @Puan_Nakit, [Puan_KK] = @Puan_KK, [Puan_Fis] = @Puan_Fis, [Prom] = @Prom, [Prom_Urun] = @Prom_Urun, [Prom_Sat_Tip] = @Prom_Sat_Tip, [Prom_Sat_Puan] = @Prom_Sat_Puan, [Prom_Kac_Satis] = @Prom_Kac_Satis, [Puan_Otomas] =  @Puan_Otomas, [Gtip] = @Gtip, [Epdk_Tur] = @Epdk_Tur, [YK_Fiyat] = @YK_Fiyat, [Recete] = @Recete, [Restaurant] = @Restaurant, [Remote_id] = @Remote_id, [KarYuzde] = @KarYuzde where [id] = @id          \r\n       END\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "SpVeresiFisKmKontrol",
    "definition": "CREATE PROCEDURE dbo.SpVeresiFisKmKontrol\r\nAS\r\nBEGIN\r\n\r\n  update veresimas set OncekiKm=0 where OncekiKm is null\r\n\r\n  declare @id int\r\n  declare @sayac int\r\n  declare @cartip varchar(30)\r\n  declare @carkod varchar(30)\r\n  declare @plaka varchar(30)\r\n  declare @TarihSaat datetime\r\n  declare @km float\r\n  declare @oncekikm float\r\n  \r\n  \r\n  \r\n  declare @varno int\r\n  declare pom_varx CURSOR FAST_FORWARD  FOR \r\n  SELECT plaka from veresimas where Sil=0 and isnull(Km,0)>0\r\n  and plaka<>''\r\n  group by plaka\r\n   open pom_varx\r\n  fetch next from  pom_varx into @plaka\r\n  while @@FETCH_STATUS=0\r\n   begin\r\n  \r\n\r\n       set @sayac=0\r\n       \r\n        declare pom_var CURSOR FAST_FORWARD  FOR \r\n        SELECT id,cartip,carkod,km,tarih+isnull(saat,'00:00:00') TarihSaat \r\n         from veresimas where Sil=0\r\n         and isnull(Km,0)>0 and plaka=@plaka\r\n         /*and isnull(OncekiKm,0)=0 */\r\n         order by TarihSaat asc\r\n         open pom_var\r\n        fetch next from  pom_var into @id,@cartip,@carkod,@km,@TarihSaat\r\n        while @@FETCH_STATUS=0\r\n         begin\r\n        \r\n        if @sayac>0 \r\n         update veresimas set oncekikm=@oncekikm where id=@id  \r\n          \r\n         \r\n         set @oncekikm=@km \r\n         \r\n        set @sayac=@sayac+1 \r\n\r\n\r\n\r\n        FETCH next from  pom_var into @id,@cartip,@carkod,@km,@TarihSaat\r\n        end\r\n       close Pom_Var\r\n       deallocate pom_var\r\n       \r\n \r\n \r\n \r\n \r\n  FETCH next from  pom_varx into @plaka\r\n  end\r\n close Pom_Varx\r\n deallocate pom_varx\r\n \r\n \r\nEND"
  },
  {
    "schema": "dbo",
    "name": "SpVerFisTopluFatura",
    "definition": "CREATE PROCEDURE [dbo].[SpVerFisTopluFatura](\r\n@Firmano    int,\r\n@Fatrap_id   int,\r\n@Aktip      varchar(10),\r\n@FisTarih   bit,\r\n@Ortbrm     bit,\r\n@TutarSec  bit,\r\n@cartip     varchar(10),\r\n@carkod     varchar(30),\r\n@veridin    varchar(max),\r\n@tutar      float,\r\n@EFatSeriId    int, \r\n@EFatSeri        varchar(5),\r\n@EFatSeriNo      varchar(50),\r\n@EArsSeriId    int, \r\n@EArsSeri        varchar(5),\r\n@EArsSeriNo      varchar(50),\r\n@Fattarih   datetime,\r\n@Userad     varchar(50),\r\n@Ack        varchar(200),\r\n@iskTip\t    tinyint,\r\n@iskOran\tfloat,\r\n@EBelge     int )\r\nAS\r\n BEGIN\r\n \r\n set nocount on\r\n\r\n declare @trancount int\r\n set @trancount = @@trancount\r\n \r\n  BEGIN TRY\r\n  if @trancount = 0\r\n    BEGIN TRANSACTION\r\n\r\n  DECLARE @EKSTRE_TEMPAK TABLE (\r\n  verid      varchar(30))\r\n\r\n   declare @hrk_id        int\r\n   declare @hrk_verid     int\r\n   declare @fishrk_kaltut float\r\n   declare @fishrktut     float\r\n   declare @brmfiy        float\r\n   declare @gctip         varchar(1)\r\n   declare @giren         float\r\n   declare @cikan         float\r\n   declare @newid         int\r\n   declare @islmtip       varchar(20)\r\n   declare @islmhrk       varchar(20)\r\n   declare @yertip        varchar(20)\r\n   declare @yertipad      varchar(30)\r\n   declare @islmtipad     varchar(30)\r\n   declare @islmhrkad     varchar(30)\r\n   declare @saatx         varchar(8)\r\n   declare @tarx          datetime\r\n   declare @parabrm       varchar(8)\r\n   declare @parakur       float\r\n   declare @say           int\r\n   declare @mesaj         varchar(300)\r\n   declare @fatvadtip     varchar(20)\r\n   declare @fatvadsur     int\r\n   declare @vadtarih      datetime\r\n   declare @cartip_id\t  int\r\n   declare @car_id\t  \t  int\r\n   declare @fattip_id  \t  int\r\n   declare @fattur_id     int\r\n   declare @fattipad\t  varchar(100)\r\n   declare @fis_iskonto\t  float\r\n   declare @fis_isk_kart_kod   varchar(30)\r\n   declare @cari_unvan   varchar(150)\r\n   declare @kaptip\t\t varchar(30)\r\n   declare @fattip\t\t varchar(30)\r\n   \r\n   declare @Hrk_Stk_Pro    bit\r\n   declare @CariEfatura    bit\r\n   \r\n   declare   @AvansTakip  bit\r\n   declare   @Karsi_Cartipid  int\r\n   declare   @Karsi_Carid     int \r\n   \r\n   declare   @Karsi_Hrk_Pro   bit  \r\n   declare   @EBelgeSeriId    int\r\n   \r\n   declare @HataNo              int \r\n   declare @BelgeTipId          int\r\n   declare @BelgeSeri           varchar(5) \r\n   declare @BelgeSeriNo         varchar(50) \r\n   \r\n   \r\n  /* declare @fisno         int */\r\n   \r\n   declare @fatiskyuz     float\r\n   \r\n   set @HataNo=0\r\n   \r\n   \r\n   select @car_id=id,@cartip_id=tip_id,\r\n   @fis_iskonto=fis_iskonto,@CariEfatura=Efatura,\r\n   @cari_unvan=ad from Genel_Kart as k where \r\n   k.cartp=@cartip and k.kod=@carkod\r\n  \r\n   \r\n   set @BelgeTipId=0\r\n   \r\n   set @BelgeSeri=@EFatSeri\r\n   set @BelgeSeriNo=@EFatSeriNo\r\n   set @EBelgeSeriId=0\r\n   \r\n   \r\n   if @EBelge>0 \r\n   begin\r\n      set @BelgeTipId=2 \r\n      set @BelgeSeri=@EArsSeri\r\n      set @BelgeSeriNo=@EArsSeriNo\r\n      set @EBelgeSeriId=@EArsSeriId\r\n     \r\n     if @CariEfatura=1\r\n      begin\r\n        set @BelgeTipId=1\r\n        set @BelgeSeri=@EFatSeri\r\n        set @BelgeSeriNo=@EFatSeriNo\r\n        set @EBelgeSeriId=@EFatSeriId\r\n      end \r\n   end\r\n   \r\n   \r\n    if @isktip=1\r\n    set @iskoran=@fis_iskonto\r\n   \r\n   \r\n   \r\n   select @parabrm=sistem_parabrm from sistemtanim\r\n   \r\n   select @fis_isk_kart_kod=FisIskGiderKod from Firma Where id=@firmano\r\n   \r\n   set @tarx=convert(varchar,getdate(),101)\r\n   set @saatx=convert(varchar,getdate(),108)\r\n   \r\n\r\n   \r\n   if (@tutarsec=0) /*tutar girilmemissse */\r\n    begin\r\n       Insert @EKSTRE_TEMPAK\r\n       select * from CsvToInt_Max(@veridin)\r\n       \r\n       select @tutar=sum(case when v.fistip='FISVERSAT' THEN \r\n       (v.toptut-v.isktop) else -1*(v.toptut-v.isktop) end ) from veresimas as v with (nolock)\r\n        WHERE v.sil=0 and v.verid in (select * from @EKSTRE_TEMPAK)\r\n    end\r\n    \r\n    \r\n    set @tutar=round(@tutar,2)\r\n    \r\n   \r\n   if (@tutar>0) and (@tutarsec=1)  /*tutar girilmisse */\r\n   begin\r\n    set @fishrk_kaltut=@tutar\r\n\r\n    DECLARE VERFF_HRK CURSOR FAST_FORWARD FOR\r\n    SELECT  v.id,v.verid,Round((v.toptut-v.isktop),2) FROM veresimas as v with (nolock)\r\n    WHERE v.sil=0 and v.verid in (select * from CsvToInt_Max(@veridin))\r\n    order by v.id\r\n    OPEN VERFF_HRK\r\n    \r\n    FETCH NEXT FROM VERFF_HRK INTO\r\n    @hrk_id,@hrk_verid,@fishrktut\r\n    WHILE @@FETCH_STATUS = 0\r\n    BEGIN\r\n\r\n\r\n    if @fishrk_kaltut>0\r\n     Insert @EKSTRE_TEMPAK Values (@hrk_verid)\r\n\r\n\r\n\r\n     if round(@fishrk_kaltut,2)<round(@fishrktut,2)\r\n     begin\r\n      set @fishrk_kaltut=round(@fishrk_kaltut,2)\r\n      if round(@fishrk_kaltut,2)>0  \r\n       exec fisparcala @hrk_verid,@fishrk_kaltut\r\n      break\r\n     end\r\n\r\n      set @fishrk_kaltut=Round(@fishrk_kaltut-@fishrktut,2)\r\n\r\n\r\n    FETCH NEXT FROM VERFF_HRK INTO\r\n    @hrk_id,@hrk_verid,@fishrktut\r\n    END\r\n\r\n    CLOSE VERFF_HRK\r\n    DEALLOCATE VERFF_HRK\r\n  end  /*tutar girilmisse */\r\n  \r\n  \r\n    /*secilen fisler icinde aktarılmış var */\r\n     select @say=count(*) from veresimas as vs with (nolock) where \r\n     aktip not in ('BK','BL')\r\n     and vs.verid in (select * from @EKSTRE_TEMPAK)\r\n\r\n      if @say>0\r\n           begin\r\n           SELECT @MESAJ = 'Seçmiş Olduğunuz fişler içinde aktarılmış fişler var..!'\r\n           ROLLBACK TRANSACTION\r\n           RAISERROR (@MESAJ, 16,1)\r\n           RETURN\r\n       end\r\n   /*seçilen fişler */\r\n  \r\n  \r\n  \r\n  \r\n  /*---------cari aktarim */\r\n   if (@aktip='CH') or (@aktip='TEK_CH')\r\n    begin\r\n    \r\n      if @tutar>0\r\n      begin\r\n      set @cikan=0\r\n      set @giren=@tutar\r\n      set @gctip='B'\r\n      end\r\n      \r\n      if @tutar<0\r\n      begin\r\n      set @cikan=@tutar\r\n      set @giren=0\r\n      set @gctip='A'\r\n      end\r\n      \r\n      set  @islmtip='FIS'\r\n      set  @islmhrk='CAK'\r\n      set  @yertip='carikart'\r\n      select @yertipad=ad from yertipad where kod=@yertip\r\n      select @islmtipad=ad from islemturtip where tip=@islmtip\r\n      select @islmhrkad=ad from islemhrktip where tip=@islmtip and hrk=@islmhrk\r\n\r\n      \r\n       \r\n       IF (@aktip='TEK_CH') /*--ch tek cari hrk işlenmesi */\r\n       begin\r\n       \r\n       select @newid=0 \r\n       /*isnull(IDENT_CURRENT('carihrk'),0)+1   */\r\n\r\n        insert into carihrk (firmano,gctip,islmtip,islmtipad,\r\n        islmhrk,islmhrkad,yertip,yerad,\r\n        cartip_id,cartip,masterid,varno,carhrkid,perkod,\r\n        adaid,tarih,vadetar,saat,\r\n        car_id,carkod,\r\n        belno,ack,borc,alacak,kur,parabrm,olususer,olustarsaat,\r\n        fisfattip,fisaktip,fisid,plaka,surucu)\r\n        select @firmano,@gctip,@islmtip,@islmtipad,@islmhrk,\r\n        @islmhrkad,@yertip,@yertipad,\r\n        @cartip_id,@cartip,@newid,0,@newid,'',0,\r\n        case when @fistarih=0 then\r\n        @fattarih else tarih end,\r\n        vadtar,@saatx,\r\n        @car_id,@carkod,(vs.seri+vs.no),@ack+' PLAKA :'+vs.plaka+' SURUCU :'+vs.surucu, /*@ackfatno */\r\n        case when vs.fistip='FISVERSAT' THEN \r\n        (vs.toptut-vs.isktop)*(1-(@iskoran/100)) else 0 end,\r\n        case when fistip='FISALCSAT' THEN \r\n        toptut*(1-(@iskoran/100)) else 0 end,1,\r\n        @parabrm,@userad,getdate(),@islmhrk,\r\n        'CT',vs.verid,vs.plaka,vs.surucu\r\n        from veresimas as vs with (nolock) where \r\n        vs.verid in (select * from @EKSTRE_TEMPAK)\r\n        \r\n        select @newid=SCOPE_IDENTITY()\r\n        \r\n         if isnull(@newid,0)=0\r\n         begin\r\n           ROLLBACK TRANSACTION\r\n           RETURN\r\n         end\r\n         \r\n         \r\n        update carihrk set masterid=@newid,carhrkid=@newid where fisid in (select * from @EKSTRE_TEMPAK)\r\n        \r\n\r\n         update veresimas  set aktip='CT',akid=@newid,aktar=@fattarih\r\n         where verid in (select * from @EKSTRE_TEMPAK)\r\n         \r\n         \r\n         /*- iskonto kartı yansıt */\r\n         \r\n         \r\n         set @islmtip='GLG'  \r\n         set @islmhrk='FSI'\r\n         select @islmtipad=ad from islemturtip where tip=@islmtip\r\n         select @islmhrkad=ad from islemhrktip where tip=@islmtip and hrk=@islmhrk\r\n\r\n          \r\n        if @iskoran>0\r\n        insert into carihrk (firmano,gctip,islmtip,islmtipad,\r\n        islmhrk,islmhrkad,yertip,yerad,\r\n        cartip_id,cartip,masterid,varno,carhrkid,perkod,\r\n        adaid,tarih,vadetar,saat,\r\n        car_id,carkod,\r\n        belno,ack,borc,alacak,kur,parabrm,olususer,olustarsaat,\r\n        fisfattip,fisaktip,fisid,plaka,surucu)\r\n        select @firmano,@gctip,@islmtip,@islmtipad,@islmhrk,\r\n        @islmhrkad,@yertip,@yertipad,\r\n        3,'gelgidkart',@newid,0,@newid,'',0,\r\n        case when @fistarih=0 then\r\n        @fattarih else tarih end,\r\n        vadtar,@saatx,\r\n        0,@fis_isk_kart_kod,(vs.seri+vs.no),'FİŞ İSKONTO / CARI KOD '+\r\n        @carkod+' CARI ÜNVANI '+@cari_unvan+' %'+\r\n        cast(@iskoran as varchar(20))+\r\n        ' ( '+cast( round(((vs.toptut-vs.isktop)),2)  as varchar(20))+\r\n        ' ) ',\r\n        case when vs.fistip='FISVERSAT' THEN \r\n        (vs.toptut-vs.isktop)*(@iskoran/100) else 0 end,\r\n        case when fistip='FISALCSAT' THEN \r\n        toptut*(@iskoran/100) else 0 end,1,\r\n        @parabrm,@userad,getdate(),@islmhrk,'CT',vs.verid,'',''\r\n        from veresimas as vs with (nolock) where  \r\n        vs.verid in (select * from @EKSTRE_TEMPAK)\r\n               \r\n       \r\n      end /*--ch tek cari hrk işlenmesi */\r\n\r\n      if (@aktip='CH')/*ch toplu cari hrk işlenmesi */\r\n      begin\r\n      \r\n       select @newid=0 \r\n      \r\n      insert into carihrk (firmano,gctip,islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n      cartip_id,cartip,masterid,varno,carhrkid,perkod,adaid,tarih,vadetar,saat,\r\n      car_id,carkod,\r\n      belno,ack,borc,alacak,kur,parabrm,olususer,olustarsaat,\r\n      fisfattip,fisaktip,fisid)\r\n      select @firmano,@gctip,@islmtip,@islmtipad,@islmhrk,@islmhrkad,\r\n      @yertip,@yertipad,\r\n      @cartip_id,@cartip,@newid,0,@newid,'',0,\r\n      @fattarih,@fattarih,@saatx,\r\n      @car_id,@carkod,(@BelgeSeri+@BelgeSeriNo),@ack,\r\n      @giren*(1-(@iskoran/100)),(-1*@cikan)*(1-(@iskoran/100)),\r\n      1,@parabrm,@userad,getdate(),@islmhrk,\r\n      @aktip,0\r\n      \r\n       select @newid=SCOPE_IDENTITY()\r\n      \r\n         if isnull(@newid,0)=0\r\n         begin\r\n           ROLLBACK TRANSACTION\r\n           RETURN\r\n         end\r\n      \r\n      \r\n      update carihrk set masterid=@newid,carhrkid=@newid where id=@newid\r\n\r\n      update veresimas  set aktip='CH',akid=@newid,aktar=@fattarih\r\n       where verid in (select * from @EKSTRE_TEMPAK)\r\n         \r\n         \r\n      /*-iskonto yansÄ±masÄ±   */\r\n      \r\n      if @iskoran>0 \r\n      insert into carihrk (firmano,gctip,islmtip,islmtipad,\r\n        islmhrk,islmhrkad,yertip,yerad,\r\n        cartip_id,cartip,masterid,varno,carhrkid,perkod,\r\n        adaid,tarih,vadetar,saat,\r\n        car_id,carkod,\r\n        belno,ack,borc,alacak,kur,parabrm,olususer,olustarsaat,\r\n        fisfattip,fisaktip,fisid,plaka,surucu)\r\n        select @firmano,@gctip,@islmtip,@islmtipad,@islmhrk,\r\n        @islmhrkad,@yertip,@yertipad,\r\n        3,'gelgidkart',@newid,0,@newid,'',0,\r\n        @fattarih,@fattarih,@saatx,\r\n        0,@fis_isk_kart_kod,(@BelgeSeri+@BelgeSeriNo),'FİŞ İSKONTO / CARI KOD '+\r\n        @carkod+' CARI ÜNVANI '+@cari_unvan+' %'+\r\n        cast(@iskoran as varchar(20))+\r\n        ' ( '+cast( round((( ABS(@giren+@cikan))),2)  as varchar(20))+\r\n        ' ) ',\r\n        @giren*(@iskoran/100),(-1*@cikan)*(@iskoran/100), \r\n        1,@parabrm,@userad,getdate(),@islmhrk,@aktip,0,'',''\r\n        \r\n         \r\n\r\n      end/*---aktip ch */\r\n      \r\n      \r\n      \r\n\r\n    end\r\n\r\n /*------cari aktarim */\r\n\r\n  if @aktip='FT'\r\n   begin\r\n   select @gctip=f.gctip,\r\n   @fattip=r.rapkod,\r\n   @fattip_id=tip_id,\r\n   @fattur_id=tur_id,\r\n   @fattipad=r.ack\r\n  /* @Hrk_Stk_Pro=r.hrk_stk_pro */\r\n   from raporlar r left join fattip f on f.kod=r.rapkod \r\n   where r.sil=0  and r.id=@fatrap_id\r\n    /*'FATVERSAT' */\r\n  \r\n  \r\n  \r\n      set @Hrk_Stk_Pro=0\r\n      set @kaptip='VER'\r\n      if @fattip='FATTTSSAT'\r\n      begin\r\n       set @kaptip='FAT'\r\n       set @Hrk_Stk_Pro=1\r\n      end \r\n       \r\n       \r\n      set  @islmtip=@fattip\r\n      /*'FATVERSAT' */\r\n      set  @islmhrk='satis'\r\n      set  @yertip='carikart'\r\n      select @yertipad=ad from yertipad where kod=@yertip\r\n      /*select @islmtipad=ad from fattip where kod=@islmtip */\r\n\r\n    set @vadtarih=@fattarih\r\n    \r\n    if @cartip='carikart'\r\n     begin\r\n      select @fatvadtip=k.fatvadtip,@fatvadsur=k.fatvadsur,\r\n      @fatiskyuz=k.fatisk,\r\n      @Karsi_Cartipid=1,\r\n      @Karsi_Carid=fat_car_id,\r\n      @Karsi_Hrk_Pro=fat_car_sec,\r\n      @AvansTakip=AvansTakip \r\n      from carikart as k with (nolock) where\r\n      k.kod=@carkod\r\n      select @vadtarih=dbo.vadtarihver (@fatvadtip,@fatvadsur,@fattarih)\r\n     end\r\n     \r\n     \r\n      /*select @newid=isnull(max(fatid),0)+1 from faturamas */\r\n      \r\n      \r\n     if @BelgeTipId>0\r\n      begin\r\n         if len(@BelgeSeri)<3 \r\n         begin\r\n           set @HataNo=1\r\n           SELECT @MESAJ = 'EFatura Seri uyuşmazlılık mevcuttur, 3 hane olmalıdır...!'\r\n           ROLLBACK TRANSACTION\r\n           RAISERROR (@MESAJ, 16,1)\r\n           RETURN \r\n          end \r\n        \r\n      \r\n         if len(@BelgeSeriNo)>10  \r\n         begin\r\n           if DATEPART(yyyy,@fattarih)<>SUBSTRING(@BelgeSeriNo,1,4) \r\n            begin\r\n             set @HataNo=1\r\n             SELECT @MESAJ = 'EFatura Tarihi İle EFatura Seri no uyuşmazlığı mevcuttur...!'\r\n             ROLLBACK TRANSACTION\r\n             RAISERROR (@MESAJ, 16,1)\r\n             RETURN\r\n            end  \r\n          end \r\n      \r\n      end \r\n      \r\n      \r\n\r\n      if EXISTS (select id From faturamas with (nolock)\r\n      where Firmano=@firmano and cartip=@cartip \r\n      and carkod=@carkod and Sil=0 and gctip=2 and Sil=0\r\n      and fatseri=@BelgeSeri and fatno=@BelgeSeriNo) \r\n       begin\r\n           set @HataNo=1\r\n           SELECT @MESAJ = @BelgeSeri+@BelgeSeriNo+' Fatura No Önceden Kullanılmıştır..!'\r\n           ROLLBACK TRANSACTION\r\n           RAISERROR (@MESAJ, 16,1)\r\n           RETURN \r\n       end\r\n\r\n      insert into faturamas (firmano,\r\n      gctip,fatrap_id,fattip_id,fattur_id,\r\n      fatad,fatid,tarih,vadtar,saat,yuvtop,\r\n      gen_ind_tip,geniskyuz,genisktop,\r\n      fattip,fattur,fatseri,fatno,\r\n      cartip_id,cartip,car_id,carkod,kdvtip,ack,\r\n      olususer,olustarsaat,deguser,degtarsaat,\r\n      parabrm,kur,kaptip,kayok,hrk_car_pro,hrk_stk_pro,\r\n      Karsi_Cartip_id,Karsi_Car_id,Hrk_Karsi_Pro,AvansTakip,\r\n      EBelgeTipId,EBelgeSeriId      \r\n      )\r\n      select @firmano,@gctip,@fatrap_id,@fattip_id,@fattur_id,\r\n      @fattipad,0,@fattarih,@vadtarih,@saatx,0,\r\n      0,0,0,\r\n      @islmtip,@islmhrk,@BelgeSeri,@BelgeSeriNo,\r\n      @cartip_id,@cartip,@car_id,@carkod,'Hariç',@ack,/*'TOPLU FATURALANDIRMA' */\r\n      @userad,GETDATE(),'',null,@parabrm,1,@kaptip,0,1,@Hrk_Stk_Pro,\r\n      @Karsi_Cartipid,@Karsi_Carid,@Karsi_Hrk_Pro,@AvansTakip,\r\n      @BelgeTipId,@EBelgeSeriId\r\n      \r\n      select @newid=SCOPE_IDENTITY()\r\n      \r\n      if isnull(@newid,0)=0\r\n       begin\r\n           SELECT @MESAJ = 'Faturamas @newid error '\r\n           ROLLBACK TRANSACTION\r\n           RAISERROR (@MESAJ, 16,1)\r\n           RETURN\r\n       end\r\n      \r\n      update faturamas  set fatid=@newid where id=@newid\r\n      \r\n      \r\n      \r\n      if @BelgeTipId>0\r\n       begin \r\n        if @BelgeTipId=1\r\n          set @BelgeSeriNo=cast(@EFatSeriNo as bigint)+1 \r\n        if @BelgeTipId=2\r\n          set @BelgeSeriNo=cast(@EArsSeriNo as bigint)+1\r\n       end\r\n      else\r\n        set @BelgeSeriNo=cast(@BelgeSeriNo as bigint)+1  \r\n     \r\n          \r\n    \r\n      if @ortbrm=1\r\n        insert into faturahrk \r\n        (firmano,fatid,stktip_id,stktip,stk_id,stkod,mik,brim,ustbrim,carpan,\r\n        brmfiy,depkod,kdvtip,\r\n        kdvyuz,kdvtut,satiskyuz,satisktut,otvbrim,otvyuz,otvtut,olususer,olustarsaat,\r\n        parabrim,Kart_ParaBrm,Kart_kur,OtoTag)\r\n        \r\n        select @firmano,@newid,stktip_id,stktip,stk_id,stkod,sum(mik),brim,\r\n        brim,1, round(sum( ( ( (brmfiy*(1-(iskyuz/100)) ) / (1+kdvyuz) ) * mik )),12)\r\n        / sum(mik),'','Hariç',Kdvyuz,\r\n        0,\r\n        0,0,0,0,0,@userad,getdate(),'TL','TL',1,OtoTag\r\n        from veresihrk as h WITH (NOLOCK) \r\n        inner join veresimas as m WITH (NOLOCK)\r\n        on m.verid=h.verid and m.sil=0 and h.sil=0 \r\n        where m.verid in (select * from @EKSTRE_TEMPAK)\r\n        group by stktip_id,stktip,stk_id,stkod,iskyuz,brim,kdvyuz,OtoTag\r\n      else\r\n        insert into faturahrk (firmano,fatid,stktip_id,stktip,stk_id,stkod,mik,brim,ustbrim,carpan,brmfiy,depkod,kdvtip,\r\n        kdvyuz,kdvtut,satiskyuz,satisktut,otvbrim,otvyuz,otvtut,olususer,olustarsaat,\r\n        parabrim,Kart_ParaBrm,Kart_kur,OtoTag)\r\n        \r\n        select @firmano,@newid,stktip_id,stktip,stk_id,stkod,sum(mik),brim,brim,1,\r\n        round(cast((brmfiy*(1-(isnull(iskyuz,0)/100)))/(1+kdvyuz) as float),12),'','Dahil',\r\n        kdvyuz,0,0,0,0,0,0,@userad,getdate(),'TL','TL',1,OtoTag\r\n        from veresihrk h WITH (NOLOCK) \r\n        inner join veresimas as m WITH (NOLOCK)\r\n        on m.verid=h.verid and m.sil=0 and h.sil=0 \r\n        where m.verid in (select * from @EKSTRE_TEMPAK)\r\n        group by stktip_id,stktip,stk_id,stkod,\r\n        round(cast((brmfiy*(1-(isnull(iskyuz,0)/100)))/(1+kdvyuz) as float),12),\r\n        iskyuz,brim,kdvyuz,OtoTag\r\n        \r\n        \r\n        /*Depo Kart TTS ise */\r\n        if @fattip='FATTTSSAT'\r\n         update faturahrk set Depkod=dt.Kod,dep_id=dt.id From faturahrk as t join\r\n         (select id,Kod,Bagak From tankkart as t where t.sil=0 ) dt\r\n         on dt.Bagak=T.stkod and t.fatid=@newid\r\n                 \r\n\r\n\r\n        update veresimas  set aktip='FT',\r\n        akid=@newid,\r\n        fatid=@newid,aktar=@fattarih\r\n        where verid in (select * from @EKSTRE_TEMPAK)\r\n        \r\n        update faturamas  set kayok=1 where fatid=@newid\r\n\r\n        \r\n        exec Fatura_Cari_Stok_Iskonto @newid\r\n        \r\n        \r\n        exec Fatura_Genel_indirim @newid,0,@fatiskyuz\r\n   \r\n        \r\n        update faturamas  set kayok=1 where fatid=@newid\r\n    end\r\n\r\n   select @newid as fatid,@HataNo HataNo,@BelgeTipId BelgeTipId,\r\n   @BelgeSeri BelgeSeri,@BelgeSeriNo BelgeSeriNo \r\n\r\n\r\n   COMMIT TRANSACTION\r\n END TRY\r\n  BEGIN CATCH\r\n  \r\n        declare @error int, @message varchar(4000), @xstate int;\r\n        select @error = ERROR_NUMBER(), \r\n        @message = ERROR_MESSAGE(), @xstate = XACT_STATE();\r\n        if @xstate = -1\r\n            rollback\r\n        if @xstate = 1 and @trancount = 0\r\n            rollback\r\n        if @xstate = 1 and @trancount > 0\r\n            rollback transaction SpVerFisTopluFatura;\r\n\r\n        /*raiserror ('VerFisTopluFatura: %d: %s', 16, 1, @error, @message) ; */\r\n\r\n        raiserror ('%s',16, 1, @message) \r\n\r\n  END CATCH\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "SpYazarKasaServisMarketVardiyaAc",
    "definition": "CREATE PROCEDURE dbo.SpYazarKasaServisMarketVardiyaAc\r\n@Firmano         int,\r\n@Tarih           Datetime,\r\n@Saat            varchar(20),\r\n@OlusUser        varchar(50),\r\n@DepoKod         Varchar(30),\r\n@PersonelKod Varchar(30),\r\n@ZNo\t\t\t int,\r\n@YazKNo\t\t     int,\r\n@VardiyaNo       int\r\nAS\r\nBEGIN\r\n\r\n   Declare @KasaKod Varchar(20)\r\n   Declare @VardiyaAd Varchar(100)\r\n   Declare @ParaBirim Varchar(20)\r\n   Declare @ReturnId      int\r\n   Declare @Kur\t\t\tfloat\r\n   Declare @YeniVarNo   int\r\n       \r\n   \r\n   \r\n     select top 1 @YeniVarNo=\r\n     CONVERT(int,SUBSTRING(varad,1,CHARINDEX('.',varad)-1)) from marvardimas with (nolock) \r\n       where ISNUMERIC(SUBSTRING(varad,1,case when CHARINDEX('.',varad)=0 \r\n       then 1 else CHARINDEX('.',varad) end))=1 \r\n       and CHARINDEX('.',varad)>0 and sil=0 and firmano=@Firmano\r\n       order by id desc\r\n   \r\n   \r\n    /*- select @YeniVarNo= max(CONVERT(int,SUBSTRING(varad,1,CHARINDEX('.',varad)-1)))   */\r\n    /*   from marvardimas with (nolock)  */\r\n      /* where ISNUMERIC(SUBSTRING(varad,1,case when CHARINDEX('.',varad)=0 then 1 else CHARINDEX('.',varad) end))=1  */\r\n     /*   and CHARINDEX('.',varad)>0 and sil=0 and firmano=@Firmano */\r\n        \r\n     if isnull(@YeniVarNo,0)=0  \r\n       set @VardiyaAd='1. VARDİYA' \r\n      else\r\n       set @VardiyaAd=cast(@YeniVarNo+1 as varchar(10))+'. VARDİYA'  \r\n     \r\n   \r\n      \r\n   insert into marvardimas \r\n   (firmano,tarih,saat,olususer,olustarsaat,\r\n   kas_kod,bozukpara,varad,varno,depkod,perkod,parabrm,kur,\r\n   ZNo,Yaz_KNo,Kaptar,kapsaat,YazarKasaServis,YazarKasaVardiyaNo)\r\n   values \r\n   (@Firmano,@Tarih,@Saat,@OlusUser,GetDate(),\r\n   @KasaKod,0,@VardiyaAd,0,@DepoKod,@PersonelKod,@ParaBirim,@Kur,\r\n   @ZNo,@YazKNo,null,null,1,@VardiyaNo)\r\n   \r\n   select @ReturnId=SCOPE_IDENTITY() \r\n\r\n    update marvardimas Set varno=@ReturnId Where id=@ReturnId\r\n\r\n\r\n   return @ReturnId\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "SpYazarKasaServisMarketVardiyaKontrol",
    "definition": "CREATE PROCEDURE dbo.SpYazarKasaServisMarketVardiyaKontrol\r\n@Firmano       int,\r\n@DepoKod      varchar(30),\r\n@PersonelKod      varchar(30),\r\n@Tip              int   /*1 zno 2 vardiyaNo */\r\nAS\r\nBEGIN\r\n\r\n\r\n    declare @T Table (\r\n     MarSatId        int   \r\n    \r\n    )\r\n    \r\n\r\n\r\n\r\n     /*declare @Firmano       int */\r\n     declare @VarNo \t\tint\r\n     declare @Zno \t\t\tint\r\n     declare @KasaNo \t\tint\r\n     declare @FisNo\t\t\tint \r\n     declare @AcilisTarihSaat \tDatetime\r\n     declare @KapanisTarihSaat \tDatetime\r\n    /* declare @Tutar        \tfloat */\r\n     declare @FisTutar        \tfloat\r\n     declare @MarSatId      int\r\n     declare @OlusUser      varchar(100) \r\n     declare @YazarKasaServisLogId       int\r\n     declare @KasaHrkId         int\r\n     \r\n     \r\n     declare @AcilisTarih Datetime\r\n     declare @AcilisSaat  varchar(8)\r\n     \r\n     \r\n     declare @FisTarihSaat Datetime\r\n     declare @FisTarih Datetime\r\n     declare @FisSaat  varchar(8)\r\n     declare @YazarKasaVardiyaNo \t\tint\r\n\r\n     \r\n     \r\n     /*declare @DepoKod      varchar(30) */\r\n     /*declare @PersonelKod Varchar(30) */\r\n\r\n     declare @KdvTip      varchar(30)\r\n     declare @IslemTip      varchar(30)\r\n     declare @IslemTipAd      varchar(30)\r\n     declare @YerTip      varchar(30)\r\n     declare @YerTipAd      varchar(50)\r\n     Declare @ParaBirim Varchar(20)\r\n     \r\n     declare @Barkod  varchar(30)\r\n     declare @StokKod  varchar(30)\r\n     declare @StokTip  varchar(30)\r\n     declare @StokTipAd  varchar(30)\r\n     declare @Birim      varchar(20)\r\n     declare @StokId      int\r\n     declare @StokTipId      int\r\n     declare @Miktar      Float\r\n     declare @BirimFiyat      Float\r\n     declare @KdvYuz      Float\r\n     \r\n     \r\n     \r\n     declare @Giren      Float\r\n     declare @Cikan      Float\r\n     \r\n     \r\n    Set @KdvTip='Dahil'\r\n    Set @Islemtip='satis'\r\n    Set @IslemTipAd='SATIÅ'\r\n    Set @YerTip='yazarkasaservis'\r\n    Set @YerTipAd='YAZAR SERVIS AKTARIM'\r\n    Set @ParaBirim='TL' \r\n    Set @OlusUser='YAZARKASA SERVIS' \r\n    \r\n    \r\n    if @DepoKod=''\r\n      set @DepoKod='M0001'\r\n    \r\n   if @PersonelKod='' \r\n    set @PersonelKod='P0001'\r\n    \r\n    \r\n    set @StokTip='markt'\r\n    set @StokTipAd='MARKET'\r\n    set @StokTipId=2\r\n    \r\n    \r\n     if @Tip=1 \r\n     declare CurMarVar CURSOR FAST_FORWARD  FOR \r\n     Select top 1 Firmano,Zno,0 VardiyaNo,KasaNo,\r\n     Min(Tarih) AcilisTarih,\r\n     Max(Tarih) KapanisTarih\r\n     from Yazarkasa_Satis with (nolock) \r\n     Where Trans=0 and Firmano=@Firmano and Zno is not null\r\n\t group by Firmano,Zno,KasaNo\r\n\t Order by Zno desc\r\n    \r\n    if @Tip=2 \r\n     declare CurMarVar CURSOR FAST_FORWARD  FOR  \r\n     Select top 1 Firmano,0 Zno,VardiyaNo,KasaNo,\r\n     Min(Tarih) AcilisTarih,\r\n     Max(Tarih) KapanisTarih\r\n     from Yazarkasa_Satis with (nolock) \r\n     Where Trans=0 and Firmano=@Firmano and VardiyaNo is not null\r\n\t group by Firmano,VardiyaNo,KasaNo\r\n\t Order by VardiyaNo desc\r\n    \r\n    \r\n     \r\n     open CurMarVar\r\n    fetch next from  CurMarVar into @Firmano,@Zno,@YazarKasaVardiyaNo,@KasaNo,\r\n    @AcilisTarihSaat,@KapanisTarihSaat\r\n     while @@FETCH_STATUS=0\r\n      begin\r\n  \r\n      set @VarNo=0\r\n      \r\n      \r\n      \r\n      set @AcilisTarih=DATEADD(dd,0,DATEDIFF(dd,0,@AcilisTarihSaat))   \r\n      set @AcilisSaat=CONVERT(VARCHAR(8),@AcilisTarihSaat,108) \r\n\r\n\r\n      /*MarVardiMas Kontrol ve Olustur  */ \r\n      \r\n      if @Tip=1\r\n      Select @VarNo=id From marvardimas with (nolock) \r\n        where firmano=@Firmano and Yaz_KNo=@KasaNo And Zno=@Zno and Sil=0 and isnull(Varok,0)=0\r\n        \r\n      if @Tip=2\r\n       Select @VarNo=id From marvardimas with (nolock) \r\n         where firmano=@Firmano and Yaz_KNo=@KasaNo And YazarKasaVardiyaNo=@YazarKasaVardiyaNo and Sil=0 and isnull(Varok,0)=0   \r\n        \r\n\r\n       if isnull(@VarNo,0)=0\r\n        exec @Varno=SpYazarKasaServisMarketVardiyaAc \r\n         @Firmano,@AcilisTarih,@AcilisSaat,@OlusUser,@DepoKod,@PersonelKod,\r\n         @Zno,@KasaNo,@YazarKasaVardiyaNo\r\n      \r\n      /*MarSatMas Kontrol ve Olustur  */ \r\n\r\n       if @Tip=1\r\n       declare CurMarSat CURSOR FAST_FORWARD  FOR \r\n       Select Tarih,FisNo,@Zno,Sum(Carpan*Tutar) Tutar from Yazarkasa_Satis with (nolock) \r\n       Where Trans=0 and Zno=@Zno and KasaNo=@KasaNo\r\n       Group By Tarih,FisNo\r\n       \r\n       if @Tip=2\r\n       declare CurMarSat CURSOR FAST_FORWARD  FOR \r\n       Select Tarih,FisNo,Zno,Sum(Carpan*Tutar) Tutar from Yazarkasa_Satis with (nolock) \r\n       Where Trans=0 and VardiyaNo=@YazarKasaVardiyaNo and KasaNo=@KasaNo\r\n       Group By Tarih,FisNo,Zno\r\n       \r\n       \r\n       \r\n\t    \r\n        open CurMarSat\r\n       fetch next from  CurMarSat into @FisTarihSaat,@FisNo,@Zno,@FisTutar\r\n       while @@FETCH_STATUS=0\r\n         begin\r\n                  \r\n         \r\n         \r\n         Set @MarSatId=0\r\n         \r\n         set @FisTarih=DATEADD(dd,0,DATEDIFF(dd,0,@FisTarihSaat))   \r\n         set @FisSaat=CONVERT(VARCHAR(8),@FisTarihSaat,108) \r\n         \r\n         Select @MarSatId=id From marsatmas with (nolock) \r\n         where Varno=@VarNo And Fis_No=@FisNo and Zno=@Zno and Sil=0\r\n   \r\n         if isnull(@MarSatId,0)=0\r\n          begin\r\n            insert into marsatmas (Firmano,varno,marsatid,islmtip,islmtipad,yertip,yerad,\r\n            tarih,saat,kayok,olususer,olustarsaat,yazarkasa_id,Fis_No,YazarKasaIslemId,\r\n            parabrm,cartip,carkod,Zno)\r\n            values (@Firmano,@VarNo,0,@IslemTip,@IslemTipAd,@YerTip,@YerTipAd,\r\n            @FisTarih,@FisSaat,0,@OlusUser,GetDate(),0,@FisNo,0,\r\n            @ParaBirim,'vardikasa','VRDKASA',@Zno)\r\n\r\n            select @MarSatId=SCOPE_IDENTITY()\r\n            \r\n            insert into @T (MarSatId) values (@MarSatId) \r\n          \r\n            update marsatmas set marsatid=id where id=@MarSatId\r\n          end\r\n          \r\n          \r\n        /* \r\n         marsatmas,marsatid,\r\n         Firmano,varno,islmtip,islmtipad,yertip,yerad,tarih,saat,\r\n         kayok,olususer,olustarsaat,yazarkasa_id,Fis_No,YazarKasaIslemId],\r\n         [DB_Ayar.Firmano,varno,islmtip,IslmTip_Ad,Yertip,Yertip_Ad,formatdatetime('yyyymmdd',Satis_Rec[0].TarihSaat),\r\n         formatdatetime('hh:mm:ss',Satis_Rec[0].TarihSaat),0,'YKASA SERVIS',formatdatetime('yyyymmdd hh:mm:ss',now),\r\n         Satis_Rec[0].Id,Satis_Rec[0].Fis_No,Satis_Rec[0].YazarKasaIslemId])\r\n         */\r\n         \r\n         \r\n         \r\n         \r\n          /* MarsatHrk Kontrol ve Olustur   */ \r\n          if @Tip=1\r\n           declare CurMarSatHrk CURSOR FAST_FORWARD  FOR \r\n           Select id,StokId,StokKod,Barkod,Carpan*Miktar,BrimFiyat,Kdv,Brim  \r\n           from Yazarkasa_Satis with (nolock) \r\n           Where Trans=0 and Zno=@Zno and KasaNo=@KasaNo and FisNo=@FisNo\r\n           \r\n           \r\n           if @Tip=2 \r\n           declare CurMarSatHrk CURSOR FAST_FORWARD  FOR \r\n           Select id,StokId,StokKod,Barkod,Carpan*Miktar,BrimFiyat,Kdv,Brim  \r\n           from Yazarkasa_Satis with (nolock) \r\n           Where Trans=0 and VardiyaNo=@YazarKasaVardiyaNo and KasaNo=@KasaNo and FisNo=@FisNo\r\n           and Zno=@Zno\r\n           \r\n           open CurMarSatHrk\r\n           fetch next from  CurMarSatHrk into @YazarKasaServisLogId,\r\n           @StokId,@StokKod,@Barkod,@Miktar,@BirimFiyat,@KdvYuz,@Birim  \r\n           while @@FETCH_STATUS=0\r\n            begin \r\n               \r\n           insert into marsathrk (Firmano,varno,islmtip,islmtipad,perkod,depkod,\r\n            yertip,yerad,satfiyno,tarih,saat,marsatid,barkod,\r\n            stk_id,stkod,stktip_id,stktip,stktipad,mik,brim,\r\n            brmfiy,kdvtip,kdvyuz,olususer,olustarsaat,YazarKasaServisLogId)\r\n           values (@Firmano,@VarNo,@IslemTip,@IslemTipAd,@PersonelKod,@DepoKod,\r\n            @YerTip,@YerTipAd,1,@FisTarih,@FisSaat,@MarSatId,\r\n            @Barkod,@StokId,@StokKod,@StokTipId,@StokTip,@StokTipAd,@Miktar,@Birim,\r\n            @BirimFiyat,@KdvTip,@KdvYuz/100,@OlusUser,GetDate(),@YazarKasaServisLogId)\r\n\r\n            update YazarKasa_Satis Set Trans=1 Where id=@YazarKasaServisLogId\r\n\r\n               \r\n           fetch next from  CurMarSatHrk into @YazarKasaServisLogId,\r\n          @StokId,@StokKod,@Barkod,@Miktar,@BirimFiyat,@KdvYuz,@Birim\r\n       end\r\n       close CurMarSatHrk\r\n       deallocate CurMarSatHrk\r\n         \r\n        \r\n       /*Markart Kasa */\r\n        set @Giren=0\r\n        set @Cikan=0\r\n        \r\n        \r\n        Select @FisTutar=Sum(mik*brmfiy) from marsathrk with (nolock)\r\n         where  marsatid=@MarSatId\r\n             \r\n        if @FisTutar>0\r\n          set @Giren=@FisTutar\r\n        else\r\n          set @Cikan=@FisTutar \r\n          \r\n          \r\n        set @KasaHrkId=0     \r\n        select @KasaHrkId=id From markasahrk with (nolock) Where marsatid=@MarSatId     \r\n       \r\n       if isnull(@KasaHrkId,0)=0\r\n        begin\r\n        insert into markasahrk (Firmano,varno,gctip,marsatid,kaskod,\r\n         kashrkid,islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n         tarih,saat,olususer,olustarsaat,giren,cikan,kur,parabrm,perkod)\r\n        values (@Firmano,@VarNo,'G',@MarSatId,'VRDKASA',\r\n         0,'TAH','TAHSÄ°LAT','NAK','NAKÄ°T TAHSÄ°LAT',@YerTip,@YerTipAd,\r\n         @FisTarih,@FisSaat,@OlusUser,GetDate(),\r\n         @Giren,@Cikan,1,@ParaBirim,@PersonelKod)\r\n\r\n         select @KasaHrkId=SCOPE_IDENTITY() \r\n          \r\n         update markasahrk set kashrkid=id where id=@KasaHrkId\r\n\r\n       end \r\n       else\r\n         update markasahrk set giren=@Giren,cikan=abs(@Cikan) where marsatid=@MarSatId \r\n\r\n       \r\n       \r\n        /*satistop,iadetop,NakTop=satistop-iadetop, */\r\n        update MarSatMas Set KayOk=1,\r\n        NakTop=case when abs(@Cikan)>0 then @Cikan else abs(@FisTutar) end,\r\n        satistop=@Giren,iadetop=abs(@Cikan)\r\n        Where id=@MarSatId\r\n   \r\n         \r\n         \r\n        fetch next from  CurMarSat into @FisTarihSaat,@FisNo,@Zno,@FisTutar\r\n       \r\n     end\r\n      close CurMarSat\r\n      deallocate CurMarSat\r\n  \r\n         \r\n\r\n       fetch next from  CurMarVar into @Firmano,@Zno,@YazarKasaVardiyaNo,@KasaNo,\r\n       @AcilisTarihSaat,@KapanisTarihSaat \r\n     end\r\n      close CurMarVar\r\n      deallocate CurMarVar\r\n\r\n\r\n\r\n\r\n   /* oklenmemis kayit kontrolu  */\r\n     update marsatmas set kayok=0 where \r\n     marsatid in (\r\n     select marsatid \r\n     from marsathrk with (nolock)\r\n     where sil=0 \r\n     and varno=@VarNo and id not in \r\n     (select stkhrkid from stkhrk\r\n     with (nolock)  where \r\n      varno=@VarNo and sil=0 \r\n      and tabload='marsathrk') \r\n      group by marsatid  )\r\n    \r\n    \r\n     update marsatmas set kayok=1 where \r\n     marsatid in (\r\n     select marsatid \r\n     from marsathrk with (nolock) \r\n     where sil=0 \r\n     and varno=@VarNo and id not in \r\n     (select stkhrkid  from stkhrk\r\n     with (nolock) where \r\n      varno=@VarNo and sil=0 \r\n      and tabload='marsathrk')\r\n      group by marsatid )\r\n    \r\n    /*\r\n     declare CurMarSatx CURSOR FAST_FORWARD  FOR \r\n       Select t.MarSatId  from @T as t \r\n       inner join marsatmas as m with (nolock) on m.id=t.MarSatId\r\n       and m.KayOk=0\r\n       \r\n       open CurMarSatx\r\n        fetch next from  CurMarSatx into @MarSatId  \r\n         while @@FETCH_STATUS=0\r\n            begin  \r\n\r\n            update MarSatMas Set KayOk=1 Where id=@MarSatId\r\n   \r\n        fetch next from  CurMarSatx into @MarSatId\r\n      end\r\n      close CurMarSatx\r\n      deallocate CurMarSatx\r\n*/\r\n     return\r\n\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "stkhrktipolustur",
    "definition": "CREATE PROCEDURE [dbo].stkhrktipolustur\r\nAS\r\nBEGIN\r\n\r\ntruncate table stkhrktip\r\n\r\ninsert into stkhrktip (kod,ad,gc) values('KARTAC','KART AÇILIŞ','GC');\r\ninsert into stkhrktip (kod,ad,gc) values('DEVIR','DEVİR İŞLEMİ','GC');\r\n/*------FATURA */\r\ninsert into stkhrktip (kod,ad,gc) values('FATAKALS','AKARYAKIT ALIŞ FATURASI','G');\r\ninsert into stkhrktip (kod,ad,gc) values('FATMRALS','MARKET ALIŞ FATURASI','G');\r\ninsert into stkhrktip (kod,ad,gc) values('FATGGALS','GELİR GİDER ALIŞ FATURASI','G');\r\ninsert into stkhrktip (kod,ad,gc) values('FATYGALS','YAĞ ALIŞ FATURASI','G');\r\n\r\ninsert into stkhrktip (kod,ad,gc) values('FATVERSAT','VERESIYE SATIŞ FATURASI','C');\r\ninsert into stkhrktip (kod,ad,gc) values('FATGGSAT','GELİR GİDER SATIŞ FATURASI','C');\r\ninsert into stkhrktip (kod,ad,gc) values('FATTOPSAT','TOPTAN SATIŞ FATURASI','C');\r\ninsert into stkhrktip (kod,ad,gc) values('FATPERSAT','PERAKENDE SATIŞ FATURASI','C');\r\n\r\ninsert into stkhrktip (kod,ad,gc) values('FATIADALS','ALIŞTAN IADE FATURASI','C');\r\ninsert into stkhrktip (kod,ad,gc) values('FATIADSAT','SATIŞTAN IADE FATURASI','G');\r\n\r\n\r\n/*--IRSALIYE */\r\ninsert into stkhrktip (kod,ad,gc) values('IRSAKALS','AKARYAKIT ALIŞ İRSALİYESİ','G');\r\ninsert into stkhrktip (kod,ad,gc) values('IRSMRALS','MARKET ALIŞ İRSALİYESİ','G');\r\ninsert into stkhrktip (kod,ad,gc) values('IRSYGALS','YAĞ ALIŞ İRSALİYESİ','G');\r\n\r\ninsert into stkhrktip (kod,ad,gc) values('IRSAKSAT','AKARYAKIT SATIŞ İRSALİYESİ','C');\r\ninsert into stkhrktip (kod,ad,gc) values('IRSMRSAT','MARKET SATIŞ İRSALİYESİ','C');\r\ninsert into stkhrktip (kod,ad,gc) values('IRSYGSAT','YAĞ SATIŞ İRSALİYESİ','C');\r\n\r\n/*VERESIYE */\r\ninsert into stkhrktip (kod,ad,gc) values('FISVERSAT','VERESİYE SATIŞ','C');\r\n\r\n/*-POPMACI */\r\ninsert into stkhrktip (kod,ad,gc) values('POMSAYSAT','SAYAÇ SATIŞ','C');\r\ninsert into stkhrktip (kod,ad,gc) values('POMMARSAT','YAĞ-EMTİA SATIŞ','C');\r\n\r\n/*-POMPACI TRANSFER İŞLEM */\r\ninsert into stkhrktip (kod,ad,gc) values('POMTRANS','SAYAÇ TRANSFER','C');\r\n\r\n/*-MARKET */\r\ninsert into stkhrktip (kod,ad,gc) values('MARSAT','MARKET SATIŞ','C');\r\ninsert into stkhrktip (kod,ad,gc) values('MARIAD','MARKET İADE','G');\r\n\r\n/*-SAYIM */\r\ninsert into stkhrktip (kod,ad,gc) values('SAYSON','SAYIM SONUC','GC');\r\n\r\n/*-DEPO TRANSFER */\r\ninsert into stkhrktip (kod,ad,gc) values('DEPTRAN','DEPO TRANSFER','GC');\r\n\r\n/*-SAYAC YAG DOK */\r\ninsert into stkhrktip (kod,ad,gc) values('YAGDOK','SAYAÇA YAĞ DÖK','GC');\r\n\r\n\r\n/*-FİRE TRANSFER */\r\ninsert into stkhrktip (kod,ad,gc) values('STKFIRE','FİRE KAYDI','GC');\r\n\r\n/*-HARICI İŞLEM */\r\ninsert into stkhrktip (kod,ad,gc) values('HARGIRCIK','HARİCİ GİRİŞ ÇIKIŞ','GC');\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "stokbakiye",
    "definition": "CREATE PROCEDURE [dbo].stokbakiye @id float\r\nAS\r\nBEGIN\r\n\r\n\r\n  DECLARE @kalan           float\r\n  declare @idx              float\r\n  declare @giren            float\r\n  declare @cikan            float\r\n  declare @stktip varchar(20),@depkod varchar(20),@stkod varchar(20)\r\n/*\r\n  select @stktip=stktip,@depkod=depkod,@stkod=stkod from stkhrk where id=@id\r\n  \r\n\r\n    select @kalan=isnull(sum(giren-cikan),0) from stkhrk where depkod=@depkod and stktip=@stktip and\r\n    stkod=@stkod and id< @id;\r\n\r\n    set @kalan=isnull(@kalan,0);\r\n\r\n\r\n  DECLARE stokbakiyeduz CURSOR FAST_FORWARD FOR\r\n    SELECT id,giren,cikan FROM stkhrk WHERE depkod=@depkod and stktip=@stktip and\r\n    stkod=@stkod and id >= @id order by id\r\n\r\n  OPEN stokbakiyeduz\r\n\r\n  FETCH NEXT FROM stokbakiyeduz INTO @idx,@giren,@cikan\r\n  WHILE @@FETCH_STATUS = 0\r\n  BEGIN\r\n\r\n   update stkhrk set kalan=@kalan+(@giren-@cikan),pro=0 where id=@idx\r\n\r\n   set @kalan=@kalan+(@giren-@cikan);\r\n\r\n\r\n    FETCH NEXT FROM stokbakiyeduz  INTO @idx,@giren,@cikan\r\n  END\r\n\r\n  CLOSE stokbakiyeduz\r\n  DEALLOCATE stokbakiyeduz\r\n\r\n*/\r\n\r\n\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "stokfiyhistory",
    "definition": "CREATE PROCEDURE [dbo].stokfiyhistory @id int\r\nAS\r\nBEGIN\r\n\r\n\r\n insert into stokfiyathistory (kod,tip,sat1fiy,sat1kdv,sat1kdvtip,\r\n sat2fiy,sat2kdv,sat2kdvtip,alsfiy,alskdv,alskdvtip)\r\n select kod,tip,sat1fiy,sat1kdv,sat1kdvtip,\r\n sat2fiy,sat2kdv,sat2kdvtip,alsfiy,alskdv,alskdvtip from stokkart where id=@id\r\n  \r\n  \r\n  \r\n  \r\nEND"
  },
  {
    "schema": "dbo",
    "name": "stokhrkisle",
    "definition": "CREATE PROCEDURE [dbo].stokhrkisle \r\n@islmid \t\tfloat,\r\n@tabload \t\tvarchar(50),\r\n@cevstkod \t\tvarchar(30),\r\n@kayok \t\t\tint,\r\n@sil \t\t\tint,\r\n@AnaKay_id\t\tfloat\r\nAS\r\nBEGIN\r\n/*-marketkart */\r\n\r\n  declare @islmtip \tvarchar(20)\r\n  declare @islmtipad \tvarchar(30)\r\n  declare @newid \t\tfloat\r\n  declare @islmtip1 \tvarchar(20)\r\n  declare @islmtipad1 varchar(30)\r\n  declare @say \t\tfloat\r\n  declare @stktip \tvarchar(20)\r\n  declare @market_depo    varchar(30)\r\n\r\n \r\n declare @islmhrk varchar(20)\r\n declare @islmhrkad varchar(30)\r\n\r\n\r\n\r\n/*-market satis */\r\n  if @tabload='marsathrk'\r\n   begin\r\n \r\n  /*delete from stkhrk from stkhrk with(nolock) where tabload=@tabload  */\r\n  /*and (marsatid>0 and marsatid=@AnaKay_id) */\r\n  \r\n  \r\n  /* update stkhrk Set Sil=1  where tabload=@tabload and Sil=0 */\r\n /*  and (marsatid>0 and marsatid=@AnaKay_id) */\r\n  \r\n\r\n  if (@kayok=1) /*and (@sil=0) */\r\n  begin\r\n   select @islmtip=kod,@islmtipad=ad   from stkhrktip where kod='MARSAT'\r\n   select @islmtip1=kod,@islmtipad1=ad from stkhrktip where kod='MARIAD'\r\n\r\n   /*Update Recetesiz Urun Ve Receteli Ana Urun */\r\n   update stkhrk Set firmano=dt.firmano,sil=dt.sil,\r\n   stk_id=dt.stk_id,stkod=dt.stkod,barkod=dt.barkod,\r\n   tarih=dt.tarih,saat=dt.saat,\r\n   stktip_id=dt.stktip_id,stktip=dt.stktip,\r\n  /* degistarsaat=dt.degistarsaat,degisuser=dt.degisuser, */\r\n   islmtip=dt.islmtip,islmtipad=dt.islmtipad,\r\n   yertip=dt.yertip,yerad=dt.yerad,\r\n   giren=dt.giren,cikan=dt.cikan,siademik=dt.siademik,\r\n   depkod=dt.depkod,brmfiykdvli=dt.brmfiykdvli,\r\n   kdvyuz=dt.kdvyuz,belno=dt.belno,ack=dt.ack\r\n   from stkhrk as t join \r\n    ( select h.id,m.firmano,h.sil,\r\n      stk_id,stkod,h.barkod,m.tarih,m.saat,stktip_id,stktip,\r\n      /*m.degistarsaat,m.degisuser, */\r\n      case when m.islmtip='iade' then @islmtip1 else @islmtip end islmtip,\r\n      case when m.islmtip='iade' then @islmtipad1 else @islmtipad end islmtipad,\r\n      m.yertip,m.yerad,m.marsatid,\r\n      case when m.islmtip='iade' then mik else 0 end giren,\r\n      case when m.islmtip='satis' then mik else 0 end cikan,\r\n      case when m.islmtip='iade' then mik else 0 end siademik,\r\n      depkod,(brmfiy*(1-indyuz))*h.kur brmfiykdvli,kdvyuz ,\r\n      LTRIM(STR(m.marsatid, 25, 0))  belno,\r\n      (select top 1 cast(varad as varchar)+' MARKET SATIŞI' \r\n      from marvardimas with (nolock) where varno=m.varno and m.sil=0) ack,\r\n      m.varno\r\n      from marsathrk h with (nolock)\r\n      inner join marsatmas as m  with (nolock)\r\n      on m.marsatid=h.marsatid\r\n      where h.marsatid=@AnaKay_id /*and isnull(h.Recete,0)=0 */\r\n      and h.id in (Select stkhrkid From stkhrk with (nolock) \r\n      where marsatid=@AnaKay_id ) ) dt \r\n      on dt.id=t.stkhrkid and dt.marsatid=t.marsatid \r\n\r\n\r\n      /*Update Urun Receteli Ana Urun Giris Hrk */\r\n       update stkhrk Set firmano=dt.firmano,sil=dt.sil,\r\n       UrunId=dt.UrunId,stk_id=dt.stk_id,stkod=dt.stkod,barkod=dt.barkod,\r\n       tarih=dt.tarih,saat=dt.saat,\r\n       stktip_id=dt.stktip_id,stktip=dt.stktip,\r\n      /* degistarsaat=dt.degistarsaat,degisuser=dt.degisuser, */\r\n       islmtip=dt.islmtip,islmtipad=dt.islmtipad,\r\n       yertip=dt.yertip,yerad=dt.yerad,\r\n       giren=dt.giren,cikan=dt.cikan,siademik=dt.siademik,\r\n       depkod=dt.depkod,brmfiykdvli=dt.brmfiykdvli,\r\n       kdvyuz=dt.kdvyuz,belno=dt.belno,ack=dt.ack\r\n      from stkhrk as t join \r\n      ( select h.id,rh.MarSatRecHrkId RecHrkId,rh.UrunId,m.firmano,h.sil,\r\n      h.Stk_id as stk_id,h.stkod as stkod,\r\n      h.barkod,m.tarih,m.saat,\r\n      h.stktip_id as stktip_id,h.stktip as stktip,\r\n      /*m.degistarsaat,m.degisuser, */\r\n      case when m.islmtip='iade' then @islmtip1 else @islmtip end islmtip,\r\n      case when m.islmtip='iade' then @islmtipad1 else @islmtipad end islmtipad,\r\n      m.yertip,m.yerad,m.marsatid,\r\n      case when m.islmtip='iade' then 0 else mik end giren,\r\n      case when m.islmtip='satis' then 0 else mik end cikan,\r\n      case when m.islmtip='iade' then 0 else mik end siademik,\r\n      depkod,(rh.BirimMaliyetFiyat/mik) brmfiykdvli,kdvyuz ,\r\n      LTRIM(STR(m.marsatid, 25, 0))  belno,\r\n      (select top 1 cast(varad as varchar)+' MARKET SATIŞI' \r\n      from marvardimas with (nolock) where varno=m.varno and m.sil=0) ack,\r\n      m.varno\r\n      from marsathrk h with (nolock)\r\n      inner join marsatmas as m  with (nolock)\r\n      on m.marsatid=h.marsatid\r\n      inner join V_MarketSatisUrunIdReceteMaliyet as rh \r\n      on rh.MarSatId=m.marsatid and rh.MarSatHrkId=h.id\r\n      where h.marsatid=@AnaKay_id and isnull(h.Recete,0)=1  \r\n      and EXISTS (SELECT id FROM stkhrk as sh with (nolock) \r\n      WHERE sh.marsatid=@AnaKay_id and h.id = sh.stkhrkid  \r\n      and rh.MarSatRecHrkId = isnull(sh.MarSatRecHrkId,0) )\r\n      /*and h.id in (Select stkhrkid From stkhrk with (nolock)  */\r\n      /*where marsatid=@AnaKay_id )  */\r\n      ) dt \r\n      on dt.id=t.stkhrkid and dt.marsatid=t.marsatid and dt.RecHrkId=t.MarSatRecHrkId \r\n\r\n\r\n\r\n      /*Update Urun Recete Hrk */\r\n       update stkhrk Set firmano=dt.firmano,sil=dt.sil,\r\n       UrunId=dt.UrunId,stk_id=dt.stk_id,stkod=dt.stkod,barkod=dt.barkod,\r\n       tarih=dt.tarih,saat=dt.saat,\r\n       stktip_id=dt.stktip_id,stktip=dt.stktip,\r\n      /* degistarsaat=dt.degistarsaat,degisuser=dt.degisuser, */\r\n       islmtip=dt.islmtip,islmtipad=dt.islmtipad,\r\n       yertip=dt.yertip,yerad=dt.yerad,\r\n       giren=dt.giren,cikan=dt.cikan,siademik=dt.siademik,\r\n       depkod=dt.depkod,brmfiykdvli=dt.brmfiykdvli,\r\n       kdvyuz=dt.kdvyuz,belno=dt.belno,ack=dt.ack\r\n      from stkhrk as t join \r\n      ( select h.id,rh.Id RecHrkId,rh.UrunId,m.firmano,h.sil,\r\n      rh.StokId as stk_id,rh.StokKod as stkod,\r\n      h.barkod,m.tarih,m.saat,\r\n      rh.StokTipId as stktip_id,rh.StokTip as stktip,\r\n      /*m.degistarsaat,m.degisuser, */\r\n      case when m.islmtip='iade' then @islmtip1 else @islmtip end islmtip,\r\n      case when m.islmtip='iade' then @islmtipad1 else @islmtipad end islmtipad,\r\n      m.yertip,m.yerad,m.marsatid,\r\n      case when m.islmtip='iade' then rh.miktar else 0 end giren,\r\n      case when m.islmtip='satis' then rh.miktar else 0 end cikan,\r\n      case when m.islmtip='iade' then rh.miktar else 0 end siademik,\r\n      depkod,BirimFiyat brmfiykdvli,kdvyuz ,\r\n      LTRIM(STR(m.marsatid, 25, 0))  belno,\r\n      (select top 1 cast(varad as varchar)+' MARKET SATIŞI' \r\n      from marvardimas with (nolock) where varno=m.varno and m.sil=0) ack,\r\n      m.varno\r\n      from marsathrk h with (nolock)\r\n      inner join marsatmas as m  with (nolock)\r\n      on m.marsatid=h.marsatid\r\n      inner join MarSatRecHrk as rh with (nolock) on \r\n      Rh.MarSatHrkId=H.id \r\n      where h.marsatid=@AnaKay_id and isnull(h.Recete,0)=1 and rh.UretimTipId=1 \r\n      and EXISTS (SELECT id FROM stkhrk as sh with (nolock) \r\n      WHERE sh.marsatid=@AnaKay_id and h.id = sh.stkhrkid  and rh.Id = isnull(sh.MarSatRecHrkId,0) )\r\n      /*and h.id in (Select stkhrkid From stkhrk with (nolock)  */\r\n      /*where marsatid=@AnaKay_id )  */\r\n      ) dt \r\n      on dt.id=t.stkhrkid and dt.marsatid=t.marsatid and dt.RecHrkId=t.MarSatRecHrkId \r\n       \r\n      \r\n      \r\n      \r\n      \r\n      \r\n      \r\n\r\n      /*insert  Recetesiz Urun Ve Receteli Ana Urun  */\r\n      insert stkhrk (firmano,stkhrkid,\r\n      stk_id,stkod,barkod,tarih,saat,stktip_id,stktip,olustarsaat,olususer,islmtip,\r\n      islmtipad,yertip,yerad,marsatid,giren,cikan,siademik,\r\n      depkod,brmfiykdvli,kdvyuz,tabload,belno,ack,varno)\r\n      \r\n      select m.firmano,h.id,\r\n      stk_id,stkod,h.barkod,m.tarih,m.saat,stktip_id,stktip,m.olustarsaat,m.olususer,\r\n      case when m.islmtip='iade' then @islmtip1 else @islmtip end,\r\n      case when m.islmtip='iade' then @islmtipad1 else @islmtipad end,\r\n      m.yertip,m.yerad,m.marsatid,\r\n      case when m.islmtip='iade' then mik else 0 end,\r\n      case when m.islmtip='satis' then mik else 0 end,\r\n      case when m.islmtip='iade' then mik else 0 end,\r\n      depkod,(brmfiy*(1-indyuz))*h.kur,kdvyuz,@tabload,\r\n      LTRIM(STR(m.marsatid, 25, 0))  belno,\r\n      (select top 1 cast(varad as varchar)+' MARKET SATIŞI' \r\n      from marvardimas with (nolock) where varno=m.varno and m.sil=0),\r\n      m.varno\r\n      from marsathrk h with (nolock)\r\n      inner join marsatmas as m  with (nolock)\r\n      on m.marsatid=h.marsatid\r\n      and m.sil=0 and h.sil=0\r\n      where h.marsatid=@AnaKay_id and h.sil=0 \r\n      /*and isnull(h.Recete,0)=0 */\r\n      and h.id not in (Select stkhrkid From stkhrk with (nolock) \r\n      where marsatid=@AnaKay_id and isnull(MarSatRecHrkId,0)=0 )\r\n      \r\n      \r\n      /*insert Receteli Urun Giris Hrk */\r\n      insert stkhrk (firmano,stkhrkid,\r\n      stk_id,stkod,barkod,tarih,saat,stktip_id,stktip,olustarsaat,olususer,islmtip,\r\n      islmtipad,yertip,yerad,marsatid,giren,cikan,siademik,\r\n      depkod,brmfiykdvli,kdvyuz,tabload,belno,ack,varno,MarSatRecHrkId,UrunId)\r\n      \r\n      select m.firmano,h.id,\r\n      stk_id,stkod,h.barkod,m.tarih,m.saat,stktip_id,stktip,m.olustarsaat,m.olususer,\r\n      case when m.islmtip='iade' then @islmtip1 else @islmtip end,\r\n      case when m.islmtip='iade' then @islmtipad1 else @islmtipad end,\r\n      m.yertip,m.yerad,m.marsatid,\r\n      case when m.islmtip='iade' then 0 else mik end,\r\n      case when m.islmtip='satis' then 0 else mik end,\r\n      case when m.islmtip='iade' then 0 else mik end,\r\n      depkod,(rm.BirimMaliyetFiyat/mik),kdvyuz,@tabload,\r\n      LTRIM(STR(m.marsatid, 25, 0))  belno,\r\n      (select top 1 cast(varad as varchar)+' MARKET SATIŞI' \r\n      from marvardimas with (nolock) where varno=m.varno and m.sil=0),\r\n      m.varno,rm.MarSatRecHrkId,rm.UrunId\r\n      from marsathrk h with (nolock)\r\n      inner join marsatmas as m  with (nolock)\r\n      on m.marsatid=h.marsatid and m.sil=0 and h.sil=0\r\n      inner join V_MarketSatisUrunIdReceteMaliyet as rm \r\n      on rm.MarSatId=m.marsatid and rm.MarSatHrkId=h.id\r\n      where h.marsatid=@AnaKay_id and h.sil=0 \r\n      and isnull(h.Recete,0)=1\r\n      and NOT EXISTS (SELECT id FROM stkhrk as sh with (nolock) \r\n      WHERE sh.marsatid=@AnaKay_id and h.id = sh.stkhrkid  \r\n      AND rm.MarSatRecHrkId = isnull(sh.MarSatRecHrkId,0) )\r\n      \r\n     /* and h.id not in (Select stkhrkid From stkhrk with (nolock) \r\n      where marsatid=@AnaKay_id and isnull(MarSatRecHrkId,0)=0 )\r\n     */ \r\n      \r\n      \r\n      \r\n      /*insert Urun Recete Hrk */\r\n      insert stkhrk (firmano,stkhrkid,\r\n      stk_id,stkod,barkod,tarih,saat,stktip_id,stktip,olustarsaat,olususer,islmtip,\r\n      islmtipad,yertip,yerad,marsatid,giren,cikan,siademik,\r\n      depkod,brmfiykdvli,kdvyuz,tabload,belno,ack,varno,MarSatRecHrkId,UrunId)\r\n      \r\n      select m.firmano,h.id,\r\n      rh.StokId,rh.StokKod,h.barkod,m.tarih,m.saat,\r\n      rh.StokTipId,rh.StokTip,m.olustarsaat,m.olususer,\r\n      case when m.islmtip='iade' then @islmtip1 else @islmtip end,\r\n      case when m.islmtip='iade' then @islmtipad1 else @islmtipad end,\r\n      m.yertip,m.yerad,m.marsatid,\r\n      case when m.islmtip='iade' then rh.Miktar else 0 end,\r\n      case when m.islmtip='satis' then rh.Miktar else 0 end,\r\n      case when m.islmtip='iade' then rh.Miktar else 0 end,\r\n      depkod,rh.BirimFiyat,kdvyuz,@tabload,\r\n      LTRIM(STR(m.marsatid, 25, 0))  belno,\r\n      (select top 1 cast(varad as varchar)+' MARKET SATIŞI' \r\n      from marvardimas with (nolock) where varno=m.varno and m.sil=0),\r\n      m.varno,rh.Id,rh.UrunId\r\n      from marsathrk h with (nolock)\r\n      inner join marsatmas as m  with (nolock)\r\n      on m.marsatid=h.marsatid\r\n      and m.sil=0 and h.sil=0\r\n      inner join MarSatRecHrk as Rh with (nolock) on \r\n      Rh.MarSatHrkId=H.id and Rh.Sil=0     \r\n      where h.marsatid=@AnaKay_id and h.sil=0 \r\n      and isnull(h.Recete,0)=1 and rh.UretimTipId=1 /*recete */\r\n      and NOT EXISTS (SELECT id FROM stkhrk as sh with (nolock) \r\n      WHERE sh.marsatid=@AnaKay_id and h.id = sh.stkhrkid  AND rh.Id = isnull(sh.MarSatRecHrkId,0) )\r\n\r\n    /*  and h.id not in (Select stkhrkid From stkhrk with (nolock) \r\n      where marsatid=@AnaKay_id and isnull(MarSatRecHrkId,0)>0 )\r\n     */ \r\n     \r\n      \r\n     \r\n     /*delete  */\r\n     update stkhrk set Sil=1 where marsatid=@AnaKay_id\r\n     and stkhrkid not in (select h.id  from marsathrk h with (nolock)\r\n      inner join marsatmas as m  with (nolock)\r\n      on m.marsatid=h.marsatid  where h.marsatid=@AnaKay_id)\r\n    \r\n    \r\n      \r\n    end\r\n\r\n\r\n    exec SpLog_MarketSatis @AnaKay_id\r\n    exec SpLog_MarketSatisHareket @AnaKay_id\r\n   \r\n    exec SpLog_MarketSatisUrunHareket @AnaKay_id\r\n\r\n\r\n   RETURN\r\n  end\r\n/*------------------------------------------------------------------------------------------- */\r\n\r\n\r\n /*-Resturant satis */\r\n  if @tabload='ResSatHrk'\r\n   begin\r\n /* \r\n  delete from stkhrk from stkhrk with(nolock) where tabload=@tabload \r\n  and (ResSatId>0 and ResSatId=@AnaKay_id)\r\n  */\r\n  if (@kayok=1) /*and (@sil=0) */\r\n  begin\r\n   select @islmtip=kod,@islmtipad=ad   from stkhrktip where kod='RESSAT'\r\n   select @islmtip1=kod,@islmtipad1=ad from stkhrktip where kod='RESIADE'\r\n\r\n\r\n    \r\n   /*Update Recetesiz Urun Ve Receteli Ana Urun */\r\n   update stkhrk Set firmano=dt.firmano,sil=dt.sil,\r\n   stk_id=dt.stk_id,stkod=dt.stkod,barkod=dt.barkod,\r\n   tarih=dt.tarih,saat=dt.saat,\r\n   stktip_id=dt.stktip_id,stktip=dt.stktip,\r\n  /* degistarsaat=dt.degistarsaat,degisuser=dt.degisuser, */\r\n   islmtip=dt.islmtip,islmtipad=dt.islmtipad,\r\n   yertip=dt.yertip,yerad=dt.yerad,\r\n   giren=dt.giren,cikan=dt.cikan,siademik=dt.siademik,\r\n   depkod=dt.depokod,brmfiykdvli=dt.brmfiykdvli,\r\n   kdvyuz=dt.kdvyuz,belno=dt.belno,ack=dt.ack\r\n   from stkhrk as t join \r\n    ( select h.Id,m.firmano,h.sil,\r\n      H.StkId as stk_id,k.Kod stkod,k.barkod,m.tarih,m.saat,\r\n      stktipId stktip_id,k.tip stktip,\r\n      /*m.degistarsaat,m.degisuser, */\r\n      case when m.Iade=1 then @islmtip1 else @islmtip end islmtip,\r\n      case when m.Iade=1 then @islmtipad1 else @islmtipad end islmtipad,\r\n      'ResSatMas' YerTip,'Restaurant Satis' YerAd,m.Id as ResSatId,\r\n      case when m.Iade=1 then miktar else 0 end giren,\r\n      case when m.Iade=1 then miktar else 0 end cikan,\r\n      case when m.Iade=1 then miktar else 0 end siademik,\r\n      m.depokod,(birimfiyat*(1-Indyuz))*h.kur brmfiykdvli,kdvyuz ,\r\n      LTRIM(STR(m.Id, 25, 0))  belno,\r\n      (select top 1 cast(varad as varchar)+' RESTAURANT SATIŞI' \r\n      from ResVardiMas with (nolock) where varno=m.varno and m.sil=0) ack,\r\n      m.varno\r\n      from ResSatHrk h with (nolock)\r\n      inner join ResSatMas as m  with (nolock)\r\n      on m.Id=h.ResSatId\r\n      left join stokkart as k with (nolock) on k.id=h.StkId\r\n      where h.ResSatId=@AnaKay_id /*and isnull(h.Recete,0)=0 */\r\n      and h.Id in (Select stkhrkid From stkhrk with (nolock) \r\n      where ResSatId=@AnaKay_id ) ) dt \r\n      on dt.Id=t.stkhrkid and dt.ResSatId=t.ResSatId \r\n\r\n\r\n      /*Update Urun Receteli Ana Urun Giris Hrk */\r\n       update stkhrk Set firmano=dt.firmano,sil=dt.sil,\r\n       UrunId=dt.UrunId,stk_id=dt.stk_id,\r\n       stkod=dt.stkod,barkod=dt.barkod,\r\n       tarih=dt.tarih,saat=dt.saat,\r\n       stktip_id=dt.stktip_id,stktip=dt.stktip,\r\n      /* degistarsaat=dt.degistarsaat,degisuser=dt.degisuser, */\r\n       islmtip=dt.islmtip,islmtipad=dt.islmtipad,\r\n       yertip=dt.yertip,yerad=dt.yerad,\r\n       giren=dt.giren,cikan=dt.cikan,siademik=dt.siademik,\r\n       depkod=dt.depokod,brmfiykdvli=dt.brmfiykdvli,\r\n       kdvyuz=dt.kdvyuz,belno=dt.belno,ack=dt.ack\r\n      from stkhrk as t join \r\n      ( select h.Id,rh.ResSatRecHrkId RecHrkId,rh.UrunId,\r\n      m.firmano,h.sil,\r\n      h.StkId as stk_id,k.kod as stkod,k.barkod,\r\n      m.tarih,m.saat,\r\n      h.StktipId as stktip_id,k.tip as stktip,\r\n      case when m.Iade=1 then @islmtip1 else @islmtip end islmtip,\r\n      case when m.Iade=1 then @islmtipad1 else @islmtipad end islmtipad,\r\n      'ResSatMas' YerTip,'Restaurant Satis' YerAd,m.Id as ResSatId,\r\n      case when m.Iade=1 then 0 else miktar end giren,\r\n      case when m.Iade=1 then 0 else miktar end cikan,\r\n      case when m.Iade=1 then 0 else miktar end siademik,\r\n      depokod,(rh.BirimMaliyetFiyat/miktar) brmfiykdvli,kdvyuz ,\r\n      LTRIM(STR(m.Id, 25, 0))  belno,\r\n      (select top 1 cast(varad as varchar)+' RESTAURANT SATIŞI' \r\n      from ResVardiMas with (nolock) where varno=m.varno and m.sil=0) ack,\r\n      m.varno\r\n      from ResSatHrk h with (nolock)\r\n      inner join ResSatMas as m  with (nolock)\r\n      on m.Id=h.ResSatId\r\n      left join stokkart as k with (nolock) on k.id=h.StkId\r\n      inner join V_ResSatisUrunIdReceteMaliyet as rh \r\n      on rh.ResSatId=m.Id and rh.ResSatHrkId=h.Id\r\n      where h.ResSatId=@AnaKay_id and isnull(h.Recete,0)=1  \r\n      and EXISTS (SELECT id FROM stkhrk as sh with (nolock) \r\n      WHERE sh.ResSatId=@AnaKay_id and h.Id = sh.stkhrkid  \r\n      and rh.ResSatRecHrkId = isnull(sh.ResSatRecHrkId,0) )\r\n      ) dt \r\n      on dt.Id=t.stkhrkid and dt.ResSatId=t.ResSatId \r\n      and dt.RecHrkId=t.ResSatRecHrkId \r\n\r\n\r\n\r\n      /*Update Urun Recete Hrk */\r\n       update stkhrk Set firmano=dt.firmano,sil=dt.sil,\r\n       UrunId=dt.UrunId,stk_id=dt.stk_id,stkod=dt.stkod,barkod=dt.barkod,\r\n       tarih=dt.tarih,saat=dt.saat,\r\n       stktip_id=dt.stktip_id,stktip=dt.stktip,\r\n      /* degistarsaat=dt.degistarsaat,degisuser=dt.degisuser, */\r\n       islmtip=dt.islmtip,islmtipad=dt.islmtipad,\r\n       yertip=dt.yertip,yerad=dt.yerad,\r\n       giren=dt.giren,cikan=dt.cikan,siademik=dt.siademik,\r\n       depkod=dt.depokod,brmfiykdvli=dt.brmfiykdvli,\r\n       kdvyuz=dt.kdvyuz,belno=dt.belno,ack=dt.ack\r\n      from stkhrk as t join \r\n      ( select h.Id,rh.Id RecHrkId,rh.UrunId,m.firmano,h.sil,\r\n      rh.StokId as stk_id,rh.StokKod as stkod,\r\n      k.barkod,m.tarih,m.saat,\r\n      rh.StokTipId as stktip_id,rh.StokTip as stktip,\r\n      case when m.Iade=1 then @islmtip1 else @islmtip end islmtip,\r\n      case when m.Iade=1 then @islmtipad1 else @islmtipad end islmtipad,\r\n      'ResSatMas' YerTip,'Restaurant Satis' YerAd,m.Id as ResSatId,\r\n      case when m.Iade=1 then rh.miktar else 0 end giren,\r\n      case when m.Iade=1 then rh.miktar else 0 end cikan,\r\n      case when m.Iade=1 then rh.miktar else 0 end siademik,\r\n      depokod,rh.BirimFiyat brmfiykdvli,kdvyuz,\r\n      LTRIM(STR(m.Id, 25, 0))  belno,\r\n      (select top 1 cast(varad as varchar)+' RESTAURANT SATIŞI' \r\n      from ResVardiMas with (nolock) where varno=m.varno and m.sil=0) ack,\r\n      m.varno\r\n      from ResSatHrk h with (nolock)\r\n      inner join ResSatMas as m  with (nolock)\r\n      on m.Id=h.ResSatId\r\n      left join stokkart as k with (nolock) on k.id=h.StkId\r\n      inner join ResSatRecHrk as rh with (nolock) on \r\n      Rh.ResSatHrkId=H.Id \r\n      where h.ResSatId=@AnaKay_id and isnull(h.Recete,0)=1 and rh.UretimTipId=1 \r\n      and EXISTS (SELECT id FROM stkhrk as sh with (nolock) \r\n      WHERE sh.ResSatId=@AnaKay_id and h.Id = sh.stkhrkid  \r\n      and rh.Id = isnull(sh.ResSatRecHrkId,0) )\r\n      ) dt \r\n      on dt.Id=t.stkhrkid and dt.ResSatId=t.ResSatId \r\n      and dt.RecHrkId=t.ResSatRecHrkId \r\n       \r\n      \r\n      \r\n      \r\n \r\n      \r\n      \r\n\r\n      /*insert  Recetesiz Urun Ve Receteli Ana Urun  */\r\n      insert stkhrk (firmano,stkhrkid,\r\n      stk_id,stkod,barkod,tarih,saat,stktip_id,stktip,olustarsaat,olususer,islmtip,\r\n      islmtipad,yertip,yerad,ResSatId,giren,cikan,siademik,\r\n      depkod,brmfiykdvli,kdvyuz,tabload,belno,ack,varno)\r\n      \r\n      select m.firmano,h.Id,\r\n      h.stkId stk_id,k.kod stkod,h.barkod,m.tarih,m.saat,\r\n      h.stktipId stktip_id,k.tip stktip,\r\n      m.olustarsaat,m.olususer,\r\n      case when m.Iade=1 then @islmtip1 else @islmtip end,\r\n      case when m.Iade=1 then @islmtipad1 else @islmtipad end,\r\n      'ResSatMas' YerTip,'Restaurant Satis' YerAd,m.Id as ResSatId,\r\n      case when m.Iade=1 then miktar else 0 end,\r\n      case when m.Iade=0 then miktar else 0 end,\r\n      case when m.Iade=1 then miktar else 0 end,\r\n      depokod,(birimfiyat*(1-Indyuz))*h.kur,kdvyuz,@tabload,\r\n      LTRIM(STR(m.Id, 25, 0))  belno,\r\n      (select top 1 cast(varad as varchar)+' RESTAURANT SATIŞI' \r\n      from ResVardiMas with (nolock) where varno=m.varno and m.sil=0),\r\n      m.varno\r\n      from ResSatHrk h with (nolock)\r\n      inner join ResSatMas as m  with (nolock)\r\n      on m.Id=h.ResSatId\r\n      and m.sil=0 and h.sil=0\r\n      left join stokkart as k with (nolock) on k.id=h.StkId\r\n      where h.ResSatId=@AnaKay_id and h.sil=0 \r\n      and h.Id not in (Select stkhrkid From stkhrk with (nolock) \r\n      where ResSatId=@AnaKay_id and isnull(ResSatRecHrkId,0)=0 )\r\n \r\n \r\n\r\n      \r\n      \r\n      /*insert Receteli Urun Giris Hrk */\r\n      insert stkhrk (firmano,stkhrkid,\r\n      stk_id,stkod,barkod,tarih,saat,stktip_id,stktip,olustarsaat,olususer,islmtip,\r\n      islmtipad,yertip,yerad,ResSatId,giren,cikan,siademik,\r\n      depkod,brmfiykdvli,kdvyuz,tabload,belno,ack,varno,ResSatRecHrkId,UrunId)\r\n      \r\n      select m.firmano,h.Id,\r\n      h.stkId stk_id,k.kod stkod,h.barkod,\r\n      m.tarih,m.saat,\r\n      h.stktipId stktip_id,k.tip stktip,      \r\n      m.olustarsaat,m.olususer,\r\n      case when m.Iade=1 then @islmtip1 else @islmtip end,\r\n      case when m.Iade=1 then @islmtipad1 else @islmtipad end,\r\n      'ResSatMas' YerTip,'Restaurant Satis' YerAd,m.Id as ResSatId,\r\n      case when m.Iade=1 then 0 else miktar end,\r\n      case when m.Iade=0 then 0 else miktar end,\r\n      case when m.Iade=1 then 0 else miktar end,\r\n      depokod,(rm.BirimMaliyetFiyat/miktar),kdvyuz,@tabload,\r\n      LTRIM(STR(m.Id, 25, 0))  belno,\r\n      (select top 1 cast(varad as varchar)+' RESTAURANT SATIŞI' \r\n      from ResVardiMas with (nolock) where varno=m.varno and m.sil=0),\r\n      m.varno,rm.ResSatRecHrkId,rm.UrunId\r\n      from ResSatHrk h with (nolock)\r\n      inner join ResSatMas as m  with (nolock)\r\n      on m.Id=h.ResSatId and m.sil=0 and h.sil=0\r\n      inner join V_ResSatisUrunIdReceteMaliyet as rm \r\n      on rm.ResSatId=m.Id and rm.ResSatHrkId=h.Id\r\n      left join stokkart as k with (nolock) on k.id=h.StkId\r\n      where h.ResSatId=@AnaKay_id and h.sil=0 \r\n      and isnull(h.Recete,0)=1\r\n      and NOT EXISTS (SELECT id FROM stkhrk as sh with (nolock) \r\n      WHERE sh.ResSatId=@AnaKay_id and h.Id = sh.stkhrkid  \r\n      AND rm.ResSatRecHrkId = isnull(sh.ResSatRecHrkId,0) )\r\n      \r\n       \r\n \r\n      \r\n      /*insert Urun Recete Hrk */\r\n      insert stkhrk (firmano,stkhrkid,\r\n      stk_id,stkod,barkod,tarih,saat,stktip_id,stktip,olustarsaat,olususer,islmtip,\r\n      islmtipad,yertip,yerad,ResSatId,giren,cikan,siademik,\r\n      depkod,brmfiykdvli,kdvyuz,tabload,belno,ack,varno,ResSatRecHrkId,UrunId)\r\n      \r\n      select m.firmano,h.Id,\r\n      rh.StokId,rh.StokKod,k.barkod,m.tarih,m.saat,\r\n      rh.StokTipId,rh.StokTip,m.olustarsaat,m.olususer,\r\n      case when m.Iade=1  then @islmtip1 else @islmtip end,\r\n      case when m.Iade=1  then @islmtipad1 else @islmtipad end,\r\n      'ResSatMas' YerTip,'Restaurant Satis' YerAd,m.Id as ResSatId,\r\n      case when m.Iade=1  then rh.Miktar else 0 end,\r\n      case when m.Iade=0  then rh.Miktar else 0 end,\r\n      case when m.Iade=1  then rh.Miktar else 0 end,\r\n      depokod,rh.BirimFiyat,kdvyuz,@tabload,\r\n      LTRIM(STR(m.Id, 25, 0))  belno,\r\n      (select top 1 cast(varad as varchar)+' RESTAURANT SATIŞI' \r\n      from ResVardiMas with (nolock) where varno=m.varno and m.sil=0),\r\n      m.varno,rh.Id,rh.UrunId\r\n      from ResSatHrk h with (nolock)\r\n      inner join ResSatMas as m  with (nolock)\r\n      on m.Id=h.ResSatId\r\n      and m.sil=0 and h.sil=0\r\n      inner join ResSatRecHrk as Rh with (nolock) on \r\n      Rh.ResSatHrkId=H.Id and Rh.Sil=0   \r\n      left join stokkart as k with (nolock) on k.id=h.StkId  \r\n      where h.ResSatId=@AnaKay_id and h.sil=0 \r\n      and isnull(h.Recete,0)=1 and rh.UretimTipId=1 /*recete */\r\n      and NOT EXISTS (SELECT id FROM stkhrk as sh with (nolock) \r\n      WHERE sh.ResSatId=@AnaKay_id and h.Id = sh.stkhrkid  \r\n      AND rh.Id = isnull(sh.ResSatRecHrkId,0) )\r\n\r\n    \r\n  \r\n     \r\n     /*delete  */\r\n     update stkhrk set Sil=1 where ResSatId=@AnaKay_id\r\n     and stkhrkid not in (select h.Id  from ResSatHrk h with (nolock)\r\n      inner join ResSatMas as m  with (nolock)\r\n      on m.Id=h.ResSatId  where h.ResSatId=@AnaKay_id)\r\n   \r\n   \r\n\r\n\r\n   /*\r\n    insert stkhrk (firmano,stkhrkid,\r\n    stk_id,stkod,barkod,tarih,saat,stktip_id,stktip,olustarsaat,olususer,islmtip,\r\n    islmtipad,yertip,yerad,ResSatId,giren,cikan,siademik,\r\n    depkod,brmfiykdvli,kdvyuz,tabload,belno,ack,varno)\r\n    select m.firmano,h.Id,\r\n    stkId,k.kod,k.barkod,m.tarih,m.saat,stktipId,'markt',m.olustarsaat,m.olususer,\r\n    case when m.Iade=1 then @islmtip1 else @islmtip end,\r\n    case when m.Iade=1 then @islmtipad1 else @islmtipad end,\r\n    'ResVardiMas','RESTAURAT VARDIYA',m.Id,\r\n    case when m.Iade=1 then miktar else 0 end,\r\n    case when m.Iade=0 then miktar else 0 end,\r\n    case when m.Iade=1 then miktar else 0 end,\r\n    m.depokod,(BirimFiyat*(1-Indyuz))*h.kur,kdvyuz,@tabload,\r\n    LTRIM(STR(m.Id, 25, 0))  belno,\r\n    (select top 1 cast(varad as varchar)+' RESTAURANT SATIŞI' \r\n    from resvardimas with (nolock) where \r\n    varno=m.varno and m.sil=0),\r\n    m.varno\r\n    from ressathrk h with (nolock)\r\n    inner join ressatmas as m with (nolock)\r\n    on m.Id=h.RessatId\r\n    and m.sil=0 and h.sil=0\r\n    inner join stokkart as k with (nolock) on\r\n    k.id=h.stkId\r\n    where h.RessatId=@AnaKay_id\r\n    and h.sil=0\r\n    */\r\n    \r\n    \r\n    \r\n     \r\n    end\r\n\r\n   RETURN\r\n  end\r\n/*------------------------------------------------------------------------------------------- */\r\n\r\n\r\n\r\n  /*-veresihrk satis */\r\n  if @tabload='veresihrk'\r\n  begin\r\n\r\n   delete from stkhrk from stkhrk with(nolock) where tabload=@tabload\r\n   and (fisid>0 and fisid=@AnaKay_id)\r\n   /* and stkhrkid=@islmid */\r\n   \r\n\r\n  if (@kayok=1) and (@sil=0) \r\n   insert stkhrk (firmano,stkhrkid,stkod,tarih,saat,stktip,olustarsaat,olususer,islmtip,islmtipad,\r\n   yertip,yerad,fisid,giren,cikan,depkod,brmfiykdvli,kdvyuz,tabload,belno,ack,\r\n   Karsi_Karttip,Karsi_KartKod)\r\n   select m.firmano,h.id,stkod,m.tarih,m.saat,h.stktip,h.olustarsaat,h.olususer,\r\n   m.fistip,m.fisad,m.yertip,m.yerad,m.verid,0,mik,depkod,brmfiy,kdvyuz,@tabload,\r\n   seri+cast([no] as varchar),ack,\r\n   m.cartip,m.carkod\r\n    from veresihrk as h WITH (NOLOCK)\r\n   inner join veresimas as m WITH (NOLOCK) on m.verid=h.verid\r\n   where h.verid=@AnaKay_id and h.depkod <>'' and m.hrk_stk_pro=1 \r\n   and h.stktip in ('akykt','markt') and h.sil=0 \r\n   \r\n   \r\n   \r\n   /*emtia satis işle */\r\n   delete from emtiasat from emtiasat with(nolock) where \r\n   (fis_id>0 and fis_id=@AnaKay_id)\r\n  \r\n  if (@kayok=1) and (@sil=0) \r\n   begin\r\n   \r\n   select @islmtip=kod,@islmtipad=ad from stkhrktip \r\n   where kod='POMMARSAT'\r\n   \r\n   \r\n   select top 1 @market_depo=kod from depokart \r\n   where sil=0 and firmano=(select top 1 firmano from\r\n    veresimas with(nolock) where verid=@AnaKay_id)\r\n      \r\n   insert emtiasat (emtid,firmano,tarih,saat,varno,perkod,adaid,\r\n   stktip,islmtip,islmtipad,yertip,yerad,depkod,\r\n   stkod,mik,brmfiy,tutar,olususer,olustarsaat,\r\n   deguser,degtarsaat,kdvyuz,varok,sil,\r\n   belno,ack,stk_id,stktip_id,fis_id)\r\n     \r\n   select h.id,m.firmano,m.tarih,m.saat,m.varno,m.perkod,m.adaid,\r\n   h.stktip,@islmtip,@islmtipad,m.yertip,m.yerad,@market_depo,\r\n   h.stkod,h.mik,h.brmfiy,h.mik*h.brmfiy,\r\n   h.olususer,h.olustarsaat,h.deguser,h.degtarsaat,\r\n   kdvyuz,m.varok,m.sil,seri+cast([no] as varchar),ack,\r\n   h.stk_id,h.stktip_id,m.Verid \r\n   from veresihrk as h WITH (NOLOCK)\r\n   inner join veresimas as m WITH (NOLOCK) on m.verid=h.verid\r\n   where h.verid=@AnaKay_id  and m.emtia_isle=1 \r\n   and h.stktip in ('markt') and h.sil=0 \r\n   \r\n   \r\n   update emtiasat set emtid=id where fis_id=@AnaKay_id\r\n   \r\n   \r\n  end \r\n   \r\n   \r\n   delete from carihrk  from carihrk with(nolock) where \r\n   (fisid>0 and fisid=@AnaKay_id) and (FisStkAnaid=@AnaKay_id) \r\n   /* fisstkhrkid=@islmid  */\r\n   \r\n   if (@kayok=1) and (@sil=0) \r\n    begin\r\n\r\n   set @islmtip='FIS'\r\n   set @islmhrk='FST'\r\n   select @islmtipad=ad from islemturtip where tip=@islmtip\r\n   select @islmhrkad=ad from islemhrktip where tip=@islmtip and hrk=@islmhrk\r\n   \r\n\r\n    select @newid=0\r\n    insert into carihrk (firmano,carhrkid,gctip,\r\n    fisstkhrkid,fisfattip,fisfatid,\r\n    islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n    cartip_id,cartip,car_id,carkod,borc,alacak,bakiye,tarih,saat,olususer,olustarsaat,vadetar,belno,\r\n    ack,varno,kur,dataok,pro,varok,perkod,adaid,deguser,degtarsaat,sil,\r\n    karsihestip,karsiheskod,parabrm,fisid,FisStkAnaid)\r\n    select m.firmano,@newid,'',@islmid,'FIS',m.verid,@islmtip,\r\n    @islmtipad,@islmhrk,@islmhrkad,m.yertip,m.yerad,\r\n    3,'gelgidkart',h.stk_id,h.stkod,(h.brmfiy*h.mik),0,\r\n    0,m.tarih,m.saat,h.olususer,h.olustarsaat,m.vadtar,m.seri+cast(m.[no] as varchar(20)),\r\n    m.ack,0,1,0,0,1,'',0,h.olususer,h.olustarsaat,m.sil,\r\n    '','',m.parabrm,m.verid,m.verid  from veresihrk as h WITH (NOLOCK)\r\n    inner join veresimas as m WITH (NOLOCK) on m.verid=h.verid\r\n    where h.verid=@AnaKay_id and h.depkod <>'' and m.hrk_stk_pro=1 \r\n    and h.stktip in ('gelgid') and h.sil=0 \r\n\r\n    select @newid=SCOPE_IDENTITY()\r\n    update carihrk set carhrkid=@newid where id=@newid \r\n   \r\n   \r\n   end\r\n   \r\n  return\r\n  end\r\n\r\n\r\n/*-prom_Sat_hrk satis */\r\nif @tabload='Prom_Sat_Hrk'\r\nbegin\r\n\r\n delete from stkhrk from stkhrk with(nolock) where tabload=@tabload\r\n and (Promid>0 and Promid=@AnaKay_id)\r\n /* and stkhrkid=@islmid */\r\n \r\n\r\nif (@kayok=1) and (@sil=0) \r\n insert stkhrk (firmano,stkhrkid,stkod,tarih,saat,stktip,\r\n olustarsaat,olususer,islmtip,islmtipad,\r\n yertip,yerad,promid,giren,cikan,depkod,brmfiykdvli,kdvyuz,tabload,belno,ack)\r\n select m.firmano,h.id,h.stkod,m.tarih,m.saat,h.stktip,h.olustarsaat,h.olususer,\r\n m.fistip,m.fisad,m.yertip,m.yerad,m.promid,0,mik,depkod,brmfiy,kdvyuz,@tabload,\r\n seri+cast([no] as varchar),ack from Prom_Sat_Hrk as h with (nolock)\r\n inner join Prom_Sat_Baslik as m with (nolock) on m.promid=h.promid\r\n where h.promid=@AnaKay_id and h.depkod <>'' and m.hrk_stk_pro=1 \r\n and h.stktip in ('akykt','markt') and h.sil=0 \r\n \r\n \r\n delete from carihrk from carihrk with(nolock) where \r\n (promid>0 and promid=@AnaKay_id) and (PromStkAnaid=@AnaKay_id) \r\n /* fisstkhrkid=@islmid  */\r\n \r\n if (@kayok=1) and (@sil=0) \r\n  begin\r\n\r\n set @islmtip='FIS'\r\n set @islmhrk='FST'\r\n select @islmtipad=ad from islemturtip where tip=@islmtip\r\n select @islmhrkad=ad from islemhrktip where tip=@islmtip and hrk=@islmhrk\r\n \r\n\r\n\r\n  select @newid=0\r\n  insert into carihrk (firmano,carhrkid,gctip,\r\n  fisstkhrkid,fisfattip,fisfatid,\r\n  islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n  cartip_id,cartip,car_id,carkod,borc,alacak,bakiye,tarih,saat,olususer,olustarsaat,vadetar,belno,\r\n  ack,varno,kur,dataok,pro,varok,perkod,adaid,deguser,degtarsaat,sil,\r\n  karsihestip,karsiheskod,parabrm,Promid,PromStkAnaid)\r\n  select m.firmano,@newid,'',@islmid,'PRS',m.promid,@islmtip,\r\n  @islmtipad,@islmhrk,@islmhrkad,m.yertip,m.yerad,\r\n  3,'gelgidkart',h.stk_id,h.stkod,(h.brmfiy*h.mik),0,\r\n  0,m.tarih,m.saat,h.olususer,h.olustarsaat,m.vadtar,m.seri+cast(m.[no] as varchar(20)),\r\n  m.ack,0,1,0,0,1,'',0,h.olususer,h.olustarsaat,m.sil,\r\n  '','',m.parabrm,m.promid,m.promid  from Prom_Sat_Hrk as h with (NOLOCK)\r\n  inner join Prom_Sat_Baslik as m with (nolock) on m.promid=h.promid\r\n  where h.promid=@AnaKay_id and h.depkod <>'' and m.hrk_stk_pro=1 \r\n  and h.stktip in ('gelgid') and h.sil=0 \r\n  \r\n  select @newid=SCOPE_IDENTITY()\r\n  update carihrk set carhrkid=@newid where id=@newid\r\n \r\n \r\n \r\n end\r\n \r\nreturn\r\nend\r\n\r\n\r\n/*-Prom_Puan_Hrk //giris cikis kaydi */\r\n  if @tabload='Prom_Puan_Hrk'\r\n   begin\r\n \r\n  delete from stkhrk from stkhrk with(nolock) where tabload=@tabload \r\n  and (Puanid>0 and Puanid=@AnaKay_id)\r\n \r\n\r\n  if (@kayok=1) and (@sil=0)\r\n  begin\r\n  \r\n   select @islmtip=kod,@islmtipad=ad  from stkhrktip where \r\n   kod='PRSGIRCIK'\r\n\r\n    insert stkhrk (firmano,stkhrkid,\r\n    stk_id,stkod,tarih,saat,stktip_id,stktip,olustarsaat,olususer,\r\n    islmtip,islmtipad,yertip,yerad,Puanid,\r\n    giren,cikan,siademik,depkod,brmfiykdvli,kdvyuz,tabload,\r\n    belno,ack)\r\n    select h.firmano,h.id,\r\n    stk_id,stkkod,tarih,saat,stktip_id,stktip,h.olustarsaat,h.olususer,\r\n    @islmtip,@islmtipad,\r\n    yertip,yerad,h.Puanid,\r\n    h.mik_giren,\r\n    h.mik_cikan,0,\r\n    Dep_Kod,Brm_Fiyat_Kdvli*kur,\r\n    case when Kdv_Oran>0 then Kdv_Oran/100 else Kdv_Oran end,\r\n    @tabload,h.belno,h.ack\r\n    from Prom_Puan_Hrk h with (nolock) where h.Puanid=@AnaKay_id\r\n    and h.sil=0 \r\n    end\r\n\r\n   RETURN\r\n  end\r\n\r\n\r\n\r\n\r\n/*------------------------------------------------------------------------------------------- */\r\n/*irsaliye */\r\nif @tabload='irsaliyehrk'\r\n begin\r\n\r\n  delete from stkhrk from stkhrk with(nolock) \r\n  where tabload=@tabload  and (irid>0 and irid=@AnaKay_id)\r\n/*  and stkhrkid=@islmid */\r\n\r\n if (@kayok=1) and (@sil=0) \r\n insert stkhrk (firmano,stkhrkid,stkod,tarih,saat,stktip,\r\n olustarsaat,olususer,\r\n islmtip,islmtipad,yertip,yerad,irid,giren,cikan,depkod,brmfiykdvli,\r\n kdvyuz,tabload,belno,ack,\r\n Karsi_Karttip,Karsi_KartKod)\r\n select m.firmano,h.id,stkod,m.tarih,m.saat,h.stktip,h.olustarsaat,h.olususer,\r\n m.irtip,m.irad,\r\n m.yertip,m.yerad,m.irid,\r\n case when m.gctip=1 then mik else 0 end,\r\n case when m.gctip=2 then mik else 0 end,\r\n depkod,\r\n ((h.brmfiy+isnull(h.otvbrim,0))-isnull(h.satisktut+h.genisktut,0))\r\n *(1+kdvyuz),kdvyuz,@tabload,\r\n irseri+cast([irno] as varchar),ack,\r\n m.cartip,m.carkod \r\n from irsaliyehrk as h WITH (NOLOCK)\r\n inner join irsaliyemas as m WITH (NOLOCK) on m.irid=h.irid \r\n where h.irid=@AnaKay_id and h.depkod <>'' and m.hrk_stk_pro=1\r\n and m.sil=0 and h.sil=0 and h.stktip in ('akykt','markt') \r\n \r\n \r\n \r\n    /*--DELETE */\r\n    delete from carihrk from carihrk with(nolock) where \r\n     (irsid>0 and irsid=@AnaKay_id) and (irsStkAnaid=@AnaKay_id)\r\n     \r\n     \r\n     \r\n    set @islmtip='IRS'\r\n    set @islmhrk='SHR'\r\n    select @islmtipad=ad from islemturtip where tip=@islmtip\r\n    select @islmhrkad=ad from islemhrktip where tip=@islmtip \r\n    and hrk=@islmhrk\r\n\r\n    if (@kayok=1) and (@sil=0)\r\n    begin\r\n\r\n        select @newid=0\r\n        insert into carihrk (firmano,carhrkid,\r\n        gctip,fatstkhrkid,fisfattip,fisfatid,islmtip,islmtipad,\r\n        islmhrk,islmhrkad,yertip,yerad,\r\n        cartip_id,cartip,car_id,carkod,borc,alacak,\r\n        bakiye,tarih,saat,olususer,olustarsaat,vadetar,belno,\r\n        ack,varno,kur,dataok,pro,varok,perkod,\r\n        adaid,deguser,degtarsaat,sil,\r\n        karsihestip,karsiheskod,parabrm,irsid,irsStkAnaid,belrap_id,\r\n        Karsi_Karttip,Karsi_KartKod)\r\n        select m.firmano,@newid,'',@islmid,'FAT',m.irid,@islmtip,\r\n        @islmtipad,@islmhrk,@islmhrkad,m.yertip,m.yerad,\r\n        3,'gelgidkart',\r\n        h.stk_id,h.stkod,\r\n        case when m.gctip=1 then \r\n        (((h.brmfiy+isnull(h.otvbrim,0))-isnull(h.satisktut+h.genisktut,0)) / \r\n        ( case when h.carpan=0 then 1 else h.carpan end )*(1+kdvyuz))*h.mik\r\n        else 0 end,\r\n        case when m.gctip=2 then \r\n        (((h.brmfiy+isnull(h.otvbrim,0))-isnull(h.satisktut+h.genisktut,0)) / \r\n        ( case when h.carpan=0 then 1 else h.carpan end )*(1+kdvyuz))*h.mik\r\n        else 0 end,\r\n        0,m.tarih,m.saat,h.olususer,h.olustarsaat,m.vadtar,m.irseri+cast(m.irno as varchar(20)),\r\n        m.ack,0,1,0,0,1,'',0,h.olususer,h.olustarsaat,m.sil,\r\n        '','','TL',m.irid,m.irid,m.irsrap_id,\r\n        m.cartip,m.carkod  from irsaliyehrk as h WITH (NOLOCK)\r\n        inner join irsaliyemas as m WITH (NOLOCK) on \r\n        m.irid=h.irid \r\n        where h.irid=@AnaKay_id \r\n        and h.sil=0  and m.hrk_stk_pro=1\r\n        and h.stktip in ('gelgid')\r\n    \r\n        select @newid=SCOPE_IDENTITY()\r\n        update carihrk set carhrkid=@newid where id=@newid  \r\n        \r\n        \r\n     end\r\n     \r\n     \r\n     \r\n     \r\n     \r\n \r\n\r\n end\r\n\r\n\r\n\r\n/*-faturahrk satis */\r\nif @tabload='faturahrk'\r\n begin\r\n/*perakende fatura dan stok dusumu olmazzz...! */\r\n/*veresiye faturadan stok dusumu olmaz.....! */\r\n\r\n declare @mik float\r\n declare @kdvyuz float\r\n declare @kdvsizbrmfiyat float\r\n declare @kdvsizgidertut float\r\n declare @fattip varchar(20)\r\n declare @fattur varchar(20)\r\n declare @kaptip varchar(20)\r\n /*declare @fatturad varchar(30) */\r\n declare @aliskdvsatirlitut float\r\n declare @satiskdvsatirlitut float\r\n declare @girenmik float\r\n declare @cikanmik float\r\n declare @Fat_Isk_Kart  varchar(50)\r\n \r\n set @aliskdvsatirlitut=0\r\n set @satiskdvsatirlitut=0\r\n\r\n set @girenmik=0\r\n set @cikanmik=0\r\n \r\n \r\n select @kaptip=m.kaptip from faturamas as m  WITH (NOLOCK)\r\n where m.fatid=@AnaKay_id\r\n \r\n  if @kaptip='IRS'\r\n      return\r\n   \r\n   Select @Fat_Isk_Kart=Isnull(fat_iskonto_kart,'') from Sistemtanim\r\n\r\n\r\n   /*stok hrk işlenmesii */\r\n\r\n   /*delete from stkhrk from stkhrk with(nolock) where tabload=@tabload  */\r\n   /*and (fatid>0 and fatid=@AnaKay_id)  */\r\n   /*update stkhrk Set Sil=1 Where  tabload=@tabload and Sil=0  */\r\n   /*and (fatid>0 and fatid=@AnaKay_id)  */\r\n   \r\n  /* delete from stkhrk from stkhrk with(nolock) where tabload=@tabload  */\r\n  /* and stkhrkid in (select id from faturahrk WITH (NOLOCK) where fatid=@AnaKay_id) */\r\n  /* update stkhrk Set Sil=1 Where tabload=@tabload  and Sil=0  */\r\n  /* and stkhrkid in (select id from faturahrk WITH (NOLOCK) where fatid=@AnaKay_id)  */\r\n\r\n\r\n   if (@kayok=1) /*and (@sil=0) */\r\n     begin  \r\n     \r\n     \r\n      /*Update  */\r\n     update stkhrk Set firmano=dt.firmano,sil=dt.sil,\r\n     stk_id=dt.stk_id,stkod=dt.stkod,barkod=dt.barkod,\r\n     tarih=dt.tarih,saat=dt.saat,\r\n     stktip_id=dt.stktip_id,stktip=dt.stktip,\r\n     /* degistarsaat=dt.degistarsaat,degisuser=dt.degisuser, */\r\n     islmtip=dt.islmtip,islmtipad=dt.islmtipad,\r\n     yertip=dt.yertip,yerad=dt.yerad,\r\n     giren=dt.giren,cikan=dt.cikan,\r\n     aiademik=dt.aiademik,siademik=dt.siademik,\r\n     depkod=dt.depkod,brmfiykdvli=dt.brmfiykdvli,\r\n     kdvyuz=dt.kdvyuz,belno=dt.belno,ack=dt.ack\r\n     from stkhrk as t join \r\n      ( select h.id,m.firmano,h.sil,stk_id,stkod,h.barkod,\r\n      m.tarih,m.saat,stktip_id,stktip,\r\n      h.olustarsaat,h.olususer,\r\n      m.fattip islmtip,m.fatad islmtipad,\r\n      m.yertip,m.yerad,m.fatid,\r\n      case when m.gctip=1 then mik*carpan else 0 end giren,\r\n      case when m.gctip=2 then mik*carpan else 0 end cikan,\r\n      /*@girenmik,@cikanmik, */\r\n      /*alistan iade */\r\n      (case when m.fattip='FATIADALS' then mik*carpan else 0 end) aiademik,\r\n      /*satistan iade */\r\n      (case when m.fattip='FATIADSAT' then mik*carpan else 0 end) siademik,\r\n      depkod,\r\n      case when (m.gctip=1) then\r\n      ((h.brmfiy+h.otvbrim)-(h.satisktut+h.genisktut)) / \r\n      ( case when h.carpan=0 then 1 else h.carpan end )*(1+kdvyuz)\r\n      when (m.gctip=2) and (@Fat_Isk_Kart='')  then\r\n      ((h.brmfiy+h.otvbrim)-(h.satisktut+h.genisktut)) / \r\n      ( case when h.carpan=0 then 1 else h.carpan end )*(1+kdvyuz)\r\n      when (m.gctip=2) and (@Fat_Isk_Kart<>'') then\r\n      ((h.brmfiy+h.otvbrim)) / \r\n      ( case when h.carpan=0 then 1 else h.carpan end )*(1+kdvyuz) \r\n      end brmfiykdvli,kdvyuz,\r\n      fatseri+cast([fatno] as varchar) belno,m.ack ack,\r\n      m.cartip Karsi_KartTip,m.carkod Karsi_KartKod \r\n      from faturahrk h WITH (NOLOCK)\r\n      inner join faturamas m WITH (NOLOCK) on m.fatid=h.fatid \r\n      and m.hrk_stk_pro=1 \r\n      and h.stktip in ('akykt','markt') where h.fatid=@AnaKay_id\r\n      and h.id in (Select stkhrkid From stkhrk with (nolock) \r\n      where fatid=@AnaKay_id ) ) dt \r\n      on dt.id=t.stkhrkid and dt.fatid=t.fatid \r\n     \r\n     \r\n     \r\n      /*insert  */\r\n      insert stkhrk (firmano,stkhrkid,stk_id,stkod,barkod,tarih,saat,\r\n      stktip_id,stktip,olustarsaat,olususer,\r\n      islmtip,islmtipad,yertip,yerad,\r\n      fatid,giren,cikan,aiademik,siademik,depkod,\r\n      brmfiykdvli,kdvyuz,tabload,belno,ack,\r\n      Karsi_Karttip,Karsi_KartKod)\r\n      select m.firmano,h.id,stk_id,stkod,h.barkod,m.tarih,m.saat,stktip_id,\r\n      stktip,h.olustarsaat,h.olususer,\r\n      m.fattip,m.fatad,m.yertip,m.yerad,m.fatid,\r\n      case when m.gctip=1 then mik*carpan else 0 end,\r\n      case when m.gctip=2 then mik*carpan else 0 end,\r\n      /*@girenmik,@cikanmik, */\r\n      /*alistan iade */\r\n      (case when m.fattip='FATIADALS' then mik*carpan else 0 end),\r\n      /*satistan iade */\r\n      (case when m.fattip='FATIADSAT' then mik*carpan else 0 end),\r\n      depkod,case when (m.gctip=1) then\r\n      ((h.brmfiy+h.otvbrim)-(h.satisktut+h.genisktut)) / \r\n      ( case when h.carpan=0 then 1 else h.carpan end )*(1+kdvyuz)\r\n      when (m.gctip=2) and (@Fat_Isk_Kart='')  then\r\n      ((h.brmfiy+h.otvbrim)-(h.satisktut+h.genisktut)) / \r\n      ( case when h.carpan=0 then 1 else h.carpan end )*(1+kdvyuz)\r\n      when (m.gctip=2) and (@Fat_Isk_Kart<>'') then\r\n      ((h.brmfiy+h.otvbrim)) / \r\n      ( case when h.carpan=0 then 1 else h.carpan end )*(1+kdvyuz) \r\n      end,kdvyuz,@tabload,fatseri+cast([fatno] as varchar),m.ack,\r\n      m.cartip,m.carkod from faturahrk h WITH (NOLOCK)\r\n      inner join faturamas m WITH (NOLOCK) on m.fatid=h.fatid \r\n      and m.sil=0  and h.sil=0 and m.hrk_stk_pro=1 \r\n      and h.stktip in ('akykt','markt') where h.fatid=@AnaKay_id\r\n      and h.id not in (Select stkhrkid From stkhrk with (nolock) \r\n      where fatid=@AnaKay_id ) \r\n    \r\n           \r\n      /*delete  */\r\n      update stkhrk set Sil=1 where fatid=@AnaKay_id\r\n      and stkhrkid not in (select h.id  from faturahrk h with (nolock)\r\n      inner join faturamas as m  with (nolock)\r\n      on m.fatid=h.fatid  where h.fatid=@AnaKay_id) \r\n    \r\n    \r\n    end  \r\n      \r\n      \r\n      \r\n    \r\n      \r\n\r\n  /*--DELETE */\r\n    delete from carihrk from carihrk with(nolock) where \r\n     (fatid>0 and fatid=@AnaKay_id) and (FatStkAnaid=@AnaKay_id)\r\n     /*fatstkhrkid=@islmid */\r\n\r\n  set @islmtip='FAT'\r\n  set @islmhrk='SHR'\r\n   select @islmtipad=ad from islemturtip where tip=@islmtip\r\n   select @islmhrkad=ad from islemhrktip where tip=@islmtip \r\n   and hrk=@islmhrk\r\n\r\n    if (@kayok=1) and (@sil=0)\r\n    begin\r\n       \r\n        select @newid=0\r\n        insert into carihrk (firmano,carhrkid,\r\n        gctip,fatstkhrkid,fisfattip,fisfatid,islmtip,islmtipad,\r\n        islmhrk,islmhrkad,yertip,yerad,\r\n        cartip_id,cartip,car_id,carkod,borc,alacak,\r\n        bakiye,tarih,saat,olususer,olustarsaat,vadetar,belno,\r\n        ack,varno,kur,dataok,pro,varok,perkod,\r\n        adaid,deguser,degtarsaat,sil,\r\n        karsihestip,karsiheskod,parabrm,fatid,FatStkAnaid,belrap_id,\r\n        Karsi_Karttip,Karsi_KartKod)\r\n        select m.firmano,@newid,'',@islmid,'FAT',m.fatid,@islmtip,\r\n        @islmtipad,@islmhrk,@islmhrkad,m.yertip,m.yerad,\r\n        3,'gelgidkart',\r\n        h.stk_id,h.stkod,\r\n        case when m.gctip=1 then \r\n        (((h.brmfiy+h.otvbrim)-(h.satisktut+h.genisktut)) / \r\n        ( case when h.carpan=0 then 1 else h.carpan end )*(1+kdvyuz))*h.mik\r\n        else 0 end,\r\n        case when m.gctip=2 then \r\n        (((h.brmfiy+h.otvbrim)-(h.satisktut+h.genisktut)) / \r\n        ( case when h.carpan=0 then 1 else h.carpan end )*(1+kdvyuz))*h.mik\r\n        else 0 end,\r\n        0,m.tarih,m.saat,h.olususer,h.olustarsaat,m.vadtar,m.fatseri+cast(m.fatno as varchar(20)),\r\n        m.ack,0,1,0,0,1,'',0,h.olususer,h.olustarsaat,m.sil,\r\n        '','',m.parabrm,m.fatid,m.fatid,m.fatrap_id,\r\n        m.cartip,m.carkod  from faturahrk as h WITH (NOLOCK)\r\n        inner join faturamas as m WITH (NOLOCK) on \r\n        m.fatid=h.fatid \r\n        /*and m.fattip  --not in ('FATPERSAT')  */\r\n        where h.fatid=@AnaKay_id \r\n        and h.sil=0  and m.hrk_stk_pro=1\r\n        and h.stktip in ('gelgid')\r\n        \r\n          update carihrk set carhrkid=id where FatStkAnaid=@AnaKay_id  \r\n        \r\n        \r\n     end\r\n     \r\n     \r\n     \r\n     \r\n     exec SpLog_Fatura @AnaKay_id\r\n     exec SpLog_FaturaHareket @AnaKay_id \r\n     \r\n     \r\n     exec SpLog_FaturaUrunHareket @AnaKay_id\r\n     \r\n     \r\n     \r\nend\r\n\r\n/*---------------------------------------------------------------------- */\r\n\r\n/*pompacı vardiya emtia satis */\r\nif @tabload='emtiasat'\r\nbegin\r\n\r\n  delete from stkhrk from stkhrk with(nolock) \r\n  where tabload=@tabload \r\n  and (pomsatid>0 and pomsatid=@AnaKay_id)\r\n  /*and stkhrkid=@islmid; */\r\n\r\n  select @islmtip=kod,@islmtipad=ad from stkhrktip \r\n  where kod='POMMARSAT'\r\n\r\n  if (@kayok=1) and (@sil=0)\r\n  insert stkhrk (firmano,stkhrkid,pomsatid,stk_id,stkod,tarih,saat,stktip_id,stktip,\r\n  stktipad,olustarsaat,olususer,islmtip,islmtipad,\r\n  yertip,yerad,tabload,giren,cikan,depkod,brmfiykdvli,kdvyuz,varno,\r\n  ack)\r\n  select m.firmano,h.id,h.id,h.stk_id,h.stkod,\r\n  h.tarih,h.saat,h.stktip_id,h.stktip,h.stktipad,\r\n  h.olustarsaat,h.olususer,@islmtip,@islmtipad,\r\n  h.yertip,h.yerad,@tabload,0,h.mik,h.depkod,h.brmfiy,\r\n  h.kdvyuz,m.varno,m.varad\r\n  from emtiasat as h WITH (NOLOCK)\r\n  inner join pomvardimas as m WITH (NOLOCK)\r\n  on m.varno=h.varno and m.sil=0 and h.sil=0\r\n  where h.id=@islmid and h.sil=0\r\n\r\n\r\n\r\n\r\nend\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "stokisle",
    "definition": "CREATE PROCEDURE [dbo].stokisle @id float\r\nAS\r\nBEGIN\r\ndeclare @stktip \t\tvarchar(10)\r\ndeclare @stkod \t\t\tvarchar(30)\r\ndeclare @depkod \t\tvarchar(30)\r\ndeclare @islmtip \t\tvarchar(20)\r\ndeclare @yertip \t\tvarchar(20)\r\ndeclare @tarx \t\t\tdatetime\r\ndeclare @brimfiy \t\tfloat\r\ndeclare @kdvyuz \t\tfloat\r\ndeclare @giren \t\t\tfloat\r\ndeclare @cikan \t\t\tfloat\r\ndeclare @say \t\t\tint\r\ndeclare @userad \t\tvarchar(100)\r\ndeclare @firmano        int\r\ndeclare @StkId       int\r\ndeclare @Sil       int\r\ndeclare @tar \t\t\tdatetime\r\ndeclare @marsatid     int\r\n\r\n\r\n   declare @Market_Sube  int\r\n   Select @Market_Sube=Market_Sube  from sistemtanim\r\n\r\n\r\n  select @firmano=firmano,@yertip=yertip,@stktip=stktip,@depkod=depkod,\r\n  @userad=olususer,@tarx=olustarsaat,@tar=tarih,@stkod=stkod,@islmtip=islmtip,@Sil=sil,\r\n  @brimfiy=brmfiykdvli,@kdvyuz=kdvyuz,@giren=giren,@cikan=cikan, \r\n  @marsatid=isnull(marsatid,0)  from\r\n  stkhrk with (nolock) where id=@id\r\n  \r\n  \r\n  if @Market_Sube>0 and @firmano>0 and @Sil=0 and @stktip='markt'\r\n  and @marsatid=0\r\n   begin\r\n    select @StkId=id from stokkart with (nolock) \r\n    where kod=@stkod and tip=@stktip\r\n    \r\n   \r\n    if @giren>0\r\n     begin\r\n         /*Sonrasi±nda Fatura Varsa bunu baz alma */\r\n        if not EXISTS(select id from stkhrk with (nolock)\r\n        where tarih>@tar and giren>0 and firmano=@firmano\r\n        and  stktip=@stktip and stkod=@stkod and sil=0)     \r\n        update Stok_Fiyat set \r\n        Fiyat=case when KdvTip=1 then @brimfiy else @brimfiy/(1+@kdvyuz) end\r\n        where FiyTip=1 and FiyNo=1 and Stktip_id=2 and Stk_id=@StkId\r\n        and firmano=@firmano\r\n    \r\n     end\r\n    \r\n    \r\n    \r\n    \r\n   end \r\n  \r\n  \r\n  \r\n  \r\n /*Genel */\r\n  if  (@islmtip='FATAKALS') or (@islmtip='FATMRALS') \r\n     OR (@islmtip='IRSAKALS') or (@islmtip='IRSMRALS') \r\n     or (@islmtip='FATYGALS') or (@islmtip='KARTAC')\r\n     UPDATE stokkart  SET\r\n     olususer=@userad,\r\n     olustarsaat=@tarx,\r\n     ortalsfiykdvli=DT.ortalsfiy,\r\n     alsfiy=isnull((select top 1 case when k.alskdvtip='Dahil' then \r\n      brmfiykdvli else (brmfiykdvli/(1+kdvyuz)) end\r\n     from stkhrk as h with (nolock) \r\n     inner join stokkart as k with(nolock) on \r\n     k.kod=h.stkod and k.tip=h.stktip\r\n     where h.stkod=@stkod and h.stktip=@stktip\r\n     and h.brmfiykdvli>0\r\n     and h.sil=0 and islmtip in \r\n     ('KARTAC','FATAKALS','FATMRALS',\r\n     'IRSAKALS','IRSMRALS','FATYGALS')\r\n     order by h.tarih desc),alsfiy)\r\n     from stokkart as t  JOIN\r\n     (select h.stkod,h.stktip,\r\n     isnull(case when sum((h.giren-(h.aiademik+h.siademik))) >0  then\r\n     sum((h.giren-(h.aiademik+h.siademik))*brmfiykdvli)\r\n     / sum((h.giren-(h.aiademik+h.siademik)))\r\n     else 0 end,0)   as ortalsfiy\r\n     from stkhrk as h with (nolock) where h.stkod=@stkod and h.stktip=@stktip\r\n     and h.sil=0 group by h.stkod,h.stktip ) DT on\r\n     DT.stkod=T.kod AND DT.stktip=T.tip\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "stokislesil",
    "definition": "CREATE PROCEDURE [dbo].stokislesil @id float,@stkod varchar(30),@islmtip varchar(10),\r\n@stktip varchar(20),@depkod varchar(30),\r\n@giren float,@cikan float,@tarx datetime\r\nAS\r\nBEGIN\r\ndeclare @say int\r\n\r\n\r\nupdate stokkart set alsmik=dt.giren,satmik=dt.cikan from stokkart as t\r\nJOIN (select isnull(sum(giren),0) as giren,isnull(sum(cikan),0) as cikan from stkhrk\r\nwhere stkod=@stkod and stktip=@stktip and sil=0 ) dt\r\non t.kod=@stkod and tip=@stktip\r\n\r\nif @stktip='akykt'\r\nupdate tankkart set alsmik=dt.giren,satmik=dt.cikan from tankkart as t JOIN\r\n(select isnull(sum(giren),0) as giren,isnull(sum(cikan),0) as cikan from stkhrk\r\nwhere depkod=@depkod and stkod=@stkod and stktip=@stktip and sil=0 ) dt\r\non t.kod=@depkod\r\n\r\n\r\n\r\n\r\nselect @say=count(*) from stkdrm where depkod=@depkod and stkod=@stkod and stktip=@stktip\r\nif @say>0\r\nupdate stkdrm set girenmik=dt.giren,cikanmik=dt.cikan from stkdrm as t JOIN\r\n(select isnull(sum(giren),0) as giren,isnull(sum(cikan),0) as cikan from stkhrk\r\nwhere depkod=@depkod and stkod=@stkod and stktip=@stktip and sil=0 ) dt\r\non t.depkod=@depkod and t.stkod=@stkod and t.stktip=@stktip\r\n\r\nif @say=0\r\ninsert into stkdrm  (girenmik,cikanmik,stktip,stkod,depkod)\r\nvalues (@giren,@cikan,@stktip,@stkod,@depkod);\r\n\r\n\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "stokkartacilis",
    "definition": "CREATE PROCEDURE [dbo].stokkartacilis @tip varchar(20),@depkod varchar(20),@stkod varchar(20)\r\nAS\r\nBEGIN\r\ndeclare @acmik       float\r\ndeclare @firmano     float\r\ndeclare @giren       float\r\ndeclare @cikan       float\r\ndeclare @alskdvtip   varchar(10)\r\ndeclare @brmfiy      float\r\ndeclare @kdvyuz      float\r\ndeclare @idx         float\r\ndeclare @olustar     datetime\r\ndeclare @tarx        datetime;\r\ndeclare @saatx       varchar(8)\r\ndeclare @user        varchar(50)\r\n\r\n\r\ndeclare @islmtip varchar(20)\r\ndeclare @islmtipad varchar(20)\r\n\r\nset @giren=0\r\nset @cikan=0\r\n\r\n  select @islmtip=kod,@islmtipad=ad from stkhrktip where kod='KARTAC'\r\n\r\n\r\n select @idx=id,@firmano=firmano,@acmik=acmik,@alskdvtip=alskdvtip,@kdvyuz=alskdv,@brmfiy=alsfiy,\r\n @olustar=olustarsaat,@user=olususer from stokkart where \r\n tip=@tip and kod=@stkod\r\n\r\n set @kdvyuz=@kdvyuz/100\r\n if @alskdvtip='Hariç'\r\n set @brmfiy=@brmfiy*(1+@kdvyuz)\r\n\r\n/*--------------market stokları-------- */\r\nif (@acmik<>0 and @tip='markt')\r\nbegin\r\nif @acmik>0\r\nset @giren=@acmik\r\n\r\nif @acmik<0\r\nset @cikan=-1*@acmik\r\n\r\n\r\nif @tip='markt'\r\nselect @depkod=mardepo from sistemtanim\r\n\r\nset @tarx=convert(varchar,getdate(),101)\r\nset @saatx=convert(varchar,getdate(),108)\r\n\r\n update stkhrk set sil=1 where stkhrkid=@idx and islmtip=@islmtip  \r\n and yertip='marketkart'\r\n\r\ninsert into stkhrk (firmano,stkhrkid,stkod,tarih,saat,belno,giren,cikan,brmfiykdvli,\r\nkdvyuz,ack,olususer,olustarsaat,islmtip,islmtipad,depkod,stktip,tabload,yertip,yerad,dataok)\r\nvalues\r\n(@firmano,@idx,@stkod,@tarx,@saatx,'',@giren,@cikan,@brmfiy,@kdvyuz,'',@user,@olustar,@islmtip,@islmtipad,\r\n@depkod,@tip,'marketkart','marketkart','MARKET STOK KARTI',0)\r\nend\r\n/*--------------------------------------------- */\r\n\r\n/*-----------tankkartı------------- */\r\nif @tip='akykt'\r\nbegin\r\nselect @firmano=firmano,@idx=id,@acmik=acmik,@olustar=olustarsaat,@user=olususer \r\nfrom tankkart where kod=@depkod\r\n\r\nset @tarx=convert(varchar,@olustar,101)\r\nset @saatx=convert(varchar,@olustar,108)\r\n\r\nif @acmik<>0\r\nbegin\r\n\r\nif @acmik>0\r\nset @giren=@acmik\r\n\r\nif @acmik<0\r\nset @cikan=-1*@acmik\r\n\r\n update stkhrk set sil=1 where stkhrkid=@idx and islmtip=@islmtip and yertip='tankkart' \r\n\r\ninsert into stkhrk (firmano,stkhrkid,stkod,tarih,saat,belno,giren,cikan,brmfiykdvli,\r\nkdvyuz,ack,olususer,olustarsaat,islmtip,islmtipad,depkod,stktip,tabload,yertip,yerad,dataok)\r\nvalues\r\n(@firmano,@idx,@stkod,@tarx,@saatx,'',@giren,@cikan,@brmfiy,@kdvyuz,'',@user,@olustar,@islmtip,@islmtipad,\r\n@depkod,@tip,'tankkart','tankkart','TANK KARTI',0);\r\n\r\nend\r\nend\r\n/*----------------------------- */\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "Surucu_Kaydet",
    "definition": "CREATE PROCEDURE [dbo].[Surucu_Kaydet]\r\n(@firmano    int,\r\n@cartip_id \tint,\r\n@carkod \tvarchar(30),\r\n@Ad \t\tvarchar(100),\r\n@userad  \tvarchar(100))\r\nAS\r\nBEGIN\r\n\r\n\r\n  if @Ad=''\r\n    return\r\n  \r\n\r\n \r\n  declare @car_id      int\r\n\r\n  \r\n   select @car_id=id From \r\n   Genel_Cari_Kart where CarTip_id=@cartip_id and Kod=@carkod\r\n  \r\n   if (Select COUNT(*) From Cari_Surucu with (nolock) Where cartip_id=@cartip_id \r\n   and car_id=@car_id and Ad=@Ad)=0  \r\n    insert into Cari_Surucu (firmano,cartip_id,car_id,car_kod,ad,olususer,olustarsaat)\r\n    select @firmano,@cartip_id,@car_id,@carkod,@Ad,@userad,getdate()\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "tablelogat",
    "definition": "CREATE PROCEDURE [dbo].tablelogat @tabload varchar(30),@islemtip char,@id float\r\nAS\r\nBEGIN\r\n/*islemtip */\r\n/*I insert */\r\n/*U update */\r\n/*D delete */\r\n  \r\n  \r\ninsert into tablelog (tablead,islemtip,hrkid) values (@tabload,@islemtip,@id)\r\n  \r\n  \r\nEND"
  },
  {
    "schema": "dbo",
    "name": "tabloalan",
    "definition": "CREATE PROCEDURE [dbo].tabloalan (@tabload varchar(30),@fieldstr nvarchar(4000) OUTPUT\r\n)\r\nAS\r\nBEGIN\r\ndeclare @alanadi varchar(40)\r\ndeclare @sqlstr varchar(1000)\r\n\r\n/*declare @fieldstr  varchar(1000); */\r\ndeclare @valuestr  varchar(8000);\r\n\r\nset @fieldstr=''\r\nset @valuestr=''\r\n\r\n  Declare curpos CURSOR static FOR\r\n  SELECT col.name FROM syscolumns as col\r\n  left join sysobjects as obj on obj.id=col.id\r\n  where obj.xtype='U' and obj.name=@tabload\r\n  order by colorder\r\n  OPEN curpos\r\n  FETCH First FROM curpos into @alanadi\r\n  WHILE (@@FETCH_STATUS = 0) begin\r\n\r\n   /* if @fieldstr='' */\r\n    set @fieldstr =cast(@alanadi as varchar)\r\n   /* else */\r\n   /* set @fieldstr = COALESCE(@fieldstr+',','' )+@alanadi */\r\n    FETCH Next FROM curpos into @alanadi\r\n  end;\r\n  CLOSE curpos\r\n  DEALLOCATE curpos\r\n\r\n\r\n  \r\n/*\r\n  EXEC(@sqlstr)\r\n  OPEN curposf\r\n  FETCH First FROM curposf into @alanadi\r\n  WHILE (@@FETCH_STATUS = 0) begin\r\n\r\n    if @valuestr=''\r\n    set @valuestr =@alanadi\r\n    else\r\n    set @valuestr = COALESCE(@valuestr+',','' )+@alanadi\r\n\r\n  FETCH Next FROM curposf into @alanadi\r\n  end;\r\n  CLOSE curposf\r\n  DEALLOCATE curposf\r\n\r\n*/\r\n\r\n\r\n/*'''+@fieldstr */\r\n  /*set @sqlstr='declare @valuestr varchar(8000); select @valuestr=COALESCE(@valuestr,'','')+cast(id as varchar)+'' ''+ad FROM '+@tabload+' '; */\r\n  /*EXEC(@sqlstr) */\r\n\r\n\r\n\r\nRETURN @fieldstr\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "TarihKapat",
    "definition": "CREATE PROCEDURE [dbo].TarihKapat\r\n@firmano      int,\r\n@bastar       datetime,\r\n@bittar       datetime,\r\n@drm          int,\r\n@user_Ad      varchar(100)\r\nAS\r\nBEGIN\r\n\r\n declare   @tar    datetime\r\n\r\n set @tar=@bastar\r\n \r\n \r\n \r\n   while @tar<=@bittar \r\n    begin\r\n    \r\n    if (select count(*) from tarih_kapat where \r\n    firmano=@firmano and Tarih=@tar and sil=0)=0 \r\n     insert into tarih_kapat \r\n     (firmano,tarih,drm,olususer,olustarsaat)\r\n     values (@firmano,@tar,@drm,@user_Ad,getdate())\r\n     else\r\n     update tarih_kapat \r\n     set drm=@drm,\r\n     deguser=@user_Ad,\r\n     degtarsaat=getdate()\r\n     where firmano=@firmano and Tarih=@tar\r\n     \r\n     \r\n     \r\n    \r\n    \r\n    \r\n    set @tar=DATEADD(day,1,@tar)\r\n    \r\n    end\r\n   \r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "userformolustur",
    "definition": "CREATE PROCEDURE [dbo].userformolustur\r\nAS\r\nBEGIN\r\ndeclare @grupkod varchar(30)\r\ndeclare @sr int;\r\n/*\r\n----------tanimlar\r\nset @grupkod='tanim'\r\nset @sr=10\r\ninsert into userformgrup (kod,ad,grpsr) values (@grupkod,'Tanım',@sr)\r\n\r\ninsert into userformlar (grupkod,formkod,fromack,sira) values (@grupkod,'firtan','Firma Tanımı',@sr+1)\r\ninsert into userformlar (grupkod,formkod,fromack,sira) values (@grupkod,'depotan','Depo Kart Tanımı',@sr+2)\r\ninsert into userformlar (grupkod,formkod,fromack,sira) values (@grupkod,'stkbrm','Stok Birim Tanımı',@sr+3)\r\ninsert into userformlar (grupkod,formkod,fromack,sira) values (@grupkod,'kurgrs','Kur Girişi',@sr+4)\r\ninsert into userformlar (grupkod,formkod,fromack,sira) values (@grupkod,'kultan','Kullanıcı Tanımı',@sr+5)\t\r\ninsert into userformlar (grupkod,formkod,fromack,sira) values (@grupkod,'sistemtan','Sistem Tanımları',@sr+6)\r\ninsert into userformlar (grupkod,formkod,fromack,sira) values (@grupkod,'raportan','Rapor Tanımı',@sr+7)\r\n\r\n\r\n\r\n\r\n----------grup kodları\r\nset @grupkod='kart'\r\nset @sr=20\r\ninsert into userformgrup (kod,ad,grpsr) values (@grupkod,'Kart',@sr)\r\n\r\ninsert into userformlar (grupkod,formkod,fromack,sira) values (@grupkod,'astokkart','Akaryakıt Stok Kart Tanımı',@sr+1)\r\ninsert into userformlar (grupkod,formkod,fromack,sira) values (@grupkod,'mstokkart','Market Stok Kart Tanımı',@sr+2)\r\ninsert into userformlar (grupkod,formkod,fromack,sira) values (@grupkod,'carikart','Cari Kart Tanımı',@sr+3)\r\ninsert into userformlar (grupkod,formkod,fromack,sira) values (@grupkod,'perkart','Personel Kart Tanımı',@sr+4)\r\ninsert into userformlar (grupkod,formkod,fromack,sira) values (@grupkod,'perakendekart','Perekande Kart Tanımı',@sr+5)\t\r\ninsert into userformlar (grupkod,formkod,fromack,sira) values (@grupkod,'gelgidkart','Gelir - Gider Kart Tanımı',@sr+6)\r\ninsert into userformlar (grupkod,formkod,fromack,sira) values (@grupkod,'bankkart','Banka Kart Tanımı',@sr+7)\r\ninsert into userformlar (grupkod,formkod,fromack,sira) values (@grupkod,'poskart','Pos Kart Tanımı',@sr+8)\r\ninsert into userformlar (grupkod,formkod,fromack,sira) values (@grupkod,'istkredikart','İşletme Kredi Kartları',@sr+9)\r\ninsert into userformlar (grupkod,formkod,fromack,sira) values (@grupkod,'sayackart','Sayaç Kart Tanımı',@sr+10)\r\ninsert into userformlar (grupkod,formkod,fromack,sira) values (@grupkod,'tankkart','Tank Kart Tanımı',@sr+11)\r\n*/\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "VAR_TANK_STOK_HESAPLA",
    "definition": "CREATE PROCEDURE [dbo].VAR_TANK_STOK_HESAPLA (\r\n@TIP VARCHAR(30),\r\n@VARNIN VARCHAR(max))\r\nAS\r\nBEGIN\r\n\r\ndeclare @varno           int\r\ndeclare @ac_tarih        datetime\r\ndeclare @ac_saat         varchar(10)\r\ndeclare @kap_tarih       datetime\r\ndeclare @kap_saat        varchar(10)\r\ndeclare @say             int\r\n\r\n   DECLARE CRS_VAR_DEPO_HRK CURSOR FAST_FORWARD FOR\r\n    select IntValue varno from CsvToInt_Max(@VARNIN)\r\n    OPEN CRS_VAR_DEPO_HRK\r\n     FETCH NEXT FROM CRS_VAR_DEPO_HRK INTO\r\n      @varno\r\n      WHILE @@FETCH_STATUS = 0\r\n      BEGIN\r\n\r\n      if @TIP='pomvardimas'\r\n      begin\r\n      SELECT @say=count(*),\r\n      @ac_tarih=tarih,@ac_saat=saat,\r\n      @kap_tarih=kaptar,@kap_saat=kapsaat\r\n      from pomvardimas with (nolock) where varno=@varno and sil=0\r\n      group by tarih,saat,kaptar,kapsaat\r\n\r\n       if @say>0\r\n        begin\r\n        /*-- stok son durumları */\r\n        DECLARE @TB_DEP_TARIH TABLE (\r\n        VAR_NO     FLOAT,\r\n        DEP_KOD    VARCHAR(30) COLLATE Turkish_CI_AS,\r\n        STOK_TIP   VARCHAR(10) COLLATE Turkish_CI_AS,\r\n        STOK_KOD   VARCHAR(30) COLLATE Turkish_CI_AS,\r\n        MIKTAR     FLOAT,\r\n        TUTAR      FLOAT)\r\n        INSERT INTO @TB_DEP_TARIH\r\n        SELECT * FROM DBO.DEPO_TARIHLI_STOKIN ('pomvardimas',@varno)\r\n\r\n        /*--- stoklar */\r\n        update pomvardistok set acmik=dt.miktar,\r\n        kalan=dt.miktar-satmik from pomvardistok as t join\r\n        (select STOK_TIP,STOK_KOD,isnull(sum(MIKTAR),0) as miktar\r\n        from  @TB_DEP_TARIH group by STOK_TIP,STOK_KOD) dt on t.varno=@varno\r\n        and dt.STOK_TIP=t.stktip and dt.STOK_KOD=t.kod\r\n\r\n        /*--- tanklar */\r\n        update pomvarditank set acmik=dt.miktar,kalan=dt.miktar-satmik \r\n        from pomvarditank as t join\r\n        (select DEP_KOD,STOK_TIP,STOK_KOD,isnull(MIKTAR,0) as miktar\r\n        from  @TB_DEP_TARIH )\r\n        dt on t.varno=@varno\r\n        and dt.DEP_KOD=t.kod and \r\n        dt.STOK_TIP=t.stktip and dt.STOK_KOD=t.stkod\r\n       end\r\n\r\n      end\r\n\r\n\r\n       FETCH NEXT FROM CRS_VAR_DEPO_HRK INTO\r\n       @varno\r\n      END\r\n      CLOSE CRS_VAR_DEPO_HRK\r\n      DEALLOCATE CRS_VAR_DEPO_HRK\r\n\r\n\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "vardirapicerik",
    "definition": "CREATE PROCEDURE [dbo].vardirapicerik\r\nAS\r\nBEGIN\r\n  TRUNCATE table marvardirapgoster\r\n  TRUNCATE table pomvardirapgoster\r\n  \r\n  \r\nINSERT INTO [dbo].[marvardirapgoster] ([id], [Ad], [Goster])\r\nVALUES (1, 'Emtia Satış', 1)\r\n\r\nINSERT INTO [dbo].[marvardirapgoster] ([id], [Ad], [Goster])\r\nVALUES (2, 'Dövizli Satış', 1)\r\n\r\nINSERT INTO [dbo].[marvardirapgoster] ([id], [Ad], [Goster])\r\nVALUES (3, 'Kdv Toplam', 1)\r\n\r\nINSERT INTO [dbo].[marvardirapgoster] ([id], [Ad], [Goster])\r\nVALUES (4, 'Satış / İade Dökümü', 1)\r\n\r\nINSERT INTO [dbo].[marvardirapgoster] ([id], [Ad], [Goster])\r\nVALUES (5, 'Cari Tahsilat / Ödemeler', 1)\r\n\r\nINSERT INTO [dbo].[marvardirapgoster] ([id], [Ad], [Goster])\r\nVALUES (6, 'Personel Tahsilat / Ödemeler', 1)\r\n\r\nINSERT INTO [dbo].[marvardirapgoster] ([id], [Ad], [Goster])\r\nVALUES (7, 'Gelir / Gider Tahsilat / Ödemeler', 1)\r\n\r\nINSERT INTO [dbo].[marvardirapgoster] ([id], [Ad], [Goster])\r\nVALUES (8, 'Genel Tahsilat / Ödemeler', 1)\r\n\r\nINSERT INTO [dbo].[marvardirapgoster] ([id], [Ad], [Goster])\r\nVALUES (9, 'Açık Fazla Dağılımı', 1)\r\n\r\nINSERT INTO [dbo].[marvardirapgoster] ([id], [Ad], [Goster])\r\nVALUES (10, 'Veresiye Fiş Dökümü', 1)\r\n\r\nINSERT INTO [dbo].[marvardirapgoster] ([id], [Ad], [Goster])\r\nVALUES  (11, 'Banka Dökümü', 1)\r\n\r\nINSERT INTO [dbo].[marvardirapgoster] ([id], [Ad], [Goster])\r\nVALUES (12, 'Çek / Senet Dökümü', 1)\r\n\r\nINSERT INTO [dbo].[marvardirapgoster] ([id], [Ad], [Goster])\r\nVALUES (13, 'Pos Dökümü', 1)\r\n\r\nINSERT INTO [dbo].[marvardirapgoster] ([id], [Ad], [Goster])\r\nVALUES (14, 'Nakit Teslimat', 1)\r\n\r\nINSERT INTO [dbo].[marvardirapgoster] ([id], [Ad], [Goster])\r\nVALUES (15, 'Vardiya Genel Toplam', 1)\r\n\r\n\r\nINSERT INTO [dbo].[marvardirapgoster] ([id], [Ad], [Goster])\r\nVALUES (16, 'Hizmet Satış', 1)\r\n\r\n/*-pomvardiya */\r\n\r\nINSERT INTO [dbo].[pomvardirapgoster] ([id], [Ad], [Goster])\r\nVALUES (1, 'Stok Miktarı', 1)\r\n\r\nINSERT INTO [dbo].[pomvardirapgoster] ([id], [Ad], [Goster])\r\nVALUES (2, 'Sayaclara Göre', 1)\r\n\r\nINSERT INTO [dbo].[pomvardirapgoster] ([id], [Ad], [Goster])\r\nVALUES (3, 'Nakit Teslimat', 1)\r\n\r\nINSERT INTO [dbo].[pomvardirapgoster] ([id], [Ad], [Goster])\r\nVALUES (4, 'Cari Tahislat - Ödemeleri', 1)\r\n\r\nINSERT INTO [dbo].[pomvardirapgoster] ([id], [Ad], [Goster])\r\nVALUES (5, 'Cari Veresiye', 1)\r\n\r\nINSERT INTO [dbo].[pomvardirapgoster] ([id], [Ad], [Goster])\r\nVALUES (6, 'Pos Dökümü', 1)\r\n\r\nINSERT INTO [dbo].[pomvardirapgoster] ([id], [Ad], [Goster])\r\nVALUES (7, 'Pos Grup Toplam', 1)\r\n\r\nINSERT INTO [dbo].[pomvardirapgoster] ([id], [Ad], [Goster])\r\nVALUES (8, 'Personel', 1)\r\n\r\nINSERT INTO [dbo].[pomvardirapgoster] ([id], [Ad], [Goster])\r\nVALUES (9, 'Emtia Satış', 1)\r\n\r\nINSERT INTO [dbo].[pomvardirapgoster] ([id], [Ad], [Goster])\r\nVALUES (10, 'Akaryakıt Satış', 1)\r\n\r\nINSERT INTO [dbo].[pomvardirapgoster] ([id], [Ad], [Goster])\r\nVALUES (11, 'Tanklara Gore  Stok', 1)\r\n\r\nINSERT INTO [dbo].[pomvardirapgoster] ([id], [Ad], [Goster])\r\nVALUES (12, 'Vardiya Genel Toplam', 1)\r\n\r\nINSERT INTO [dbo].[pomvardirapgoster] ([id], [Ad], [Goster])\r\nVALUES (13, 'Tahsilatlar', 1)\r\n\r\nINSERT INTO [dbo].[pomvardirapgoster] ([id], [Ad], [Goster])\r\nVALUES (14, 'Ödemeler', 1)\r\n\r\nINSERT INTO [dbo].[pomvardirapgoster] ([id], [Ad], [Goster])\r\nVALUES (15, 'Cari Veresiye Grup Toplam', 1)\r\n\r\n  \r\nEND"
  },
  {
    "schema": "dbo",
    "name": "Vardiya_Hrk_Tar_Ata",
    "definition": "CREATE PROCEDURE [dbo].Vardiya_Hrk_Tar_Ata\r\n(@Firmano    int,\r\n@varno \t\tint,\r\n@yertip   \tvarchar(50) )\r\nAS\r\nBEGIN\r\n\r\n\r\n declare  @drm     tinyint\r\n\r\n  select @drm=Var_Hrk_Tar_isle from sistemtanim\r\n\r\n  if not (@drm>0) \r\n     RETURN\r\n\r\n\r\n   declare @Tarih           datetime\r\n\r\n  if @yertip='pomvardimas' \r\n   begin\r\n   \r\n    \r\n   select @Tarih=tarih from pomvardimas with (nolock) where varno=@varno\r\n   and sil=0\r\n   \r\n   if not (@Tarih is null)\r\n    begin\r\n   \r\n\r\n      /* pos hrk  */\r\n       update poshrk set Tarih=@Tarih where \r\n         yertip=@yertip and varno=@varno\r\n         \r\n       /*fis   */\r\n       update veresimas set Tarih=@Tarih where \r\n         yertip=@yertip and varno=@varno\r\n         \r\n      /*kasa    */\r\n       update kasahrk set Tarih=@Tarih where \r\n         yertip=@yertip and varno=@varno\r\n        \r\n      /*emtia  */\r\n       update emtiasat set Tarih=@Tarih where \r\n         yertip=@yertip and varno=@varno  \r\n       \r\n       /*cari */\r\n       update carihrk set Tarih=@Tarih where \r\n         yertip=@yertip and varno=@varno     \r\n       \r\n       /*banka   */\r\n       update bankahrk set Tarih=@Tarih where \r\n         yertip=@yertip and varno=@varno \r\n         \r\n       /*cek    */\r\n        update cekkart set Tarih=@Tarih where \r\n         yertip=@yertip and varno=@varno \r\n         and drm in ('POR','KSN')   \r\n         \r\n      end\r\n    end \r\n     \r\n\r\n  \r\n if @yertip='marvardimas' \r\n   begin\r\n   \r\n    \r\n   select @Tarih=tarih from marvardimas with (nolock) where varno=@varno\r\n   and sil=0\r\n   \r\n   if not (@Tarih is null)\r\n    begin\r\n   \r\n\r\n      /* pos hrk  */\r\n       update poshrk set Tarih=@Tarih where \r\n         yertip=@yertip and varno=@varno\r\n         \r\n       /*fis   */\r\n       update veresimas set Tarih=@Tarih where \r\n         yertip=@yertip and varno=@varno\r\n         \r\n      /*kasa    */\r\n       update kasahrk set Tarih=@Tarih where \r\n         yertip=@yertip and varno=@varno\r\n        \r\n       \r\n      /*market satis stok    */\r\n       update marsatmas set Tarih=@Tarih where \r\n         yertip=@yertip and varno=@varno \r\n       \r\n       \r\n      \r\n       /*cari */\r\n       update carihrk set Tarih=@Tarih where \r\n         yertip=@yertip and varno=@varno     \r\n       \r\n       /*banka   */\r\n       update bankahrk set Tarih=@Tarih where \r\n         yertip=@yertip and varno=@varno \r\n         \r\n       /*cek    */\r\n        update cekkart set Tarih=@Tarih where \r\n         yertip=@yertip and varno=@varno \r\n         and drm in ('POR','KSN')   \r\n         \r\n   \r\n  \r\n       end\r\n    end \r\n      \r\n\r\n\r\n\r\n\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "Vardiya_Kasa_Kapat",
    "definition": "CREATE  PROCEDURE [dbo].Vardiya_Kasa_Kapat (\r\n@yertip varchar(20),\r\n@varno float)\r\nAS\r\nBEGIN\r\n  \r\n  DECLARE @HRK_KASKOD      VARCHAR(30)\r\n  DECLARE @HRK_BAKIYE      FLOAT\r\n  DECLARE @HRK_FIRMANO      FLOAT\r\n  DECLARE @HRK_KUR         FLOAT\r\n  DECLARE @VAR_TARIH\t   DATETIME\r\n  DECLARE @VAR_SAAT\t\t   VARCHAR(10)\r\n  DECLARE @VAR_USER        VARCHAR(50)\r\n  DECLARE @YER_AD          VARCHAR(50)\r\n  DECLARE @PARA_BRM        VARCHAR(10)\r\n\r\n  DECLARE @newid           FLOAT\r\n  DECLARE @giren           FLOAT\r\n  DECLARE @cikan           FLOAT\r\n  DECLARE @gctip           varchar(1)\r\n  \r\n  declare @islmtip         varchar(20)\r\n  declare @islmtipad       varchar(30)\r\n  declare @islmhrk         varchar(20)\r\n  declare @islmhrkad       varchar(30)\r\n\r\n  declare @ack             VARCHAR(50)\r\n\r\n  \r\n  select @islmtip=tip,@islmtipad=ad from islemturtip where tip='VAR'\r\n  select @islmhrk=hrk,@islmhrkad=ad from islemhrktip where tip='VAR' and hrk='VTO'\r\n  \r\n  select @YER_AD=ad from yertipad where kod=@yertip\r\n  \r\n  \r\n  \r\n  \r\n   declare  @drm     tinyint\r\n\r\n  select @drm=Var_Hrk_Tar_isle from sistemtanim\r\n  \r\n  if @yertip='pomvardimas'\r\n  select @ack=varad+' (POMPACI)',\r\n    @VAR_TARIH=kaptar,\r\n    @VAR_SAAT=kapsaat,\r\n    @VAR_USER=deguser from \r\n    pomvardimas WITH (NOLOCK) where varno=@varno and sil=0\r\n\r\n  \r\n   if @yertip='marvardimas'\r\n    select @ack=varad+' (MARKET)',\r\n      @VAR_TARIH=kaptar,\r\n      @VAR_SAAT=kapsaat,\r\n      @VAR_USER=deguser from \r\n     marvardimas WITH (NOLOCK) where varno=@varno and sil=0\r\n  \r\n\r\n   if (@drm>0) and (@yertip='pomvardimas') /*acılıs tarihi */\r\n     select\r\n     @ack=varad+' (POMPACI)', \r\n     @VAR_TARIH=tarih,\r\n     @VAR_SAAT=saat,\r\n     @VAR_USER=deguser from \r\n     pomvardimas WITH (NOLOCK) where varno=@varno and sil=0\r\n    \r\n   if (@drm>0) and (@yertip='marvardimas') /*acılıs tarihi */\r\n     select @ack=varad+' (MARKET)',\r\n     @VAR_TARIH=tarih,\r\n     @Var_saat=saat,\r\n     @VAR_USER=deguser from \r\n     marvardimas WITH (NOLOCK) where varno=@varno and sil=0\r\n  \r\n  \r\n /*ilgili vardiyadaki kasa cari tahsilat odemesini siliyoruz */\r\n /*cari tahsilat odeme cek odeme banka yatan çekilen vs. */\r\n delete from kasahrk where islmhrk='VTO' and varno=@varno and yertip=@yertip\r\n\r\n\r\n   DECLARE CRS_KASA_KAP CURSOR FAST_FORWARD FOR\r\n   select h.firmano,h.kaskod,h.parabrm,sum(h.giren-h.cikan),avg(kur) from kasahrk as h WITH (NOLOCK)\r\n   where h.varno=@varno and h.yertip=@yertip and h.sil=0 and h.islmhrk<>'TES'\r\n   group by h.firmano,h.kaskod,h.parabrm\r\n   \r\n   OPEN CRS_KASA_KAP\r\n   \r\n    FETCH NEXT FROM CRS_KASA_KAP INTO\r\n    @HRK_FIRMANO,@HRK_KASKOD,@PARA_BRM,@HRK_BAKIYE,@HRK_KUR\r\n\r\n      WHILE @@FETCH_STATUS = 0\r\n      BEGIN\r\n \r\n      set @giren=0\r\n      set @cikan=0\r\n      if @HRK_BAKIYE>0\r\n      begin\r\n      SET @gctip='C'\r\n      set @cikan=@HRK_BAKIYE\r\n      end\r\n\r\n      if @HRK_BAKIYE<0\r\n      begin\r\n      SET @gctip='G'\r\n      set @giren=(-1*@HRK_BAKIYE)\r\n      end\r\n\r\n     if abs(@HRK_BAKIYE)>0\r\n      begin\r\n      select @newid=0\r\n      insert into kasahrk (firmano,kaskod,kashrkid,gctip,varno,masterid,\r\n      fisfattip,fisfatid,\r\n      islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n      perkod,adaid,giren,cikan,bakiye,carkod,cartip,\r\n      tarih,saat,belno,ack,kur,varok,sil,olususer,\r\n      olustarsaat,parabrm,karsihestip,karsiheskod)\r\n      select @HRK_FIRMANO,@HRK_KASKOD,@newid,@gctip,@varno,@varno,'KENDI',0,\r\n      @islmtip,@islmtipad,@islmhrk,@islmhrkad,@yertip,@YER_AD,\r\n      'Diger',0,@giren,@cikan,0,'VRDKASA','vardikasa',@VAR_TARIH,@VAR_SAAT,\r\n      cast(@varno as varchar),@ack,\r\n      1,1,0,@VAR_USER,getdate(),'VRDKASA','kasakart',@HRK_KASKOD\r\n \r\n      select @newid=SCOPE_IDENTITY()\r\n      update kasahrk set kashrkid=@newid where id=@newid \r\n      \r\n      \r\n      \r\n      end\r\n\r\n      \r\n      FETCH NEXT FROM CRS_KASA_KAP INTO\r\n      @HRK_FIRMANO,@HRK_KASKOD,@PARA_BRM,@HRK_BAKIYE,@HRK_KUR\r\n      END\r\n\r\n     CLOSE CRS_KASA_KAP\r\n     DEALLOCATE CRS_KASA_KAP\r\n\r\n  \r\nEND"
  },
  {
    "schema": "dbo",
    "name": "veresiyegiris",
    "definition": "CREATE PROCEDURE [dbo].veresiyegiris @hrkid float\r\nAS\r\nBEGIN\r\n\r\ndeclare @varno float\r\ndeclare @baktop float\r\ndeclare @newid float\r\ndeclare @fistip varchar(3)\r\ndeclare @gctip varchar(1)\r\ndeclare @borc float,@alacak float\r\ndeclare @tutar float\r\ndeclare @say int\r\n\r\ndeclare @cartip varchar(20)\r\ndeclare @verid float\r\n\r\nselect @fistip=fistip,@verid=verid,\r\n@tutar=toptut,@varno=varno,@cartip=cartip from veresimas with (nolock) \r\nwhere verid=@hrkid\r\n\r\nset @borc=0\r\nset @alacak=0\r\n\r\nif @fistip='BOR'\r\nbegin\r\nset @gctip='B'\r\nset @borc=@tutar\r\nend\r\n\r\nif @fistip='ALC'\r\nbegin\r\nset @gctip='A'\r\nset @alacak=@tutar\r\nend\r\n\r\n\r\nif (@cartip='carikart') or (@cartip='perkart') or (@cartip='gelgidkart')\r\nbegin\r\n  delete from carihrk where masterid=@hrkid and islmtip='FIS'\r\n\r\n  select @newid=0\r\n  insert into carihrk (carhrkid,gctip,masterid,islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n  cartip,carkod,borc,alacak,tarih,saat,olususer,olustarsaat,vadetar,belno,\r\n  ack,varno,kur,dataok,pro,varok,perkod,adaid,deguser,degtarsaat,sil,parabrm,fisaktip)\r\n  select @newid,@gctip,@verid,'FIS','Fiş Girişi',@fistip,fisad,yertip,yerad,\r\n  cartip,carkod,@borc,@alacak,tarih,saat,olususer,olustarsaat,vadtar,seri+cast([no] as varchar),\r\n  ack,varno,kur,dataok,1,varok,perkod,adaid,deguser,degtarsaat,sil,parabrm,aktip\r\n  from veresimas with (nolock) where verid=@hrkid\r\n  \r\n  select @newid=SCOPE_IDENTITY()\r\n  update carihrk set carhrkid=@newid where id=@newid\r\n\r\n\r\nEND\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "verfisfatsaktar",
    "definition": "CREATE PROCEDURE [dbo].verfisfatsaktar(\r\n@firmano    int,\r\n@fatrap_id   int,\r\n@aktip      varchar(10),\r\n@fistarih   bit,\r\n@ortbrm     bit,\r\n@tutar_sec  bit,\r\n@cartip     varchar(10),\r\n@carkod     varchar(30),\r\n@veridin    varchar(8000),\r\n@tutartl    float,\r\n@bel_seri   varchar(50),\r\n@bel_no     varchar(50),\r\n@fattarih   datetime,\r\n@userad     varchar(50),\r\n@ack        varchar(200),\r\n@isk_tip\ttinyint,\r\n@isk_oran\tfloat)\r\nAS\r\n BEGIN\r\n\r\n\r\n  DECLARE @EKSTRE_TEMPAK TABLE (\r\n  verid      varchar(30))\r\n\r\n   declare @hrk_id        int\r\n   declare @hrk_verid     int\r\n   declare @fishrk_kaltut float\r\n   declare @fishrktut     float\r\n   declare @brmfiy        float\r\n   declare @gctip         varchar(1)\r\n   declare @giren         float\r\n   declare @cikan         float\r\n   declare @newid         int\r\n   declare @islmtip       varchar(20)\r\n   declare @islmhrk       varchar(20)\r\n   declare @yertip        varchar(20)\r\n   declare @yertipad      varchar(30)\r\n   declare @islmtipad     varchar(30)\r\n   declare @islmhrkad     varchar(30)\r\n   declare @saatx         varchar(8)\r\n   declare @tarx          datetime\r\n   declare @parabrm       varchar(8)\r\n   declare @parakur       float\r\n   declare @say           int\r\n   declare @mesaj         varchar(300)\r\n   declare @fatvadtip     varchar(20)\r\n   declare @fatvadsur     int\r\n   declare @vadtarih      datetime\r\n   declare @cartip_id\t  int\r\n   declare @car_id\t  \t  int\r\n   declare @fattip_id  \t  int\r\n   declare @fattur_id     int\r\n   declare @fattipad\t  varchar(100)\r\n   declare @fis_iskonto\t  float\r\n   declare @fis_isk_kart_kod   varchar(30)\r\n   declare @cari_unvan   varchar(150)\r\n   declare @kaptip\t\t varchar(30)\r\n   declare @fattip\t\t varchar(30)\r\n   \r\n   declare @Hrk_Stk_Pro    bit\r\n   \r\n   declare   @AvansTakip  bit\r\n   declare   @Karsi_Cartipid  int\r\n   declare   @Karsi_Carid     int \r\n   \r\n   declare   @Karsi_Hrk_Pro   bit  \r\n   \r\n  /* declare @fisno         int */\r\n   \r\n   declare @fatiskyuz     float\r\n   \r\n   select @car_id=id,@cartip_id=tip_id,\r\n   @fis_iskonto=fis_iskonto,\r\n   @cari_unvan=ad from \r\n   Genel_Kart as k with (nolock) where \r\n   k.cartp=@cartip and k.kod=@carkod\r\n   \r\n\r\n    if @isk_tip=1\r\n    set @isk_oran=@fis_iskonto\r\n   \r\n   \r\n   \r\n   select @parabrm=sistem_parabrm,\r\n   @fis_isk_kart_kod=fis_iskonto_kart from sistemtanim\r\n   \r\n   set @tarx=convert(varchar,getdate(),101);\r\n   set @saatx=convert(varchar,getdate(),108);\r\n   \r\n\r\n   \r\n   if (@tutar_sec=0) /*tutar girilmemissse */\r\n    begin\r\n       Insert @EKSTRE_TEMPAK\r\n       select * from CsvToInt(@veridin)\r\n       \r\n       select @tutartl=sum(case when v.fistip='FISVERSAT' THEN \r\n       (v.toptut-v.isktop) else -1*(v.toptut-v.isktop) end ) from veresimas as v with (nolock)\r\n        WHERE v.sil=0 and v.verid in (select * from @EKSTRE_TEMPAK)\r\n    end\r\n    \r\n    \r\n    set @tutartl=round(@tutartl,2)\r\n    \r\n   \r\n   if (@tutartl>0) and (@tutar_sec=1)  /*tutar girilmisse */\r\n   begin\r\n    set @fishrk_kaltut=@tutartl\r\n\r\n    DECLARE VERFF_HRK CURSOR FAST_FORWARD FOR\r\n    SELECT  v.id,v.verid,Round((v.toptut-v.isktop),2) FROM veresimas as v with (nolock)\r\n    WHERE v.sil=0 and v.verid in (select * from CsvToInt(@veridin))\r\n    order by v.id\r\n    OPEN VERFF_HRK\r\n    \r\n    FETCH NEXT FROM VERFF_HRK INTO\r\n    @hrk_id,@hrk_verid,@fishrktut\r\n    WHILE @@FETCH_STATUS = 0\r\n    BEGIN\r\n\r\n\r\n    if @fishrk_kaltut>0\r\n     Insert @EKSTRE_TEMPAK Values (@hrk_verid)\r\n\r\n\r\n\r\n     if round(@fishrk_kaltut,2)<round(@fishrktut,2)\r\n     begin\r\n      set @fishrk_kaltut=round(@fishrk_kaltut,2)\r\n      if round(@fishrk_kaltut,2)>0  \r\n       exec fisparcala @hrk_verid,@fishrk_kaltut\r\n      break\r\n     end\r\n\r\n      set @fishrk_kaltut=Round(@fishrk_kaltut-@fishrktut,2)\r\n\r\n\r\n    FETCH NEXT FROM VERFF_HRK INTO\r\n    @hrk_id,@hrk_verid,@fishrktut\r\n    END\r\n\r\n    CLOSE VERFF_HRK\r\n    DEALLOCATE VERFF_HRK\r\n  end  /*tutar girilmisse */\r\n  \r\n  \r\n    /*seçilen fişler içinde aktarılmıs varmı? */\r\n     select @say=count(*) from veresimas as vs with (nolock) where \r\n     aktip not in ('BK','BL')\r\n     and vs.verid in (select * from @EKSTRE_TEMPAK)\r\n\r\n      if @say>0\r\n           begin\r\n           SELECT @MESAJ = 'Seçmiş Olduğunuz Fişler İçinde Aktarılmış Fişler Var..!'\r\n           RAISERROR (@MESAJ, 16,1)\r\n           RETURN\r\n       end\r\n   /*seçilen fişler */\r\n  \r\n  \r\n  \r\n  \r\n  /*---------cari aktarim */\r\n   if (@aktip='CH') or (@aktip='TEK_CH')\r\n    begin\r\n    \r\n      if @tutartl>0\r\n      begin\r\n      set @cikan=0\r\n      set @giren=@tutartl\r\n      set @gctip='B'\r\n      end\r\n      \r\n      if @tutartl<0\r\n      begin\r\n      set @cikan=@tutartl\r\n      set @giren=0\r\n      set @gctip='A'\r\n      end\r\n      \r\n      set  @islmtip='FIS'\r\n      set  @islmhrk='CAK'\r\n      set  @yertip='carikart'\r\n      select @yertipad=ad from yertipad where kod=@yertip\r\n      select @islmtipad=ad from islemturtip where tip=@islmtip\r\n      select @islmhrkad=ad from islemhrktip where tip=@islmtip and hrk=@islmhrk\r\n\r\n     \r\n\r\n       IF (@aktip='TEK_CH') /*--ch tek cari hrk işlenmesi */\r\n       begin\r\n\r\n         select @newid=0\r\n\r\n        insert into carihrk (firmano,gctip,islmtip,islmtipad,\r\n        islmhrk,islmhrkad,yertip,yerad,\r\n        cartip_id,cartip,masterid,varno,carhrkid,perkod,\r\n        adaid,tarih,vadetar,saat,\r\n        car_id,carkod,\r\n        belno,ack,borc,alacak,kur,parabrm,olususer,olustarsaat,\r\n        fisfattip,fisaktip,fisid,plaka,surucu)\r\n        select @firmano,@gctip,@islmtip,@islmtipad,@islmhrk,\r\n        @islmhrkad,@yertip,@yertipad,\r\n        @cartip_id,@cartip,@newid,0,@newid,'',0,\r\n        case when @fistarih=0 then\r\n        @fattarih else tarih end,\r\n        vadtar,@saatx,\r\n        @car_id,@carkod,(vs.seri+vs.no),@ack+' PLAKA :'+vs.plaka+' SURUCU :'+vs.surucu, /*@ackfatno */\r\n        case when vs.fistip='FISVERSAT' THEN \r\n        (vs.toptut-vs.isktop)*(1-(@isk_oran/100)) else 0 end,\r\n        case when fistip='FISALCSAT' THEN \r\n        toptut*(1-(@isk_oran/100)) else 0 end,1,\r\n        @parabrm,@userad,getdate(),@islmhrk,\r\n        'CT',vs.verid,vs.plaka,vs.surucu\r\n        from veresimas as vs with (nolock) where \r\n        vs.verid in (select * from @EKSTRE_TEMPAK)\r\n        \r\n        select @newid=SCOPE_IDENTITY()\r\n        update carihrk set masterid=@newid,carhrkid=@newid where fisid in (select * from @EKSTRE_TEMPAK)\r\n        \r\n\r\n        update veresimas  set aktip='CT',akid=@newid,aktar=@fattarih\r\n         where verid in (select * from @EKSTRE_TEMPAK)\r\n         \r\n         \r\n         /*- iskonto kartıı yansıttt */\r\n         \r\n         \r\n         set @islmtip='GLG'  \r\n         set @islmhrk='FSI'\r\n         select @islmtipad=ad from islemturtip where tip=@islmtip\r\n         select @islmhrkad=ad from islemhrktip where tip=@islmtip and hrk=@islmhrk\r\n\r\n          \r\n        if @isk_oran>0\r\n        insert into carihrk (firmano,gctip,islmtip,islmtipad,\r\n        islmhrk,islmhrkad,yertip,yerad,\r\n        cartip_id,cartip,masterid,varno,carhrkid,perkod,\r\n        adaid,tarih,vadetar,saat,\r\n        car_id,carkod,\r\n        belno,ack,borc,alacak,kur,parabrm,olususer,olustarsaat,\r\n        fisfattip,fisaktip,fisid,plaka,surucu)\r\n        select @firmano,@gctip,@islmtip,@islmtipad,@islmhrk,\r\n        @islmhrkad,@yertip,@yertipad,\r\n        3,'gelgidkart',@newid,0,@newid,'',0,\r\n        case when @fistarih=0 then\r\n        @fattarih else tarih end,\r\n        vadtar,@saatx,\r\n        0,@fis_isk_kart_kod,(vs.seri+vs.no),'FİŞ İSKONTO / CARI KOD '+\r\n        @carkod+' CARI ÜNVANI '+@cari_unvan+' %'+\r\n        cast(@isk_oran as varchar(20))+\r\n        ' ( '+cast( round(((vs.toptut-vs.isktop)),2)  as varchar(20))+\r\n        ' ) ',\r\n        case when vs.fistip='FISVERSAT' THEN \r\n        (vs.toptut-vs.isktop)*(@isk_oran/100) else 0 end,\r\n        case when fistip='FISALCSAT' THEN \r\n        toptut*(@isk_oran/100) else 0 end,1,\r\n        @parabrm,@userad,getdate(),@islmhrk,'CT',vs.verid,'',''\r\n        from veresimas as vs with (nolock) where  \r\n        vs.verid in (select * from @EKSTRE_TEMPAK)\r\n               \r\n       \r\n      end /*--ch tek cari hrk işlenmesi */\r\n\r\n      if (@aktip='CH')/*ch toplu cari hrk işlenmesi */\r\n      begin\r\n      \r\n       select @newid=0\r\n      \r\n      insert into carihrk (firmano,gctip,islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n      cartip_id,cartip,masterid,varno,carhrkid,perkod,adaid,tarih,vadetar,saat,\r\n      car_id,carkod,\r\n      belno,ack,borc,alacak,kur,parabrm,olususer,olustarsaat,\r\n      fisfattip,fisaktip,fisid)\r\n      select @firmano,@gctip,@islmtip,@islmtipad,@islmhrk,@islmhrkad,\r\n      @yertip,@yertipad,\r\n      @cartip_id,@cartip,@newid,0,@newid,'',0,\r\n      @fattarih,@fattarih,@saatx,\r\n      @car_id,@carkod,(@bel_seri+@bel_no),@ack,\r\n      @giren*(1-(@isk_oran/100)),(-1*@cikan)*(1-(@isk_oran/100)),\r\n      1,@parabrm,@userad,getdate(),@islmhrk,\r\n      @aktip,0\r\n      \r\n       select @newid=SCOPE_IDENTITY()\r\n       update carihrk set masterid=@newid,carhrkid=@newid where id=@newid\r\n        \r\n\r\n      update veresimas  set aktip='CH',akid=@newid,aktar=@fattarih\r\n      where verid in (select * from @EKSTRE_TEMPAK)\r\n         \r\n         \r\n      /*-iskonto yansıması   */\r\n      \r\n      if @isk_oran>0 \r\n      insert into carihrk (firmano,gctip,islmtip,islmtipad,\r\n        islmhrk,islmhrkad,yertip,yerad,\r\n        cartip_id,cartip,masterid,varno,carhrkid,perkod,\r\n        adaid,tarih,vadetar,saat,\r\n        car_id,carkod,\r\n        belno,ack,borc,alacak,kur,parabrm,olususer,olustarsaat,\r\n        fisfattip,fisaktip,fisid,plaka,surucu)\r\n        select @firmano,@gctip,@islmtip,@islmtipad,@islmhrk,\r\n        @islmhrkad,@yertip,@yertipad,\r\n        3,'gelgidkart',@newid,0,@newid,'',0,\r\n        @fattarih,@fattarih,@saatx,\r\n        0,@fis_isk_kart_kod,(@bel_seri+@bel_no),'FİŞ İSKONTO / CARI KOD '+\r\n        @carkod+' CARI ÜNVANI '+@cari_unvan+' %'+\r\n        cast(@isk_oran as varchar(20))+\r\n        ' ( '+cast( round((( ABS(@giren+@cikan))),2)  as varchar(20))+\r\n        ' ) ',\r\n        @giren*(@isk_oran/100),(-1*@cikan)*(@isk_oran/100), \r\n        1,@parabrm,@userad,getdate(),@islmhrk,@aktip,0,'',''\r\n              \r\n       \r\n         \r\n         \r\n\r\n      end/*---aktip ch */\r\n      \r\n      \r\n      \r\n\r\n    end\r\n\r\n /*------cari aktarim */\r\n\r\n  if @aktip='FT'\r\n   begin\r\n   select @gctip=f.gctip,\r\n   @fattip=r.rapkod,\r\n   @fattip_id=tip_id,\r\n   @fattur_id=tur_id,\r\n   @fattipad=r.ack\r\n  /* @Hrk_Stk_Pro=r.hrk_stk_pro */\r\n   from raporlar r left join fattip f on f.kod=r.rapkod \r\n   where r.sil=0  and r.id=@fatrap_id\r\n    /*'FATVERSAT' */\r\n  \r\n  \r\n  \r\n      set @Hrk_Stk_Pro=0\r\n      set @kaptip='VER'\r\n      if @fattip='FATTTSSAT'\r\n      begin\r\n       set @kaptip='FAT'\r\n       set @Hrk_Stk_Pro=1\r\n      end \r\n       \r\n       \r\n      set  @islmtip=@fattip\r\n      /*'FATVERSAT' */\r\n      set  @islmhrk='satis'\r\n      set  @yertip='carikart'\r\n      select @yertipad=ad from yertipad where kod=@yertip\r\n      /*select @islmtipad=ad from fattip where kod=@islmtip */\r\n\r\n    set @vadtarih=@fattarih\r\n    \r\n    if @cartip='carikart'\r\n     begin\r\n      select @fatvadtip=k.fatvadtip,@fatvadsur=k.fatvadsur,\r\n      @fatiskyuz=k.fatisk,\r\n      @Karsi_Cartipid=1,\r\n      @Karsi_Carid=fat_car_id,\r\n      @Karsi_Hrk_Pro=fat_car_sec,\r\n      @AvansTakip=AvansTakip\r\n      from carikart as k with (nolock) where\r\n      k.kod=@carkod\r\n      select @vadtarih=dbo.vadtarihver (@fatvadtip,@fatvadsur,@fattarih)\r\n     end\r\n     \r\n     \r\n      /*select @newid=isnull(max(fatid),0)+1 from faturamas */\r\n\r\n      insert into faturamas (firmano,\r\n      gctip,fatrap_id,fattip_id,fattur_id,\r\n      fatad,fatid,tarih,vadtar,saat,yuvtop,\r\n      gen_ind_tip,geniskyuz,genisktop,\r\n      fattip,fattur,fatseri,fatno,\r\n      cartip_id,cartip,car_id,carkod,kdvtip,ack,\r\n      olususer,olustarsaat,deguser,degtarsaat,\r\n      parabrm,kur,kaptip,kayok,hrk_car_pro,hrk_stk_pro,\r\n      Karsi_Cartip_id,Karsi_Car_id,Hrk_Karsi_Pro,AvansTakip)\r\n      select @firmano,@gctip,@fatrap_id,@fattip_id,@fattur_id,\r\n      @fattipad,0,@fattarih,@vadtarih,@saatx,0,\r\n      0,0,0,\r\n      @islmtip,@islmhrk,@bel_seri,@bel_no,\r\n      @cartip_id,@cartip,@car_id,@carkod,'Hariç',@ack,/*'TOPLU FATURALANDIRMA' */\r\n      @userad,GETDATE(),'',null,@parabrm,1,@kaptip,0,1,@Hrk_Stk_Pro,\r\n      @Karsi_Cartipid,@Karsi_Carid,@Karsi_Hrk_Pro,@AvansTakip\r\n      \r\n      select @newid=SCOPE_IDENTITY()\r\n      update faturamas  set fatid=@newid where id=@newid\r\n      \r\n    \r\n      if @ortbrm=1\r\n        insert into faturahrk \r\n        (firmano,fatid,stktip_id,stktip,stk_id,stkod,mik,brim,ustbrim,carpan,\r\n        brmfiy,depkod,kdvtip,\r\n        kdvyuz,kdvtut,satiskyuz,satisktut,otvbrim,otvyuz,otvtut,olususer,olustarsaat,\r\n        parabrim,Kart_ParaBrm,Kart_kur,OtoTag)\r\n        \r\n        select @firmano,@newid,stktip_id,stktip,stk_id,stkod,sum(mik),brim,\r\n        brim,1, round(sum( ( ( (brmfiy*(1-(iskyuz/100)) ) / (1+kdvyuz) ) * mik )),12)\r\n        / sum(mik),'','Hariç',Kdvyuz,\r\n        0,\r\n        0,0,0,0,0,@userad,getdate(),'TL','TL',1,OtoTag\r\n        from veresihrk as h WITH (NOLOCK) \r\n        inner join veresimas as m WITH (NOLOCK)\r\n        on m.verid=h.verid and m.sil=0 and h.sil=0 \r\n        where m.verid in (select * from @EKSTRE_TEMPAK)\r\n        group by stktip_id,stktip,stk_id,stkod,iskyuz,brim,kdvyuz,OtoTag\r\n      else\r\n        insert into faturahrk (firmano,fatid,stktip_id,stktip,stk_id,stkod,mik,brim,ustbrim,carpan,brmfiy,depkod,kdvtip,\r\n        kdvyuz,kdvtut,satiskyuz,satisktut,otvbrim,otvyuz,otvtut,olususer,olustarsaat,\r\n        parabrim,Kart_ParaBrm,Kart_kur,OtoTag)\r\n        \r\n        select @firmano,@newid,stktip_id,stktip,stk_id,stkod,sum(mik),brim,brim,1,\r\n        round(cast((brmfiy*(1-(isnull(iskyuz,0)/100)))/(1+kdvyuz) as float),12),'','Dahil',\r\n        kdvyuz,0,0,0,0,0,0,@userad,getdate(),'TL','TL',1,OtoTag\r\n        from veresihrk h WITH (NOLOCK) \r\n        inner join veresimas as m WITH (NOLOCK)\r\n        on m.verid=h.verid and m.sil=0 and h.sil=0 \r\n        where m.verid in (select * from @EKSTRE_TEMPAK)\r\n        group by stktip_id,stktip,stk_id,stkod,\r\n        round(cast((brmfiy*(1-(isnull(iskyuz,0)/100)))/(1+kdvyuz) as float),12),\r\n        iskyuz,brim,kdvyuz,OtoTag\r\n        \r\n        \r\n        /*Depo Kart TTS ise */\r\n        if @fattip='FATTTSSAT'\r\n         update faturahrk set Depkod=dt.Kod,dep_id=dt.id From faturahrk as t join\r\n         (select id,Kod,Bagak From tankkart as t with (nolock) where t.sil=0 ) dt\r\n         on dt.Bagak=T.stkod and t.fatid=@newid\r\n                 \r\n\r\n\r\n        update veresimas  set aktip='FT',\r\n        akid=@newid,\r\n        fatid=@newid,aktar=@fattarih\r\n        where verid in (select * from @EKSTRE_TEMPAK)\r\n        \r\n        update faturamas  set kayok=1 where fatid=@newid\r\n\r\n        \r\n        exec Fatura_Cari_Stok_Iskonto @newid\r\n        \r\n        \r\n        exec Fatura_Genel_indirim @newid,0,@fatiskyuz\r\n   \r\n        \r\n        update faturamas  set kayok=1 where fatid=@newid\r\n    end\r\n\r\n   select @newid as fatid\r\n\r\n END"
  },
  {
    "schema": "dbo",
    "name": "verfisfatsaktar_Max",
    "definition": "CREATE PROCEDURE [dbo].[verfisfatsaktar_Max](\r\n@firmano    int,\r\n@fatrap_id   int,\r\n@aktip      varchar(10),\r\n@fistarih   bit,\r\n@ortbrm     bit,\r\n@tutar_sec  bit,\r\n@cartip     varchar(10),\r\n@carkod     varchar(30),\r\n@veridin    varchar(max),\r\n@tutartl    float,\r\n@bel_seri   varchar(50),\r\n@bel_no     varchar(50),\r\n@fattarih   datetime,\r\n@userad     varchar(50),\r\n@ack        varchar(200),\r\n@isk_tip\ttinyint,\r\n@isk_oran\tfloat)\r\nAS\r\n BEGIN\r\n\r\n\r\n  DECLARE @EKSTRE_TEMPAK TABLE (\r\n  verid      varchar(30))\r\n\r\n   declare @hrk_id        int\r\n   declare @hrk_verid     int\r\n   declare @fishrk_kaltut float\r\n   declare @fishrktut     float\r\n   declare @brmfiy        float\r\n   declare @gctip         varchar(1)\r\n   declare @giren         float\r\n   declare @cikan         float\r\n   declare @newid         int\r\n   declare @islmtip       varchar(20)\r\n   declare @islmhrk       varchar(20)\r\n   declare @yertip        varchar(20)\r\n   declare @yertipad      varchar(30)\r\n   declare @islmtipad     varchar(30)\r\n   declare @islmhrkad     varchar(30)\r\n   declare @saatx         varchar(8)\r\n   declare @tarx          datetime\r\n   declare @parabrm       varchar(8)\r\n   declare @parakur       float\r\n   declare @say           int\r\n   declare @mesaj         varchar(300)\r\n   declare @fatvadtip     varchar(20)\r\n   declare @fatvadsur     int\r\n   declare @vadtarih      datetime\r\n   declare @cartip_id\t  int\r\n   declare @car_id\t  \t  int\r\n   declare @fattip_id  \t  int\r\n   declare @fattur_id     int\r\n   declare @fattipad\t  varchar(100)\r\n   declare @fis_iskonto\t  float\r\n   declare @fis_isk_kart_kod   varchar(30)\r\n   declare @cari_unvan   varchar(150)\r\n   declare @kaptip\t\t varchar(30)\r\n   declare @fattip\t\t varchar(30)\r\n   \r\n   declare @Hrk_Stk_Pro    bit\r\n   \r\n   declare   @AvansTakip  bit\r\n   declare   @Karsi_Cartipid  int\r\n   declare   @Karsi_Carid     int \r\n   \r\n   declare   @Karsi_Hrk_Pro   bit  \r\n   \r\n  /* declare @fisno         int */\r\n   \r\n   declare @fatiskyuz     float\r\n   \r\n   select @car_id=id,@cartip_id=tip_id,\r\n   @fis_iskonto=fis_iskonto,\r\n   @cari_unvan=ad from \r\n   Genel_Kart as k where \r\n   k.cartp=@cartip and k.kod=@carkod\r\n   \r\n\r\n    if @isk_tip=1\r\n    set @isk_oran=@fis_iskonto\r\n   \r\n   \r\n   \r\n   select @parabrm=sistem_parabrm,\r\n   @fis_isk_kart_kod=fis_iskonto_kart from sistemtanim\r\n   \r\n   set @tarx=convert(varchar,getdate(),101);\r\n   set @saatx=convert(varchar,getdate(),108);\r\n   \r\n\r\n   \r\n   if (@tutar_sec=0) /*tutar girilmemissse */\r\n    begin\r\n       Insert @EKSTRE_TEMPAK\r\n       select * from CsvToInt_Max(@veridin)\r\n       \r\n       select @tutartl=sum(case when v.fistip='FISVERSAT' THEN \r\n       (v.toptut-v.isktop) else -1*(v.toptut-v.isktop) end ) from veresimas as v with (nolock)\r\n        WHERE v.sil=0 and v.verid in (select * from @EKSTRE_TEMPAK)\r\n    end\r\n    \r\n    \r\n    set @tutartl=round(@tutartl,2)\r\n    \r\n   \r\n   if (@tutartl>0) and (@tutar_sec=1)  /*tutar girilmisse */\r\n   begin\r\n    set @fishrk_kaltut=@tutartl\r\n\r\n    DECLARE VERFF_HRK CURSOR FAST_FORWARD FOR\r\n    SELECT  v.id,v.verid,Round((v.toptut-v.isktop),2) FROM veresimas as v with (nolock)\r\n    WHERE v.sil=0 and v.verid in (select * from CsvToInt_Max(@veridin))\r\n    order by v.id\r\n    OPEN VERFF_HRK\r\n    \r\n    FETCH NEXT FROM VERFF_HRK INTO\r\n    @hrk_id,@hrk_verid,@fishrktut\r\n    WHILE @@FETCH_STATUS = 0\r\n    BEGIN\r\n\r\n\r\n    if @fishrk_kaltut>0\r\n     Insert @EKSTRE_TEMPAK Values (@hrk_verid)\r\n\r\n\r\n\r\n     if round(@fishrk_kaltut,2)<round(@fishrktut,2)\r\n     begin\r\n      set @fishrk_kaltut=round(@fishrk_kaltut,2)\r\n      if round(@fishrk_kaltut,2)>0  \r\n       exec fisparcala @hrk_verid,@fishrk_kaltut\r\n      break\r\n     end\r\n\r\n      set @fishrk_kaltut=Round(@fishrk_kaltut-@fishrktut,2)\r\n\r\n\r\n    FETCH NEXT FROM VERFF_HRK INTO\r\n    @hrk_id,@hrk_verid,@fishrktut\r\n    END\r\n\r\n    CLOSE VERFF_HRK\r\n    DEALLOCATE VERFF_HRK\r\n  end  /*tutar girilmisse */\r\n  \r\n  \r\n    /*seçilen fişler içinde aktarılmıs varmı? */\r\n     select @say=count(*) from veresimas as vs with (nolock) where \r\n     aktip not in ('BK','BL')\r\n     and vs.verid in (select * from @EKSTRE_TEMPAK)\r\n\r\n      if @say>0\r\n           begin\r\n           SELECT @MESAJ = 'Seçmiş Olduğunuz Fişler İçinde Aktarılmış Fişler Var..!'\r\n           RAISERROR (@MESAJ, 16,1)\r\n           RETURN\r\n       end\r\n   /*seçilen fişler */\r\n  \r\n  \r\n  \r\n  \r\n  /*---------cari aktarim */\r\n   if (@aktip='CH') or (@aktip='TEK_CH')\r\n    begin\r\n    \r\n      if @tutartl>0\r\n      begin\r\n      set @cikan=0\r\n      set @giren=@tutartl\r\n      set @gctip='B'\r\n      end\r\n      \r\n      if @tutartl<0\r\n      begin\r\n      set @cikan=@tutartl\r\n      set @giren=0\r\n      set @gctip='A'\r\n      end\r\n      \r\n      set  @islmtip='FIS'\r\n      set  @islmhrk='CAK'\r\n      set  @yertip='carikart'\r\n      select @yertipad=ad from yertipad where kod=@yertip\r\n      select @islmtipad=ad from islemturtip where tip=@islmtip\r\n      select @islmhrkad=ad from islemhrktip where tip=@islmtip and hrk=@islmhrk\r\n\r\n     \r\n\r\n       IF (@aktip='TEK_CH') /*--ch tek cari hrk işlenmesi */\r\n       begin\r\n\r\n\r\n        select @newid=0\r\n        insert into carihrk (firmano,gctip,islmtip,islmtipad,\r\n        islmhrk,islmhrkad,yertip,yerad,\r\n        cartip_id,cartip,masterid,varno,carhrkid,perkod,\r\n        adaid,tarih,vadetar,saat,\r\n        car_id,carkod,\r\n        belno,ack,borc,alacak,kur,parabrm,olususer,olustarsaat,\r\n        fisfattip,fisaktip,fisid,plaka,surucu)\r\n        select @firmano,@gctip,@islmtip,@islmtipad,@islmhrk,\r\n        @islmhrkad,@yertip,@yertipad,\r\n        @cartip_id,@cartip,@newid,0,@newid,'',0,\r\n        case when @fistarih=0 then\r\n        @fattarih else tarih end,\r\n        vadtar,@saatx,\r\n        @car_id,@carkod,(vs.seri+vs.no),@ack+' PLAKA :'+vs.plaka+' SURUCU :'+vs.surucu, /*@ackfatno */\r\n        case when vs.fistip='FISVERSAT' THEN \r\n        (vs.toptut-vs.isktop)*(1-(@isk_oran/100)) else 0 end,\r\n        case when fistip='FISALCSAT' THEN \r\n        toptut*(1-(@isk_oran/100)) else 0 end,1,\r\n        @parabrm,@userad,getdate(),@islmhrk,\r\n        'CT',vs.verid,vs.plaka,vs.surucu\r\n        from veresimas as vs with (nolock) where \r\n        vs.verid in (select * from @EKSTRE_TEMPAK)\r\n        \r\n       select @newid=SCOPE_IDENTITY()\r\n       update carihrk set masterid=@newid,carhrkid=@newid where fisid in (select * from @EKSTRE_TEMPAK)\r\n       \r\n        \r\n\r\n        update veresimas  set aktip='CT',akid=@newid,aktar=@fattarih\r\n         where verid in (select * from @EKSTRE_TEMPAK)\r\n         \r\n         \r\n         /*- iskonto kartıı yansıttt */\r\n         \r\n         \r\n         set @islmtip='GLG'  \r\n         set @islmhrk='FSI'\r\n         select @islmtipad=ad from islemturtip where tip=@islmtip\r\n         select @islmhrkad=ad from islemhrktip where tip=@islmtip and hrk=@islmhrk\r\n\r\n          \r\n        if @isk_oran>0\r\n        insert into carihrk (firmano,gctip,islmtip,islmtipad,\r\n        islmhrk,islmhrkad,yertip,yerad,\r\n        cartip_id,cartip,masterid,varno,carhrkid,perkod,\r\n        adaid,tarih,vadetar,saat,\r\n        car_id,carkod,\r\n        belno,ack,borc,alacak,kur,parabrm,olususer,olustarsaat,\r\n        fisfattip,fisaktip,fisid,plaka,surucu)\r\n        select @firmano,@gctip,@islmtip,@islmtipad,@islmhrk,\r\n        @islmhrkad,@yertip,@yertipad,\r\n        3,'gelgidkart',@newid,0,@newid,'',0,\r\n        case when @fistarih=0 then\r\n        @fattarih else tarih end,\r\n        vadtar,@saatx,\r\n        0,@fis_isk_kart_kod,(vs.seri+vs.no),'FİŞ İSKONTO / CARI KOD '+\r\n        @carkod+' CARI ÜNVANI '+@cari_unvan+' %'+\r\n        cast(@isk_oran as varchar(20))+\r\n        ' ( '+cast( round(((vs.toptut-vs.isktop)),2)  as varchar(20))+\r\n        ' ) ',\r\n        case when vs.fistip='FISVERSAT' THEN \r\n        (vs.toptut-vs.isktop)*(@isk_oran/100) else 0 end,\r\n        case when fistip='FISALCSAT' THEN \r\n        toptut*(@isk_oran/100) else 0 end,1,\r\n        @parabrm,@userad,getdate(),@islmhrk,'CT',vs.verid,'',''\r\n        from veresimas as vs with (nolock) where  \r\n        vs.verid in (select * from @EKSTRE_TEMPAK)\r\n               \r\n       \r\n      end /*--ch tek cari hrk işlenmesi */\r\n\r\n      if (@aktip='CH')/*ch toplu cari hrk işlenmesi */\r\n      begin\r\n      \r\n      select @newid=0\r\n      insert into carihrk (firmano,gctip,islmtip,islmtipad,islmhrk,islmhrkad,yertip,yerad,\r\n      cartip_id,cartip,masterid,varno,carhrkid,perkod,adaid,tarih,vadetar,saat,\r\n      car_id,carkod,\r\n      belno,ack,borc,alacak,kur,parabrm,olususer,olustarsaat,\r\n      fisfattip,fisaktip,fisid)\r\n      select @firmano,@gctip,@islmtip,@islmtipad,@islmhrk,@islmhrkad,\r\n      @yertip,@yertipad,\r\n      @cartip_id,@cartip,@newid,0,@newid,'',0,\r\n      @fattarih,@fattarih,@saatx,\r\n      @car_id,@carkod,(@bel_seri+@bel_no),@ack,\r\n      @giren*(1-(@isk_oran/100)),(-1*@cikan)*(1-(@isk_oran/100)),\r\n      1,@parabrm,@userad,getdate(),@islmhrk,\r\n      @aktip,0\r\n      \r\n       select @newid=SCOPE_IDENTITY()\r\n       update carihrk set masterid=@newid,carhrkid=@newid where id=@newid \r\n       \r\n\r\n        update veresimas  set aktip='CH',akid=@newid,aktar=@fattarih\r\n         where verid in (select * from @EKSTRE_TEMPAK)\r\n         \r\n         \r\n      /*-iskonto yansıması   */\r\n      \r\n      if @isk_oran>0 \r\n      insert into carihrk (firmano,gctip,islmtip,islmtipad,\r\n        islmhrk,islmhrkad,yertip,yerad,\r\n        cartip_id,cartip,masterid,varno,carhrkid,perkod,\r\n        adaid,tarih,vadetar,saat,\r\n        car_id,carkod,\r\n        belno,ack,borc,alacak,kur,parabrm,olususer,olustarsaat,\r\n        fisfattip,fisaktip,fisid,plaka,surucu)\r\n        select @firmano,@gctip,@islmtip,@islmtipad,@islmhrk,\r\n        @islmhrkad,@yertip,@yertipad,\r\n        3,'gelgidkart',@newid,0,@newid,'',0,\r\n        @fattarih,@fattarih,@saatx,\r\n        0,@fis_isk_kart_kod,(@bel_seri+@bel_no),'FİŞ İSKONTO / CARI KOD '+\r\n        @carkod+' CARI ÜNVANI '+@cari_unvan+' %'+\r\n        cast(@isk_oran as varchar(20))+\r\n        ' ( '+cast( round((( ABS(@giren+@cikan))),2)  as varchar(20))+\r\n        ' ) ',\r\n        @giren*(@isk_oran/100),(-1*@cikan)*(@isk_oran/100), \r\n        1,@parabrm,@userad,getdate(),@islmhrk,@aktip,0,'',''\r\n              \r\n       \r\n         \r\n         \r\n\r\n      end/*---aktip ch */\r\n      \r\n      \r\n      \r\n\r\n    end\r\n\r\n /*------cari aktarim */\r\n\r\n  if @aktip='FT'\r\n   begin\r\n   select @gctip=f.gctip,\r\n   @fattip=r.rapkod,\r\n   @fattip_id=tip_id,\r\n   @fattur_id=tur_id,\r\n   @fattipad=r.ack\r\n  /* @Hrk_Stk_Pro=r.hrk_stk_pro */\r\n   from raporlar r left join fattip f on f.kod=r.rapkod \r\n   where r.sil=0  and r.id=@fatrap_id\r\n    /*'FATVERSAT' */\r\n  \r\n  \r\n  \r\n      set @Hrk_Stk_Pro=0\r\n      set @kaptip='VER'\r\n      if @fattip='FATTTSSAT'\r\n      begin\r\n       set @kaptip='FAT'\r\n       set @Hrk_Stk_Pro=1\r\n      end \r\n       \r\n       \r\n      set  @islmtip=@fattip\r\n      /*'FATVERSAT' */\r\n      set  @islmhrk='satis'\r\n      set  @yertip='carikart'\r\n      select @yertipad=ad from yertipad where kod=@yertip\r\n      /*select @islmtipad=ad from fattip where kod=@islmtip */\r\n\r\n    set @vadtarih=@fattarih\r\n    \r\n    if @cartip='carikart'\r\n     begin\r\n      select @fatvadtip=k.fatvadtip,@fatvadsur=k.fatvadsur,\r\n      @fatiskyuz=k.fatisk,\r\n      @Karsi_Cartipid=1,\r\n      @Karsi_Carid=fat_car_id,\r\n      @Karsi_Hrk_Pro=fat_car_sec,\r\n      @AvansTakip=AvansTakip \r\n      from carikart as k with (nolock) where\r\n      k.kod=@carkod\r\n      select @vadtarih=dbo.vadtarihver (@fatvadtip,@fatvadsur,@fattarih)\r\n     end\r\n     \r\n     \r\n      /*select @newid=isnull(max(fatid),0)+1 from faturamas */\r\n\r\n      insert into faturamas (firmano,\r\n      gctip,fatrap_id,fattip_id,fattur_id,\r\n      fatad,fatid,tarih,vadtar,saat,yuvtop,\r\n      gen_ind_tip,geniskyuz,genisktop,\r\n      fattip,fattur,fatseri,fatno,\r\n      cartip_id,cartip,car_id,carkod,kdvtip,ack,\r\n      olususer,olustarsaat,deguser,degtarsaat,\r\n      parabrm,kur,kaptip,kayok,hrk_car_pro,hrk_stk_pro,\r\n      Karsi_Cartip_id,Karsi_Car_id,Hrk_Karsi_Pro,AvansTakip)\r\n      select @firmano,@gctip,@fatrap_id,@fattip_id,@fattur_id,\r\n      @fattipad,0,@fattarih,@vadtarih,@saatx,0,\r\n      0,0,0,\r\n      @islmtip,@islmhrk,@bel_seri,@bel_no,\r\n      @cartip_id,@cartip,@car_id,@carkod,'Hariç',@ack,/*'TOPLU FATURALANDIRMA' */\r\n      @userad,GETDATE(),'',null,@parabrm,1,@kaptip,0,1,@Hrk_Stk_Pro,\r\n      @Karsi_Cartipid,@Karsi_Carid,@Karsi_Hrk_Pro,@AvansTakip\r\n      \r\n      select @newid=SCOPE_IDENTITY()\r\n      update faturamas  set fatid=@newid where id=@newid\r\n      \r\n    \r\n      if @ortbrm=1\r\n        insert into faturahrk \r\n        (firmano,fatid,stktip_id,stktip,stk_id,stkod,mik,brim,ustbrim,carpan,\r\n        brmfiy,depkod,kdvtip,\r\n        kdvyuz,kdvtut,satiskyuz,satisktut,otvbrim,otvyuz,otvtut,olususer,olustarsaat,\r\n        parabrim,Kart_ParaBrm,Kart_kur,OtoTag)\r\n        \r\n        select @firmano,@newid,stktip_id,stktip,stk_id,stkod,sum(mik),brim,\r\n        brim,1, round(sum( ( ( (brmfiy*(1-(iskyuz/100)) ) / (1+kdvyuz) ) * mik )),12)\r\n        / sum(mik),'','Hariç',Kdvyuz,\r\n        0,\r\n        0,0,0,0,0,@userad,getdate(),'TL','TL',1,OtoTag\r\n        from veresihrk as h WITH (NOLOCK) \r\n        inner join veresimas as m WITH (NOLOCK)\r\n        on m.verid=h.verid and m.sil=0 and h.sil=0 \r\n        where m.verid in (select * from @EKSTRE_TEMPAK)\r\n        group by stktip_id,stktip,stk_id,stkod,iskyuz,brim,kdvyuz,OtoTag\r\n      else\r\n        insert into faturahrk (firmano,fatid,stktip_id,stktip,stk_id,stkod,mik,brim,ustbrim,carpan,brmfiy,depkod,kdvtip,\r\n        kdvyuz,kdvtut,satiskyuz,satisktut,otvbrim,otvyuz,otvtut,olususer,olustarsaat,\r\n        parabrim,Kart_ParaBrm,Kart_kur,OtoTag)\r\n        \r\n        select @firmano,@newid,stktip_id,stktip,stk_id,stkod,sum(mik),brim,brim,1,\r\n        round(cast((brmfiy*(1-(isnull(iskyuz,0)/100)))/(1+kdvyuz) as float),12),'','Dahil',\r\n        kdvyuz,0,0,0,0,0,0,@userad,getdate(),'TL','TL',1,OtoTag\r\n        from veresihrk h WITH (NOLOCK) \r\n        inner join veresimas as m WITH (NOLOCK)\r\n        on m.verid=h.verid and m.sil=0 and h.sil=0 \r\n        where m.verid in (select * from @EKSTRE_TEMPAK)\r\n        group by stktip_id,stktip,stk_id,stkod,\r\n        round(cast((brmfiy*(1-(isnull(iskyuz,0)/100)))/(1+kdvyuz) as float),12),\r\n        iskyuz,brim,kdvyuz,OtoTag\r\n        \r\n        \r\n        /*Depo Kart TTS ise */\r\n        if @fattip='FATTTSSAT'\r\n         update faturahrk set Depkod=dt.Kod,dep_id=dt.id From faturahrk as t join\r\n         (select id,Kod,Bagak From tankkart as t where t.sil=0 ) dt\r\n         on dt.Bagak=T.stkod and t.fatid=@newid\r\n                 \r\n\r\n\r\n        update veresimas  set aktip='FT',\r\n        akid=@newid,\r\n        fatid=@newid,aktar=@fattarih\r\n        where verid in (select * from @EKSTRE_TEMPAK)\r\n        \r\n        update faturamas  set kayok=1 where fatid=@newid\r\n\r\n        \r\n        exec Fatura_Cari_Stok_Iskonto @newid\r\n        \r\n        \r\n        exec Fatura_Genel_indirim @newid,0,@fatiskyuz\r\n   \r\n        \r\n        update faturamas  set kayok=1 where fatid=@newid\r\n    end\r\n\r\n   select @newid as fatid\r\n\r\n END"
  },
  {
    "schema": "dbo",
    "name": "verfisfaturala",
    "definition": "CREATE PROCEDURE [dbo].verfisfaturala (@cartip varchar(20),\r\n@carkod varchar(20),@vadtar datetime,@VERIDIN VARCHAR(8000))\r\nAS\r\nBEGIN\r\n BEGIN TRAN VERFAT1\r\n  \r\n\r\n DECLARE @EKSTRE_TEMP TABLE (\r\n    VARNO      FLOAT)\r\n declare @separator char(1)\r\n set @separator = ','\r\n\r\n declare @separator_position int\r\n declare @array_value varchar(1000)\r\n\r\n IF (LEN(RTRIM(@VERIDIN)) > 0)\r\n BEGIN\r\n  set @VERIDIN = @VERIDIN + ','\r\n END\r\n\r\n while patindex('%,%' , @VERIDIN) <> 0\r\n begin\r\n\r\n   select @separator_position =  patindex('%,%' , @VERIDIN)\r\n   select @array_value = left(@VERIDIN, @separator_position - 1)\r\n\r\n  Insert @EKSTRE_TEMP\r\n  Values (Cast(@array_value as float))\r\n  select @VERIDIN = stuff(@VERIDIN, 1, @separator_position, '')\r\n end\r\n\r\n\r\n/*-----------DECLARE */\r\n/*\r\nSET @fattip='veresi'\r\nSET @fattur:='satis'\r\nSELECT @parabrm=sistem_ytlstr,@kur=sistem_kasakur\r\nFROM sistemtanim\r\n\r\n  IF (SELECT COUNT(*) FROM TB_BANKA WHERE BANKA_KOD = @BANKA_KOD AND TB_BANKA_ID <> @TB_BANKA_ID) > 0\r\n    BEGIN\r\n      SELECT @MESAJ = '\"'+@BANKA_KOD + '\" Kodu farklı bir banka hesabında kullanılmıştır.'\r\n      RAISERROR (@MESAJ, 16,1)\r\n      ROLLBACK TRANSACTION\r\n    END\r\n    ELSE\r\n    BEGIN\r\n      EXEC SP_YAZ_FIS_NO 'BANKA', @BANKA_KOD\r\n    END\r\n\r\n*/\r\n\r\n \tIF @@ERROR > 0\r\n\t\tROLLBACK TRAN VERFAT1\r\n\tELSE\r\n\t   COMMIT TRAN VERFAT1\r\n  \r\n  \r\nEND"
  },
  {
    "schema": "dbo",
    "name": "verfisisle",
    "definition": "CREATE PROCEDURE [dbo].verfisisle @fatid float\r\nAS\r\nBEGIN\r\ndeclare @kaptip varchar(10)\r\ndeclare @tarih datetime\r\ndeclare @sql varchar(8000)\r\ndeclare @kayok int,@sil int\r\n\r\ndeclare @cartip varchar(20)\r\ndeclare @carkod varchar(50)\r\n\r\nselect @kayok=kayok,@sil=sil,@tarih=tarih,\r\n@sql=kapidler,\r\n@kaptip=kaptip from faturamas WITH (NOLOCK) where fatid=@fatid\r\n\r\n  if @fatid=0\r\n   RETURN\r\n\r\n\r\nif @kaptip='VER'\r\nbegin\r\n\r\n if @kayok=1 and @sil=0\r\n update veresimas  set aktip='FT',aktar=@tarih,akid=@fatid\r\n where fatid=@fatid\r\n\r\n if @kayok=0 or @sil=1\r\n begin\r\n select @cartip=cartip,@carkod=carkod from veresimas WITH (NOLOCK) where fatid=@fatid\r\n \r\n update veresimas  set aktip='BK',aktar=NULL,akid=0,fatid=0 /*from veresimas WITH (NOLOCK) */\r\n where fatid=@fatid\r\n \r\n\r\n end\r\n\r\nend;\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "verfisisle_sil",
    "definition": "CREATE PROCEDURE [dbo].verfisisle_sil @fatid float\r\nAS\r\nBEGIN\r\n\r\n if @fatid=0\r\n  return\r\n\r\n  update veresimas set aktip='BK',aktar=NULL,akid=0,fatid=0 where\r\n   fatid=@fatid\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "Vts_Fis_Giris",
    "definition": "CREATE PROCEDURE [dbo].Vts_Fis_Giris (@vtsid float,@sil int)\r\nAS\r\nBEGIN\r\n\r\nif @sil=0\r\nupdate otomasonlineoku set\r\naktarid=dt.verid,\r\nsattip=dt.sattip,\r\ncartip=dt.cartip,\r\ncarkod=dt.carkod,\r\ncarad=dt.carad\r\nfrom otomasonlineoku as t join\r\n(select verid,'Veresiye' as sattip,cartip,carkod,k.ad as carad\r\nfrom veresimas as v with (nolock) inner join Genel_Kart as k \r\non k.cartp=v.cartip and k.kod=v.carkod where v.varno=0 and \r\nv.vtsid=@vtsid and v.sil=0) \r\ndt on otomasid=@vtsid and varno=0\r\n\r\nif @sil=1\r\nupdate otomasonlineoku set\r\naktarid=0,sattip='Nakit',cartip='',carkod='',carad=''\r\nfrom otomasonlineoku where otomasid=@vtsid\r\n\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "Yedek_Al",
    "definition": "CREATE PROCEDURE [dbo].Yedek_Al (@dataadi varchar(50))\r\nAS\r\nBEGIN\r\n\r\n\r\n/*SET NOCOUNT ON */\r\n/*SET XACT_ABORT ON --rollback */\r\n\r\nDECLARE @DBNAME VARCHAR(50)\r\n\r\nDECLARE @BACK_YER VARCHAR(3000)\r\ndeclare @dosyaad  VARCHAR(3000)\r\ndeclare @sil_dosyad VARCHAR(3000)\r\ndeclare @sil_id int\r\ndeclare @i int\r\ndeclare @dicExist bit\r\ndeclare @mesaj  VARCHAR(255)\r\ndeclare @sqlstr  VARCHAR(5000)\r\n\r\n\r\n/*BEGIN TRANSACTION */\r\n\r\nselect @BACK_YER=isnull(yedek_dizin,'') from sistemtanim\r\n\r\n if @BACK_YER=''\r\n  begin\r\n       set @mesaj=@dataadi+' İçin Yedek Alınacak Dizini Belirtiniz...!'\r\n       RAISERROR (@mesaj,16,1)\r\n       ROLLBACK TRANSACTION\r\n       RETURN\r\n  end\r\n set @i=len(@BACK_YER)\r\n while @i>0\r\n  begin\r\n   if SUBSTRING(@BACK_YER,@i,1)='\\'\r\n    begin\r\n    declare @dizin  varchar(200)\r\n    declare @klasor  varchar(50)\r\n    \r\n    set @dizin=RTRIM(SUBSTRING(@BACK_YER,1,@i))\r\n    set @klasor=RTRIM(SUBSTRING(@BACK_YER,@i+1,200))\r\n    \r\n    exec @dicExist=sp_DizinKontrol @dizin,@klasor\r\n\r\n    if @dicExist=0\r\n     begin\r\n       set @mesaj='Ana Bilgisayarda Yedek Alınacak Dizin Bulunamıyor...!'+\r\n       CHAR(13)+CHAR(10)+\r\n       'Yedek Dizin = '+@dizin+@klasor\r\n       RAISERROR (@mesaj,16,1)\r\n      /* ROLLBACK TRANSACTION */\r\n       RETURN\r\n     end\r\n    \r\n     break\r\n    \r\n    end\r\n  set @i=@i-1\r\n  end\r\n  \r\n\r\n SELECT @dosyaad=convert(varchar,getdate(),120);\r\n\r\n SELECT @dosyaad=Replace(@dosyaad,':', '-')\r\n SELECT @dosyaad=Replace(@dosyaad,' ', '_')\r\n\r\n set @BACK_YER=@BACK_YER+'\\'+@dataadi+'_'+@dosyaad+'.bak';\r\n\r\n  insert into yedek (tarih,dosyaad,ok) values\r\n  (getdate(),@BACK_YER,1)\r\n\r\n set @sqlstr='BACKUP DATABASE ['+@dataadi+'] TO\r\n DISK = '''+@BACK_YER+''' WITH NOFORMAT, NOINIT,\r\n NAME =''Full Database Backup'', SKIP, NOREWIND,NOUNLOAD,STATS = 1'\r\n \r\n  BEGIN TRY\r\n     execute(@sqlstr)\r\n  END TRY\r\n   BEGIN CATCH\r\n    delete from yedek where dosyaad=@BACK_YER \r\n    /*ROLLBACK TRANSACTION */\r\n    RETURN\r\n   END CATCH\r\n    \r\n    /*IF @@TRANCOUNT > 0 */\r\n    /* COMMIT TRANSACTION */\r\n  \r\n \r\n\r\n /*set @BACK_YER='C:\\Petronet\\Yedek' */\r\n\r\n /*declare @str varchar(300) */\r\n\r\n /*set @str = 'md '+@BACK_YER+'' */\r\n\r\n  /*EXEC master..xp_cmdshell @str */\r\n\r\n if (select count(*) from yedek)>6\r\n begin\r\n  select top 1 @sil_dosyad=min(dosyaad),@sil_id=min(id) from yedek\r\n\r\n  set @sil_dosyad='del '+@sil_dosyad\r\n\r\n  declare @RC int\r\n  /* exec @RC = master..xp_cmdshell @sil_dosyad */\r\n  /*  EXEC master..xp_cmdshell @sil_dosyad */\r\n  /*\r\n   EXEC master.dbo.sp_configure 'show advanced options', 1\r\n   RECONFIGURE\r\n   EXEC master.dbo.sp_configure 'xp_cmdshell', 1\r\n   RECONFIGURE\r\n  */\r\n  \r\n   if @RC=1\r\n   begin\r\n    raiserror ('Error',16,1)\r\n    return\r\n   end \r\n  \r\n    \r\n   delete from yedek where id =@sil_id\r\n \r\n end\r\n\r\n \r\n\r\n\r\n/*\r\nBACKUP DATABASE [BP] TO  DISK = N'C:\\petronet\\backup\\BPDB.bak' WITH NOFORMAT, NOINIT,\r\nNAME = N'GODB-Full Database Backup', SKIP, NOREWIND, NOUNLOAD,  STATS = 10\r\nGO\r\n*/\r\n\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "YedekAlYuzde",
    "definition": "CREATE PROCEDURE dbo.YedekAlYuzde\r\n@DbAd  varchar(150)\r\nAS\r\nBEGIN\r\n  \r\n\r\n  SELECT A.NAME,B.TOTAL_ELAPSED_TIME/60000 AS [Running Time],\r\n  B.ESTIMATED_COMPLETION_TIME/60000 AS [Remaining],\r\n  B.PERCENT_COMPLETE as [%],(SELECT TEXT FROM sys.dm_exec_sql_text(B.SQL_HANDLE))AS COMMAND FROM\r\n  MASTER..SYSDATABASES A, sys.dm_exec_requests B\r\n  WHERE A.DBID=B.DATABASE_ID and A.NAME=@DbAd\r\n  AND B.COMMAND LIKE '%BACKUP%'\r\n  order by percent_complete desc,B.TOTAL_ELAPSED_TIME/60000 desc\r\n  \r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "Yeni_Fiyat_Fark",
    "definition": "CREATE PROCEDURE [dbo].Yeni_Fiyat_Fark\r\n(@masid integer,\r\n@sil  tinyint)\r\nAS\r\nBEGIN\r\n\r\n\r\n  declare @newid int\r\n  DECLARE @gidkod varchar(30)\r\n\r\n  declare @kur      float\r\n  declare @parabrm  varchar(20)\r\n  \r\n  declare @islmtip varchar(30)\r\n  declare @islmtipad varchar(50)\r\n  declare @islmhrk varchar(30)\r\n  declare @islmhrkad varchar(50)\r\n\r\n     set @islmtip='GLG'\r\n     select @islmtipad=ad from islemturtip where tip=@islmtip\r\n     set @islmhrk='FYF'\r\n     select @islmhrkad=ad from islemhrktip where\r\n     tip=@islmtip and hrk=@islmhrk\r\n\r\n     select @parabrm=sistem_parabrm,@kur=sistem_kasakur,\r\n     @gidkod=fisyenfiygelgid from sistemtanim\r\n\r\n   delete from carihrk where masterid=@masid and islmtip=@islmtip\r\n   and islmhrk=@islmhrk\r\n\r\n  if @sil=0\r\n   begin\r\n      select @newid=0\r\n      insert into carihrk (firmano,carhrkid,gctip,masterid,fisfattip,fisfatid,islmtip,islmtipad,islmhrk,islmhrkad,\r\n      yertip,yerad,cartip,carkod,borc,alacak,bakiye,tarih,saat,olususer,olustarsaat,vadetar,belno,\r\n      ack,varno,kur,dataok,pro,varok,perkod,adaid,deguser,degtarsaat,sil,\r\n      karsihestip,karsiheskod,parabrm)\r\n      select max(m.firmano),@newid,'-',@masid,'KENDI',0,\r\n      @islmtip,@islmtipad,@islmhrk,@islmhrkad,max(vf.yertip),max(vf.yerad),\r\n      'gelgidkart',@gidkod,SUM( case when yeni_fiyat-eski_fiyat<0 then\r\n      vh.mik*abs(yeni_fiyat-eski_fiyat) else 0 end),\r\n      SUM( case when yeni_fiyat-eski_fiyat>0 then\r\n      vh.mik*abs(yeni_fiyat-eski_fiyat) else 0 end),0,max(vf.tarih),max(vf.saat),\r\n      max(vf.olususer),max(vf.olustarsaat),max(vf.tarih),cast(@masid as varchar),\r\n      max(vf.ack),0,@kur,0,1,1,'',0,'','',0,\r\n      '','',@parabrm from veresiyenfiyhrk as vf with (nolock) inner join\r\n      veresihrk as vh with (nolock)  on vh.id=vf.verhrkid and vh.sil=0\r\n      inner join veresimas as m on m.verid=vh.verid and m.sil=0\r\n      where vf.masterid=@masid\r\n      \r\n      select @newid=SCOPE_IDENTITY()\r\n       update carihrk set carhrkid=@newid \r\n       where masterid=@masid and islmtip=@islmtip and islmhrk=@islmhrk\r\n       \r\n      \r\n      \r\n      \r\n      \r\n   end\r\n\r\n  \r\n  \r\nEND"
  },
  {
    "schema": "dbo",
    "name": "yertipolustur",
    "definition": "CREATE PROCEDURE [dbo].yertipolustur\r\nAS\r\nBEGIN\r\n\r\nTRUNCATE TABLE yertipad;\r\n\r\ninsert into yertipad (kod,ad) values('pomvardimas','POMPACI VARDİYA');\r\ninsert into yertipad (kod,ad) values('marvardimas','MARKET VARDİYA');\r\ninsert into yertipad (kod,ad) values('veresiislem','VERESİYE İŞLEM');\r\ninsert into yertipad (kod,ad) values('faturamas','FATURA GİRİŞ');\r\n\r\ninsert into yertipad (kod,ad) values('irsaliyemas','İRSALİYE GİRİŞ');\r\n\r\ninsert into yertipad (kod,ad) values('carikart','CARİ KART');\r\ninsert into yertipad (kod,ad) values('perkart','PERSONEL KART');\r\ninsert into yertipad (kod,ad) values('gelgidkart','GELİR-GİDER KART');\r\ninsert into yertipad (kod,ad) values('perakendekart','PERAKENDE KART');\r\ninsert into yertipad (kod,ad) values('tankkart','TANK KART');\r\ninsert into yertipad (kod,ad) values('marstkkart','MARKET STOK KART');\r\ninsert into yertipad (kod,ad) values('poskart','POS KART');\r\ninsert into yertipad (kod,ad) values('bankakart','BANKA KART');\r\ninsert into yertipad (kod,ad) values('sayackart','SAYAÇ KART');\r\ninsert into yertipad (kod,ad) values('istkart','İŞLETME KREDİ KART');\r\n\r\ninsert into yertipad (kod,ad) values('otomas','OTOMASYON KART');\r\ninsert into yertipad (kod,ad) values('kasahrk','KASA HAREKET');\r\n\r\ninsert into yertipad (kod,ad) values('hizliislem','HIZLI İŞLEM');\r\ninsert into yertipad (kod,ad) values('ceksenislem','ÇEK SENET İŞLEM');\r\ninsert into yertipad (kod,ad) values('posislem','POS İŞLEM');\r\ninsert into yertipad (kod,ad) values('bankaislem','BANKA İŞLEM');\r\ninsert into yertipad (kod,ad) values('kasaislem','KASA İŞLEM');\r\ninsert into yertipad (kod,ad) values('haricislem','HARİCİ İŞLEM');\r\ninsert into yertipad (kod,ad) values('havuzislem','HAVUZ İŞLEM');\r\ninsert into yertipad (kod,ad) values('vts_islem','VTS İŞLEM');\r\n\r\ninsert into yertipad (kod,ad) values('deptrsislem','DEPO TRANSFER');\r\n\r\ninsert into yertipad (kod,ad) values('fireislem','ÖLÇÜM-FİRE İŞLEM');\r\ninsert into yertipad (kod,ad) values('yagdokislem','YAĞ DÖKME İŞLEM');\r\ninsert into yertipad (kod,ad) values('yazarkasa','YAZAR KASA AKTARIM');\r\ninsert into yertipad (kod,ad) values('sayim','SAYIM İŞLEM');\r\n\r\ninsert into yertipad (kod,ad) values('permaas','PERSONEL MAAŞ AKTARIM');\r\n\r\ninsert into yertipad (kod,ad) values('z_rapor','Z RAPOR');\r\n\r\nEND"
  },
  {
    "schema": "dbo",
    "name": "Yetki_Evrak_Olustur",
    "definition": "CREATE PROCEDURE  [dbo].Yetki_Evrak_Olustur @Tip varchar(30)\r\nAS\r\nBEGIN\r\n  declare @frmid\t\tint\r\n  declare @bolumid\t\tint\r\n  \r\n  declare @link_name  varchar(50)\r\n  declare @kont  varchar(50)\r\n  declare @modul varchar(10)\r\n  \r\n  /*if NOT ((@tip='FATURA') or (@tip='PROMOSYON')) */\r\n  /* return */\r\n  \r\n  \r\n  set @modul=''\r\n  \r\n  if @tip='FATURA'\r\n  begin\r\n   set  @link_name='FATURA_LINK'\r\n   set @kont='mn_fatlist'\r\n  end\r\n  \r\n  \r\n  if @tip='PROMOSYON'\r\n  begin\r\n   set  @link_name='PROM_LINK'\r\n   set @kont='mn_fisislem'\r\n   set @modul='H'\r\n  end\r\n  \r\n  \r\n   \r\n  select @frmid=id,@bolumid=bolumid from frm\r\n  where [frm]=@link_name\r\n\r\n\r\n  insert into frmkont \r\n  (firmano,bolumid,frmid,kont,kont_menu,konttr,yetkialan,rap_id,modul)\r\n  select 0,@bolumid,@frmid,\r\n  @kont,\r\n  @kont+cast(r.id as varchar),\r\n  r.ack,1,r.id,@modul\r\n  from raporlar r \r\n   where r.rapgrp=@Tip and r.sil=0 and id not in  \r\n  (select rap_id from frmkont where frmid=@frmid and rap_id>0 )\r\n  \r\n  \r\n  update frmkont set konttr=dt.ack from frmkont as t \r\n  join (select r.id,r.ack from raporlar as r \r\n  where r.rapgrp=@Tip and r.sil=0 ) dt\r\n  on t.Rap_id=dt.id\r\n  \r\n    \r\n   \r\n  delete from frmkont where \r\n  kont=@kont and rap_id \r\n  not in (select id from raporlar as r\r\n  where r.rapgrp=@Tip and r.sil=0 )  \r\n  \r\n\r\n\r\nEND"
  }
]