{% extends "dashboard/base.html" %}
{% load static %}

{% block title %}K.Kartı-Kredi{% endblock %}

{% block extra_head %}
  <style>
    *{box-sizing:border-box}
    /* Kredi kartı sayfası için overflow kontrolü */
    #kredi-karti-grid, #kredi-karti-grid .k-grid, #kredi-karti-grid .k-grid-content,
    #kredi-karti-grid .k-grid-header, #kredi-karti-grid .k-grid-header-wrap,
    #kredi-karti-grid .k-grid-content-wrap, #kredi-karti-grid table {overflow-x:hidden !important;max-width:100% !important;width:100% !important}
  </style>
{% endblock %}

{% block content %}
  <div style="padding:0;width:100%;max-width:100vw;height:100%;overflow-x:hidden !important;overflow-y:auto;box-sizing:border-box;margin:0;">
    <h1 style="text-align:center;color:#206d7d;margin:10px 0;font-size:20pt;font-weight:bold;">KREDİ KARTI TAKİP</h1>
    <div id="kredi-karti-grid" style="width:100%;max-width:100vw;height:calc(100vh - 220px);overflow-x:hidden !important;overflow-y:auto;margin:0;padding:0;"></div>
  </div>
{% endblock %}

{% block extra_scripts %}
  <script>
    $(document).ready(function() {
      // Tab yönetimi - Dinamik Tab Sistemi
      var openTabs = {};
      var activeTabId = null;
      
      // Tab'ları sessionStorage'a kaydetme fonksiyonu
      function saveTabsToStorage() {
        var tabsArray = [];
        for (var tabId in openTabs) {
          tabsArray.push({
            tabId: tabId,
            title: openTabs[tabId].title,
            pageId: openTabs[tabId].pageId,
            icon: openTabs[tabId].icon
          });
        }
        sessionStorage.setItem('openTabs', JSON.stringify({
          tabs: tabsArray,
          activeTabId: activeTabId
        }));
      }
      
      // Tab'ları sessionStorage'dan yükleme fonksiyonu
      function loadTabsFromStorage() {
        var stored = sessionStorage.getItem('openTabs');
        if (!stored) return;
        
        try {
          var data = JSON.parse(stored);
          if (data.tabs && data.tabs.length > 0) {
            data.tabs.forEach(function(tabData) {
              openTabs[tabData.tabId] = {
                title: tabData.title,
                pageId: tabData.pageId,
                icon: tabData.icon,
                tabElement: null
              };
            });
            
            for (var tabId in openTabs) {
              if (!openTabs[tabId].tabElement) {
                createTabElement(tabId);
              }
            }
            
            if (data.activeTabId && openTabs[data.activeTabId]) {
              setActiveTab(data.activeTabId);
            }
          }
        } catch (e) {
          console.error('Tab yükleme hatası:', e);
        }
      }
      
      // Tab DOM elementi oluşturma fonksiyonu
      function createTabElement(tabId) {
        var tab = openTabs[tabId];
        if (!tab) return;
        
        var tabElement = $('<div class="tab-item" data-tab-id="' + tabId + '" style="background:linear-gradient(to bottom, rgb(255, 235, 180), rgb(255, 220, 150));border:1px solid #CC9966;border-bottom:none;height:32px;padding:0 15px;display:flex;align-items:center;gap:8px;color:#333333;font-weight:normal;border-radius:4px 4px 0 0;margin-right:2px;cursor:pointer;">' +
          '<div style="width:16px;height:16px;background:#4A90E2;border-radius:50%;font-size:14px;display:flex;align-items:center;justify-content:center;">' + tab.icon + '</div>' +
          '<span>' + tab.title + '</span>' +
          '<div class="tab-close" style="width:16px;height:16px;margin-left:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:#666666;font-size:12px;font-weight:bold;border-radius:50%;transition:background 0.2s;">×</div>' +
          '</div>');
        
        tabElement.find('span, div:not(.tab-close)').on('click', function() {
          setActiveTab(tabId);
          var pageId = tab.pageId;
          if (pageId === 'operasyon_sayfasi' || pageId === 'operasyon') {
            if (window.location.pathname !== '/') {
              window.location.href = "/";
            }
          } else {
            var menuItem = menuItems.find(function(item) { return item.name === pageId; });
            if (menuItem && menuItem.page_url && window.location.pathname !== menuItem.page_url) {
              window.location.href = menuItem.page_url;
            }
          }
        });
        
        tabElement.find('.tab-close').on('click', function(e) {
          e.stopPropagation();
          closeTab(tabId);
        });
        
        tabElement.find('.tab-close').hover(
          function() { $(this).css('background', 'rgba(255,0,0,0.2)'); },
          function() { $(this).css('background', 'transparent'); }
        );
        
        $('#tabs-list').append(tabElement);
        openTabs[tabId].tabElement = tabElement;
      }
      
      // Tab açma fonksiyonu
      function openTab(title, pageId, icon) {
        var tabId = 'tab-' + pageId;
        
        if (openTabs[tabId]) {
          setActiveTab(tabId);
          saveTabsToStorage();
          return;
        }
        
        var tabElement = $('<div class="tab-item" data-tab-id="' + tabId + '" style="background:linear-gradient(to bottom, rgb(255, 235, 180), rgb(255, 220, 150));border:1px solid #CC9966;border-bottom:none;height:32px;padding:0 15px;display:flex;align-items:center;gap:8px;color:#333333;font-weight:normal;border-radius:4px 4px 0 0;margin-right:2px;cursor:pointer;">' +
          '<div style="width:16px;height:16px;background:#4A90E2;border-radius:50%;font-size:14px;display:flex;align-items:center;justify-content:center;">' + icon + '</div>' +
          '<span>' + title + '</span>' +
          '<div class="tab-close" style="width:16px;height:16px;margin-left:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:#666666;font-size:12px;font-weight:bold;border-radius:50%;transition:background 0.2s;">×</div>' +
          '</div>');
        
        tabElement.find('span, div:not(.tab-close)').on('click', function() {
          setActiveTab(tabId);
          if (pageId === 'operasyon_sayfasi' || pageId === 'operasyon') {
            if (window.location.pathname !== '/') {
              window.location.href = "/";
            }
          } else {
            var menuItem = menuItems.find(function(item) { return item.name === pageId; });
            if (menuItem && menuItem.page_url && window.location.pathname !== menuItem.page_url) {
              window.location.href = menuItem.page_url;
            }
          }
        });
        
        tabElement.find('.tab-close').on('click', function(e) {
          e.stopPropagation();
          closeTab(tabId);
        });
        
        tabElement.find('.tab-close').hover(
          function() { $(this).css('background', 'rgba(255,0,0,0.2)'); },
          function() { $(this).css('background', 'transparent'); }
        );
        
        $('#tabs-list').append(tabElement);
        
        openTabs[tabId] = {
          title: title,
          pageId: pageId,
          icon: icon,
          tabElement: tabElement
        };
        
        setActiveTab(tabId);
        saveTabsToStorage();
        
        if (pageId === 'operasyon_sayfasi' || pageId === 'operasyon') {
          $('#main-content-operasyon').show();
          $('#title-bar').hide();
        } else {
          $('#main-content-operasyon').hide();
          $('#title-bar').hide();
        }
      }
      
      // Tab bulma fonksiyonu
      function findTabByTitle(title) {
        for (var id in openTabs) {
          if (openTabs[id].title === title) {
            return id;
          }
        }
        return null;
      }
      
      // Aktif tab değiştirme
      function setActiveTab(tabId) {
        $('.tab-item').each(function() {
          var id = $(this).data('tab-id');
          if (id !== tabId) {
            $(this).css({
              'background': '#FFFFFF',
              'border': '1px solid #CCCCCC',
              'border-bottom': '1px solid #E0E0E0',
              'height': '30px'
            });
            $(this).find('div:first').css({
              'width': '14px',
              'height': '14px',
              'background': '#FFFFFF',
              'border': '1px solid #4A90E2',
              'border-radius': '2px',
              'font-size': '12px'
            });
          }
        });
        
        if (openTabs[tabId]) {
          openTabs[tabId].tabElement.css({
            'background': 'linear-gradient(to bottom, rgb(255, 235, 180), rgb(255, 220, 150))',
            'border': '1px solid #CC9966',
            'border-bottom': 'none',
            'height': '32px'
          });
          openTabs[tabId].tabElement.find('div:first').css({
            'width': '16px',
            'height': '16px',
            'background': '#4A90E2',
            'border-radius': '50%',
            'border': 'none',
            'font-size': '14px'
          });
          
          activeTabId = tabId;
          setActiveRibbonButton(openTabs[tabId].pageId);
          
          if (openTabs[tabId].pageId === 'operasyon_sayfasi' || openTabs[tabId].pageId === 'operasyon') {
            $('#main-content-operasyon').show();
            $('#title-bar').hide();
          } else {
            $('#main-content-operasyon').hide();
            $('#title-bar').hide();
          }
          
          saveTabsToStorage();
        }
      }
      
      // Tab kapatma
      function closeTab(tabId) {
        if (!openTabs[tabId]) return;
        
        var wasActive = (activeTabId === tabId);
        var closedPageId = openTabs[tabId].pageId;
        var isOnClosedPage = false;
        
        if (closedPageId === 'operasyon_sayfasi' || closedPageId === 'operasyon') {
          isOnClosedPage = (window.location.pathname === '/');
        } else {
          var menuItem = menuItems.find(function(item) { return item.name === closedPageId; });
          if (menuItem && menuItem.page_url) {
            isOnClosedPage = (window.location.pathname === menuItem.page_url);
          }
        }
        
        openTabs[tabId].tabElement.remove();
        delete openTabs[tabId];
        
        if (wasActive) {
          var remainingTabs = Object.keys(openTabs);
          if (remainingTabs.length > 0) {
            var lastTabId = remainingTabs[remainingTabs.length - 1];
            var lastTab = openTabs[lastTabId];
            var isTabVisible = lastTab.tabElement && lastTab.tabElement.length > 0 && lastTab.tabElement.is(':visible');
            
            if (isOnClosedPage) {
              if (isTabVisible) {
                if (lastTab.pageId === 'operasyon_sayfasi' || lastTab.pageId === 'operasyon') {
                  window.location.href = "/";
                } else {
                  var lastMenuItem = menuItems.find(function(item) { return item.name === lastTab.pageId; });
                  if (lastMenuItem && lastMenuItem.page_url) {
                    window.location.href = lastMenuItem.page_url;
                  }
                }
              } else {
                activeTabId = null;
                $('#main-content-operasyon').hide();
                $('#title-bar').show();
                setActiveRibbonButton(null);
              }
            } else {
              if (isTabVisible) {
                setActiveTab(lastTabId);
              } else {
                activeTabId = null;
                $('#main-content-operasyon').hide();
                $('#title-bar').show();
                setActiveRibbonButton(null);
              }
            }
          } else {
            activeTabId = null;
            $('#main-content-operasyon').hide();
            $('#title-bar').show();
            setActiveRibbonButton(null);
          }
        }
        
        saveTabsToStorage();
      }
      
      // Aktif ribbon butonunu ayarlama fonksiyonu
      function setActiveRibbonButton(pageName) {
        $(".ribbon-button").each(function() {
          var page = $(this).data('page');
          if (pageName && page === pageName) {
            $(this).addClass('active');
            $(this).css({
              'background': 'rgba(255,255,255,0.4)',
              'border': '2px solid #4A90E2',
              'box-shadow': '0 2px 4px rgba(74, 144, 226, 0.3)'
            });
            $(this).find('div:last').css({
              'color': '#1e3a8a',
              'font-weight': '600'
            });
          } else {
            $(this).removeClass('active');
            $(this).css({
              'background': 'transparent',
              'border': '2px solid transparent',
              'box-shadow': 'none'
            });
            $(this).find('div:last').css({
              'color': '#333333',
              'font-weight': '500'
            });
          }
        });
      }
      
      // Ribbon butonlarına tıklama
      $(document).on("click", ".ribbon-button", function() {
        var pageName = $(this).data('page');
        var menuItem = menuItems.find(function(item) { return item.name === pageName; });
        
        if (!menuItem) return;
        
        var tabBaslik = menuItem.tab_baslik || menuItem.baslik;
        var existingTab = findTabByTitle(tabBaslik);
        
        if (existingTab) {
          setActiveTab(existingTab);
        } else {
          openTab(tabBaslik, pageName, menuItem.icon);
          
          if (pageName === 'operasyon_sayfasi') {
            $('#main-content-operasyon').show();
            $('#title-bar').hide();
          }
        }
        
        setActiveRibbonButton(pageName);
        
        if (menuItem.page_url && menuItem.page_url !== window.location.pathname && menuItem.page_url !== '/') {
          window.location.href = menuItem.page_url;
        }
      });
      
      // Ribbon butonlarına hover efekti
      $(".ribbon-button").hover(
        function() { 
          if (!$(this).hasClass('active')) {
            $(this).css("background", "rgba(255,255,255,0.2)"); 
          }
        },
        function() { 
          if (!$(this).hasClass('active')) {
            $(this).css("background", "transparent"); 
          }
        }
      );
      
      // Sayfa yüklendiğinde tab'ları yükle
      setTimeout(function() {
        loadTabsFromStorage();
      }, 50);
      
          // Telerik Kendo Grid oluştur
      setTimeout(function() {
        if (typeof kendo !== 'undefined' && typeof $.fn.kendoGrid !== 'undefined') {
          // 20 boş satır oluştur
          var emptyRows = [];
          for (var i = 0; i < 20; i++) {
            emptyRows.push({
              son_odeme: null,
              kalan_gun: null,
              tutar: "",
              banka: "",
              kime_ait: "",
              kart_numarasi: "",
              son_kullanim_tarihi: "",
              cv: "",
              iban: "",
              sifre: "",
              sutun1: "",
              sutun2: "",
              sutun3: ""
            });
          }
          
          // Ekran genişliği: 1920px
          // ALAN 1: 28px, ALAN 2: 86px, ALAN 3: 23px, Tab: 32px = Toplam: 169px
          // Kullanılabilir genişlik: 1920px (padding yok)
          // Grid container genişliğini hesapla
          var containerWidth = $("#kredi-karti-grid").parent().width() || $(window).width();
          var gridWidth = Math.min(containerWidth, 1920);
          
          $("#kredi-karti-grid").kendoGrid({
            dataSource: {
              data: emptyRows, // 20 boş satır
              schema: {
                model: {
                  fields: {
                    son_odeme: { type: "date" },
                    kalan_gun: { type: "number" },
                    tutar: { type: "string" },
                    banka: { type: "string" },
                    kime_ait: { type: "string" },
                    kart_numarasi: { type: "string" },
                    son_kullanim_tarihi: { type: "string" },
                    cv: { type: "string" },
                    iban: { type: "string" },
                    sifre: { type: "string" },
                    sutun1: { type: "string" },
                    sutun2: { type: "string" },
                    sutun3: { type: "string" }
                  }
                }
              }
            },
            width: gridWidth,
            height: "100%",
            scrollable: false,
            sortable: true,
            filterable: true,
            resizable: false, // Sütun genişliği değiştirme kapalı (horizontal scroll olmasın diye)
            pageable: false, // Sayfalama kapalı - tüm satırlar görünsün
            columns: [
              {
                field: "son_odeme",
                title: "SON ÖDEME",
                width: 125,
                format: "{0:dd.MM.yyyy}",
                headerAttributes: {
                  style: "background: linear-gradient(to bottom, #206d7d, #1a5a68); color: white; font-weight: bold; text-align: center;"
                }
              },
              {
                field: "kalan_gun",
                title: "KALAN GÜN",
                width: 95,
                headerAttributes: {
                  style: "background: linear-gradient(to bottom, #206d7d, #1a5a68); color: white; font-weight: bold; text-align: center;"
                },
                attributes: {
                  style: "text-align: center;"
                }
              },
              {
                field: "tutar",
                title: "TUTAR",
                width: 115,
                headerAttributes: {
                  style: "background: linear-gradient(to bottom, #206d7d, #1a5a68); color: white; font-weight: bold; text-align: center;"
                },
                attributes: {
                  style: "text-align: right;"
                }
              },
              {
                field: "banka",
                title: "BANKA",
                width: 135,
                headerAttributes: {
                  style: "background: linear-gradient(to bottom, #206d7d, #1a5a68); color: white; font-weight: bold; text-align: center;"
                }
              },
              {
                field: "kime_ait",
                title: "KİME AİT",
                width: 115,
                headerAttributes: {
                  style: "background: linear-gradient(to bottom, #206d7d, #1a5a68); color: white; font-weight: bold; text-align: center;"
                }
              },
              {
                field: "kart_numarasi",
                title: "KART NUMARASI",
                width: 175,
                headerAttributes: {
                  style: "background: linear-gradient(to bottom, #206d7d, #1a5a68); color: white; font-weight: bold; text-align: center;"
                }
              },
              {
                field: "son_kullanim_tarihi",
                title: "SON KULLANMA TARİHİ",
                width: 135,
                headerAttributes: {
                  style: "background: linear-gradient(to bottom, #206d7d, #1a5a68); color: white; font-weight: bold; text-align: center;"
                }
              },
              {
                field: "cv",
                title: "CV",
                width: 65,
                headerAttributes: {
                  style: "background: linear-gradient(to bottom, #206d7d, #1a5a68); color: white; font-weight: bold; text-align: center;"
                },
                attributes: {
                  style: "text-align: center;"
                }
              },
              {
                field: "iban",
                title: "İBAN",
                width: 195,
                headerAttributes: {
                  style: "background: linear-gradient(to bottom, #206d7d, #1a5a68); color: white; font-weight: bold; text-align: center;"
                }
              },
              {
                field: "sifre",
                title: "ŞİFRE",
                width: 75,
                headerAttributes: {
                  style: "background: linear-gradient(to bottom, #206d7d, #1a5a68); color: white; font-weight: bold; text-align: center;"
                },
                attributes: {
                  style: "text-align: center;"
                }
              },
              {
                field: "sutun1",
                title: "Sütun1",
                width: 115,
                headerAttributes: {
                  style: "background: linear-gradient(to bottom, #008000, #006600); color: white; font-weight: bold; text-align: center;"
                }
              },
              {
                field: "sutun2",
                title: "Sütun2",
                width: 145,
                headerAttributes: {
                  style: "background: linear-gradient(to bottom, #008000, #006600); color: white; font-weight: bold; text-align: center;"
                }
              },
              {
                field: "sutun3",
                title: "Sütun3",
                width: 115,
                headerAttributes: {
                  style: "background: linear-gradient(to bottom, #008000, #006600); color: white; font-weight: bold; text-align: center;"
                }
              }
            ],
            dataBound: function(e) {
              // Grid yüklendiğinde horizontal scroll'u kaldır
              var grid = this;
              setTimeout(function() {
                var gridElement = $("#kredi-karti-grid");
                // Tüm scroll'ları kaldır - tüm Telerik Grid elementlerinde
                gridElement.find("*").each(function() {
                  var $el = $(this);
                  if ($el.hasClass("k-grid") || $el.hasClass("k-grid-content") || 
                      $el.hasClass("k-grid-header") || $el.hasClass("k-grid-header-wrap") ||
                      $el.hasClass("k-grid-content-wrap") || $el.is("table")) {
                    $el.css("overflow-x", "hidden !important");
                    $el.css("max-width", "100vw");
                  }
                });
                gridElement.find(".k-grid-content").css("overflow-y", "auto");
                gridElement.css("overflow-x", "hidden").css("max-width", "100vw");
                gridElement.parent().css("overflow-x", "hidden").css("max-width", "100vw");
                
                // Grid genişliğini container'a göre ayarla
                var containerWidth = gridElement.parent().width();
                var windowWidth = $(window).width();
                var maxWidth = Math.min(windowWidth, 1920);
                gridElement.css("width", maxWidth + "px");
                grid.resize();
                
                console.log("Kredi Kartı Grid yüklendi - 20 satır, horizontal scroll kapalı");
              }, 100);
            }
          });
          
          // Grid oluşturulduktan sonra horizontal scroll'u kaldır
          setTimeout(function() {
            var gridElement = $("#kredi-karti-grid");
            // Tüm Telerik Grid elementlerinde overflow-x hidden
            gridElement.find("*").each(function() {
              var $el = $(this);
              if ($el.hasClass("k-grid") || $el.hasClass("k-grid-content") || 
                  $el.hasClass("k-grid-header") || $el.hasClass("k-grid-header-wrap") ||
                  $el.hasClass("k-grid-content-wrap") || $el.is("table") || $el.is("thead") || $el.is("tbody")) {
                $el.css("overflow-x", "hidden !important");
                $el.css("max-width", "100vw");
              }
            });
            gridElement.find(".k-grid-content").css("overflow-y", "auto");
            gridElement.css("overflow-x", "hidden").css("max-width", "100vw");
            gridElement.parent().css("overflow-x", "hidden").css("max-width", "100vw");
            
            // Tüm parent container'ları kontrol et
            $("#main-content").css("overflow-x", "hidden").css("max-width", "100vw");
            $("body").css("overflow-x", "hidden").css("max-width", "100vw");
            $("html").css("overflow-x", "hidden").css("max-width", "100vw");
          }, 400);
          
          console.log("✅ Kredi Kartı Grid başarıyla oluşturuldu! (20 satır)");
        } else {
          console.log("⏳ Telerik yükleniyor, bekleniyor...");
          setTimeout(arguments.callee, 100);
        }
      }, 200);
      
      // Ekran boyutu değiştiğinde grid'i yeniden boyutlandır
      $(window).on('resize', function() {
        var grid = $("#kredi-karti-grid").data("kendoGrid");
        if (grid) {
          grid.resize();
        }
      });
    });
  </script>
{% endblock %}
