{% extends "dashboard/base.html" %}
{% load static %}

{% block title %}K.Kartı-Kredi{% endblock %}

{% block extra_head %}
  <style>
    *{box-sizing:border-box}
    /* Kredi kartı sayfası için overflow kontrolü */
    #kredi-karti-grid, #kredi-karti-grid .k-grid, #kredi-karti-grid .k-grid-content,
    #kredi-karti-grid .k-grid-header, #kredi-karti-grid .k-grid-header-wrap,
    #kredi-karti-grid .k-grid-content-wrap, #kredi-karti-grid table {overflow-x:hidden !important;max-width:100% !important;width:100% !important}
  </style>
{% endblock %}

{% block content %}
  <div style="padding:0;width:100%;max-width:100vw;overflow-x:hidden !important;overflow-y:auto;box-sizing:border-box;margin:0;">
    <h1 style="text-align:center;color:#206d7d;margin:10px 0;font-size:20pt;font-weight:bold;">KREDİ KARTI TAKİP</h1>
    <div id="kredi-karti-grid" style="width:100%;max-width:100vw;height:800px;overflow-x:hidden !important;overflow-y:auto;margin:0;padding:0;"></div>
  </div>
{% endblock %}

{% block extra_scripts %}
  <script>
    $(document).ready(function() {
      // NOT: Tab yönetimi (openTabs, activeTabId, openTab, setActiveTab, closeTab, saveTabsToStorage, loadTabsFromStorage, createTabElement, findTabByTitle, setActiveRibbonButton) base.html'de tanımlı, burada tekrar tanımlamaya gerek yok
      // NOT: Ribbon butonlarına tıklama base.html'de tanımlı, burada tekrar tanımlamaya gerek yok
      // NOT: Ribbon butonlarına hover efekti base.html'de tanımlı, burada tekrar tanımlamaya gerek yok
      
      // Sayfa yüklendiğinde tab'ları yükle
      setTimeout(function() {
        loadTabsFromStorage();
      }, 50);
      
          // Telerik Kendo Grid oluştur
      setTimeout(function() {
        if (typeof kendo !== 'undefined' && typeof $.fn.kendoGrid !== 'undefined') {
          // 20 boş satır oluştur
          var emptyRows = [];
          for (var i = 0; i < 20; i++) {
            emptyRows.push({
              son_odeme: null,
              kalan_gun: null,
              tutar: "",
              banka: "",
              kime_ait: "",
              kart_numarasi: "",
              son_kullanim_tarihi: "",
              cv: "",
              iban: "",
              sifre: "",
              sutun1: "",
              sutun2: "",
              sutun3: ""
            });
          }
          
          // Ekran genişliği: 1920px
          // ALAN 1: 28px, ALAN 2: 86px, ALAN 3: 23px, Tab: 32px = Toplam: 169px
          // Kullanılabilir genişlik: 1920px (padding yok)
          // Grid container genişliğini hesapla
          var containerWidth = $("#kredi-karti-grid").parent().width() || $(window).width();
          var gridWidth = Math.min(containerWidth, 1920);
          
          $("#kredi-karti-grid").kendoGrid({
            dataSource: {
              data: emptyRows, // 20 boş satır
              schema: {
                model: {
                  fields: {
                    son_odeme: { type: "date" },
                    kalan_gun: { type: "number" },
                    tutar: { type: "string" },
                    banka: { type: "string" },
                    kime_ait: { type: "string" },
                    kart_numarasi: { type: "string" },
                    son_kullanim_tarihi: { type: "string" },
                    cv: { type: "string" },
                    iban: { type: "string" },
                    sifre: { type: "string" },
                    sutun1: { type: "string" },
                    sutun2: { type: "string" },
                    sutun3: { type: "string" }
                  }
                }
              }
            },
            width: gridWidth,
            height: "100%",
            scrollable: false,
            sortable: true,
            filterable: true,
            resizable: false, // Sütun genişliği değiştirme kapalı (horizontal scroll olmasın diye)
            pageable: false, // Sayfalama kapalı - tüm satırlar görünsün
            columns: [
              {
                field: "son_odeme",
                title: "SON ÖDEME",
                width: 125,
                format: "{0:dd.MM.yyyy}",
                headerAttributes: {
                  style: "background: linear-gradient(to bottom, #206d7d, #1a5a68); color: white; font-weight: bold; text-align: center;"
                }
              },
              {
                field: "kalan_gun",
                title: "KALAN GÜN",
                width: 95,
                headerAttributes: {
                  style: "background: linear-gradient(to bottom, #206d7d, #1a5a68); color: white; font-weight: bold; text-align: center;"
                },
                attributes: {
                  style: "text-align: center;"
                }
              },
              {
                field: "tutar",
                title: "TUTAR",
                width: 115,
                headerAttributes: {
                  style: "background: linear-gradient(to bottom, #206d7d, #1a5a68); color: white; font-weight: bold; text-align: center;"
                },
                attributes: {
                  style: "text-align: right;"
                }
              },
              {
                field: "banka",
                title: "BANKA",
                width: 135,
                headerAttributes: {
                  style: "background: linear-gradient(to bottom, #206d7d, #1a5a68); color: white; font-weight: bold; text-align: center;"
                }
              },
              {
                field: "kime_ait",
                title: "KİME AİT",
                width: 115,
                headerAttributes: {
                  style: "background: linear-gradient(to bottom, #206d7d, #1a5a68); color: white; font-weight: bold; text-align: center;"
                }
              },
              {
                field: "kart_numarasi",
                title: "KART NUMARASI",
                width: 175,
                headerAttributes: {
                  style: "background: linear-gradient(to bottom, #206d7d, #1a5a68); color: white; font-weight: bold; text-align: center;"
                }
              },
              {
                field: "son_kullanim_tarihi",
                title: "SON KULLANMA TARİHİ",
                width: 135,
                headerAttributes: {
                  style: "background: linear-gradient(to bottom, #206d7d, #1a5a68); color: white; font-weight: bold; text-align: center;"
                }
              },
              {
                field: "cv",
                title: "CV",
                width: 65,
                headerAttributes: {
                  style: "background: linear-gradient(to bottom, #206d7d, #1a5a68); color: white; font-weight: bold; text-align: center;"
                },
                attributes: {
                  style: "text-align: center;"
                }
              },
              {
                field: "iban",
                title: "İBAN",
                width: 195,
                headerAttributes: {
                  style: "background: linear-gradient(to bottom, #206d7d, #1a5a68); color: white; font-weight: bold; text-align: center;"
                }
              },
              {
                field: "sifre",
                title: "ŞİFRE",
                width: 75,
                headerAttributes: {
                  style: "background: linear-gradient(to bottom, #206d7d, #1a5a68); color: white; font-weight: bold; text-align: center;"
                },
                attributes: {
                  style: "text-align: center;"
                }
              },
              {
                field: "sutun1",
                title: "Sütun1",
                width: 115,
                headerAttributes: {
                  style: "background: linear-gradient(to bottom, #008000, #006600); color: white; font-weight: bold; text-align: center;"
                }
              },
              {
                field: "sutun2",
                title: "Sütun2",
                width: 145,
                headerAttributes: {
                  style: "background: linear-gradient(to bottom, #008000, #006600); color: white; font-weight: bold; text-align: center;"
                }
              },
              {
                field: "sutun3",
                title: "Sütun3",
                width: 115,
                headerAttributes: {
                  style: "background: linear-gradient(to bottom, #008000, #006600); color: white; font-weight: bold; text-align: center;"
                }
              }
            ],
            dataBound: function(e) {
              // Grid yüklendiğinde horizontal scroll'u kaldır
              var grid = this;
              setTimeout(function() {
                var gridElement = $("#kredi-karti-grid");
                // Tüm scroll'ları kaldır - tüm Telerik Grid elementlerinde
                gridElement.find("*").each(function() {
                  var $el = $(this);
                  if ($el.hasClass("k-grid") || $el.hasClass("k-grid-content") || 
                      $el.hasClass("k-grid-header") || $el.hasClass("k-grid-header-wrap") ||
                      $el.hasClass("k-grid-content-wrap") || $el.is("table")) {
                    $el.css("overflow-x", "hidden !important");
                    $el.css("max-width", "100vw");
                  }
                });
                gridElement.find(".k-grid-content").css("overflow-y", "auto");
                gridElement.css("overflow-x", "hidden").css("max-width", "100vw");
                gridElement.parent().css("overflow-x", "hidden").css("max-width", "100vw");
                
                // Grid genişliğini container'a göre ayarla
                var containerWidth = gridElement.parent().width();
                var windowWidth = $(window).width();
                var maxWidth = Math.min(windowWidth, 1920);
                gridElement.css("width", maxWidth + "px");
                grid.resize();
                
                console.log("Kredi Kartı Grid yüklendi - 20 satır, horizontal scroll kapalı");
              }, 100);
            }
          });
          
          // Grid oluşturulduktan sonra horizontal scroll'u kaldır
          setTimeout(function() {
            var gridElement = $("#kredi-karti-grid");
            // Tüm Telerik Grid elementlerinde overflow-x hidden
            gridElement.find("*").each(function() {
              var $el = $(this);
              if ($el.hasClass("k-grid") || $el.hasClass("k-grid-content") || 
                  $el.hasClass("k-grid-header") || $el.hasClass("k-grid-header-wrap") ||
                  $el.hasClass("k-grid-content-wrap") || $el.is("table") || $el.is("thead") || $el.is("tbody")) {
                $el.css("overflow-x", "hidden !important");
                $el.css("max-width", "100vw");
              }
            });
            gridElement.find(".k-grid-content").css("overflow-y", "auto");
            gridElement.css("overflow-x", "hidden").css("max-width", "100vw");
            gridElement.parent().css("overflow-x", "hidden").css("max-width", "100vw");
            
            // Tüm parent container'ları kontrol et
            $("#main-content").css("overflow-x", "hidden").css("max-width", "100vw");
            $("body").css("overflow-x", "hidden").css("max-width", "100vw");
            $("html").css("overflow-x", "hidden").css("max-width", "100vw");
          }, 400);
          
          console.log("✅ Kredi Kartı Grid başarıyla oluşturuldu! (20 satır)");
        } else {
          console.log("⏳ Telerik yükleniyor, bekleniyor...");
          setTimeout(arguments.callee, 100);
        }
      }, 200);
      
      // Ekran boyutu değiştiğinde grid'i yeniden boyutlandır
      $(window).on('resize', function() {
        var grid = $("#kredi-karti-grid").data("kendoGrid");
        if (grid) {
          grid.resize();
        }
      });
    });
  </script>
{% endblock %}
