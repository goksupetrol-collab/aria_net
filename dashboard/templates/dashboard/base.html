{% load static %}
<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{% block title %}Yeni Telerik Projesi{% endblock %}</title>
  <link rel="icon" href="data:,">
  <style>
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;height:100%;font-size:11px;overflow-x:hidden !important;overflow-y:auto;width:100%;max-width:100vw}
    /* Operasyon sayfası açıkken boş sayfada kaydırma çubuğunu gizle */
    body.operasyon-sayfasi-acik {
      overflow-y: hidden !important;
    }
    body.operasyon-sayfasi-acik html {
      overflow-y: hidden !important;
    }
    
    /* main-content overflow kontrolü - horizontal scroll olmasın */
    #main-content{overflow-x:hidden !important;overflow-y:auto;width:100% !important;max-width:100vw !important;position:relative;min-height:auto !important;height:auto !important}
    /* Operasyon sayfası açıkken main-content kaydırmasını gizle */
    body.operasyon-sayfasi-acik #main-content {
      overflow-y: hidden !important;
    }
    #main-content > * {max-width:100% !important;width:100% !important}
    
    /* 3 Sabit Alan - Basit HTML ile */
    #fixed-area-1-container,
    #fixed-area-2-container,
    #fixed-area-3-container {
      font-family: 'Segoe UI', Arial, sans-serif;
    }
    
    /* Tab Container - Basit HTML Tab Sistemi */
    #tabs-container {
      width: 100%;
      margin: 0;
      padding: 0;
      display: flex !important;
      visibility: visible !important;
      overflow-x: auto;
    }
    #tabs-list {
      display: flex !important;
      align-items: center;
      gap: 2px;
      padding: 0;
      margin: 0;
      height: 100%;
      list-style: none;
    }
    /* Flash sorunu çözümü: Tüm sabit alanları ve içeriği sayfa yüklenene kadar gizle */
    #fixed-area-1-container,
    #fixed-area-2-container,
    #tabs-container,
    #main-content {
      opacity: 0;
      transition: opacity 0.05s;
    }
    /* Sayfa yüklendikten sonra göster */
    body.loaded #fixed-area-1-container,
    body.loaded #fixed-area-2-container,
    body.loaded #tabs-container,
    body.loaded #main-content {
      opacity: 1 !important;
    }
    
    /* ALAN 1 - Ana Menü Butonları */
    #fixed-area-1-container {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      padding: 0;
    }

    /* ALAN 1 - Ana menü yazı boyutu */
    #ana-menu-bar .k-menu-item-text,
    #ana-menu-bar .k-link,
    #ana-menu-bar li span {
      font-size: 19px !important;
    }

    /* Alt menü yazıları - 16px ve sol hizalı */
    #ana-menu-bar .k-menu-group .k-menu-item-text,
    #ana-menu-bar .k-menu-group .k-link,
    #ana-menu-bar .k-popup .k-menu-item-text,
    #ana-menu-bar .k-popup .k-link {
      font-size: 16px !important;
      text-align: left !important;
      justify-content: flex-start !important;
    }

    /* Alt menü yazı boyutu - en güçlü zorlamalar */
    #ana-menu-bar .k-menu-group .k-item,
    #ana-menu-bar .k-popup .k-item,
    #ana-menu-bar .k-menu-group .k-item .k-link,
    #ana-menu-bar .k-popup .k-item .k-link,
    #ana-menu-bar .k-menu-group .k-item .k-menu-item-text,
    #ana-menu-bar .k-popup .k-item .k-menu-item-text,
    #ana-menu-bar .k-menu-group .k-item span,
    #ana-menu-bar .k-popup .k-item span {
      font-size: 16px !important;
    }

    /* Alt menü arka planı - açık gri */
    #ana-menu-bar .k-menu-group,
    #ana-menu-bar .k-popup,
    #ana-menu-bar .k-menu-group .k-item,
    #ana-menu-bar .k-popup .k-item {
      background: #f0f0f0 !important;
      background-color: #f0f0f0 !important;
    }

    /* Alt menü yazı hizası - sol baştan */
    #ana-menu-bar .k-menu-group .k-item,
    #ana-menu-bar .k-popup .k-item,
    #ana-menu-bar .k-menu-group .k-item .k-link,
    #ana-menu-bar .k-popup .k-item .k-link {
      text-align: left !important;
      justify-content: flex-start !important;
      align-items: center !important;
      padding-left: 12px !important;
    }

    /* Alt menü yumuşak geçiş */
    #ana-menu-bar .k-menu-group .k-item,
    #ana-menu-bar .k-popup .k-item,
    #ana-menu-bar .k-menu-group .k-item .k-link,
    #ana-menu-bar .k-popup .k-item .k-link {
      transition: background-color 0.15s ease, border-color 0.15s ease;
    }

    /* Çerçeve sabit dursun, sadece rengi değişsin */
    #ana-menu-bar .k-menu-group .k-item,
    #ana-menu-bar .k-popup .k-item {
      box-sizing: border-box !important;
      border: 1px solid transparent !important;
    }

    /* Alt menüde sol hizayı zorla sabitle */
    #ana-menu-bar .k-menu-group,
    #ana-menu-bar .k-popup {
      text-align: left !important;
    }
    #ana-menu-bar .k-menu-group .k-item,
    #ana-menu-bar .k-popup .k-item {
      display: flex !important;
      justify-content: flex-start !important;
      align-items: center !important;
      width: 100% !important;
    }
    #ana-menu-bar .k-menu-group .k-link,
    #ana-menu-bar .k-popup .k-link,
    #ana-menu-bar .k-menu-group .k-menu-link,
    #ana-menu-bar .k-popup .k-menu-link {
      display: flex !important;
      justify-content: flex-start !important;
      align-items: center !important;
      width: 100% !important;
      text-align: left !important;
      padding-left: 12px !important;
      margin-left: 0 !important;
    }
    #ana-menu-bar .k-menu-group .k-menu-item-text,
    #ana-menu-bar .k-popup .k-menu-item-text {
      display: inline-block !important;
      text-align: left !important;
      margin-left: 0 !important;
    }
    
    /* Telerik TabStrip (ALAN 3) - modern ve anlaşılır görünüm */
    #tabs .k-tabstrip-items {
      gap: 2px;
    }
    #tabs .k-tabstrip-item {
      font-size: 14px !important;
      line-height: 1;
    }
    #tabs .k-tabstrip-item .k-link {
      font-size: 14px !important;
      padding: 6px 12px !important;
      height: 30px;
      line-height: 30px;
      display: inline-flex;
      align-items: center;
      border-radius: 4px 4px 0 0;
      border: 1px solid transparent;
      background: #f0f0f0;
      color: #333333;
      font-weight: 500;
    }
    #tabs .k-tabstrip-item .k-link:hover,
    #tabs .k-tabstrip-item .k-link.k-hover {
      background: #e6e6e6;
      border-color: #d0d0d0;
    }
    #tabs .k-tabstrip-item.k-active .k-link,
    #tabs .k-tabstrip-item.k-selected .k-link,
    #tabs .k-tabstrip-item .k-link.k-active,
    #tabs .k-tabstrip-item .k-link.k-selected {
      background: #2e7d32;
      border-color: #2e7d32;
      color: #ffffff;
      font-weight: 700;
    }
    #tabs .k-tabstrip-item.k-active .k-link:hover,
    #tabs .k-tabstrip-item.k-selected .k-link:hover {
      background: #2b6f2e;
      border-color: #2b6f2e;
    }
    /* Eski CSS'ler temizlendi - Artık Telerik kullanılıyor */
    /* Ribbon buton stili - Resimdeki gibi kompakt */
    .ribbon-button {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 4px 6px;
      min-width: 70px;
      max-width: 70px;
      cursor: pointer;
      border-radius: 2px;
      transition: all 0.15s;
      background: transparent;
      border: 1px solid transparent;
    }
    .ribbon-button:hover {
      background: rgba(255,255,255,0.5);
      border: 1px solid #C0C0C0;
    }
    .ribbon-button.active {
      background: rgba(255,255,255,0.8);
      border: 1px solid #808080;
      box-shadow: inset 0 0 2px rgba(0,0,0,0.1);
    }
  </style>
  
  <!-- Telerik Kendo UI CSS -->
  <link rel="stylesheet" href="{% static 'dashboard/kendo/styles/default-main.css' %}" />
  
  <!-- jQuery (Telerik için gerekli) -->
  <script src="{% static 'dashboard/js/jquery-3.6.0.min.js' %}"></script>
  
  <!-- Telerik Kendo UI JavaScript (Tüm bileşenler) -->
  <script src="{% static 'dashboard/js/kendo.all.min.js' %}"></script>
  
  <!-- Telerik Türkçe Kültür -->
  <script src="{% static 'dashboard/js/cultures/kendo.culture.tr-TR.min.js' %}"></script>
  <script>
    kendo.culture("tr-TR");
  </script>
  
  <!-- Telerik Lisans -->
  <script src="{% static 'dashboard/kendo/telerik-license.js' %}"></script>
  
  {% block extra_head %}{% endblock %}
</head>

<body>
    <!-- 1. SABİT ALAN: ALAN 1 (En Üst) - Ana Menü Butonları -->
  <div id="fixed-area-1-container" style="position:fixed;top:0;left:0;right:0;z-index:10000;background:linear-gradient(to bottom, #f5f5f5, #eeeeee);height:28px;border-bottom:1px solid #e0e0e0;font-family:'Segoe UI',Arial,sans-serif;opacity:0;">
    <!-- Telerik Kendo UI Menu -->
    <ul id="ana-menu-bar" style="margin:0;padding:0;list-style:none;display:flex;height:100%;align-items:center;font-family:'Segoe UI',Arial,sans-serif !important;">
      <li>
        <span>Tanımlar</span>
        <ul>
          <li><span>Firma Tanımları</span></li>
          <li><span>Şube Tanımları</span></li>
          <li><span>Ürün Tanımları</span></li>
          <li><span>Whatsapp Tanımları</span></li>
          <li><span>Sistem Tanımları</span></li>
          <li><span>Kullanıcı Tanımları</span></li>
          <li><span>Menü Çubuğu Ayarları</span></li>
          <li><span>Çıkış</span></li>
        </ul>
      </li>
      <li>
        <span>Kartlar</span>
        <ul>
          <li><span>Cari Kartlar</span></li>
        </ul>
      </li>
      <li>
        <span>Operasyon</span>
        <ul>
          <li><span>Zam/İndirim</span></li>
        </ul>
      </li>
      <li>
        <span>Raporlar</span>
        <ul></ul>
      </li>
    </ul>
    <span style="position:absolute;right:8px;top:6px;color:#555;font-size:10pt;font-weight:600;pointer-events:none;white-space:nowrap;">ALAN 1</span>
  </div>
  
  <!-- 2. SABİT ALAN: ALAN 2 (İkonlu Butonlar) - Açık Gri -->
  <div id="fixed-area-2-container" style="position:fixed;top:28px;left:0;right:0;z-index:9999;background:linear-gradient(to bottom, #f5f5f5, #eeeeee);height:80px;display:flex;align-items:center;justify-content:flex-start;padding:8px 6px;gap:4px;font-family:'Segoe UI',Arial,sans-serif;border-bottom:1px solid #e0e0e0;opacity:0;">
    <!-- İkonlu Butonlar (ALAN 2'nin içinde) -->
    <div id="main-ribbon-container" style="display:flex;align-items:center;gap:4px;overflow-x:auto;flex:1;justify-content:flex-start;">
      <div id="ribbon-buttons" style="display:flex;gap:4px;align-items:center;flex-wrap:nowrap"></div>
    </div>
    <span style="position:absolute;right:8px;top:30px;color:#555;font-size:10pt;font-weight:600;pointer-events:none;white-space:nowrap;">ALAN 2</span>
  </div>
  
  <!-- 3. Tab Container - Telerik TabStrip - Açık Gri (ALAN 2 ile aynı) -->
  <div id="tabs-container" style="position:fixed;top:108px;left:0;right:0;z-index:9998;height:30px;background:#f5f5f5;border-bottom:1px solid #e0e0e0;padding:0;opacity:0;">
    <div id="tabs"></div>
    <span style="position:absolute;right:8px;top:6px;color:#555;font-size:10pt;font-weight:600;pointer-events:none;white-space:nowrap;">ALAN 3</span>
  </div>
  
  <!-- TANIMLAR ALT MENÜ -->
  <div id="tanimlar-menu" style="position:fixed;top:28px;left:0;background:#FFFFFF;border:1px solid #E0E0E0;box-shadow:0 2px 4px rgba(0,0,0,0.1);z-index:10001;display:none;min-width:200px;">
    <div id="tanimlar-firmalar" style="padding:5px 15px;cursor:pointer;">Firmalar</div>
  </div>
  
  <!-- FIRMA TANIMLARI WINDOW -->
  <div id="firma-tanimlari-window" style="display:none;">
    <div style="padding:12px;">
      <label for="firma-adi-input" style="display:block;margin-bottom:6px;font-weight:600;">Firma İsmi</label>
      <input id="firma-adi-input" style="width:100%;" />
    </div>
  </div>
  
  <!-- ÜRÜN TANIMLARI WINDOW -->
  <div id="urun-tanimlari-window" style="display:none;">
    <div style="padding:12px;">
      <label for="urun-adi-input" style="display:block;margin-bottom:6px;font-weight:600;">Ürün İsmi</label>
      <input id="urun-adi-input" style="width:100%;" />
    </div>
  </div>

  <!-- FIRMA YÖNETİMİ WINDOW -->
  <div id="firma-window" style="display:none;">
    <div id="firma-grid-container" style="padding:10px;height:100%;">
      <div id="firma-grid" style="height:300px;"></div>
    </div>
  </div>
  
  <!-- ÜRÜN YÖNETİMİ WINDOW -->
  <div id="urun-window" style="display:none;">
    <div id="urun-grid-container" style="padding:10px;height:100%;">
      <div id="urun-grid" style="height:300px;"></div>
    </div>
  </div>
  
  <!-- İÇERİK ALANI -->
  <div id="main-content" style="margin-top:134px;padding-top:0;opacity:0;">
    <style>
      #main-content-firma-tanimlari h1 {
        margin-top: 4px !important;
      }
    </style>
    {% block content %}{% endblock %}
  </div>
  
  <!-- TELERİK NOTIFICATION BİLEŞENİ -->
  <div id="notification"></div>
  
  <script>
    // Menü öğelerini veritabanından yükle
    var menuItems = {{ menu_items|safe }};

    // Tanımlar menüsü - geçiş için örnek veri (Petronet mantığına hazırlık)
    // Şimdilik mevcut Tanımlar alt başlıklarıyla aynı içerik verildi.
    var tanimlarMenuData = [
      { text: "Firma Tanımları", key: "firma_tanimlari" },
      { text: "Şube Tanımları", key: "sube_tanimlari" },
      { text: "Ürün Tanımları", key: "urun_tanimlari" },
      { text: "Whatsapp Tanımları", key: "whatsapp_tanimlari" },
      { text: "Menü Çubuğu Ayarları", key: "menu_cubugu_ayarlari" },
      { text: "Çıkış", key: "cikis" }
    ];

    // Bu bayrak true olduğunda Tanımlar alt menüsü veriden doldurulur.
    // Şu an içerik aynı olduğu için ekranda fark yoktur.
    var useTanimlarMenuData = true;

    function renderTanimlarMenuFromData() {
      if (!useTanimlarMenuData || !Array.isArray(tanimlarMenuData) || tanimlarMenuData.length === 0) {
        return;
      }

      var tanimlarMenu = $("#ana-menu-bar > li").filter(function() {
        return $(this).children("span").first().text().trim() === "Tanımlar";
      }).first();

      if (!tanimlarMenu.length) {
        return;
      }

      var subList = tanimlarMenu.children("ul");
      if (!subList.length) {
        subList = $("<ul></ul>").appendTo(tanimlarMenu);
      }

      subList.empty();
      tanimlarMenuData.forEach(function(item) {
        var li = $("<li></li>");
        if (item.key) {
          li.attr("data-menu-key", item.key);
        }
        li.append($("<span></span>").text(item.text));
        subList.append(li);
      });
    }

    function updateFixedArea4DateTime() {
      var target = document.getElementById("fixed-area-4-datetime");
      if (!target) {
        return;
      }
      var now = new Date();
      if (typeof kendo !== "undefined" && typeof kendo.toString === "function") {
        target.textContent = kendo.toString(now, "dd.MM.yyyy dddd HH:mm:ss");
      } else {
        var pad = function(value) { return value < 10 ? ("0" + value) : value; };
        var dateText = pad(now.getDate()) + "." + pad(now.getMonth() + 1) + "." + now.getFullYear();
        var timeText = pad(now.getHours()) + ":" + pad(now.getMinutes()) + ":" + pad(now.getSeconds());
        target.textContent = dateText + " " + timeText;
      }
    }

    function updateFixedArea4Rates() {
      var target = document.getElementById("fixed-area-4-rates");
      if (!target) {
        return;
      }
      fetch("/api/harem-kur/", { cache: "no-store" })
        .then(function(response) { return response.json(); })
        .then(function(result) {
          if (!result || !result.data) {
            target.textContent = "";
            return;
          }
          var data = result.data;
          var usd = data.USD || {};
          var eur = data.EUR || {};
          var altin = data.ALTIN || {};
          var format = function(item) {
            if (!item || !item.alis || !item.satis) {
              return "--/--";
            }
            return item.alis + "/" + item.satis;
          };
          var alis = altin && altin.alis ? altin.alis : "--";
          var satis = altin && altin.satis ? altin.satis : "--";
          var yuzdeRaw = altin && altin.yuzde ? altin.yuzde : (altin && altin.fark ? altin.fark : "--");
          var renk = function(value) {
            var num = parseFloat((value || "").toString().replace(",", "."));
            if (isNaN(num)) {
              return "#333";
            }
            return num >= 0 ? "#2e7d32" : "#c62828";
          };
          var usdYuzde = usd && (usd.yuzde || usd.fark) ? (usd.yuzde || usd.fark) : "--";
          var eurYuzde = eur && (eur.yuzde || eur.fark) ? (eur.yuzde || eur.fark) : "--";
          fetch("/api/zam-indirim-panel/", { cache: "no-store" })
            .then(function(resp) { return resp.json(); })
            .then(function(panel) {
              var formatSigned = function(value, suffix) {
                var num = parseFloat((value || "").toString().replace(",", "."));
                if (isNaN(num)) {
                  return { text: "--", color: "#666" };
                }
                var sign = num > 0 ? "+" : num < 0 ? "-" : "";
                var abs = Math.abs(num).toFixed(2).replace(".", ",");
                var color = num > 0 ? "#2e7d32" : num < 0 ? "#c62828" : "#666";
                return { text: sign + abs + (suffix || ""), color: color };
              };
              var benzinPct = panel && panel.benzin_kalan_pct ? formatSigned(panel.benzin_kalan_pct, "%") : { text: "--", color: "#666" };
              var motorinPct = panel && panel.motorin_kalan_pct ? formatSigned(panel.motorin_kalan_pct, "%") : { text: "--", color: "#666" };
              var benzinTl = panel && panel.benzin_tl_l ? formatSigned(panel.benzin_tl_l, " TL/L") : { text: "--", color: "#666" };
              var motorinTl = panel && panel.motorin_tl_l ? formatSigned(panel.motorin_tl_l, " TL/L") : { text: "--", color: "#666" };
              var benzinSignal = panel && panel.benzin_sinyal ? panel.benzin_sinyal.toLowerCase() : "yok";
              var motorinSignal = panel && panel.motorin_sinyal ? panel.motorin_sinyal.toLowerCase() : "yok";

              target.innerHTML =
                "<span class=\"area4-chip area4-usd\">USD " + format(usd) +
                  " <span style=\"color:" + renk(usdYuzde) + ";font-weight:700;\">%" + usdYuzde + "</span></span>" +
                "<span class=\"area4-chip area4-eur\">EUR " + format(eur) +
                  " <span style=\"color:" + renk(eurYuzde) + ";font-weight:700;\">%" + eurYuzde + "</span></span>" +
                "<span class=\"area4-chip area4-gold\">HAS ALTIN " + alis + "/" + satis +
                  " <span style=\"color:" + renk(yuzdeRaw) + ";font-weight:700;\">%" + yuzdeRaw + "</span></span>" +
                "<span class=\"area4-chip area4-zam-motorin\">Motorin sinyal " + motorinSignal +
                  " • Zam’a kalan <span style=\"color:" + motorinPct.color + ";font-weight:700;\">" + motorinPct.text + "</span>" +
                  " • <span style=\"color:" + motorinTl.color + ";font-weight:700;\">" + motorinTl.text + "</span></span>" +
                "<span class=\"area4-chip area4-zam-benzin\">Benzin sinyal " + benzinSignal +
                  " • Zam’a kalan <span style=\"color:" + benzinPct.color + ";font-weight:700;\">" + benzinPct.text + "</span>" +
                  " • <span style=\"color:" + benzinTl.color + ";font-weight:700;\">" + benzinTl.text + "</span></span>";
            })
            .catch(function() {
              target.innerHTML =
                "<span class=\"area4-chip area4-usd\">USD " + format(usd) +
                  " <span style=\"color:" + renk(usdYuzde) + ";font-weight:700;\">%" + usdYuzde + "</span></span>" +
                "<span class=\"area4-chip area4-eur\">EUR " + format(eur) +
                  " <span style=\"color:" + renk(eurYuzde) + ";font-weight:700;\">%" + eurYuzde + "</span></span>" +
                "<span class=\"area4-chip area4-gold\">HAS ALTIN " + alis + "/" + satis +
                  " <span style=\"color:" + renk(yuzdeRaw) + ";font-weight:700;\">%" + yuzdeRaw + "</span></span>";
            });
        })
        .catch(function() {
          target.textContent = "";
        });
    }

    var zamIndirimUsdTryValue = null;
    var zamIndirimInputsReady = false;
    var zamIndirimSaveTimer = null;
    var zamIndirimGridReady = false;
    var zamIndirimInfoReady = false;

    function initZamIndirimGrids() {
      if (zamIndirimGridReady) {
        return;
      }
      var veriGrid = $("#zam-indirim-veri-grid");
      var benzinGrid = $("#zam-indirim-benzin-ort5-grid");
      var motorinGrid = $("#zam-indirim-motorin-ort5-grid");
      if (!veriGrid.length || !benzinGrid.length || !motorinGrid.length) {
        return;
      }
      veriGrid.kendoGrid({
        dataSource: { data: [] },
        sortable: true,
        scrollable: true,
        height: 300,
        columns: [
          { field: "tarih", title: "Tarih", width: 110 },
          { field: "usdtry_1530", title: "USD/TRY (15:30)", width: 140 },
          { field: "benzin_usd_ton", title: "Benzin_USD_TON", width: 140 },
          { field: "motorin_usd_ton", title: "Motorin_USD_TON", width: 140 }
        ],
        noRecords: { template: "" }
      });
      benzinGrid.kendoGrid({
        dataSource: { data: [] },
        sortable: false,
        scrollable: true,
        height: 200,
        columns: [
          { field: "tarih", title: "Tarih", width: 110 },
          { field: "ref", title: "Benzin_Referans", width: 150 }
        ],
        noRecords: { template: "" }
      });
      motorinGrid.kendoGrid({
        dataSource: { data: [] },
        sortable: false,
        scrollable: true,
        height: 200,
        columns: [
          { field: "tarih", title: "Tarih", width: 110 },
          { field: "ref", title: "Motorin_Referans", width: 150 }
        ],
        noRecords: { template: "" }
      });
      zamIndirimGridReady = true;
    }

    function initZamIndirimInfoPanels() {
      if (zamIndirimInfoReady) {
        return;
      }
      var panels = [
        "#zam-indirim-system-note",
        "#zam-indirim-veri-info",
        "#zam-indirim-hesap-info",
        "#zam-indirim-panel-info"
      ];
      panels.forEach(function(selector) {
        var $panel = $(selector);
        if ($panel.length && typeof $panel.kendoExpansionPanel === "function") {
          $panel.kendoExpansionPanel({
            title: "Bilgi",
            expanded: false
          });
        }
      });
      zamIndirimInfoReady = true;
    }

    function parseZamIndirimNumber(value) {
      if (value === null || value === undefined) {
        return null;
      }
      if (typeof value === "number") {
        return isNaN(value) ? null : value;
      }
      var text = value.toString().trim();
      if (!text) {
        return null;
      }
      var normalized = text.replace(",", ".");
      var num = parseFloat(normalized);
      return isNaN(num) ? null : num;
    }

    function initZamIndirimInputs() {
      if (zamIndirimInputsReady) {
        return;
      }
      var benzinInput = $("#zam-indirim-benzin-usd-ton");
      var motorinInput = $("#zam-indirim-motorin-usd-ton");
      if (!benzinInput.length || !motorinInput.length) {
        return;
      }
      benzinInput.kendoNumericTextBox({
        format: "n4",
        decimals: 4,
        min: 0,
        step: 0.0001,
        change: function() {
          updateZamIndirimReferans();
          scheduleZamIndirimSave();
        }
      });
      motorinInput.kendoNumericTextBox({
        format: "n4",
        decimals: 4,
        min: 0,
        step: 0.0001,
        change: function() {
          updateZamIndirimReferans();
          scheduleZamIndirimSave();
        }
      });
      zamIndirimInputsReady = true;
    }

    function getZamIndirimInputValues() {
      var benzinWidget = $("#zam-indirim-benzin-usd-ton").data("kendoNumericTextBox");
      var motorinWidget = $("#zam-indirim-motorin-usd-ton").data("kendoNumericTextBox");
      return {
        benzin: benzinWidget ? benzinWidget.value() : null,
        motorin: motorinWidget ? motorinWidget.value() : null
      };
    }

    function formatZamIndirimValue(value, decimals) {
      var num = parseZamIndirimNumber(value);
      if (num === null) {
        return "--";
      }
      if (window.kendo && kendo.toString) {
        var format = "n" + decimals;
        return kendo.toString(num, format);
      }
      return num.toFixed(decimals);
    }

    function updateZamIndirimDisplayValues(data) {
      var tarihTarget = document.getElementById("zam-indirim-tarih");
      var usdTargets = [
        document.getElementById("zam-indirim-usd-kur"),
        document.getElementById("zam-indirim-panel-usd")
      ];
      if (tarihTarget) {
        tarihTarget.textContent = data.tarih || "--";
      }
      usdTargets.forEach(function(target) {
        if (target) {
          target.textContent = data.usdtry_1530 || "--";
        }
      });
      var benzinRefTargets = [
        document.getElementById("zam-indirim-benzin-ref"),
        document.getElementById("zam-indirim-panel-benzin-ref")
      ];
      var motorinRefTargets = [
        document.getElementById("zam-indirim-motorin-ref"),
        document.getElementById("zam-indirim-panel-motorin-ref")
      ];
      var benzinOrtTargets = [
        document.getElementById("zam-indirim-benzin-ort5"),
        document.getElementById("zam-indirim-panel-benzin-ort5")
      ];
      var motorinOrtTargets = [
        document.getElementById("zam-indirim-motorin-ort5"),
        document.getElementById("zam-indirim-panel-motorin-ort5")
      ];
      var benzinSinyalTargets = [
        document.getElementById("zam-indirim-benzin-sinyal"),
        document.getElementById("zam-indirim-panel-benzin-sinyal")
      ];
      var motorinSinyalTargets = [
        document.getElementById("zam-indirim-motorin-sinyal"),
        document.getElementById("zam-indirim-panel-motorin-sinyal")
      ];
      var benzinKalanTargets = [
        document.getElementById("zam-indirim-panel-benzin-kalan")
      ];
      var motorinKalanTargets = [
        document.getElementById("zam-indirim-panel-motorin-kalan")
      ];
      var benzinOngoruTarget = document.getElementById("zam-indirim-panel-benzin-ongoru");
      var benzinOngoruLabel = document.getElementById("zam-indirim-panel-benzin-ongoru-label");
      var motorinOngoruTarget = document.getElementById("zam-indirim-panel-motorin-ongoru");
      var motorinOngoruLabel = document.getElementById("zam-indirim-panel-motorin-ongoru-label");

      var benzinRefText = formatZamIndirimValue(data.benzin_ref, 2);
      var motorinRefText = formatZamIndirimValue(data.motorin_ref, 2);
      benzinRefTargets.forEach(function(target) {
        if (target) target.textContent = benzinRefText;
      });
      motorinRefTargets.forEach(function(target) {
        if (target) target.textContent = motorinRefText;
      });
      var benzinOrtText = data.benzin_ort5_text || formatZamIndirimValue(data.benzin_ort5, 2);
      var motorinOrtText = data.motorin_ort5_text || formatZamIndirimValue(data.motorin_ort5, 2);
      benzinOrtTargets.forEach(function(target) {
        if (target) target.textContent = benzinOrtText;
      });
      motorinOrtTargets.forEach(function(target) {
        if (target) target.textContent = motorinOrtText;
      });
      benzinSinyalTargets.forEach(function(target) {
        if (target) target.textContent = data.benzin_sinyal || "--";
      });
      motorinSinyalTargets.forEach(function(target) {
        if (target) target.textContent = data.motorin_sinyal || "--";
      });
      if (benzinOngoruTarget) {
        benzinOngoruTarget.textContent = data.benzin_ongoru || "--";
      }
      if (benzinOngoruLabel) {
        benzinOngoruLabel.textContent = data.benzin_ongoru_label ? "(" + data.benzin_ongoru_label + ")" : "";
      }
      if (motorinOngoruTarget) {
        motorinOngoruTarget.textContent = data.motorin_ongoru || "--";
      }
      if (motorinOngoruLabel) {
        motorinOngoruLabel.textContent = data.motorin_ongoru_label ? "(" + data.motorin_ongoru_label + ")" : "";
      }
      var benzinKalanText = "Ort5 yok";
      var motorinKalanText = "Ort5 yok";
      var benzinPctNum = parseZamIndirimNumber(data.benzin_kalan_pct);
      var motorinPctNum = parseZamIndirimNumber(data.motorin_kalan_pct);
      if (!data.benzin_ort5_text && benzinPctNum !== null) {
        var benzinPctText = formatZamIndirimValue(benzinPctNum, 2);
        benzinKalanText = (benzinPctNum > 0 ? "+" : benzinPctNum < 0 ? "-" : "") + benzinPctText.replace("-", "") + " %";
      }
      if (!data.motorin_ort5_text && motorinPctNum !== null) {
        var motorinPctText = formatZamIndirimValue(motorinPctNum, 2);
        motorinKalanText = (motorinPctNum > 0 ? "+" : motorinPctNum < 0 ? "-" : "") + motorinPctText.replace("-", "") + " %";
      }
      benzinKalanTargets.forEach(function(target) {
        if (target) {
          target.textContent = benzinKalanText;
          if (target.id && target.id.indexOf("panel") >= 0 && benzinPctNum !== null) {
            target.style.color = benzinPctNum > 0 ? "#2e7d32" : benzinPctNum < 0 ? "#c62828" : "#666";
          } else {
            target.style.color = "";
          }
        }
      });
      motorinKalanTargets.forEach(function(target) {
        if (target) {
          target.textContent = motorinKalanText;
          if (target.id && target.id.indexOf("panel") >= 0 && motorinPctNum !== null) {
            target.style.color = motorinPctNum > 0 ? "#2e7d32" : motorinPctNum < 0 ? "#c62828" : "#666";
          } else {
            target.style.color = "";
          }
        }
      });

      var benzinTlTarget = document.getElementById("zam-indirim-panel-benzin-tl-l");
      var motorinTlTarget = document.getElementById("zam-indirim-panel-motorin-tl-l");
      var benzinTlNum = parseZamIndirimNumber(data.benzin_tl_l);
      var motorinTlNum = parseZamIndirimNumber(data.motorin_tl_l);
      if (!data.benzin_ort5_text && benzinTlNum !== null) {
        var benzinTl = formatZamIndirimValue(benzinTlNum, 2);
        if (benzinTlTarget) {
          benzinTlTarget.textContent = "≈ " + (benzinTlNum > 0 ? "+" : benzinTlNum < 0 ? "-" : "") + benzinTl.replace("-", "") + " TL/L";
          benzinTlTarget.style.color = benzinTlNum > 0 ? "#2e7d32" : benzinTlNum < 0 ? "#c62828" : "#666";
        }
      } else if (benzinTlTarget) {
        benzinTlTarget.textContent = "";
        benzinTlTarget.style.color = "";
      }
      if (!data.motorin_ort5_text && motorinTlNum !== null) {
        var motorinTl = formatZamIndirimValue(motorinTlNum, 2);
        if (motorinTlTarget) {
          motorinTlTarget.textContent = "≈ " + (motorinTlNum > 0 ? "+" : motorinTlNum < 0 ? "-" : "") + motorinTl.replace("-", "") + " TL/L";
          motorinTlTarget.style.color = motorinTlNum > 0 ? "#2e7d32" : motorinTlNum < 0 ? "#c62828" : "#666";
        }
      } else if (motorinTlTarget) {
        motorinTlTarget.textContent = "";
        motorinTlTarget.style.color = "";
      }

      var ort5Uyari = document.getElementById("zam-indirim-panel-ort5-uyari");
      if (ort5Uyari) {
        ort5Uyari.style.display = data.ort5_yetersiz ? "block" : "none";
      }

      var anlikBox = document.getElementById("zam-indirim-anlik");
      var anlikBadge = document.getElementById("zam-indirim-anlik-badge");
      var anlikBenzin = document.getElementById("zam-indirim-anlik-benzin-text");
      var anlikMotorin = document.getElementById("zam-indirim-anlik-motorin-text");
      if (anlikBox && anlikBadge && anlikBenzin && anlikMotorin) {
        if (data.anlik_active) {
          anlikBox.style.display = "block";
          anlikBox.style.borderColor = "#d32f2f";
          anlikBadge.className = "k-badge k-badge-solid k-badge-md k-badge-error";
          anlikBenzin.textContent = data.anlik_benzin_text || "Veri yok";
          anlikMotorin.textContent = data.anlik_motorin_text || "Veri yok";
        } else {
          anlikBox.style.display = "block";
          anlikBox.style.borderColor = "#9e9e9e";
          anlikBadge.className = "k-badge k-badge-solid k-badge-md k-badge-base";
          anlikBenzin.textContent = "Kapanış sonrası pasif";
          anlikMotorin.textContent = "";
        }
      }
    }

    function loadZamIndirimForm() {
      initZamIndirimInfoPanels();
      initZamIndirimGrids();
      initZamIndirimInputs();
      fetch("/api/zam-indirim/", { cache: "no-store" })
        .then(function(response) { return response.json(); })
        .then(function(result) {
          if (!result || !result.success) {
            return;
          }
          var benzinWidget = $("#zam-indirim-benzin-usd-ton").data("kendoNumericTextBox");
          var motorinWidget = $("#zam-indirim-motorin-usd-ton").data("kendoNumericTextBox");
          if (benzinWidget) {
            benzinWidget.value(parseZamIndirimNumber(result.benzin_usd_ton));
          }
          if (motorinWidget) {
            motorinWidget.value(parseZamIndirimNumber(result.motorin_usd_ton));
          }
          zamIndirimUsdTryValue = result.usdtry_1530 || null;
          refreshZamIndirimPanel();
        })
        .catch(function() {});
    }

    function scheduleZamIndirimSave() {
      if (zamIndirimSaveTimer) {
        clearTimeout(zamIndirimSaveTimer);
      }
      zamIndirimSaveTimer = setTimeout(saveZamIndirimForm, 300);
    }

    function saveZamIndirimForm() {
      var values = getZamIndirimInputValues();
      fetch("/api/zam-indirim/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          benzin_usd_ton: values.benzin,
          motorin_usd_ton: values.motorin
        })
      })
        .then(function() { refreshZamIndirimPanel(); })
        .catch(function() {});
    }

    function refreshZamIndirimPanel() {
      fetch("/api/zam-indirim-panel/", { cache: "no-store" })
        .then(function(response) { return response.json(); })
        .then(function(result) {
          if (!result || !result.success) {
            return;
          }
          updateZamIndirimDisplayValues(result);
          updateZamIndirimTables(result);
          window.zamIndirimPanelData = result;
        })
        .catch(function() {});
    }

    function updateZamIndirimTables(data) {
      var veriGrid = $("#zam-indirim-veri-grid").data("kendoGrid");
      if (veriGrid) {
        veriGrid.dataSource.data(data.veri_kayitlari || []);
      }
      var benzinGrid = $("#zam-indirim-benzin-ort5-grid").data("kendoGrid");
      if (benzinGrid) {
        benzinGrid.dataSource.data(data.benzin_ort5_list || []);
      }
      var motorinGrid = $("#zam-indirim-motorin-ort5-grid").data("kendoGrid");
      if (motorinGrid) {
        motorinGrid.dataSource.data(data.motorin_ort5_list || []);
      }
    }

    function buildZamIndirimWhatsappMessage(data) {
      var ort5BenzinYok = !!data.benzin_ort5_text;
      var ort5MotorinYok = !!data.motorin_ort5_text;
      var benzinTlNum = parseZamIndirimNumber(data.benzin_tl_l);
      var motorinTlNum = parseZamIndirimNumber(data.motorin_tl_l);
      var benzinPctNum = parseZamIndirimNumber(data.benzin_kalan_pct);
      var motorinPctNum = parseZamIndirimNumber(data.motorin_kalan_pct);

      var benzinDurum = "Değişim beklenmiyor";
      var motorinDurum = "Değişim beklenmiyor";
      if (!ort5BenzinYok && benzinTlNum !== null) {
        if (Math.abs(benzinTlNum) < 0.0001) {
          benzinDurum = "Değişim beklenmiyor";
        } else if (benzinTlNum > 0) {
          benzinDurum = benzinPctNum !== null && Math.abs(benzinPctNum) < 3 ? "Artış eşiğine yakın" : "Artış bölgesinde";
        } else {
          benzinDurum = benzinPctNum !== null && Math.abs(benzinPctNum) < 3 ? "İndirim eşiğine yakın" : "İndirim bölgesinde";
        }
      }
      if (!ort5MotorinYok && motorinTlNum !== null) {
        if (Math.abs(motorinTlNum) < 0.0001) {
          motorinDurum = "Değişim beklenmiyor";
        } else if (motorinTlNum > 0) {
          motorinDurum = motorinPctNum !== null && Math.abs(motorinPctNum) < 3 ? "Artış eşiğine yakın" : "Artış bölgesinde";
        } else {
          motorinDurum = motorinPctNum !== null && Math.abs(motorinPctNum) < 3 ? "İndirim eşiğine yakın" : "İndirim bölgesinde";
        }
      }

      var benzinTlText = "";
      var motorinTlText = "";
      var benzinPctText = "";
      var motorinPctText = "";

      if (ort5BenzinYok) {
        benzinTlText = "Yetersiz veri – kesin değerlendirme yapılamıyor";
      } else if (benzinTlNum !== null) {
        benzinTlText = (benzinTlNum >= 0 ? "+" : "-") + formatZamIndirimValue(Math.abs(benzinTlNum), 2) + " TL/L";
        if (benzinPctNum !== null) {
          benzinPctText = (benzinPctNum >= 0 ? "+" : "-") + formatZamIndirimValue(Math.abs(benzinPctNum), 2) + "%";
        }
      }

      if (ort5MotorinYok) {
        motorinTlText = "Yetersiz veri – kesin değerlendirme yapılamıyor";
      } else if (motorinTlNum !== null) {
        motorinTlText = (motorinTlNum >= 0 ? "+" : "-") + formatZamIndirimValue(Math.abs(motorinTlNum), 2) + " TL/L";
        if (motorinPctNum !== null) {
          motorinPctText = (motorinPctNum >= 0 ? "+" : "-") + formatZamIndirimValue(Math.abs(motorinPctNum), 2) + "%";
        }
      }

      var now = new Date();
      var pad = function(value) { return value < 10 ? ("0" + value) : value; };
      var tarih = pad(now.getDate()) + "." + pad(now.getMonth() + 1) + "." + now.getFullYear();
      var saat = pad(now.getHours()) + ":" + pad(now.getMinutes());

      var lines = [];
      lines.push("Piyasa değerlendirmesi (ANLIK – Kapanış Beklemeden) – " + tarih + " " + saat);
      lines.push("");
      lines.push("Benzin: " + benzinDurum);
      if (ort5BenzinYok) {
        lines.push(benzinTlText);
      } else {
        lines.push("≈ " + benzinTlText + "  |  " + benzinPctText);
      }
      lines.push("");
      lines.push("Motorin: " + motorinDurum);
      if (ort5MotorinYok) {
        lines.push(motorinTlText);
      } else {
        lines.push("≈ " + motorinTlText + "  |  " + motorinPctText);
      }
      var nextBusinessDay = function(startDate) {
        var d = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
        do {
          d.setDate(d.getDate() + 1);
        } while (d.getDay() === 0 || d.getDay() === 6);
        return d;
      };
      var gunAdlari = ["Pazar", "Pazartesi", "Salı", "Çarşamba", "Perşembe", "Cuma", "Cumartesi"];
      var formatDate = function(d) {
        return pad(d.getDate()) + "." + pad(d.getMonth() + 1) + "." + d.getFullYear();
      };
      var formatDateWithDay = function(d) {
        return formatDate(d) + " (" + gunAdlari[d.getDay()] + ")";
      };
      var kararGunu = nextBusinessDay(now);
      var uygulamaGunu = new Date(kararGunu.getFullYear(), kararGunu.getMonth(), kararGunu.getDate() + 1);
      var buildBand = function(tlNum, urunLabel) {
        if (tlNum === null) {
          return null;
        }
        var min = Math.max(0, Math.abs(tlNum) - 0.10);
        var max = Math.abs(tlNum) + 0.10;
        var minText = min.toFixed(2).replace(".", ",");
        var maxText = max.toFixed(2).replace(".", ",");
        return "≈ " + minText + " – " + maxText + " TL/L " + urunLabel + " artışı beklenebilir.";
      };
      var benzinBand = buildBand(benzinTlNum, "benzin");
      var motorinBand = buildBand(motorinTlNum, "motorin");
      if (benzinBand || motorinBand) {
        lines.push("");
        lines.push("Öngörü (tahmini):");
        lines.push("Mevcut gidişat korunursa " + formatDateWithDay(kararGunu) + " günü karar,");
        lines.push(formatDateWithDay(uygulamaGunu) + " 00:00’dan geçerli");
        if (benzinBand) {
          lines.push(benzinBand);
        }
        if (motorinBand) {
          lines.push(motorinBand);
        }
        lines.push("");
      }
      lines.push("Not: Bu değerlendirme anlık verilere göre hazırlanmıştır; 15:30 sonrası kesinleşir, kapanışla değişebilir.");
      lines.push("");
      lines.push("Tayfun Türk");
      lines.push("Uyarı: Kişisel değerlendirmedir, kesinlik içermez; hata/yanılma olabilir.");
      return lines.join("\n");
    }

    function initZamIndirimWhatsappCopy() {
      var btn = document.getElementById("zam-indirim-whatsapp-copy");
      if (!btn) {
        return;
      }
      if (btn.dataset.bound === "1") {
        return;
      }
      btn.dataset.bound = "1";
      btn.addEventListener("click", function() {
        var data = window.zamIndirimPanelData;
        if (!data) {
          return;
        }
        var message = buildZamIndirimWhatsappMessage(data);
        var copyPromise;
        if (navigator && navigator.clipboard && navigator.clipboard.writeText) {
          copyPromise = navigator.clipboard.writeText(message);
        } else {
          var temp = document.createElement("textarea");
          temp.value = message;
          temp.style.position = "fixed";
          temp.style.opacity = "0";
          document.body.appendChild(temp);
          temp.focus();
          temp.select();
          document.execCommand("copy");
          document.body.removeChild(temp);
          copyPromise = Promise.resolve();
        }
        copyPromise.then(function() {
          if (typeof showSuccess === "function") {
            showSuccess("Mesaj kopyalandı");
          } else {
            alert("Mesaj kopyalandı");
          }
        });
      });
    }

    function startInvestingSocket() {
      if (window.investingSocketStarted) {
        return;
      }
      window.investingSocketStarted = true;
      window.investingOilData = { brent: null, wti: null };

      var wsUrl = "wss://streaming.forexpros.com/echo/649/0ys5gq61/websocket";
      var pidBrent = "8833";
      var pidWti = "8849";

      var pendingSubscribe = true;
      function sendInvestingSubscribe(ws) {
        try {
          var subscribeMessage = {
            _event: "bulk-subscribe",
            tzID: 8,
            message: "isOpenExch-NaN:%%pid-19155:%%isOpenExch-49:%%pidExt-19155:%%pid-172:%%isOpenExch-4:%%pidExt-172:%%pid-169:%%isOpenExch-1:%%pidExt-169:%%pid-1175153:%%isOpenExch-152:%%pidExt-1175153:%%pid-178:%%isOpenExch-20:%%pidExt-178:%%pid-27:%%isOpenExch-3:%%pidExt-27:%%pid-8827:%%isOpenExch-1004:%%pidExt-8827:%%pid-18:%%isOpenExch-1002:%%pidExt-18:%%pid-50655:%%pidExt-50655:%%pid-17:%%pidExt-17:%%pid-66:%%pidExt-66:%%pid-1:%%pidExt-1:%%pid-97:%%pidExt-97:%%pid-2:%%pidExt-2:%%pid-166:%%pid-20:%%isOpenExch-2:%%pid-13665:%%isOpenExch-40:%%pid-8830:%%pidExt-8830:%%pid-8836:%%pidExt-8836:%%pid-8833:%%pidExt-8833:%%pid-8849:%%pidExt-8849:%%pid-8851:%%pidExt-8851:%%pid-8831:%%pidExt-8831:%%pid-8910:%%pidExt-8910:%%pid-19581:%%pidExt-19581:%%pid-19412:%%pidExt-19412:%%pid-19454:%%pidExt-19454:%%pid-19294:%%pidExt-19294:%%pid-19394:%%pidExt-19394:%%pid-19522:%%pidExt-19522:%%pid-19430:%%pidExt-19430:%%pid-1197643:%%pid-19556:%%pid-19402:%%pid-1198406:%%pid-19557:%%pid-19483:%%pid-1199483:%%pid-1066607:%%pid-19528:%%pid-19598:%%pid-19386:%%pid-1211837:%%pid-40456:%%pid-6408:%%pid-6369:%%pid-243:%%pid-267:%%pid-7888:%%pid-358:%%pid-402:%%isOpenExch-9:%%pid-3:%%pid-9:%%pid-126:%%isOpenExch-1003:%%cmt-10-5-8833:%%pid-1180255:%%pid-945629:%%pid-1058142:%%pid-1118146:%%pid-1153127:%%pid-1173409:%%pid-1192221:%%pid-1202584:%%pid-399:%%pid-1187186:%%pid-6497:%%pid-8274:%%pid-13969:%%pid-6564:%%pid-10522:%%pid-20610:%%pid-284:%%pid-302:%%pid-376:%%pid-462:%%pid-6974:%%pid-8862:%%pid-1178696:%%pid-1178699:%%pid-1195670:%%pid-1195671:%%pid-1234779:%%pid-1235066:%%pid-1175151:%%pid-8884:"
          };
          var payload = JSON.stringify(subscribeMessage).replace(/\\/g, "\\\\").replace(/\"/g, "\\\"");
          ws.send("a[\"" + payload + "\"]");
          pendingSubscribe = false;
        } catch (error) {
          return;
        }
      }

      function handleMessage(raw, ws) {
        try {
          if (raw === "o" && pendingSubscribe && ws) {
            sendInvestingSubscribe(ws);
            return;
          }
          if (typeof raw === "string" && raw.startsWith("a[")) {
            var arr = JSON.parse(raw.slice(1));
            if (Array.isArray(arr)) {
              arr.forEach(function(entry) { handleMessage(entry, ws); });
            }
            return;
          }
          if (Array.isArray(raw) && raw.length > 0) {
            raw = raw[0];
          }
          if (typeof raw === "string") {
            var outer = JSON.parse(raw);
            if (outer && outer.message && typeof outer.message === "string" && outer.message.indexOf("pid-") === 0) {
              var parts = outer.message.split("::");
              if (parts.length >= 2) {
                var payload = JSON.parse(parts[1]);
                if (payload && payload.pid) {
                  var item = {
                    last: payload.last,
                    pc: payload.pc,
                    pcp: payload.pcp,
                    time: payload.time
                  };
                  if (payload.pid === pidBrent) {
                    window.investingOilData.brent = item;
                  } else if (payload.pid === pidWti) {
                    window.investingOilData.wti = item;
                  }
                  updateFixedArea4Rates();
                }
              }
            }
          }
        } catch (error) {
          return;
        }
      }

      try {
        var ws = new WebSocket(wsUrl);
        ws.onopen = function() {
          setTimeout(function() {
            if (pendingSubscribe) {
              sendInvestingSubscribe(ws);
            }
          }, 500);
        };
        ws.onmessage = function(event) {
          handleMessage(event.data, ws);
        };
        ws.onclose = function() {
          window.investingSocketStarted = false;
          setTimeout(startInvestingSocket, 30000);
        };
      } catch (error) {
        window.investingSocketStarted = false;
      }
    }
    
    // Tab yönetimi - Sadece Operasyon sayfası için test
    var tabStrip = null;
    var ignoreSelectEvent = false; // Tab kapatılırken select event'ini ignore et
    var activeTabIdToKeep = null; // Pasif tab kapatıldığında aktif tab ID'sini korumak için
    
    // Ribbon butonlarını başlat
    // TELERİK NOTIFICATION BİLEŞENİ - Tüm sayfalarda kullanılabilir
    var notification = null;
    
    // Bildirim gösterme fonksiyonları
    function showSuccess(message) {
      if (notification) {
        notification.show(message, "success");
      } else {
        // Fallback: Notification henüz hazır değilse alert kullan
        setTimeout(function() {
          if (notification) {
            notification.show(message, "success");
          } else {
            alert(message);
          }
        }, 100);
      }
    }
    
    function showError(message) {
      if (notification) {
        // Hata mesajları için daha uzun süre göster (5 saniye)
        var errorNotification = notification.show(message, "error");
        setTimeout(function() {
          if (errorNotification && notification) {
            notification.hide(errorNotification);
          }
        }, 5000);
      } else {
        // Fallback: Notification henüz hazır değilse alert kullan
        setTimeout(function() {
          if (notification) {
            var errorNotification = notification.show(message, "error");
            setTimeout(function() {
              if (errorNotification && notification) {
                notification.hide(errorNotification);
              }
            }, 5000);
          } else {
            alert(message);
          }
        }, 100);
      }
    }
    
    function showInfo(message) {
      if (notification) {
        notification.show(message, "info");
      } else {
        // Fallback: Notification henüz hazır değilse alert kullan
        setTimeout(function() {
          if (notification) {
            notification.show(message, "info");
          } else {
            alert(message);
          }
        }, 100);
      }
    }
    
    function showWarning(message) {
      if (notification) {
        // Uyarı mesajları için orta süre göster (4 saniye)
        var warningNotification = notification.show(message, "warning");
        setTimeout(function() {
          if (warningNotification && notification) {
            notification.hide(warningNotification);
          }
        }, 4000);
      } else {
        // Fallback: Notification henüz hazır değilse alert kullan
        setTimeout(function() {
          if (notification) {
            var warningNotification = notification.show(message, "warning");
            setTimeout(function() {
              if (warningNotification && notification) {
                notification.hide(warningNotification);
              }
            }, 4000);
          } else {
            alert(message);
          }
        }, 100);
      }
    }
    
    $(document).ready(function() {
      // Flash sorunu çözümü: Sayfa yüklendiğinde body'ye 'loaded' class'ı ekle
      $('body').addClass('loaded');

      // Tanımlar menüsünü veriden doldur (geçiş hazırlığı)
      renderTanimlarMenuFromData();

      // TELERİK NOTIFICATION BAŞLAT
      if (typeof kendo !== 'undefined' && typeof $.fn.kendoNotification !== 'undefined') {
        try {
          notification = $("#notification").kendoNotification({
            position: { top: 50, right: 50 },
            stacking: "down",
            hideAfter: 3000  // Varsayılan 3 saniye
          }).data("kendoNotification");
          
          // TEST İÇİN: Konsoldan test edebilmek için global fonksiyonlar
          // Tarayıcı konsolunda (F12) şunları yazabilirsiniz:
          // showSuccess("Test başarı mesajı")
          // showError("Test hata mesajı")
          // showWarning("Test uyarı mesajı")
          // showInfo("Test bilgi mesajı")
        } catch(error) {
          console.error("Notification başlatılırken hata:", error);
        }
      }

      // ALAN 1 - Ana Menü Butonları (Telerik Kendo UI Menu)
      var anaMenu = null;
      var enablePetronetMenuStyles = false;
      var allowHoverOpen = false;
      function applyAltMenuFontSize() {
        $("#ana-menu-bar .k-menu-group .k-item, #ana-menu-bar .k-popup .k-item").each(function() {
          this.style.setProperty('font-size', '16px', 'important');
        });
        $("#ana-menu-bar .k-menu-group .k-link, #ana-menu-bar .k-popup .k-link").each(function() {
          this.style.setProperty('font-size', '16px', 'important');
        });
        $("#ana-menu-bar .k-menu-group .k-menu-item-text, #ana-menu-bar .k-popup .k-menu-item-text").each(function() {
          this.style.setProperty('font-size', '16px', 'important');
        });
        $("#ana-menu-bar .k-menu-group span, #ana-menu-bar .k-popup span").each(function() {
          this.style.setProperty('font-size', '16px', 'important');
        });
      }
      function initAnaMenu() {
        if (typeof kendo !== 'undefined' && typeof $.fn.kendoMenu !== 'undefined') {
          try {
            anaMenu = $("#ana-menu-bar").kendoMenu({
              orientation: "horizontal",
              openOnClick: true,
              highlightFirst: false, // COPILOT ÇÖZÜMÜ - Varsayılan hover'ları engelle
              animation: {
                open: {
                  effects: "fadeIn",
                  duration: 150
                },
                close: {
                  effects: "fadeOut",
                  duration: 100
                }
              },
              open: function(e) {
                applyAltMenuFontSize();
                if (!enablePetronetMenuStyles) {
                  return;
                }
                // Menü açıldığında tıklanan butonu koyu mavi yap (#64B5F6)
                var $item = $(e.item);
                $item.addClass('menu-acik');
                $item.css({
                  'background': '#64B5F6 !important',
                  'background-color': '#64B5F6 !important'
                });
                // Diğer tüm ana menü butonlarını açık mavi yap
                $("#ana-menu-bar > li").not($item).css({
                  'background': '#E3F2FD !important',
                  'background-color': '#E3F2FD !important'
                });
                // Alt menü stillerini uygula - daha uzun bekleme
                setTimeout(function() {
                  if (typeof applyPetronetStyles === 'function' && !isApplyingStyles) {
                    applyPetronetStyles();
                  }
                  // Ekstra kontrol - alt menü .k-link'leri zorla düzelt
                  setTimeout(function() {
                    $("#ana-menu-bar .k-menu-group .k-link, #ana-menu-bar .k-popup .k-link").each(function() {
                      this.style.setProperty('font-size', '15px', 'important');
                      this.style.setProperty('font-weight', 'normal', 'important');
                      this.style.setProperty('color', '#333333', 'important');
                      // Varsayılan arka planı transparent yap
                      this.style.setProperty('background', 'transparent', 'important');
                      this.style.setProperty('background-color', 'transparent', 'important');
                    });
                  }, 100);
                  // Telerik kontrolü yap
                  setTimeout(checkTelerikMenuStyles, 300);
                }, 300);
              },
              close: function(e) {
                if (!enablePetronetMenuStyles) {
                  return;
                }
                // Menü kapandığında tüm butonları açık mavi yap
                var $item = $(e.item);
                $item.removeClass('menu-acik');
                $item.css({
                  'background': '#E3F2FD',
                  'background-color': '#E3F2FD'
                });
                // Tüm ana menü butonlarını açık mavi yap
                $("#ana-menu-bar > li").css({
                  'background': '#E3F2FD',
                  'background-color': '#E3F2FD'
                });
                // Stilleri tekrar uygula (sadece bir kez)
                setTimeout(function() {
                  if (typeof applyPetronetStyles === 'function' && !isApplyingStyles) {
                    applyPetronetStyles();
                  }
                }, 150);
                console.log("Menü kapandı:", $item.text());
              },
              select: function(e) {
                var menuText = $(e.item).text().trim();
                console.log("Ana menü tıklandı:", menuText);
                // Alt menü öğelerine tıklama işlemleri
                if (menuText === "Firma Tanımları") {
                  openFirmaTanimlariTab();
                } else if (menuText === "Şube Tanımları") {
                  openSubeTanimlariTab();
                } else if (menuText === "Ürün Tanımları") {
                  openUrunTanimlariWindow();
                } else if (menuText === "Sistem Tanımları") {
                  openSistemTanimlariWindow();
                } else if (menuText === "Kullanıcı Tanımları") {
                  openKullaniciTanimlariWindow();
                } else if (menuText === "Menü Çubuğu Ayarları") {
                  openMenuCubuguAyarlarTab();
                } else if (menuText === "Cari Kartlar" || menuText === "Cari Kart") {
                  // Cari Kart sayfası devre dışı
                } else if (menuText === "Zam/İndirim") {
                  openZamIndirimTab();
                }
              }
            }).data("kendoMenu");
            console.log("✅ Ana menü başarıyla oluşturuldu!");
            setTimeout(applyAltMenuFontSize, 50);

            // Hover ile açma sadece tıklamadan sonra aktif olsun
            $("#ana-menu-bar").on("click", "li.k-item", function(e) {
              if ($(this).closest(".k-menu-group, .k-popup").length > 0) {
                return;
              }
              allowHoverOpen = true;
            });

            $("#ana-menu-bar").on("mouseenter", "li.k-item", function() {
              if (!allowHoverOpen || !anaMenu) {
                return;
              }
              if ($(this).closest(".k-menu-group, .k-popup").length > 0) {
                return;
              }
              var $item = $(this);
              $item.siblings("li.k-item").each(function() {
                anaMenu.close($(this));
              });
              anaMenu.open($item);
            });

            // ALAN 1 dışına tıklanınca hover açma kapansın
            $(document).on("click", function(e) {
              if ($(e.target).closest("#fixed-area-1-container").length === 0) {
                allowHoverOpen = false;
                if (anaMenu) {
                  $("#ana-menu-bar > li.k-item").each(function() {
                    anaMenu.close($(this));
                  });
                }
              }
            });
            
            // Menü oluşturulduktan sonra Petronet görüntüsüne göre tüm stilleri uygula
            var isApplyingStyles = false; // Sonsuz döngü önleme
            var lastApplyTime = 0; // Throttle için
            
            function applyPetronetStyles() {
              if (!enablePetronetMenuStyles) {
                return;
              }
              // Throttle: 300ms içinde tekrar çağrılırsa çık
              var now = Date.now();
              if (now - lastApplyTime < 300) return;
              lastApplyTime = now;
              
              if (isApplyingStyles) return; // Zaten uygulanıyorsa çık
              isApplyingStyles = true;
              
              try {
                // Ana menü container arka planı
                $("#fixed-area-1-container").css({
                  'background': '#E3F2FD',
                  'background-color': '#E3F2FD',
                  'background-image': 'none'
                });
                
                // Ana menü butonları
                $("#ana-menu-bar > li, #ana-menu-bar .k-menu-item, #ana-menu-bar li").each(function() {
                  var $item = $(this);
                  $item.css({
                    'background': '#E3F2FD',
                    'background-color': '#E3F2FD',
                    'padding': '0 12px',
                    'margin': '0',
                    'height': '28px',
                    'line-height': '28px',
                    'font-family': "'Segoe UI', Arial, sans-serif",
                    'border-right': '1px solid #90caf9'
                  });
                  // Ana menü yazı - Telerik .k-link'i zorla override et
                  $item.find('.k-menu-item-text, .k-link, span').css({
                    'font-size': '16px',
                    'font-weight': '600',
                    'font-family': "'Segoe UI', Arial, sans-serif",
                    'color': '#333333',
                    'letter-spacing': '0.3px',
                    'line-height': '28px'
                  });
                  
                  // .k-link'i özellikle hedefle ve zorla uygula
                  var kLink = $item.find('.k-link').first();
                  if (kLink.length > 0) {
                    kLink[0].style.setProperty('font-size', '16px', 'important');
                    kLink[0].style.setProperty('font-weight', '600', 'important');
                    kLink[0].style.setProperty('color', '#333333', 'important');
                    kLink[0].style.setProperty('font-family', "'Segoe UI', Arial, sans-serif", 'important');
                  }
                });
                
                // Alt menü container
                $("#ana-menu-bar .k-menu-group, #ana-menu-bar .k-popup").css({
                  'background': '#D9D9FF',
                  'background-color': '#D9D9FF',
                  'padding': '0'
                });
                
                // Alt menü öğeleri - ayırıcı çizgi YOK, sol tarafta mavi çizgi VAR
                $("#ana-menu-bar .k-menu-group .k-menu-item, #ana-menu-bar .k-popup .k-menu-item, #ana-menu-bar .k-menu-group .k-item").each(function() {
                  var item = this; // DOM elementi
                  var $item = $(this);
                  
                  // Alt menü öğesi padding'i zorla uygula - DOM elementine direkt - DİKEY ORTALANMIŞ
                  item.style.setProperty('padding', '0 20px 0 25px', 'important'); /* Üst ve alt padding 0, sol padding 25px - YAZILAR DAHA SOLDAN BAŞLAR */
                  item.style.setProperty('padding-left', '25px', 'important'); /* Sol padding 25px (20px mavi çizgi + 5px boşluk) */
                  item.style.setProperty('margin', '0', 'important');
                  item.style.setProperty('min-height', '28px', 'important');
                  item.style.setProperty('line-height', '28px', 'important'); /* min-height ile aynı - dikey ortalama için */
                  item.style.setProperty('font-family', "'Segoe UI', Arial, sans-serif", 'important');
                  item.style.setProperty('background', '#D9D9FF', 'important');
                  item.style.setProperty('background-color', '#D9D9FF', 'important');
                  item.style.setProperty('border-bottom', 'none', 'important');
                  item.style.setProperty('border-top', 'none', 'important');
                  item.style.setProperty('position', 'relative', 'important');
                  item.style.setProperty('font-size', '15px', 'important'); // li elementinin font boyutu
                  item.style.setProperty('display', 'flex', 'important'); /* Flexbox ile dikey ortalama */
                  item.style.setProperty('align-items', 'center', 'important'); /* Dikey ortalama */
                  item.style.setProperty('justify-content', 'flex-start', 'important'); /* Sol baştan hizalama */
                  
                  // COPILOT ÇÖZÜMÜ - Runtime inline stillerini kaldır (SADECE background stilleri)
                  $item.off('mouseenter mouseleave').on('mouseenter', function() {
                    var item = this;
                    
                    // SADECE background ile ilgili inline stilleri temizle (padding/margin korunmalı)
                    var currentStyle = item.getAttribute('style') || '';
                    var styleParts = currentStyle.split(';');
                    var newStyleParts = [];
                    for (var i = 0; i < styleParts.length; i++) {
                      var part = styleParts[i].trim();
                      if (part && 
                          !part.toLowerCase().includes('background') && 
                          !part.toLowerCase().includes('box-shadow') &&
                          !part.toLowerCase().includes('border-color')) {
                        newStyleParts.push(part);
                      }
                    }
                    item.setAttribute('style', newStyleParts.join('; '));
                    
                    // Düz sarı-turuncu arka plan uygula
                    item.style.setProperty('background', '#F3E9C9', 'important');
                    item.style.setProperty('background-color', '#F3E9C9', 'important');
                    item.style.setProperty('border-color', '#E5C76B', 'important');
                    item.style.setProperty('background-image', 'none', 'important');
                    item.style.setProperty('box-shadow', 'none', 'important');
                    item.style.setProperty('border', 'none', 'important');
                    
                    // TÜM çocuk elementlerin SADECE background stillerini temizle (padding/margin korunmalı)
                    $(item).find('*').each(function() {
                      // SADECE background stillerini temizle
                      this.style.background = 'transparent';
                      this.style.backgroundColor = 'transparent';
                      this.style.backgroundImage = 'none';
                      this.style.boxShadow = 'none';
                      // padding, margin, position, left, top, width, height gibi değerleri KORU
                    });
                  }).on('mouseleave', function() {
                    var item = this;
                    if (!item.classList.contains('k-state-selected') && 
                        !item.classList.contains('k-state-active')) {
                      // Varsayılan arka plana dön
                      item.style.setProperty('background', '#D9D9FF', 'important');
                      item.style.setProperty('background-color', '#D9D9FF', 'important');
                      item.style.setProperty('border-color', 'transparent', 'important');
                      item.style.setProperty('background-image', 'none', 'important');
                      
                      // Çocuk elementleri transparent yap
                      $(item).find('*').each(function() {
                        this.style.background = 'transparent';
                        this.style.backgroundColor = 'transparent';
                        this.style.backgroundImage = 'none';
                      });
                    }
                  });
                  
                  // Hover durumunu temizle (varsayılan arka planı zorla uygula)
                  if (!item.classList.contains('k-state-hover') && 
                      !item.classList.contains('k-state-selected') && 
                      !item.classList.contains('k-state-active')) {
                    item.style.setProperty('background', '#D9D9FF', 'important');
                    item.style.setProperty('background-color', '#D9D9FF', 'important');
                  }
                  
                  // JavaScript ile eklenen span'leri kaldır (CSS ::before kullanıyoruz)
                  $item.find('span[style*="position:absolute"][style*="left:0"]').remove();
                  
                  // TÜM .k-link elementlerini bul ve zorla uygula - İLK HARFLER ALT ALTA BAŞLAMALI
                  // DİKEY ORTALAMA İÇİN line-height ve display: flex ekle, SOL BAŞTAN HİZALAMA
                  var kLinks = item.querySelectorAll('.k-link');
                  kLinks.forEach(function(kLink) {
                    kLink.style.setProperty('font-size', '15px', 'important');
                    kLink.style.setProperty('font-weight', 'normal', 'important');
                    kLink.style.setProperty('color', '#333333', 'important');
                    kLink.style.setProperty('font-family', "'Segoe UI', Arial, sans-serif", 'important');
                    kLink.style.setProperty('letter-spacing', '0.2px', 'important');
                    kLink.style.setProperty('line-height', '28px', 'important'); /* min-height ile aynı - dikey ortalama için */
                    kLink.style.setProperty('text-align', 'left', 'important'); /* Sol baştan hizalama */
                    // FLEXBOX İLE DİKEY ORTALAMA VE SOL HİZALAMA
                    kLink.style.setProperty('display', 'flex', 'important'); /* Flexbox yapısı */
                    kLink.style.setProperty('align-items', 'center', 'important'); /* Dikey ortalama */
                    kLink.style.setProperty('justify-content', 'flex-start', 'important'); /* Sol baştan hizalama */
                    kLink.style.setProperty('text-align', 'left', 'important'); /* Metin sol hizalama */
                    // İLK HARFLER ALT ALTA BAŞLAMALI - padding ve margin 0
                    kLink.style.setProperty('padding-left', '0', 'important');
                    kLink.style.setProperty('padding-right', '0', 'important');
                    kLink.style.setProperty('padding-top', '0', 'important');
                    kLink.style.setProperty('padding-bottom', '0', 'important');
                    kLink.style.setProperty('margin-left', '0', 'important');
                    kLink.style.setProperty('margin-right', '0', 'important');
                    kLink.style.setProperty('margin-top', '0', 'important');
                    kLink.style.setProperty('margin-bottom', '0', 'important');
                    // Varsayılan arka planı transparent yap (merdiven görünümünü önlemek için)
                    kLink.style.setProperty('background', 'transparent', 'important');
                    kLink.style.setProperty('background-color', 'transparent', 'important');
                    kLink.style.setProperty('background-image', 'none', 'important');
                    
                    // .k-link içindeki TÜM elementlerin padding ve margin'i 0 olmalı
                    var linkChildren = kLink.querySelectorAll('*');
                    linkChildren.forEach(function(child) {
                      child.style.setProperty('padding-left', '0', 'important');
                      child.style.setProperty('padding-right', '0', 'important');
                      child.style.setProperty('margin-left', '0', 'important');
                      child.style.setProperty('margin-right', '0', 'important');
                    });
                  });
                  
                  // .k-menu-item-text için - GRID YAPISI İLE SOL HİZALAMA
                  var menuItemTexts = item.querySelectorAll('.k-menu-item-text');
                  menuItemTexts.forEach(function(text) {
                    text.style.setProperty('padding-left', '0', 'important');
                    text.style.setProperty('padding-right', '0', 'important');
                    text.style.setProperty('margin-left', '0', 'important');
                    text.style.setProperty('margin-right', '0', 'important');
                    text.style.setProperty('text-align', 'left', 'important'); /* Sol baştan hizalama */
                    text.style.setProperty('justify-self', 'start', 'important'); /* Grid içinde sol hizalama */
                    text.style.setProperty('display', 'block', 'important'); /* Block element */
                    text.style.setProperty('width', 'auto', 'important'); /* Otomatik genişlik */
                  });
                  
                  // .k-link içindeki span'ler için de sol hizalama (FLEXBOX UYUMLU)
                  var linkSpans = item.querySelectorAll('.k-link span');
                  linkSpans.forEach(function(span) {
                    span.style.setProperty('text-align', 'left', 'important'); /* Sol baştan hizalama */
                    span.style.setProperty('flex', '0 0 auto', 'important'); /* Flexbox içinde otomatik boyut */
                    span.style.setProperty('align-self', 'flex-start', 'important'); /* Sol baştan hizalama */
                    /* display: block kaldırıldı - flexbox ile uyumlu olmalı */
                  });
                  
                  // Diğer yazı elementleri - SOL BAŞTAN HİZALAMA (FLEXBOX UYUMLU)
                  var spans = item.querySelectorAll('span:not([style*="position"])');
                  spans.forEach(function(span) {
                    if (!span.classList.contains('k-link')) {
                      span.style.setProperty('font-size', '15px', 'important');
                      span.style.setProperty('color', '#333333', 'important');
                      span.style.setProperty('text-align', 'left', 'important'); /* Sol baştan hizalama */
                      /* display: block kaldırıldı - flexbox ile uyumlu olmalı */
                    }
                  });
                });
              } catch(e) {
                console.error("Stil uygulama hatası:", e);
              } finally {
                isApplyingStyles = false;
              }
            }
            
            // İlk uygulama - sadece birkaç kez
            setTimeout(applyPetronetStyles, 300);
            setTimeout(applyPetronetStyles, 800);
            
            // AGRESIF ÇÖZÜM - Telerik'in inline style'larını tamamen temizle ve zorla uygula
            function forceLeftAlignment() {
              // Parent li için - Telerik'in inline style'larını temizle ve zorla uygula
              $('#ana-menu-bar .k-menu-group li.k-item, #ana-menu-bar .k-popup li.k-item').each(function() {
                // Telerik'in inline style'larını tamamen temizle
                this.removeAttribute('style');
                // Zorla flexbox ayarları uygula
                this.style.setProperty('display', 'flex', 'important');
                this.style.setProperty('align-items', 'center', 'important');
                this.style.setProperty('justify-content', 'flex-start', 'important');
                this.style.setProperty('text-align', 'left', 'important');
              });
              
              // .k-link için - Telerik'in inline style'larını temizle ve zorla uygula
              $('#ana-menu-bar .k-menu-group .k-menu-item .k-link, #ana-menu-bar .k-popup .k-menu-item .k-link').each(function() {
                // Telerik'in inline style'larını tamamen temizle
                this.removeAttribute('style');
                // Zorla flexbox ayarları uygula
                this.style.setProperty('display', 'flex', 'important');
                this.style.setProperty('align-items', 'center', 'important');
                this.style.setProperty('justify-content', 'flex-start', 'important');
                this.style.setProperty('text-align', 'left', 'important');
                this.style.setProperty('padding-left', '0', 'important');
                this.style.setProperty('margin-left', '0', 'important');
              });
              
              // .k-menu-item-text için - Telerik'in inline style'larını temizle ve zorla uygula
              $('#ana-menu-bar .k-menu-group .k-menu-item .k-menu-item-text, #ana-menu-bar .k-popup .k-menu-item .k-menu-item-text').each(function() {
                // Telerik'in inline style'larını tamamen temizle
                this.removeAttribute('style');
                // Zorla sol hizalama uygula
                this.style.setProperty('text-align', 'left', 'important');
                this.style.setProperty('margin-left', '0', 'important');
                this.style.setProperty('padding-left', '0', 'important');
                this.style.setProperty('display', 'block', 'important');
                this.style.setProperty('width', 'auto', 'important');
              });
            }
            
            // İlk uygulama
            setTimeout(forceLeftAlignment, 500);
            setTimeout(forceLeftAlignment, 1000);
            setTimeout(forceLeftAlignment, 1500);
            
            // Menü açıldığında da uygula
            if (anaMenu) {
              anaMenu.bind('open', function() {
                setTimeout(forceLeftAlignment, 50);
                setTimeout(forceLeftAlignment, 200);
                setTimeout(forceLeftAlignment, 500);
              });
            }
            
            // Sürekli kontrol et (Telerik'in runtime değişikliklerini yakala)
            setInterval(function() {
              $('#ana-menu-bar .k-menu-group li.k-item').each(function() {
                var justifyContent = window.getComputedStyle(this).justifyContent;
                if (justifyContent !== 'flex-start') {
                  this.style.setProperty('justify-content', 'flex-start', 'important');
                }
              });
              
              $('#ana-menu-bar .k-menu-group .k-menu-item .k-link').each(function() {
                var justifyContent = window.getComputedStyle(this).justifyContent;
                var textAlign = window.getComputedStyle(this).textAlign;
                if (justifyContent !== 'flex-start') {
                  this.style.setProperty('justify-content', 'flex-start', 'important');
                }
                if (textAlign !== 'left') {
                  this.style.setProperty('text-align', 'left', 'important');
                }
              });
              
              $('#ana-menu-bar .k-menu-group .k-menu-item .k-menu-item-text').each(function() {
                var textAlign = window.getComputedStyle(this).textAlign;
                if (textAlign !== 'left') {
                  this.style.setProperty('text-align', 'left', 'important');
                }
              });
            }, 100); // Her 100ms'de bir kontrol et
            
            // Hover rengi sadece üstündeyken kalsın, çıkınca sıfırla
            $("#ana-menu-bar").on("mouseenter", "li.k-item", function() {
              var $item = $(this);
              
              // SADECE background ile ilgili inline stilleri temizle (padding/margin korunmalı)
              var currentStyle = this.getAttribute('style') || '';
              var styleParts = currentStyle.split(';');
              var newStyleParts = [];
              for (var i = 0; i < styleParts.length; i++) {
                var part = styleParts[i].trim();
                if (part && 
                    !part.toLowerCase().includes('background') && 
                    !part.toLowerCase().includes('box-shadow') &&
                    !part.toLowerCase().includes('border-color')) {
                  newStyleParts.push(part);
                }
              }
              this.setAttribute('style', newStyleParts.join('; '));
              
              // Hover rengi uygula
              this.style.setProperty('background', '#F3E9C9', 'important');
              this.style.setProperty('background-color', '#F3E9C9', 'important');
              this.style.setProperty('border-color', '#E5C76B', 'important');
              this.style.setProperty('background-image', 'none', 'important');
              this.style.setProperty('box-shadow', 'none', 'important');
              
              // Çocuk elementlerin arka planını temizle
              $item.find("*").each(function() {
                this.style.background = "transparent";
                this.style.backgroundColor = "transparent";
                this.style.backgroundImage = "none";
                this.style.boxShadow = "none";
              });
            }).on("mouseleave", "li.k-item", function() {
              var $item = $(this);
              // Hover bittiğinde inline arka planı temizle
              this.style.removeProperty('background');
              this.style.removeProperty('background-color');
              this.style.removeProperty('background-image');
              this.style.removeProperty('box-shadow');
              this.style.setProperty('border-color', 'transparent', 'important');
              
              // Çocuk elementlerin inline arka planını temizle
              $item.find("*").each(function() {
                this.style.removeProperty('background');
                this.style.removeProperty('background-color');
                this.style.removeProperty('background-image');
                this.style.removeProperty('box-shadow');
              });
            });
            
            // TELERIK KARŞILAŞTIRMA KONTROLÜ - Fonksiyon olarak tanımla
            function checkTelerikMenuStyles() {
              console.log("\n\n========================================");
              console.log("=== TELERIK MENU KARŞILAŞTIRMA KONTROLÜ ===");
              console.log("========================================\n");
              
              // Ana menü container kontrolü
              var menuBar = document.getElementById('ana-menu-bar');
              if (!menuBar) {
                console.log("❌ #ana-menu-bar bulunamadı!");
                return;
              }
              console.log("✅ #ana-menu-bar bulundu");
              
              // Ana menü öğelerini kontrol et - TÜM YOLLARLA
              var anaMenuItems1 = $("#ana-menu-bar > li");
              var anaMenuItems2 = $("#ana-menu-bar .k-item");
              var anaMenuItems3 = $("#ana-menu-bar .k-menu-item");
              var anaMenuItems4 = $("#ana-menu-bar li");
              
              console.log("\n--- ANA MENÜ KONTROLÜ ---");
              console.log("  - #ana-menu-bar > li sayısı:", anaMenuItems1.length);
              console.log("  - .k-item sayısı:", anaMenuItems2.length);
              console.log("  - .k-menu-item sayısı:", anaMenuItems3.length);
              console.log("  - li sayısı:", anaMenuItems4.length);
              
              var anaMenuItems = anaMenuItems1.length > 0 ? anaMenuItems1 : anaMenuItems4;
              console.log("\n✅ Kullanılan selector ile bulunan öğe sayısı:", anaMenuItems.length);
              
              if (anaMenuItems.length > 0) {
                anaMenuItems.each(function(index) {
                  var $item = $(this);
                  var itemText = $item.text().trim().replace(/\s+/g, ' ').substring(0, 50);
                  var hasKItem = $item.hasClass('k-item');
                  var hasKMenuItem = $item.hasClass('k-menu-item');
                  var kLink = $item.find('.k-link').first();
                  var kLinkText = kLink.length > 0 ? kLink.text().trim() : '';
                  var computedBg = window.getComputedStyle(this).backgroundColor;
                  var computedFontSize = window.getComputedStyle(this).fontSize;
                  var computedColor = window.getComputedStyle(this).color;
                  
                  console.log(`\n  📌 Ana Menü ${index + 1}: "${itemText}"`);
                  console.log("    ✓ k-item class:", hasKItem);
                  console.log("    ✓ k-menu-item class:", hasKMenuItem);
                  console.log("    ✓ .k-link bulundu:", kLink.length > 0);
                  if (kLink.length > 0) {
                    console.log("    ✓ .k-link metni:", kLinkText || "(boş)");
                    var kLinkBg = window.getComputedStyle(kLink[0]).backgroundColor;
                    var kLinkFontSize = window.getComputedStyle(kLink[0]).fontSize;
                    var kLinkColor = window.getComputedStyle(kLink[0]).color;
                    console.log("    ✓ .k-link arka plan:", kLinkBg);
                    console.log("    ✓ .k-link font boyutu:", kLinkFontSize);
                    console.log("    ✓ .k-link yazı rengi:", kLinkColor);
                  }
                  console.log("    ✓ Arka plan rengi:", computedBg);
                  console.log("    ✓ Font boyutu:", computedFontSize);
                  console.log("    ✓ Yazı rengi:", computedColor);
                });
              } else {
                console.log("  ⚠️ Ana menü öğeleri bulunamadı!");
                console.log("  💡 HTML yapısını kontrol edin: $('#ana-menu-bar').html()");
              }
              
              // Alt menü öğelerini kontrol et - TÜM YOLLARLA
              console.log("\n\n--- ALT MENÜ KONTROLÜ ---");
              var altMenuItems1 = $("#ana-menu-bar .k-menu-group .k-menu-item");
              var altMenuItems2 = $("#ana-menu-bar .k-popup .k-menu-item");
              var altMenuItems3 = $("#ana-menu-bar .k-menu-group .k-item");
              var altMenuItems4 = $("#ana-menu-bar .k-popup .k-item");
              
              console.log("  - .k-menu-group .k-menu-item sayısı:", altMenuItems1.length);
              console.log("  - .k-popup .k-menu-item sayısı:", altMenuItems2.length);
              console.log("  - .k-menu-group .k-item sayısı:", altMenuItems3.length);
              console.log("  - .k-popup .k-item sayısı:", altMenuItems4.length);
              
              var altMenuItems = altMenuItems1.length > 0 ? altMenuItems1 : 
                                 altMenuItems2.length > 0 ? altMenuItems2 :
                                 altMenuItems3.length > 0 ? altMenuItems3 : altMenuItems4;
              
              console.log("\nKullanılan selector ile bulunan öğe sayısı:", altMenuItems.length);
              
              if (altMenuItems.length > 0) {
                console.log("\n✅ Alt menü öğeleri bulundu!");
                altMenuItems.each(function(index) {
                  var $item = $(this);
                  var itemText = $item.text().trim().replace(/\s+/g, ' ').substring(0, 50);
                  var kLink = $item.find('.k-link').first();
                  var kLinkText = kLink.length > 0 ? kLink.text().trim() : '';
                  var computedBg = window.getComputedStyle(this).backgroundColor;
                  var computedFontSize = window.getComputedStyle(this).fontSize;
                  var computedPaddingLeft = window.getComputedStyle(this).paddingLeft;
                  var computedColor = window.getComputedStyle(this).color;
                  
                  console.log(`\n  📌 Alt Menü ${index + 1}: "${itemText}"`);
                  console.log("    ✓ .k-link bulundu:", kLink.length > 0);
                  if (kLink.length > 0) {
                    console.log("    ✓ .k-link metni:", kLinkText || "(boş)");
                    var kLinkBg = window.getComputedStyle(kLink[0]).backgroundColor;
                    var kLinkFontSize = window.getComputedStyle(kLink[0]).fontSize;
                    var kLinkColor = window.getComputedStyle(kLink[0]).color;
                    console.log("    ✓ .k-link arka plan:", kLinkBg);
                    console.log("    ✓ .k-link font boyutu:", kLinkFontSize);
                    console.log("    ✓ .k-link yazı rengi:", kLinkColor);
                  }
                  console.log("    ✓ Arka plan rengi:", computedBg);
                  console.log("    ✓ Font boyutu:", computedFontSize);
                  console.log("    ✓ Sol padding:", computedPaddingLeft);
                  console.log("    ✓ Yazı rengi:", computedColor);
                });
              } else {
                console.log("  ⚠️ Alt menü öğeleri bulunamadı!");
                console.log("  💡 İpucu: 'Tanımlar' menüsünü AÇIK tutun ve konsolda şunu yazın:");
                console.log("     checkTelerikMenuStyles()");
              }
              
              // Telerik varsayılan stillerini kontrol et
              console.log("\n\n--- TELERIK VARSAYILAN STİLLER ---");
              var kendoStyles = document.querySelector('link[href*="kendo"]');
              if (kendoStyles) {
                console.log("✅ Telerik CSS yüklendi:", kendoStyles.href);
              } else {
                console.log("⚠️ Telerik CSS bulunamadı!");
              }
              
              console.log("\n========================================");
              console.log("=== KONTROL TAMAMLANDI ===");
              console.log("========================================\n");
            }
            
            // İlk kontrol - sayfa yüklendiğinde
            setTimeout(checkTelerikMenuStyles, 2000);
            
            // Global fonksiyon olarak tanımla - konsoldan çağrılabilir
            window.checkTelerikMenuStyles = checkTelerikMenuStyles;
          } catch(error) {
            console.error("❌ Ana menü oluşturulurken hata:", error);
          }
        } else {
          console.log("⏳ Telerik yükleniyor, ana menü bekleniyor...");
          setTimeout(initAnaMenu, 100);
        }
      }
      initAnaMenu();
      
      // Firma Tanımları Window (boş içerik)
      var firmaTanimlariWindow = null;
      var urunTanimlariWindow = null;
      function initFirmaTanimlariWindow() {
        if (typeof kendo !== 'undefined' && typeof $.fn.kendoWindow !== 'undefined') {
          try {
            firmaTanimlariWindow = $("#firma-tanimlari-window").kendoWindow({
              title: "Firma Tanımları",
              width: "60%",
              height: "60%",
              visible: false,
              modal: false,
              resizable: true,
              draggable: true,
              actions: ["Maximize", "Minimize", "Close"]
            }).data("kendoWindow");
            
            if (typeof $.fn.kendoTextBox !== 'undefined') {
              $("#firma-adi-input").kendoTextBox({
                placeholder: "Firma ismi yazın..."
              });
            }
          } catch (error) {
            console.error("Firma Tanımları Window başlatılırken hata:", error);
          }
        } else {
          setTimeout(initFirmaTanimlariWindow, 100);
        }
      }
      initFirmaTanimlariWindow();

      function initUrunTanimlariWindow() {
        if (typeof kendo !== 'undefined' && typeof $.fn.kendoWindow !== 'undefined') {
          try {
            urunTanimlariWindow = $("#urun-tanimlari-window").kendoWindow({
              title: "Ürün Tanımları",
              width: "60%",
              height: "60%",
              visible: false,
              modal: false,
              resizable: true,
              draggable: true,
              actions: ["Maximize", "Minimize", "Close"]
            }).data("kendoWindow");
            
            if (typeof $.fn.kendoTextBox !== 'undefined') {
              $("#urun-adi-input").kendoTextBox({
                placeholder: "Ürün ismi yazın..."
              });
            }
          } catch (error) {
            console.error("Ürün Tanımları Window başlatılırken hata:", error);
          }
        } else {
          setTimeout(initUrunTanimlariWindow, 100);
        }
      }
      initUrunTanimlariWindow();


      function isWindowOpen(win) {
        return !!(win && win.wrapper && win.wrapper.is(":visible"));
      }

      function openWindowCascade(win) {
        if (!win) {
          return;
        }

        win.open();
        win.center();

        var openCount = 0;
        if (isWindowOpen(firmaTanimlariWindow)) {
          openCount += 1;
        }
        if (isWindowOpen(urunTanimlariWindow)) {
          openCount += 1;
        }
        if (openCount > 1) {
          var offset = (openCount - 1) * 30;
          var wrapper = win.wrapper;
          var top = parseInt(wrapper.css("top"), 10) || 0;
          var left = parseInt(wrapper.css("left"), 10) || 0;
          var maxTop = $(window).height() - wrapper.outerHeight() - 10;
          var maxLeft = $(window).width() - wrapper.outerWidth() - 10;

          top = Math.max(10, Math.min(top + offset, maxTop));
          left = Math.max(10, Math.min(left + offset, maxLeft));

          wrapper.css({ top: top + "px", left: left + "px" });
        }
      }

      function openFirmaTanimlariWindow() {
        if (!firmaTanimlariWindow) {
          initFirmaTanimlariWindow();
          return;
        }
        openWindowCascade(firmaTanimlariWindow);
      }
      
      function openUrunTanimlariWindow() {
        if (!urunTanimlariWindow) {
          initUrunTanimlariWindow();
          return;
        }
        openWindowCascade(urunTanimlariWindow);
      }

      // Ribbon butonlarını oluştur (ALAN 2)
      loadRibbonButtons();

      updateFixedArea4DateTime();
      setInterval(updateFixedArea4DateTime, 1000);
      updateFixedArea4Rates();
      setInterval(updateFixedArea4Rates, 60000);
      startInvestingSocket();

      // Telerik TabStrip başlat (ALAN 3) - Sadece operasyon için
      if (typeof kendo !== 'undefined' && typeof $.fn.kendoTabStrip !== 'undefined') {
        tabStrip = $("#tabs").kendoTabStrip({
          animation: false,
          tabPosition: "top",
          select: function(e) {
            // Tab kapatılırken select event'ini ignore et
            if (ignoreSelectEvent) {
              console.log("Select event ignore edildi (tab kapatılıyor)");
              
              // Eğer aktif tab korunması gerekiyorsa koru
              if (activeTabIdToKeep) {
                console.log("Aktif tab korunuyor (select event içinde):", activeTabIdToKeep);
                showPageOnly(activeTabIdToKeep);
                activeTabIdToKeep = null; // Temizle
                ignoreSelectEvent = false; // Flag'i kapat
                return;
              }
              
              ignoreSelectEvent = false; // Flag'i kapat
              return;
            }
            
            // Tab'a tıklayınca sayfayı göster
            var tabItem = $(e.item);
            var tabId = tabItem.attr("data-tab-id");
            var tabText = tabItem.text() || tabItem.html() || "";
            
            console.log("Tab tıklandı, tabId:", tabId, "tabText:", tabText);
            
            // data-tab-id yoksa tabText'ten bul
            if (!tabId) {
              if (tabText.indexOf("Operasyon") >= 0) {
                tabId = "operasyon";
              } else if (tabText.indexOf("Kredi Kartı") >= 0 || tabText.indexOf("Kredi") >= 0) {
                tabId = "kredi-karti";
              } else if (tabText.indexOf("Cari Kart") >= 0) {
                tabId = "cari-kart";
            } else if (tabText.indexOf("Firma") >= 0) {
                tabId = "firma-tanimlari";
            } else if (tabText.indexOf("Şube") >= 0) {
              tabId = "sube-karti";
              } else if (tabText.indexOf("Banka") >= 0) {
                tabId = "banka";
              } else if (tabText.indexOf("Tanker") >= 0) {
                tabId = "tanker";
              } else if (tabText.indexOf("Fiyat") >= 0) {
                tabId = "fiyat-degisimi";
              } else if (tabText.indexOf("Menü Çubuğu") >= 0 || tabText.indexOf("Menu Cubugu") >= 0) {
                tabId = "menu-cubugu-ayarlari";
              }
            }
            
            if (tabId) {
              console.log("Sayfa gösteriliyor:", tabId);
              showPageOnly(tabId);
            } else {
              console.log("Tab ID bulunamadı!");
            }
          }
        }).data("kendoTabStrip");
        
      }
      
      // X butonlarına event delegation (dinamik elementler için)
      $(document).on("click", ".tab-close-operasyon", function(e) {
        e.stopPropagation();
        e.preventDefault();
        console.log("Operasyon X butonuna tıklandı!");
        closeOperasyonTab();
      });
      
      $(document).on("click", ".tab-close-kredi-karti", function(e) {
        e.stopPropagation();
        e.preventDefault();
        console.log("Kredi Kartı X butonuna tıklandı!");
        closeKrediKartiTab();
      });
      
      $(document).on("click", ".tab-close-cari-kart", function(e) {
        e.stopPropagation();
        e.preventDefault();
        console.log("Cari Kart X butonuna tıklandı!");
        closeCariKartTab();
      });

      $(document).on("click", ".tab-close-firma-tanimlari", function(e) {
        e.stopPropagation();
        e.preventDefault();
        console.log("Firma Tanımları X butonuna tıklandı!");
        closeFirmaTanimlariTab();
      });

      $(document).on("click", ".tab-close-sube-karti", function(e) {
        e.stopPropagation();
        e.preventDefault();
        console.log("Şube Kartı X butonuna tıklandı!");
        closeSubeKartiTab();
      });

      $(document).on("click", ".tab-close-sube-tanimlari", function(e) {
        e.stopPropagation();
        e.preventDefault();
        console.log("Şube Tanımları X butonuna tıklandı!");
        closeSubeTanimlariTab();
      });
      
      $(document).on("click", ".tab-close-banka", function(e) {
        e.stopPropagation();
        e.preventDefault();
        console.log("Banka X butonuna tıklandı!");
        closeBankaTab();
      });
      
      $(document).on("click", ".tab-close-tanker", function(e) {
        e.stopPropagation();
        e.preventDefault();
        console.log("Tanker X butonuna tıklandı!");
        closeTankerTab();
      });
      
      $(document).on("click", ".tab-close-fiyat-degisimi", function(e) {
        e.stopPropagation();
        e.preventDefault();
        console.log("Fiyat Değişimi X butonuna tıklandı!");
        closeFiyatDegisimiTab();
      });

      $(document).on("click", ".tab-close-zam-indirim", function(e) {
        e.stopPropagation();
        e.preventDefault();
        console.log("Zam/İndirim X butonuna tıklandı!");
        closeZamIndirimTab();
      });
      
      $(document).on("click", ".tab-close-menu-cubugu-ayarlari", function(e) {
        e.stopPropagation();
        e.preventDefault();
        console.log("Menü Çubuğu Ayarları X butonuna tıklandı!");
        closeMenuCubuguAyarlarTab();
      });

      $(document).on("click", "#firma-tanimlari-right-buttons .exit-button", function(e) {
        e.preventDefault();
        e.stopPropagation();
        closeFirmaTanimlariTab();
      });
    });
    
    var menuCubuguAyarStorageKey = "menu_cubugu_ayarlari_v1";

    function getDefaultRibbonItems() {
      return [];
    }

    function getSavedRibbonItems() {
      try {
        var raw = localStorage.getItem(menuCubuguAyarStorageKey);
        if (!raw) {
          return null;
        }
        var parsed = JSON.parse(raw);
        if (Array.isArray(parsed) && parsed.length > 0) {
          return parsed;
        }
      } catch (error) {
        console.warn("Ribbon ayarları okunamadı:", error);
      }
      return null;
    }

    function findAnySavedRibbonItems() {
      try {
        for (var i = 0; i < localStorage.length; i++) {
          var key = localStorage.key(i);
          if (!key || key.indexOf("menu_cubugu_ayarlari") === -1) {
            continue;
          }
          var raw = localStorage.getItem(key);
          if (!raw) {
            continue;
          }
          var parsed = JSON.parse(raw);
          if (Array.isArray(parsed) && parsed.length > 0) {
            return { items: parsed, key: key };
          }
        }
      } catch (error) {
        return null;
      }
      return null;
    }

    function saveRibbonItems(items) {
      try {
        localStorage.setItem(menuCubuguAyarStorageKey, JSON.stringify(items || []));
      } catch (error) {
        console.warn("Ribbon ayarları kaydedilemedi:", error);
      }
    }

    function getRibbonItemsForRender() {
      var saved = getSavedRibbonItems();
      if (saved && saved.length > 0) {
        return saved;
      }
      return getDefaultRibbonItems();
    }

    // Ribbon butonlarını oluştur (tüm sayfalarda kullanılabilir) - Telerik Button ile
    function loadRibbonButtons() {
      // Önce mevcut butonları temizle
      $("#ribbon-buttons").empty();

      var itemsToRender = getRibbonItemsForRender();
      itemsToRender.forEach(function(item) {
        var pageName = (item.name || '').toString();
        var baslik = (item.baslik || '').toString();

        if (!pageName) {
          return;
        }

        // Yazıları kısa tut, uzunsa kısalt
        if (baslik.length > 12) {
          baslik = baslik.substring(0, 10) + '...';
        }

        // Telerik Button için HTML oluştur
        var buttonId = 'ribbon-btn-' + pageName;
        var buttonHtml = '<button id="' + buttonId + '" class="k-button k-button-md ribbon-button" data-page="' + pageName + '" style="display:flex;flex-direction:column;align-items:center;justify-content:center;padding:4px 6px;min-width:70px;max-width:70px;height:70px;">' +
          '<span style="font-size:32px;margin-bottom:2px;line-height:1;">' + (item.icon || '⬜') + '</span>' +
          '<span style="text-align:center;font-size:12px;line-height:1.1;max-width:65px;word-wrap:break-word;">' + baslik + '</span>' +
          '</button>';

        $("#ribbon-buttons").append(buttonHtml);

        // Telerik Button'ı başlat (sadece görsel)
        if (typeof kendo !== 'undefined' && typeof $.fn.kendoButton !== 'undefined') {
          $("#" + buttonId).kendoButton();
        }
      });
    }

    var menuAyarPageInitialized = false;
    var menuAyarTreeView = null;
    var menuAyarListBox = null;
    var menuAyarIconDropDown = null;
    var menuAyarWindow = null;
    var menuAyarLastTreeItem = null;
    var menuAyarEscBound = false;

    function getMenuAyarIconByName(name, fallback) {
      if (!Array.isArray(menuItems)) {
        return fallback || "⬜";
      }
      var found = menuItems.find(function(item) {
        return (item.name || "") === name;
      });
      return (found && found.icon) ? found.icon : (fallback || "⬜");
    }

    function buildMenuAyarTreeData() {
      return [
        {
          text: "Tanımlar",
          expanded: true,
          items: [
            { text: "Firma Tanımları", name: "firma_tanimlari", icon: "🏢" },
            { text: "Şube Tanımları", name: "sube_tanimlari", icon: "🏬" },
            { text: "Ürün Tanımları", name: "urun_tanimlari", icon: "📦" },
            { text: "Whatsapp Tanımları", name: "whatsapp_tanimlari", icon: "💬" },
            { text: "Sistem Tanımları", name: "sistem_tanimlari", icon: "⚙️" },
            { text: "Kullanıcı Tanımları", name: "kullanici_tanimlari", icon: "👤" }
          ]
        },
        {
          text: "Operasyon",
          expanded: true,
          items: [
            { text: "Operasyon", name: "operasyon_sayfasi", icon: "⛽" },
            { text: "Zam/İndirim", name: "zam-indirim", icon: "📈" }
          ]
        },
      ];
    }

    function getMenuAyarIconOptions() {
      var options = [];
      var seen = {};
      if (Array.isArray(menuItems)) {
        menuItems.forEach(function(item) {
          if (!item || !item.icon) {
            return;
          }
          var iconValue = item.icon.toString();
          if (!seen[iconValue]) {
            options.push({ text: iconValue + " " + (item.baslik || ""), value: iconValue });
            seen[iconValue] = true;
          }
        });
      }

      var defaultIcons = ["⛽", "🏢", "🏬", "📦", "💬", "⚙️", "👤", "📌", "✅"];
      defaultIcons.forEach(function(iconValue) {
        if (!seen[iconValue]) {
          options.push({ text: iconValue + " Seçim", value: iconValue });
          seen[iconValue] = true;
        }
      });

      return options;
    }

    function getMenuAyarSelectedItems() {
      var saved = getSavedRibbonItems();
      if (saved && saved.length > 0) {
        return saved;
      }
      var fallback = findAnySavedRibbonItems();
      if (fallback && fallback.items) {
        localStorage.setItem(menuCubuguAyarStorageKey, JSON.stringify(fallback.items));
        return fallback.items;
      }
      return getDefaultRibbonItems();
    }

    function refreshMenuAyarSelectedList() {
      if (!menuAyarListBox) {
        return;
      }
      var items = getMenuAyarSelectedItems();
      menuAyarListBox.dataSource.data(items);
      menuAyarListBox.refresh();
      if (menuAyarIconDropDown) {
        menuAyarIconDropDown.value("");
      }
    }

    function initMenuCubuguAyarlarPage() {
      var container = $("#main-content-menu-cubugu-ayarlari");
      if (!container.length || typeof kendo === "undefined") {
        $("#menu-cubugu-ayarlari-window").css("display", "block");
        return;
      }

      if (!menuAyarWindow) {
        menuAyarWindow = $("#menu-cubugu-ayarlari-window").kendoWindow({
          title: "Menü Çubuğunu Ayarla",
          width: "860px",
          height: "540px",
          modal: false,
          visible: false,
          resizable: false,
          draggable: true,
          actions: ["Close"],
          close: function() {
            closeMenuCubuguAyarlarTab();
          }
        }).data("kendoWindow");
      }

      menuAyarWindow.center().open();

      if (!menuAyarPageInitialized) {
        setTimeout(function() {
          try {
            if (!$("#menu-ayar-splitter").data("kendoSplitter")) {
              $("#menu-ayar-splitter").kendoSplitter({
                panes: [
                  { size: "35%", collapsible: false },
                  { size: "10%", collapsible: false },
                  { size: "55%", collapsible: false }
                ]
              });
            }

            menuAyarTreeView = $("#menu-ayar-tree").kendoTreeView({
              dataSource: buildMenuAyarTreeData(),
              dataTextField: "text",
              select: function(e) {
                var item = this.dataItem(e.node);
                menuAyarLastTreeItem = item || null;
              }
            }).data("kendoTreeView");

            menuAyarListBox = $("#menu-ayar-selected-list").kendoListBox({
              dataSource: new kendo.data.DataSource({ data: [] }),
              dataTextField: "baslik",
              dataValueField: "name",
              selectable: "single",
              template: function(dataItem) {
                return '<span style="font-size:18px;margin-right:6px;">' + (dataItem.icon || "⬜") + '</span>' +
                  '<span>' + (dataItem.baslik || "") + '</span>';
              },
              change: function() {
                var selected = this.dataItem(this.select());
                if (menuAyarIconDropDown) {
                  menuAyarIconDropDown.value(selected ? (selected.icon || "") : "");
                }
              }
            }).data("kendoListBox");

            menuAyarIconDropDown = $("#menu-ayar-icon-select").kendoDropDownList({
              dataTextField: "text",
              dataValueField: "value",
              optionLabel: "İkon seç",
              dataSource: getMenuAyarIconOptions()
            }).data("kendoDropDownList");

            function addSelectedMenuAyarItem() {
              if (!menuAyarTreeView || !menuAyarListBox) {
                return;
              }
              var selectedNode = menuAyarTreeView.select();
              var dataItem = null;
              if (selectedNode && selectedNode.length > 0) {
                dataItem = menuAyarTreeView.dataItem(selectedNode);
              }
              if (!dataItem && menuAyarLastTreeItem) {
                dataItem = menuAyarLastTreeItem;
              }
              if (!dataItem) {
                return;
              }
              var name = dataItem.name || (typeof dataItem.get === "function" ? dataItem.get("name") : "");
              var text = dataItem.text || (typeof dataItem.get === "function" ? dataItem.get("text") : "");
              var icon = dataItem.icon || (typeof dataItem.get === "function" ? dataItem.get("icon") : "");
              var hasChild = false;
              if (typeof dataItem.hasChildren === "function") {
                hasChild = dataItem.hasChildren();
              } else {
                hasChild = !!dataItem.hasChildren;
              }
              if (!name || hasChild) {
                return;
              }
              var existing = null;
              var currentItems = menuAyarListBox.dataSource.data();
              for (var i = 0; i < currentItems.length; i++) {
                if (currentItems[i].name === name) {
                  existing = currentItems[i];
                  break;
                }
              }
              if (existing) {
                return;
              }
              menuAyarListBox.dataSource.add({
                name: name,
                baslik: text,
                icon: icon || "⬜"
              });
              menuAyarListBox.refresh();
            }

            $("#menu-ayar-add").kendoButton().click(addSelectedMenuAyarItem);
            $("#menu-ayar-tree").on("click", ".k-in", function() {
              var item = menuAyarTreeView.dataItem($(this).closest(".k-item"));
              menuAyarLastTreeItem = item || null;
            });
            $("#menu-ayar-tree").on("dblclick", ".k-in", function() {
              var item = menuAyarTreeView.dataItem($(this).closest(".k-item"));
              menuAyarLastTreeItem = item || null;
              addSelectedMenuAyarItem();
            });

            $("#menu-ayar-remove").kendoButton().click(function() {
              if (!menuAyarListBox) {
                return;
              }
              var selected = menuAyarListBox.select();
              var dataItem = menuAyarListBox.dataItem(selected);
              if (dataItem) {
                menuAyarListBox.dataSource.remove(dataItem);
              }
            });

            $("#menu-ayar-up").kendoButton().click(function() {
              if (!menuAyarListBox) {
                return;
              }
              var selected = menuAyarListBox.select();
              var dataItem = menuAyarListBox.dataItem(selected);
              if (!dataItem) {
                return;
              }
              var data = menuAyarListBox.dataSource.data();
              var index = data.indexOf(dataItem);
              if (index > 0) {
                data.splice(index, 1);
                data.splice(index - 1, 0, dataItem);
                menuAyarListBox.dataSource.data(data);
                menuAyarListBox.select(menuAyarListBox.items().eq(index - 1));
              }
            });

            $("#menu-ayar-down").kendoButton().click(function() {
              if (!menuAyarListBox) {
                return;
              }
              var selected = menuAyarListBox.select();
              var dataItem = menuAyarListBox.dataItem(selected);
              if (!dataItem) {
                return;
              }
              var data = menuAyarListBox.dataSource.data();
              var index = data.indexOf(dataItem);
              if (index >= 0 && index < data.length - 1) {
                data.splice(index, 1);
                data.splice(index + 1, 0, dataItem);
                menuAyarListBox.dataSource.data(data);
                menuAyarListBox.select(menuAyarListBox.items().eq(index + 1));
              }
            });

            $("#menu-ayar-icon-apply").kendoButton().click(function() {
              if (!menuAyarListBox || !menuAyarIconDropDown) {
                return;
              }
              var selected = menuAyarListBox.select();
              var dataItem = menuAyarListBox.dataItem(selected);
              var newIcon = menuAyarIconDropDown.value();
              if (dataItem && newIcon) {
                dataItem.set("icon", newIcon);
                menuAyarListBox.refresh();
              }
            });

            $("#menu-ayar-save").kendoButton().click(function() {
              if (!menuAyarListBox) {
                return;
              }
              var items = menuAyarListBox.dataSource.data().toJSON();
              saveRibbonItems(items);
              loadRibbonButtons();
            });

            $("#menu-ayar-exit").kendoButton().click(function() {
              closeMenuCubuguAyarlarTab();
            });

            menuAyarPageInitialized = true;
            refreshMenuAyarSelectedList();
          } catch (error) {
            console.error("Menü ayarları ekranı başlatılamadı:", error);
          }
        }, 0);
      }
      if (menuAyarPageInitialized) {
        refreshMenuAyarSelectedList();
      }

      if (!menuAyarEscBound) {
        menuAyarEscBound = true;
        $(document).on("keydown.menuAyarEsc", function(e) {
          if (e.key === "Escape" || e.keyCode === 27) {
            if (menuAyarWindow && menuAyarWindow.wrapper && menuAyarWindow.wrapper.is(":visible")) {
              closeMenuCubuguAyarlarTab();
            }
          }
        });
      }
    }
    
    // Tab yönetimi fonksiyonları temizlendi - Baştan yazılacak
    
    // Aktif ribbon butonunu ayarlama fonksiyonu - Telerik Button için
    function setActiveRibbonButton(pageName) {
      $('button[data-page]').each(function() {
        var page = $(this).data('page');
        var button = $(this).data('kendoButton');
        if (pageName && page === pageName) {
          $(this).addClass('k-state-active');
          $(this).css({
            'background': 'rgba(255,255,255,0.8)',
            'border': '1px solid #808080',
            'box-shadow': 'inset 0 0 2px rgba(0,0,0,0.1)'
          });
        } else {
          $(this).removeClass('k-state-active');
          $(this).css({
            'background': '',
            'border': '',
            'box-shadow': ''
          });
        }
      });
    }
    
    // Aktif tab ID'sini bul
    function getActiveTabId() {
      var activeTab = tabStrip.select();
      if (!activeTab) return null;
      
      var activeTabElement = $(activeTab);
      var activeTabId = activeTabElement.attr("data-tab-id");
      var activeTabText = activeTabElement.text() || activeTabElement.html() || "";
      
      if (!activeTabId) {
        if (activeTabText.indexOf("Operasyon") >= 0) {
          activeTabId = "operasyon";
        } else if (activeTabText.indexOf("Kredi Kartı") >= 0 || activeTabText.indexOf("Kredi") >= 0) {
          activeTabId = "kredi-karti";
        } else if (activeTabText.indexOf("Cari Kart") >= 0) {
          activeTabId = "cari-kart";
        } else if (activeTabText.indexOf("Şube Tanımları") >= 0) {
          activeTabId = "sube-tanimlari";
        } else if (activeTabText.indexOf("Şube Kartı") >= 0) {
          activeTabId = "sube-karti";
        } else if (activeTabText.indexOf("Banka") >= 0) {
          activeTabId = "banka";
        } else if (activeTabText.indexOf("Tanker") >= 0) {
          activeTabId = "tanker";
        } else if (activeTabText.indexOf("Fiyat") >= 0) {
          activeTabId = "fiyat-degisimi";
        } else if (activeTabText.indexOf("Menü Çubuğu") >= 0 || activeTabText.indexOf("Menu Cubugu") >= 0) {
          activeTabId = "menu-cubugu-ayarlari";
        }
      }
      
      return activeTabId;
    }
    
    // Tab ID'sine göre tab index'ini bul (GitHub çözümü)
    function getTabIndexById(tabId) {
      var items = tabStrip.items();
      var index = -1;
      for (var i = 0; i < items.length; i++) {
        var tab = $(items[i]);
        var currentTabId = tab.attr("data-tab-id");
        var tabText = tab.text() || tab.html() || "";
        
        // data-tab-id yoksa tabText'ten bul
        if (!currentTabId) {
          if (tabText.indexOf("Operasyon") >= 0) {
            currentTabId = "operasyon";
          } else if (tabText.indexOf("Kredi Kartı") >= 0 || tabText.indexOf("Kredi") >= 0) {
            currentTabId = "kredi-karti";
          } else if (tabText.indexOf("Cari Kart") >= 0) {
            currentTabId = "cari-kart";
        } else if (tabText.indexOf("Şube Tanımları") >= 0) {
          currentTabId = "sube-tanimlari";
        } else if (tabText.indexOf("Şube Kartı") >= 0) {
          currentTabId = "sube-karti";
        } else if (tabText.indexOf("Banka") >= 0) {
            currentTabId = "banka";
          } else if (tabText.indexOf("Tanker") >= 0) {
            currentTabId = "tanker";
          } else if (tabText.indexOf("Fiyat") >= 0) {
            currentTabId = "fiyat-degisimi";
          } else if (tabText.indexOf("Menü Çubuğu") >= 0 || tabText.indexOf("Menu Cubugu") >= 0) {
            currentTabId = "menu-cubugu-ayarlari";
          }
        }
        
        if (currentTabId === tabId) {
          index = i;
          break;
        }
      }
      return index;
    }
    
    // Tab kapatıldığında solundaki tab'ı bul ve göster
    function showNextTabAfterClose(closedTabIndex, wasActiveTab) {
      setTimeout(function() {
        var remainingTabs = tabStrip.items();
        var remainingTabsCount = remainingTabs.length;
        console.log("Kalan tab sayısı:", remainingTabsCount, "Kapatılan tab index:", closedTabIndex, "Aktif tab mıydı:", wasActiveTab);
        
        if (remainingTabsCount === 0) {
          // Hiç tab kalmadı → Lobiye dön
          console.log("Tüm tab'lar kapandı, lobiye dönülüyor...");
          showPageOnly(null);
          setActiveRibbonButton(null);
        } else {
          // Aktif tab kapatıldıysa → Solundaki tab'ı göster
          // Aktif olmayan tab kapatıldıysa → Aktif tab'ı koru (sayfa değişmesin)
          if (wasActiveTab) {
            // Aktif tab kapatıldı → Solundaki tab'ı aktif yap
            var nextTabIndex;
            if (closedTabIndex > 0) {
              // Solunda tab var → Solundaki tab'ı göster
              nextTabIndex = closedTabIndex - 1;
            } else {
              // En soldaki tab kapatıldı → En soldaki tab'ı göster (şimdi index 0)
              nextTabIndex = 0;
            }
            
            // Index sınırlarını kontrol et
            if (nextTabIndex >= remainingTabsCount) {
              nextTabIndex = remainingTabsCount - 1;
            }
            
            var nextTab = remainingTabs[nextTabIndex];
            
            if (nextTab) {
              var nextTabElement = $(nextTab);
              var nextTabId = nextTabElement.attr("data-tab-id");
              var nextTabText = nextTabElement.text() || nextTabElement.html() || "";
              
              // data-tab-id yoksa tabText'ten bul
              if (!nextTabId) {
                if (nextTabText.indexOf("Operasyon") >= 0) {
                  nextTabId = "operasyon";
                } else if (nextTabText.indexOf("Kredi Kartı") >= 0 || nextTabText.indexOf("Kredi") >= 0) {
                  nextTabId = "kredi-karti";
                } else if (nextTabText.indexOf("Cari Kart") >= 0) {
                  nextTabId = "cari-kart";
                } else if (nextTabText.indexOf("Banka") >= 0) {
                  nextTabId = "banka";
                } else if (nextTabText.indexOf("Tanker") >= 0) {
                  nextTabId = "tanker";
                } else if (nextTabText.indexOf("Fiyat") >= 0) {
                  nextTabId = "fiyat-degisimi";
                } else if (nextTabText.indexOf("Menü Çubuğu") >= 0 || nextTabText.indexOf("Menu Cubugu") >= 0) {
                  nextTabId = "menu-cubugu-ayarlari";
                }
              }
              
              if (nextTabId) {
                console.log("Aktif tab kapatıldı, solundaki tab gösteriliyor:", nextTabId, "Index:", nextTabIndex);
                // Aktif tab kapatıldığında select event'ini ignore et (çünkü manuel olarak select yapıyoruz)
                ignoreSelectEvent = true;
                tabStrip.select(nextTabIndex);
                showPageOnly(nextTabId);
                ignoreSelectEvent = false;
              } else {
                console.log("Solundaki tab ID bulunamadı, lobiye dönülüyor...");
                showPageOnly(null);
              }
            } else {
              console.log("Solundaki tab bulunamadı, lobiye dönülüyor...");
              showPageOnly(null);
            }
          } else {
            // Aktif olmayan tab kapatıldı → Aktif tab'ı koru, sayfa değişmesin
            console.log("Aktif olmayan tab kapatıldı, aktif tab korunuyor...");
            var currentActiveTab = tabStrip.select();
            var remainingTabsArray = tabStrip.items();
            var currentActiveTabIndex = -1;
            for (var j = 0; j < remainingTabsArray.length; j++) {
              if ($(remainingTabsArray[j])[0] === $(currentActiveTab)[0]) {
                currentActiveTabIndex = j;
                break;
              }
            }
            
            if (currentActiveTabIndex >= 0 && currentActiveTabIndex < remainingTabsCount) {
              var activeTabElement = $(currentActiveTab);
              var activeTabId = activeTabElement.attr("data-tab-id");
              var activeTabText = activeTabElement.text() || activeTabElement.html() || "";
              
              // data-tab-id yoksa tabText'ten bul
              if (!activeTabId) {
                if (activeTabText.indexOf("Operasyon") >= 0) {
                  activeTabId = "operasyon";
                } else if (activeTabText.indexOf("Kredi Kartı") >= 0 || activeTabText.indexOf("Kredi") >= 0) {
                  activeTabId = "kredi-karti";
                } else if (activeTabText.indexOf("Cari Kart") >= 0) {
                  activeTabId = "cari-kart";
                } else if (activeTabText.indexOf("Banka") >= 0) {
                  activeTabId = "banka";
                } else if (activeTabText.indexOf("Tanker") >= 0) {
                  activeTabId = "tanker";
                } else if (activeTabText.indexOf("Fiyat") >= 0) {
                  activeTabId = "fiyat-degisimi";
                } else if (activeTabText.indexOf("Menü Çubuğu") >= 0 || activeTabText.indexOf("Menu Cubugu") >= 0) {
                  activeTabId = "menu-cubugu-ayarlari";
                }
              }
              
              if (activeTabId) {
                console.log("Aktif tab korunuyor:", activeTabId);
                showPageOnly(activeTabId);
              }
            }
          }
          
          setActiveRibbonButton(null);
        }
        
        // Flag'i her zaman sıfırla (işlem bittikten sonra)
        ignoreSelectEvent = false;
      }, 50);
    }
    
    // Tüm sayfaları gizle, sadece belirtilen sayfayı göster
    function showPageOnly(pageId) {
      // Body class'larını temizle
      $('body').removeClass('operasyon-sayfasi-acik kredi-karti-sayfasi-acik cari-kart-sayfasi-acik firma-tanimlari-sayfasi-acik sube-tanimlari-sayfasi-acik sube-karti-sayfasi-acik banka-sayfasi-acik tanker-sayfasi-acik fiyat-degisimi-sayfasi-acik zam-indirim-sayfasi-acik menu-cubugu-ayarlari-sayfasi-acik');
      
      // Tüm sayfaları gizle
      $('#main-content-operasyon').hide();
      $('#main-content-kredi-karti').hide();
      $('#main-content-cari-kart').hide();
      $('#main-content-firma-tanimlari').hide();
      $('#main-content-sube-tanimlari').hide();
      $('#main-content-banka').hide();
      $('#main-content-sube-karti').hide();
      $('#main-content-tanker').hide();
      $('#main-content-fiyat-degisimi').hide();
      $('#main-content-zam-indirim').hide();
      $('#main-content-menu-cubugu-ayarlari').hide();
      
      // Belirtilen sayfayı göster
      if (pageId === 'operasyon') {
        $('body').addClass('operasyon-sayfasi-acik');
        $('#main-content-operasyon').show();
        $('#title-bar').hide();
      } else if (pageId === 'kredi-karti') {
        $('body').addClass('kredi-karti-sayfasi-acik');
        $('#main-content-kredi-karti').show();
        $('#title-bar').hide();
      } else if (pageId === 'cari-kart') {
        $('body').addClass('cari-kart-sayfasi-acik');
        $('#main-content-cari-kart').show();
        $('#title-bar').hide();
      } else if (pageId === 'firma-tanimlari') {
        $('body').addClass('firma-tanimlari-sayfasi-acik');
        $('#main-content-firma-tanimlari').show();
        $('#title-bar').hide();
        if (window.initFirmaTanimlariGrid) {
          setTimeout(function() { window.initFirmaTanimlariGrid(true); }, 0);
        }
      } else if (pageId === 'sube-tanimlari') {
        $('body').addClass('sube-tanimlari-sayfasi-acik');
        $('#main-content-sube-tanimlari').show();
        $('#title-bar').hide();
        if (window.initSubeTanimlariGrid) {
          setTimeout(function() { window.initSubeTanimlariGrid(true); }, 0);
        }
      } else if (pageId === 'sube-karti') {
        $('body').addClass('sube-karti-sayfasi-acik');
        $('#main-content-sube-karti').show();
        $('#title-bar').hide();
        if (window.updateSubeKartiView) {
          setTimeout(window.updateSubeKartiView, 0);
        }
      } else if (pageId === 'banka') {
        $('body').addClass('banka-sayfasi-acik');
        $('#main-content-banka').show();
        $('#title-bar').hide();
      } else if (pageId === 'tanker') {
        $('body').addClass('tanker-sayfasi-acik');
        $('#main-content-tanker').show();
        $('#title-bar').hide();
      } else if (pageId === 'fiyat-degisimi') {
        $('body').addClass('fiyat-degisimi-sayfasi-acik');
        $('#main-content-fiyat-degisimi').show();
        $('#title-bar').hide();
      } else if (pageId === 'zam-indirim') {
        $('body').addClass('zam-indirim-sayfasi-acik');
        $('#main-content-zam-indirim').show();
        $('#title-bar').hide();
      } else if (pageId === 'menu-cubugu-ayarlari') {
        $('body').addClass('menu-cubugu-ayarlari-sayfasi-acik');
        $('#main-content-menu-cubugu-ayarlari').show();
        $('#title-bar').hide();
      } else {
        // Hiçbir sayfa açık değilse lobi göster
        $('#title-bar').show();
      }
    }
    
    // Sadece Operasyon sayfası için basit tab mantığı
    function openOperasyonTab() {
      if (!tabStrip) {
        console.error("TabStrip başlatılmamış!");
        return;
      }
      
      // Tab zaten var mı kontrol et - Tüm tab'ları kontrol et
      var allTabs = tabStrip.items();
      var operasyonTabIndex = -1;
      
      for (var i = 0; i < allTabs.length; i++) {
        var tab = $(allTabs[i]);
        var tabId = tab.attr("data-tab-id");
        var tabText = tab.text() || tab.html() || "";
        
        // data-tab-id veya içerikte "Operasyon" kelimesi varsa
        if (tabId === "operasyon" || tabText.indexOf("Operasyon") >= 0) {
          operasyonTabIndex = i;
          break;
        }
      }
      
      // Tab zaten varsa sadece aktif yap
      if (operasyonTabIndex >= 0) {
        console.log("Operasyon tab'ı zaten var, aktif yapılıyor...");
        tabStrip.select(operasyonTabIndex);
        showPageOnly('operasyon');
        return;
      }
      
      // Yeni tab ekle
      console.log("Yeni operasyon tab'ı ekleniyor...");
      
      // ÖNCE sayfayı göster (tab eklenmeden önce)
      showPageOnly('operasyon');
      
      var tabContent = '⛽ Operasyon Sayfası <span class="tab-close-operasyon" style="margin-left:6px;cursor:pointer;padding:2px 4px;border-radius:4px;font-weight:bold;">×</span>';
      
      tabStrip.append({
        text: tabContent,
        content: '<div></div>',
        encoded: false
      });
      
      // Tab elementine data-tab-id ekle
      setTimeout(function() {
        var allTabsArray = tabStrip.items();
        var addedTab = allTabsArray[allTabsArray.length - 1];
        $(addedTab).attr("data-tab-id", "operasyon");
        
        // Event delegation zaten document ready'de tanımlı, burada ekstra bir şey yapmaya gerek yok
        
        // Tab'ı aktif yap
        var tabIndex = allTabsArray.length - 1;
        if (tabIndex >= 0) {
          tabStrip.select(tabIndex);
        }
      }, 100);
    }
    
    // Operasyon tab'ını kapat
    function closeOperasyonTab() {
      console.log("closeOperasyonTab çağrıldı");
      if (!tabStrip) {
        console.error("TabStrip yok!");
        return;
      }
      
      // Tab'ı bul ve kapat
      var allTabs = tabStrip.items();
      var operasyonTabIndex = -1;
      
      for (var i = 0; i < allTabs.length; i++) {
        var tab = $(allTabs[i]);
        var tabId = tab.attr("data-tab-id");
        var tabText = tab.text() || tab.html() || "";
        
        if (tabId === "operasyon" || tabText.indexOf("Operasyon") >= 0) {
          operasyonTabIndex = i;
          break;
        }
      }
      
      // Kapatılmadan önce aktif tab mı kontrol et ve aktif tab ID'sini kaydet
      var activeTab = tabStrip.select();
      var allTabsArray = tabStrip.items();
      var activeTabIndex = -1;
      for (var j = 0; j < allTabsArray.length; j++) {
        if ($(allTabsArray[j])[0] === $(activeTab)[0]) {
          activeTabIndex = j;
          break;
        }
      }
      var wasActiveTab = (operasyonTabIndex >= 0 && operasyonTabIndex === activeTabIndex);
      
      if (operasyonTabIndex < 0) {
        console.log("Operasyon tab'ı bulunamadı!");
        return;
      }
      
      // Pasif tab kapatılıyorsa aktif tab ID'sini kaydet
      if (!wasActiveTab) {
        activeTabIdToKeep = getActiveTabId();
        ignoreSelectEvent = true; // Select event'ini ignore et
        console.log("Pasif tab kapatılıyor, aktif tab korunacak:", activeTabIdToKeep);
      }
      
      // GitHub çözümü: setTimeout ile remove() çağrısını ertele
      setTimeout(function() {
        try {
          console.log("Operasyon tab'ı kapatılıyor... Index:", operasyonTabIndex, "Aktif tab mı:", wasActiveTab);
          tabStrip.remove(operasyonTabIndex);
          console.log("Tab kapatıldı, kalan tab sayısı:", tabStrip.items().length);
          
          // Pasif tab kapatıldıysa aktif tab'ı manuel olarak tekrar seç
          if (!wasActiveTab && activeTabIdToKeep) {
            var desiredTabIndex = getTabIndexById(activeTabIdToKeep);
            if (desiredTabIndex >= 0) {
              console.log("Aktif tab manuel olarak tekrar seçiliyor:", activeTabIdToKeep, "Index:", desiredTabIndex);
              ignoreSelectEvent = true; // Manuel seçim sırasında select event'ini ignore et
              tabStrip.select(desiredTabIndex);
              showPageOnly(activeTabIdToKeep);
              ignoreSelectEvent = false;
              activeTabIdToKeep = null;
            }
          } else if (wasActiveTab) {
            // Aktif tab kapatıldıysa solundaki tab'ı göster
            showNextTabAfterClose(operasyonTabIndex, wasActiveTab);
          }
        } catch(error) {
          console.error("Tab kapatılırken hata:", error);
          ignoreSelectEvent = false;
          activeTabIdToKeep = null;
        }
      }, 0);
    }

    // Zam/İndirim tab'ını aç - Operasyon kodlarının birebir aynısı
    function openZamIndirimTab() {
      if (!tabStrip) {
        console.error("TabStrip başlatılmamış!");
        return;
      }
      
      // Tab zaten var mı kontrol et - Tüm tab'ları kontrol et
      var allTabs = tabStrip.items();
      var zamIndirimTabIndex = -1;
      
      for (var i = 0; i < allTabs.length; i++) {
        var tab = $(allTabs[i]);
        var tabId = tab.attr("data-tab-id");
        var tabText = tab.text() || tab.html() || "";
        
        // data-tab-id veya içerikte "Zam/İndirim" kelimesi varsa
        if (tabId === "zam-indirim" || tabText.indexOf("Zam/İndirim") >= 0) {
          zamIndirimTabIndex = i;
          break;
        }
      }
      
      // Tab zaten varsa sadece aktif yap
      if (zamIndirimTabIndex >= 0) {
        console.log("Zam/İndirim tab'ı zaten var, aktif yapılıyor...");
        tabStrip.select(zamIndirimTabIndex);
        showPageOnly('zam-indirim');
        if (typeof loadZamIndirimForm === "function") {
          setTimeout(loadZamIndirimForm, 0);
        }
        if (typeof initZamIndirimWhatsappCopy === "function") {
          setTimeout(initZamIndirimWhatsappCopy, 0);
        }
        return;
      }
      
      // Yeni tab ekle
      console.log("Yeni Zam/İndirim tab'ı ekleniyor...");
      
      // ÖNCE sayfayı göster (tab eklenmeden önce)
      showPageOnly('zam-indirim');
      if (typeof loadZamIndirimForm === "function") {
        setTimeout(loadZamIndirimForm, 0);
      }
      if (typeof initZamIndirimWhatsappCopy === "function") {
        setTimeout(initZamIndirimWhatsappCopy, 0);
      }
      
      var tabContent = 'Zam/İndirim <span class="tab-close-zam-indirim" style="margin-left:6px;cursor:pointer;padding:2px 4px;border-radius:4px;font-weight:bold;">×</span>';
      
      tabStrip.append({
        text: tabContent,
        content: '<div></div>',
        encoded: false
      });
      
      // Tab elementine data-tab-id ekle
      setTimeout(function() {
        var allTabsArray = tabStrip.items();
        var addedTab = allTabsArray[allTabsArray.length - 1];
        $(addedTab).attr("data-tab-id", "zam-indirim");
        
        // Tab'ı aktif yap
        var tabIndex = allTabsArray.length - 1;
        if (tabIndex >= 0) {
          tabStrip.select(tabIndex);
        }
      }, 100);
    }
    
    // Zam/İndirim tab'ını kapat - Operasyon kodlarının birebir aynısı
    function closeZamIndirimTab() {
      console.log("closeZamIndirimTab çağrıldı");
      if (!tabStrip) {
        console.error("TabStrip yok!");
        return;
      }
      
      // Tab'ı bul ve kapat
      var allTabs = tabStrip.items();
      var zamIndirimTabIndex = -1;
      
      for (var i = 0; i < allTabs.length; i++) {
        var tab = $(allTabs[i]);
        var tabId = tab.attr("data-tab-id");
        var tabText = tab.text() || tab.html() || "";
        
        if (tabId === "zam-indirim" || tabText.indexOf("Zam/İndirim") >= 0) {
          zamIndirimTabIndex = i;
          break;
        }
      }
      
      // Kapatılmadan önce aktif tab mı kontrol et ve aktif tab ID'sini kaydet
      var activeTab = tabStrip.select();
      var allTabsArray = tabStrip.items();
      var activeTabIndex = -1;
      for (var j = 0; j < allTabsArray.length; j++) {
        if ($(allTabsArray[j])[0] === $(activeTab)[0]) {
          activeTabIndex = j;
          break;
        }
      }
      var wasActiveTab = (zamIndirimTabIndex >= 0 && zamIndirimTabIndex === activeTabIndex);
      
      if (zamIndirimTabIndex < 0) {
        console.log("Zam/İndirim tab'ı bulunamadı!");
        return;
      }
      
      // Pasif tab kapatılıyorsa aktif tab ID'sini kaydet
      if (!wasActiveTab) {
        activeTabIdToKeep = getActiveTabId();
        ignoreSelectEvent = true; // Select event'ini ignore et
        console.log("Pasif tab kapatılıyor, aktif tab korunacak:", activeTabIdToKeep);
      }
      
      // GitHub çözümü: setTimeout ile remove() çağrısını ertele
      setTimeout(function() {
        try {
          console.log("Zam/İndirim tab'ı kapatılıyor... Index:", zamIndirimTabIndex, "Aktif tab mı:", wasActiveTab);
          tabStrip.remove(zamIndirimTabIndex);
          console.log("Tab kapatıldı, kalan tab sayısı:", tabStrip.items().length);
          
          // Pasif tab kapatıldıysa aktif tab'ı manuel olarak tekrar seç
          if (!wasActiveTab && activeTabIdToKeep) {
            var desiredTabIndex = getTabIndexById(activeTabIdToKeep);
            if (desiredTabIndex >= 0) {
              console.log("Aktif tab manuel olarak tekrar seçiliyor:", activeTabIdToKeep, "Index:", desiredTabIndex);
              ignoreSelectEvent = true; // Manuel seçim sırasında select event'ini ignore et
              tabStrip.select(desiredTabIndex);
              showPageOnly(activeTabIdToKeep);
              ignoreSelectEvent = false;
              activeTabIdToKeep = null;
            }
          } else if (wasActiveTab) {
            // Aktif tab kapatıldıysa solundaki tab'ı göster
            showNextTabAfterClose(zamIndirimTabIndex, wasActiveTab);
          }
        } catch(error) {
          console.error("Tab kapatılırken hata:", error);
          ignoreSelectEvent = false;
          activeTabIdToKeep = null;
        }
      }, 0);
    }
    
    // Kredi kartı tab'ını aç - Operasyon kodlarının birebir aynısı
    function openKrediKartiTab() {
      if (!tabStrip) {
        console.error("TabStrip başlatılmamış!");
        return;
      }
      
      // Tab zaten var mı kontrol et - Tüm tab'ları kontrol et
      var allTabs = tabStrip.items();
      var krediKartiTabIndex = -1;
      
      for (var i = 0; i < allTabs.length; i++) {
        var tab = $(allTabs[i]);
        var tabId = tab.attr("data-tab-id");
        var tabText = tab.text() || tab.html() || "";
        
        // data-tab-id veya içerikte "Kredi Kartı" kelimesi varsa
        if (tabId === "kredi-karti" || tabText.indexOf("Kredi Kartı") >= 0) {
          krediKartiTabIndex = i;
          break;
        }
      }
      
      // Tab zaten varsa sadece aktif yap
      if (krediKartiTabIndex >= 0) {
        console.log("Kredi Kartı tab'ı zaten var, aktif yapılıyor...");
        tabStrip.select(krediKartiTabIndex);
        showPageOnly('kredi-karti');
        return;
      }
      
      // Yeni tab ekle
      console.log("Yeni kredi kartı tab'ı ekleniyor...");
      
      // ÖNCE sayfayı göster (tab eklenmeden önce)
      showPageOnly('kredi-karti');
      
      var tabContent = '💳 Kredi Kartı <span class="tab-close-kredi-karti" style="margin-left:6px;cursor:pointer;padding:2px 4px;border-radius:4px;font-weight:bold;">×</span>';
      
      tabStrip.append({
        text: tabContent,
        content: '<div></div>',
        encoded: false
      });
      
      // Tab elementine data-tab-id ekle
      setTimeout(function() {
        var allTabsArray = tabStrip.items();
        var addedTab = allTabsArray[allTabsArray.length - 1];
        $(addedTab).attr("data-tab-id", "kredi-karti");
        
        // Event delegation zaten document ready'de tanımlı, burada ekstra bir şey yapmaya gerek yok
        
        // Tab'ı aktif yap
        var tabIndex = allTabsArray.length - 1;
        if (tabIndex >= 0) {
          tabStrip.select(tabIndex);
        }
      }, 100);
    }
    
    // Kredi kartı tab'ını kapat - Operasyon kodlarının birebir aynısı
    function closeKrediKartiTab() {
      console.log("closeKrediKartiTab çağrıldı");
      if (!tabStrip) {
        console.error("TabStrip yok!");
        return;
      }
      
      // Tab'ı bul ve kapat
      var allTabs = tabStrip.items();
      var krediKartiTabIndex = -1;
      
      for (var i = 0; i < allTabs.length; i++) {
        var tab = $(allTabs[i]);
        var tabId = tab.attr("data-tab-id");
        var tabText = tab.text() || tab.html() || "";
        
        if (tabId === "kredi-karti" || tabText.indexOf("Kredi Kartı") >= 0) {
          krediKartiTabIndex = i;
          break;
        }
      }
      
      // Kapatılmadan önce aktif tab mı kontrol et ve aktif tab ID'sini kaydet
      var activeTab = tabStrip.select();
      var allTabsArray = tabStrip.items();
      var activeTabIndex = -1;
      for (var j = 0; j < allTabsArray.length; j++) {
        if ($(allTabsArray[j])[0] === $(activeTab)[0]) {
          activeTabIndex = j;
          break;
        }
      }
      var wasActiveTab = (krediKartiTabIndex >= 0 && krediKartiTabIndex === activeTabIndex);
      
      if (krediKartiTabIndex < 0) {
        console.log("Kredi Kartı tab'ı bulunamadı!");
        return;
      }
      
      // Pasif tab kapatılıyorsa aktif tab ID'sini kaydet
      if (!wasActiveTab) {
        activeTabIdToKeep = getActiveTabId();
        ignoreSelectEvent = true;
        console.log("Pasif tab kapatılıyor, aktif tab korunacak:", activeTabIdToKeep);
      }
      
      // GitHub çözümü: setTimeout ile remove() çağrısını ertele
      setTimeout(function() {
        try {
          console.log("Kredi Kartı tab'ı kapatılıyor... Index:", krediKartiTabIndex, "Aktif tab mı:", wasActiveTab);
          tabStrip.remove(krediKartiTabIndex);
          
          // Pasif tab kapatıldıysa aktif tab'ı manuel olarak tekrar seç
          if (!wasActiveTab && activeTabIdToKeep) {
            var desiredTabIndex = getTabIndexById(activeTabIdToKeep);
            if (desiredTabIndex >= 0) {
              console.log("Aktif tab manuel olarak tekrar seçiliyor:", activeTabIdToKeep, "Index:", desiredTabIndex);
              ignoreSelectEvent = true;
              tabStrip.select(desiredTabIndex);
              showPageOnly(activeTabIdToKeep);
              ignoreSelectEvent = false;
              activeTabIdToKeep = null;
            }
          } else if (wasActiveTab) {
            showNextTabAfterClose(krediKartiTabIndex, wasActiveTab);
          }
        } catch(error) {
          console.error("Tab kapatılırken hata:", error);
          ignoreSelectEvent = false;
          activeTabIdToKeep = null;
        }
      }, 0);
    }
    
    // Cari kart tab'ını aç - Operasyon kodlarının birebir aynısı
    function openCariKartTab() {
      if (!tabStrip) {
        console.error("TabStrip başlatılmamış!");
        return;
      }
      
      var allTabs = tabStrip.items();
      var cariKartTabIndex = -1;
      
      for (var i = 0; i < allTabs.length; i++) {
        var tab = $(allTabs[i]);
        var tabId = tab.attr("data-tab-id");
        var tabText = tab.text() || tab.html() || "";
        
        if (tabId === "cari-kart" || tabText.indexOf("Cari Kart") >= 0) {
          cariKartTabIndex = i;
          break;
        }
      }
      
      if (cariKartTabIndex >= 0) {
        console.log("Cari Kart tab'ı zaten var, aktif yapılıyor...");
        tabStrip.select(cariKartTabIndex);
        showPageOnly('cari-kart');
        return;
      }
      
      console.log("Yeni cari kart tab'ı ekleniyor...");
      showPageOnly('cari-kart');
      
      var tabContent = '👤 Cari Kartlar <span class="tab-close-cari-kart" style="margin-left:6px;cursor:pointer;padding:2px 4px;border-radius:4px;font-weight:bold;">×</span>';
      
      tabStrip.append({
        text: tabContent,
        content: '<div></div>',
        encoded: false
      });
      
      setTimeout(function() {
        var allTabsArray = tabStrip.items();
        var addedTab = allTabsArray[allTabsArray.length - 1];
        $(addedTab).attr("data-tab-id", "cari-kart");
        var tabIndex = allTabsArray.length - 1;
        if (tabIndex >= 0) {
          tabStrip.select(tabIndex);
        }
      }, 100);
    }
    
    // Cari kart tab'ını kapat - Operasyon kodlarının birebir aynısı
    function closeCariKartTab() {
      console.log("closeCariKartTab çağrıldı");
      if (!tabStrip) {
        console.error("TabStrip yok!");
        return;
      }
      
      var allTabs = tabStrip.items();
      var cariKartTabIndex = -1;
      
      for (var i = 0; i < allTabs.length; i++) {
        var tab = $(allTabs[i]);
        var tabId = tab.attr("data-tab-id");
        var tabText = tab.text() || tab.html() || "";
        
        if (tabId === "cari-kart" || tabText.indexOf("Cari Kart") >= 0) {
          cariKartTabIndex = i;
          break;
        }
      }
      
      var activeTab = tabStrip.select();
      var allTabsArray = tabStrip.items();
      var activeTabIndex = -1;
      for (var j = 0; j < allTabsArray.length; j++) {
        if ($(allTabsArray[j])[0] === $(activeTab)[0]) {
          activeTabIndex = j;
          break;
        }
      }
      var wasActiveTab = (cariKartTabIndex >= 0 && cariKartTabIndex === activeTabIndex);
      
      if (cariKartTabIndex < 0) {
        console.log("Cari Kart tab'ı bulunamadı!");
        return;
      }
      
      if (!wasActiveTab) {
        activeTabIdToKeep = getActiveTabId();
        ignoreSelectEvent = true;
        console.log("Pasif tab kapatılıyor, aktif tab korunacak:", activeTabIdToKeep);
      }
      
      setTimeout(function() {
        try {
          console.log("Cari Kart tab'ı kapatılıyor... Index:", cariKartTabIndex, "Aktif tab mı:", wasActiveTab);
          tabStrip.remove(cariKartTabIndex);
          
          if (!wasActiveTab && activeTabIdToKeep) {
            var desiredTabIndex = getTabIndexById(activeTabIdToKeep);
            if (desiredTabIndex >= 0) {
              console.log("Aktif tab manuel olarak tekrar seçiliyor:", activeTabIdToKeep, "Index:", desiredTabIndex);
              ignoreSelectEvent = true;
              tabStrip.select(desiredTabIndex);
              showPageOnly(activeTabIdToKeep);
              ignoreSelectEvent = false;
              activeTabIdToKeep = null;
            }
          } else if (wasActiveTab) {
            showNextTabAfterClose(cariKartTabIndex, wasActiveTab);
          }
        } catch (error) {
          console.error("Tab kapatılırken hata:", error);
          ignoreSelectEvent = false;
          activeTabIdToKeep = null;
        }
      }, 0);
    }

    function ensureFirmaTanimlariGrid() {
      if (typeof window.initFirmaTanimlariGrid !== "function") {
        return;
      }
      setTimeout(function() {
        window.initFirmaTanimlariGrid(true);
        var grid = $("#firma-tanimlari-grid").data("kendoGrid");
        if (grid) {
          grid.resize();
          grid.dataSource.read();
        }
      }, 200);
    }

    // Firma Tanımları tab'ını aç
    function openFirmaTanimlariTab() {
      if (!tabStrip) {
        console.error("TabStrip başlatılmamış!");
        return;
      }
      
      var allTabs = tabStrip.items();
      var firmaTabIndex = -1;
      
      for (var i = 0; i < allTabs.length; i++) {
        var tab = $(allTabs[i]);
        var tabId = tab.attr("data-tab-id");
        var tabText = tab.text() || tab.html() || "";
        
        if (tabId === "firma-tanimlari" || tabText.indexOf("Firma") >= 0) {
          firmaTabIndex = i;
          break;
        }
      }
      
      if (firmaTabIndex >= 0) {
        console.log("Firma Tanımları tab'ı zaten var, aktif yapılıyor...");
        tabStrip.select(firmaTabIndex);
        showPageOnly('firma-tanimlari');
        ensureFirmaTanimlariGrid();
        return;
      }
      
      console.log("Yeni firma tanımları tab'ı ekleniyor...");
      showPageOnly('firma-tanimlari');
      
      var tabContent = '🏢 Firma Tanımları <span class="tab-close-firma-tanimlari" style="margin-left:6px;cursor:pointer;padding:2px 4px;border-radius:4px;font-weight:bold;">×</span>';
      
      tabStrip.append({
        text: tabContent,
        content: '<div></div>',
        encoded: false
      });
      
      setTimeout(function() {
        var allTabsArray = tabStrip.items();
        var addedTab = allTabsArray[allTabsArray.length - 1];
        $(addedTab).attr("data-tab-id", "firma-tanimlari");
        var tabIndex = allTabsArray.length - 1;
        if (tabIndex >= 0) {
          tabStrip.select(tabIndex);
        }
        ensureFirmaTanimlariGrid();
      }, 100);
    }

    // Firma Tanımları tab'ını kapat
    function closeFirmaTanimlariTab() {
      console.log("closeFirmaTanimlariTab çağrıldı");
      if (!tabStrip) {
        console.error("TabStrip yok!");
        return;
      }
      
      var allTabs = tabStrip.items();
      var firmaTabIndex = -1;
      
      for (var i = 0; i < allTabs.length; i++) {
        var tab = $(allTabs[i]);
        var tabId = tab.attr("data-tab-id");
        var tabText = tab.text() || tab.html() || "";
        
        if (tabId === "firma-tanimlari" || tabText.indexOf("Firma") >= 0) {
          firmaTabIndex = i;
          break;
        }
      }
      
      var activeTab = tabStrip.select();
      var allTabsArray = tabStrip.items();
      var activeTabIndex = -1;
      for (var j = 0; j < allTabsArray.length; j++) {
        if ($(allTabsArray[j])[0] === $(activeTab)[0]) {
          activeTabIndex = j;
          break;
        }
      }
      var wasActiveTab = (firmaTabIndex >= 0 && firmaTabIndex === activeTabIndex);
      
      if (firmaTabIndex < 0) {
        console.log("Firma Tanımları tab'ı bulunamadı!");
        return;
      }
      
      if (!wasActiveTab) {
        activeTabIdToKeep = getActiveTabId();
        ignoreSelectEvent = true;
        console.log("Pasif tab kapatılıyor, aktif tab korunacak:", activeTabIdToKeep);
      }
      
      setTimeout(function() {
        try {
          console.log("Firma Tanımları tab'ı kapatılıyor... Index:", firmaTabIndex, "Aktif tab mı:", wasActiveTab);
          tabStrip.remove(firmaTabIndex);
          
          if (!wasActiveTab && activeTabIdToKeep) {
            var desiredTabIndex = getTabIndexById(activeTabIdToKeep);
            if (desiredTabIndex >= 0) {
              console.log("Aktif tab manuel olarak tekrar seçiliyor:", activeTabIdToKeep, "Index:", desiredTabIndex);
              ignoreSelectEvent = true;
              tabStrip.select(desiredTabIndex);
              showPageOnly(activeTabIdToKeep);
              ignoreSelectEvent = false;
              activeTabIdToKeep = null;
            }
          } else if (wasActiveTab) {
            showNextTabAfterClose(firmaTabIndex, wasActiveTab);
          }
        } catch(error) {
          console.error("Tab kapatılırken hata:", error);
          ignoreSelectEvent = false;
          activeTabIdToKeep = null;
        }
      }, 0);
    }

    // Şube Tanımları tab'ını aç
    function openSubeTanimlariTab() {
      if (!tabStrip) {
        console.error("TabStrip başlatılmamış!");
        return;
      }

      var allTabs = tabStrip.items();
      var subeTanimTabIndex = -1;

      for (var i = 0; i < allTabs.length; i++) {
        var tab = $(allTabs[i]);
        var tabId = tab.attr("data-tab-id");
        var tabText = tab.text() || tab.html() || "";

        if (tabId === "sube-tanimlari" || tabText.indexOf("Şube Tanımları") >= 0) {
          subeTanimTabIndex = i;
          break;
        }
      }

      if (subeTanimTabIndex >= 0) {
        console.log("Şube Tanımları tab'ı zaten var, aktif yapılıyor...");
        tabStrip.select(subeTanimTabIndex);
        showPageOnly('sube-tanimlari');
        return;
      }

      console.log("Yeni Şube Tanımları tab'ı ekleniyor...");
      showPageOnly('sube-tanimlari');

      var tabContent = '🏢 Şube Tanımları <span class="tab-close-sube-tanimlari" style="margin-left:6px;cursor:pointer;padding:2px 4px;border-radius:4px;font-weight:bold;">×</span>';

      tabStrip.append({
        text: tabContent,
        content: '<div></div>',
        encoded: false
      });

      setTimeout(function() {
        var allTabsArray = tabStrip.items();
        var addedTab = allTabsArray[allTabsArray.length - 1];
        $(addedTab).attr("data-tab-id", "sube-tanimlari");
        var tabIndex = allTabsArray.length - 1;
        if (tabIndex >= 0) {
          tabStrip.select(tabIndex);
        }
      }, 100);
    }

    // Şube Tanımları tab'ını kapat
    function closeSubeTanimlariTab() {
      console.log("closeSubeTanimlariTab çağrıldı");
      if (!tabStrip) {
        console.error("TabStrip yok!");
        return;
      }

      var allTabs = tabStrip.items();
      var subeTanimTabIndex = -1;

      for (var i = 0; i < allTabs.length; i++) {
        var tab = $(allTabs[i]);
        var tabId = tab.attr("data-tab-id");
        var tabText = tab.text() || tab.html() || "";

        if (tabId === "sube-tanimlari" || tabText.indexOf("Şube Tanımları") >= 0) {
          subeTanimTabIndex = i;
          break;
        }
      }

      var activeTab = tabStrip.select();
      var allTabsArray = tabStrip.items();
      var activeTabIndex = -1;
      for (var j = 0; j < allTabsArray.length; j++) {
        if ($(allTabsArray[j])[0] === $(activeTab)[0]) {
          activeTabIndex = j;
          break;
        }
      }
      var wasActiveTab = (subeTanimTabIndex >= 0 && subeTanimTabIndex === activeTabIndex);

      if (subeTanimTabIndex < 0) {
        console.log("Şube Tanımları tab'ı bulunamadı!");
        return;
      }

      if (!wasActiveTab) {
        activeTabIdToKeep = getActiveTabId();
        ignoreSelectEvent = true;
        console.log("Pasif tab kapatılıyor, aktif tab korunacak:", activeTabIdToKeep);
      }

      setTimeout(function() {
        try {
          console.log("Şube Tanımları tab'ı kapatılıyor... Index:", subeTanimTabIndex, "Aktif tab mı:", wasActiveTab);
          tabStrip.remove(subeTanimTabIndex);

          if (!wasActiveTab && activeTabIdToKeep) {
            var desiredTabIndex = getTabIndexById(activeTabIdToKeep);
            if (desiredTabIndex >= 0) {
              console.log("Aktif tab manuel olarak tekrar seçiliyor:", activeTabIdToKeep, "Index:", desiredTabIndex);
              ignoreSelectEvent = true;
              tabStrip.select(desiredTabIndex);
              showPageOnly(activeTabIdToKeep);
              ignoreSelectEvent = false;
              activeTabIdToKeep = null;
            }
          } else if (wasActiveTab) {
            showNextTabAfterClose(subeTanimTabIndex, wasActiveTab);
          }
        } catch (error) {
          console.error("Tab kapatılırken hata:", error);
          ignoreSelectEvent = false;
          activeTabIdToKeep = null;
        }
      }, 0);
    }

    // Menü Çubuğu Ayarları tab'ını aç
    function openMenuCubuguAyarlarTab() {
      if (!tabStrip) {
        console.error("TabStrip başlatılmamış!");
        return;
      }

      var allTabs = tabStrip.items();
      var menuAyarTabIndex = -1;

      for (var i = 0; i < allTabs.length; i++) {
        var tab = $(allTabs[i]);
        var tabId = tab.attr("data-tab-id");
        var tabText = tab.text() || tab.html() || "";

        if (tabId === "menu-cubugu-ayarlari" || tabText.indexOf("Menü Çubuğu") >= 0 || tabText.indexOf("Menu Cubugu") >= 0) {
          menuAyarTabIndex = i;
          break;
        }
      }

      if (menuAyarTabIndex >= 0) {
        console.log("Menü Çubuğu Ayarları tab'ı zaten var, aktif yapılıyor...");
        tabStrip.select(menuAyarTabIndex);
        showPageOnly('menu-cubugu-ayarlari');
        setTimeout(initMenuCubuguAyarlarPage, 0);
        return;
      }

      console.log("Yeni Menü Çubuğu Ayarları tab'ı ekleniyor...");
      showPageOnly('menu-cubugu-ayarlari');
      setTimeout(initMenuCubuguAyarlarPage, 0);

      var tabContent = '⚙️ Menü Çubuğu Ayarları <span class="tab-close-menu-cubugu-ayarlari" style="margin-left:6px;cursor:pointer;padding:2px 4px;border-radius:4px;font-weight:bold;">×</span>';

      tabStrip.append({
        text: tabContent,
        content: '<div></div>',
        encoded: false
      });

      setTimeout(function() {
        var allTabsArray = tabStrip.items();
        var addedTab = allTabsArray[allTabsArray.length - 1];
        $(addedTab).attr("data-tab-id", "menu-cubugu-ayarlari");
        var tabIndex = allTabsArray.length - 1;
        if (tabIndex >= 0) {
          tabStrip.select(tabIndex);
        }
      }, 100);
    }

    // Menü Çubuğu Ayarları tab'ını kapat
    function closeMenuCubuguAyarlarTab() {
      console.log("closeMenuCubuguAyarlarTab çağrıldı");
      if (!tabStrip) {
        console.error("TabStrip yok!");
        return;
      }

      var allTabs = tabStrip.items();
      var menuAyarTabIndex = -1;

      for (var i = 0; i < allTabs.length; i++) {
        var tab = $(allTabs[i]);
        var tabId = tab.attr("data-tab-id");
        var tabText = tab.text() || tab.html() || "";

        if (tabId === "menu-cubugu-ayarlari" || tabText.indexOf("Menü Çubuğu") >= 0 || tabText.indexOf("Menu Cubugu") >= 0) {
          menuAyarTabIndex = i;
          break;
        }
      }

      var activeTab = tabStrip.select();
      var allTabsArray = tabStrip.items();
      var activeTabIndex = -1;
      for (var j = 0; j < allTabsArray.length; j++) {
        if ($(allTabsArray[j])[0] === $(activeTab)[0]) {
          activeTabIndex = j;
          break;
        }
      }
      var wasActiveTab = (menuAyarTabIndex >= 0 && menuAyarTabIndex === activeTabIndex);

      if (menuAyarTabIndex < 0) {
        console.log("Menü Çubuğu Ayarları tab'ı bulunamadı!");
        return;
      }

      if (!wasActiveTab) {
        activeTabIdToKeep = getActiveTabId();
        ignoreSelectEvent = true;
        console.log("Pasif tab kapatılıyor, aktif tab korunacak:", activeTabIdToKeep);
      }

      setTimeout(function() {
        try {
          console.log("Menü Çubuğu Ayarları tab'ı kapatılıyor... Index:", menuAyarTabIndex, "Aktif tab mı:", wasActiveTab);
          tabStrip.remove(menuAyarTabIndex);

          if (!wasActiveTab && activeTabIdToKeep) {
            var desiredTabIndex = getTabIndexById(activeTabIdToKeep);
            if (desiredTabIndex >= 0) {
              console.log("Aktif tab manuel olarak tekrar seçiliyor:", activeTabIdToKeep, "Index:", desiredTabIndex);
              ignoreSelectEvent = true;
              tabStrip.select(desiredTabIndex);
              showPageOnly(activeTabIdToKeep);
              ignoreSelectEvent = false;
              activeTabIdToKeep = null;
            }
          } else if (wasActiveTab) {
            showNextTabAfterClose(menuAyarTabIndex, wasActiveTab);
          }
        } catch (error) {
          console.error("Tab kapatılırken hata:", error);
          ignoreSelectEvent = false;
          activeTabIdToKeep = null;
        }
      }, 0);
    }

    // Şube Kartı tab'ını aç
    function openSubeKartiTab() {
      if (!tabStrip) {
        console.error("TabStrip başlatılmamış!");
        return;
      }

      var allTabs = tabStrip.items();
      var subeTabIndex = -1;

      for (var i = 0; i < allTabs.length; i++) {
        var tab = $(allTabs[i]);
        var tabId = tab.attr("data-tab-id");
        var tabText = tab.text() || tab.html() || "";

        if (tabId === "sube-karti" || tabText.indexOf("Şube Kartı") >= 0) {
          subeTabIndex = i;
          break;
        }
      }

      if (subeTabIndex >= 0) {
        console.log("Şube Kartı tab'ı zaten var, aktif yapılıyor...");
        tabStrip.select(subeTabIndex);
        showPageOnly('sube-karti');
        return;
      }

      console.log("Yeni Şube Kartı tab'ı ekleniyor...");
      showPageOnly('sube-karti');

      var tabContent = '🏬 Şube Kartı <span class="tab-close-sube-karti" style="margin-left:6px;cursor:pointer;padding:2px 4px;border-radius:4px;font-weight:bold;">×</span>';

      tabStrip.append({
        text: tabContent,
        content: '<div></div>',
        encoded: false
      });

      setTimeout(function() {
        var allTabsArray = tabStrip.items();
        var addedTab = allTabsArray[allTabsArray.length - 1];
        $(addedTab).attr("data-tab-id", "sube-karti");
        var tabIndex = allTabsArray.length - 1;
        if (tabIndex >= 0) {
          tabStrip.select(tabIndex);
        }
      }, 100);
    }

    // Şube Kartı tab'ını kapat
    function closeSubeKartiTab() {
      console.log("closeSubeKartiTab çağrıldı");
      if (!tabStrip) {
        console.error("TabStrip yok!");
        return;
      }

      var allTabs = tabStrip.items();
      var subeTabIndex = -1;

      for (var i = 0; i < allTabs.length; i++) {
        var tab = $(allTabs[i]);
        var tabId = tab.attr("data-tab-id");
        var tabText = tab.text() || tab.html() || "";

        if (tabId === "sube-karti" || tabText.indexOf("Şube Kartı") >= 0) {
          subeTabIndex = i;
          break;
        }
      }

      var activeTab = tabStrip.select();
      var allTabsArray = tabStrip.items();
      var activeTabIndex = -1;
      for (var j = 0; j < allTabsArray.length; j++) {
        if ($(allTabsArray[j])[0] === $(activeTab)[0]) {
          activeTabIndex = j;
          break;
        }
      }
      var wasActiveTab = (subeTabIndex >= 0 && subeTabIndex === activeTabIndex);

      if (subeTabIndex < 0) {
        console.log("Şube Kartı tab'ı bulunamadı!");
        return;
      }

      if (!wasActiveTab) {
        activeTabIdToKeep = getActiveTabId();
        ignoreSelectEvent = true;
        console.log("Pasif tab kapatılıyor, aktif tab korunacak:", activeTabIdToKeep);
      }

      setTimeout(function() {
        try {
          console.log("Şube Kartı tab'ı kapatılıyor... Index:", subeTabIndex, "Aktif tab mı:", wasActiveTab);
          tabStrip.remove(subeTabIndex);

          if (!wasActiveTab && activeTabIdToKeep) {
            var desiredTabIndex = getTabIndexById(activeTabIdToKeep);
            if (desiredTabIndex >= 0) {
              console.log("Aktif tab manuel olarak tekrar seçiliyor:", activeTabIdToKeep, "Index:", desiredTabIndex);
              ignoreSelectEvent = true;
              tabStrip.select(desiredTabIndex);
              showPageOnly(activeTabIdToKeep);
              ignoreSelectEvent = false;
              activeTabIdToKeep = null;
            }
          } else if (wasActiveTab) {
            showNextTabAfterClose(subeTabIndex, wasActiveTab);
          }
        } catch (error) {
          console.error("Tab kapatılırken hata:", error);
          ignoreSelectEvent = false;
          activeTabIdToKeep = null;
        }
      }, 0);
    }
    
    // Banka tab'ını aç - Operasyon kodlarının birebir aynısı
    function openBankaTab() {
      if (!tabStrip) {
        console.error("TabStrip başlatılmamış!");
        return;
      }
      
      var allTabs = tabStrip.items();
      var bankaTabIndex = -1;
      
      for (var i = 0; i < allTabs.length; i++) {
        var tab = $(allTabs[i]);
        var tabId = tab.attr("data-tab-id");
        var tabText = tab.text() || tab.html() || "";
        
        if (tabId === "banka" || tabText.indexOf("Banka") >= 0) {
          bankaTabIndex = i;
          break;
        }
      }
      
      if (bankaTabIndex >= 0) {
        console.log("Banka tab'ı zaten var, aktif yapılıyor...");
        tabStrip.select(bankaTabIndex);
        showPageOnly('banka');
        return;
      }
      
      console.log("Yeni banka tab'ı ekleniyor...");
      showPageOnly('banka');
      
      var tabContent = '🏦 Banka <span class="tab-close-banka" style="margin-left:6px;cursor:pointer;padding:2px 4px;border-radius:4px;font-weight:bold;">×</span>';
      
      tabStrip.append({
        text: tabContent,
        content: '<div></div>',
        encoded: false
      });
      
      setTimeout(function() {
        var allTabsArray = tabStrip.items();
        var addedTab = allTabsArray[allTabsArray.length - 1];
        $(addedTab).attr("data-tab-id", "banka");
        var tabIndex = allTabsArray.length - 1;
        if (tabIndex >= 0) {
          tabStrip.select(tabIndex);
        }
      }, 100);
    }
    
    // Banka tab'ını kapat - Operasyon kodlarının birebir aynısı
    function closeBankaTab() {
      console.log("closeBankaTab çağrıldı");
      if (!tabStrip) {
        console.error("TabStrip yok!");
        return;
      }
      
      var allTabs = tabStrip.items();
      var bankaTabIndex = -1;
      
      for (var i = 0; i < allTabs.length; i++) {
        var tab = $(allTabs[i]);
        var tabId = tab.attr("data-tab-id");
        var tabText = tab.text() || tab.html() || "";
        
        if (tabId === "banka" || tabText.indexOf("Banka") >= 0) {
          bankaTabIndex = i;
          break;
        }
      }
      
      // Kapatılmadan önce aktif tab mı kontrol et ve aktif tab ID'sini kaydet
      var activeTab = tabStrip.select();
      var allTabsArray = tabStrip.items();
      var activeTabIndex = -1;
      for (var j = 0; j < allTabsArray.length; j++) {
        if ($(allTabsArray[j])[0] === $(activeTab)[0]) {
          activeTabIndex = j;
          break;
        }
      }
      var wasActiveTab = (bankaTabIndex >= 0 && bankaTabIndex === activeTabIndex);
      
      if (bankaTabIndex < 0) {
        console.log("Banka tab'ı bulunamadı!");
        return;
      }
      
      // Pasif tab kapatılıyorsa aktif tab ID'sini kaydet
      if (!wasActiveTab) {
        activeTabIdToKeep = getActiveTabId();
        ignoreSelectEvent = true;
        console.log("Pasif tab kapatılıyor, aktif tab korunacak:", activeTabIdToKeep);
      }
      
      // GitHub çözümü: setTimeout ile remove() çağrısını ertele
      setTimeout(function() {
        try {
          console.log("Banka tab'ı kapatılıyor... Index:", bankaTabIndex, "Aktif tab mı:", wasActiveTab);
          tabStrip.remove(bankaTabIndex);
          
          // Pasif tab kapatıldıysa aktif tab'ı manuel olarak tekrar seç
          if (!wasActiveTab && activeTabIdToKeep) {
            var desiredTabIndex = getTabIndexById(activeTabIdToKeep);
            if (desiredTabIndex >= 0) {
              console.log("Aktif tab manuel olarak tekrar seçiliyor:", activeTabIdToKeep, "Index:", desiredTabIndex);
              ignoreSelectEvent = true;
              tabStrip.select(desiredTabIndex);
              showPageOnly(activeTabIdToKeep);
              ignoreSelectEvent = false;
              activeTabIdToKeep = null;
            }
          } else if (wasActiveTab) {
            showNextTabAfterClose(bankaTabIndex, wasActiveTab);
          }
        } catch(error) {
          console.error("Tab kapatılırken hata:", error);
          ignoreSelectEvent = false;
          activeTabIdToKeep = null;
        }
      }, 0);
    }
    
    // Tanker tab'ını aç - Operasyon kodlarının birebir aynısı
    function openTankerTab() {
      if (!tabStrip) {
        console.error("TabStrip başlatılmamış!");
        return;
      }
      
      var allTabs = tabStrip.items();
      var tankerTabIndex = -1;
      
      for (var i = 0; i < allTabs.length; i++) {
        var tab = $(allTabs[i]);
        var tabId = tab.attr("data-tab-id");
        var tabText = tab.text() || tab.html() || "";
        
        if (tabId === "tanker" || tabText.indexOf("Tanker") >= 0) {
          tankerTabIndex = i;
          break;
        }
      }
      
      if (tankerTabIndex >= 0) {
        console.log("Tanker tab'ı zaten var, aktif yapılıyor...");
        tabStrip.select(tankerTabIndex);
        showPageOnly('tanker');
        return;
      }
      
      console.log("Yeni tanker tab'ı ekleniyor...");
      showPageOnly('tanker');
      
      var tabContent = '🚛 Tanker <span class="tab-close-tanker" style="margin-left:6px;cursor:pointer;padding:2px 4px;border-radius:4px;font-weight:bold;">×</span>';
      
      tabStrip.append({
        text: tabContent,
        content: '<div></div>',
        encoded: false
      });
      
      setTimeout(function() {
        var allTabsArray = tabStrip.items();
        var addedTab = allTabsArray[allTabsArray.length - 1];
        $(addedTab).attr("data-tab-id", "tanker");
        var tabIndex = allTabsArray.length - 1;
        if (tabIndex >= 0) {
          tabStrip.select(tabIndex);
        }
      }, 100);
    }
    
    // Tanker tab'ını kapat - Operasyon kodlarının birebir aynısı
    function closeTankerTab() {
      console.log("closeTankerTab çağrıldı");
      if (!tabStrip) {
        console.error("TabStrip yok!");
        return;
      }
      
      var allTabs = tabStrip.items();
      var tankerTabIndex = -1;
      
      for (var i = 0; i < allTabs.length; i++) {
        var tab = $(allTabs[i]);
        var tabId = tab.attr("data-tab-id");
        var tabText = tab.text() || tab.html() || "";
        
        if (tabId === "tanker" || tabText.indexOf("Tanker") >= 0) {
          tankerTabIndex = i;
          break;
        }
      }
      
      // Kapatılmadan önce aktif tab mı kontrol et ve aktif tab ID'sini kaydet
      var activeTab = tabStrip.select();
      var allTabsArray = tabStrip.items();
      var activeTabIndex = -1;
      for (var j = 0; j < allTabsArray.length; j++) {
        if ($(allTabsArray[j])[0] === $(activeTab)[0]) {
          activeTabIndex = j;
          break;
        }
      }
      var wasActiveTab = (tankerTabIndex >= 0 && tankerTabIndex === activeTabIndex);
      
      if (tankerTabIndex < 0) {
        console.log("Tanker tab'ı bulunamadı!");
        return;
      }
      
      // Pasif tab kapatılıyorsa aktif tab ID'sini kaydet
      if (!wasActiveTab) {
        activeTabIdToKeep = getActiveTabId();
        ignoreSelectEvent = true;
        console.log("Pasif tab kapatılıyor, aktif tab korunacak:", activeTabIdToKeep);
      }
      
      // GitHub çözümü: setTimeout ile remove() çağrısını ertele
      setTimeout(function() {
        try {
          console.log("Tanker tab'ı kapatılıyor... Index:", tankerTabIndex, "Aktif tab mı:", wasActiveTab);
          tabStrip.remove(tankerTabIndex);
          
          // Pasif tab kapatıldıysa aktif tab'ı manuel olarak tekrar seç
          if (!wasActiveTab && activeTabIdToKeep) {
            var desiredTabIndex = getTabIndexById(activeTabIdToKeep);
            if (desiredTabIndex >= 0) {
              console.log("Aktif tab manuel olarak tekrar seçiliyor:", activeTabIdToKeep, "Index:", desiredTabIndex);
              ignoreSelectEvent = true;
              tabStrip.select(desiredTabIndex);
              showPageOnly(activeTabIdToKeep);
              ignoreSelectEvent = false;
              activeTabIdToKeep = null;
            }
          } else if (wasActiveTab) {
            showNextTabAfterClose(tankerTabIndex, wasActiveTab);
          }
        } catch(error) {
          console.error("Tab kapatılırken hata:", error);
          ignoreSelectEvent = false;
          activeTabIdToKeep = null;
        }
      }, 0);
    }
    
    // Fiyat değişimi tab'ını aç - Operasyon kodlarının birebir aynısı
    function openFiyatDegisimiTab() {
      if (!tabStrip) {
        console.error("TabStrip başlatılmamış!");
        return;
      }
      
      var allTabs = tabStrip.items();
      var fiyatDegisimiTabIndex = -1;
      
      for (var i = 0; i < allTabs.length; i++) {
        var tab = $(allTabs[i]);
        var tabId = tab.attr("data-tab-id");
        var tabText = tab.text() || tab.html() || "";
        
        if (tabId === "fiyat-degisimi" || tabText.indexOf("Fiyat") >= 0) {
          fiyatDegisimiTabIndex = i;
          break;
        }
      }
      
      if (fiyatDegisimiTabIndex >= 0) {
        console.log("Fiyat Değişimi tab'ı zaten var, aktif yapılıyor...");
        tabStrip.select(fiyatDegisimiTabIndex);
        showPageOnly('fiyat-degisimi');
        return;
      }
      
      console.log("Yeni fiyat değişimi tab'ı ekleniyor...");
      showPageOnly('fiyat-degisimi');
      
      var tabContent = '💰 Fiyat Değişimi <span class="tab-close-fiyat-degisimi" style="margin-left:6px;cursor:pointer;padding:2px 4px;border-radius:4px;font-weight:bold;">×</span>';
      
      tabStrip.append({
        text: tabContent,
        content: '<div></div>',
        encoded: false
      });
      
      setTimeout(function() {
        var allTabs = tabStrip.items();
        var addedTab = allTabs[allTabs.length - 1];
        $(addedTab).attr("data-tab-id", "fiyat-degisimi");
        var tabIndex = allTabs.length - 1;
        if (tabIndex >= 0) {
          tabStrip.select(tabIndex);
        }
      }, 100);
    }
    
    // Fiyat değişimi tab'ını kapat - Operasyon kodlarının birebir aynısı
    function closeFiyatDegisimiTab() {
      console.log("closeFiyatDegisimiTab çağrıldı");
      if (!tabStrip) {
        console.error("TabStrip yok!");
        return;
      }
      
      var allTabs = tabStrip.items();
      var fiyatDegisimiTabIndex = -1;
      
      for (var i = 0; i < allTabs.length; i++) {
        var tab = $(allTabs[i]);
        var tabId = tab.attr("data-tab-id");
        var tabText = tab.text() || tab.html() || "";
        
        if (tabId === "fiyat-degisimi" || tabText.indexOf("Fiyat") >= 0) {
          fiyatDegisimiTabIndex = i;
          break;
        }
      }
      
      // Kapatılmadan önce aktif tab mı kontrol et ve aktif tab ID'sini kaydet
      var activeTab = tabStrip.select();
      var allTabsArray = tabStrip.items();
      var activeTabIndex = -1;
      for (var j = 0; j < allTabsArray.length; j++) {
        if ($(allTabsArray[j])[0] === $(activeTab)[0]) {
          activeTabIndex = j;
          break;
        }
      }
      var wasActiveTab = (fiyatDegisimiTabIndex >= 0 && fiyatDegisimiTabIndex === activeTabIndex);
      
      if (fiyatDegisimiTabIndex < 0) {
        console.log("Fiyat Değişimi tab'ı bulunamadı!");
        return;
      }
      
      // Pasif tab kapatılıyorsa aktif tab ID'sini kaydet
      if (!wasActiveTab) {
        activeTabIdToKeep = getActiveTabId();
        ignoreSelectEvent = true;
        console.log("Pasif tab kapatılıyor, aktif tab korunacak:", activeTabIdToKeep);
      }
      
      // GitHub çözümü: setTimeout ile remove() çağrısını ertele
      setTimeout(function() {
        try {
          console.log("Fiyat Değişimi tab'ı kapatılıyor... Index:", fiyatDegisimiTabIndex, "Aktif tab mı:", wasActiveTab);
          tabStrip.remove(fiyatDegisimiTabIndex);
          
          // Pasif tab kapatıldıysa aktif tab'ı manuel olarak tekrar seç
          if (!wasActiveTab && activeTabIdToKeep) {
            var desiredTabIndex = getTabIndexById(activeTabIdToKeep);
            if (desiredTabIndex >= 0) {
              console.log("Aktif tab manuel olarak tekrar seçiliyor:", activeTabIdToKeep, "Index:", desiredTabIndex);
              ignoreSelectEvent = true;
              tabStrip.select(desiredTabIndex);
              showPageOnly(activeTabIdToKeep);
              ignoreSelectEvent = false;
              activeTabIdToKeep = null;
            }
          } else if (wasActiveTab) {
            showNextTabAfterClose(fiyatDegisimiTabIndex, wasActiveTab);
          }
        } catch(error) {
          console.error("Tab kapatılırken hata:", error);
          ignoreSelectEvent = false;
          activeTabIdToKeep = null;
        }
      }, 0);
    }

    
    // Ribbon butonlarına tıklama - Tüm sayfalar için
    $(document).on("click", ".ribbon-button", function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      var pageName = $(this).data('page');
      console.log("Ribbon buton tıklandı, pageName:", pageName);
      
      // Operasyon sayfası
      if (pageName === 'operasyon_sayfasi' || pageName === 'operasyon') {
        console.log("Operasyon sayfası açılıyor...");
        openOperasyonTab();
        setActiveRibbonButton(pageName);
      } else if (pageName === 'firma_tanimlari' || pageName === 'firma-tanimlari') {
        console.log("Firma Tanımları açılıyor...");
        openFirmaTanimlariTab();
        setActiveRibbonButton(pageName);
      } else if (pageName === 'sube_tanimlari' || pageName === 'sube-tanimlari') {
        console.log("Şube Tanımları açılıyor...");
        openSubeTanimlariTab();
        setActiveRibbonButton(pageName);
      } else if (pageName === 'sube_karti' || pageName === 'sube-karti') {
        console.log("Şube Kartı açılıyor...");
        openSubeKartiTab();
        setActiveRibbonButton(pageName);
      } else if (pageName === 'urun_tanimlari') {
        console.log("Ürün Tanımları açılıyor...");
        if (typeof openUrunTanimlariWindow === 'function') {
          openUrunTanimlariWindow();
        }
        setActiveRibbonButton(pageName);
      } else if (pageName === 'sistem_tanimlari') {
        console.log("Sistem Tanımları açılıyor...");
        if (typeof openSistemTanimlariWindow === 'function') {
          openSistemTanimlariWindow();
        }
        setActiveRibbonButton(pageName);
      } else if (pageName === 'kullanici_tanimlari') {
        console.log("Kullanıcı Tanımları açılıyor...");
        if (typeof openKullaniciTanimlariWindow === 'function') {
          openKullaniciTanimlariWindow();
        }
        setActiveRibbonButton(pageName);
      } else if (pageName === 'zam-indirim' || pageName === 'zam_indirim') {
        console.log("Zam/İndirim açılıyor...");
        openZamIndirimTab();
        setActiveRibbonButton(pageName);
      } else if (pageName === 'menu_cubugu_ayarlari') {
        console.log("Menü Çubuğu Ayarları açılıyor...");
        openMenuCubuguAyarlarTab();
        setActiveRibbonButton(pageName);
      } else {
        console.log("Bu sayfa için tanım yok:", pageName);
      }
    });
    
    // duzeltGridBorderSorunu fonksiyonu - Grid border sorununu düzeltir
    function duzeltGridBorderSorunu(gridSelector, gridWidth) {
      try {
        var $grid = $(gridSelector);
        if ($grid.length === 0) {
          console.warn("Grid bulunamadı:", gridSelector);
          return;
        }
        
        // Grid container genişliğini ayarla
        $grid.css({
          'width': gridWidth + 'px',
          'max-width': gridWidth + 'px',
          'min-width': gridWidth + 'px'
        });
        
        // Grid wrapper genişliğini ayarla
        var $wrapper = $grid.closest('.k-grid-wrapper, .k-widget');
        if ($wrapper.length > 0) {
          $wrapper.css({
            'width': gridWidth + 'px',
            'max-width': gridWidth + 'px'
          });
        }
        
        console.log("Grid border sorunu düzeltildi:", gridSelector, "Genişlik:", gridWidth + 'px');
      } catch(error) {
        console.error("duzeltGridBorderSorunu hatası:", error);
      }
    }
    
    // Global fonksiyon olarak tanımla
    window.duzeltGridBorderSorunu = duzeltGridBorderSorunu;
  </script>
  
  {% block extra_scripts %}{% endblock %}
  <div id="fixed-area-4-container" style="position:fixed;left:0;right:0;bottom:0;z-index:9997;height:30px;background:#f5f5f5;border-top:1px solid #e0e0e0;font-family:'Segoe UI',Arial,sans-serif;display:flex;align-items:center;justify-content:space-between;padding:0 8px;opacity:1;">
    <style>
      #fixed-area-4-container .area4-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        height: 22px;
        padding: 0 8px;
        border: 1px solid #cfd8dc;
        border-radius: 4px;
        font-size: 10pt;
        font-weight: 600;
        color: #333333;
        white-space: nowrap;
      }
      #fixed-area-4-container .area4-time { background: #e8f1fb; }
      #fixed-area-4-container .area4-usd { background: #eaf6ee; }
      #fixed-area-4-container .area4-eur { background: #f3edf9; }
      #fixed-area-4-container .area4-gold { background: #fff4e5; }
      #fixed-area-4-container .area4-zam-motorin { background: #eef7ed; }
      #fixed-area-4-container .area4-zam-benzin { background: #f7f2e7; }
    </style>
    <div style="display:flex;align-items:center;gap:8px;white-space:nowrap;">
      <span id="fixed-area-4-datetime" class="area4-chip area4-time"></span>
      <span id="fixed-area-4-rates" style="display:flex;align-items:center;gap:8px;"></span>
    </div>
    <span style="color:#555;font-size:10pt;font-weight:600;pointer-events:none;white-space:nowrap;">ALAN 4</span>
  </div>
</body>
</html>
